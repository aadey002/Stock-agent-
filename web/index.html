<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SPY Puts & Calls Confluence Agent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-alt: #030712;
      --bg-card: #020617;
      --border-subtle: #1f2937;
      --border-strong: #374151;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --accent-strong: #0ea5e9;
      --danger: #f97373;
      --success: #4ade80;
      --warn: #facc15;
      --chip-bg: rgba(15, 23, 42, 0.8);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .page {
      max-width: 1180px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 18px;
    }

    .title-block h1 {
      font-size: 22px;
      letter-spacing: 0.04em;
    }

    .title-block h1 span {
      font-weight: 400;
      color: var(--accent);
    }

    .subtitle {
      margin-top: 2px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .pill {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.7);
    }

    .pill strong {
      color: var(--accent);
      font-weight: 500;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 16px;
    }

    .cards-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }

    .summary-card {
      background: radial-gradient(circle at top left, #0b1120 0, #020617 55%);
      border-radius: 18px;
      padding: 10px 12px;
      border: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 70px;
    }

    .summary-label {
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .summary-main {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .summary-main span {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .summary-sub {
      margin-top: 2px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .summary-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.85);
    }

    .summary-chip.call {
      border-color: rgba(74, 222, 128, 0.8);
      color: var(--success);
    }

    .summary-chip.put {
      border-color: rgba(248, 113, 113, 0.8);
      color: var(--danger);
    }

    .summary-chip.neutral {
      border-color: rgba(148, 163, 184, 0.8);
      color: var(--text-muted);
    }

    .summary-kpi {
      font-size: 12px;
      font-weight: 500;
    }

    .summary-kpi.positive {
      color: var(--success);
    }

    .summary-kpi.negative {
      color: var(--danger);
    }

    .grid-two {
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.1fr);
      gap: 16px;
    }

    section.card {
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #000 140%);
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      padding: 14px 14px 10px;
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.7);
    }

    section.card h2 {
      font-size: 14px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .price-chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .price-chart-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .chart-shell {
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      background: #020617;
      padding: 8px 8px 4px;
    }

    .chart-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    svg {
      width: 100%;
      height: 180px;
    }

    .backtest-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 8px;
      margin-top: 3px;
    }

    .backtest-row {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
    }

    .backtest-row span.value {
      color: var(--text-main);
      font-weight: 500;
    }

    .backtest-highlight {
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px dashed var(--border-strong);
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.8);
    }

    .backtest-highlight strong {
      color: var(--accent);
      font-weight: 500;
    }

    .table-card {
      margin-top: 4px;
    }

    table.trade-log {
      width: 100%;
      border-collapse: collapse;
      font-size: 10.5px;
      margin-top: 6px;
    }

    table.trade-log thead {
      background: rgba(15, 23, 42, 0.9);
    }

    table.trade-log th,
    table.trade-log td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      text-align: right;
      white-space: nowrap;
    }

    table.trade-log th:first-child,
    table.trade-log td:first-child {
      text-align: left;
    }

    table.trade-log th {
      font-weight: 500;
      color: var(--text-muted);
    }

    table.trade-log tbody tr:nth-child(2n) {
      background: rgba(15, 23, 42, 0.7);
    }

    table.trade-log td.pnl-pos {
      color: var(--success);
    }

    table.trade-log td.pnl-neg {
      color: var(--danger);
    }

    .disclaimer {
      margin-top: 7px;
      font-size: 10px;
      color: var(--text-muted);
    }

    .disclaimer strong {
      color: var(--accent);
      font-weight: 500;
    }

    /* tuning table re-use */
    #tuning-table td,
    #tuning-table th {
      text-align: right;
    }

    #tuning-table th:first-child,
    #tuning-table td:first-child {
      text-align: right;
    }

    #tuning-table th:nth-child(1),
    #tuning-table td:nth-child(1) {
      text-align: right;
    }

    #tuning-table th:nth-child(2),
    #tuning-table td:nth-child(2) {
      text-align: right;
    }

    .chip-muted {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      background: var(--chip-bg);
      border: 1px solid var(--border-subtle);
      color: var(--text-muted);
    }

    @media (max-width: 880px) {
      .cards-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .grid-two {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 640px) {
      .cards-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title-block">
        <h1>SPY Puts &amp; Calls <span>Confluence Agent</span></h1>
        <div class="subtitle">
          Geometry × φ × time windows. Signals are synthetic and for research only.
        </div>
      </div>
      <div class="pill">
        Powered by <strong>Tiingo</strong> · Backtested locally on SPY closes
      </div>
    </header>

    <main>
      <!-- Top summary metrics -->
      <section class="cards-row">
        <div class="summary-card">
          <div class="summary-label">Latest close</div>
          <div class="summary-main" id="summary-last-close">—</div>
          <div class="summary-sub" id="summary-last-change">Awaiting data…</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Last confluence signal</div>
          <div class="summary-main">
            <span id="summary-last-signal">—</span>
            <span id="summary-last-signal-date" style="font-size:11px;"></span>
          </div>
          <div class="summary-sub" id="summary-last-signal-detail">Bias and exit details will appear here.</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Win / loss (all confluence trades)</div>
          <div class="summary-main">
            <span class="summary-kpi" id="summary-win-loss">—</span>
          </div>
          <div class="summary-sub">
            Calls: <span id="summary-calls">0</span> · Puts: <span id="summary-puts">0</span> ·
            Avg R: <span id="summary-avg-r">—</span>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Confluence performance (3Y)</div>
          <div class="summary-main" id="perf-win-rate">
            —
          </div>
          <div class="summary-sub">
            Trades: <span id="perf-total-trades">—</span> · Avg R:
            <span id="perf-avg-r">—</span> · Max DD:
            <span id="perf-max-dd">—</span> · SPY Buy &amp; Hold:
            <span id="perf-bh">—</span>
          </div>
        </div>
      </section>

      <!-- Chart + backtest -->
      <section class="grid-two">
        <section class="card">
          <div class="price-chart-header">
            <h2>Price chart</h2>
            <div class="price-chart-meta" id="chart-meta">Last 60 trading days of SPY</div>
          </div>
          <p class="card-subtitle">
            SPY closes with a simple fast/slow bias underneath the geometry/φ/time confluence logic.
          </p>
          <div class="chart-shell">
            <svg id="price-chart" viewBox="0 0 100 60" preserveAspectRatio="none">
              <polyline id="price-path" fill="none" stroke="url(#gradLine)" stroke-width="0.7" />
              <defs>
                <linearGradient id="gradLine" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#38bdf8" />
                  <stop offset="100%" stop-color="#a855f7" />
                </linearGradient>
              </defs>
            </svg>
            <div class="chart-label-row">
              <span id="chart-start-label">—</span>
              <span id="chart-end-label">—</span>
            </div>
          </div>
        </section>

        <section class="card">
          <h2>Backtest summary</h2>
          <p class="card-subtitle">
            Simple rule: take a directional trade only when geometry/φ levels, time window, and SMA bias align.
            Exit on the HOLD_DAYS time stop.
          </p>
          <div class="backtest-grid">
            <div class="backtest-row">
              <span>Total trades</span>
              <span class="value" id="bt-trades">—</span>
            </div>
            <div class="backtest-row">
              <span>Win rate</span>
              <span class="value" id="bt-winrate">—</span>
            </div>
            <div class="backtest-row">
              <span>Median P&amp;L per trade</span>
              <span class="value" id="bt-median">—</span>
            </div>
            <div class="backtest-row">
              <span>Max drawdown (pnl points)</span>
              <span class="value" id="bt-dd">—</span>
            </div>
          </div>
          <div class="backtest-highlight" id="bt-highlight">
            Waiting for data…
          </div>
        </section>
      </section>

      <!-- Log + tuning -->
      <section class="card table-card">
        <h2>Confluence trade log</h2>
        <p class="card-subtitle">
          Each row is a synthetic playbook built from a confluence bar (CALL/PUT bias + price confluence + time window).
          Entry/stop/targets are derived from ATR; exits are time-based.
        </p>
        <div style="overflow-x:auto;">
          <table class="trade-log" id="trade-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Side</th>
                <th>Entry</th>
                <th>Exit</th>
                <th>P&amp;L</th>
                <th>Entry band</th>
                <th>Stop</th>
                <th>T1</th>
                <th>T2</th>
                <th>Exit date</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="disclaimer">
          <strong>Important:</strong> this is a research tool only. Numbers are based purely on historical SPY closes with
          simplified assumptions; they do not include slippage, commissions, margin or option pricing. Do not trade directly
          from this page.
        </div>
      </section>

      <section class="card table-card">
        <h2>Parameter tuning sandbox</h2>
        <p class="card-subtitle">
          Precomputed grids for Light / Medium / Deep tuning. Use this to see how changes to entry band, stop distance,
          hold days, and price tolerance affect win rate, average R-return, and trade frequency. The live playbook
          continues to use the baseline parameters in <code>agent.py</code>.
        </p>
        <div style="display:flex;align-items:center;gap:8px;font-size:11px;margin-bottom:8px;">
          <span style="color:var(--text-muted);">Tuning mode:</span>
          <select id="tuning-mode"
            style="background:#020617;border:1px solid #374151;color:#e5e7eb;border-radius:999px;padding:3px 10px;font-size:11px;">
            <option value="light">Light (fast)</option>
            <option value="medium">Medium (balanced)</option>
            <option value="deep">Deep (full sweep)</option>
          </select>
          <span class="chip-muted">No parameters are changed automatically.</span>
        </div>
        <div style="overflow-x:auto;">
          <table class="trade-log" id="tuning-table">
            <thead>
              <tr>
                <th>Entry ATR</th>
                <th>Stop ATR</th>
                <th>Hold (d)</th>
                <th>Price tol</th>
                <th>Trades</th>
                <th>Win%</th>
                <th>Avg R</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="disclaimer">
          Tuning results are historical and based on SPY only. They are meant to guide thinking about robustness, not to
          “optimize to the last decimal”.
        </div>
      </section>
    </main>
  </div>

  <script>
    // --- tiny CSV parser ----------------------------------------------------
    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length <= 1) return [];
      const headers = lines[0].split(",");
      return lines.slice(1).map(line => {
        const cols = line.split(",");
        const obj = {};
        headers.forEach((h, i) => {
          obj[h] = cols[i];
        });
        return obj;
      });
    }

    function toNumber(v) {
      const x = Number(v);
      return Number.isFinite(x) ? x : NaN;
    }

    // --- load SPY CSV & draw chart -----------------------------------------
    async function loadSpy() {
      const res = await fetch("data/SPY.csv");
      if (!res.ok) return null;
      const text = await res.text();
      const rows = parseCsv(text);
      if (!rows.length) return null;

      // enhance rows
      rows.forEach(r => {
        r._date = new Date(r.Date);
        r._close = toNumber(r.Close);
      });

      // sort by date ascending
      rows.sort((a, b) => a._date - b._date);

      // summary
      const last = rows[rows.length - 1];
      const prev = rows[rows.length - 2] || last;
      const lastClose = last._close;
      const prevClose = prev._close;
      const change = lastClose - prevClose;
      const changePct = prevClose ? (change / prevClose) * 100 : 0;

      const lastText = lastClose ? lastClose.toFixed(2) : "—";
      const deltaText = `${change >= 0 ? "+" : ""}${change.toFixed(2)} (${changePct >= 0 ? "+" : ""}${changePct.toFixed(2)}%)`;

      document.getElementById("summary-last-close").textContent = lastText;
      document.getElementById("summary-last-change").textContent =
        `${deltaText} vs prior close on ${prev.Date}`;

      // chart: use last 60 rows
      const windowSize = 60;
      const slice = rows.slice(-windowSize);
      if (!slice.length) return rows;

      const xs = slice.map((_, i) => i);
      const ys = slice.map(r => r._close);
      const minY = Math.min(...ys);
      const maxY = Math.max(...ys);
      const spanY = maxY - minY || 1;

      const pts = xs.map((x, i) => {
        const px = (x / (xs.length - 1 || 1)) * 100;
        const normY = (ys[i] - minY) / spanY;
        const py = 60 - normY * 55; // pad at top/bottom
        return `${px},${py}`;
      }).join(" ");

      document.getElementById("price-path").setAttribute("points", pts);
      document.getElementById("chart-start-label").textContent = slice[0].Date;
      document.getElementById("chart-end-label").textContent = slice[slice.length - 1].Date;

      return rows;
    }

    // --- load trade log -----------------------------------------------------
    async function loadTrades() {
      const res = await fetch("data/portfolio_confluence.csv");
      if (!res.ok) return [];
      const text = await res.text();
      const rows = parseCsv(text);
      if (!rows.length) return [];

      // sort by entry date ascending
      rows.forEach(r => {
        r._entryDate = new Date(r.EntryDate);
        r._exitDate = new Date(r.ExitDate);
        r._pnl = toNumber(r.PNL);
      });
      rows.sort((a, b) => a._entryDate - b._entryDate);

      const tbody = document.querySelector("#trade-table tbody");
      tbody.innerHTML = "";

      let wins = 0;
      let losses = 0;
      let calls = 0;
      let puts = 0;
      const pnls = [];
      let equity = 0;
      let peak = 0;
      let maxDD = 0;

      rows.forEach(r => {
        const pnl = r._pnl;
        pnls.push(pnl);
        equity += pnl;
        if (equity > peak) peak = equity;
        const dd = peak - equity;
        if (dd > maxDD) maxDD = dd;

        if (pnl > 0) wins++;
        else if (pnl < 0) losses++;

        if (r.Signal === "CALL") calls++;
        if (r.Signal === "PUT") puts++;

        const tr = document.createElement("tr");
        const band = `${Number(r.EntryLow).toFixed(2)} – ${Number(r.EntryHigh).toFixed(2)}`;
        tr.innerHTML = `
          <td>${r.EntryDate}</td>
          <td>${r.Signal}</td>
          <td>${Number(r.EntryPrice).toFixed(2)}</td>
          <td>${Number(r.ExitPrice).toFixed(2)}</td>
          <td class="${pnl > 0 ? "pnl-pos" : pnl < 0 ? "pnl-neg" : ""}">${pnl.toFixed(2)}</td>
          <td>${band}</td>
          <td>${Number(r.Stop).toFixed(2)}</td>
          <td>${Number(r.Target1).toFixed(2)}</td>
          <td>${Number(r.Target2).toFixed(2)}</td>
          <td>${r.ExitDate}</td>
        `;
        tbody.appendChild(tr);
      });

      // simple stats
      const total = rows.length;
      const winRate = total ? (wins / total) * 100 : 0;
      const medianPnl = pnls.length ? pnls.slice().sort((a, b) => a - b)[Math.floor(pnls.length / 2)] : 0;

      document.getElementById("bt-trades").textContent = total;
      document.getElementById("bt-winrate").textContent = total ? winRate.toFixed(1) + "%" : "—";
      document.getElementById("bt-median").textContent = medianPnl.toFixed(2);
      document.getElementById("bt-dd").textContent = maxDD.toFixed(2);

      const highlight = document.getElementById("bt-highlight");
      if (total) {
        highlight.innerHTML =
          `Over <strong>${total}</strong> confluence trades this configuration produced a ` +
          `<strong>${winRate.toFixed(1)}%</strong> win rate with a maximum equity ` +
          `drawdown of <strong>${maxDD.toFixed(2)}</strong> P&amp;L points.`;
      } else {
        highlight.textContent = "No confluence trades yet in the current lookback.";
      }

      // summary cards
      const last = rows[rows.length - 1];
      if (last) {
        const chip = document.createElement("span");
        chip.className = "summary-chip " + (last.Signal === "CALL" ? "call" : "put");
        chip.textContent = last.Signal;
        const holder = document.getElementById("summary-last-signal");
        holder.innerHTML = "";
        holder.appendChild(chip);

        document.getElementById("summary-last-signal-date").textContent =
          `· entry ${last.EntryDate}, exit ${last.ExitDate}`;
        document.getElementById("summary-last-signal-detail").textContent =
          `Entry ${Number(last.EntryPrice).toFixed(2)}, time exit ${Number(last.ExitPrice).toFixed(2)}, ` +
          `PNL ${Number(last.PNL).toFixed(2)}.`;
      }

      document.getElementById("summary-win-loss").textContent =
        `${wins} won / ${losses} lost`;
      document.getElementById("summary-calls").textContent = calls;
      document.getElementById("summary-puts").textContent = puts;

      return rows;
    }

    // --- load performance + tuning JSON ------------------------------------
    async function loadPerformanceAndTuning() {
      let perf = null;
      let tuning = null;
      try {
        perf = await fetch("data/performance_confluence.json").then(r => r.ok ? r.json() : null);
      } catch (e) { /* ignore */ }

      try {
        tuning = await fetch("data/tuning_confluence.json").then(r => r.ok ? r.json() : null);
      } catch (e) { /* ignore */ }

      if (perf && perf.summary) {
        const s = perf.summary;
        const b = perf.benchmark || {};
        document.getElementById("perf-total-trades").textContent = s.total_trades;
        document.getElementById("perf-win-rate").textContent =
          s.total_trades ? s.win_rate.toFixed(1) + "%" : "—";
        document.getElementById("perf-avg-r").textContent =
          s.total_trades ? s.avg_r.toFixed(2) : "—";
        document.getElementById("perf-max-dd").textContent =
          s.total_trades ? s.max_drawdown.toFixed(2) : "—";
        document.getElementById("perf-bh").textContent =
          b.spy_buy_hold_return != null ? b.spy_buy_hold_return.toFixed(1) + "%" : "—";
      }

      if (tuning) {
        const modeSelect = document.getElementById("tuning-mode");
        const tbody = document.querySelector("#tuning-table tbody");

        function renderMode(mode) {
          const rows = tuning[mode] || [];
          tbody.innerHTML = "";
          rows.forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${r.ENTRY_BAND_ATR}</td>
              <td>${r.STOP_ATR}</td>
              <td>${r.HOLD_DAYS}</td>
              <td>${(r.PRICE_TOL_PCT * 100).toFixed(1)}%</td>
              <td>${r.total_trades}</td>
              <td>${r.total_trades ? r.win_rate.toFixed(1) + "%" : "—"}</td>
              <td>${r.total_trades ? r.avg_r.toFixed(2) : "—"}</td>
            `;
            tbody.appendChild(tr);
          });
        }

        modeSelect.addEventListener("change", () => renderMode(modeSelect.value));
        renderMode("light");
      }
    }

    // --- init ---------------------------------------------------------------
    async function init() {
      await loadSpy();
      await loadTrades();
      await loadPerformanceAndTuning();
    }

    init();
  </script>
</body>
</html>
