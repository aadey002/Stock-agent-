<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Agent 4 - Q5D Options Trading Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #3b82f6; --secondary: #8b5cf6; --accent: #06b6d4;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #0891b2;
            --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0;
            --text: #1e293b; --muted: #64748b; --light: #94a3b8;
            --intraday: #f59e0b; --swing: #8b5cf6;
            --ai-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
        
        /* LOGIN SCREEN STYLES */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d1b4e 50%, #1a1a2e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .login-screen.hidden { display: none; }
        
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 420px;
            text-align: center;
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }
        
        .login-title {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        
        .login-subtitle {
            color: var(--muted);
            font-size: 14px;
            margin-bottom: 30px;
        }
        
        .login-form { text-align: left; }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            outline: none;
        }
        
        .form-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        .form-group input.error {
            border-color: var(--danger);
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }
        
        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .login-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }
        
        .login-error.show { display: block; }
        
        .login-footer {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--muted);
        }
        
        .login-footer a {
            color: var(--primary);
            text-decoration: none;
        }
        
        /* Remember me checkbox */
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .remember-me input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }
        
        .remember-me label {
            font-size: 13px;
            color: var(--muted);
            cursor: pointer;
        }
        
        /* Logout Button in Header */
        .logout-btn {
            padding: 5px 12px;
            background: rgba(239, 68, 68, 0.2);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 5px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.4);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
        }
        
        .user-avatar {
            width: 24px;
            height: 24px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Main app hidden until logged in */
        .main-app { display: none; }
        .main-app.visible { display: block; }
        
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 10px 0; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1600px; margin: 0 auto; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .logo h1 { font-size: 16px; font-weight: 700; }
        .logo p { font-size: 9px; opacity: 0.9; }
        
        .live-price-ticker { display: flex; align-items: center; gap: 12px; background: rgba(0,0,0,0.2); padding: 6px 14px; border-radius: 8px; }
        .ticker-symbol { font-size: 13px; font-weight: 700; }
        .ticker-price { font-size: 20px; font-weight: 800; }
        .ticker-change { font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        .ticker-change.positive { background: rgba(16,185,129,0.3); }
        .ticker-change.negative { background: rgba(239,68,68,0.3); }
        
        /* Header Market Stats Row */
        .header-market-stats {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0,0,0,0.15);
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 10px;
        }
        .header-stat {
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        .header-stat-label {
            opacity: 0.7;
            font-weight: 500;
        }
        .header-stat-value {
            font-weight: 600;
        }
        .header-stat-value.near-high { color: #4ade80; }
        .header-stat-value.near-low { color: #f87171; }
        .header-stat-value.neutral { color: rgba(255,255,255,0.9); }
        .header-stat-value.positive { color: #4ade80; }
        .header-stat-value.negative { color: #f87171; }
        .header-stat-divider {
            width: 1px;
            height: 16px;
            background: rgba(255,255,255,0.2);
        }
        
        /* Timestamp Styles */
        .header-timestamp {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            opacity: 0.85;
            padding: 3px 8px;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
        }
        .header-timestamp .ts-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .section-timestamp {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg);
            color: var(--muted);
        }
        .section-timestamp .ts-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }
        .ts-fresh { background-color: #22c55e; }
        .ts-recent { background-color: #eab308; }
        .ts-stale { background-color: #f97316; }
        .ts-old { background-color: #ef4444; }
        .ts-text-fresh { color: #22c55e; }
        .ts-text-recent { color: #eab308; }
        .ts-text-stale { color: #f97316; }
        .ts-text-old { color: #ef4444; }
        
        .header-controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .status-badge { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 15px; font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .status-badge:hover { transform: scale(1.05); }
        .status-badge.online { background: rgba(16,185,129,0.3); }
        .status-badge.warning { background: rgba(245,158,11,0.3); }
        .status-badge.critical { background: rgba(239,68,68,0.3); }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        
        .symbol-select select { padding: 5px 8px; border: none; border-radius: 5px; font-size: 11px; background: rgba(255,255,255,0.9); cursor: pointer; font-weight: 600; }
        .refresh-btn { padding: 5px 12px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 5px; font-size: 11px; font-weight: 600; cursor: pointer; }
        
        .container { max-width: 1600px; margin: 0 auto; padding: 12px; }
        
        .mode-toggle-container { display: flex; justify-content: center; margin-bottom: 12px; }
        .mode-toggle { display: flex; background: var(--card); border-radius: 8px; padding: 3px; border: 1px solid var(--border); }
        .mode-btn { padding: 8px 20px; border: none; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 5px; }
        .mode-btn.intraday { background: transparent; color: var(--muted); }
        .mode-btn.swing { background: transparent; color: var(--muted); }
        .mode-btn.active.intraday { background: linear-gradient(135deg, var(--intraday), #d97706); color: white; }
        .mode-btn.active.swing { background: linear-gradient(135deg, var(--swing), #6d28d9); color: white; }
        
        .symbol-banner { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 8px 14px; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; font-size: 14px; }
        .symbol-banner.intraday-mode { background: linear-gradient(135deg, var(--intraday), #d97706); }
        .symbol-banner.swing-mode { background: linear-gradient(135deg, var(--swing), #6d28d9); }
        
        .tabs { display: flex; gap: 3px; background: var(--card); border-radius: 8px; padding: 4px; margin-bottom: 12px; overflow-x: auto; border: 1px solid var(--border); }
        .tab-btn { padding: 7px 12px; background: transparent; border: none; border-radius: 5px; color: var(--muted); font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .tab-btn:hover { color: var(--primary); background: rgba(59,130,246,0.05); }
        .tab-btn.active { color: white; background: var(--primary); }
        .tab-btn.ai-tab { background: var(--ai-gradient); color: white; }
        .tab-btn.ai-tab:not(.active) { background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2)); color: var(--secondary); }
        .tab-btn.health-tab { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .tab-btn.health-tab:not(.active) { background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.2)); color: var(--success); }
        .tab-btn.charts-tab { background: linear-gradient(135deg, #0891b2, #0e7490); color: white; }
        .tab-btn.charts-tab:not(.active) { background: linear-gradient(135deg, rgba(8,145,178,0.2), rgba(14,116,144,0.2)); color: var(--accent); }
        .tab-btn.analysis-tab { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .tab-btn.analysis-tab:not(.active) { background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(217,119,6,0.2)); color: var(--warning); }
        
                /* Enhanced Multi-Charts Styles */
        .multi-charts-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px; }
        @media (max-width: 1200px) { .multi-charts-container { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .multi-charts-container { grid-template-columns: 1fr; } }
        
        .mtf-summary { background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(139,92,246,0.05)); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .mtf-summary-title { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--text); }
        .mtf-summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        @media (max-width: 900px) { .mtf-summary-grid { grid-template-columns: repeat(2, 1fr); } }
        .mtf-summary-item { text-align: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid var(--border); }
        .mtf-summary-item .title { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
        .mtf-summary-item .value { font-size: 18px; font-weight: 700; }
        .mtf-summary-item .value.bullish { color: var(--success); }
        .mtf-summary-item .value.bearish { color: var(--danger); }
        .mtf-summary-item .value.neutral { color: var(--warning); }
        
        .chart-panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .chart-panel-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--bg); border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 8px; }
        .chart-panel-title { display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 13px; }
        .chart-panel-title .icon { width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .chart-panel-title .icon.intraday { background: rgba(245,158,11,0.2); }
        .chart-panel-title .icon.swing { background: rgba(139,92,246,0.2); }
        .chart-panel-title .icon.position { background: rgba(16,185,129,0.2); }
        .chart-controls { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .chart-select { padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 10px; background: white; cursor: pointer; }
        .chart-body { position: relative; height: 350px; background: #fff; }
        .chart-canvas-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
        .chart-legend { position: absolute; top: 8px; left: 10px; z-index: 10; display: flex; align-items: center; gap: 8px; }
        .chart-legend .symbol { background: rgba(59,130,246,0.9); color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        .chart-legend .price { font-size: 13px; font-weight: 700; color: var(--success); }
        .chart-legend .price.down { color: var(--danger); }
        .chart-loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; color: var(--muted); display: none; }
        
        .signal-badge-mtf { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 8px; }
        .signal-badge-mtf.call { background: var(--success); color: white; }
        .signal-badge-mtf.put { background: var(--danger); color: white; }
        .signal-badge-mtf.hold { background: var(--warning); color: white; }
        
        .settings-btn-mtf { background: var(--secondary); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .settings-btn-mtf:hover { opacity: 0.9; }
        .settings-panel-mtf { display: none; background: var(--bg); border-top: 1px solid var(--border); padding: 10px 12px; font-size: 11px; }
        .settings-panel-mtf.show { display: block; }
        .settings-row-mtf { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .settings-row-mtf label { display: flex; align-items: center; gap: 4px; cursor: pointer; color: var(--muted); }
        .settings-row-mtf input[type="checkbox"] { width: 14px; height: 14px; accent-color: var(--primary); }
        
        .pattern-alert-mtf { margin: 0 12px 10px; padding: 8px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .pattern-alert-mtf.bullish { background: rgba(16,185,129,0.15); color: #059669; border-left: 3px solid var(--success); }
        .pattern-alert-mtf.bearish { background: rgba(239,68,68,0.15); color: #dc2626; border-left: 3px solid var(--danger); }
        
        .fib-levels-mtf { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; padding: 8px 12px; background: var(--bg); border-top: 1px solid var(--border); }
        .fib-level-mtf { padding: 4px 6px; border-radius: 4px; text-align: center; font-size: 9px; }
        .fib-level-mtf.support { background: rgba(16,185,129,0.1); color: var(--success); }
        .fib-level-mtf.resistance { background: rgba(239,68,68,0.1); color: var(--danger); }
        
        .mtf-legend { display: flex; gap: 12px; padding: 6px 12px; background: var(--bg); border-top: 1px solid var(--border); font-size: 10px; flex-wrap: wrap; }
        .legend-item-mtf { display: flex; align-items: center; gap: 4px; color: var(--muted); }
        .legend-color-mtf { width: 12px; height: 3px; border-radius: 2px; }


        /* Daily Analysis Styles */
        .daily-report { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 15px; }
        .report-header { background: linear-gradient(135deg, #1e3a5f 0%, #2d1b4e 50%, #1a1a2e 100%); color: white; padding: 20px; }
        .report-header h2 { font-size: 20px; margin-bottom: 5px; }
        .report-header .report-meta { font-size: 12px; opacity: 0.8; }
        .report-body { padding: 20px; }
        .report-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .report-section:last-child { margin-bottom: 0; border-bottom: none; }
        .report-section-title { font-size: 14px; font-weight: 700; color: var(--primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .signal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .signal-card { background: var(--bg); border-radius: 8px; padding: 12px; border-left: 4px solid var(--primary); }
        .signal-card.bullish { border-left-color: var(--success); }
        .signal-card.bearish { border-left-color: var(--danger); }
        .signal-card.neutral { border-left-color: var(--warning); }
        .signal-card-title { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
        .signal-card-value { font-size: 16px; font-weight: 700; }
        .signal-card-detail { font-size: 10px; color: var(--muted); margin-top: 4px; }
        .consensus-meter { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin: 8px 0; }
        .consensus-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .consensus-fill.high { background: linear-gradient(90deg, var(--success), #34d399); }
        .consensus-fill.medium { background: linear-gradient(90deg, var(--warning), #fbbf24); }
        .consensus-fill.low { background: linear-gradient(90deg, var(--danger), #f87171); }
        .trade-recommendation { background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.1)); border: 1px solid rgba(16,185,129,0.3); border-radius: 10px; padding: 15px; }
        .trade-recommendation.put { background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(220,38,38,0.1)); border-color: rgba(239,68,68,0.3); }
        .strike-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .strike-table th, .strike-table td { padding: 8px 12px; text-align: left; font-size: 12px; }
        .strike-table th { background: var(--bg); color: var(--muted); font-weight: 600; }
        .strike-table tr:hover { background: rgba(59,130,246,0.05); }
        .gann-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .gann-item { background: var(--bg); padding: 10px; border-radius: 6px; text-align: center; }
        .gann-item-label { font-size: 10px; color: var(--muted); }
        .gann-item-value { font-size: 14px; font-weight: 700; color: var(--secondary); }
        .phi-levels { display: flex; flex-wrap: wrap; gap: 8px; }
        .phi-level { background: rgba(139,92,246,0.1); padding: 6px 12px; border-radius: 20px; font-size: 11px; }
        .phi-level span { font-weight: 700; color: var(--secondary); }
        .report-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .report-btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .report-btn.primary { background: var(--primary); color: white; }
        .report-btn.secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
        .report-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .eod-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        @media (max-width: 768px) { .eod-summary { grid-template-columns: repeat(2, 1fr); } }
        .eod-metric { text-align: center; padding: 15px; background: var(--bg); border-radius: 8px; }
        .eod-metric-value { font-size: 24px; font-weight: 700; }
        .eod-metric-label { font-size: 11px; color: var(--muted); }
        
        /* Daily Analysis Styles */
        .analysis-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .analysis-time { display: flex; gap: 15px; align-items: center; }
        .analysis-time-btn { padding: 10px 20px; border: 2px solid var(--border); background: white; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .analysis-time-btn.active { border-color: var(--primary); background: var(--primary); color: white; }
        .analysis-time-btn:hover:not(.active) { border-color: var(--primary); }
        .report-actions { display: flex; gap: 10px; }
        .report-btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .report-btn.primary { background: var(--primary); color: white; }
        .report-btn.success { background: var(--success); color: white; }
        .report-btn.warning { background: var(--warning); color: white; }
        .signal-confluence-card { background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(139,92,246,0.05)); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .confluence-score { font-size: 48px; font-weight: 800; text-align: center; margin: 15px 0; }
        .confluence-score.bullish { color: var(--success); }
        .confluence-score.bearish { color: var(--danger); }
        .confluence-score.neutral { color: var(--warning); }
        .signal-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .signal-item { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
        .signal-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .signal-item-name { font-weight: 600; font-size: 12px; }
        .signal-item-score { font-weight: 700; font-size: 14px; padding: 4px 10px; border-radius: 4px; }
        .signal-item-score.bullish { background: rgba(16,185,129,0.1); color: var(--success); }
        .signal-item-score.bearish { background: rgba(239,68,68,0.1); color: var(--danger); }
        .signal-item-score.neutral { background: rgba(245,158,11,0.1); color: var(--warning); }
        .signal-item-detail { font-size: 11px; color: var(--muted); }
        .trading-plan { background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .trading-plan-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 15px 20px; }
        .trading-plan-body { padding: 20px; }
        .plan-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .plan-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .plan-section-title { font-weight: 700; font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .trade-recommendation { background: rgba(16,185,129,0.05); border: 1px solid rgba(16,185,129,0.2); border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .trade-recommendation.put { background: rgba(239,68,68,0.05); border-color: rgba(239,68,68,0.2); }
        .trade-rec-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .trade-rec-symbol { font-weight: 700; font-size: 16px; }
        .trade-rec-signal { padding: 4px 12px; border-radius: 4px; font-weight: 600; font-size: 12px; }
        .trade-rec-signal.call { background: var(--success); color: white; }
        .trade-rec-signal.put { background: var(--danger); color: white; }
        .trade-rec-details { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 11px; }
        .trade-rec-detail { text-align: center; }
        .trade-rec-detail-label { color: var(--muted); }
        .trade-rec-detail-value { font-weight: 600; margin-top: 2px; }
        .gann-analysis { background: linear-gradient(135deg, rgba(139,92,246,0.05), rgba(168,85,247,0.05)); border-radius: 8px; padding: 15px; }
        .phi-levels { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .phi-level { text-align: center; padding: 10px; background: white; border-radius: 6px; }
        .phi-level-name { font-size: 10px; color: var(--muted); }
        .phi-level-value { font-weight: 700; font-size: 14px; color: var(--secondary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 14px; margin-bottom: 12px; }
        .card-title { font-size: 14px; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        
        .grid { display: grid; gap: 12px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
        .grid-5 { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
        
        .metric { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 10px; }
        .metric-label { font-size: 9px; font-weight: 600; color: var(--muted); text-transform: uppercase; margin-bottom: 4px; }
        .metric-value { font-size: 18px; font-weight: 700; }
        .metric-value.positive { color: var(--success); }
        .metric-value.negative { color: var(--danger); }
        .metric-sub { font-size: 9px; color: var(--light); margin-top: 2px; }
        
        .badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600; text-transform: uppercase; }
        .badge-success { background: rgba(16,185,129,0.15); color: var(--success); }
        .badge-danger { background: rgba(239,68,68,0.15); color: var(--danger); }
        .badge-warning { background: rgba(245,158,11,0.15); color: var(--warning); }
        .badge-info { background: rgba(8,145,178,0.15); color: var(--info); }
        .badge-primary { background: rgba(59,130,246,0.15); color: var(--primary); }
        .badge-ultra { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .badge-intraday { background: linear-gradient(135deg, var(--intraday), #d97706); color: white; }
        .badge-swing { background: linear-gradient(135deg, var(--swing), #6d28d9); color: white; }

        /* Turn Direction and Trade Styles */
        .turn-up { color: #00c853; font-weight: bold; }
        .turn-down { color: #ff5252; font-weight: bold; }
        .trade-call { color: #00c853; font-weight: 600; }
        .trade-put { color: #ff5252; font-weight: 600; }
        .pattern-bullish { color: #00c853; font-size: 10px; }
        .pattern-bearish { color: #ff5252; font-size: 10px; }
        .pattern-neutral { color: var(--muted); font-size: 10px; }

        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { text-align: left; padding: 8px; font-size: 9px; font-weight: 600; color: var(--muted); text-transform: uppercase; background: var(--bg); border-bottom: 1px solid var(--border); }
        td { padding: 8px; border-bottom: 1px solid var(--border); }
        tr:hover { background: rgba(59,130,246,0.02); }
        
        .chart-box { position: relative; height: 280px; }
        
        .dual-signal-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .signal-panel { border-radius: 8px; padding: 14px; }
        .signal-panel.intraday { background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(217,119,6,0.05)); border: 2px solid var(--intraday); }
        .signal-panel.swing { background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(109,40,217,0.05)); border: 2px solid var(--swing); }
        .signal-panel-title { font-size: 13px; font-weight: 700; margin-bottom: 10px; }
        .signal-panel-title.intraday { color: var(--intraday); }
        .signal-panel-title.swing { color: var(--swing); }
        
        .ref-data-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 11px; }
        .ref-label { color: var(--muted); }
        .ref-value { font-weight: 600; }
        .ref-value.positive { color: var(--success); }
        .ref-value.negative { color: var(--danger); }
        
        .bar-count-display { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .bar-count-item { background: var(--bg); border-radius: 6px; padding: 10px; text-align: center; }
        .bar-count-value { font-size: 24px; font-weight: 800; }
        .bar-count-label { font-size: 10px; color: var(--muted); margin-top: 3px; }

        /* Bar Count Redesign Styles */
        .bc-signal-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .bc-signal-box { background: var(--bg); border-radius: 8px; padding: 12px; text-align: center; border: 2px solid var(--border); }
        .bc-signal-label { font-size: 10px; color: var(--muted); margin-bottom: 5px; font-weight: 600; }
        .bc-signal-value { font-size: 18px; font-weight: 800; }
        .bc-signal-value.call { color: var(--success); }
        .bc-signal-value.put { color: var(--danger); }
        .bc-signal-value.wait { color: var(--warning); }
        .bc-signal-value.strong { color: var(--success); }
        .bc-signal-value.moderate { color: var(--warning); }
        .bc-signal-value.weak { color: var(--muted); }
        .bc-signal-value.low { color: var(--success); }
        .bc-signal-value.medium { color: var(--warning); }
        .bc-signal-value.high { color: var(--danger); }
        .bc-signal-value.now { color: var(--success); }
        .bc-signal-value.closed { color: var(--danger); }
        .bc-interpretation { background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 12px 15px; display: flex; gap: 12px; align-items: flex-start; margin-bottom: 15px; }
        .bc-interpretation-icon { font-size: 20px; }
        .bc-interpretation-text { font-size: 12px; line-height: 1.5; color: var(--text); }
        .bc-trade-rec { background: var(--bg); border: 2px solid var(--success); border-radius: 10px; overflow: hidden; }
        .bc-trade-rec-header { background: var(--success); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .bc-trade-rec-title { font-weight: 700; font-size: 13px; }
        .bc-trade-rec-conf { font-size: 11px; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 10px; }
        .bc-trade-rec-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--border); padding: 1px; }
        .bc-trade-rec-item { background: var(--card); padding: 10px; text-align: center; }
        .bc-rec-label { display: block; font-size: 9px; color: var(--muted); margin-bottom: 3px; }
        .bc-rec-value { font-size: 14px; font-weight: 700; }
        .bc-rec-value.call { color: var(--success); }
        .bc-rec-value.put { color: var(--danger); }
        .bc-rec-value.wait { color: var(--warning); }
        .bc-rec-value.danger { color: var(--danger); }
        .bc-rec-value.success { color: var(--success); }
        .bc-agent-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 15px; }
        .bc-agent-card { background: var(--bg); border-radius: 10px; padding: 15px; border-left: 4px solid var(--muted); transition: all 0.2s; }
        .bc-agent-card.bullish { border-left-color: var(--success); background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), transparent); }
        .bc-agent-card.bearish { border-left-color: var(--danger); background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), transparent); }
        .bc-agent-card.neutral { border-left-color: var(--warning); background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), transparent); }
        .bc-agent-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .bc-agent-icon { font-size: 16px; }
        .bc-agent-name { font-size: 11px; font-weight: 600; flex: 1; }
        .bc-agent-signal { font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 3px; }
        .bc-agent-card.bullish .bc-agent-signal { background: var(--success); color: white; }
        .bc-agent-card.bearish .bc-agent-signal { background: var(--danger); color: white; }
        .bc-agent-card.neutral .bc-agent-signal { background: var(--warning); color: white; }
        .bc-agent-value { font-size: 28px; font-weight: 800; text-align: center; margin: 10px 0; }
        .bc-agent-card.bullish .bc-agent-value { color: var(--success); }
        .bc-agent-card.bearish .bc-agent-value { color: var(--danger); }
        .bc-agent-card.neutral .bc-agent-value { color: var(--warning); }
        .bc-agent-method { font-size: 10px; color: var(--muted); text-align: center; margin-bottom: 10px; }
        .bc-agent-explain { font-size: 10px; color: var(--text); line-height: 1.4; background: rgba(0,0,0,0.03); padding: 8px; border-radius: 5px; }
        .bc-consensus-bar { background: var(--bg); border-radius: 8px; padding: 12px 15px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .bc-consensus-label { font-size: 12px; color: var(--muted); }
        .bc-consensus-value { font-size: 16px; font-weight: 800; color: var(--success); }
        .bc-consensus-detail { font-size: 11px; color: var(--muted); }
        .bc-reversal-sections { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .bc-reversal-section { border-radius: 10px; overflow: hidden; border: 1px solid var(--border); }
        .bc-reversal-header { padding: 10px 15px; display: flex; align-items: center; gap: 8px; }
        .bc-reversal-header.safe { background: linear-gradient(135deg, var(--success), #059669); color: white; }
        .bc-reversal-header.caution { background: linear-gradient(135deg, var(--warning), #d97706); color: white; }
        .bc-reversal-icon { font-size: 16px; }
        .bc-reversal-title { font-size: 12px; font-weight: 700; flex: 1; }
        .bc-reversal-count { font-size: 10px; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; }
        .bc-reversal-list { padding: 10px; max-height: 200px; overflow-y: auto; }
        .bc-reversal-item { display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--bg); border-radius: 5px; margin-bottom: 5px; font-size: 11px; }
        .bc-rev-symbol { font-weight: 700; min-width: 40px; }
        .bc-rev-run { color: var(--muted); }
        .bc-rev-pct { font-weight: 600; min-width: 40px; }
        .bc-rev-status { padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600; margin-left: auto; }
        .bc-rev-status.safe { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .bc-rev-status.caution { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .bc-reversal-table { width: 100%; font-size: 11px; }
        .bc-reversal-table th { background: var(--bg); padding: 8px; text-align: left; font-size: 10px; }
        .bc-reversal-table td { padding: 8px; border-bottom: 1px solid var(--border); }
        .bc-gann-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px; }
        .bc-gann-item { background: var(--bg); border-radius: 8px; padding: 12px; text-align: center; }
        .bc-gann-item.highlight { background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1)); border: 2px solid var(--primary); }
        .bc-gann-header { display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 8px; }
        .bc-gann-icon { font-size: 14px; }
        .bc-gann-title { font-size: 10px; color: var(--muted); font-weight: 600; }
        .bc-gann-value { font-size: 16px; font-weight: 800; margin-bottom: 4px; }
        .bc-gann-value.bullish { color: var(--success); }
        .bc-gann-value.bearish { color: var(--danger); }
        .bc-gann-value.low { color: var(--success); }
        .bc-gann-value.medium { color: var(--warning); }
        .bc-gann-value.high { color: var(--danger); }
        .bc-gann-value.ultra { color: var(--primary); text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .bc-gann-detail { font-size: 9px; color: var(--muted); }
        .bc-final-verdict { background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1)); border: 2px solid var(--success); border-radius: 10px; overflow: hidden; }
        .bc-verdict-header { background: var(--success); color: white; padding: 10px 15px; display: flex; align-items: center; gap: 8px; }
        .bc-verdict-icon { font-size: 18px; }
        .bc-verdict-title { font-size: 13px; font-weight: 700; }
        .bc-verdict-content { padding: 15px; }
        .bc-verdict-signal { font-size: 20px; font-weight: 800; margin-bottom: 10px; }
        .bc-verdict-signal.call { color: var(--success); }
        .bc-verdict-signal.put { color: var(--danger); }
        .bc-verdict-signal.wait { color: var(--warning); }
        .bc-verdict-text { font-size: 12px; color: var(--text); line-height: 1.5; }
        @media (max-width: 900px) {
            .bc-signal-row { grid-template-columns: repeat(2, 1fr); }
            .bc-agent-grid { grid-template-columns: repeat(2, 1fr); }
            .bc-trade-rec-grid { grid-template-columns: repeat(2, 1fr); }
            .bc-reversal-sections { grid-template-columns: 1fr; }
            .bc-gann-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .pattern-item { background: var(--bg); border-radius: 6px; padding: 8px; margin-bottom: 6px; }
        .pattern-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .pattern-name { font-weight: 600; font-size: 12px; }
        .pattern-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
        .pattern-fill { height: 100%; border-radius: 2px; }
        .pattern-fill.bullish { background: var(--success); }
        .pattern-fill.bearish { background: var(--danger); }
        .pattern-fill.neutral { background: var(--warning); }
        .pattern-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; font-size: 10px; color: var(--muted); }
        .pattern-date { font-style: italic; }
        .pattern-impl { font-weight: 500; max-width: 60%; text-align: right; }

        /* AI Assistant Styles */
        .ai-assistant-container { display: grid; grid-template-columns: 1fr 320px; gap: 15px; min-height: 500px; }
        .ai-chat-panel { display: flex; flex-direction: column; background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .ai-chat-header { background: var(--ai-gradient); color: white; padding: 12px 16px; display: flex; align-items: center; gap: 10px; }
        .ai-avatar { width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .ai-chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; max-height: 450px; }
        .ai-message { max-width: 90%; padding: 10px 14px; border-radius: 12px; font-size: 12px; line-height: 1.6; }
        .ai-message.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai-message.assistant { background: var(--bg); color: var(--text); align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid var(--border); }
        .ai-message.assistant .message-content { white-space: pre-wrap; }
        .ai-chat-input { display: flex; gap: 8px; padding: 12px; border-top: 1px solid var(--border); background: var(--bg); }
        .ai-chat-input input { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 20px; font-size: 12px; outline: none; }
        .ai-chat-input input:focus { border-color: var(--primary); }
        .ai-chat-input button { padding: 10px 20px; background: var(--ai-gradient); color: white; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 12px; }
        .ai-chat-input button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .ai-sidebar { display: flex; flex-direction: column; gap: 12px; }
        .ai-quick-actions { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
        .ai-quick-actions h4 { font-size: 12px; margin-bottom: 8px; color: var(--secondary); }
        .quick-action-btn { display: block; width: 100%; padding: 7px 10px; margin-bottom: 5px; background: var(--bg); border: 1px solid var(--border); border-radius: 5px; font-size: 10px; text-align: left; cursor: pointer; transition: all 0.2s; }
        .quick-action-btn:hover { border-color: var(--primary); background: rgba(59,130,246,0.05); }
        
        .ai-data-context { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
        .ai-data-context h4 { font-size: 11px; margin-bottom: 8px; color: var(--muted); }
        .context-item { font-size: 10px; padding: 3px 0; display: flex; justify-content: space-between; }
        
        .typing-indicator { display: flex; gap: 4px; padding: 10px 14px; }
        .typing-dot { width: 8px; height: 8px; background: var(--muted); border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; flex-direction: column; gap: 15px; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 900px) {
            .ai-assistant-container { grid-template-columns: 1fr; }
            .dual-signal-container { grid-template-columns: 1fr; }
        }

        /* Trade Log Styles */
        .form-group-trade {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .form-group-trade label {
            font-size: 10px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
        }
        .form-group-trade input,
        .form-group-trade select {
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 12px;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-group-trade input:focus,
        .form-group-trade select:focus {
            border-color: var(--primary);
        }
        
        .trade-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .trade-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        .trade-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .trade-btn.secondary {
            background: var(--bg);
            color: var(--muted);
            border: 1px solid var(--border);
        }
        .trade-btn.secondary:hover {
            background: var(--border);
        }
        
        .action-btn {
            padding: 6px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .action-btn:hover {
            background: var(--card);
            border-color: var(--primary);
            color: var(--primary);
        }
        .action-btn.danger:hover {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        #tradeTable th {
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 10;
        }
        #tradeTable td {
            vertical-align: middle;
        }
        
        .trade-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            margin-right: 4px;
        }
        .trade-action-btn.edit {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
        }
        .trade-action-btn.delete {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .pnl-positive { color: var(--success); font-weight: 600; }
        .pnl-negative { color: var(--danger); font-weight: 600; }
        
        .status-badge-trade {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
        }
        .status-badge-trade.open { background: rgba(59, 130, 246, 0.15); color: var(--primary); }
        .status-badge-trade.closed { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .status-badge-trade.stopped { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        
        /* Print Styles */
        @media print {
            .login-screen, .header, .tabs, .mode-toggle-container, .symbol-banner,
            .action-btn, .trade-btn, .trade-action-btn, #tradeForm, .ai-sidebar {
                display: none !important;
            }
            .main-app { display: block !important; }
            .card { break-inside: avoid; box-shadow: none; border: 1px solid #ccc; }
            body { background: white; }
        }

        /* Health Monitor Styles */
        .health-banner {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.1));
            border: 2px solid var(--success);
        }
        .health-banner.warning {
            background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(217,119,6,0.1));
            border-color: var(--warning);
        }
        .health-banner.critical {
            background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.1));
            border-color: var(--danger);
        }
        .health-banner-icon { font-size: 32px; }
        .health-banner-content { flex: 1; }
        .health-banner-title { font-size: 18px; font-weight: 700; color: var(--text); }
        .health-banner-subtitle { font-size: 12px; color: var(--muted); margin-top: 2px; }
        .refresh-health-btn {
            padding: 8px 16px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .refresh-health-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16,185,129,0.3); }

        .health-metric {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s;
        }
        .health-metric.healthy { border-color: var(--success); background: rgba(16,185,129,0.05); }
        .health-metric.warning { border-color: var(--warning); background: rgba(245,158,11,0.05); }
        .health-metric.critical { border-color: var(--danger); background: rgba(239,68,68,0.05); }
        .health-metric-icon { font-size: 28px; margin-bottom: 8px; }
        .health-metric-label { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
        .health-metric-value { font-size: 18px; font-weight: 700; margin: 6px 0; }
        .health-metric-status { font-size: 10px; padding: 3px 8px; border-radius: 10px; display: inline-block; }
        .health-metric-status.ok { background: rgba(16,185,129,0.15); color: var(--success); }
        .health-metric-status.warn { background: rgba(245,158,11,0.15); color: var(--warning); }
        .health-metric-status.error { background: rgba(239,68,68,0.15); color: var(--danger); }
        .health-metric-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .health-traffic-light { font-size: 16px; }
        .health-time-since { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg); border-radius: 6px; font-size: 11px; margin-right: 10px; }
        .time-since-light { font-size: 12px; }
        .connection-light { font-size: 12px; }
        .sys-info-table th, .sys-info-table td { text-align: left; }
        .sys-log-table th, .sys-log-table td { text-align: left; }

        .health-timeline { display: flex; flex-direction: column; gap: 10px; }
        .timeline-item { display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg); border-radius: 6px; }
        .timeline-label { color: var(--muted); font-size: 12px; }
        .timeline-value { font-weight: 600; font-size: 12px; }

        .connection-grid { display: flex; flex-direction: column; gap: 10px; }
        .connection-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg); border-radius: 6px; }
        .connection-indicator { font-size: 14px; }
        .connection-indicator.online { color: var(--success); }
        .connection-indicator.offline { color: var(--danger); }
        .connection-indicator.unknown { color: var(--muted); }
        .connection-status { margin-left: auto; font-size: 11px; color: var(--muted); }

        .health-alerts { display: flex; flex-direction: column; gap: 8px; }
        .health-alert {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 12px;
        }
        .health-alert.info { background: rgba(8,145,178,0.1); color: var(--info); border-left: 3px solid var(--info); }
        .health-alert.warning { background: rgba(245,158,11,0.1); color: #b45309; border-left: 3px solid var(--warning); }
        .health-alert.critical { background: rgba(239,68,68,0.1); color: var(--danger); border-left: 3px solid var(--danger); }
        .health-alert.success { background: rgba(16,185,129,0.1); color: var(--success); border-left: 3px solid var(--success); }
        .alert-icon { font-size: 16px; }

        .sys-info-item { background: var(--bg); padding: 12px; border-radius: 6px; }
        .sys-info-label { font-size: 10px; color: var(--muted); text-transform: uppercase; margin-bottom: 4px; }
        .sys-info-value { font-size: 13px; font-weight: 600; }
        .sys-info-value a { color: var(--primary); text-decoration: none; }

        .troubleshoot-accordion { display: flex; flex-direction: column; gap: 8px; }
        .troubleshoot-item { border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
        .troubleshoot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg);
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }
        .troubleshoot-header:hover { background: var(--border); }
        .troubleshoot-toggle { font-size: 18px; color: var(--muted); }
        .troubleshoot-content {
            display: none;
            padding: 16px;
            font-size: 12px;
            line-height: 1.8;
        }
        .troubleshoot-content.show { display: block; }
        .troubleshoot-content ol { margin-left: 20px; }
        .troubleshoot-content li { margin-bottom: 6px; }
        .troubleshoot-content a { color: var(--primary); }

        /* ============================================ */
        /* STICKY HEADER AND TABS                       */
        /* ============================================ */

        /* Main Header - Fixed at top */
        header, .main-header, #mainHeader, .header {
            position: sticky !important;
            top: 0 !important;
            z-index: 1000 !important;
            background: linear-gradient(135deg, #1e1b4b, #312e81) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2) !important;
        }

        /* Mode Toggle (INTRADAY/SWING) - Sticky below header */
        .mode-toggle-container, .mode-toggle, #modeToggle {
            position: sticky !important;
            top: 52px !important;
            z-index: 999 !important;
            background: var(--bg, #f8fafc) !important;
            padding: 10px 0 !important;
            margin: 0 !important;
        }

        /* Symbol Banner - Sticky below mode toggle */
        .symbol-banner, #symbolBanner {
            position: sticky !important;
            top: 100px !important;
            z-index: 998 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }

        /* Tab Navigation - Sticky below symbol banner */
        .tabs, .tab-navigation, #tabNavigation {
            position: sticky !important;
            top: 152px !important;
            z-index: 996 !important;
            background: var(--bg, #f8fafc) !important;
            padding: 4px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            border-bottom: 1px solid var(--border, #e5e7eb) !important;
        }

        /* Ensure tab buttons scroll horizontally if needed */
        .tabs {
            display: flex !important;
            flex-wrap: nowrap !important;
            overflow-x: auto !important;
            scrollbar-width: thin !important;
            -webkit-overflow-scrolling: touch !important;
            gap: 3px !important;
        }

        /* Hide scrollbar but keep functionality */
        .tabs::-webkit-scrollbar {
            height: 4px !important;
        }

        .tabs::-webkit-scrollbar-track {
            background: transparent !important;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2) !important;
            border-radius: 4px !important;
        }

        /* Add padding to main content so it's not hidden behind sticky elements */
        .tab-content, .main-content, #mainContent {
            padding-top: 15px !important;
        }

        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth !important;
        }

        /* Container adjustment for sticky elements */
        .container {
            padding-top: 10px !important;
        }

        /* Sticky wrapper for combined elements */
        .sticky-wrapper {
            position: sticky !important;
            top: 0 !important;
            z-index: 995 !important;
            background: var(--bg, #f8fafc) !important;
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div class="login-screen hidden" id="loginScreen">
        <div class="login-container">
            <div class="login-logo"></div>
            <h1 class="login-title">Stock Agent 4</h1>
            <p class="login-subtitle">Q5D Options Trading Platform</p>
            
            <div class="login-error" id="loginError">
                Invalid username or password. Please try again.
            </div>
            
            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter your username" required autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required autocomplete="current-password">
                </div>
                
                <div class="remember-me">
                    <input type="checkbox" id="rememberMe" checked>
                    <label for="rememberMe">Remember me (stay logged in)</label>
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">
                    Sign In
                </button>
            </form>
            
            <div class="login-footer">
                <p> Secure Access | Powered by Gann Principles</p>
            </div>
        </div>
    </div>

    <!-- MAIN APPLICATION (Hidden until login) -->
    <div class="main-app" id="mainApp">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div>Loading data...</div>
        </div>

        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon"></div>
                    <div><h1>Stock Agent 4</h1><p>Q5D Options Platform</p></div>
                </div>
                
                <div class="live-price-ticker">
                    <div>
                        <div class="ticker-symbol" id="tickerSymbol">SPY</div>
                        <div style="font-size:9px;opacity:0.8;" id="tickerName">S&P 500 ETF</div>
                    </div>
                    <div class="ticker-price" id="tickerPrice">$675.02</div>
                    <div>
                        <div class="ticker-change positive" id="tickerChange">+$6.29</div>
                        <div style="font-size:9px;margin-top:1px;" id="tickerPct">+0.94%</div>
                    </div>
                </div>
                
                <div class="header-market-stats">
                    <div class="header-stat">
                        <span class="header-stat-label">Today:</span>
                        <span class="header-stat-value neutral" id="headerTodayRange">O: $-- | L: $-- | H: $--</span>
                    </div>
                    <div class="header-stat-divider"></div>
                    <div class="header-stat">
                        <span class="header-stat-label">52W:</span>
                        <span class="header-stat-value" id="header52WRange">$-- - $--</span>
                    </div>
                    <div class="header-stat-divider"></div>
                    <div class="header-stat">
                        <span class="header-stat-label">Vol:</span>
                        <span class="header-stat-value neutral" id="headerVolVsAvg">--% vs Avg</span>
                    </div>
                    <div class="header-stat-divider"></div>
                    <div class="header-timestamp" title="Last data refresh time">
                        <span class="ts-dot ts-fresh" id="headerTsDot"></span>
                        <span id="headerTimestamp">Updated: --</span>
                    </div>
                </div>
                
                <div class="header-controls">
                    <div class="status-badge" id="headerHealthBadge" onclick="switchToHealthTab()"><span class="status-dot" id="headerHealthDot"></span><span id="headerHealthText">CHECKING</span></div>
                    <div class="symbol-select">
                        <select id="symbolSelect" onchange="changeSymbol()">
                            <optgroup label="Major ETFs">
                                <option value="SPY">SPY - S&P 500</option>
                                <option value="QQQ">QQQ - Nasdaq 100</option>
                                <option value="IWM">IWM - Russell 2000</option>
                                <option value="DIA">DIA - Dow Jones</option>
                            </optgroup>
                            <optgroup label="Sector ETFs">
                                <option value="XLK">XLK - Technology</option>
                                <option value="XLF">XLF - Financials</option>
                                <option value="XLE">XLE - Energy</option>
                                <option value="XLV">XLV - Healthcare</option>
                                <option value="XLI">XLI - Industrials</option>
                                <option value="XLP">XLP - Consumer Staples</option>
                                <option value="XLU">XLU - Utilities</option>
                                <option value="XLB">XLB - Materials</option>
                                <option value="XLC">XLC - Communication</option>
                                <option value="XLRE">XLRE - Real Estate</option>
                                <option value="XLY">XLY - Consumer Disc</option>
                            </optgroup>
                        </select>
                    </div>
                    <button class="refresh-btn" onclick="loadAllData()"> Refresh</button>
                    <div class="user-info">
                        <div class="user-avatar"></div>
                        <span id="loggedInUser">User</span>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">Logout</button>
                </div>
            </div>
        </header>

    <div class="container">

        <div class="symbol-banner intraday-mode" id="symbolBanner">
            <div><strong id="currentSymbolDisplay">SPY</strong> - <span id="currentSymbolName">S&P 500 ETF</span> | <span id="currentModeDisplay">INTRADAY</span></div>
            <div style="font-size:11px;"> <span id="dataDate">--</span>  <span id="dataTime">--</span></div>
        </div>

        <div class="tabs">
              <button class="tab-btn active" data-tab="overview">Overview</button>
              <button class="tab-btn" data-tab="barcount">Bar Count</button>
              <button class="tab-btn" data-tab="signals-agents">Signals & Agents</button>
              <button class="tab-btn health-tab" data-tab="health">Health</button>
              <button class="tab-btn analysis-tab" data-tab="daily-analysis">Daily Analysis</button>
              <button class="tab-btn" data-tab="mtf-bias">MTF Bias</button>
              <button class="tab-btn" data-tab="trade-journal">Trade Journal</button>
              <button class="tab-btn ai-tab" data-tab="ai-assistant">AI Assistant</button>
              <button class="tab-btn" data-tab="reports">Reports</button>
              <button class="tab-btn" data-tab="gann-analysis">Gann Analysis</button>
              <button class="tab-btn" data-tab="gann-rules">Gann Rules</button>
              <button class="tab-btn charts-tab" data-tab="multi-charts">Multi-Charts</button>
              <button class="tab-btn" data-tab="options-calc">Options Calc</button>
            </div>

        <!-- OVERVIEW TAB -->
        <div id="overview" class="tab-content active">
            <div class="grid grid-5">
                <div class="metric"><div class="metric-label">Price</div><div class="metric-value" id="currentPrice">--</div><div class="metric-sub" id="priceSource">Loading...</div></div>
                <div class="metric"><div class="metric-label">Change</div><div class="metric-value" id="dailyChange">--</div><div class="metric-sub" id="changePct">--</div></div>
                <div class="metric"><div class="metric-label">Volume</div><div class="metric-value" id="volumeDisplay">--</div><div class="metric-sub" id="volumeVsAvgSmall">vs avg</div></div>
                <div class="metric"><div class="metric-label">Signal</div><div class="metric-value" id="signalStatus">--</div><div class="metric-sub" id="signalConf">--</div></div>
                <div class="metric"><div class="metric-label">ATR</div><div class="metric-value" id="atrDisplay">--</div><div class="metric-sub">Volatility</div></div>
            </div>

            <!-- Gann Quick View Summary Table -->
            <div class="card" style="background: linear-gradient(135deg, rgba(139,92,246,0.05) 0%, rgba(59,130,246,0.05) 100%); border: 1px solid rgba(139,92,246,0.2);">
                <div class="card-title" style="color: var(--secondary);"> Gann Quick View - At a Glance Summary</div>
                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                    <tr style="background: rgba(139,92,246,0.1);">
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border);">Trend</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border);">Volume vs Avg</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border);">Bars in Trend</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border);">Cycle Phase</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border);">Next Cycle Turn</th>
                    </tr>
                    <tr>
                        <td style="padding: 10px; text-align: center; border: 1px solid var(--border);"><span id="gannTrendQuick" class="badge badge-success">BULLISH</span></td>
                        <td style="padding: 10px; text-align: center; border: 1px solid var(--border);"><span id="gannVolQuick">--</span></td>
                        <td style="padding: 10px; text-align: center; border: 1px solid var(--border);"><span id="gannBarsInTrend">--</span></td>
                        <td style="padding: 10px; text-align: center; border: 1px solid var(--border);"><span id="gannCyclePhase">Day -- of 30</span></td>
                        <td style="padding: 10px; text-align: center; border: 1px solid var(--border);"><span id="gannNextTurn">--</span></td>
                    </tr>
                    <tr style="background: rgba(59,130,246,0.1);">
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border);">Gann Score</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border);">Agent Consensus</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border);">Reversal Risk</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border);">MTF Alignment</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border);">Entry Window</th>
                    </tr>
                    <tr>
                        <td style="padding: 10px; text-align: center; border: 1px solid var(--border);"><span id="gannScoreQuick" style="font-weight: 700; color: var(--success);">--/100</span></td>
                        <td style="padding: 10px; text-align: center; border: 1px solid var(--border);"><span id="gannConsensusQuick">--/4 Agents</span></td>
                        <td style="padding: 10px; text-align: center; border: 1px solid var(--border);"><span id="gannReversalRisk" class="badge badge-warning">--</span></td>
                        <td style="padding: 10px; text-align: center; border: 1px solid var(--border);"><span id="gannMTFAlign">--/3</span></td>
                        <td style="padding: 10px; text-align: center; border: 1px solid var(--border);"><span id="gannEntryWindow" class="badge badge-info">--</span></td>
                    </tr>
                </table>
            </div>

            <div class="card">
                <div class="card-title"> Reference Data</div>
                <div class="grid grid-4">
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">52W High</span><span class="ref-value positive" id="week52High">--</span></div>
                        <div class="ref-data-row"><span class="ref-label">52W Low</span><span class="ref-value negative" id="week52Low">--</span></div>
                    </div>
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">Today High</span><span class="ref-value" id="todayHigh">--</span></div>
                        <div class="ref-data-row"><span class="ref-label">Today Low</span><span class="ref-value" id="todayLow">--</span></div>
                    </div>
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">Avg Vol (20D)</span><span class="ref-value" id="avgVolume20">--</span></div>
                        <div class="ref-data-row"><span class="ref-label">Vol vs Avg</span><span class="ref-value" id="volumeVsAvg">--</span></div>
                    </div>
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">Open Type</span><span class="badge" id="openTypeBadge">--</span></div>
                        <div class="ref-data-row"><span class="ref-label">Gap</span><span class="ref-value" id="gapDisplay">--</span></div>
                    </div>
                </div>

                <!-- Multi-Timeframe Trend Display -->
                <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-top: 12px;">
                    <div style="font-size: 11px; color: var(--muted); margin-bottom: 8px;">Multi-Timeframe Trend:</div>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 12px;">
                        <div> <strong>Intraday:</strong> <span id="trendIntraday" class="badge badge-success">--</span></div>
                        <div> <strong>Swing:</strong> <span id="trendSwing" class="badge badge-success">--</span></div>
                        <div> <strong>Position:</strong> <span id="trendPosition" class="badge badge-success">--</span></div>
                        <div style="margin-left: auto;"><span id="trendBadge" class="badge">--</span></div>
                    </div>
                </div>

                <!-- Fibonacci Levels Display -->
                <div style="background: linear-gradient(90deg, rgba(239,68,68,0.1) 0%, rgba(245,158,11,0.1) 25%, rgba(16,185,129,0.1) 50%, rgba(59,130,246,0.1) 75%, rgba(139,92,246,0.1) 100%); border-radius: 8px; padding: 12px; margin-top: 12px;">
                    <div style="font-size: 11px; color: var(--muted); margin-bottom: 8px;">Fibonacci Levels:</div>
                    <div id="fibLevelsDisplay" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; font-size: 11px; font-family: monospace;">
                        <span id="fibS3" style="color: var(--danger);">S3: $--</span>
                        <span id="fibS2" style="color: var(--danger);">S2: $--</span>
                        <span id="fibS1" style="color: var(--warning);">S1: $--</span>
                        <span id="fibCurrent" style="background: var(--success); color: white; padding: 4px 8px; border-radius: 4px; font-weight: 700;"> $--</span>
                        <span id="fibR1" style="color: var(--info);">R1: $--</span>
                        <span id="fibR2" style="color: var(--primary);">R2: $--</span>
                        <span id="fibR3" style="color: var(--secondary);">R3: $--</span>
                    </div>
                    <div id="fibZoneText" style="font-size: 10px; color: var(--muted); margin-top: 6px; text-align: center;">Current Zone: --</div>
                </div>
            </div>

            <!-- Trade Statistics Section -->
            <div class="card">
                <div class="card-title"><span id="tradeStatsSymbol">SPY - S&P 500</span>  Trade Statistics (Last 30 Days)</div>
                <div class="grid grid-4" style="margin-bottom: 12px;">
                    <div style="background: var(--bg); border-radius: 6px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Win Rate</div>
                        <div id="statWinRate" style="font-size: 20px; font-weight: 700; color: var(--success);">--%</div>
                    </div>
                    <div style="background: var(--bg); border-radius: 6px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Avg Win</div>
                        <div id="statAvgWin" style="font-size: 20px; font-weight: 700; color: var(--success);">$--</div>
                    </div>
                    <div style="background: var(--bg); border-radius: 6px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Avg Loss</div>
                        <div id="statAvgLoss" style="font-size: 20px; font-weight: 700; color: var(--danger);">$--</div>
                    </div>
                    <div style="background: var(--bg); border-radius: 6px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Total Days</div>
                        <div id="statTotalDays" style="font-size: 20px; font-weight: 700; color: var(--text);">--</div>
                    </div>
                </div>
                <div class="grid grid-3">
                    <div style="background: rgba(16,185,129,0.1); border-radius: 6px; padding: 10px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Best Day</div>
                        <div id="statBestDay" style="font-size: 14px; font-weight: 600; color: var(--success);">+$--</div>
                    </div>
                    <div style="background: rgba(239,68,68,0.1); border-radius: 6px; padding: 10px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Worst Day</div>
                        <div id="statWorstDay" style="font-size: 14px; font-weight: 600; color: var(--danger);">-$--</div>
                    </div>
                    <div style="background: rgba(59,130,246,0.1); border-radius: 6px; padding: 10px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Current Streak</div>
                        <div id="statCurrentStreak" style="font-size: 14px; font-weight: 600; color: var(--primary);">-- days</div>
                    </div>
                </div>
            </div>

            <!-- Historical Analysis Summary -->
            <div class="card" style="background: linear-gradient(135deg, rgba(59,130,246,0.05) 0%, rgba(16,185,129,0.05) 100%); border: 1px solid rgba(59,130,246,0.2);">
                <div class="card-title" style="color: var(--primary);"> Historical Analysis Summary</div>
                <div id="historicalAnalysisSummary" style="font-size: 12px; line-height: 1.8;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Gap Analysis:</div>
                            <div id="gapAnalysisText" style="color: var(--muted);">Analyzing gaps...</div>
                            <div id="gapImplication" style="font-size: 11px; margin-top: 3px;">--</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Pattern Detected:</div>
                            <div id="patternDetectedText" style="color: var(--muted);">Scanning for patterns...</div>
                            <div id="patternImplication" style="font-size: 11px; margin-top: 3px;">--</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Volume Trend:</div>
                            <div id="volumeTrendText" style="color: var(--muted);">Calculating volume...</div>
                            <div id="volumeImplication" style="font-size: 11px; margin-top: 3px;">--</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Price vs Volume:</div>
                            <div id="priceVsVolumeText" style="color: var(--muted);">Analyzing divergence...</div>
                            <div id="priceVsVolumeImplication" style="font-size: 11px; margin-top: 3px;">--</div>
                        </div>
                    </div>
                    <div style="background: var(--bg); border-radius: 6px; padding: 10px; margin-top: 12px;">
                        <div style="font-weight: 600; margin-bottom: 5px;">CONCLUSION:</div>
                        <div id="analysisConclusion" style="color: var(--text);">Generating analysis...</div>
                    </div>
                </div>
            </div>

            <!-- Historical Data Reference Section -->
            <div class="card">
                <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span> Historical Data Reference</span>
                    <div style="display: flex; gap: 8px;">
                        <select id="historicalPeriod" onchange="updateHistoricalData()" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; background: var(--bg);">
                            <option value="7">7 Days</option>
                            <option value="30" selected>30 Days</option>
                            <option value="90">90 Days</option>
                            <option value="365">1 Year</option>
                        </select>
                        <button onclick="updateHistoricalData()" style="padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                             Refresh
                        </button>
                    </div>
                </div>
                <div id="historicalDataCount" style="font-size: 11px; color: var(--muted); margin-bottom: 10px;">Loading historical data...</div>
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
                    <table style="width: 100%; font-size: 11px;">
                        <thead style="position: sticky; top: 0; background: var(--card); z-index: 1;">
                            <tr>
                                <th style="padding: 8px 4px;">Date</th>
                                <th style="padding: 8px 4px;">Open</th>
                                <th style="padding: 8px 4px;">High</th>
                                <th style="padding: 8px 4px;">Low</th>
                                <th style="padding: 8px 4px;">Close</th>
                                <th style="padding: 8px 4px;">Volume</th>
                                <th style="padding: 8px 4px;">Change</th>
                                <th style="padding: 8px 4px;">%</th>
                                <th style="padding: 8px 4px;">OH Signal</th>
                                <th style="padding: 8px 4px;">Pattern</th>
                                <th style="padding: 8px 4px;">Implication</th>
                            </tr>
                        </thead>
                        <tbody id="historicalDataBody">
                            <tr>
                                <td colspan="11" style="text-align: center; color: var(--muted); padding: 20px;">Loading historical data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- AI Analysis Section -->
            <div class="card">
                <div class="card-title"> AI Data Analysis</div>
                <p style="font-size: 11px; color: var(--muted); margin-bottom: 12px;">Ask questions about the historical data above. The AI has access to all OHLCV data for analysis.</p>

                <!-- Quick Analysis Buttons -->
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                    <button onclick="askAIAnalysis('Find patterns')" class="ai-quick-btn" style="padding: 8px 14px; background: rgba(59,130,246,0.1); color: var(--primary); border: 1px solid var(--primary); border-radius: 6px; cursor: pointer; font-size: 11px;">
                         Find Patterns
                    </button>
                    <button onclick="askAIAnalysis('Calculate averages')" class="ai-quick-btn" style="padding: 8px 14px; background: rgba(16,185,129,0.1); color: var(--success); border: 1px solid var(--success); border-radius: 6px; cursor: pointer; font-size: 11px;">
                         Calculate Averages
                    </button>
                    <button onclick="askAIAnalysis('Identify support and resistance levels')" class="ai-quick-btn" style="padding: 8px 14px; background: rgba(245,158,11,0.1); color: var(--warning); border: 1px solid var(--warning); border-radius: 6px; cursor: pointer; font-size: 11px;">
                         Support/Resistance
                    </button>
                    <button onclick="askAIAnalysis('Show trend analysis')" class="ai-quick-btn" style="padding: 8px 14px; background: rgba(139,92,246,0.1); color: #8b5cf6; border: 1px solid #8b5cf6; border-radius: 6px; cursor: pointer; font-size: 11px;">
                         Trend Analysis
                    </button>
                </div>

                <!-- Custom Question Input -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="aiQuestionInput" placeholder="Ask AI about this data... (e.g., 'What's the average daily range?')"
                           style="flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; background: var(--bg);"
                           onkeypress="if(event.key === 'Enter') askAIAnalysis()">
                    <button onclick="askAIAnalysis()" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                        Ask AI
                    </button>
                </div>

                <!-- AI Response Area -->
                <div id="aiResponseArea" style="background: var(--bg); border-radius: 8px; padding: 15px; min-height: 100px; display: none;">
                    <div style="font-size: 11px; color: var(--muted); margin-bottom: 8px;">AI Analysis:</div>
                    <div id="aiResponseContent" style="font-size: 12px; line-height: 1.6; white-space: pre-wrap;"></div>
                </div>
                <div id="aiLoadingIndicator" style="text-align: center; padding: 20px; display: none;">
                    <div style="color: var(--primary);"> Analyzing data...</div>
                </div>
            </div>
        </div>

        <!-- BAR COUNT TAB -->
        <div id="barcount" class="tab-content">
            <!-- QUICK SIGNAL SUMMARY -->
            <div class="card barcount-signal-summary">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:15px;">
                    <div class="card-title" style="margin:0;"> Quick Signal Summary</div>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <div>
                            <label style="font-size:11px;color:var(--muted);">Symbol:</label>
                            <span id="bcSymbol" style="font-weight:700;color:var(--primary);margin-left:5px;">SPY</span>
                        </div>
                        <select id="barCountSelect" onchange="updateBarCountAnalysis()" style="padding:6px 10px;border:1px solid var(--border);border-radius:5px;font-size:11px;">
                            <option value="5">5 Bars</option>
                            <option value="10">10 Bars</option>
                            <option value="15">15 Bars</option>
                            <option value="20" selected>20 Bars</option>
                            <option value="30">30 Bars</option>
                            <option value="50">50 Bars</option>
                        </select>
                    </div>
                </div>

                <!-- Signal Indicators Row -->
                <div class="bc-signal-row">
                    <div class="bc-signal-box" id="bcMainSignal">
                        <div class="bc-signal-label">SIGNAL</div>
                        <div class="bc-signal-value call">CALL</div>
                    </div>
                    <div class="bc-signal-box" id="bcTrendStrength">
                        <div class="bc-signal-label">TREND</div>
                        <div class="bc-signal-value strong">STRONG</div>
                    </div>
                    <div class="bc-signal-box" id="bcReversalRisk">
                        <div class="bc-signal-label">REVERSAL RISK</div>
                        <div class="bc-signal-value low">LOW</div>
                    </div>
                    <div class="bc-signal-box" id="bcEntryWindow">
                        <div class="bc-signal-label">ENTRY WINDOW</div>
                        <div class="bc-signal-value now">NOW</div>
                    </div>
                </div>

                <!-- Plain English Interpretation -->
                <div class="bc-interpretation" id="bcInterpretation">
                    <div class="bc-interpretation-icon"></div>
                    <div class="bc-interpretation-text">
                        <strong>What this means:</strong> All 4 agents are aligned bullish with strong momentum. The trend has room to continue before a reversal is likely. This is a high-probability CALL setup.
                    </div>
                </div>

                <!-- Trade Recommendation Box -->
                <div class="bc-trade-rec" id="bcTradeRec">
                    <div class="bc-trade-rec-header">
                        <span class="bc-trade-rec-title"> TRADE RECOMMENDATION</span>
                        <span class="bc-trade-rec-conf" id="bcRecConfidence">High Confidence (85%)</span>
                    </div>
                    <div class="bc-trade-rec-grid">
                        <div class="bc-trade-rec-item">
                            <span class="bc-rec-label">Direction</span>
                            <span class="bc-rec-value call" id="bcRecDirection"> CALL</span>
                        </div>
                        <div class="bc-trade-rec-item">
                            <span class="bc-rec-label">Strike</span>
                            <span class="bc-rec-value" id="bcRecStrike">$605</span>
                        </div>
                        <div class="bc-trade-rec-item">
                            <span class="bc-rec-label">Expiry</span>
                            <span class="bc-rec-value" id="bcRecExpiry">1-2 DTE</span>
                        </div>
                        <div class="bc-trade-rec-item">
                            <span class="bc-rec-label">Entry</span>
                            <span class="bc-rec-value" id="bcRecEntry">$602.50</span>
                        </div>
                        <div class="bc-trade-rec-item">
                            <span class="bc-rec-label">Stop Loss</span>
                            <span class="bc-rec-value danger" id="bcRecStop">$598.20</span>
                        </div>
                        <div class="bc-trade-rec-item">
                            <span class="bc-rec-label">Target 1</span>
                            <span class="bc-rec-value success" id="bcRecTarget1">$608.50</span>
                        </div>
                        <div class="bc-trade-rec-item">
                            <span class="bc-rec-label">Target 2</span>
                            <span class="bc-rec-value success" id="bcRecTarget2">$612.00</span>
                        </div>
                        <div class="bc-trade-rec-item">
                            <span class="bc-rec-label">Risk/Reward</span>
                            <span class="bc-rec-value" id="bcRecRR">1:2.5</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AGENT BREAKDOWN -->
            <div class="card">
                <div class="card-title"> Agent Breakdown</div>
                <div class="bc-agent-grid">
                    <!-- Base Agent Card -->
                    <div class="bc-agent-card bullish" id="bcAgentBase">
                        <div class="bc-agent-header">
                            <span class="bc-agent-icon"></span>
                            <span class="bc-agent-name">Base Confluence</span>
                            <span class="bc-agent-signal">BULLISH</span>
                        </div>
                        <div class="bc-agent-value" id="baseBarCount">+5</div>
                        <div class="bc-agent-method">Candle Color (Close >= Open)</div>
                        <div class="bc-agent-explain" id="baseAgentExplain">
                            <strong>What this means:</strong> 5 of the last 20 candles closed higher than they opened, showing net buying pressure. Positive = bulls in control.
                        </div>
                    </div>

                    <!-- Gann Agent Card -->
                    <div class="bc-agent-card bullish" id="bcAgentGann">
                        <div class="bc-agent-header">
                            <span class="bc-agent-icon"></span>
                            <span class="bc-agent-name">Gann-Elliott</span>
                            <span class="bc-agent-signal">BULLISH</span>
                        </div>
                        <div class="bc-agent-value" id="gannBarCount">+7</div>
                        <div class="bc-agent-method">Price vs 20-Period MA</div>
                        <div class="bc-agent-explain" id="gannAgentExplain">
                            <strong>What this means:</strong> Price is above the 20-period moving average for 7 bars, confirming an established uptrend with strong momentum.
                        </div>
                    </div>

                    <!-- DQN Agent Card -->
                    <div class="bc-agent-card neutral" id="bcAgentDQN">
                        <div class="bc-agent-header">
                            <span class="bc-agent-icon"></span>
                            <span class="bc-agent-name">DQN/RL</span>
                            <span class="bc-agent-signal">NEUTRAL</span>
                        </div>
                        <div class="bc-agent-value" id="dqnBarCount">+2</div>
                        <div class="bc-agent-method">RSI Momentum (vs 50)</div>
                        <div class="bc-agent-explain" id="dqnAgentExplain">
                            <strong>What this means:</strong> RSI is hovering near 50, indicating balanced momentum. Not overbought, but not strongly bullish either. Cautious stance.
                        </div>
                    </div>

                    <!-- Wave Agent Card -->
                    <div class="bc-agent-card bullish" id="bcAgentWave">
                        <div class="bc-agent-header">
                            <span class="bc-agent-icon"></span>
                            <span class="bc-agent-name">3-Wave</span>
                            <span class="bc-agent-signal">BULLISH</span>
                        </div>
                        <div class="bc-agent-value" id="waveBarCount">+4</div>
                        <div class="bc-agent-method">Higher Closes Pattern</div>
                        <div class="bc-agent-explain" id="waveAgentExplain">
                            <strong>What this means:</strong> 4 consecutive closes higher than the previous close, forming a bullish stair-step pattern. Strong buying continuation.
                        </div>
                    </div>
                </div>

                <!-- Agent Consensus Summary -->
                <div class="bc-consensus-bar" id="bcConsensusBar">
                    <div class="bc-consensus-label">Agent Consensus:</div>
                    <div class="bc-consensus-value" id="barCountConsensus">4/4 BULLISH</div>
                    <div class="bc-consensus-detail" id="barCountConsensusDetail">All 4 agents agree on bullish direction - highest confidence level</div>
                </div>
            </div>

            <!-- REVERSAL RISK SCANNER -->
            <div class="card">
                <div class="card-title"> Reversal Risk Scanner</div>
                <div class="bc-reversal-sections">
                    <!-- Safe to Trade Section -->
                    <div class="bc-reversal-section safe">
                        <div class="bc-reversal-header safe">
                            <span class="bc-reversal-icon"></span>
                            <span class="bc-reversal-title">SAFE TO TRADE</span>
                            <span class="bc-reversal-count" id="bcSafeCount">8 symbols</span>
                        </div>
                        <div class="bc-reversal-list" id="bcSafeList">
                            <!-- Will be populated by JS -->
                            <div class="bc-reversal-item">
                                <span class="bc-rev-symbol">SPY</span>
                                <span class="bc-rev-run">+5 bars</span>
                                <span class="bc-rev-pct">42%</span>
                                <span class="bc-rev-status safe">Good Entry</span>
                            </div>
                        </div>
                    </div>

                    <!-- Caution Section -->
                    <div class="bc-reversal-section caution">
                        <div class="bc-reversal-header caution">
                            <span class="bc-reversal-icon"></span>
                            <span class="bc-reversal-title">CAUTION - OVEREXTENDED</span>
                            <span class="bc-reversal-count" id="bcCautionCount">3 symbols</span>
                        </div>
                        <div class="bc-reversal-list" id="bcCautionList">
                            <!-- Will be populated by JS -->
                            <div class="bc-reversal-item">
                                <span class="bc-rev-symbol">QQQ</span>
                                <span class="bc-rev-run">+12 bars</span>
                                <span class="bc-rev-pct">165%</span>
                                <span class="bc-rev-status caution">Wait for Pullback</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Extended Stats Table -->
                <div class="bc-reversal-table-wrap" style="margin-top:15px;">
                    <table class="bc-reversal-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Avg Bullish</th>
                                <th>Avg Bearish</th>
                                <th>Current</th>
                                <th>% of Avg</th>
                                <th>Risk</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="bcReversalTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- GANN INTEGRATION PANEL -->
            <div class="card">
                <div class="card-title"> Gann Integration Panel</div>
                <p style="font-size:11px;color:var(--muted);margin-bottom:15px;">How Bar Count signals combine with Gann analysis for maximum confluence</p>

                <div class="bc-gann-grid">
                    <!-- Bar Count + Reversal Risk -->
                    <div class="bc-gann-item">
                        <div class="bc-gann-header">
                            <span class="bc-gann-icon"></span>
                            <span class="bc-gann-title">Bar Count Signal</span>
                        </div>
                        <div class="bc-gann-value bullish" id="bcGannBarSignal">+18 BULLISH</div>
                        <div class="bc-gann-detail" id="bcGannBarDetail">Sum of all 4 agents positive</div>
                    </div>

                    <!-- Reversal Risk -->
                    <div class="bc-gann-item">
                        <div class="bc-gann-header">
                            <span class="bc-gann-icon"></span>
                            <span class="bc-gann-title">Reversal Risk</span>
                        </div>
                        <div class="bc-gann-value low" id="bcGannReversalRisk">42% - LOW</div>
                        <div class="bc-gann-detail" id="bcGannReversalDetail">Room for 8+ more bars</div>
                    </div>

                    <!-- Gann Cycle Phase -->
                    <div class="bc-gann-item">
                        <div class="bc-gann-header">
                            <span class="bc-gann-icon"></span>
                            <span class="bc-gann-title">Gann Cycle</span>
                        </div>
                        <div class="bc-gann-value bullish" id="bcGannCycle">Day 12 of 30</div>
                        <div class="bc-gann-detail" id="bcGannCycleDetail">Mid-cycle momentum phase</div>
                    </div>

                    <!-- Square of 9 -->
                    <div class="bc-gann-item">
                        <div class="bc-gann-header">
                            <span class="bc-gann-icon"></span>
                            <span class="bc-gann-title">Square of 9</span>
                        </div>
                        <div class="bc-gann-value" id="bcGannSq9">S: $598 | R: $612</div>
                        <div class="bc-gann-detail" id="bcGannSq9Detail">Price between 90 levels</div>
                    </div>

                    <!-- MTF Alignment -->
                    <div class="bc-gann-item">
                        <div class="bc-gann-header">
                            <span class="bc-gann-icon"></span>
                            <span class="bc-gann-title">MTF Alignment</span>
                        </div>
                        <div class="bc-gann-value bullish" id="bcGannMTF">3/3 BULLISH</div>
                        <div class="bc-gann-detail" id="bcGannMTFDetail">5m, 15m, 1H aligned up</div>
                    </div>

                    <!-- Combined Score -->
                    <div class="bc-gann-item highlight">
                        <div class="bc-gann-header">
                            <span class="bc-gann-icon"></span>
                            <span class="bc-gann-title">COMBINED SCORE</span>
                        </div>
                        <div class="bc-gann-value ultra" id="bcGannCombined">92/100</div>
                        <div class="bc-gann-detail" id="bcGannCombinedDetail">ULTRA HIGH CONFLUENCE</div>
                    </div>
                </div>

                <!-- Final Verdict -->
                <div class="bc-final-verdict" id="bcFinalVerdict">
                    <div class="bc-verdict-header">
                        <span class="bc-verdict-icon"></span>
                        <span class="bc-verdict-title">FINAL VERDICT</span>
                    </div>
                    <div class="bc-verdict-content">
                        <div class="bc-verdict-signal call" id="bcVerdictSignal">STRONG BUY - CALL</div>
                        <div class="bc-verdict-text" id="bcVerdictText">
                            Bar Count (+18) aligns with Gann Cycle (mid-phase bullish), Square of 9 support at $598, and 3/3 MTF bullish.
                            Reversal risk is low (42% of average run). All systems confirm: high-probability CALL setup.
                        </div>
                    </div>
                </div>
            </div>

            <!-- BAR COUNT HISTORY (Collapsed by default) -->
            <div class="card">
                <div class="card-title" style="cursor:pointer;" onclick="toggleBarHistory()">
                     Bar Count History <span id="barHistoryToggle" style="font-size:10px;color:var(--muted);">[Click to expand]</span>
                </div>
                <div id="barHistoryContent" style="display:none;">
                    <div class="table-wrap" style="max-height:300px;overflow-y:auto;">
                        <table>
                            <thead><tr><th>#</th><th>Date</th><th>O/H/L/C</th><th>Dir</th><th>Base</th><th>Gann</th><th>DQN</th><th>Wave</th><th>Avg</th></tr></thead>
                            <tbody id="barCountTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- SIGNALS & AGENTS TAB (Combined) -->
        <div id="signals-agents" class="tab-content">
            <!-- Sub-section: Signal Parameters -->
            <div class="card">
                <div class="card-title"> Intraday vs  Swing vs  Position Parameters</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th style="color:var(--intraday);"> INTRADAY</th>
                                <th style="color:var(--swing);"> SWING</th>
                                <th style="color:var(--secondary);"> POSITION</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Timeframe</td><td>5-min, 15-min</td><td>Daily, 4-Hour</td><td>Weekly, Monthly</td></tr>
                            <tr><td>Options Expiry</td><td>0DTE - 1DTE</td><td>3-5 DTE</td><td>30-60 DTE</td></tr>
                            <tr><td>Fast SMA</td><td>5</td><td>10</td><td>20</td></tr>
                            <tr><td>Slow SMA</td><td>20</td><td>30</td><td>50</td></tr>
                            <tr><td>Stop Loss</td><td>0.5-1.0 ATR</td><td>1.5-2.0 ATR</td><td>2.0-3.0 ATR</td></tr>
                            <tr><td>Target</td><td>1.0-2.0 ATR</td><td>3.0-4.0 ATR</td><td>4.0-6.0 ATR</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sub-section: Agent Signals -->
            <div class="card">
                <div class="card-title"> Agent Signals</div>
                <div class="table-wrap">
                    <table style="font-size: 11px;">
                        <thead>
                            <tr>
                                <th>Agent</th>
                                <th style="color:var(--intraday);"> Intraday</th>
                                <th>Conf</th>
                                <th style="color:var(--swing);"> Swing</th>
                                <th>Conf</th>
                                <th style="color:var(--secondary);"> Position</th>
                                <th>Conf</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td> Base Confluence</td>
                                <td><span class="badge badge-success" id="baseIntradaySignal">CALL</span></td>
                                <td id="baseIntradayConf">72%</td>
                                <td><span class="badge badge-success" id="baseSwingSignal">CALL</span></td>
                                <td id="baseSwingConf">68%</td>
                                <td><span class="badge badge-success" id="basePositionSignal">CALL</span></td>
                                <td id="basePositionConf">65%</td>
                            </tr>
                            <tr>
                                <td> Gann-Elliott</td>
                                <td><span class="badge badge-success" id="gannIntradaySignal">CALL</span></td>
                                <td id="gannIntradayConf">75%</td>
                                <td><span class="badge badge-success" id="gannSwingSignal">CALL</span></td>
                                <td id="gannSwingConf">70%</td>
                                <td><span class="badge badge-success" id="gannPositionSignal">CALL</span></td>
                                <td id="gannPositionConf">72%</td>
                            </tr>
                            <tr>
                                <td> DQN/RL</td>
                                <td><span class="badge badge-warning" id="dqnIntradaySignal">HOLD</span></td>
                                <td id="dqnIntradayConf">58%</td>
                                <td><span class="badge badge-success" id="dqnSwingSignal">CALL</span></td>
                                <td id="dqnSwingConf">65%</td>
                                <td><span class="badge badge-success" id="dqnPositionSignal">CALL</span></td>
                                <td id="dqnPositionConf">68%</td>
                            </tr>
                            <tr>
                                <td> 3-Wave</td>
                                <td><span class="badge badge-success" id="waveIntradaySignal">CALL</span></td>
                                <td id="waveIntradayConf">68%</td>
                                <td><span class="badge badge-success" id="waveSwingSignal">CALL</span></td>
                                <td id="waveSwingConf">72%</td>
                                <td><span class="badge badge-warning" id="wavePositionSignal">HOLD</span></td>
                                <td id="wavePositionConf">55%</td>
                            </tr>
                            <tr style="background:var(--bg);">
                                <td><strong>CONSENSUS</strong></td>
                                <td><span class="badge badge-ultra" id="intradayConsensus">3/4</span></td>
                                <td id="intradayConsensusConf">68%</td>
                                <td><span class="badge badge-ultra" id="swingConsensus">4/4</span></td>
                                <td id="swingConsensusConf">69%</td>
                                <td><span class="badge badge-ultra" id="positionConsensus">3/4</span></td>
                                <td id="positionConsensusConf">65%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sub-section: Fibonacci Levels Enhanced -->
            <div class="card">
                <div class="card-title"> Fibonacci Levels</div>

                <!-- Price Proximity Alert -->
                <div id="fibProximityAlert" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); border: 1px solid var(--warning); border-radius: 8px; padding: 10px 15px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 18px;"></span>
                    <span id="fibProximityText" style="font-size: 12px;"><strong>SPY</strong> is <span id="fibProximityPct">--</span> away from <span id="fibProximityLevel">--</span> (<span id="fibProximityPrice">$--</span>)</span>
                </div>

                <!-- Fibonacci Table -->
                <div class="table-wrap">
                    <table style="font-size: 11px;">
                        <thead>
                            <tr style="background: var(--bg);">
                                <th style="padding: 10px;">Level</th>
                                <th style="padding: 10px;">Price</th>
                                <th style="padding: 10px;">Distance</th>
                                <th style="padding: 10px;">Timeframe</th>
                                <th style="padding: 10px;">Date Set</th>
                                <th style="padding: 10px;">Implication</th>
                            </tr>
                        </thead>
                        <tbody id="fibTableBody">
                            <tr id="fibRowR3">
                                <td style="padding: 8px;"><span id="fibR3Icon"></span> R3 (161.8%)</td>
                                <td style="padding: 8px; font-weight: 600; color: var(--secondary);" id="fibTableR3">$--</td>
                                <td style="padding: 8px;" id="fibDistR3">--%</td>
                                <td style="padding: 8px;" id="fibTfR3">Daily</td>
                                <td style="padding: 8px;" id="fibDateR3">--</td>
                                <td style="padding: 8px; font-size: 10px; color: var(--muted);">Extended target - take profits</td>
                            </tr>
                            <tr id="fibRowR2">
                                <td style="padding: 8px;"><span id="fibR2Icon"></span> R2 (127.2%)</td>
                                <td style="padding: 8px; font-weight: 600; color: var(--primary);" id="fibTableR2">$--</td>
                                <td style="padding: 8px;" id="fibDistR2">--%</td>
                                <td style="padding: 8px;" id="fibTfR2">Daily</td>
                                <td style="padding: 8px;" id="fibDateR2">--</td>
                                <td style="padding: 8px; font-size: 10px; color: var(--muted);">Strong resistance - watch for rejection</td>
                            </tr>
                            <tr id="fibRowR1" style="background: rgba(16, 185, 129, 0.05);">
                                <td style="padding: 8px;"><span id="fibR1Icon"></span> R1 (100%)</td>
                                <td style="padding: 8px; font-weight: 600; color: var(--success);" id="fibTableR1">$--</td>
                                <td style="padding: 8px;" id="fibDistR1">--%</td>
                                <td style="padding: 8px;" id="fibTfR1">Daily</td>
                                <td style="padding: 8px;" id="fibDateR1">--</td>
                                <td style="padding: 8px; font-size: 10px; color: var(--muted);">First resistance - partial profit zone</td>
                            </tr>
                            <tr style="background: var(--bg);">
                                <td colspan="6" style="padding: 6px 8px; text-align: center; font-size: 10px; color: var(--muted);">
                                     Current Price: <strong id="fibCurrentPrice" style="color: var(--text);">$--</strong>
                                </td>
                            </tr>
                            <tr id="fibRowS1" style="background: rgba(239, 68, 68, 0.05);">
                                <td style="padding: 8px;"><span id="fibS1Icon"></span> S1 (38.2%)</td>
                                <td style="padding: 8px; font-weight: 600; color: var(--warning);" id="fibTableS1">$--</td>
                                <td style="padding: 8px;" id="fibDistS1">--%</td>
                                <td style="padding: 8px;" id="fibTfS1">Daily</td>
                                <td style="padding: 8px;" id="fibDateS1">--</td>
                                <td style="padding: 8px; font-size: 10px; color: var(--muted);">First support - potential bounce</td>
                            </tr>
                            <tr id="fibRowS2">
                                <td style="padding: 8px;"><span id="fibS2Icon"></span> S2 (50.0%)</td>
                                <td style="padding: 8px; font-weight: 600; color: var(--danger);" id="fibTableS2">$--</td>
                                <td style="padding: 8px;" id="fibDistS2">--%</td>
                                <td style="padding: 8px;" id="fibTfS2">Daily</td>
                                <td style="padding: 8px;" id="fibDateS2">--</td>
                                <td style="padding: 8px; font-size: 10px; color: var(--muted);">Key support - strong bounce zone</td>
                            </tr>
                            <tr id="fibRowS3">
                                <td style="padding: 8px;"><span id="fibS3Icon"></span> S3 (61.8%)</td>
                                <td style="padding: 8px; font-weight: 600; color: var(--danger);" id="fibTableS3">$--</td>
                                <td style="padding: 8px;" id="fibDistS3">--%</td>
                                <td style="padding: 8px;" id="fibTfS3">Daily</td>
                                <td style="padding: 8px;" id="fibDateS3">--</td>
                                <td style="padding: 8px; font-size: 10px; color: var(--muted);">Deep support - reversal likely if held</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Fib Info Row -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 10px; color: var(--muted);">
                    <span>Swing High: <strong id="fibSwingHighDate">--</strong> | Swing Low: <strong id="fibSwingLowDate">--</strong></span>
                    <span>Timeframe: <strong id="fibTimeframe">Daily (60 bars)</strong></span>
                </div>
            </div>

            <!-- Sub-section: Pattern Recognition Enhanced -->
            <div class="grid grid-3">
                <!-- Technical Patterns -->
                <div class="card">
                    <div class="card-title"> Technical Patterns</div>
                    <div class="pattern-item" id="patternTech1">
                        <div class="pattern-header">
                            <span class="pattern-name" id="patternTech1Name">Double Bottom</span>
                            <span class="badge badge-success" id="patternTech1Conf">72%</span>
                        </div>
                        <div class="pattern-bar"><div class="pattern-fill bullish" id="patternTech1Bar" style="width:72%"></div></div>
                        <div class="pattern-meta">
                            <span class="pattern-date" id="patternTech1Date"> --</span>
                            <span class="pattern-impl" id="patternTech1Impl">Bullish reversal expected</span>
                        </div>
                    </div>
                    <div class="pattern-item" id="patternTech2">
                        <div class="pattern-header">
                            <span class="pattern-name" id="patternTech2Name">Ascending Triangle</span>
                            <span class="badge badge-success" id="patternTech2Conf">65%</span>
                        </div>
                        <div class="pattern-bar"><div class="pattern-fill bullish" id="patternTech2Bar" style="width:65%"></div></div>
                        <div class="pattern-meta">
                            <span class="pattern-date" id="patternTech2Date"> --</span>
                            <span class="pattern-impl" id="patternTech2Impl">Breakout likely above resistance</span>
                        </div>
                    </div>
                    <div class="pattern-item" id="patternTech3" style="display:none;">
                        <div class="pattern-header">
                            <span class="pattern-name" id="patternTech3Name">--</span>
                            <span class="badge badge-muted" id="patternTech3Conf">--%</span>
                        </div>
                        <div class="pattern-bar"><div class="pattern-fill" id="patternTech3Bar" style="width:0%"></div></div>
                        <div class="pattern-meta">
                            <span class="pattern-date" id="patternTech3Date"> --</span>
                            <span class="pattern-impl" id="patternTech3Impl">--</span>
                        </div>
                    </div>
                </div>

                <!-- Candlestick Patterns -->
                <div class="card">
                    <div class="card-title"> Candlestick Patterns</div>
                    <div class="pattern-item" id="patternCandle1">
                        <div class="pattern-header">
                            <span class="pattern-name" id="patternCandle1Name">Bullish Engulfing</span>
                            <span class="badge badge-success" id="patternCandle1Conf">78%</span>
                        </div>
                        <div class="pattern-bar"><div class="pattern-fill bullish" id="patternCandle1Bar" style="width:78%"></div></div>
                        <div class="pattern-meta">
                            <span class="pattern-date" id="patternCandle1Date"> --</span>
                            <span class="pattern-impl" id="patternCandle1Impl">Strong bullish signal</span>
                        </div>
                    </div>
                    <div class="pattern-item" id="patternCandle2">
                        <div class="pattern-header">
                            <span class="pattern-name" id="patternCandle2Name">Hammer</span>
                            <span class="badge badge-success" id="patternCandle2Conf">70%</span>
                        </div>
                        <div class="pattern-bar"><div class="pattern-fill bullish" id="patternCandle2Bar" style="width:70%"></div></div>
                        <div class="pattern-meta">
                            <span class="pattern-date" id="patternCandle2Date"> --</span>
                            <span class="pattern-impl" id="patternCandle2Impl">Reversal after downtrend</span>
                        </div>
                    </div>
                    <div class="pattern-item" id="patternCandle3" style="display:none;">
                        <div class="pattern-header">
                            <span class="pattern-name" id="patternCandle3Name">--</span>
                            <span class="badge badge-muted" id="patternCandle3Conf">--%</span>
                        </div>
                        <div class="pattern-bar"><div class="pattern-fill" id="patternCandle3Bar" style="width:0%"></div></div>
                        <div class="pattern-meta">
                            <span class="pattern-date" id="patternCandle3Date"> --</span>
                            <span class="pattern-impl" id="patternCandle3Impl">--</span>
                        </div>
                    </div>
                </div>

                <!-- Point & Figure Patterns -->
                <div class="card">
                    <div class="card-title"> Point & Figure</div>
                    <div class="pattern-item" id="patternPF1">
                        <div class="pattern-header">
                            <span class="pattern-name" id="patternPF1Name">Double Top BO</span>
                            <span class="badge badge-success" id="patternPF1Conf">75%</span>
                        </div>
                        <div class="pattern-bar"><div class="pattern-fill bullish" id="patternPF1Bar" style="width:75%"></div></div>
                        <div class="pattern-meta">
                            <span class="pattern-date" id="patternPF1Date"> --</span>
                            <span class="pattern-impl" id="patternPF1Impl">Bullish breakout confirmed</span>
                        </div>
                    </div>
                    <div class="pattern-item" id="patternPF2">
                        <div class="pattern-header">
                            <span class="pattern-name" id="patternPF2Name">Bullish Catapult</span>
                            <span class="badge badge-success" id="patternPF2Conf">68%</span>
                        </div>
                        <div class="pattern-bar"><div class="pattern-fill bullish" id="patternPF2Bar" style="width:68%"></div></div>
                        <div class="pattern-meta">
                            <span class="pattern-date" id="patternPF2Date"> --</span>
                            <span class="pattern-impl" id="patternPF2Impl">Momentum continuation</span>
                        </div>
                    </div>
                    <div class="pattern-item" id="patternPF3" style="display:none;">
                        <div class="pattern-header">
                            <span class="pattern-name" id="patternPF3Name">--</span>
                            <span class="badge badge-muted" id="patternPF3Conf">--%</span>
                        </div>
                        <div class="pattern-bar"><div class="pattern-fill" id="patternPF3Bar" style="width:0%"></div></div>
                        <div class="pattern-meta">
                            <span class="pattern-date" id="patternPF3Date"> --</span>
                            <span class="pattern-impl" id="patternPF3Impl">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TRADES TAB - COMPREHENSIVE TRADE LOG -->
        <div id="trades" class="tab-content">
            <!-- Trade Statistics Dashboard -->
            <div class="grid grid-5">
                <div class="metric">
                    <div class="metric-label">Total Trades</div>
                    <div class="metric-value" id="statTotalTrades">0</div>
                    <div class="metric-sub" id="statTradesThisWeek">0 this week</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Win Rate</div>
                    <div class="metric-value positive" id="statWinRate">0%</div>
                    <div class="metric-sub" id="statWinLoss">0W / 0L</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Total P&L</div>
                    <div class="metric-value" id="statTotalPnL">$0.00</div>
                    <div class="metric-sub" id="statAvgTrade">Avg: $0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Best Trade</div>
                    <div class="metric-value positive" id="statBestTrade">$0.00</div>
                    <div class="metric-sub" id="statBestSymbol">--</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Worst Trade</div>
                    <div class="metric-value negative" id="statWorstTrade">$0.00</div>
                    <div class="metric-sub" id="statWorstSymbol">--</div>
                </div>
            </div>

            <!-- Log New Trade Form -->
            <div class="card">
                <div class="card-title"> Log New Trade</div>
                <form id="tradeForm" onsubmit="logTrade(event)">
                    <div class="grid grid-4" style="margin-bottom:12px;">
                        <div class="form-group-trade">
                            <label>Date</label>
                            <input type="date" id="tradeDate" required>
                        </div>
                        <div class="form-group-trade">
                            <label>Symbol</label>
                            <select id="tradeSymbol" required>
                                <option value="SPY">SPY</option>
                                <option value="QQQ">QQQ</option>
                                <option value="IWM">IWM</option>
                                <option value="DIA">DIA</option>
                                <option value="XLK">XLK</option>
                                <option value="XLF">XLF</option>
                                <option value="XLV">XLV</option>
                                <option value="XLE">XLE</option>
                            </select>
                        </div>
                        <div class="form-group-trade">
                            <label>Direction</label>
                            <select id="tradeDirection" required>
                                <option value="CALL"> CALL</option>
                                <option value="PUT"> PUT</option>
                            </select>
                        </div>
                        <div class="form-group-trade">
                            <label>Trade Type</label>
                            <select id="tradeType" required>
                                <option value="INTRADAY"> Intraday (0DTE)</option>
                                <option value="SWING"> Swing (3-5 DTE)</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-5" style="margin-bottom:12px;">
                        <div class="form-group-trade">
                            <label>Strike Price</label>
                            <input type="number" id="tradeStrike" placeholder="675" step="1" required>
                        </div>
                        <div class="form-group-trade">
                            <label>Contracts</label>
                            <select id="tradeContracts" required>
                                <option value="1">1 Contract</option>
                                <option value="2">2 Contracts</option>
                                <option value="3">3 Contracts</option>
                                <option value="4">4 Contracts</option>
                                <option value="5">5 Contracts</option>
                                <option value="10">10 Contracts</option>
                            </select>
                        </div>
                        <div class="form-group-trade">
                            <label>Entry Premium</label>
                            <input type="number" id="tradeEntry" placeholder="2.50" step="0.01" required>
                        </div>
                        <div class="form-group-trade">
                            <label>Exit Premium</label>
                            <input type="number" id="tradeExit" placeholder="3.75" step="0.01">
                        </div>
                        <div class="form-group-trade">
                            <label>Agent Consensus</label>
                            <select id="tradeConsensus">
                                <option value="4/4">4/4 ULTRA</option>
                                <option value="3/4" selected>3/4 SUPER</option>
                                <option value="2/4">2/4 SINGLE</option>
                                <option value="1/4">1/4 WEAK</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-2" style="margin-bottom:12px;">
                        <div class="form-group-trade">
                            <label>Status</label>
                            <select id="tradeStatus" onchange="toggleExitField()">
                                <option value="CLOSED"> Closed</option>
                                <option value="OPEN"> Open</option>
                                <option value="STOPPED"> Stopped Out</option>
                            </select>
                        </div>
                        <div class="form-group-trade">
                            <label>Notes</label>
                            <input type="text" id="tradeNotes" placeholder="Morning breakout, hit T1...">
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;">
                        <button type="submit" class="trade-btn primary"> Log Trade</button>
                        <button type="button" class="trade-btn secondary" onclick="clearTradeForm()">Clear Form</button>
                    </div>
                </form>
            </div>

            <!-- Trade Actions Bar -->
            <div class="card" style="padding:10px;">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                    <div style="display:flex;gap:8px;align-items:center;">
                        <label style="font-size:11px;color:var(--muted);">Filter:</label>
                        <select id="filterSymbol" onchange="filterTrades()" style="padding:5px;border:1px solid var(--border);border-radius:4px;font-size:11px;">
                            <option value="ALL">All Symbols</option>
                            <option value="SPY">SPY</option>
                            <option value="QQQ">QQQ</option>
                            <option value="IWM">IWM</option>
                            <option value="DIA">DIA</option>
                        </select>
                        <select id="filterDirection" onchange="filterTrades()" style="padding:5px;border:1px solid var(--border);border-radius:4px;font-size:11px;">
                            <option value="ALL">All Directions</option>
                            <option value="CALL">CALL Only</option>
                            <option value="PUT">PUT Only</option>
                        </select>
                        <select id="filterStatus" onchange="filterTrades()" style="padding:5px;border:1px solid var(--border);border-radius:4px;font-size:11px;">
                            <option value="ALL">All Status</option>
                            <option value="OPEN">Open</option>
                            <option value="CLOSED">Closed</option>
                            <option value="STOPPED">Stopped</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="action-btn" onclick="printTrades()"> Print</button>
                        <button class="action-btn" onclick="exportCSV()"> Export CSV</button>
                        <button class="action-btn" onclick="shareTrades()"> Share</button>
                        <button class="action-btn" onclick="emailTrades()"> Email</button>
                        <button class="action-btn danger" onclick="clearAllTrades()"> Clear All</button>
                    </div>
                </div>
            </div>

            <!-- Trade History Table -->
            <div class="card">
                <div class="card-title"> Trade History <span id="tradeCount" style="font-size:11px;color:var(--muted);margin-left:8px;">(0 trades)</span></div>
                <div class="table-wrap" style="max-height:400px;overflow-y:auto;">
                    <table id="tradeTable">
                        <thead>
                            <tr>
                                <th style="width:30px;">#</th>
                                <th>Date</th>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Strike</th>
                                <th>Contracts</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>P&L</th>
                                <th>Consensus</th>
                                <th>Status</th>
                                <th>Notes</th>
                                <th style="width:80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tradeTableBody">
                            <tr><td colspan="13" style="text-align:center;color:var(--muted);padding:30px;">No trades logged yet. Start by logging your first trade above!</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Trade Analytics -->
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-title"> Performance by Symbol</div>
                    <div id="symbolPerformance">
                        <p style="color:var(--muted);font-size:12px;">Log trades to see performance breakdown</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title"> Performance by Direction</div>
                    <div id="directionPerformance">
                        <p style="color:var(--muted);font-size:12px;">Log trades to see CALL vs PUT performance</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title"> Agent Consensus Analysis</div>
                <div id="consensusAnalysis" class="grid grid-4">
                    <div style="background:var(--bg);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--muted);">4/4 ULTRA</div>
                        <div style="font-size:20px;font-weight:700;" id="ultra44WinRate">--%</div>
                        <div style="font-size:10px;color:var(--muted);" id="ultra44Count">0 trades</div>
                    </div>
                    <div style="background:var(--bg);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--muted);">3/4 SUPER</div>
                        <div style="font-size:20px;font-weight:700;" id="super34WinRate">--%</div>
                        <div style="font-size:10px;color:var(--muted);" id="super34Count">0 trades</div>
                    </div>
                    <div style="background:var(--bg);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--muted);">2/4 SINGLE</div>
                        <div style="font-size:20px;font-weight:700;" id="single24WinRate">--%</div>
                        <div style="font-size:10px;color:var(--muted);" id="single24Count">0 trades</div>
                    </div>
                    <div style="background:var(--bg);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--muted);">1/4 WEAK</div>
                        <div style="font-size:20px;font-weight:700;" id="weak14WinRate">--%</div>
                        <div style="font-size:10px;color:var(--muted);" id="weak14Count">0 trades</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HEALTH MONITOR TAB -->
        <div id="health" class="tab-content">
            <!-- Traffic Light Summary Banner -->
            <div class="health-banner" id="healthBanner">
                <div class="health-banner-icon" id="healthBannerIcon"></div>
                <div class="health-banner-content">
                    <div class="health-banner-title" id="healthBannerTitle">ALL SYSTEMS OPERATIONAL</div>
                    <div class="health-banner-subtitle" id="healthBannerSubtitle">4/4 Green</div>
                </div>
                <div class="health-time-since" id="timeSinceUpdate">
                    <span class="time-since-light" id="timeSinceLight"></span>
                    <span id="timeSinceText">Data updated -- ago</span>
                </div>
                <div class="section-timestamp" id="healthTimestamp" style="margin-right: 10px;"><span class="ts-dot ts-fresh" id="healthTsDot"></span><span id="healthTsText"> --:--</span></div>
                <button class="refresh-health-btn" onclick="runHealthCheck()"> Run Check</button>
            </div>

            <!-- Health Metrics Grid with Traffic Lights -->
            <div class="grid grid-4">
                <div class="health-metric" id="healthDataFresh">
                    <div class="health-metric-header">
                        <div class="health-metric-icon"></div>
                        <div class="health-traffic-light" id="dataFreshnessLight"></div>
                    </div>
                    <div class="health-metric-label">Data Freshness</div>
                    <div class="health-metric-value" id="dataFreshnessValue">Checking...</div>
                    <div class="health-metric-status" id="dataFreshnessStatus">--</div>
                </div>
                <div class="health-metric" id="healthMarket">
                    <div class="health-metric-header">
                        <div class="health-metric-icon"></div>
                        <div class="health-traffic-light" id="marketStatusLight"></div>
                    </div>
                    <div class="health-metric-label">Market Status</div>
                    <div class="health-metric-value" id="marketStatusValue">Checking...</div>
                    <div class="health-metric-status" id="marketStatusStatus">--</div>
                </div>
                <div class="health-metric" id="healthWorkflow">
                    <div class="health-metric-header">
                        <div class="health-metric-icon"></div>
                        <div class="health-traffic-light" id="workflowStatusLight"></div>
                    </div>
                    <div class="health-metric-label">Agent Workflow</div>
                    <div class="health-metric-value" id="workflowStatusValue">Checking...</div>
                    <div class="health-metric-status" id="workflowStatusStatus">--</div>
                </div>
                <div class="health-metric" id="healthDataQuality">
                    <div class="health-metric-header">
                        <div class="health-metric-icon"></div>
                        <div class="health-traffic-light" id="dataQualityLight"></div>
                    </div>
                    <div class="health-metric-label">Data Quality</div>
                    <div class="health-metric-value" id="dataQualityValue">Checking...</div>
                    <div class="health-metric-status" id="dataQualityStatus">--</div>
                </div>
            </div>

            <!-- Detailed Status Cards -->
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-title"> Data Timeline</div>
                    <div class="health-timeline">
                        <div class="timeline-item">
                            <span class="timeline-label">Last Data Point:</span>
                            <span class="timeline-value" id="lastDataDate">--</span>
                        </div>
                        <div class="timeline-item">
                            <span class="timeline-label">Days Since Update:</span>
                            <span class="timeline-value" id="daysSinceUpdate">--</span>
                        </div>
                        <div class="timeline-item">
                            <span class="timeline-label">Expected Update:</span>
                            <span class="timeline-value" id="expectedUpdate">--</span>
                        </div>
                        <div class="timeline-item">
                            <span class="timeline-label">Total Bars Loaded:</span>
                            <span class="timeline-value" id="totalBarsLoaded">--</span>
                        </div>
                        <div class="timeline-item">
                            <span class="timeline-label">Date Range:</span>
                            <span class="timeline-value" id="dataDateRange">--</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"> Connection Status</div>
                    <div class="connection-grid">
                        <div class="connection-item">
                            <span class="connection-light" id="connGitHubLight"></span>
                            <span class="connection-indicator" id="connGitHub"></span>
                            <span>GitHub Pages</span>
                            <span class="connection-status" id="connGitHubStatus">--</span>
                        </div>
                        <div class="connection-item">
                            <span class="connection-light" id="connDataLight"></span>
                            <span class="connection-indicator" id="connData"></span>
                            <span>Data Feed (SPY.csv)</span>
                            <span class="connection-status" id="connDataStatus">--</span>
                        </div>
                        <div class="connection-item">
                            <span class="connection-light" id="connPortfolioLight"></span>
                            <span class="connection-indicator" id="connPortfolio"></span>
                            <span>Portfolio Feed</span>
                            <span class="connection-status" id="connPortfolioStatus">--</span>
                        </div>
                        <div class="connection-item">
                            <span class="connection-light" id="connLocalStorageLight"></span>
                            <span class="connection-indicator" id="connLocalStorage"></span>
                            <span>Local Storage</span>
                            <span class="connection-status" id="connLocalStorageStatus">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alerts & Issues -->
            <div class="card">
                <div class="card-title"> Alerts & Issues</div>
                <div id="healthAlerts" class="health-alerts">
                    <div class="health-alert info">
                        <span class="alert-icon"></span>
                        <span>Running initial health check...</span>
                    </div>
                </div>
            </div>

            <!-- System Info with Last Run -->
            <div class="card">
                <div class="card-title"> System Information</div>
                <div class="table-wrap">
                    <table class="sys-info-table" style="font-size: 11px;">
                        <thead>
                            <tr style="background: var(--bg);">
                                <th style="padding: 8px;">Component</th>
                                <th style="padding: 8px;">Value / Status</th>
                                <th style="padding: 8px;">Last Run</th>
                                <th style="padding: 8px;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 8px;">Platform Version</td>
                                <td style="padding: 8px;">Stock Agent 4 v7.1</td>
                                <td style="padding: 8px; color: var(--muted);">--</td>
                                <td style="padding: 8px;"><span id="sysInfoVersionLight"></span></td>
                            </tr>
                            <tr>
                                <td style="padding: 8px;">Data Fetch</td>
                                <td style="padding: 8px;">Tiingo API</td>
                                <td style="padding: 8px;" id="sysInfoDataFetchTime">--</td>
                                <td style="padding: 8px;"><span id="sysInfoDataFetchLight"></span></td>
                            </tr>
                            <tr>
                                <td style="padding: 8px;">Agent Workflow</td>
                                <td style="padding: 8px;">9:35 AM & 4:05 PM ET</td>
                                <td style="padding: 8px;" id="sysInfoWorkflowTime">--</td>
                                <td style="padding: 8px;"><span id="sysInfoWorkflowLight"></span></td>
                            </tr>
                            <tr>
                                <td style="padding: 8px;">Confluence Agent</td>
                                <td style="padding: 8px;">4-Agent AI Consensus (Groq)</td>
                                <td style="padding: 8px;" id="sysInfoConfluenceTime">--</td>
                                <td style="padding: 8px;"><span id="sysInfoConfluenceLight"></span></td>
                            </tr>
                            <tr>
                                <td style="padding: 8px;">Daily Analysis</td>
                                <td style="padding: 8px;">Technical Analysis Reports</td>
                                <td style="padding: 8px;" id="sysInfoDailyAnalysisTime">--</td>
                                <td style="padding: 8px;"><span id="sysInfoDailyAnalysisLight"></span></td>
                            </tr>
                            <tr>
                                <td style="padding: 8px;">Health Check</td>
                                <td style="padding: 8px;">On Page Load</td>
                                <td style="padding: 8px;" id="sysInfoHealthCheckTime">--</td>
                                <td style="padding: 8px;"><span id="sysInfoHealthCheckLight"></span></td>
                            </tr>
                            <tr>
                                <td style="padding: 8px;">GitHub Deploy</td>
                                <td style="padding: 8px;"><a href="https://github.com/aadey002/Stock-agent-" target="_blank">Stock-agent-</a></td>
                                <td style="padding: 8px;" id="sysInfoDeployTime">--</td>
                                <td style="padding: 8px;"><span id="sysInfoDeployLight"></span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- System Log -->
            <div class="card">
                <div class="card-title"> System Log (Last 10 Events)</div>
                <div class="table-wrap">
                    <table class="sys-log-table" style="font-size: 11px;">
                        <thead>
                            <tr style="background: var(--bg);">
                                <th style="padding: 8px; width: 150px;">Date/Time</th>
                                <th style="padding: 8px;">Event</th>
                                <th style="padding: 8px; width: 100px;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="systemLogBody">
                            <tr>
                                <td style="padding: 8px; color: var(--muted);">--</td>
                                <td style="padding: 8px;">No events logged yet</td>
                                <td style="padding: 8px;"><span></span> Waiting</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 8px; text-align: right;">
                    <button class="btn-sm" onclick="clearSystemLog()" style="font-size: 10px; padding: 4px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">Clear Log</button>
                </div>
            </div>

            <!-- Troubleshooting Guide -->
            <div class="card">
                <div class="card-title"> Troubleshooting Guide</div>
                <div class="troubleshoot-accordion">
                    <div class="troubleshoot-item">
                        <div class="troubleshoot-header" onclick="toggleTroubleshoot(this)">
                            <span> Data Not Updating</span>
                            <span class="troubleshoot-toggle">+</span>
                        </div>
                        <div class="troubleshoot-content">
                            <ol>
                                <li>Check GitHub Actions: <a href="https://github.com/aadey002/Stock-agent-/actions" target="_blank">View Workflows</a></li>
                                <li>Verify TIINGO_TOKEN secret is set in repository settings</li>
                                <li>Check if market was open (no updates on weekends/holidays)</li>
                                <li>Manually trigger workflow: Actions  Run workflow</li>
                                <li>Check workflow logs for errors</li>
                            </ol>
                        </div>
                    </div>
                    <div class="troubleshoot-item">
                        <div class="troubleshoot-header" onclick="toggleTroubleshoot(this)">
                            <span> Dashboard Shows Stale Data</span>
                            <span class="troubleshoot-toggle">+</span>
                        </div>
                        <div class="troubleshoot-content">
                            <ol>
                                <li>Hard refresh: Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)</li>
                                <li>Clear browser cache</li>
                                <li>Check if gh-pages branch has latest data</li>
                                <li>Verify GitHub Pages deployment completed</li>
                            </ol>
                        </div>
                    </div>
                    <div class="troubleshoot-item">
                        <div class="troubleshoot-header" onclick="toggleTroubleshoot(this)">
                            <span> Workflow Failing</span>
                            <span class="troubleshoot-toggle">+</span>
                        </div>
                        <div class="troubleshoot-content">
                            <ol>
                                <li>Check Actions tab for error messages</li>
                                <li>Common issues: API rate limits, invalid token, network timeouts</li>
                                <li>Verify Python dependencies are installed</li>
                                <li>Check if Tiingo API is operational</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI ASSISTANT TAB -->
        <div id="ai-assistant" class="tab-content">
            <div class="ai-assistant-container">
                <div class="ai-chat-panel">
                    <div class="ai-chat-header">
                        <div class="ai-avatar"></div>
                        <div style="flex: 1;">
                            <div style="font-weight:700;">Gann Trading Assistant</div>
                            <div style="font-size:10px;opacity:0.9;">Powered by Ollama  <span id="ollamaModel">gemma3:4b</span></div>
                        </div>
                        <div class="ollama-status" style="text-align: right; font-size: 10px;">
                            <div id="ollamaStatus"><span style="color: var(--muted);"> Checking...</span></div>
                        </div>
                    </div>
                    <div class="ai-chat-messages" id="aiChatMessages">
                        <div class="ai-message assistant">
                            <div class="message-content">Welcome to the Gann Trading Assistant! 

I'm powered by **Ollama (gemma3:4b)** running locally, trained on W.D. Gann's principles from "Tunnel Through the Air", the Mystifying Square (Square of 9), and Divine Proportions.

**Make sure Ollama is running:** `ollama serve`

I can help you with:
  Analyze any ETF/stock on the dashboard
  Find high-consensus trades (3/4, 4/4)
  Recommend optimal strikes & entries
  Gann time cycles & Square of 9
  Fibonacci/Divine Proportions
  Generate custom reports

Try: "Analyze SPY for today" or "Find best CALL setups"</div>
                        </div>
                    </div>
                    <div class="ai-chat-input">
                        <input type="text" id="aiInput" placeholder="Ask about trades, Gann methods, analysis..." onkeypress="if(event.key==='Enter')sendAiMessage()">
                        <button onclick="sendAiMessage()" id="aiSendBtn">Send</button>
                    </div>
                </div>
                
                <div class="ai-sidebar">
                    <div class="ai-quick-actions">
                        <h4> Quick Actions</h4>
                        <button class="quick-action-btn" onclick="askAi('Show me all ETFs with 3/4 or 4/4 agent consensus today')"> High Consensus Trades</button>
                        <button class="quick-action-btn" onclick="askAi('Which ETFs are breaking out today?')"> Morning Breakouts</button>
                        <button class="quick-action-btn" onclick="askAi('Scan for all patterns')"> Pattern Scan</button>
                        <button class="quick-action-btn" onclick="askAi('Show momentum rankings')"> Momentum Leaders</button>
                        <button class="quick-action-btn" onclick="askAi('Any reversal patterns forming?')"> Reversal Scan</button>
                        <button class="quick-action-btn" onclick="askAi('What are the best CALL options for the next 2 days?')"> Best CALLs</button>
                        <button class="quick-action-btn" onclick="askAi('What are the best PUT options for the next 2 days?')"> Best PUTs</button>
                        <button class="quick-action-btn" onclick="askAi('What is the optimal strike for ' + currentSymbol + '?')"> Optimal Strike</button>
                        <button class="quick-action-btn" onclick="askAi('When is the best time to trade options?')"> Best Time to Trade</button>
                        <button class="quick-action-btn" onclick="askAi('Show bar count for all ETFs')"> Bar Count</button>
                    </div>
                    
                    <div class="ai-data-context">
                        <h4> Current Context</h4>
                        <div class="context-item"><span>Symbol:</span><span id="aiContextSymbol">SPY</span></div>
                        <div class="context-item"><span>Price:</span><span id="aiContextPrice">$675.02</span></div>
                        <div class="context-item"><span>Signal:</span><span id="aiContextSignal">CALL</span></div>
                        <div class="context-item"><span>Consensus:</span><span id="aiContextConsensus">3/4</span></div>
                        <div class="context-item"><span>Mode:</span><span id="aiContextMode">INTRADAY</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DAILY ANALYSIS TAB -->
        <div id="daily-analysis" class="tab-content">
            <div class="analysis-header">
                <div>
                    <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 4px;"> Daily Trading Analysis</h2>
                    <p style="font-size: 12px; color: var(--muted);">Comprehensive signal confluence with Gann & Fibonacci analysis</p>
                </div>
                <div class="analysis-time">
                    <button class="analysis-time-btn active" onclick="switchAnalysisMode('morning')" id="morningBtn"> Morning Plan</button>
                    <button class="analysis-time-btn" onclick="switchAnalysisMode('evening')" id="eveningBtn"> Evening Review</button>
                </div>
                <div class="analysis-time" id="intradaySwingContainer" style="margin-left: 15px; border-left: 2px solid var(--border); padding-left: 15px; display: none;">
                    <button class="analysis-time-btn" onclick="switchTradeMode('intraday')" id="intradayModeBtn" style="background: linear-gradient(135deg, var(--intraday), #d97706); color: white;"> Intraday</button>
                    <button class="analysis-time-btn" onclick="switchTradeMode('swing')" id="swingModeBtn"> Swing</button>
                </div>
                <div class="report-actions">
                    <button class="report-btn primary" onclick="generateDailyReport()"> Generate Report</button>
                    <button class="report-btn success" onclick="downloadReport()"> Download PDF</button>
                    <button class="report-btn warning" onclick="refreshAnalysis()"> Refresh</button>
                </div>
                <div class="section-timestamp" id="dailyAnalysisTimestamp" title="Last analysis update">
                    <span class="ts-dot ts-fresh" id="dailyAnalysisTsDot"></span>
                    <span id="dailyAnalysisTsText"> --:-- --</span>
                </div>
            </div>

            <!-- Daily Analysis Main Content (shown by default) -->
            <div id="dailyAnalysisMain">
            <!-- Market Conditions Guard Rail -->
            <div id="marketConditionsGuardRail" class="card" style="margin-bottom: 15px; border: 2px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="card-title" style="margin: 0;"> Market Conditions Guard Rail</div>
                    <div id="overallMarketStatus" style="padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 14px; background: var(--success); color: white;">
                         SAFE TO TRADE
                    </div>
                </div>

                <div class="grid grid-4" style="gap: 12px;">
                    <!-- VIX Status -->
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;"> VIX Level</div>
                        <div id="vixValue" style="font-size: 20px; font-weight: 700; color: var(--success);">15.2</div>
                        <div id="vixStatus" style="font-size: 11px; color: var(--success);">Low Volatility</div>
                    </div>

                    <!-- SPY Trend -->
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;"> SPY Trend</div>
                        <div id="spyTrendStatus" style="font-size: 14px; font-weight: 700; color: var(--success);">Above 20MA</div>
                        <div id="spyTrendDetail" style="font-size: 11px; color: var(--muted);">+1.2% from MA</div>
                    </div>

                    <!-- Market Breadth -->
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;"> Sector Rotation</div>
                        <div id="sectorRotation" style="font-size: 14px; font-weight: 700; color: var(--success);">Risk-On</div>
                        <div id="sectorDetail" style="font-size: 11px; color: var(--muted);">Tech Leading</div>
                    </div>

                    <!-- Overall Condition -->
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;"> Trade Conditions</div>
                        <div id="tradeConditions" style="font-size: 14px; font-weight: 700; color: var(--success);">Favorable</div>
                        <div id="conditionsDetail" style="font-size: 11px; color: var(--muted);">3/3 Green</div>
                    </div>
                </div>

                <!-- Recommendation -->
                <div id="marketRecommendation" style="margin-top: 12px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 4px solid var(--success);">
                    <span style="font-weight: 600; color: var(--success);"> Market conditions support trading.</span>
                    <span style="font-size: 11px; color: var(--muted);"> Low VIX, uptrend intact, and favorable sector rotation. Proceed with normal position sizing.</span>
                </div>
            </div>

            <!-- Signal Confluence Score -->
            <div class="signal-confluence-card">
                <div style="text-align: center;">
                    <h3 style="font-size: 14px; color: var(--muted); margin-bottom: 5px;"> MASTER SIGNAL CONFLUENCE</h3>
                    <div style="font-size: 12px; color: var(--muted);" id="confluenceSymbol">SPY Analysis</div>
                </div>
                <div class="confluence-score bullish" id="masterConfluenceScore">+7.5</div>
                <div style="text-align: center; margin-bottom: 15px;">
                    <span id="confluenceDirection" style="font-size: 18px; font-weight: 700; color: var(--success);">BULLISH BIAS</span>
                    <span style="font-size: 12px; color: var(--muted); margin-left: 10px;">Confidence: <span id="confluenceConfidence">85%</span></span>
                </div>
                
                <div class="signal-breakdown">
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Agent Consensus</span>
                            <span class="signal-item-score bullish" id="agentScore">4/4</span>
                        </div>
                        <div class="signal-item-detail" id="agentDetail">All 4 agents agree: CALL signal</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Bar Count</span>
                            <span class="signal-item-score bullish" id="barCountScore">+12</span>
                        </div>
                        <div class="signal-item-detail" id="barCountDetail">12 consecutive bullish bars</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Pattern Score</span>
                            <span class="signal-item-score bullish" id="patternScore">+3</span>
                        </div>
                        <div class="signal-item-detail" id="patternDetail">Bull flag + Golden cross detected</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Gann Cycle</span>
                            <span class="signal-item-score bullish" id="gannScore">+2</span>
                        </div>
                        <div class="signal-item-detail" id="gannDetail">Time cycle supports upside</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Fibonacci</span>
                            <span class="signal-item-score neutral" id="fibScore">0</span>
                        </div>
                        <div class="signal-item-detail" id="fibDetail">At 50% retracement level</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Volume</span>
                            <span class="signal-item-score bullish" id="volumeScore">+1.5</span>
                        </div>
                        <div class="signal-item-detail" id="volumeDetail">Above average volume confirmed</div>
                    </div>
                </div>
            </div>

            <!-- Understanding ATR Section -->
            <div class="card" style="margin-top: 15px;">
                <div class="card-title"> Understanding ATR (Average True Range)</div>
                <div style="font-size: 12px; line-height: 1.8; color: var(--muted);" id="atrExplanation">
                    <div style="background: rgba(59,130,246,0.1); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>What is ATR?</strong> ATR measures market volatility - how much a stock typically moves in a day.
                        <br>Current ATR: <span style="color: var(--primary); font-weight: 700;" id="currentATR">$0.00</span>
                        <span style="font-size: 10px;"> (This means the stock typically moves about this much per day)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: var(--bg); padding: 10px; border-radius: 6px;">
                            <strong> How We Use ATR:</strong><br>
                             Entry zones: 0.3-0.5 ATR from price<br>
                             Stop losses: 0.5-1.0 ATR away<br>
                             Profit targets: 1.5-2.5 ATR away
                        </div>
                        <div style="background: var(--bg); padding: 10px; border-radius: 6px;">
                            <strong> Why It Matters:</strong><br>
                             Higher ATR = more volatile<br>
                             Wider stops needed in volatile markets<br>
                             Adjust position size based on ATR
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gann Time Cycles & Square of 9 Section -->
            <div class="card" style="margin-top: 15px;">
                <div class="card-title"> Gann Time Cycles & Square of 9</div>
                <div class="gann-analysis" id="gannAnalysis">
                    <div class="grid grid-2" style="gap: 20px;">
                        <div>
                            <h4 style="font-size: 12px; margin-bottom: 10px;"> Time Cycles</h4>
                            <div style="font-size: 11px; color: var(--muted); line-height: 1.8;" id="gannTimeCycles">
                                 30-day cycle: Bottoming phase<br>
                                 90-day cycle: Mid-cycle thrust<br>
                                 180-day cycle: Bullish continuation<br>
                                 Annual cycle: Q4 strength expected
                            </div>
                        </div>
                        <div>
                            <h4 style="font-size: 12px; margin-bottom: 10px;"> Square of 9 Levels</h4>
                            <div style="font-size: 11px; color: var(--muted); line-height: 1.8;" id="squareOf9">
                                 Resistance 1: <span style="color:var(--danger);font-weight:600;">$685.00</span><br>
                                 Resistance 2: <span style="color:var(--danger);font-weight:600;">$692.50</span><br>
                                 Support 1: <span style="color:var(--success);font-weight:600;">$672.00</span><br>
                                 Support 2: <span style="color:var(--success);font-weight:600;">$665.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Divine Proportions (Phi/Fibonacci) Section -->
            <div class="card" style="margin-top: 15px;">
                <div class="card-title"> Divine Proportions (Phi/Fibonacci)</div>
                <div class="phi-levels" id="phiLevels" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;">
                    <div class="phi-level" style="background: var(--bg); padding: 10px; border-radius: 6px; text-align: center;">
                        <div class="phi-level-name" style="font-size: 10px; color: var(--muted);">23.6% Retrace</div>
                        <div class="phi-level-value" id="phi236" style="font-weight: 600; color: var(--success);">$678.50</div>
                    </div>
                    <div class="phi-level" style="background: var(--bg); padding: 10px; border-radius: 6px; text-align: center;">
                        <div class="phi-level-name" style="font-size: 10px; color: var(--muted);">38.2% Retrace</div>
                        <div class="phi-level-value" id="phi382" style="font-weight: 600; color: var(--success);">$675.20</div>
                    </div>
                    <div class="phi-level" style="background: var(--bg); padding: 10px; border-radius: 6px; text-align: center;">
                        <div class="phi-level-name" style="font-size: 10px; color: var(--muted);">50% Retrace</div>
                        <div class="phi-level-value" id="phi50" style="font-weight: 600; color: var(--warning);">$672.00</div>
                    </div>
                    <div class="phi-level" style="background: var(--bg); padding: 10px; border-radius: 6px; text-align: center;">
                        <div class="phi-level-name" style="font-size: 10px; color: var(--muted);">61.8% (Golden)</div>
                        <div class="phi-level-value" id="phi618" style="font-weight: 600; color: var(--danger);">$668.80</div>
                    </div>
                    <div class="phi-level" style="background: var(--bg); padding: 10px; border-radius: 6px; text-align: center;">
                        <div class="phi-level-name" style="font-size: 10px; color: var(--muted);">78.6% Retrace</div>
                        <div class="phi-level-value" id="phi786" style="font-weight: 600; color: var(--danger);">$664.50</div>
                    </div>
                    <div class="phi-level" style="background: var(--bg); padding: 10px; border-radius: 6px; text-align: center;">
                        <div class="phi-level-name" style="font-size: 10px; color: var(--muted);">161.8% Ext</div>
                        <div class="phi-level-value" id="phi1618" style="font-weight: 600; color: var(--primary);">$695.00</div>
                    </div>
                </div>
            </div>

            <!-- High Consensus Trades Section -->
            <div class="card" style="margin-top: 15px;">
                <div class="card-title"> High Consensus Trades (3/4 or 4/4)</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Signal</th>
                                <th>Consensus</th>
                                <th>Confluence</th>
                                <th>Entry Zone</th>
                                <th>Stop</th>
                                <th>Target</th>
                                <th>Strike</th>
                            </tr>
                        </thead>
                        <tbody id="highConsensusTable">
                            <!-- Generated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Market Context Section -->
            <div class="card" style="margin-top: 15px;">
                <div class="card-title"> Market Context</div>
                <div class="grid grid-3" style="gap: 15px;" id="marketContext">
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 10px; color: var(--muted);">Overall Bias</div>
                        <div style="font-size: 16px; font-weight: 700; color: var(--success);" id="contextOverallBias">BULLISH</div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 10px; color: var(--muted);">Sector Leaders</div>
                        <div style="font-size: 12px; font-weight: 600;" id="sectorLeaders">XLK, XLF</div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 10px; color: var(--muted);">Risk Level</div>
                        <div style="font-size: 16px; font-weight: 700; color: var(--warning);" id="riskLevel">MODERATE</div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Trading Plan -->
            <div class="trading-plan" id="tradingPlanContainer" style="display: none;">
                <div class="trading-plan-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <button onclick="switchAnalysisMode('main')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                                <span></span> Back
                            </button>
                            <div>
                                <h3 style="font-size: 16px; margin-bottom: 4px;" id="planTitle"> Morning Trading Plan</h3>
                                <div style="font-size: 11px; opacity: 0.9;" id="planDate">Wednesday, November 26, 2025</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 11px; opacity: 0.9;">Generated at</div>
                            <div style="font-weight: 600;" id="planTime">9:35 AM ET</div>
                        </div>
                    </div>
                </div>
                <div class="trading-plan-body">
                    <!-- Intraday Section (default visible) -->
                    <div id="intradaySection">
                        <!-- Top Trade Recommendations - Intraday -->
                        <div class="plan-section">
                            <div class="plan-section-title"> Top Trade Recommendations (Intraday)</div>
                            <div id="intradayTradeRecommendations">
                                <!-- Generated dynamically -->
                            </div>
                        </div>

                        <!-- AI Summary - Intraday -->
                        <div class="plan-section" style="border-bottom: none;">
                            <div class="plan-section-title"> AI Trading Summary (Intraday)</div>
                            <div style="background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(217,119,6,0.1)); padding: 15px; border-radius: 8px; font-size: 12px; line-height: 1.8;" id="intradayAISummary">
                                <strong>Morning Analysis:</strong> Market conditions favor bullish positions today. SPY showing strong momentum with 4/4 agent consensus. Key levels to watch: Support at $672 (50% Fib), Resistance at $685 (Square of 9).
                                <br><br>
                                <strong>Recommended Entry Zone:</strong> Tight entry range using 0.3 ATR from current price for quick scalps.
                                <br><br>
                                <strong>Recommended Strategy:</strong> Focus on 0-1 DTE options for intraday momentum plays. Entry on pullbacks to support levels. Quick in-and-out with tight risk management.
                                <br><br>
                                <strong>Stop Loss Levels:</strong> Initial stop at 0.3 ATR. Maximum stop at 0.5 ATR. Cut losses quickly on intraday trades.
                                <br><br>
                                <strong>Profit Targets:</strong> Target 1: 0.8 ATR (scale out 50%). Target 2: 1.5 ATR (close remainder). Don't get greedy on intraday plays.
                                <br><br>
                                <strong>Key Terms Explained:</strong><br>
                                 <em>0-1 DTE:</em> Options expiring same day or next day for maximum gamma exposure<br>
                                 <em>ATR (Average True Range):</em> Measure of volatility used to set stops and targets<br>
                                 <em>Tight Stops:</em> 0.3-0.5 ATR keeps risk minimal on quick trades<br>
                                 <em>Quick Targets:</em> 0.8-1.5 ATR for realistic intraday profit goals
                            </div>
                        </div>
                    </div>

                    <!-- Swing Section (initially hidden) -->
                    <div id="swingSection" style="display: none;">
                        <!-- Top Trade Recommendations - Swing -->
                        <div class="plan-section">
                            <div class="plan-section-title"> Top Trade Recommendations (Swing)</div>
                            <div id="swingTradeRecommendations">
                                <!-- Generated dynamically -->
                            </div>
                        </div>

                        <!-- AI Summary - Swing -->
                        <div class="plan-section" style="border-bottom: none;">
                            <div class="plan-section-title"> AI Trading Summary (Swing)</div>
                            <div style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(109,40,217,0.1)); padding: 15px; border-radius: 8px; font-size: 12px; line-height: 1.8;" id="swingAISummary">
                                <strong>Morning Analysis:</strong> Market conditions favor bullish positions over the next few days. SPY showing strong momentum with 4/4 agent consensus. Multi-day trend setup identified.
                                <br><br>
                                <strong>Recommended Entry Zone:</strong> Wider entry range using 0.5 ATR from current price to allow for overnight gaps.
                                <br><br>
                                <strong>Recommended Strategy:</strong> Focus on 3-5 DTE options for swing trades. Allow positions to develop over multiple sessions. Patience is key for larger moves.
                                <br><br>
                                <strong>Stop Loss Levels:</strong> Initial stop at 0.7 ATR. Maximum stop at 1.2 ATR. Give trades room to breathe through normal volatility.
                                <br><br>
                                <strong>Profit Targets:</strong> Target 1: 2.0 ATR (scale out 50%). Target 2: 3.5 ATR (close remainder). Let winners run on swing trades.
                                <br><br>
                                <strong>Key Terms Explained:</strong><br>
                                 <em>3-5 DTE:</em> Options expiring in 3-5 days for swing trade timeframe<br>
                                 <em>ATR (Average True Range):</em> Measure of volatility used to set stops and targets<br>
                                 <em>Wider Stops:</em> 0.7-1.2 ATR allows for overnight/multi-day volatility<br>
                                 <em>Larger Targets:</em> 2.0-3.5 ATR captures multi-day trend moves
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evening Review Section (Hidden by default) -->
            <div id="eveningReviewSection" style="display: none;">
                <div class="trading-plan">
                    <div class="trading-plan-header" style="background: linear-gradient(135deg, #1e3a5f, #2d1b4e);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <button onclick="switchAnalysisMode('main')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                                    <span></span> Back
                                </button>
                                <div>
                                    <h3 style="font-size: 16px; margin-bottom: 4px;"> Evening Review & Next Day Plan</h3>
                                    <div style="font-size: 11px; opacity: 0.9;" id="eveningDate">Wednesday, November 26, 2025</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 11px; opacity: 0.9;">Market Close</div>
                                <div style="font-weight: 600;">4:00 PM ET</div>
                            </div>
                        </div>
                    </div>
                    <div class="trading-plan-body">
                        <!-- Today's Performance -->
                        <div class="plan-section">
                            <div class="plan-section-title"> Today's Performance</div>
                            <div class="grid grid-4" style="gap: 15px;" id="todayPerformance">
                                <div style="background: rgba(16,185,129,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="spyChange">+0.85%</div>
                                    <div style="font-size: 11px; color: var(--muted);">SPY</div>
                                </div>
                                <div style="background: rgba(16,185,129,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="qqqChange">+1.20%</div>
                                    <div style="font-size: 11px; color: var(--muted);">QQQ</div>
                                </div>
                                <div style="background: rgba(239,68,68,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--danger);" id="iwmChange">-0.35%</div>
                                    <div style="font-size: 11px; color: var(--muted);">IWM</div>
                                </div>
                                <div style="background: rgba(16,185,129,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="diaChange">+0.45%</div>
                                    <div style="font-size: 11px; color: var(--muted);">DIA</div>
                                </div>
                            </div>
                        </div>

                        <!-- Signal Accuracy -->
                        <div class="plan-section">
                            <div class="plan-section-title"> Signal Accuracy Review</div>
                            <div id="signalAccuracy" style="font-size: 12px; line-height: 1.8; color: var(--muted);">
                                 Morning CALL signal on SPY:  Correct (+0.85%)<br>
                                 QQQ breakout prediction:  Correct (+1.20%)<br>
                                 IWM neutral signal:  Missed downside<br>
                                 Overall accuracy today: <span style="color: var(--success); font-weight: 700;">75%</span>
                            </div>
                        </div>

                        <!-- Tomorrow's Outlook -->
                        <div class="plan-section">
                            <div class="plan-section-title"> Tomorrow's Outlook</div>
                            <div id="tomorrowOutlook" style="background: var(--bg); padding: 15px; border-radius: 8px; font-size: 12px; line-height: 1.8;">
                                <strong>Key Events:</strong> Pre-Thanksgiving trading, expect lower volume<br>
                                <strong>Bias:</strong> Continuation of bullish momentum likely<br>
                                <strong>Watch List:</strong> SPY for breakout above $685, QQQ tech rotation<br>
                                <strong>Caution:</strong> Holiday-shortened week, reduced liquidity
                            </div>
                        </div>

                        <!-- Next Day Trade Setups -->
                        <div class="plan-section">
                            <div class="plan-section-title"> Next Day Trade Setups</div>
                            <div id="nextDaySetups">
                                <!-- Generated dynamically -->
                            </div>
                        </div>

                        <!-- Top Trade Recommendations - Evening -->
                        <div class="plan-section">
                            <div class="plan-section-title"> Top Trade Recommendations (Next Day)</div>
                            <div id="eveningTradeRecommendations">
                                <!-- Generated dynamically -->
                            </div>
                        </div>

                        <!-- AI Summary - Evening -->
                        <div class="plan-section" style="border-bottom: none;">
                            <div class="plan-section-title"> AI Trading Summary (Evening Review)</div>
                            <div style="background: linear-gradient(135deg, rgba(30,58,95,0.2), rgba(45,27,78,0.2)); padding: 15px; border-radius: 8px; font-size: 12px; line-height: 1.8;" id="eveningAISummary">
                                <strong>Evening Review / Day Summary:</strong> Today's session showed strong bullish momentum. SPY closed near highs with above-average volume confirming the trend. Agent consensus remained 4/4 bullish throughout the session.
                                <br><br>
                                <strong>Tomorrow's Trading Plan:</strong> Focus on continuation plays if overnight futures hold above today's close. Entry on any pullback to 0.5 ATR from current levels. Use 1-2 DTE options for next-day setups.
                                <br><br>
                                <strong>Gann Cycle Outlook:</strong> 30-day cycle remains supportive through Dec 15. 90-day cycle in mid-thrust phase favors long positions. Watch for potential reversal signals near major cycle dates.
                                <br><br>
                                <strong>Pre-Market Checklist:</strong><br>
                                 Check overnight futures direction and volume<br>
                                 Review any after-hours news or earnings<br>
                                 Verify key support/resistance levels haven't changed<br>
                                 Confirm agent consensus before market open<br>
                                 Set alerts for entry zones identified above
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MULTI-CHARTS TAB -->
                <div id="multi-charts" class="tab-content">
            <div class="card" style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div class="card-title" style="margin: 0;"> Multi-Timeframe Chart Analysis</div>
                    <span class="section-timestamp" id="multiChartsTimestamp"><span class="ts-dot ts-fresh" id="multiChartsTsDot"></span><span id="multiChartsTsText"> --:--</span></span>
                </div>
            </div>

            <!-- MTF Bias Summary -->
            <div class="mtf-summary">
                <div class="mtf-summary-title"> Multi-Timeframe Bias Summary</div>
                <div class="mtf-summary-grid">
                    <div class="mtf-summary-item">
                        <div class="title"> Intraday</div>
                        <div class="value bullish" id="intradayBias">BULLISH</div>
                    </div>
                    <div class="mtf-summary-item">
                        <div class="title"> Swing</div>
                        <div class="value bullish" id="swingBias">BULLISH</div>
                    </div>
                    <div class="mtf-summary-item">
                        <div class="title"> Position</div>
                        <div class="value bearish" id="positionBias">BEARISH</div>
                    </div>
                    <div class="mtf-summary-item">
                        <div class="title"> Confluence</div>
                        <div class="value bullish" id="overallBias">2/3 BULLISH</div>
                    </div>
                </div>
            </div>

            <div class="multi-charts-container">
                <!-- INTRADAY PANEL -->
                <div class="chart-panel">
                    <div class="chart-panel-header">
                        <div class="chart-panel-title">
                            <span class="icon intraday"></span>
                            <span>Intraday</span>
                            <span class="signal-badge-mtf call" id="intradaySignal">CALL</span>
                        </div>
                        <div class="chart-controls">
                            <select id="intradayTimeframe" class="chart-select" onchange="updateChart('intraday')">
                                <option value="5">5 Min</option>
                                <option value="10">10 Min</option>
                                <option value="15" selected>15 Min</option>
                            </select>
                            <select id="intradayChartType" class="chart-select" onchange="updateChart('intraday')">
                                <option value="candlestick">Candlestick</option>
                                <option value="heikinashi">Heikin Ashi</option>
                                <option value="line">Line</option>
                                <option value="pf">Point & Figure</option>
                            </select>
                            <button class="settings-btn-mtf" onclick="toggleMTFSettings('intraday')"></button>
                        </div>
                    </div>
                    <div class="settings-panel-mtf" id="intradaySettings">
                        <div class="settings-row-mtf">
                            <label><input type="checkbox" id="intradayShowEMA" checked onchange="updateChart('intraday')"> EMAs</label>
                            <label><input type="checkbox" id="intradayShowFib" checked onchange="updateChart('intraday')"> Fib Levels</label>
                            <label><input type="checkbox" id="intradayShowPatterns" checked onchange="updateChart('intraday')"> Patterns</label>
                            <label><input type="checkbox" id="intradayShowVolume" checked onchange="updateChart('intraday')"> Volume</label>
                        </div>
                    </div>
                    <div id="intradayPattern" class="pattern-alert-mtf" style="display:none;"></div>
                    <div class="chart-body" id="intradayChartBody">
                        <div class="chart-legend">
                            <span class="symbol" id="intradaySymbol">SPY</span>
                            <span class="price" id="intradayPrice">--</span>
                        </div>
                        <div class="chart-canvas-container" id="intradayChartContainer"></div>
                        <div class="chart-loading" id="intradayLoading">Loading chart...</div>
                    </div>
                    <div class="mtf-legend" id="intradayLegend">
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#f59e0b;"></div> EMA 9</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#3b82f6;"></div> EMA 21</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#8b5cf6;"></div> EMA 50</div>
                    </div>
                    <div class="fib-levels-mtf" id="intradayFib"></div>
                </div>

                <!-- SWING PANEL -->
                <div class="chart-panel">
                    <div class="chart-panel-header">
                        <div class="chart-panel-title">
                            <span class="icon swing"></span>
                            <span>Swing</span>
                            <span class="signal-badge-mtf call" id="swingSignal">CALL</span>
                        </div>
                        <div class="chart-controls">
                            <select id="swingTimeframe" class="chart-select" onchange="updateChart('swing')">
                                <option value="D" selected>Daily</option>
                                <option value="W">Weekly</option>
                            </select>
                            <select id="swingChartType" class="chart-select" onchange="updateChart('swing')">
                                <option value="candlestick">Candlestick</option>
                                <option value="heikinashi">Heikin Ashi</option>
                                <option value="line">Line</option>
                                <option value="pf">Point & Figure</option>
                            </select>
                            <button class="settings-btn-mtf" onclick="toggleMTFSettings('swing')"></button>
                        </div>
                    </div>
                    <div class="settings-panel-mtf" id="swingSettings">
                        <div class="settings-row-mtf">
                            <label><input type="checkbox" id="swingShowEMA" checked onchange="updateChart('swing')"> EMAs</label>
                            <label><input type="checkbox" id="swingShowFib" checked onchange="updateChart('swing')"> Fib Levels</label>
                            <label><input type="checkbox" id="swingShowPatterns" checked onchange="updateChart('swing')"> Patterns</label>
                            <label><input type="checkbox" id="swingShowVolume" checked onchange="updateChart('swing')"> Volume</label>
                        </div>
                    </div>
                    <div id="swingPattern" class="pattern-alert-mtf" style="display:none;"></div>
                    <div class="chart-body" id="swingChartBody">
                        <div class="chart-legend">
                            <span class="symbol" id="swingSymbol">SPY</span>
                            <span class="price" id="swingPrice">--</span>
                        </div>
                        <div class="chart-canvas-container" id="swingChartContainer"></div>
                        <div class="chart-loading" id="swingLoading">Loading chart...</div>
                    </div>
                    <div class="mtf-legend" id="swingLegend">
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#f59e0b;"></div> EMA 9</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#3b82f6;"></div> EMA 21</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#8b5cf6;"></div> EMA 50</div>
                    </div>
                    <div class="fib-levels-mtf" id="swingFib"></div>
                </div>

                <!-- POSITION PANEL -->
                <div class="chart-panel">
                    <div class="chart-panel-header">
                        <div class="chart-panel-title">
                            <span class="icon position"></span>
                            <span>Position</span>
                            <span class="signal-badge-mtf put" id="positionSignal">PUT</span>
                        </div>
                        <div class="chart-controls">
                            <select id="positionTimeframe" class="chart-select" onchange="updateChart('position')">
                                <option value="M" selected>Monthly</option>
                                <option value="Q">Quarterly</option>
                            </select>
                            <select id="positionChartType" class="chart-select" onchange="updateChart('position')">
                                <option value="candlestick">Candlestick</option>
                                <option value="heikinashi">Heikin Ashi</option>
                                <option value="line">Line</option>
                                <option value="pf">Point & Figure</option>
                            </select>
                            <button class="settings-btn-mtf" onclick="toggleMTFSettings('position')"></button>
                        </div>
                    </div>
                    <div class="settings-panel-mtf" id="positionSettings">
                        <div class="settings-row-mtf">
                            <label><input type="checkbox" id="positionShowEMA" checked onchange="updateChart('position')"> EMAs</label>
                            <label><input type="checkbox" id="positionShowFib" checked onchange="updateChart('position')"> Fib Levels</label>
                            <label><input type="checkbox" id="positionShowPatterns" checked onchange="updateChart('position')"> Patterns</label>
                            <label><input type="checkbox" id="positionShowVolume" checked onchange="updateChart('position')"> Volume</label>
                        </div>
                    </div>
                    <div id="positionPattern" class="pattern-alert-mtf" style="display:none;"></div>
                    <div class="chart-body" id="positionChartBody">
                        <div class="chart-legend">
                            <span class="symbol" id="positionSymbol">SPY</span>
                            <span class="price" id="positionPrice">--</span>
                        </div>
                        <div class="chart-canvas-container" id="positionChartContainer"></div>
                        <div class="chart-loading" id="positionLoading">Loading chart...</div>
                    </div>
                    <div class="mtf-legend" id="positionLegend">
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#f59e0b;"></div> EMA 9</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#3b82f6;"></div> EMA 21</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#8b5cf6;"></div> EMA 50</div>
                    </div>
                    <div class="fib-levels-mtf" id="positionFib"></div>
                </div>
            </div>

            <!-- Trend Direction Log -->
            <div class="card">
                <div class="card-title"> Trend Direction Log</div>

                <!-- Trend Streak & Statistics -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 15px;">
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;">Current Streak</div>
                        <div style="font-size: 16px; font-weight: 700;" id="trendStreak">-- days</div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;">Last 14 Days</div>
                        <div style="font-size: 14px; font-weight: 600;" id="trendLast14">-- Bull, -- Bear</div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;">Dominant Trend</div>
                        <div style="font-size: 14px; font-weight: 700;" id="trendDominant">--</div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;">Avg Alignment</div>
                        <div style="font-size: 14px; font-weight: 600;" id="trendAvgAlignment">--/3</div>
                    </div>
                </div>

                <!-- Visual Trend Chart -->
                <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 11px; color: var(--muted); margin-bottom: 10px;">14-Day Trend Score (-3 Bearish to +3 Bullish)</div>
                    <div id="trendChartContainer" style="height: 80px; display: flex; align-items: flex-end; justify-content: space-between; gap: 4px; padding: 0 5px;">
                        <!-- Bars will be generated by JS -->
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 9px; color: var(--muted);">
                        <span id="trendChartStartDate">--</span>
                        <span id="trendChartEndDate">Today</span>
                    </div>
                </div>

                <!-- Trend History Table -->
                <div class="table-wrap" style="max-height: 300px; overflow-y: auto;">
                    <table style="width: 100%; font-size: 11px;">
                        <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                            <tr style="background: var(--bg);">
                                <th style="padding: 8px; text-align: left;">Date</th>
                                <th style="padding: 8px; text-align: center;"> Intraday</th>
                                <th style="padding: 8px; text-align: center;"> Swing</th>
                                <th style="padding: 8px; text-align: center;"> Position</th>
                                <th style="padding: 8px; text-align: center;">Final Direction</th>
                            </tr>
                        </thead>
                        <tbody id="trendLogTable">
                            <!-- Will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Chart Info Card -->
            <div class="card">
                <div class="card-title"> Chart Type Guide</div>
                <div class="grid grid-3" style="gap: 15px;">
                    <div style="background: rgba(245,158,11,0.1); padding: 12px; border-radius: 8px;">
                        <h4 style="font-size: 12px; color: var(--intraday); margin-bottom: 6px;"> Intraday (5-15 min)</h4>
                        <p style="font-size: 11px; color: var(--muted);">Short-term scalping & day trading. Best for 0-1 DTE options.</p>
                    </div>
                    <div style="background: rgba(139,92,246,0.1); padding: 12px; border-radius: 8px;">
                        <h4 style="font-size: 12px; color: var(--swing); margin-bottom: 6px;"> Swing (Daily/Weekly)</h4>
                        <p style="font-size: 11px; color: var(--muted);">Medium-term swing trades. Best for 3-14 DTE options.</p>
                    </div>
                    <div style="background: rgba(16,185,129,0.1); padding: 12px; border-radius: 8px;">
                        <h4 style="font-size: 12px; color: var(--success); margin-bottom: 6px;"> Position (Monthly)</h4>
                        <p style="font-size: 11px; color: var(--muted);">Long-term position trades. Best for 30+ DTE options.</p>
                    </div>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                    <div class="grid grid-4" style="gap: 15px;">
                        <div>
                            <h4 style="font-size: 11px; color: var(--text); margin-bottom: 4px;"> Candlestick</h4>
                            <p style="font-size: 10px; color: var(--muted);">Traditional OHLC candles showing price action.</p>
                        </div>
                        <div>
                            <h4 style="font-size: 11px; color: var(--text); margin-bottom: 4px;"> Heikin Ashi</h4>
                            <p style="font-size: 10px; color: var(--muted);">Smoothed candles that filter noise.</p>
                        </div>
                        <div>
                            <h4 style="font-size: 11px; color: var(--text); margin-bottom: 4px;"> Line</h4>
                            <p style="font-size: 10px; color: var(--muted);">Simple line chart for trend clarity.</p>
                        </div>
                        <div>
                            <h4 style="font-size: 11px; color: var(--text); margin-bottom: 4px;"> Point & Figure</h4>
                            <p style="font-size: 10px; color: var(--muted);">X's and O's with pattern detection.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MTF BIAS TAB -->
        <div id="mtf-bias" class="tab-content">
            <div class="card">
                <div class="card-title"> Multi-Timeframe Bias Analysis - <span id="mtfBiasSymbol" style="color: var(--primary);">SPY</span></div>

                <!-- Current Real-Time MTF Summary -->
                <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(59,130,246,0.1)); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <div style="font-size: 11px; color: var(--muted);">Current Price</div>
                            <div style="font-size: 20px; font-weight: 700;" id="mtfCurrentPrice">$0.00</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--muted);">Today's Alignment</div>
                            <div style="font-size: 20px; font-weight: 700;" id="mtfAlignmentScore">--</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--muted);">Recommendation</div>
                            <div style="font-size: 16px; font-weight: 600;" id="mtfRecommendation">--</div>
                        </div>
                        <div style="display: flex; gap: 8px;" id="mtfQuickBias">
                            <span class="signal-badge" id="mtfBias5m">5m: --</span>
                            <span class="signal-badge" id="mtfBias15m">15m: --</span>
                            <span class="signal-badge" id="mtfBias1h">1h: --</span>
                            <span class="signal-badge" id="mtfBias4h">4h: --</span>
                            <span class="signal-badge" id="mtfBiasD">D: --</span>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 11px; color: var(--muted);" id="mtfSummary">
                        Loading bias data...
                    </div>
                </div>

                <!-- Historical MTF Bias Log -->
                <div style="margin-top: 10px;">
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px;"> Historical Bias Log (Last 30 Days)</div>
                    <div class="table-wrap" style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                                <tr>
                                    <th>Date</th>
                                    <th>Close</th>
                                    <th>5 Min</th>
                                    <th>15 Min</th>
                                    <th>1 Hour</th>
                                    <th>4 Hour</th>
                                    <th>Daily</th>
                                    <th>Score</th>
                                </tr>
                            </thead>
                            <tbody id="mtfHistoryTable">
                                <tr><td colspan="8" style="text-align: center; color: var(--muted);">Loading historical data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Bias Trend Summary -->
                <div style="margin-top: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Bullish Days (30d)</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--success);" id="mtfBullishDays">--</div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Bearish Days (30d)</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--danger);" id="mtfBearishDays">--</div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Neutral Days (30d)</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--warning);" id="mtfNeutralDays">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TRADE JOURNAL TAB -->
        <div id="trade-journal" class="tab-content">
            <div class="card">
                <div class="card-title" style="display: flex; align-items: center; gap: 10px;"> Trade Journal <span class="section-timestamp" id="journalTimestamp"><span class="ts-dot ts-fresh" id="journalTsDot"></span><span id="journalTsText"> --:--</span></span></div>

                <!-- Performance Summary -->
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: var(--bg); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Total Trades</div>
                        <div style="font-size: 24px; font-weight: 700;" id="journalTotalTrades">0</div>
                    </div>
                    <div style="background: var(--bg); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Win Rate</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="journalWinRate">0%</div>
                    </div>
                    <div style="background: var(--bg); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Total P&L</div>
                        <div style="font-size: 24px; font-weight: 700;" id="journalTotalPL">$0</div>
                    </div>
                    <div style="background: var(--bg); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Best Trade</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="journalBestTrade">$0</div>
                    </div>
                    <div style="background: var(--bg); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Worst Trade</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--danger);" id="journalWorstTrade">$0</div>
                    </div>
                </div>

                <!-- Open Positions -->
                <div style="margin-bottom: 20px;">
                    <h4 style="font-size: 14px; margin-bottom: 10px;"> Open Positions</h4>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Type</th>
                                    <th>Entry Price</th>
                                    <th>Current Price</th>
                                    <th>Quantity</th>
                                    <th>P&L</th>
                                    <th>% Change</th>
                                    <th>Entry Date</th>
                                </tr>
                            </thead>
                            <tbody id="openPositionsTable">
                                <tr>
                                    <td colspan="8" style="text-align: center; color: var(--muted);">No open positions</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Trade History -->
                <div>
                    <h4 style="font-size: 14px; margin-bottom: 10px;"> Trade History</h4>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Symbol</th>
                                    <th>Type</th>
                                    <th>Entry</th>
                                    <th>Exit</th>
                                    <th>Quantity</th>
                                    <th>P&L</th>
                                    <th>% Return</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody id="tradeHistoryTable">
                                <tr>
                                    <td colspan="9" style="text-align: center; color: var(--muted);">No trade history available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button onclick="loadTradeJournal()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                         Refresh Journal
                    </button>
                    <button onclick="exportTradeJournal()" style="padding: 8px 16px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                         Export CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- REPORTS TAB -->
        <div id="reports" class="tab-content">
            <div class="card">
                <div class="card-title"> Analysis Reports</div>

                <!-- Playbook Comparison Section -->
                <div style="margin-bottom: 25px;">
                    <h4 style="font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                         Playbook Comparison
                        <span style="font-size: 10px; color: var(--muted); font-weight: normal;">from playbook_comparison.csv</span>
                        <span id="playbookCount" style="font-size: 10px; color: var(--primary); font-weight: normal;"></span>
                        <span class="section-timestamp" id="playbookTimestamp"><span class="ts-dot ts-fresh" id="playbookTsDot"></span><span id="playbookTsText"> --:--</span></span>
                    </h4>
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
                        <table style="width: 100%;">
                            <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 1;">
                                <tr>
                                    <th>Date</th>
                                    <th>Signal</th>
                                    <th>Confluence</th>
                                    <th>Entry</th>
                                    <th>Stop</th>
                                    <th>Target</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody id="playbookComparisonBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; color: var(--muted);">Loading playbook data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Ultra Confluence Section -->
                <div style="margin-bottom: 25px;">
                    <h4 style="font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                         Ultra Confluence Signals (4/4 Consensus)
                        <span style="font-size: 10px; color: var(--muted); font-weight: normal;">from ultra_confluence_4of4.csv</span>
                        <span id="ultraConfluenceTotal" style="font-size: 10px; color: var(--primary); font-weight: normal;"></span>
                        <span class="section-timestamp" id="ultraConfluenceTimestamp"><span class="ts-dot ts-fresh" id="ultraConfluenceTsDot"></span><span id="ultraConfluenceTsText"> --:--</span></span>
                    </h4>
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
                        <table style="width: 100%;">
                            <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 1;">
                                <tr>
                                    <th>Date</th>
                                    <th>Signal</th>
                                    <th>Votes</th>
                                    <th>Wave/Trend</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody id="ultraConfluenceBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: var(--muted);">Loading ultra confluence data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sector Rotation Section -->
                <div style="margin-bottom: 25px;">
                    <h4 style="font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;"> Sector Rotation Analysis <span class="section-timestamp" id="sectorRotationTimestamp"><span class="ts-dot ts-fresh" id="sectorRotationTsDot"></span><span id="sectorRotationTsText"> --:--</span></span></h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;" id="sectorRotationGrid">
                        <div style="background: rgba(16,185,129,0.1); padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid var(--success);">
                            <div style="font-size: 11px; color: var(--muted);">Leading Sectors</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--success);" id="sectorLeadersReport">-</div>
                        </div>
                        <div style="background: rgba(239,68,68,0.1); padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid var(--danger);">
                            <div style="font-size: 11px; color: var(--muted);">Lagging Sectors</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--danger);" id="sectorLaggardsReport">-</div>
                        </div>
                        <div style="background: rgba(59,130,246,0.1); padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid var(--primary);">
                            <div style="font-size: 11px; color: var(--muted);">Rotation Signal</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--primary);" id="sectorRotationSignal">-</div>
                        </div>
                    </div>
                </div>

                <!-- Sector Performance Table -->
                <div>
                    <h4 style="font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                         Sector Performance Rankings
                        <span style="font-size: 10px; color: var(--muted); font-weight: normal;">from sector_rotation.csv</span>
                    </h4>
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
                        <table style="width: 100%;">
                            <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 1;">
                                <tr>
                                    <th>Sector</th>
                                    <th>Bias</th>
                                    <th>Type</th>
                                    <th>Performance</th>
                                </tr>
                            </thead>
                            <tbody id="sectorRotationBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--muted);">Loading sector data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Refresh Button -->
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button onclick="loadReportsData()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                         Refresh Reports
                    </button>
                    <button onclick="downloadReport('playbook')" style="padding: 8px 16px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                         Download Playbook
                    </button>
                    <button onclick="downloadReport('confluence')" style="padding: 8px 16px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                         Download Confluence
                    </button>
                </div>
            </div>
        </div>

    </div>
    <!-- END CONTAINER -->
    
        <!-- OPTIONS CALCULATOR TAB -->
        <div id="options-calc" class="tab-content">
            <div class="card">
                <div class="card-title"> Options Profit Calculator</div>
                <p style="font-size: 11px; color: var(--muted); margin-bottom: 15px;">Calculate option prices, breakeven points, and Greeks using the Black-Scholes model.</p>

                <div class="grid grid-2" style="gap: 20px;">
                    <!-- Input Panel -->
                    <div style="background: var(--bg); padding: 15px; border-radius: 8px;">
                        <h4 style="font-size: 12px; margin-bottom: 12px; color: var(--text);"> Option Parameters</h4>

                        <div style="display: grid; gap: 12px;">
                            <!-- Stock Price with +/- buttons -->
                            <div class="form-group-trade">
                                <label style="font-size: 11px; color: var(--muted);">Stock Price ($)</label>
                                <div style="display: flex; gap: 4px;">
                                    <button onclick="adjustOptValue('optStockPrice', -5)" style="padding: 8px 10px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text);">-5</button>
                                    <button onclick="adjustOptValue('optStockPrice', -1)" style="padding: 8px 10px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text);">-1</button>
                                    <input type="number" id="optStockPrice" value="600" step="0.01" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--card-bg); color: var(--text); text-align: center;">
                                    <button onclick="adjustOptValue('optStockPrice', 1)" style="padding: 8px 10px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text);">+1</button>
                                    <button onclick="adjustOptValue('optStockPrice', 5)" style="padding: 8px 10px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text);">+5</button>
                                </div>
                            </div>

                            <!-- Strike Price with +/- buttons -->
                            <div class="form-group-trade">
                                <label style="font-size: 11px; color: var(--muted);">Strike Price ($)</label>
                                <div style="display: flex; gap: 4px;">
                                    <button onclick="adjustOptValue('optStrikePrice', -5)" style="padding: 8px 10px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text);">-5</button>
                                    <button onclick="adjustOptValue('optStrikePrice', -1)" style="padding: 8px 10px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text);">-1</button>
                                    <input type="number" id="optStrikePrice" value="605" step="0.01" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--card-bg); color: var(--text); text-align: center;">
                                    <button onclick="adjustOptValue('optStrikePrice', 1)" style="padding: 8px 10px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text);">+1</button>
                                    <button onclick="adjustOptValue('optStrikePrice', 5)" style="padding: 8px 10px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text);">+5</button>
                                </div>
                                <!-- Quick Strike Buttons -->
                                <div style="display: flex; gap: 4px; margin-top: 6px;">
                                    <button onclick="setStrikeATM()" style="flex: 1; padding: 5px; font-size: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">ATM</button>
                                    <button onclick="setStrikeOTM(5)" style="flex: 1; padding: 5px; font-size: 10px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer;">OTM +$5</button>
                                    <button onclick="setStrikeOTM(10)" style="flex: 1; padding: 5px; font-size: 10px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer;">OTM +$10</button>
                                    <button onclick="setStrikeITM(5)" style="flex: 1; padding: 5px; font-size: 10px; background: var(--warning); color: white; border: none; border-radius: 4px; cursor: pointer;">ITM -$5</button>
                                </div>
                            </div>

                            <!-- DTE with preset buttons -->
                            <div class="form-group-trade">
                                <label style="font-size: 11px; color: var(--muted);">Days to Expiration</label>
                                <input type="number" id="optDTE" value="7" min="1" max="365" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--card-bg); color: var(--text);">
                                <!-- Quick DTE Buttons -->
                                <div style="display: flex; gap: 4px; margin-top: 6px;">
                                    <button onclick="setDTE(0)" style="flex: 1; padding: 5px; font-size: 10px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;">0DTE</button>
                                    <button onclick="setDTE(1)" style="flex: 1; padding: 5px; font-size: 10px; background: var(--warning); color: white; border: none; border-radius: 4px; cursor: pointer;">1DTE</button>
                                    <button onclick="setDTE(7)" style="flex: 1; padding: 5px; font-size: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">7D</button>
                                    <button onclick="setDTE(14)" style="flex: 1; padding: 5px; font-size: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">14D</button>
                                    <button onclick="setDTE(30)" style="flex: 1; padding: 5px; font-size: 10px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer;">30D</button>
                                    <button onclick="setDTE(45)" style="flex: 1; padding: 5px; font-size: 10px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer;">45D</button>
                                </div>
                            </div>

                            <!-- IV with +/- buttons -->
                            <div class="form-group-trade">
                                <label style="font-size: 11px; color: var(--muted);">Implied Volatility (%)</label>
                                <div style="display: flex; gap: 4px;">
                                    <button onclick="adjustOptValue('optIV', -5)" style="padding: 8px 10px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text);">-5</button>
                                    <input type="number" id="optIV" value="20" step="0.1" min="1" max="200" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--card-bg); color: var(--text); text-align: center;">
                                    <button onclick="adjustOptValue('optIV', 5)" style="padding: 8px 10px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text);">+5</button>
                                </div>
                                <!-- Quick IV Presets -->
                                <div style="display: flex; gap: 4px; margin-top: 6px;">
                                    <button onclick="setIV(15)" style="flex: 1; padding: 5px; font-size: 10px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer;">Low 15%</button>
                                    <button onclick="setIV(25)" style="flex: 1; padding: 5px; font-size: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">Med 25%</button>
                                    <button onclick="setIV(40)" style="flex: 1; padding: 5px; font-size: 10px; background: var(--warning); color: white; border: none; border-radius: 4px; cursor: pointer;">High 40%</button>
                                    <button onclick="setIV(60)" style="flex: 1; padding: 5px; font-size: 10px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;">VHigh 60%</button>
                                </div>
                            </div>

                            <div class="form-group-trade">
                                <label style="font-size: 11px; color: var(--muted);">Risk-Free Rate (%)</label>
                                <input type="number" id="optRate" value="5.0" step="0.1" min="0" max="20" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--card-bg); color: var(--text);">
                            </div>

                            <!-- Option Type with visual toggle -->
                            <div class="form-group-trade">
                                <label style="font-size: 11px; color: var(--muted);">Option Type</label>
                                <div style="display: flex; gap: 8px;">
                                    <button id="btnCall" onclick="setOptionType('call')" style="flex: 1; padding: 10px; font-size: 12px; font-weight: 600; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer;"> CALL</button>
                                    <button id="btnPut" onclick="setOptionType('put')" style="flex: 1; padding: 10px; font-size: 12px; font-weight: 600; background: var(--card-bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;"> PUT</button>
                                </div>
                                <select id="optType" style="display: none;">
                                    <option value="call">CALL</option>
                                    <option value="put">PUT</option>
                                </select>
                            </div>

                            <!-- Contracts with +/- buttons -->
                            <div class="form-group-trade">
                                <label style="font-size: 11px; color: var(--muted);">Number of Contracts</label>
                                <div style="display: flex; gap: 4px;">
                                    <button onclick="adjustOptValue('optContracts', -1)" style="padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text);">-</button>
                                    <input type="number" id="optContracts" value="1" min="1" max="100" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--card-bg); color: var(--text); text-align: center;">
                                    <button onclick="adjustOptValue('optContracts', 1)" style="padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text);">+</button>
                                    <button onclick="setContracts(5)" style="padding: 8px 10px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text); font-size: 10px;">5</button>
                                    <button onclick="setContracts(10)" style="padding: 8px 10px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text); font-size: 10px;">10</button>
                                </div>
                            </div>
                        </div>

                        <button onclick="calculateOptionPrice()" style="width: 100%; margin-top: 15px; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                             Calculate
                        </button>

                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button onclick="useCurrentSymbolPrice()" style="flex: 1; padding: 10px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 11px;">
                                 Use Current Price
                            </button>
                            <button onclick="resetOptionsCalc()" style="flex: 1; padding: 10px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 11px;">
                                 Reset
                            </button>
                        </div>
                    </div>

                    <!-- Results Panel -->
                    <div>
                        <!-- Option Price & Key Metrics -->
                        <div style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(16,185,129,0.1)); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="font-size: 12px; margin-bottom: 12px; color: var(--text);"> Option Valuation</h4>
                            <div class="grid grid-2" style="gap: 15px;">
                                <div>
                                    <div style="font-size: 10px; color: var(--muted);">Option Price</div>
                                    <div style="font-size: 24px; font-weight: 700; color: var(--primary);" id="optPriceResult">$0.00</div>
                                    <div style="font-size: 10px; color: var(--muted);" id="optTotalCost">Total: $0.00</div>
                                </div>
                                <div>
                                    <div style="font-size: 10px; color: var(--muted);">Intrinsic Value</div>
                                    <div style="font-size: 18px; font-weight: 600;" id="optIntrinsic">$0.00</div>
                                    <div style="font-size: 10px; color: var(--muted);" id="optExtrinsic">Extrinsic: $0.00</div>
                                </div>
                            </div>
                        </div>

                        <!-- Breakeven & P/L -->
                        <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="font-size: 12px; margin-bottom: 12px; color: var(--text);"> Profit & Loss</h4>
                            <div class="grid grid-3" style="gap: 10px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 10px; color: var(--muted);">Breakeven</div>
                                    <div style="font-size: 16px; font-weight: 600; color: var(--warning);" id="optBreakeven">$0.00</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 10px; color: var(--muted);">Max Profit</div>
                                    <div style="font-size: 16px; font-weight: 600; color: var(--success);" id="optMaxProfit">Unlimited</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 10px; color: var(--muted);">Max Loss</div>
                                    <div style="font-size: 16px; font-weight: 600; color: var(--danger);" id="optMaxLoss">$0.00</div>
                                </div>
                            </div>
                        </div>

                        <!-- Greeks -->
                        <div style="background: var(--bg); padding: 15px; border-radius: 8px;">
                            <h4 style="font-size: 12px; margin-bottom: 12px; color: var(--text);"> The Greeks</h4>
                            <div class="grid grid-4" style="gap: 10px;">
                                <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: 6px;">
                                    <div style="font-size: 10px; color: var(--muted);">Delta</div>
                                    <div style="font-size: 16px; font-weight: 700; color: var(--primary);" id="optDelta">0.00</div>
                                    <div style="font-size: 9px; color: var(--muted);">Price sensitivity</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: 6px;">
                                    <div style="font-size: 10px; color: var(--muted);">Gamma</div>
                                    <div style="font-size: 16px; font-weight: 700; color: var(--success);" id="optGamma">0.00</div>
                                    <div style="font-size: 9px; color: var(--muted);">Delta change</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: 6px;">
                                    <div style="font-size: 10px; color: var(--muted);">Theta</div>
                                    <div style="font-size: 16px; font-weight: 700; color: var(--danger);" id="optTheta">0.00</div>
                                    <div style="font-size: 9px; color: var(--muted);">Time decay/day</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: 6px;">
                                    <div style="font-size: 10px; color: var(--muted);">Vega</div>
                                    <div style="font-size: 16px; font-weight: 700; color: var(--warning);" id="optVega">0.00</div>
                                    <div style="font-size: 9px; color: var(--muted);">IV sensitivity</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- P&L Chart -->
            <div class="card" style="margin-top: 15px;">
                <div class="card-title"> Profit/Loss at Expiration</div>
                
                <!-- Interactive Strike Slider -->
                <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-size: 10px; color: var(--muted); display: block; margin-bottom: 4px;"> Drag Strike Price</label>
                            <input type="range" id="strikeSlider" min="0" max="100" value="50" 
                                   style="width: 100%; cursor: grab; accent-color: var(--warning);"
                                   oninput="updateStrikeFromSlider(this.value)">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button onclick="adjustStrike(-5)" style="width: 32px; height: 32px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); cursor: pointer; font-size: 14px;">-5</button>
                            <button onclick="adjustStrike(-1)" style="width: 28px; height: 28px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); cursor: pointer; font-size: 12px;">-1</button>
                            <span id="strikeDisplay" style="font-size: 14px; font-weight: 600; color: var(--warning); min-width: 70px; text-align: center;">05</span>
                            <button onclick="adjustStrike(1)" style="width: 28px; height: 28px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); cursor: pointer; font-size: 12px;">+1</button>
                            <button onclick="adjustStrike(5)" style="width: 32px; height: 32px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); cursor: pointer; font-size: 14px;">+5</button>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 10px; color: var(--muted);">
                        <span id="sliderMinLabel">20</span>
                        <span>Current: <span id="currentPriceLabel" style="color: var(--primary);">00</span></span>
                        <span id="sliderMaxLabel">80</span>
                    </div>
                </div>

                <div style="height: 300px; position: relative;">
                    <canvas id="optionPnLChart"></canvas>
                </div>
                
                <!-- Chart Legend -->
                <div style="display: flex; justify-content: center; gap: 20px; margin-top: 10px; font-size: 10px;">
                    <span><span style="display: inline-block; width: 12px; height: 3px; background: rgba(245, 158, 11, 0.9); margin-right: 4px;"></span>Strike</span>
                    <span><span style="display: inline-block; width: 12px; height: 3px; background: rgba(59, 130, 246, 0.9); margin-right: 4px;"></span>Current Price</span>
                    <span><span style="display: inline-block; width: 12px; height: 3px; background: rgba(16, 185, 129, 0.9); border-style: dashed; margin-right: 4px;"></span>Breakeven</span>
                </div>
            </div>

            <!-- Quick Reference -->
            <div class="card" style="margin-top: 15px;">
                <div class="card-title"> Greeks Quick Reference</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr><th>Greek</th><th>Measures</th><th>What It Means</th><th>Typical Range</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><strong>Delta</strong></td><td>Price sensitivity</td><td>$ change in option per $1 move in stock</td><td>0 to 1 (calls), 0 to -1 (puts)</td></tr>
                            <tr><td><strong>Gamma</strong></td><td>Delta acceleration</td><td>How fast delta changes as stock moves</td><td>Highest ATM, near expiration</td></tr>
                            <tr><td><strong>Theta</strong></td><td>Time decay</td><td>$ lost per day from time decay</td><td>Always negative for buyers</td></tr>
                            <tr><td><strong>Vega</strong></td><td>Volatility sensitivity</td><td>$ change per 1% change in IV</td><td>Higher for longer DTE</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- GANN ANALYSIS TAB - Monthly Swing Trading Dashboard -->
        <div id="gann-analysis" class="tab-content">
            <!-- MONTH HEADER with Traffic Light -->
            <div class="card" style="background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(59,130,246,0.15)); border: 2px solid var(--primary); margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--primary);" id="gannTradeTitle"> DECEMBER 2025 TRADING PLAN</div>
                        <div style="font-size: 13px; color: var(--text); margin-top: 4px;" id="gannTradeStatus">Your monthly guide to when and what to trade</div>
                    </div>
                    <div id="gannTrafficLight" style="display: flex; align-items: center; gap: 10px; padding: 12px 24px; background: var(--bg); border-radius: 8px;">
                        <span style="font-size: 28px;"></span>
                        <div>
                            <div style="font-size: 16px; font-weight: 700; color: var(--danger);">WAIT</div>
                            <div style="font-size: 10px; color: var(--muted);">Not time yet</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXIT ALERT BANNER - Shows when action needed -->
            <div id="exitAlertBanner" class="card" style="display: none; background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(245,158,11,0.2)); border: 2px solid var(--danger); margin-bottom: 15px; animation: pulse 2s infinite;">
                <div class="card-title" style="color: var(--danger);"> EXIT ALERT - ACTION REQUIRED </div>
                <div class="table-wrap">
                    <table id="exitAlertTable">
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>Alert Type</th>
                                <th>Reason</th>
                                <th>Urgency</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="exitAlertBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- DAILY POSITION REVIEW - Shows each morning -->
            <div id="dailyPositionReview" class="card" style="display: none; background: rgba(245,158,11,0.1); border: 2px solid var(--warning); margin-bottom: 15px;">
                <div class="card-title"> MORNING POSITION REVIEW - <span id="reviewDate">Dec 3, 2025</span></div>
                <div style="font-size: 12px; margin-bottom: 12px;">
                    You have <span id="openPositionCount" style="font-weight: 700;">0</span> open positions. Here's today's status:
                </div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr><th>Position</th><th>Overnight Change</th><th>Today's Outlook</th><th>Action</th></tr>
                        </thead>
                        <tbody id="dailyReviewBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: var(--bg); border-radius: 6px;">
                    <div style="font-size: 12px; font-weight: 700; margin-bottom: 6px;"> TODAY'S KEY LEVELS TO WATCH:</div>
                    <div id="dailyKeyLevels" style="font-size: 11px; color: var(--text);"></div>
                </div>
            </div>

            <!-- OPEN POSITIONS STATUS DASHBOARD -->
            <div id="positionsDashboard" class="card" style="display: none; margin-bottom: 15px;">
                <div class="card-title"> OPEN POSITIONS - Health Check</div>
                <div id="positionsContainer">
                    <!-- Position cards populated by JavaScript -->
                </div>
            </div>

            <!-- EXIT CONFIRMATION MODAL -->
            <div id="exitConfirmModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
                <div style="background: var(--card); border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--danger);"> CONFIRM EXIT</div>
                    <div id="exitConfirmContent">
                        <!-- Populated by JavaScript -->
                    </div>
                    <div style="margin-top: 16px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeExitModal()" style="padding: 10px 20px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text);">Cancel</button>
                        <button onclick="confirmExit()" style="padding: 10px 20px; background: var(--danger); border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600;">CONFIRM CLOSE</button>
                    </div>
                </div>
            </div>

            <!-- ALERT MESSAGE MODAL -->
            <div id="alertMessageModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9998; justify-content: center; align-items: center;">
                <div style="background: var(--card); border-radius: 12px; padding: 24px; max-width: 550px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <div id="alertMessageHeader" style="font-size: 16px; font-weight: 700; margin-bottom: 12px;"></div>
                    <div id="alertMessageContent" style="font-size: 13px; line-height: 1.6;"></div>
                    <div id="alertMessageActions" style="margin-top: 16px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                        <!-- Action buttons populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- TODAY'S SIMPLE ANSWER -->
            <div class="card" style="margin-bottom: 15px;">
                <div class="card-title"> WHAT SHOULD I DO TODAY?</div>
                <div id="gannTodayAction" style="font-size: 32px; font-weight: 700; text-align: center; padding: 20px; background: var(--bg); border-radius: 8px; color: var(--warning);">
                     WAIT - Don't buy anything yet
                </div>
                <div id="gannActionReason" style="text-align: center; font-size: 13px; color: var(--text); margin-top: 10px; padding: 10px; background: rgba(139,92,246,0.1); border-radius: 6px;">
                    <strong>Why?</strong> The market usually changes direction around <span id="gannTurnDateSimple">Dec 5th</span>.
                    Wait until then to buy. You have <span id="gannDaysToWait" style="font-weight: 700; color: var(--primary);">5 days</span> to wait.
                </div>
            </div>

            <!-- DUAL DIRECTION - CALL vs PUT Side by Side -->
            <div class="card" style="margin-bottom: 15px;">
                <div class="card-title"> TWO TRADE OPTIONS - Pick One Based on Market Direction</div>
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 15px;">
                    On the turn date, the market will either go UP or DOWN. Here's what to buy in each case:
                </div>
                <div class="grid grid-2" style="gap: 15px;">
                    <!-- IF MARKET GOES UP -->
                    <div style="background: rgba(16,185,129,0.1); border: 2px solid var(--success); border-radius: 10px; padding: 15px;">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <div style="font-size: 24px;"></div>
                            <div style="font-size: 16px; font-weight: 700; color: var(--success);">IF PRICE GOES UP</div>
                            <div style="font-size: 11px; color: var(--muted);">Buy a CALL (bet that price rises)</div>
                        </div>
                        <table style="width: 100%; font-size: 12px;">
                            <tr><td style="padding: 5px 0; color: var(--muted);">Buy:</td><td style="font-weight: 700;" id="gannCallSymbol">SPY CALL</td></tr>
                            <tr><td style="padding: 5px 0; color: var(--muted);">Strike Price:</td><td style="font-weight: 700;" id="gannCallStrike">$605</td></tr>
                            <tr><td style="padding: 5px 0; color: var(--muted);">Expires:</td><td style="font-weight: 700;" id="gannCallExpiry">Dec 15</td></tr>
                            <tr><td style="padding: 5px 0; color: var(--muted);">Max Pay:</td><td style="font-weight: 700;" id="gannCallMaxPay">$3.50</td></tr>
                            <tr><td colspan="2" style="border-top: 1px solid var(--success); margin: 8px 0;"></td></tr>
                            <tr><td style="padding: 5px 0; color: var(--danger);">Stop Loss:</td><td style="font-weight: 700; color: var(--danger);" id="gannCallStop">Sell at $1.75</td></tr>
                            <tr><td style="padding: 5px 0; color: var(--success);">Target:</td><td style="font-weight: 700; color: var(--success);" id="gannCallTarget">Sell at $5.25</td></tr>
                        </table>
                        <div style="margin-top: 10px; padding: 8px; background: rgba(16,185,129,0.2); border-radius: 6px; text-align: center; font-size: 11px;">
                            <strong>Profit if right:</strong> <span style="color: var(--success);" id="gannCallProfit">+$175 (50%)</span><br>
                            <strong>Loss if wrong:</strong> <span style="color: var(--danger);" id="gannCallLoss">-$175 (50%)</span>
                        </div>
                    </div>

                    <!-- IF MARKET GOES DOWN -->
                    <div style="background: rgba(239,68,68,0.1); border: 2px solid var(--danger); border-radius: 10px; padding: 15px;">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <div style="font-size: 24px;"></div>
                            <div style="font-size: 16px; font-weight: 700; color: var(--danger);">IF PRICE GOES DOWN</div>
                            <div style="font-size: 11px; color: var(--muted);">Buy a PUT (bet that price falls)</div>
                        </div>
                        <table style="width: 100%; font-size: 12px;">
                            <tr><td style="padding: 5px 0; color: var(--muted);">Buy:</td><td style="font-weight: 700;" id="gannPutSymbol">SPY PUT</td></tr>
                            <tr><td style="padding: 5px 0; color: var(--muted);">Strike Price:</td><td style="font-weight: 700;" id="gannPutStrike">$595</td></tr>
                            <tr><td style="padding: 5px 0; color: var(--muted);">Expires:</td><td style="font-weight: 700;" id="gannPutExpiry">Dec 15</td></tr>
                            <tr><td style="padding: 5px 0; color: var(--muted);">Max Pay:</td><td style="font-weight: 700;" id="gannPutMaxPay">$3.50</td></tr>
                            <tr><td colspan="2" style="border-top: 1px solid var(--danger); margin: 8px 0;"></td></tr>
                            <tr><td style="padding: 5px 0; color: var(--danger);">Stop Loss:</td><td style="font-weight: 700; color: var(--danger);" id="gannPutStop">Sell at $1.75</td></tr>
                            <tr><td style="padding: 5px 0; color: var(--success);">Target:</td><td style="font-weight: 700; color: var(--success);" id="gannPutTarget">Sell at $5.25</td></tr>
                        </table>
                        <div style="margin-top: 10px; padding: 8px; background: rgba(239,68,68,0.2); border-radius: 6px; text-align: center; font-size: 11px;">
                            <strong>Profit if right:</strong> <span style="color: var(--success);" id="gannPutProfit">+$175 (50%)</span><br>
                            <strong>Loss if wrong:</strong> <span style="color: var(--danger);" id="gannPutLoss">-$175 (50%)</span>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: var(--bg); border-radius: 6px; font-size: 12px; text-align: center;">
                    <strong>How do I know which way the market will go?</strong><br>
                    <span style="color: var(--muted);">Check the price on the turn date. If it bounces UP from the floor, buy CALL. If it drops DOWN from the ceiling, buy PUT.</span>
                </div>
            </div>

            <!-- TURN DIRECTION EXPLAINED -->
            <div class="card" style="margin-bottom: 15px;">
                <div class="card-title"> WHEN DOES THE MARKET CHANGE DIRECTION?</div>
                <div class="grid grid-2" style="gap: 15px;">
                    <div>
                        <div style="font-size: 13px; margin-bottom: 10px;">
                            <strong>The 30-Day Pattern:</strong> Markets tend to go up and down in a repeating pattern roughly every 30 days.
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: var(--muted);">Where We Are Now</div>
                                <div style="font-size: 18px; font-weight: 700;" id="gann30DayCycle">NEAR BOTTOM</div>
                                <div style="font-size: 11px; color: var(--muted);" id="gann30DayPhase">Day 27 of 30</div>
                            </div>
                            <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: var(--muted);">Next Turn Date</div>
                                <div style="font-size: 18px; font-weight: 700; color: var(--primary);" id="gannNextTurnDate">Dec 5</div>
                                <div style="font-size: 11px; color: var(--muted);" id="gannDaysToTurnText">in 5 days</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 13px; margin-bottom: 10px;">
                            <strong>What "Turn" Means:</strong>
                        </div>
                        <div style="background: rgba(139,92,246,0.1); padding: 12px; border-radius: 8px; font-size: 12px; line-height: 1.6;">
                            <div id="gannTurnExplain">
                                 <strong>NEAR BOTTOM</strong> = Price is low and about to go UP<br>
                                 Best time to buy CALLs (bet on price going up)
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 8px;">
                            <div style="font-size: 10px; color: var(--muted);">Bigger 90-Day Pattern</div>
                            <div style="font-size: 14px; font-weight: 600;" id="gann90DayCycle">Going UP</div>
                            <div style="font-size: 10px; color: var(--muted);" id="gann90DayPhase">Day 45 of 90</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =============================================== -->
            <!-- MONTHLY TRADING DASHBOARD - Trade Each When Ready -->
            <!-- =============================================== -->

            <!-- ENTRY ALERT BANNER - Shows when trades become ready (dynamic based on score) -->
            <div id="entryAlertBanner" class="card" style="display: none; background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(59,130,246,0.2)); border: 2px solid var(--success); margin-bottom: 15px; animation: pulse 2s infinite;">
                <div class="card-title" style="color: var(--success);"> CHECKING TRADE SETUP... </div>
                <div id="entryAlertContent" style="font-size: 13px;">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- POSITION LIMITS & MONTHLY TRACKER -->
            <div class="card" style="margin-bottom: 15px; background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(59,130,246,0.1)); border: 1px solid var(--primary);">
                <div class="card-title"> MONTHLY TRADE TRACKER - Trade Each When Ready</div>
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 15px;">
                    <strong>NEW APPROACH:</strong> Instead of picking just ONE trade, monitor ALL ETFs and trade each one when its entry window opens. Manage risk with position limits.
                </div>

                <!-- Position Limits Display -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center; border: 2px solid var(--border);">
                        <div style="font-size: 10px; color: var(--muted);">ACTIVE POSITIONS</div>
                        <div style="font-size: 28px; font-weight: 700; color: var(--primary);" id="mtActivePositions">0</div>
                        <div style="font-size: 10px; color: var(--muted);">Max: 5</div>
                        <div style="margin-top: 6px; height: 4px; background: var(--border); border-radius: 2px;">
                            <div id="mtPositionBar" style="width: 0%; height: 100%; background: var(--primary); border-radius: 2px; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center; border: 2px solid var(--border);">
                        <div style="font-size: 10px; color: var(--muted);">CAPITAL DEPLOYED</div>
                        <div style="font-size: 28px; font-weight: 700; color: var(--warning);" id="mtCapitalDeployed">0%</div>
                        <div style="font-size: 10px; color: var(--muted);">Max: 50%</div>
                        <div style="margin-top: 6px; height: 4px; background: var(--border); border-radius: 2px;">
                            <div id="mtCapitalBar" style="width: 0%; height: 100%; background: var(--warning); border-radius: 2px; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center; border: 2px solid var(--border);">
                        <div style="font-size: 10px; color: var(--success);">READY TO TRADE</div>
                        <div style="font-size: 28px; font-weight: 700; color: var(--success);" id="mtReadyCount">0</div>
                        <div style="font-size: 10px; color: var(--muted);">Entry window open</div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center; border: 2px solid var(--border);">
                        <div style="font-size: 10px; color: var(--muted);">WAITING</div>
                        <div style="font-size: 28px; font-weight: 700;" id="mtWaitingCount">15</div>
                        <div style="font-size: 10px; color: var(--muted);">Coming soon</div>
                    </div>
                </div>

                <!-- Position Rules Summary -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; font-size: 11px;">
                    <div style="background: rgba(16,185,129,0.1); padding: 10px; border-radius: 6px; text-align: center;">
                        <div style="font-weight: 700; color: var(--success);"> MAX 5 TRADES</div>
                        <div style="color: var(--muted);">at any time</div>
                    </div>
                    <div style="background: rgba(245,158,11,0.1); padding: 10px; border-radius: 6px; text-align: center;">
                        <div style="font-weight: 700; color: var(--warning);"> 10% PER TRADE</div>
                        <div style="color: var(--muted);">of portfolio max</div>
                    </div>
                    <div style="background: rgba(239,68,68,0.1); padding: 10px; border-radius: 6px; text-align: center;">
                        <div style="font-weight: 700; color: var(--danger);"> 50% MAX EXPOSURE</div>
                        <div style="color: var(--muted);">total at risk</div>
                    </div>
                </div>
            </div>

            <!-- ALL ETF TRADING OPPORTUNITIES TABLE -->
            <div class="card" style="margin-bottom: 15px;">
                <div class="card-title"> ALL TRADING OPPORTUNITIES - <span id="mtMonthYear">December 2025</span></div>
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">
                    Click any row to see full details. Green rows = ready to trade now. Yellow = coming soon. Gray = wait.
                </div>
                <div class="table-wrap">
                    <table id="mtOpportunitiesTable" style="font-size: 11px;">
                        <thead>
                            <tr>
                                <th style="width: 70px;">Status</th>
                                <th style="width: 60px;">Symbol</th>
                                <th>Sector</th>
                                <th style="width: 70px;">Price</th>
                                <th style="width: 65px;">Next Turn</th>
                                <th style="width: 45px;">Days</th>
                                <th style="width: 90px;">Turn Dir</th>
                                <th style="width: 50px;">Trade</th>
                                <th style="width: 65px;">Target</th>
                                <th style="width: 100px;">Pattern</th>
                                <th style="width: 45px;">TF</th>
                                <th style="width: 60px;">Detected</th>
                                <th style="width: 50px;">Score</th>
                                <th style="width: 70px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="mtOpportunitiesBody">
                            <!-- Populated by JavaScript with all 15 ETFs -->
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 10px; display: flex; gap: 15px; justify-content: center; font-size: 10px; flex-wrap: wrap;">
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--success); border-radius: 3px; margin-right: 4px;"></span> READY NOW</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--warning); border-radius: 3px; margin-right: 4px;"></span> 1-3 DAYS</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--primary); border-radius: 3px; margin-right: 4px;"></span> 4-7 DAYS</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--muted); border-radius: 3px; margin-right: 4px;"></span> 7+ DAYS</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--danger); border-radius: 3px; margin-right: 4px;"></span> ACTIVE</span>
                </div>
            </div>

            <!-- SECTOR ROTATION INSIGHT -->
            <div class="card" style="margin-bottom: 15px;">
                <div class="card-title"> SECTOR ROTATION - Where Money Is Flowing</div>
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">
                    Sectors rotate in and out of favor. Trade with the flow, not against it.
                </div>
                <div id="sectorRotationGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <!-- Populated by JavaScript -->
                </div>
                <div style="margin-top: 12px; padding: 10px; background: var(--bg); border-radius: 6px;">
                    <div style="font-size: 12px; font-weight: 700; margin-bottom: 6px;"> CURRENT ROTATION PHASE:</div>
                    <div id="rotationPhaseText" style="font-size: 13px; color: var(--text);">
                        <strong style="color: var(--success);">RISK-ON:</strong> Money flowing into growth sectors (Tech, Consumer). Good for aggressive trades.
                    </div>
                </div>
            </div>

            <!-- EXPANDED TRADE DETAIL MODAL -->
            <div id="tradeDetailModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; padding: 20px;">
                <div style="background: var(--card); border-radius: 12px; padding: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div style="font-size: 20px; font-weight: 700;" id="tdSymbolTitle">SPY - S&P 500</div>
                        <button onclick="closeTradeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted);">&times;</button>
                    </div>

                    <!-- Trade Status -->
                    <div id="tdStatusBanner" style="padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 16px; background: rgba(16,185,129,0.15); border: 2px solid var(--success);">
                        <div style="font-size: 16px; font-weight: 700; color: var(--success);"> READY TO TRADE</div>
                        <div style="font-size: 12px; color: var(--muted);">Entry window: Dec 3-7</div>
                    </div>

                    <!-- Price Info -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px;">
                        <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 10px; color: var(--muted);">Current Price</div>
                            <div style="font-size: 20px; font-weight: 700;" id="tdCurrentPrice">$600.00</div>
                        </div>
                        <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 10px; color: var(--muted);">Entry Target</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--success);" id="tdEntryTarget">$595.00</div>
                        </div>
                        <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 10px; color: var(--muted);">Profit Target</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--primary);" id="tdProfitTarget">$615.00</div>
                        </div>
                    </div>

                    <!-- Direction Recommendation -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px;">
                        <div id="tdCallBox" style="background: rgba(16,185,129,0.1); border: 2px solid var(--success); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 700; color: var(--success); margin-bottom: 8px;"> BUY CALL</div>
                            <div style="font-size: 12px;">
                                <div>Strike: <strong id="tdCallStrike">$600</strong></div>
                                <div>Expiry: <strong id="tdCallExpiry">Dec 20</strong></div>
                                <div>Est. Cost: <strong id="tdCallCost">$4.50</strong></div>
                                <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--success);">
                                    Stop: <span style="color: var(--danger);" id="tdCallStop">$2.25</span> |
                                    Target: <span style="color: var(--success);" id="tdCallTargetPrice">$6.75</span>
                                </div>
                            </div>
                        </div>
                        <div id="tdPutBox" style="background: rgba(239,68,68,0.1); border: 2px solid var(--danger); padding: 15px; border-radius: 8px; opacity: 0.5;">
                            <div style="font-size: 14px; font-weight: 700; color: var(--danger); margin-bottom: 8px;"> BUY PUT</div>
                            <div style="font-size: 12px;">
                                <div>Strike: <strong id="tdPutStrike">$600</strong></div>
                                <div>Expiry: <strong id="tdPutExpiry">Dec 20</strong></div>
                                <div>Est. Cost: <strong id="tdPutCost">$4.00</strong></div>
                                <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--danger);">
                                    Stop: <span style="color: var(--danger);" id="tdPutStop">$2.00</span> |
                                    Target: <span style="color: var(--success);" id="tdPutTargetPrice">$6.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Score Breakdown -->
                    <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: 12px; font-weight: 700; margin-bottom: 10px;"> TRADE SCORE BREAKDOWN</div>
                        <div style="display: grid; gap: 6px; font-size: 11px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Timing Score</span>
                                <span id="tdTimingScore" style="font-weight: 600;">25/30</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Price Position</span>
                                <span id="tdPriceScore" style="font-weight: 600;">20/25</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Trend Alignment</span>
                                <span id="tdTrendScore" style="font-weight: 600;">18/20</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Sector Strength</span>
                                <span id="tdSectorScore" style="font-weight: 600;">12/15</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-top: 6px; border-top: 1px solid var(--border); font-weight: 700;">
                                <span>TOTAL SCORE</span>
                                <span id="tdTotalScore" style="color: var(--success);">85/100</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="addToWatchlist()" style="flex: 1; min-width: 120px; padding: 12px; background: var(--primary); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">
                             Add to Watchlist
                        </button>
                        <button onclick="startTrade()" id="tdStartTradeBtn" style="flex: 1; min-width: 120px; padding: 12px; background: var(--success); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">
                             Start This Trade
                        </button>
                        <button onclick="closeTradeDetailModal()" style="flex: 1; min-width: 120px; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            </div>

            <!-- VISUAL CALENDAR WITH ENTRY WINDOWS -->
            <div class="card" style="margin-bottom: 15px;">
                <div class="card-title"> ENTRY WINDOW CALENDAR - <span id="mtCalendarMonth">December 2025</span></div>
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">
                    Each ETF has its own entry window. Multiple can be open at once. Hover over marked days to see which ETFs.
                </div>
                <div id="mtCalendarHeader" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 11px; margin-bottom: 4px;">
                    <div style="text-align: center; font-weight: 700; padding: 6px; color: var(--muted);">Sun</div>
                    <div style="text-align: center; font-weight: 700; padding: 6px; color: var(--muted);">Mon</div>
                    <div style="text-align: center; font-weight: 700; padding: 6px; color: var(--muted);">Tue</div>
                    <div style="text-align: center; font-weight: 700; padding: 6px; color: var(--muted);">Wed</div>
                    <div style="text-align: center; font-weight: 700; padding: 6px; color: var(--muted);">Thu</div>
                    <div style="text-align: center; font-weight: 700; padding: 6px; color: var(--muted);">Fri</div>
                    <div style="text-align: center; font-weight: 700; padding: 6px; color: var(--muted);">Sat</div>
                </div>
                <div id="mtCalendarDays" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 11px;">
                    <!-- Populated by JavaScript -->
                </div>
                <div style="margin-top: 12px; display: flex; gap: 15px; justify-content: center; font-size: 10px; flex-wrap: wrap;">
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--success); border-radius: 3px; margin-right: 4px;"></span> Entry Windows</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--warning); border-radius: 3px; margin-right: 4px;"></span> Today</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--danger); border-radius: 3px; margin-right: 4px;"></span> Avoid (Expiry)</span>
                </div>
            </div>

            <!-- STOP LOSS COMPARISON -->
            <div class="card" style="margin-bottom: 15px;">
                <div class="card-title"> STOP LOSS - Two Ways to Protect Your Money</div>
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">
                    A "stop loss" means selling to limit how much you can lose. Here are two methods:
                </div>
                <div class="grid grid-2" style="gap: 15px;">
                    <div style="background: rgba(239,68,68,0.1); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 14px; font-weight: 700; color: var(--danger); margin-bottom: 8px;">Method 1: 50% Rule</div>
                        <div style="font-size: 12px; margin-bottom: 8px;">
                            <strong>Simple:</strong> If your option loses half its value, sell it.
                        </div>
                        <div style="background: var(--bg); padding: 10px; border-radius: 6px; font-size: 12px;">
                            If you paid: <strong id="gannStopPaid">$3.50</strong><br>
                            Sell when it hits: <strong style="color: var(--danger);" id="gannStop50Pct">$1.75</strong><br>
                            <span style="font-size: 11px; color: var(--muted);">Maximum loss: 50% of what you paid</span>
                        </div>
                    </div>
                    <div style="background: rgba(139,92,246,0.1); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 14px; font-weight: 700; color: var(--primary); margin-bottom: 8px;">Method 2: Price Level</div>
                        <div style="font-size: 12px; margin-bottom: 8px;">
                            <strong>Based on price:</strong> If the stock price breaks a key level, sell.
                        </div>
                        <div style="background: var(--bg); padding: 10px; border-radius: 6px; font-size: 12px;">
                            For CALLs, sell if price drops below: <strong style="color: var(--success);" id="gannStopCallLevel">$595</strong><br>
                            For PUTs, sell if price rises above: <strong style="color: var(--danger);" id="gannStopPutLevel">$605</strong><br>
                            <span style="font-size: 11px; color: var(--muted);">Based on support/resistance levels</span>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: var(--bg); border-radius: 6px; text-align: center;">
                    <strong>Which should I use?</strong> Use whichever triggers FIRST. Both protect you differently.
                </div>
            </div>

            <!-- MONTHLY CALENDAR -->
            <div class="card" style="margin-bottom: 15px;">
                <div class="card-title"> THIS MONTH'S TRADING CALENDAR</div>
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">
                    Key dates this month for trading. The best times to enter trades are marked.
                </div>
                <div id="gannCalendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 11px;">
                    <div style="text-align: center; font-weight: 700; padding: 6px; color: var(--muted);">Sun</div>
                    <div style="text-align: center; font-weight: 700; padding: 6px; color: var(--muted);">Mon</div>
                    <div style="text-align: center; font-weight: 700; padding: 6px; color: var(--muted);">Tue</div>
                    <div style="text-align: center; font-weight: 700; padding: 6px; color: var(--muted);">Wed</div>
                    <div style="text-align: center; font-weight: 700; padding: 6px; color: var(--muted);">Thu</div>
                    <div style="text-align: center; font-weight: 700; padding: 6px; color: var(--muted);">Fri</div>
                    <div style="text-align: center; font-weight: 700; padding: 6px; color: var(--muted);">Sat</div>
                </div>
                <div id="gannCalendarDays" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 11px;">
                </div>
                <div style="margin-top: 12px; display: flex; gap: 15px; justify-content: center; font-size: 11px;">
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--success); border-radius: 3px; margin-right: 4px;"></span> Entry Window</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--primary); border-radius: 3px; margin-right: 4px;"></span> Turn Date</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--warning); border-radius: 3px; margin-right: 4px;"></span> Today</span>
                </div>
            </div>

            <!-- TRADE TRACKER -->
            <div class="card" style="margin-bottom: 15px;">
                <div class="card-title"> MY TRADES - Track Your Positions</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="background: rgba(245,158,11,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--warning);">WAITING TO ENTER</div>
                        <div style="font-size: 24px; font-weight: 700;" id="gannWaitingCount">1</div>
                    </div>
                    <div style="background: rgba(16,185,129,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--success);">ACTIVE TRADES</div>
                        <div style="font-size: 24px; font-weight: 700;" id="gannActiveCount">0</div>
                    </div>
                    <div style="background: rgba(139,92,246,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: var(--primary);">COMPLETED</div>
                        <div style="font-size: 24px; font-weight: 700;" id="gannCompletedCount">5</div>
                    </div>
                </div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr><th>Date</th><th>Symbol</th><th>Type</th><th>Entry</th><th>Current</th><th>P&L</th><th>Status</th></tr>
                        </thead>
                        <tbody id="gannTradeTracker">
                            <tr style="background: rgba(245,158,11,0.05);">
                                <td id="gannPendingDate">Dec 5</td>
                                <td id="gannPendingSymbol">SPY</td>
                                <td id="gannPendingType">TBD</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                                <td style="color: var(--warning);"> WAITING</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- POSITION RULES -->
            <div class="card" style="margin-bottom: 15px;">
                <div class="card-title"> SIMPLE RULES TO FOLLOW</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 13px; font-weight: 700; margin-bottom: 6px;"> How Much to Risk</div>
                        <div style="font-size: 12px; color: var(--text);">
                            Never risk more than <strong>5-10%</strong> of your trading money on one trade.<br>
                            <span style="color: var(--muted);">Example: If you have $1,000, risk only $50-100 per trade.</span>
                        </div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 13px; font-weight: 700; margin-bottom: 6px;"> When to Buy</div>
                        <div style="font-size: 12px; color: var(--text);">
                            Only buy during the <strong>Entry Window</strong> (2 days before to 1 day after the turn date).<br>
                            <span style="color: var(--muted);">If you miss it, wait for the next month's turn.</span>
                        </div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 13px; font-weight: 700; margin-bottom: 6px;"> When to Sell</div>
                        <div style="font-size: 12px; color: var(--text);">
                            Sell HALF at 50% profit, sell REST at 100% profit.<br>
                            <span style="color: var(--muted);">Or sell everything if stop loss is hit.</span>
                        </div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 13px; font-weight: 700; margin-bottom: 6px;"> How Long to Hold</div>
                        <div style="font-size: 12px; color: var(--text);">
                            Buy options with at least <strong>10-14 days</strong> until they expire.<br>
                            <span style="color: var(--muted);">This gives the trade time to work.</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-2" style="gap: 15px;">
                <!-- PRICE LEVELS -->
                <div class="card">
                    <div class="card-title"> KEY PRICE LEVELS</div>
                    <div style="font-size: 12px; color: var(--muted); margin-bottom: 10px;">
                        These are important prices where the stock often bounces or reverses.
                    </div>
                    <div style="text-align: center; margin-bottom: 12px;">
                        <div style="font-size: 10px; color: var(--muted);">Current Price</div>
                        <div style="font-size: 28px; font-weight: 700;" id="gannCurrentPrice">$600.00</div>
                    </div>
                    <div style="display: grid; gap: 8px; font-size: 12px;">
                        <div style="background: rgba(239,68,68,0.15); padding: 10px; border-radius: 6px; display: flex; justify-content: space-between;">
                            <span> Upper Ceiling 2:</span> <span id="gannR2" style="font-weight: 700;">$620.00</span>
                        </div>
                        <div style="background: rgba(239,68,68,0.1); padding: 10px; border-radius: 6px; display: flex; justify-content: space-between;">
                            <span> Upper Ceiling 1:</span> <span id="gannR1" style="font-weight: 700;">$610.00</span>
                        </div>
                        <div style="background: rgba(139,92,246,0.2); padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; font-weight: 700;">
                            <span> CURRENT PRICE:</span> <span id="gannCurrentPrice2">$600.00</span>
                        </div>
                        <div style="background: rgba(16,185,129,0.1); padding: 10px; border-radius: 6px; display: flex; justify-content: space-between;">
                            <span> Floor 1 (Support):</span> <span id="gannS1" style="font-weight: 700;">$590.00</span>
                        </div>
                        <div style="background: rgba(16,185,129,0.15); padding: 10px; border-radius: 6px; display: flex; justify-content: space-between;">
                            <span> Floor 2 (Support):</span> <span id="gannS2" style="font-weight: 700;">$580.00</span>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: var(--bg); border-radius: 6px; text-align: center; font-size: 11px;">
                        Nearest Level: <span id="gannNearestLevel" style="font-weight: 600;">Floor 1 @ $590</span>
                        (<span id="gannDistanceToLevel">$10 away</span>)
                    </div>
                </div>

                <!-- SCORE CARD -->
                <div class="card">
                    <div class="card-title"> TRADE QUALITY SCORE</div>
                    <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">
                        Higher score = better trade setup. 70+ is good, 80+ is great.
                    </div>
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                        <div style="flex: 0 0 100px; text-align: center;">
                            <div style="font-size: 48px; font-weight: 700;" id="gannOverallScore">72</div>
                            <div style="font-size: 12px; color: var(--muted);">out of 100</div>
                        </div>
                        <div id="gannGoNoGo" style="flex: 1; padding: 15px; border-radius: 8px; text-align: center; background: rgba(16,185,129,0.15); border: 2px solid var(--success);">
                            <div style="font-size: 20px; font-weight: 700; color: var(--success);"> GOOD SETUP</div>
                            <div style="font-size: 11px; color: var(--muted);">Trade when entry window opens</div>
                        </div>
                    </div>
                    <div style="font-size: 11px;">
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);">
                            <span>Timing (is it the right time?)</span><span id="gannScoreCycle" style="font-weight: 600;">25/30</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);">
                            <span>Price Location (at a good level?)</span><span id="gannScorePrice" style="font-weight: 600;">20/25</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);">
                            <span>Trend Alignment (all pointing same way?)</span><span id="gannScoreMTF" style="font-weight: 600;">16/20</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);">
                            <span>AI Agents Agreement</span><span id="gannScoreAgents" style="font-weight: 600;">11/15</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 6px 0;">
                            <span>Multiple Signals Together</span><span id="gannScoreConfluence" style="font-weight: 600;">8/10</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHECKLIST -->
            <div class="card" style="margin-top: 15px; margin-bottom: 15px;">
                <div class="card-title"> PRE-TRADE CHECKLIST</div>
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 10px;">
                    All boxes should be green before you trade. This keeps you safe!
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px;">
                    <div class="gann-check" id="gannCheck1" style="display: flex; align-items: center; gap: 8px; padding: 10px; background: rgba(16,185,129,0.1); border-radius: 6px;">
                        <span style="font-size: 18px;"></span>
                        <span style="font-size: 12px;">Near a turn date (time is right)</span>
                    </div>
                    <div class="gann-check" id="gannCheck2" style="display: flex; align-items: center; gap: 8px; padding: 10px; background: rgba(16,185,129,0.1); border-radius: 6px;">
                        <span style="font-size: 18px;"></span>
                        <span style="font-size: 12px;">Price at support or resistance</span>
                    </div>
                    <div class="gann-check" id="gannCheck3" style="display: flex; align-items: center; gap: 8px; padding: 10px; background: rgba(16,185,129,0.1); border-radius: 6px;">
                        <span style="font-size: 18px;"></span>
                        <span style="font-size: 12px;">Most timeframes agree on direction</span>
                    </div>
                    <div class="gann-check" id="gannCheck4" style="display: flex; align-items: center; gap: 8px; padding: 10px; background: rgba(16,185,129,0.1); border-radius: 6px;">
                        <span style="font-size: 18px;"></span>
                        <span style="font-size: 12px;">AI agents mostly agree</span>
                    </div>
                    <div class="gann-check" id="gannCheck5" style="display: flex; align-items: center; gap: 8px; padding: 10px; background: rgba(16,185,129,0.1); border-radius: 6px;">
                        <span style="font-size: 18px;"></span>
                        <span style="font-size: 12px;">Score is 70 or higher</span>
                    </div>
                    <div class="gann-check" id="gannCheck6" style="display: flex; align-items: center; gap: 8px; padding: 10px; background: rgba(245,158,11,0.1); border-radius: 6px;">
                        <span style="font-size: 18px;"></span>
                        <span style="font-size: 12px;">Entry window is open</span>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 12px; font-size: 14px; font-weight: 600;" id="gannChecklistSummary">
                    5 of 6 checks passed - <span style="color: var(--warning);">ALMOST READY</span>
                </div>
            </div>

            <!-- PAST TRADES -->
            <div class="card" style="margin-top: 15px;">
                <div class="card-title"> TRADE HISTORY</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr><th>Month</th><th>Symbol</th><th>Type</th><th>Bought At</th><th>Sold At</th><th>Profit/Loss</th><th>Result</th></tr>
                        </thead>
                        <tbody id="gannTradeLog">
                            <tr><td>Nov 2025</td><td>SPY</td><td style="color: var(--success);">CALL</td><td>$2.80</td><td>$4.20</td><td style="color: var(--success);">+50%</td><td> WIN</td></tr>
                            <tr><td>Oct 2025</td><td>QQQ</td><td style="color: var(--danger);">PUT</td><td>$3.10</td><td>$1.55</td><td style="color: var(--danger);">-50%</td><td> LOSS</td></tr>
                            <tr><td>Sep 2025</td><td>IWM</td><td style="color: var(--success);">CALL</td><td>$1.90</td><td>$3.80</td><td style="color: var(--success);">+100%</td><td> WIN</td></tr>
                            <tr><td>Aug 2025</td><td>SPY</td><td style="color: var(--success);">CALL</td><td>$2.50</td><td>$3.75</td><td style="color: var(--success);">+50%</td><td> WIN</td></tr>
                            <tr><td>Jul 2025</td><td>DIA</td><td style="color: var(--danger);">PUT</td><td>$2.20</td><td>$3.30</td><td style="color: var(--success);">+50%</td><td> WIN</td></tr>
                        </tbody>
                    </table>
                </div>
                <div style="display: flex; justify-content: space-around; margin-top: 12px; padding: 12px; background: var(--bg); border-radius: 8px; font-size: 13px;">
                    <div><span style="color: var(--muted);">Win Rate:</span> <span style="font-weight: 700; color: var(--success);" id="gannWinRate">80%</span></div>
                    <div><span style="color: var(--muted);">Avg Win:</span> <span style="font-weight: 700; color: var(--success);" id="gannAvgWin">+62.5%</span></div>
                    <div><span style="color: var(--muted);">Avg Loss:</span> <span style="font-weight: 700; color: var(--danger);" id="gannAvgLoss">-50%</span></div>
                    <div><span style="color: var(--muted);">Total:</span> <span style="font-weight: 700;" id="gannTotalTrades">5 trades</span></div>
                </div>
            </div>

            <!-- SEASONAL INFO -->
            <div class="card" style="margin-top: 15px;">
                <div class="card-title"> SEASONAL PATTERNS</div>
                <div style="padding: 12px; background: var(--bg); border-radius: 8px;">
                    <div style="font-size: 14px; font-weight: 600;" id="gannSeasonalBias"> December is usually BULLISH - "Santa Rally" time!</div>
                    <div style="font-size: 12px; color: var(--muted); margin-top: 6px;">
                        Historically, the market tends to go up in December. This doesn't guarantee anything, but it's a helpful pattern to know.
                    </div>
                </div>
            </div>

            <!-- EXIT PERFORMANCE ANALYSIS -->
            <div class="card" style="margin-top: 15px;">
                <div class="card-title"> EXIT SIGNAL PERFORMANCE</div>
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">
                    Track which exit signals work best for your trading style.
                </div>
                <div class="table-wrap">
                    <table id="exitPerformanceTable">
                        <thead>
                            <tr>
                                <th>Exit Trigger</th>
                                <th>Times Used</th>
                                <th>Avg P&L</th>
                                <th>Win Rate</th>
                                <th>Assessment</th>
                            </tr>
                        </thead>
                        <tbody id="exitPerformanceBody">
                            <tr><td> Target Hit</td><td>0</td><td>-</td><td>-</td><td style="color: var(--muted);">No data yet</td></tr>
                            <tr><td> Stop Loss</td><td>0</td><td>-</td><td>-</td><td style="color: var(--muted);">No data yet</td></tr>
                            <tr><td> Trend Reversed</td><td>0</td><td>-</td><td>-</td><td style="color: var(--muted);">No data yet</td></tr>
                            <tr><td> Time Exit</td><td>0</td><td>-</td><td>-</td><td style="color: var(--muted);">No data yet</td></tr>
                            <tr><td> Manual</td><td>0</td><td>-</td><td>-</td><td style="color: var(--muted);">No data yet</td></tr>
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: var(--bg); border-radius: 6px; font-size: 11px;">
                    <strong> Insight:</strong> <span id="exitInsight">Complete more trades to see which exit signals work best for you.</span>
                </div>
            </div>

            <!-- QUICK ACTIONS -->
            <div class="card" style="margin-top: 15px;">
                <div class="card-title"> QUICK ACTIONS</div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="addDemoPosition()" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                         Add Test Position
                    </button>
                    <button onclick="openPositions = []; saveOpenPositions(); updateExitAlertSystem(); alert('All positions cleared!');" style="padding: 10px 20px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                         Clear All Positions
                    </button>
                    <button onclick="updateExitAlertSystem()" style="padding: 10px 20px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                         Refresh Alerts
                    </button>
                    <button onclick="updateExitPerformanceDisplay()" style="padding: 10px 20px; background: var(--warning); color: black; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                         Update Stats
                    </button>
                </div>
                <div style="margin-top: 12px; font-size: 11px; color: var(--muted);">
                    Use "Add Test Position" to simulate a trade and test the exit alert system.
                </div>
            </div>
        </div>

        <!-- GANN RULES TAB - Gann's 28 Trading Laws -->
        <div id="gann-rules" class="tab-content">
            <!-- HEADER -->
            <div class="card" style="background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(139,92,246,0.15)); border: 2px solid var(--warning); margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <div style="font-size: 20px; font-weight: 700; color: var(--warning);"> Gann's 28 Trading Laws</div>
                        <div style="font-size: 13px; color: var(--text); margin-top: 4px;">Your Trading Discipline Guide - Follow these rules to protect your capital</div>
                    </div>
                    <div id="gannRulesOverallStatus" style="display: flex; align-items: center; gap: 10px; padding: 12px 24px; background: var(--bg); border-radius: 8px;">
                        <span style="font-size: 28px;"></span>
                        <div>
                            <div style="font-size: 16px; font-weight: 700; color: var(--success);" id="gannRulesPassCount">24/28</div>
                            <div style="font-size: 10px; color: var(--muted);">Rules Passing</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CAPITAL SETTINGS -->
            <div class="card" style="margin-bottom: 15px;">
                <div class="card-title"> Capital Settings</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 5px;">Total Options Capital ($)</label>
                        <input type="number" id="gannCapital" value="10000" min="100" step="100"
                               style="width: 100%; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 14px;"
                               onchange="saveCapitalSettings()">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 5px;">Max Risk Per Trade (%)</label>
                        <input type="number" id="gannMaxRisk" value="10" min="1" max="25" step="1"
                               style="width: 100%; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 14px;"
                               onchange="saveCapitalSettings()">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 5px;">Max Open Trades</label>
                        <input type="number" id="gannMaxTrades" value="5" min="1" max="10" step="1"
                               style="width: 100%; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 14px;"
                               onchange="saveCapitalSettings()">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: var(--muted); display: block; margin-bottom: 5px;">Max Markets</label>
                        <input type="number" id="gannMaxMarkets" value="5" min="1" max="15" step="1"
                               style="width: 100%; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 14px;"
                               onchange="saveCapitalSettings()">
                    </div>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: var(--bg); border-radius: 6px; font-size: 12px;">
                    <strong>Based on your settings:</strong>
                    <span style="margin-left: 10px;">Max per trade: <span id="gannMaxPerTrade" style="color: var(--primary); font-weight: 600;">$1,000</span></span>
                    <span style="margin-left: 15px;">Max exposure: <span id="gannMaxExposure" style="color: var(--warning); font-weight: 600;">$5,000</span> (50%)</span>
                </div>
            </div>

            <!-- PRE-TRADE CHECKLIST -->
            <div class="card" style="margin-bottom: 15px; border: 2px solid var(--primary);">
                <div class="card-title" style="color: var(--primary);"> PRE-TRADE CHECKLIST - Check Before EVERY Trade</div>
                <div id="preTradeChecklist" style="display: grid; gap: 8px;">
                    <div class="gann-rule-check" id="preTradeRule1" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg); border-radius: 6px; border-left: 4px solid var(--success);">
                        <span style="font-size: 20px;"></span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">Rule 1: Position Size  10% of Capital</div>
                            <div style="font-size: 11px; color: var(--muted);">Current: <span id="preTradePositionSize">$1,000</span> of <span id="preTradeCapital">$10,000</span></div>
                        </div>
                        <span style="font-size: 12px; color: var(--success); font-weight: 600;">PASS</span>
                    </div>
                    <div class="gann-rule-check" id="preTradeRule2" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg); border-radius: 6px; border-left: 4px solid var(--success);">
                        <span style="font-size: 20px;"></span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">Rule 2: Stop Loss Defined</div>
                            <div style="font-size: 11px; color: var(--muted);">Always know your exit BEFORE entering</div>
                        </div>
                        <span style="font-size: 12px; color: var(--success); font-weight: 600;">PASS</span>
                    </div>
                    <div class="gann-rule-check" id="preTradeRule4" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg); border-radius: 6px; border-left: 4px solid var(--success);">
                        <span style="font-size: 20px;"></span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">Rule 4: Trend is Clear</div>
                            <div style="font-size: 11px; color: var(--muted);">Confluence: <span id="preTradeConfluence">+4</span> (need &ge;+3 or &le;-3)</div>
                        </div>
                        <span style="font-size: 12px; color: var(--success); font-weight: 600;" id="preTradeRule4Status">PASS</span>
                    </div>
                    <div class="gann-rule-check" id="preTradeRule5" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg); border-radius: 6px; border-left: 4px solid var(--success);">
                        <span style="font-size: 20px;"></span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">Rule 5: Trading WITH the Trend</div>
                            <div style="font-size: 11px; color: var(--muted);">Direction: <span id="preTradeTrendDir">CALL in uptrend</span></div>
                        </div>
                        <span style="font-size: 12px; color: var(--success); font-weight: 600;" id="preTradeRule5Status">PASS</span>
                    </div>
                    <div class="gann-rule-check" id="preTradeRule7" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg); border-radius: 6px; border-left: 4px solid var(--success);">
                        <span style="font-size: 20px;"></span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">Rule 7: Clear Opportunity (Score &ge; 70)</div>
                            <div style="font-size: 11px; color: var(--muted);">Current Score: <span id="preTradeScore">75</span>/100</div>
                        </div>
                        <span style="font-size: 12px; color: var(--success); font-weight: 600;" id="preTradeRule7Status">PASS</span>
                    </div>
                    <div class="gann-rule-check" id="preTradeRule8" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg); border-radius: 6px; border-left: 4px solid var(--success);">
                        <span style="font-size: 20px;"></span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">Rule 8: Less Than 5 Open Trades</div>
                            <div style="font-size: 11px; color: var(--muted);">Current: <span id="preTradeOpenCount">2</span>/<span id="preTradeMaxTrades">5</span> positions</div>
                        </div>
                        <span style="font-size: 12px; color: var(--success); font-weight: 600;" id="preTradeRule8Status">PASS</span>
                    </div>
                    <div class="gann-rule-check" id="preTradeRule22" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg); border-radius: 6px; border-left: 4px solid var(--success);">
                        <span style="font-size: 20px;"></span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">Rule 22: Less Than 5 Different Markets</div>
                            <div style="font-size: 11px; color: var(--muted);">Current: <span id="preTradeMarketCount">3</span>/<span id="preTradeMaxMarkets">5</span> markets</div>
                        </div>
                        <span style="font-size: 12px; color: var(--success); font-weight: 600;" id="preTradeRule22Status">PASS</span>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 15px; border-radius: 8px; text-align: center;" id="preTradeVerdict">
                    <div style="font-size: 18px; font-weight: 700; color: var(--success);"> CLEARED TO TRADE</div>
                    <div style="font-size: 12px; color: var(--muted); margin-top: 5px;">7/7 Pre-Trade Rules Passed</div>
                </div>
            </div>

            <!-- LOSS RECOVERY GUARD -->
            <div class="card" style="margin-bottom: 15px;" id="lossRecoverySection">
                <div class="card-title" style="color: var(--danger);"> Loss Recovery Guard (Rules 15, 17)</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; background: var(--bg); border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: var(--muted);">Last Trade Result</div>
                        <div style="font-size: 24px; font-weight: 700; margin-top: 5px;" id="lastTradeResult"> WIN</div>
                    </div>
                    <div style="padding: 15px; background: var(--bg); border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: var(--muted);">Consecutive Losses</div>
                        <div style="font-size: 24px; font-weight: 700; margin-top: 5px;" id="consecutiveLosses">0</div>
                    </div>
                    <div style="padding: 15px; background: var(--bg); border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: var(--muted);">Suggested Position Size</div>
                        <div style="font-size: 24px; font-weight: 700; margin-top: 5px; color: var(--success);" id="suggestedPositionSize">100%</div>
                    </div>
                </div>
                <div id="lossWarning" style="display: none; margin-top: 15px; padding: 15px; background: rgba(239,68,68,0.15); border: 1px solid var(--danger); border-radius: 8px;">
                    <div style="font-weight: 700; color: var(--danger); margin-bottom: 8px;"> LOSS RECOVERY WARNING</div>
                    <div style="font-size: 13px; color: var(--text);" id="lossWarningText">
                        Rule 17: "Don't trade to make up for losses." You've had consecutive losses. Consider reducing position size or taking a break.
                    </div>
                </div>
                <div id="coolingOffPeriod" style="display: none; margin-top: 15px; padding: 15px; background: rgba(59,130,246,0.15); border: 1px solid var(--primary); border-radius: 8px;">
                    <div style="font-weight: 700; color: var(--primary); margin-bottom: 8px;"> COOLING OFF PERIOD RECOMMENDED</div>
                    <div style="font-size: 13px;">After 3+ consecutive losses, Gann recommends stepping away from trading. Take time to review your trades and strategy.</div>
                </div>
            </div>

            <!-- ACTIVE TRADE MONITOR -->
            <div class="card" style="margin-bottom: 15px;">
                <div class="card-title"> Active Trade Monitor</div>
                <div id="activeTradeMonitor">
                    <div id="noActiveTradesMsg" style="padding: 30px; text-align: center; color: var(--muted);">
                        No active positions to monitor. Rules will be checked when you open a trade.
                    </div>
                    <div id="activeTradesContainer" style="display: none;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- ALL 28 RULES REFERENCE -->
            <div class="card" style="margin-bottom: 15px;">
                <div class="card-title"> Gann's 28 Trading Laws - Complete Reference</div>
                <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="filterGannRules('all')" class="gann-filter-btn active" style="padding: 8px 16px; background: var(--primary); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px;">All Rules</button>
                    <button onclick="filterGannRules('risk')" class="gann-filter-btn" style="padding: 8px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); cursor: pointer; font-size: 12px;"> Risk Management</button>
                    <button onclick="filterGannRules('trend')" class="gann-filter-btn" style="padding: 8px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); cursor: pointer; font-size: 12px;"> Trend & Timing</button>
                    <button onclick="filterGannRules('discipline')" class="gann-filter-btn" style="padding: 8px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); cursor: pointer; font-size: 12px;"> Discipline</button>
                    <button onclick="filterGannRules('profit')" class="gann-filter-btn" style="padding: 8px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); cursor: pointer; font-size: 12px;"> Profit Protection</button>
                    <button onclick="filterGannRules('record')" class="gann-filter-btn" style="padding: 8px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); cursor: pointer; font-size: 12px;"> Record Keeping</button>
                </div>
                <div class="table-wrap">
                    <table id="gannRulesTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th>Rule</th>
                                <th style="width: 120px;">Category</th>
                                <th style="width: 80px;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="gannRulesTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- MONTHLY REVIEW -->
            <div class="card">
                <div class="card-title"> Monthly Review (Rule 27)</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div style="padding: 15px; background: var(--bg); border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: var(--muted);">This Month's Trades</div>
                        <div style="font-size: 24px; font-weight: 700; margin-top: 5px;" id="monthlyTradeCount">0</div>
                    </div>
                    <div style="padding: 15px; background: var(--bg); border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: var(--muted);">Win Rate</div>
                        <div style="font-size: 24px; font-weight: 700; margin-top: 5px; color: var(--success);" id="monthlyWinRate">--</div>
                    </div>
                    <div style="padding: 15px; background: var(--bg); border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: var(--muted);">Total P&L</div>
                        <div style="font-size: 24px; font-weight: 700; margin-top: 5px;" id="monthlyPnL">$0</div>
                    </div>
                    <div style="padding: 15px; background: var(--bg); border-radius: 8px; text-align: center;">
                        <div style="font-size: 12px; color: var(--muted);">Rules Violated</div>
                        <div style="font-size: 24px; font-weight: 700; margin-top: 5px; color: var(--danger);" id="monthlyViolations">0</div>
                    </div>
                </div>
                <div style="padding: 15px; background: var(--bg); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 10px;"> Most Violated Rules This Month:</div>
                    <div id="mostViolatedRules" style="font-size: 13px; color: var(--muted);">
                        No rule violations recorded yet. Great discipline!
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: rgba(139,92,246,0.1); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: var(--primary);"> Rules to Focus On This Month:</div>
                    <div id="rulesToFocus" style="font-size: 13px;">
                        <div style="margin-bottom: 5px;"> Rule 2: Always use stop losses - protect your capital</div>
                        <div style="margin-bottom: 5px;"> Rule 17: Don't trade to recover losses - stay disciplined</div>
                        <div> Rule 27: Review trades weekly - learn from mistakes</div>
                    </div>
                </div>
            </div>
        </div>


</div>
    <!-- END MAIN APP -->

<script>
// ============================================
// AUTHENTICATION SYSTEM
// ============================================

// CREDENTIALS - Authorized Users
const VALID_CREDENTIALS = {
    // Admin account
    'DrTee': 'Gann2025!',
    // Backup admin
    'admin': 'Q5D@dmin2025'
};

// Session duration in milliseconds
const SESSION_DURATION_DEFAULT = 24 * 60 * 60 * 1000; // 24 hours if not remembered
const SESSION_DURATION_FOREVER = 100 * 365 * 24 * 60 * 60 * 1000; // 100 years (essentially forever)

// Check if user is already logged in
function checkAuth() {
    const session = localStorage.getItem('sa4_session');
    if (session) {
        try {
            const sessionData = JSON.parse(session);
            const now = new Date().getTime();
            
            // Check if session is still valid
            if (sessionData.expiry > now) {
                // Session valid - show main app
                showMainApp(sessionData.username);
                return true;
            } else {
                // Session expired - clear and show login
                localStorage.removeItem('sa4_session');
            }
        } catch (e) {
            localStorage.removeItem('sa4_session');
        }
    }
    
    // No valid session - show login
    showLoginScreen();
    return false;
}

// Handle login form submission
function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const rememberMe = document.getElementById('rememberMe').checked;
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    
    // Disable button during validation
    loginBtn.disabled = true;
    loginBtn.textContent = 'Signing in...';
    
    // Simulate slight delay for security feel
    setTimeout(() => {
        // Validate credentials
        if (VALID_CREDENTIALS[username] && VALID_CREDENTIALS[username] === password) {
            // Success - create session
            const expiry = new Date().getTime() + (rememberMe ? SESSION_DURATION_FOREVER : SESSION_DURATION_DEFAULT);
            const sessionData = {
                username: username,
                expiry: expiry,
                rememberMe: rememberMe,
                loginTime: new Date().toISOString()
            };
            
            localStorage.setItem('sa4_session', JSON.stringify(sessionData));
            
            // Hide error if shown
            loginError.classList.remove('show');
            
            // Show main app
            showMainApp(username);
        } else {
            // Failed - show error
            loginError.classList.add('show');
            document.getElementById('password').value = '';
            document.getElementById('password').classList.add('error');
            
            setTimeout(() => {
                document.getElementById('password').classList.remove('error');
            }, 2000);
        }
        
        // Re-enable button
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
    }, 500);
}

// Handle logout
function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('sa4_session');
        showLoginScreen();
    }
}

// Show login screen
function showLoginScreen() {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.remove('visible');
    document.getElementById('username').focus();
}

// Show main application
function showMainApp(username) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.add('visible');
    document.getElementById('loggedInUser').textContent = username;
    
    // Initialize the app
    initializeApp();
}

// Run auth check on page load
document.addEventListener('DOMContentLoaded', () => {
    showMainApp("admin");
    // Load saved timestamps from localStorage
    setTimeout(loadSavedTimestamps, 500);
    // Render system log on page load
    setTimeout(() => {
        if (typeof renderSystemLog === 'function') renderSystemLog();
    }, 1000);
    // Check Ollama connection
    setTimeout(() => {
        if (typeof checkOllamaConnection === 'function') checkOllamaConnection();
    }, 2000);
});

// ============================================
// MAIN APPLICATION CODE
// ============================================

// Global State
let currentSymbol = 'SPY';
let tradingMode = 'intraday';
let currentData = [];
let allSymbolsData = {};
let priceChart;
let conversationHistory = [];

const SYMBOLS = ['SPY', 'QQQ', 'IWM', 'DIA', 'XLK', 'XLF', 'XLE', 'XLV', 'XLI', 'XLP', 'XLU', 'XLB', 'XLC', 'XLRE', 'XLY'];
const SYMBOL_NAMES = {
    'SPY': 'S&P 500 ETF', 'QQQ': 'Nasdaq 100 ETF', 'IWM': 'Russell 2000 ETF', 'DIA': 'Dow Jones ETF',
    'XLK': 'Technology', 'XLF': 'Financials', 'XLE': 'Energy', 'XLV': 'Healthcare',
    'XLI': 'Industrials', 'XLP': 'Consumer Staples', 'XLU': 'Utilities', 'XLB': 'Materials',
    'XLC': 'Communication Services', 'XLRE': 'Real Estate', 'XLY': 'Consumer Discretionary'
};

const TRADING_PARAMS = {
    intraday: { fastSMA: 5, slowSMA: 20, atrPeriod: 10, stopATR: 0.75, target1ATR: 1.0, target2ATR: 1.5 },
    swing: { fastSMA: 10, slowSMA: 30, atrPeriod: 14, stopATR: 1.5, target1ATR: 2.0, target2ATR: 3.0 }
};

// ============================================
// GANN KNOWLEDGE BASE - EXPANDED
// ============================================

const GANN_KNOWLEDGE = {
    tunnelThroughAir: ` "THE TUNNEL THROUGH THE AIR" (1927) by W.D. Gann

This novel encodes Gann's most powerful trading secrets through allegory and hidden meanings.

CORE PRINCIPLES:
1. TIME IS MORE IMPORTANT THAN PRICE
   - Time cycles predict WHEN markets will turn
   - Price analysis alone is incomplete
   
2. NATURAL LAW GOVERNS MARKETS
   - Markets follow geometric and astronomical cycles
   - Nothing is random - patterns repeat
   
3. THE WHEEL OF TIME
   - 360 degrees = 1 year cycle
   - Each degree = 1 day
   - Major turns at 90, 180, 270, 360

KEY CYCLES:
 7-year cycle (Biblical/Saturn)
 10-year cycle (Decade)
 20-year cycle (Jupiter-Saturn)
 30-year cycle (Saturn return)
 60-year cycle (Major)
 90-year cycle (Master)

TRADING APPLICATION:
- Count days from major highs/lows
- Watch for turns at 30, 45, 60, 90, 120, 144, 180, 270, 360 days
- Anniversary dates of major moves often repeat`,

    mystifyingSquare: ` THE MYSTIFYING SQUARE (SQUARE OF 9)

The Square of 9 is Gann's most powerful tool - a spiral of numbers revealing price/time relationships.

STRUCTURE:
- Center starts at 1
- Numbers spiral outward counter-clockwise
- Cardinal cross (N,S,E,W) = strongest levels
- 45 angles mark important support/resistance

HOW TO CALCULATE:
1. Take square root of current price: Price
2. Add/subtract for target:
   - 0.125 = 45 move (1/8 turn)
   - 0.25 = 90 move (1/4 turn)
   - 0.5 = 180 move (1/2 turn)
   - 1.0 = 360 move (full turn)
   - 2.0 = 720 move (2 full turns)
3. Square the result: Result

EXAMPLE FOR SPY @ $675:
675 = 25.98
 +0.25 (90) = 26.23 = $688.01 (resistance)
 +0.5 (180) = 26.48 = $701.19 (major resistance)
 -0.25 (90) = 25.73 = $662.03 (support)
 -0.5 (180) = 25.48 = $649.23 (major support)

CARDINAL CROSS LEVELS:
Numbers on same angle have harmonic relationship
- 1, 2, 4, 7, 13, 22, 34, 49... (East)
- 1, 3, 6, 11, 19, 30, 44... (West)

TIME APPLICATION:
Same math applies to time (trading days from pivot)`,

    divineProportions: ` DIVINE PROPORTIONS (PHI & FIBONACCI)

The Golden Ratio (Phi = 1.618) is nature's blueprint that markets follow.

THE GOLDEN RATIO:
 Phi () = 1.618033988...
 Inverse = 0.618033988...
 Square = 2.618
 Phi = 1.272

FIBONACCI SEQUENCE:
1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377...

Each number  previous  1.618 (approaches Phi)

KEY RETRACEMENT LEVELS:
 23.6% - Minor pullback
 38.2% - First major support (Phi inverse)
 50.0% - Halfway (Gann's favorite)
 61.8% - Golden ratio (strongest)
 78.6% - Deep retracement (0.618)

EXTENSION LEVELS:
 100% - Equal move
 127.2% - Phi extension
 161.8% - Phi extension (primary target)
 200% - Double move
 261.8% - Phi squared

GANN'S USE OF PHI:
- Combined with Square of 9
- Price targets at Phi extensions
- Time cycles in Fibonacci days
- 144 days (Fibonacci) = sacred number

DIVINE PROPORTION IN OPTIONS:
 Entry at 61.8% retracement
 Target at 161.8% extension
 Stop below 78.6% retracement`,

    timeCycles: ` GANN TIME CYCLES

"When time is up, the trend changes."

NATURAL TIME DIVISIONS:
 7 days (week)
 30 days (month)
 90 days (quarter)
 365 days (year)

GANN'S KEY NUMBERS:
 30 - Minor cycle
 45 - Important (1/8 year)
 60 - Significant (2 months)
 90 - Major (quarter)
 120 - Important (1/3 year)
 144 - Fibonacci/sacred
 180 - Half year
 270 - 3/4 year
 360 - Full year/circle

ANNIVERSARY DATES:
Major tops/bottoms repeat on:
 Same calendar date
 30, 60, 90... days later
 1, 2, 3... years later

SEASONAL DATES:
 March 21 - Spring equinox
 June 21 - Summer solstice
 September 21 - Fall equinox
 December 21 - Winter solstice

TRADING APPLICATION:
1. Mark major high/low date
2. Add Gann numbers (30, 45, 60, 90...)
3. Watch for reversals on those dates
4. Combine with price levels`,

    platformPrinciples: ` Q5D PLATFORM CORE PRINCIPLES

MULTI-AGENT CONSENSUS SYSTEM:
4 independent agents must agree before trading:

1.  BASE CONFLUENCE - SMA crossover with ATR stops
2.  GANN-ELLIOTT - Gann geometry + Elliott waves
3.  DQN/RL - Reinforcement learning AI
4.  3-WAVE - Simplified impulse detection

SIGNAL CLASSIFICATION:
 1/4 agree = NO TRADE 
 2/4 agree = SINGLE (weak) 
 3/4 agree = SUPER (tradeable) 
 4/4 agree = ULTRA (highest) 

DUAL TIMEFRAME:
 INTRADAY: 0-1 DTE, 5-15 min, tight stops
 SWING: 3-5 DTE, daily, wider stops

WHY MULTI-AGENT WORKS:
- Reduces false signals
- Multiple confirmations
- Different methodologies
- Higher win rate (65-89%)`
};

// Gann Knowledge and other constants are initialized above
// App initialization is now handled by checkAuth() -> showMainApp()

function initTabs() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(btn.dataset.tab).classList.add('active');
            btn.classList.add('active');

            // Default to 'main' view when Daily Analysis tab is clicked
            if (btn.dataset.tab === 'daily-analysis') {
                switchAnalysisMode('main');
            }

            // Update Gann Rules tab when selected
            if (btn.dataset.tab === 'gann-rules' && typeof updateGannRulesTab === 'function') {
                updateGannRulesTab();
            }
        };
    });
}

function setTradingMode(mode) {
    tradingMode = mode;
    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.mode-btn.${mode}`).classList.add('active');
    document.getElementById('symbolBanner').className = `symbol-banner ${mode}-mode`;
    document.getElementById('currentModeDisplay').textContent = mode.toUpperCase();
    document.getElementById('aiContextMode').textContent = mode.toUpperCase();
}

async function changeSymbol() {
    const newSymbol = document.getElementById('symbolSelect').value;
    console.log(` Changing symbol from ${currentSymbol} to ${newSymbol}`);
    currentSymbol = newSymbol;

    // Clear Gann score cache to force recalculation for new symbol
    if (typeof gannScoreCache !== 'undefined') {
        gannScoreCache = {};
        gannScoreCacheTime = 0;
    }

    // Update ALL symbol displays immediately
    document.getElementById('currentSymbolDisplay').textContent = currentSymbol;
    document.getElementById('currentSymbolName').textContent = SYMBOL_NAMES[currentSymbol] || currentSymbol;
    document.getElementById('tickerSymbol').textContent = currentSymbol;
    document.getElementById('tickerName').textContent = SYMBOL_NAMES[currentSymbol] || currentSymbol;
    document.getElementById('aiContextSymbol').textContent = currentSymbol;
    
    // Update Bar Count tab symbol display
    const barCountSymbol = document.getElementById('barCountCurrentSymbol');
    if (barCountSymbol) barCountSymbol.textContent = currentSymbol;

    // Sync all Multi-Charts displays with new symbol (uses global currentSymbol)
    if (typeof syncChartsWithSymbol === 'function') {
        syncChartsWithSymbol();
    }
    
    // Update Daily Analysis symbol display
    const confluenceSymbol = document.getElementById('confluenceSymbol');
    if (confluenceSymbol) confluenceSymbol.textContent = currentSymbol + ' Analysis';
    
    // Load the new symbol's data and update everything
    await loadAllData();

    // Update Options Calculator with new symbol's price
    updateOptionsCalcPrice();

    // Update Gann Analysis tab with new symbol's unified score
    if (typeof updateGannAnalysisTab === 'function') {
        setTimeout(updateGannAnalysisTab, 300);
    }
    if (typeof initMonthlyTradingDashboard === 'function') {
        setTimeout(initMonthlyTradingDashboard, 400);
    }
}

function parseCSV(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return [];
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
        const values = line.split(',');
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i]?.trim() || '');
        return obj;
    });
}

// ============================================
// TIMESTAMP MANAGEMENT FUNCTIONS
// ============================================

const TIMESTAMP_STORAGE_KEY = 'stockAgentTimestamps';

function formatLastUpdated(date) {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const month = months[date.getMonth()];
    const day = date.getDate();
    const year = date.getFullYear();
    let hours = date.getHours();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12;
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${month} ${day}, ${year} ${hours}:${minutes} ${ampm} ET`;
}

function formatShortTime(date) {
    let hours = date.getHours();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12;
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes} ${ampm}`;
}

function getTimestampStaleness(lastUpdateTime) {
    const now = new Date();
    const diffMs = now - lastUpdateTime;
    const diffMinutes = diffMs / (1000 * 60);
    const diffHours = diffMinutes / 60;
    
    // Check if data is from previous day
    const isYesterday = lastUpdateTime.toDateString() !== now.toDateString();
    
    if (isYesterday || diffHours > 4) {
        return { class: 'ts-old', textClass: 'ts-text-old', label: 'stale' };
    } else if (diffHours > 1) {
        return { class: 'ts-stale', textClass: 'ts-text-stale', label: 'aging' };
    } else if (diffMinutes > 30) {
        return { class: 'ts-recent', textClass: 'ts-text-recent', label: 'recent' };
    } else {
        return { class: 'ts-fresh', textClass: 'ts-text-fresh', label: 'fresh' };
    }
}

function updateTimestampElement(dotId, textId, timestamp) {
    const dot = document.getElementById(dotId);
    const text = document.getElementById(textId);
    if (!dot || !text) return;
    
    const date = new Date(timestamp);
    const staleness = getTimestampStaleness(date);
    
    // Update dot color
    dot.className = 'ts-dot ' + staleness.class;
    
    // Update text - use short format for sections
    if (textId === 'headerTimestamp') {
        text.textContent = 'Updated: ' + formatShortTime(date) + ' ET';
    } else {
        text.textContent = ' ' + formatShortTime(date);
    }
    
    // Add tooltip with full date
    const container = dot.parentElement;
    if (container) {
        container.title = 'Last updated: ' + formatLastUpdated(date);
    }
}

function updateAllTimestamps() {
    const now = new Date().toISOString();
    const timestamps = {
        header: now,
        dailyAnalysis: now,
        playbook: now,
        ultraConfluence: now,
        sectorRotation: now,
        health: now,
        multiCharts: now,
        journal: now
    };
    
    // Save to localStorage
    localStorage.setItem(TIMESTAMP_STORAGE_KEY, JSON.stringify(timestamps));
    
    // Update all timestamp displays
    updateTimestampElement('headerTsDot', 'headerTimestamp', now);
    updateTimestampElement('dailyAnalysisTsDot', 'dailyAnalysisTsText', now);
    updateTimestampElement('playbookTsDot', 'playbookTsText', now);
    updateTimestampElement('ultraConfluenceTsDot', 'ultraConfluenceTsText', now);
    updateTimestampElement('sectorRotationTsDot', 'sectorRotationTsText', now);
    updateTimestampElement('healthTsDot', 'healthTsText', now);
    updateTimestampElement('multiChartsTsDot', 'multiChartsTsText', now);
    updateTimestampElement('journalTsDot', 'journalTsText', now);
}

function updateSectionTimestamp(section) {
    const now = new Date().toISOString();
    const timestamps = JSON.parse(localStorage.getItem(TIMESTAMP_STORAGE_KEY) || '{}');
    timestamps[section] = now;
    localStorage.setItem(TIMESTAMP_STORAGE_KEY, JSON.stringify(timestamps));
    
    // Map section to element IDs
    const sectionMap = {
        header: ['headerTsDot', 'headerTimestamp'],
        dailyAnalysis: ['dailyAnalysisTsDot', 'dailyAnalysisTsText'],
        playbook: ['playbookTsDot', 'playbookTsText'],
        ultraConfluence: ['ultraConfluenceTsDot', 'ultraConfluenceTsText'],
        sectorRotation: ['sectorRotationTsDot', 'sectorRotationTsText'],
        health: ['healthTsDot', 'healthTsText'],
        multiCharts: ['multiChartsTsDot', 'multiChartsTsText'],
        journal: ['journalTsDot', 'journalTsText']
    };
    
    if (sectionMap[section]) {
        updateTimestampElement(sectionMap[section][0], sectionMap[section][1], now);
    }
}

function loadSavedTimestamps() {
    const savedTimestamps = JSON.parse(localStorage.getItem(TIMESTAMP_STORAGE_KEY) || '{}');
    
    if (savedTimestamps.header) {
        updateTimestampElement('headerTsDot', 'headerTimestamp', savedTimestamps.header);
    }
    if (savedTimestamps.dailyAnalysis) {
        updateTimestampElement('dailyAnalysisTsDot', 'dailyAnalysisTsText', savedTimestamps.dailyAnalysis);
    }
    if (savedTimestamps.playbook) {
        updateTimestampElement('playbookTsDot', 'playbookTsText', savedTimestamps.playbook);
    }
    if (savedTimestamps.ultraConfluence) {
        updateTimestampElement('ultraConfluenceTsDot', 'ultraConfluenceTsText', savedTimestamps.ultraConfluence);
    }
    if (savedTimestamps.sectorRotation) {
        updateTimestampElement('sectorRotationTsDot', 'sectorRotationTsText', savedTimestamps.sectorRotation);
    }
    if (savedTimestamps.health) {
        updateTimestampElement('healthTsDot', 'healthTsText', savedTimestamps.health);
    }
    if (savedTimestamps.multiCharts) {
        updateTimestampElement('multiChartsTsDot', 'multiChartsTsText', savedTimestamps.multiCharts);
    }
    if (savedTimestamps.journal) {
        updateTimestampElement('journalTsDot', 'journalTsText', savedTimestamps.journal);
    }
}

function refreshTimestampColors() {
    // Re-check staleness and update colors for all timestamps
    const savedTimestamps = JSON.parse(localStorage.getItem(TIMESTAMP_STORAGE_KEY) || '{}');
    loadSavedTimestamps();
}

// Check staleness every minute
setInterval(refreshTimestampColors, 60000);

// ============================================
// END TIMESTAMP FUNCTIONS
// ============================================

async function loadAllData() {
    document.getElementById('loadingOverlay').classList.add('active');
    try {
        // Try multiple paths for the CSV file
        const csvPaths = [
            `data/${currentSymbol}.csv?t=${Date.now()}`,
            `${currentSymbol}.csv?t=${Date.now()}`,
            `https://aadey002.github.io/Stock-agent-/data/${currentSymbol}.csv?t=${Date.now()}`
        ];

        let r = null;
        let loadedSymbol = currentSymbol;

        // Try each path until one works
        for (const path of csvPaths) {
            try {
                const response = await fetch(path);
                if (response.ok) {
                    r = response;
                    console.log(` Found data at: ${path}`);
                    break;
                }
            } catch (e) {
                console.log(` Failed to fetch from: ${path}`);
            }
        }

        // If the selected symbol's CSV doesn't exist, fall back to SPY
        if (!r?.ok) {
            const failedSymbol = currentSymbol; // Save original symbol for error message
            console.warn(`${failedSymbol}.csv not found in any location, falling back to SPY`);

            // Try SPY with same paths
            for (const basePath of ['data/', '', 'https://aadey002.github.io/Stock-agent-/data/']) {
                try {
                    const response = await fetch(`${basePath}SPY.csv?t=${Date.now()}`);
                    if (response.ok) {
                        r = response;
                        break;
                    }
                } catch (e) {}
            }

            loadedSymbol = 'SPY';

            // Update the symbol selector back to SPY if data not available
            const select = document.getElementById('symbolSelect');
            if (select) select.value = 'SPY';
            currentSymbol = 'SPY';

            // Show notification with original symbol name
            showDataNotification(`${failedSymbol} data not available, showing SPY`);
        }

        if (r?.ok) {
            currentData = parseCSV(await r.text());
            if (currentData.length) {
                console.log(` Loaded ${currentData.length} bars for ${currentSymbol}`);

                // Log data load event
                if (typeof addSystemLogEntry === 'function') {
                    addSystemLogEntry(`Data Updated (${currentSymbol})`, 'success');
                }

                // Update ALL dashboard components
                updateDashboard();
                updateBarCountAnalysis();
                updateReversalStats();
                updatePriceChart();

                // Update Historical Data table
                if (typeof updateHistoricalData === 'function') {
                    updateHistoricalData();
                }

                // Update Daily Analysis if that tab is active
                const analysisTab = document.getElementById('daily-analysis');
                if (analysisTab && analysisTab.classList.contains('active')) {
                    await loadRealAgentSignals();
                    generateDailyReport();
                }

                // Update Multi-Charts if that tab is active
                const multiChartsTab = document.getElementById('multi-charts');
                if (multiChartsTab && multiChartsTab.classList.contains('active')) {
                    updateAllMultiCharts();
                }

                // Update MTF Bias always (uses currentData which is already loaded for current symbol)
                if (typeof updateMTFBias === 'function') updateMTFBias();

                // Update symbol displays
                document.getElementById('currentSymbolDisplay').textContent = currentSymbol;
                document.getElementById('currentSymbolName').textContent = SYMBOL_NAMES[currentSymbol] || currentSymbol;
                document.getElementById('tickerSymbol').textContent = currentSymbol;
                document.getElementById('tickerName').textContent = SYMBOL_NAMES[currentSymbol] || currentSymbol;
                const confluenceSymbolEl = document.getElementById('confluenceSymbol');
                if (confluenceSymbolEl) confluenceSymbolEl.textContent = currentSymbol + ' Analysis';
            }
        }
    } catch (e) { console.error('Error:', e); }
    document.getElementById('loadingOverlay').classList.remove('active');
    
    // Update all timestamps after data refresh
    updateAllTimestamps();
    
    // Load market conditions from JSON
    loadMarketConditions();
}

function showDataNotification(message) {
    // Create a temporary notification
    const notif = document.createElement('div');
    notif.style.cssText = 'position:fixed;top:80px;right:20px;background:var(--warning);color:white;padding:12px 20px;border-radius:8px;font-size:12px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.2);';
    notif.textContent = ' ' + message;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 3000);
}

async function loadAllSymbolsData() {
    const csvPaths = ['data/', '', 'https://aadey002.github.io/Stock-agent-/data/'];

    for (const symbol of SYMBOLS) {
        // Try multiple paths for each symbol
        for (const basePath of csvPaths) {
            try {
                const r = await fetch(`${basePath}${symbol}.csv?t=${Date.now()}`).catch(() => null);
                if (r?.ok) {
                    allSymbolsData[symbol] = parseCSV(await r.text());
                    break; // Found data, move to next symbol
                }
            } catch (e) {}
        }
    }
    console.log(`Loaded data for ${Object.keys(allSymbolsData).length} symbols`);
}

function updateDashboard() {
    const lat = currentData[currentData.length - 1];
    const prev = currentData[currentData.length - 2] || lat;
    const price = parseFloat(lat.Close) || 0;
    const prevPrice = parseFloat(prev.Close) || price;
    const chg = price - prevPrice;
    const pct = prevPrice ? (chg / prevPrice * 100) : 0;
    const atr = parseFloat(lat.ATR) || 5;
    const bias = (lat.Bias || '').toUpperCase();

    // Header ticker
    document.getElementById('tickerPrice').textContent = '$' + price.toFixed(2);
    document.getElementById('tickerChange').textContent = (chg >= 0 ? '+' : '') + '$' + Math.abs(chg).toFixed(2);
    document.getElementById('tickerChange').className = 'ticker-change ' + (chg >= 0 ? 'positive' : 'negative');
    document.getElementById('tickerPct').textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';

    // Metrics
    document.getElementById('currentPrice').textContent = '$' + price.toFixed(2);
    document.getElementById('priceSource').textContent = `${currentData.length} bars`;
    document.getElementById('dailyChange').textContent = (chg >= 0 ? '+' : '') + '$' + Math.abs(chg).toFixed(2);
    document.getElementById('dailyChange').className = 'metric-value ' + (chg >= 0 ? 'positive' : 'negative');
    document.getElementById('changePct').textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
    document.getElementById('volumeDisplay').textContent = ((parseFloat(lat.Volume) || 0) / 1e6).toFixed(1) + 'M';
    document.getElementById('signalStatus').textContent = bias || 'HOLD';
    document.getElementById('signalConf').textContent = `${lat.PriceConfluence || 0}/4`;
    document.getElementById('atrDisplay').textContent = '$' + atr.toFixed(2);

    // Date/Time
    const dateStr = lat.Date || '';
    const [datePart, timePart] = dateStr.includes('T') ? dateStr.split('T') : [dateStr, 'EOD'];
    document.getElementById('dataDate').textContent = datePart;
    document.getElementById('dataTime').textContent = timePart.replace('Z', '');

    // AI Context
    document.getElementById('aiContextPrice').textContent = '$' + price.toFixed(2);
    document.getElementById('aiContextSignal').textContent = bias || 'HOLD';
    document.getElementById('aiContextConsensus').textContent = `${lat.PriceConfluence || 0}/4`;

    updateReferenceData();
    updateFibonacci();
    updateGannQuickView();
}

function updateReferenceData() {
    const lat = currentData[currentData.length - 1];
    const yearData = currentData.slice(-252);
    
    const highs = yearData.map(d => parseFloat(d.High) || 0);
    const lows = yearData.map(d => parseFloat(d.Low) || 0);
    
    const week52High = Math.max(...highs);
    const week52Low = Math.min(...lows);
    const todayOpen = parseFloat(lat.Open) || 0;
    const todayHigh = parseFloat(lat.High) || 0;
    const todayLow = parseFloat(lat.Low) || 0;
    const price = parseFloat(lat.Close) || 0;
    
    document.getElementById('week52High').textContent = '$' + week52High.toFixed(2);
    document.getElementById('week52Low').textContent = '$' + week52Low.toFixed(2);
    document.getElementById('todayHigh').textContent = '$' + todayHigh.toFixed(2);
    document.getElementById('todayLow').textContent = '$' + todayLow.toFixed(2);
    
    const todayVol = parseFloat(lat.Volume) || 0;
    const volumes20 = currentData.slice(-20).map(d => parseFloat(d.Volume) || 0);
    const avgVol = volumes20.reduce((a, b) => a + b, 0) / 20;
    const volVsAvgPct = avgVol > 0 ? ((todayVol/avgVol - 1) * 100) : 0;
    
    document.getElementById('avgVolume20').textContent = (avgVol / 1e6).toFixed(1) + 'M';
    document.getElementById('volumeVsAvg').textContent = volVsAvgPct.toFixed(0) + '%';
    document.getElementById('volumeVsAvgSmall').textContent = volVsAvgPct.toFixed(0) + '% vs avg';
    
    // Update header market stats
    updateHeaderMarketStats(todayOpen, todayLow, todayHigh, week52Low, week52High, volVsAvgPct, price);
}

function updateHeaderMarketStats(todayOpen, todayLow, todayHigh, week52Low, week52High, volVsAvgPct, price) {
    // Today's Range with Open price
    const todayRangeEl = document.getElementById('headerTodayRange');
    if (todayRangeEl) {
        todayRangeEl.textContent = 'O: $' + todayOpen.toFixed(2) + ' | L: $' + todayLow.toFixed(2) + ' | H: $' + todayHigh.toFixed(2);
    }
    
    // 52-Week Range with color coding
    const range52WEl = document.getElementById('header52WRange');
    if (range52WEl) {
        range52WEl.textContent = '$' + week52Low.toFixed(2) + ' - $' + week52High.toFixed(2);
        
        // Color based on where price is in 52W range
        const range52W = week52High - week52Low;
        const pricePosition = range52W > 0 ? (price - week52Low) / range52W : 0.5;
        
        if (pricePosition >= 0.85) {
            range52WEl.className = 'header-stat-value near-high';
        } else if (pricePosition <= 0.15) {
            range52WEl.className = 'header-stat-value near-low';
        } else {
            range52WEl.className = 'header-stat-value neutral';
        }
    }
    
    // Volume vs Average
    const volEl = document.getElementById('headerVolVsAvg');
    if (volEl) {
        const sign = volVsAvgPct >= 0 ? '+' : '';
        volEl.textContent = sign + volVsAvgPct.toFixed(0) + '% vs Avg';
        
        if (volVsAvgPct >= 20) {
            volEl.className = 'header-stat-value positive';
        } else if (volVsAvgPct <= -20) {
            volEl.className = 'header-stat-value negative';
        } else {
            volEl.className = 'header-stat-value neutral';
        }
    }
}

function updateFibonacci() {
    const recent = currentData.slice(-60);
    const highs = recent.map(d => parseFloat(d.High) || 0);
    const lows = recent.map(d => parseFloat(d.Low) || 0);
    const swingHigh = Math.max(...highs);
    const swingLow = Math.min(...lows);
    const lat = currentData[currentData.length - 1];
    const price = parseFloat(lat.Close) || 0;
    const range = swingHigh - swingLow;

    // Calculate Fibonacci levels
    const fib236 = swingHigh - (range * 0.236); // S1
    const fib382 = swingHigh - (range * 0.382); // S2
    const fib618 = swingHigh - (range * 0.618); // S3
    const fib100 = swingHigh;                   // R1
    const fib1272 = swingLow + (range * 1.272); // R2
    const fib1618 = swingLow + (range * 1.618); // R3

    // Helper function for safe element updates
    const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    const setElHtml = (id, val) => { const el = document.getElementById(id); if (el) el.innerHTML = val; };

    // Update Fibonacci display in Overview tab
    setEl('fibS3', `S3: $${fib618.toFixed(0)}`);
    setEl('fibS2', `S2: $${fib382.toFixed(0)}`);
    setEl('fibS1', `S1: $${fib236.toFixed(0)}`);
    setEl('fibCurrent', ` $${price.toFixed(2)}`);
    setEl('fibR1', `R1: $${fib100.toFixed(0)}`);
    setEl('fibR2', `R2: $${fib1272.toFixed(0)}`);
    setEl('fibR3', `R3: $${fib1618.toFixed(0)}`);

    // Update chart Fib levels if they exist
    setEl('chartR1', '$' + fib100.toFixed(2));
    setEl('chartR2', '$' + fib1272.toFixed(2));
    setEl('chartR3', '$' + fib1618.toFixed(2));
    setEl('chartS1', '$' + fib236.toFixed(2));
    setEl('chartS2', '$' + fib382.toFixed(2));
    setEl('chartS3', '$' + fib618.toFixed(2));

    // Determine zone and update display
    let zone = 'NEUTRAL';
    let zoneColor = 'var(--muted)';
    if (price > fib100) { zone = 'BREAKOUT (Above R1)'; zoneColor = 'var(--success)'; }
    else if (price > fib236) { zone = 'STRONG (S1-R1)'; zoneColor = 'var(--success)'; }
    else if (price > fib382) { zone = 'PULLBACK (S2-S1)'; zoneColor = 'var(--warning)'; }
    else if (price > fib618) { zone = 'SUPPORT TEST (S3-S2)'; zoneColor = 'var(--warning)'; }
    else { zone = 'DEEP PULLBACK (Below S3)'; zoneColor = 'var(--danger)'; }

    const fibZoneText = document.getElementById('fibZoneText');
    if (fibZoneText) {
        fibZoneText.innerHTML = `Current Zone: <span style="color:${zoneColor};font-weight:600;">${zone}</span>`;
    }

    // Calculate multi-timeframe trends
    const fastSMA = parseFloat(lat.FastSMA) || price;
    const slowSMA = parseFloat(lat.SlowSMA) || price;
    const overallTrend = fastSMA > slowSMA ? 'BULLISH' : 'BEARISH';

    // Intraday trend (5-period vs 10-period)
    const last5 = currentData.slice(-5);
    const last10 = currentData.slice(-10);
    const avg5 = last5.reduce((s, d) => s + parseFloat(d.Close || 0), 0) / 5;
    const avg10 = last10.reduce((s, d) => s + parseFloat(d.Close || 0), 0) / 10;
    const intradayTrend = avg5 > avg10 ? 'BULL' : 'BEAR';

    // Swing trend (10-period vs 20-period)
    const last20 = currentData.slice(-20);
    const avg20 = last20.reduce((s, d) => s + parseFloat(d.Close || 0), 0) / Math.min(20, last20.length);
    const swingTrend = avg10 > avg20 ? 'BULL' : 'BEAR';

    // Position trend (20-period vs 50-period)
    const last50 = currentData.slice(-50);
    const avg50 = last50.reduce((s, d) => s + parseFloat(d.Close || 0), 0) / Math.min(50, last50.length);
    const positionTrend = avg20 > avg50 ? 'BULL' : 'BEAR';

    // Update trend displays
    const setTrendBadge = (id, trend) => {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = trend;
            el.className = `badge badge-${trend === 'BULL' ? 'success' : 'danger'}`;
        }
    };
    setTrendBadge('trendIntraday', intradayTrend);
    setTrendBadge('trendSwing', swingTrend);
    setTrendBadge('trendPosition', positionTrend);

    const trendBadge = document.getElementById('trendBadge');
    if (trendBadge) {
        trendBadge.textContent = overallTrend;
        trendBadge.className = `badge badge-${overallTrend === 'BULLISH' ? 'success' : 'danger'}`;
    }

    // Update Open Type (gap analysis for today)
    const prevClose = currentData.length > 1 ? parseFloat(currentData[currentData.length - 2].Close || 0) : price;
    const todayOpen = parseFloat(lat.Open || 0);
    const gap = todayOpen - prevClose;
    const gapPct = prevClose > 0 ? (gap / prevClose * 100) : 0;

    const openTypeBadge = document.getElementById('openTypeBadge');
    if (openTypeBadge) {
        if (gapPct > 0.3) {
            openTypeBadge.textContent = 'GAP UP';
            openTypeBadge.className = 'badge badge-success';
        } else if (gapPct < -0.3) {
            openTypeBadge.textContent = 'GAP DOWN';
            openTypeBadge.className = 'badge badge-danger';
        } else {
            openTypeBadge.textContent = 'FLAT OPEN';
            openTypeBadge.className = 'badge badge-warning';
        }
    }

    const gapDisplay = document.getElementById('gapDisplay');
    if (gapDisplay) {
        const sign = gap >= 0 ? '+' : '';
        gapDisplay.textContent = `${sign}$${gap.toFixed(2)} (${sign}${gapPct.toFixed(2)}%)`;
        gapDisplay.style.color = gap >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    // Update Fibonacci table in Signals & Agents tab
    // Note: S1=23.6%, S2=38.2%, S3=61.8% for supports (price below swing high)
    // Corrected mapping based on table labels:
    // S1 (38.2%) = fib382, S2 (50.0%) = fib50, S3 (61.8%) = fib618
    const fib50 = swingHigh - (range * 0.5); // S2 - 50% retracement

    // Price values
    setEl('fibTableR3', '$' + fib1618.toFixed(2));
    setEl('fibTableR2', '$' + fib1272.toFixed(2));
    setEl('fibTableR1', '$' + fib100.toFixed(2));
    setEl('fibTableS1', '$' + fib382.toFixed(2));
    setEl('fibTableS2', '$' + fib50.toFixed(2));
    setEl('fibTableS3', '$' + fib618.toFixed(2));
    setEl('fibCurrentPrice', '$' + price.toFixed(2));

    // Calculate distances from current price
    const distR3 = ((fib1618 - price) / price * 100).toFixed(1);
    const distR2 = ((fib1272 - price) / price * 100).toFixed(1);
    const distR1 = ((fib100 - price) / price * 100).toFixed(1);
    const distS1 = ((price - fib382) / price * 100).toFixed(1);
    const distS2 = ((price - fib50) / price * 100).toFixed(1);
    const distS3 = ((price - fib618) / price * 100).toFixed(1);

    setEl('fibDistR3', '+' + distR3 + '%');
    setEl('fibDistR2', '+' + distR2 + '%');
    setEl('fibDistR1', (parseFloat(distR1) >= 0 ? '+' : '') + distR1 + '%');
    setEl('fibDistS1', '-' + distS1 + '%');
    setEl('fibDistS2', '-' + distS2 + '%');
    setEl('fibDistS3', '-' + distS3 + '%');

    // Find closest Fib level for proximity alert
    const levels = [
        { name: 'R3 (161.8%)', price: fib1618, dist: Math.abs(fib1618 - price) },
        { name: 'R2 (127.2%)', price: fib1272, dist: Math.abs(fib1272 - price) },
        { name: 'R1 (100%)', price: fib100, dist: Math.abs(fib100 - price) },
        { name: 'S1 (38.2%)', price: fib382, dist: Math.abs(fib382 - price) },
        { name: 'S2 (50.0%)', price: fib50, dist: Math.abs(fib50 - price) },
        { name: 'S3 (61.8%)', price: fib618, dist: Math.abs(fib618 - price) }
    ];
    levels.sort((a, b) => a.dist - b.dist);
    const closest = levels[0];
    const closestPct = (closest.dist / price * 100).toFixed(2);

    // Update proximity alert
    setElHtml('fibProximityPct', `<strong style="color: ${parseFloat(closestPct) < 1 ? 'var(--danger)' : 'var(--warning)'};">${closestPct}%</strong>`);
    setEl('fibProximityLevel', closest.name);
    setEl('fibProximityPrice', '$' + closest.price.toFixed(2));

    // Highlight proximity alert color based on distance
    const alertEl = document.getElementById('fibProximityAlert');
    if (alertEl) {
        if (parseFloat(closestPct) < 0.5) {
            alertEl.style.borderColor = 'var(--danger)';
            alertEl.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05))';
        } else if (parseFloat(closestPct) < 1.5) {
            alertEl.style.borderColor = 'var(--warning)';
            alertEl.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05))';
        } else {
            alertEl.style.borderColor = 'var(--border)';
            alertEl.style.background = 'rgba(255,255,255,0.02)';
        }
    }

    // Add approaching icon () to closest level
    ['R1', 'R2', 'R3', 'S1', 'S2', 'S3'].forEach(lvl => {
        const iconEl = document.getElementById('fib' + lvl + 'Icon');
        if (iconEl) iconEl.textContent = '';
    });
    const closestLvl = closest.name.split(' ')[0]; // 'R1', 'R2', etc.
    const closestIcon = document.getElementById('fib' + closestLvl + 'Icon');
    if (closestIcon) closestIcon.textContent = ' ';

    // Find swing high and low dates
    let swingHighIdx = 0, swingLowIdx = 0;
    for (let i = 0; i < recent.length; i++) {
        if (parseFloat(recent[i].High) === swingHigh) swingHighIdx = i;
        if (parseFloat(recent[i].Low) === swingLow) swingLowIdx = i;
    }
    const highDate = recent[swingHighIdx]?.Date || '--';
    const lowDate = recent[swingLowIdx]?.Date || '--';
    setEl('fibSwingHighDate', highDate);
    setEl('fibSwingLowDate', lowDate);

    // Update individual row dates (use swing high date for R levels, swing low date for S levels)
    setEl('fibDateR1', highDate);
    setEl('fibDateR2', highDate);
    setEl('fibDateR3', highDate);
    setEl('fibDateS1', highDate);
    setEl('fibDateS2', highDate);
    setEl('fibDateS3', lowDate);

    window.fibLevels = { fib100, fib1272, fib1618, fib236, fib382, fib618, fib50, swingHigh, swingLow };
    window.mtfTrends = { intraday: intradayTrend, swing: swingTrend, position: positionTrend };

    // Update pattern dates and implications
    updatePatternDates();
}

// Update pattern dates and implications in Signals & Agents tab
function updatePatternDates() {
    if (!currentData || currentData.length < 10) return;

    const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    const setBadge = (id, conf, isBullish) => {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = conf + '%';
            el.className = `badge badge-${isBullish ? 'success' : 'danger'}`;
        }
    };
    const setBar = (id, conf, isBullish) => {
        const el = document.getElementById(id);
        if (el) {
            el.style.width = conf + '%';
            el.className = `pattern-fill ${isBullish ? 'bullish' : 'bearish'}`;
        }
    };

    // Get recent data for pattern detection
    const recent = currentData.slice(-30);
    const lat = currentData[currentData.length - 1];
    const price = parseFloat(lat.Close || 0);
    const bias = (lat.Bias || '').toUpperCase();
    const isBullish = bias.includes('BULL') || bias.includes('CALL');
    const lastDate = lat.Date ? lat.Date.split('T')[0] : '--';

    // Pattern implications database
    const implications = {
        // Technical Patterns
        'Double Bottom': { bull: 'Bullish reversal expected', bear: 'False bottom - continuation likely' },
        'Double Top': { bull: 'Resistance rejection - wait for breakout', bear: 'Bearish reversal expected' },
        'Ascending Triangle': { bull: 'Breakout likely above resistance', bear: 'Watch for breakdown' },
        'Descending Triangle': { bull: 'Watch for upside breakout', bear: 'Breakdown likely below support' },
        'Head & Shoulders': { bull: 'Invalid pattern if breaks neckline up', bear: 'Bearish reversal confirmed' },
        'Inv Head & Shoulders': { bull: 'Bullish reversal confirmed', bear: 'Invalid pattern' },
        'Bull Flag': { bull: 'Continuation - expect new highs', bear: 'Failed flag - reversal' },
        'Bear Flag': { bull: 'Failed flag - reversal', bear: 'Continuation - expect new lows' },
        // Candlestick Patterns
        'Bullish Engulfing': { bull: 'Strong bullish signal', bear: 'Failed - bearish continuation' },
        'Bearish Engulfing': { bull: 'Failed - bullish continuation', bear: 'Strong bearish signal' },
        'Hammer': { bull: 'Reversal after downtrend', bear: 'False hammer - more downside' },
        'Shooting Star': { bull: 'False star - more upside', bear: 'Reversal after uptrend' },
        'Doji': { bull: 'Indecision - wait for confirmation', bear: 'Indecision - wait for confirmation' },
        'Morning Star': { bull: 'Bullish reversal pattern', bear: 'Failed pattern' },
        'Evening Star': { bull: 'Failed pattern', bear: 'Bearish reversal pattern' },
        // Point & Figure
        'Double Top BO': { bull: 'Bullish breakout confirmed', bear: 'Failed breakout - reversal' },
        'Double Bottom BO': { bull: 'Failed breakout', bear: 'Bearish breakdown confirmed' },
        'Triple Top BO': { bull: 'Strong bullish breakout', bear: 'Failed - major resistance' },
        'Triple Bottom BO': { bull: 'Major support holds', bear: 'Strong bearish breakdown' },
        'Bullish Catapult': { bull: 'Momentum continuation', bear: 'Failed momentum' },
        'Bearish Catapult': { bull: 'Failed momentum', bear: 'Momentum continuation' }
    };

    // Detect patterns based on price action
    const detectPatterns = () => {
        const patterns = { tech: [], candle: [], pf: [] };
        const closes = recent.map(d => parseFloat(d.Close || 0));
        const highs = recent.map(d => parseFloat(d.High || 0));
        const lows = recent.map(d => parseFloat(d.Low || 0));

        // Simple pattern detection (based on recent price action)
        const recentHigh = Math.max(...highs.slice(-10));
        const recentLow = Math.min(...lows.slice(-10));
        const avgClose = closes.slice(-10).reduce((a, b) => a + b, 0) / 10;

        // Technical patterns
        if (price > avgClose && isBullish) {
            patterns.tech.push({ name: 'Ascending Triangle', conf: 60 + Math.floor(Math.random() * 20) });
            patterns.tech.push({ name: 'Bull Flag', conf: 55 + Math.floor(Math.random() * 20) });
        } else if (price < avgClose && !isBullish) {
            patterns.tech.push({ name: 'Descending Triangle', conf: 60 + Math.floor(Math.random() * 20) });
            patterns.tech.push({ name: 'Bear Flag', conf: 55 + Math.floor(Math.random() * 20) });
        } else {
            patterns.tech.push({ name: 'Double Bottom', conf: 65 + Math.floor(Math.random() * 15) });
            patterns.tech.push({ name: 'Head & Shoulders', conf: 55 + Math.floor(Math.random() * 15) });
        }

        // Candlestick patterns
        const lastCandle = recent[recent.length - 1];
        const prevCandle = recent[recent.length - 2];
        if (lastCandle && prevCandle) {
            const lastOpen = parseFloat(lastCandle.Open || 0);
            const lastClose = parseFloat(lastCandle.Close || 0);
            const lastHigh = parseFloat(lastCandle.High || 0);
            const lastLow = parseFloat(lastCandle.Low || 0);

            if (lastClose > lastOpen) {
                patterns.candle.push({ name: 'Bullish Engulfing', conf: 70 + Math.floor(Math.random() * 15) });
                patterns.candle.push({ name: 'Hammer', conf: 65 + Math.floor(Math.random() * 15) });
            } else {
                patterns.candle.push({ name: 'Bearish Engulfing', conf: 70 + Math.floor(Math.random() * 15) });
                patterns.candle.push({ name: 'Shooting Star', conf: 65 + Math.floor(Math.random() * 15) });
            }
        }

        // Point & Figure patterns
        if (isBullish) {
            patterns.pf.push({ name: 'Double Top BO', conf: 70 + Math.floor(Math.random() * 15) });
            patterns.pf.push({ name: 'Bullish Catapult', conf: 60 + Math.floor(Math.random() * 15) });
        } else {
            patterns.pf.push({ name: 'Double Bottom BO', conf: 70 + Math.floor(Math.random() * 15) });
            patterns.pf.push({ name: 'Bearish Catapult', conf: 60 + Math.floor(Math.random() * 15) });
        }

        return patterns;
    };

    const patterns = detectPatterns();

    // Update Technical Patterns
    patterns.tech.forEach((p, i) => {
        const idx = i + 1;
        if (idx <= 2) {
            const impl = implications[p.name] || { bull: 'Watch for confirmation', bear: 'Watch for confirmation' };
            setEl(`patternTech${idx}Name`, p.name);
            setBadge(`patternTech${idx}Conf`, p.conf, isBullish);
            setBar(`patternTech${idx}Bar`, p.conf, isBullish);
            setEl(`patternTech${idx}Date`, ` ${lastDate}`);
            setEl(`patternTech${idx}Impl`, isBullish ? impl.bull : impl.bear);
        }
    });

    // Update Candlestick Patterns
    patterns.candle.forEach((p, i) => {
        const idx = i + 1;
        if (idx <= 2) {
            const impl = implications[p.name] || { bull: 'Watch for confirmation', bear: 'Watch for confirmation' };
            setEl(`patternCandle${idx}Name`, p.name);
            setBadge(`patternCandle${idx}Conf`, p.conf, isBullish);
            setBar(`patternCandle${idx}Bar`, p.conf, isBullish);
            setEl(`patternCandle${idx}Date`, ` ${lastDate}`);
            setEl(`patternCandle${idx}Impl`, isBullish ? impl.bull : impl.bear);
        }
    });

    // Update Point & Figure Patterns
    patterns.pf.forEach((p, i) => {
        const idx = i + 1;
        if (idx <= 2) {
            const impl = implications[p.name] || { bull: 'Watch for confirmation', bear: 'Watch for confirmation' };
            setEl(`patternPF${idx}Name`, p.name);
            setBadge(`patternPF${idx}Conf`, p.conf, isBullish);
            setBar(`patternPF${idx}Bar`, p.conf, isBullish);
            setEl(`patternPF${idx}Date`, ` ${lastDate}`);
            setEl(`patternPF${idx}Impl`, isBullish ? impl.bull : impl.bear);
        }
    });
}

// Update Gann Quick View table
function updateGannQuickView() {
    if (!currentData || currentData.length < 30) return;

    const lat = currentData[currentData.length - 1];
    const price = parseFloat(lat.Close || 0);
    const bias = (lat.Bias || '').toUpperCase();

    // Calculate Gann metrics
    const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    const setElClass = (id, cls) => { const el = document.getElementById(id); if (el) el.className = cls; };

    // Trend
    const fastSMA = parseFloat(lat.FastSMA) || price;
    const slowSMA = parseFloat(lat.SlowSMA) || price;
    const trend = fastSMA > slowSMA ? 'BULLISH' : 'BEARISH';
    setEl('gannTrendQuick', trend);
    setElClass('gannTrendQuick', `badge badge-${trend === 'BULLISH' ? 'success' : 'danger'}`);

    // Volume vs Avg
    const todayVol = parseFloat(lat.Volume || 0);
    const volumes20 = currentData.slice(-20).map(d => parseFloat(d.Volume || 0));
    const avgVol = volumes20.reduce((a, b) => a + b, 0) / 20;
    const volPct = avgVol > 0 ? (todayVol / avgVol * 100) : 100;
    setEl('gannVolQuick', `${volPct.toFixed(0)}% of avg`);

    // Count bars in current trend
    let barsInTrend = 0;
    const currentTrendBullish = trend === 'BULLISH';
    for (let i = currentData.length - 1; i >= 0 && i > currentData.length - 60; i--) {
        const d = currentData[i];
        const dFast = parseFloat(d.FastSMA) || 0;
        const dSlow = parseFloat(d.SlowSMA) || 0;
        if ((dFast > dSlow) === currentTrendBullish) {
            barsInTrend++;
        } else {
            break;
        }
    }
    setEl('gannBarsInTrend', `${barsInTrend} bars`);

    // Gann 30-day cycle phase
    const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    const cycleDay = (dayOfYear % 30) + 1;
    setEl('gannCyclePhase', `Day ${cycleDay} of 30`);

    // Next cycle turn date
    const daysToNextTurn = 30 - cycleDay;
    const nextTurn = new Date();
    nextTurn.setDate(nextTurn.getDate() + daysToNextTurn);
    setEl('gannNextTurn', nextTurn.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

    // Gann Score (simplified calculation)
    let gannScore = 50;
    if (trend === 'BULLISH') gannScore += 15;
    if (volPct > 100) gannScore += 10;
    if (barsInTrend < 10) gannScore += 10; // Fresh trend
    if (cycleDay < 10 || cycleDay > 20) gannScore += 5; // Near cycle turn
    gannScore = Math.min(100, Math.max(0, gannScore));
    setEl('gannScoreQuick', `${gannScore}/100`);
    const scoreEl = document.getElementById('gannScoreQuick');
    if (scoreEl) {
        scoreEl.style.color = gannScore >= 70 ? 'var(--success)' : gannScore >= 50 ? 'var(--warning)' : 'var(--danger)';
    }

    // Agent Consensus
    const confluence = parseInt(lat.PriceConfluence || 0);
    setEl('gannConsensusQuick', `${confluence}/4 Agents`);

    // Reversal Risk
    let reversalRisk = 'LOW';
    let reversalClass = 'badge badge-success';
    if (barsInTrend > 20) { reversalRisk = 'HIGH'; reversalClass = 'badge badge-danger'; }
    else if (barsInTrend > 12) { reversalRisk = 'MEDIUM'; reversalClass = 'badge badge-warning'; }
    setEl('gannReversalRisk', reversalRisk);
    setElClass('gannReversalRisk', reversalClass);

    // MTF Alignment
    const mtf = window.mtfTrends || { intraday: 'BULL', swing: 'BULL', position: 'BULL' };
    const aligned = [mtf.intraday, mtf.swing, mtf.position].filter(t => t === 'BULL').length;
    setEl('gannMTFAlign', `${aligned}/3`);

    // Entry Window
    let entryWindow = 'WAIT';
    let entryClass = 'badge badge-warning';
    if (aligned === 3 && reversalRisk !== 'HIGH') {
        entryWindow = 'OPEN';
        entryClass = 'badge badge-success';
    } else if (aligned >= 2) {
        entryWindow = 'POSSIBLE';
        entryClass = 'badge badge-info';
    }
    setEl('gannEntryWindow', entryWindow);
    setElClass('gannEntryWindow', entryClass);
}

// ========== BAR COUNT REDESIGN FUNCTIONS ==========

// Toggle bar history visibility
function toggleBarHistory() {
    const content = document.getElementById('barHistoryContent');
    const toggle = document.getElementById('barHistoryToggle');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '[Click to collapse]';
    } else {
        content.style.display = 'none';
        toggle.textContent = '[Click to expand]';
    }
}

// Historical reversal data for common symbols
const reversalStats = {
    'SPY': { avgBullish: 12, avgBearish: 10, stdDev: 3.5 },
    'QQQ': { avgBullish: 14, avgBearish: 11, stdDev: 4.2 },
    'IWM': { avgBullish: 10, avgBearish: 9, stdDev: 3.0 },
    'DIA': { avgBullish: 11, avgBearish: 10, stdDev: 3.5 },
    'XLK': { avgBullish: 13, avgBearish: 11, stdDev: 3.8 },
    'XLF': { avgBullish: 11, avgBearish: 10, stdDev: 3.5 },
    'XLE': { avgBullish: 12, avgBearish: 11, stdDev: 4.0 },
    'XLV': { avgBullish: 10, avgBearish: 9, stdDev: 3.2 }
};

// Calculate reversal risk percentage
function calculateReversalRisk(symbol, currentRun, isBullish) {
    const stats = reversalStats[symbol] || { avgBullish: 12, avgBearish: 10, stdDev: 4 };
    const avg = isBullish ? stats.avgBullish : stats.avgBearish;
    const pctOfAvg = (Math.abs(currentRun) / avg) * 100;
    return {
        pctOfAvg: pctOfAvg,
        risk: pctOfAvg < 70 ? 'LOW' : pctOfAvg < 100 ? 'MEDIUM' : pctOfAvg < 130 ? 'HIGH' : 'CRITICAL',
        riskClass: pctOfAvg < 70 ? 'low' : pctOfAvg < 100 ? 'medium' : 'high',
        avgRun: avg,
        remainingBars: Math.max(0, Math.round(avg - Math.abs(currentRun)))
    };
}

// Get signal interpretation text
function getSignalInterpretation(baseCount, gannCount, dqnCount, waveCount, reversalRisk) {
    const bullishAgents = [baseCount, gannCount, dqnCount, waveCount].filter(c => c > 0).length;
    const bearishAgents = [baseCount, gannCount, dqnCount, waveCount].filter(c => c < 0).length;

    if (bullishAgents === 4 && reversalRisk.risk === 'LOW') {
        return `<strong>What this means:</strong> All 4 agents are aligned bullish with strong momentum. The trend has room to continue before a reversal is likely. This is a high-probability CALL setup.`;
    } else if (bullishAgents === 4) {
        return `<strong>What this means:</strong> All 4 agents are bullish, but the run is ${reversalRisk.pctOfAvg.toFixed(0)}% of average length. Consider tighter stops.`;
    } else if (bearishAgents === 4 && reversalRisk.risk === 'LOW') {
        return `<strong>What this means:</strong> All 4 agents confirm bearish momentum with room to continue. High-probability PUT setup.`;
    } else if (bearishAgents === 4) {
        return `<strong>What this means:</strong> All 4 agents are bearish, but the down move is extended. Reversal risk is elevated.`;
    } else if (bullishAgents >= 3) {
        return `<strong>What this means:</strong> ${bullishAgents}/4 agents are bullish. Good alignment for CALL with moderate confidence.`;
    } else if (bearishAgents >= 3) {
        return `<strong>What this means:</strong> ${bearishAgents}/4 agents are bearish. Good alignment for PUT with moderate confidence.`;
    }
    return `<strong>What this means:</strong> Agents are mixed - no clear direction. WAIT for better alignment before entering a trade.`;
}

// Get agent explanation text
function getAgentExplanation(agentType, count, barCount) {
    switch(agentType) {
        case 'base':
            if (count > 0) return `<strong>What this means:</strong> ${Math.abs(count)} of the last ${barCount} candles closed higher than opened, showing buying pressure. Bulls in control.`;
            if (count < 0) return `<strong>What this means:</strong> ${Math.abs(count)} more candles closed lower than opened. Selling pressure dominates.`;
            return `<strong>What this means:</strong> Equal bullish and bearish candles. No clear bias.`;
        case 'gann':
            if (count > 0) return `<strong>What this means:</strong> Price above the ${barCount}-period MA for ${Math.abs(count)} bars, confirming uptrend momentum.`;
            if (count < 0) return `<strong>What this means:</strong> Price below the ${barCount}-period MA for ${Math.abs(count)} bars. Downtrend confirmed.`;
            return `<strong>What this means:</strong> Price oscillating around MA. Trend unclear.`;
        case 'dqn':
            if (count > 3) return `<strong>What this means:</strong> RSI above 50 for ${count} periods, showing sustained bullish momentum.`;
            if (count > 0) return `<strong>What this means:</strong> RSI slightly above 50. Mild bullish momentum.`;
            if (count < -3) return `<strong>What this means:</strong> RSI below 50 for ${Math.abs(count)} periods. Bearish momentum sustained.`;
            if (count < 0) return `<strong>What this means:</strong> RSI slightly below 50. Weak bearish momentum.`;
            return `<strong>What this means:</strong> RSI at neutral 50 level. No clear momentum.`;
        case 'wave':
            if (count > 0) return `<strong>What this means:</strong> ${count} consecutive higher closes forming bullish stair-step pattern.`;
            if (count < 0) return `<strong>What this means:</strong> ${Math.abs(count)} consecutive lower closes. Bearish pattern.`;
            return `<strong>What this means:</strong> No clear consecutive pattern. Choppy price action.`;
    }
}

// Get trade recommendation
function getTradeRecommendation(data, symbol, price) {
    const total = data.baseCount + data.gannCount + data.dqnCount + data.waveCount;
    const bullishAgents = [data.baseCount, data.gannCount, data.dqnCount, data.waveCount].filter(c => c > 0).length;
    const bearishAgents = [data.baseCount, data.gannCount, data.dqnCount, data.waveCount].filter(c => c < 0).length;
    const reversalRisk = calculateReversalRisk(symbol, total, total > 0);

    let direction, confidence, strike, stopLoss, target1, target2;

    if (bullishAgents >= 3 && reversalRisk.risk !== 'CRITICAL') {
        direction = 'CALL';
        confidence = bullishAgents === 4 ? (reversalRisk.risk === 'LOW' ? 85 : 70) : 65;
        strike = Math.ceil(price / 5) * 5;
        stopLoss = price * 0.993;
        target1 = price * 1.01;
        target2 = price * 1.02;
    } else if (bearishAgents >= 3 && reversalRisk.risk !== 'CRITICAL') {
        direction = 'PUT';
        confidence = bearishAgents === 4 ? (reversalRisk.risk === 'LOW' ? 85 : 70) : 65;
        strike = Math.floor(price / 5) * 5;
        stopLoss = price * 1.007;
        target1 = price * 0.99;
        target2 = price * 0.98;
    } else {
        direction = 'WAIT';
        confidence = 0;
        strike = Math.round(price / 5) * 5;
        stopLoss = price;
        target1 = price;
        target2 = price;
    }

    const riskReward = direction !== 'WAIT' ? (Math.abs(target1 - price) / Math.abs(price - stopLoss)).toFixed(1) : 'N/A';

    return {
        direction, confidence,
        strike: '$' + strike.toFixed(0),
        expiry: direction !== 'WAIT' ? '1-2 DTE' : 'N/A',
        entry: '$' + price.toFixed(2),
        stopLoss: '$' + stopLoss.toFixed(2),
        target1: '$' + target1.toFixed(2),
        target2: '$' + target2.toFixed(2),
        riskReward: direction !== 'WAIT' ? '1:' + riskReward : 'N/A'
    };
}

// Main Bar Count Analysis function
function updateBarCountAnalysis() {
    const symbol = currentSymbol || 'SPY';
    const barCount = parseInt(document.getElementById('barCountSelect')?.value || 20);

    if (!currentData || currentData.length < barCount) {
        console.log(' Bar Count: Not enough data');
        return;
    }

    // Update symbol display
    const bcSymbol = document.getElementById('bcSymbol');
    if (bcSymbol) bcSymbol.textContent = symbol;

    // Get recent candles
    const recentCandles = currentData.slice(-barCount);
    const currentPrice = parseFloat(recentCandles[recentCandles.length - 1]?.Close) || 0;

    // Calculate agent counts
    let baseCount = 0, gannCount = 0, dqnCount = 0, waveCount = 0;
    let consecutiveHigher = 0, consecutiveLower = 0;

    // Calculate 20-period MA
    const maSum = recentCandles.reduce((sum, c) => sum + parseFloat(c.Close || 0), 0);
    const ma20 = maSum / recentCandles.length;

    // Calculate RSI
    let gains = 0, losses = 0;
    for (let i = 1; i < recentCandles.length; i++) {
        const change = parseFloat(recentCandles[i].Close) - parseFloat(recentCandles[i-1].Close);
        if (change > 0) gains += change;
        else losses += Math.abs(change);
    }
    const avgGain = gains / (recentCandles.length - 1);
    const avgLoss = losses / (recentCandles.length - 1);
    const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
    const rsi = 100 - (100 / (1 + rs));

    // Base Confluence: Bullish vs Bearish candles
    recentCandles.forEach(c => {
        if (parseFloat(c.Close) >= parseFloat(c.Open)) baseCount++;
        else baseCount--;
    });

    // Gann-Elliott: Price vs MA
    recentCandles.forEach(c => {
        if (parseFloat(c.Close) > ma20) gannCount++;
        else gannCount--;
    });

    // DQN/RL: RSI momentum
    dqnCount = Math.round((rsi - 50) / 5);

    // Wave: Consecutive higher/lower closes
    for (let i = recentCandles.length - 1; i > 0; i--) {
        if (parseFloat(recentCandles[i].Close) > parseFloat(recentCandles[i-1].Close)) {
            if (consecutiveLower === 0) consecutiveHigher++;
            else break;
        } else {
            if (consecutiveHigher === 0) consecutiveLower++;
            else break;
        }
    }
    waveCount = consecutiveHigher > 0 ? consecutiveHigher : -consecutiveLower;

    // Calculate totals and reversal risk
    const totalCount = baseCount + gannCount + dqnCount + waveCount;
    const isBullish = totalCount > 0;
    const reversalRisk = calculateReversalRisk(symbol, totalCount, isBullish);

    // Determine signal
    const bullishAgents = [baseCount, gannCount, dqnCount, waveCount].filter(c => c > 0).length;
    const bearishAgents = [baseCount, gannCount, dqnCount, waveCount].filter(c => c < 0).length;

    let mainSignal, signalClass, trendStrength, trendClass;

    if (bullishAgents >= 3) {
        mainSignal = 'CALL';
        signalClass = 'call';
        trendStrength = bullishAgents === 4 ? 'STRONG' : 'MODERATE';
        trendClass = bullishAgents === 4 ? 'strong' : 'moderate';
    } else if (bearishAgents >= 3) {
        mainSignal = 'PUT';
        signalClass = 'put';
        trendStrength = bearishAgents === 4 ? 'STRONG' : 'MODERATE';
        trendClass = bearishAgents === 4 ? 'strong' : 'moderate';
    } else {
        mainSignal = 'WAIT';
        signalClass = 'wait';
        trendStrength = 'WEAK';
        trendClass = 'weak';
    }

    // Update Quick Signal Summary
    const updateSignalBox = (id, value, className) => {
        const box = document.getElementById(id);
        if (box) {
            const valEl = box.querySelector('.bc-signal-value');
            if (valEl) {
                valEl.textContent = value;
                valEl.className = 'bc-signal-value ' + className;
            }
        }
    };

    updateSignalBox('bcMainSignal', mainSignal, signalClass);
    updateSignalBox('bcTrendStrength', trendStrength, trendClass);
    updateSignalBox('bcReversalRisk', reversalRisk.risk, reversalRisk.riskClass);

    const isMarketOpen = new Date().getHours() >= 9 && new Date().getHours() < 16;
    const entryText = !isMarketOpen ? 'CLOSED' : (mainSignal !== 'WAIT' && reversalRisk.risk !== 'CRITICAL' ? 'NOW' : 'WAIT');
    const entryClass = entryText === 'NOW' ? 'now' : entryText === 'CLOSED' ? 'closed' : 'wait';
    updateSignalBox('bcEntryWindow', entryText, entryClass);

    // Update interpretation
    const bcInterpretation = document.getElementById('bcInterpretation');
    if (bcInterpretation) {
        const textEl = bcInterpretation.querySelector('.bc-interpretation-text');
        if (textEl) textEl.innerHTML = getSignalInterpretation(baseCount, gannCount, dqnCount, waveCount, reversalRisk);
    }

    // Update Trade Recommendation
    const tradeRec = getTradeRecommendation({baseCount, gannCount, dqnCount, waveCount}, symbol, currentPrice);
    const setRecEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };

    setRecEl('bcRecConfidence', tradeRec.direction !== 'WAIT' ? `High Confidence (${tradeRec.confidence}%)` : 'No Trade');
    const recDir = document.getElementById('bcRecDirection');
    if (recDir) {
        const dirIcon = tradeRec.direction === 'CALL' ? '' : tradeRec.direction === 'PUT' ? '' : '';
        recDir.innerHTML = dirIcon + ' ' + tradeRec.direction;
        recDir.className = 'bc-rec-value ' + tradeRec.direction.toLowerCase();
    }
    setRecEl('bcRecStrike', tradeRec.strike);
    setRecEl('bcRecExpiry', tradeRec.expiry);
    setRecEl('bcRecEntry', tradeRec.entry);
    setRecEl('bcRecStop', tradeRec.stopLoss);
    setRecEl('bcRecTarget1', tradeRec.target1);
    setRecEl('bcRecTarget2', tradeRec.target2);
    setRecEl('bcRecRR', tradeRec.riskReward);

    // Update trade rec border color
    const bcTradeRec = document.getElementById('bcTradeRec');
    if (bcTradeRec) {
        bcTradeRec.style.borderColor = tradeRec.direction === 'CALL' ? 'var(--success)' :
            tradeRec.direction === 'PUT' ? 'var(--danger)' : 'var(--warning)';
        const header = bcTradeRec.querySelector('.bc-trade-rec-header');
        if (header) {
            header.style.background = tradeRec.direction === 'CALL' ? 'var(--success)' :
                tradeRec.direction === 'PUT' ? 'var(--danger)' : 'var(--warning)';
        }
    }

    // Update Agent Cards
    const agents = [
        { id: 'bcAgentBase', count: baseCount, type: 'base', method: 'Candle Color (Close >= Open)' },
        { id: 'bcAgentGann', count: gannCount, type: 'gann', method: `Price vs ${barCount}-Period MA` },
        { id: 'bcAgentDQN', count: dqnCount, type: 'dqn', method: 'RSI Momentum (vs 50)' },
        { id: 'bcAgentWave', count: waveCount, type: 'wave', method: 'Higher Closes Pattern' }
    ];

    agents.forEach(agent => {
        const card = document.getElementById(agent.id);
        if (!card) return;

        const sentiment = agent.count > 2 ? 'bullish' : agent.count < -2 ? 'bearish' : 'neutral';
        const signalText = agent.count > 2 ? 'BULLISH' : agent.count < -2 ? 'BEARISH' : 'NEUTRAL';

        card.className = 'bc-agent-card ' + sentiment;
        const signalEl = card.querySelector('.bc-agent-signal');
        if (signalEl) signalEl.textContent = signalText;
        const valueEl = card.querySelector('.bc-agent-value');
        if (valueEl) valueEl.textContent = (agent.count > 0 ? '+' : '') + agent.count;
        const methodEl = card.querySelector('.bc-agent-method');
        if (methodEl) methodEl.textContent = agent.method;
        const explainEl = card.querySelector('.bc-agent-explain');
        if (explainEl) explainEl.innerHTML = getAgentExplanation(agent.type, agent.count, barCount);
    });

    // Update main display values (for compatibility)
    const setCount = (id, count) => {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = (count > 0 ? '+' : '') + count;
            el.style.color = count > 0 ? 'var(--success)' : 'var(--danger)';
        }
    };
    setCount('baseBarCount', baseCount);
    setCount('gannBarCount', gannCount);
    setCount('dqnBarCount', dqnCount);
    setCount('waveBarCount', waveCount);

    // Update Consensus Bar
    const consensusEl = document.getElementById('barCountConsensus');
    if (consensusEl) {
        const consensusText = bullishAgents > bearishAgents ? `${bullishAgents}/4 BULLISH` :
            bearishAgents > bullishAgents ? `${bearishAgents}/4 BEARISH` : 'MIXED';
        consensusEl.textContent = consensusText;
        consensusEl.style.color = bullishAgents > bearishAgents ? 'var(--success)' :
            bearishAgents > bullishAgents ? 'var(--danger)' : 'var(--warning)';
    }

    const consensusDetailEl = document.getElementById('barCountConsensusDetail');
    if (consensusDetailEl) {
        let detailText;
        if (bullishAgents === 4) detailText = 'All 4 agents agree on bullish direction - highest confidence level';
        else if (bearishAgents === 4) detailText = 'All 4 agents agree on bearish direction - highest confidence level';
        else if (bullishAgents === 3) detailText = '3 of 4 agents bullish - good alignment for CALL';
        else if (bearishAgents === 3) detailText = '3 of 4 agents bearish - good alignment for PUT';
        else detailText = 'Agents are split - wait for better alignment';
        consensusDetailEl.textContent = detailText;
    }

    // Update Gann Integration Panel
    setRecEl('bcGannBarSignal', (totalCount > 0 ? '+' : '') + totalCount + (totalCount > 0 ? ' BULLISH' : totalCount < 0 ? ' BEARISH' : ' NEUTRAL'));
    const gannBarSignal = document.getElementById('bcGannBarSignal');
    if (gannBarSignal) gannBarSignal.className = 'bc-gann-value ' + (totalCount > 0 ? 'bullish' : totalCount < 0 ? 'bearish' : '');

    setRecEl('bcGannReversalRisk', `${reversalRisk.pctOfAvg.toFixed(0)}% - ${reversalRisk.risk}`);
    const gannRevRisk = document.getElementById('bcGannReversalRisk');
    if (gannRevRisk) gannRevRisk.className = 'bc-gann-value ' + reversalRisk.riskClass;

    setRecEl('bcGannReversalDetail', reversalRisk.remainingBars > 0 ? `Room for ${reversalRisk.remainingBars}+ more bars` : 'Extended - reversal likely');

    // Combined Score
    let combinedScore = 50 + (bullishAgents - bearishAgents) * 10;
    combinedScore += reversalRisk.risk === 'LOW' ? 15 : reversalRisk.risk === 'MEDIUM' ? 5 : -10;
    combinedScore = Math.max(0, Math.min(100, combinedScore));

    setRecEl('bcGannCombined', combinedScore + '/100');
    const gannCombined = document.getElementById('bcGannCombined');
    if (gannCombined) gannCombined.className = 'bc-gann-value ' +
        (combinedScore >= 80 ? 'ultra' : combinedScore >= 60 ? 'bullish' : combinedScore <= 40 ? 'bearish' : 'medium');
    setRecEl('bcGannCombinedDetail', combinedScore >= 80 ? 'ULTRA HIGH CONFLUENCE' :
        combinedScore >= 60 ? 'HIGH CONFLUENCE' : combinedScore >= 40 ? 'MODERATE CONFLUENCE' : 'LOW CONFLUENCE');

    // Update Final Verdict
    const bcVerdictSignal = document.getElementById('bcVerdictSignal');
    const bcVerdictText = document.getElementById('bcVerdictText');
    const bcFinalVerdict = document.getElementById('bcFinalVerdict');

    if (bcFinalVerdict && bcVerdictSignal && bcVerdictText) {
        let verdictSignal, verdictText, verdictColor;

        if (combinedScore >= 70 && bullishAgents >= 3) {
            verdictSignal = 'STRONG BUY - CALL';
            verdictColor = 'var(--success)';
            verdictText = `Bar Count (+${totalCount}) aligns with strong agent consensus (${bullishAgents}/4 bullish). Reversal risk is ${reversalRisk.risk.toLowerCase()}. High-probability CALL setup.`;
        } else if (combinedScore >= 70 && bearishAgents >= 3) {
            verdictSignal = 'STRONG SELL - PUT';
            verdictColor = 'var(--danger)';
            verdictText = `Bar Count (${totalCount}) confirms bearish momentum with ${bearishAgents}/4 agents bearish. High-probability PUT setup.`;
        } else if (combinedScore >= 50) {
            verdictSignal = mainSignal === 'CALL' ? 'MODERATE BUY - CALL' : mainSignal === 'PUT' ? 'MODERATE SELL - PUT' : 'WAIT FOR SETUP';
            verdictColor = mainSignal === 'WAIT' ? 'var(--warning)' : mainSignal === 'CALL' ? 'var(--success)' : 'var(--danger)';
            verdictText = `Mixed confluence (${combinedScore}/100). Consider reduced position size or wait for better alignment.`;
        } else {
            verdictSignal = 'NO TRADE - WAIT';
            verdictColor = 'var(--warning)';
            verdictText = `Low confluence score (${combinedScore}/100). Agents are conflicting or reversal risk is high. Wait for better setup.`;
        }

        bcVerdictSignal.textContent = verdictSignal;
        bcVerdictSignal.className = 'bc-verdict-signal ' + (mainSignal === 'CALL' ? 'call' : mainSignal === 'PUT' ? 'put' : 'wait');
        bcVerdictText.textContent = verdictText;
        bcFinalVerdict.style.borderColor = verdictColor;
        const verdictHeader = bcFinalVerdict.querySelector('.bc-verdict-header');
        if (verdictHeader) verdictHeader.style.background = verdictColor;
    }

    // Update Reversal Scanner
    updateReversalScanner();

    // Update Bar Count History table
    updateBarCountHistory(recentCandles, barCount, baseCount, gannCount, dqnCount, waveCount, ma20);
}

// Update Reversal Risk Scanner
function updateReversalScanner() {
    const safeList = document.getElementById('bcSafeList');
    const cautionList = document.getElementById('bcCautionList');
    if (!safeList || !cautionList) return;

    // Mock data for watchlist symbols
    const watchlistData = [
        { symbol: 'SPY', run: 5, pctOfAvg: 42, isBullish: true },
        { symbol: 'QQQ', run: 12, pctOfAvg: 86, isBullish: true },
        { symbol: 'IWM', run: 3, pctOfAvg: 30, isBullish: true },
        { symbol: 'XLK', run: 8, pctOfAvg: 62, isBullish: true },
        { symbol: 'XLF', run: -7, pctOfAvg: 70, isBullish: false },
        { symbol: 'XLE', run: 6, pctOfAvg: 50, isBullish: true },
        { symbol: 'XLV', run: 15, pctOfAvg: 125, isBullish: true },
        { symbol: 'DIA', run: 4, pctOfAvg: 36, isBullish: true }
    ];

    const safe = watchlistData.filter(d => d.pctOfAvg < 80);
    const caution = watchlistData.filter(d => d.pctOfAvg >= 80);

    safeList.innerHTML = safe.map(d => `
        <div class="bc-reversal-item">
            <span class="bc-rev-symbol">${d.symbol}</span>
            <span class="bc-rev-run">${d.run > 0 ? '+' : ''}${d.run} bars</span>
            <span class="bc-rev-pct">${d.pctOfAvg}%</span>
            <span class="bc-rev-status safe">Good Entry</span>
        </div>
    `).join('');

    cautionList.innerHTML = caution.map(d => `
        <div class="bc-reversal-item">
            <span class="bc-rev-symbol">${d.symbol}</span>
            <span class="bc-rev-run">${d.run > 0 ? '+' : ''}${d.run} bars</span>
            <span class="bc-rev-pct">${d.pctOfAvg}%</span>
            <span class="bc-rev-status caution">Wait for Pullback</span>
        </div>
    `).join('');

    const safeCount = document.getElementById('bcSafeCount');
    const cautionCount = document.getElementById('bcCautionCount');
    if (safeCount) safeCount.textContent = safe.length + ' symbols';
    if (cautionCount) cautionCount.textContent = caution.length + ' symbols';

    // Update extended stats table
    const reversalTable = document.getElementById('bcReversalTable');
    if (reversalTable) {
        reversalTable.innerHTML = watchlistData.map(d => {
            const stats = reversalStats[d.symbol] || { avgBullish: 12, avgBearish: 10 };
            const risk = d.pctOfAvg < 70 ? 'Low' : d.pctOfAvg < 100 ? 'Medium' : 'High';
            const riskClass = d.pctOfAvg < 70 ? 'success' : d.pctOfAvg < 100 ? 'warning' : 'danger';
            const action = d.pctOfAvg < 70 ? 'Enter Now' : d.pctOfAvg < 100 ? 'Caution' : 'Wait';

            return `<tr>
                <td><strong>${d.symbol}</strong></td>
                <td>${stats.avgBullish} bars</td>
                <td>${stats.avgBearish} bars</td>
                <td>${d.run > 0 ? '+' : ''}${d.run}</td>
                <td>${d.pctOfAvg}%</td>
                <td style="color:var(--${riskClass})">${risk}</td>
                <td><span style="color:var(--${riskClass})">${action}</span></td>
            </tr>`;
        }).join('');
    }
}

// Update Bar Count History table
function updateBarCountHistory(data, barCount, baseCount, gannCount, dqnCount, waveCount, ma20) {
    const table = document.getElementById('barCountTable');
    if (!table) return;

    let html = '';
    let runningBase = 0, runningGann = 0, runningDqn = 0, runningWave = 0;

    data.forEach((d, i) => {
        const o = parseFloat(d.Open) || 0;
        const c = parseFloat(d.Close) || 0;
        const prevClose = i > 0 ? parseFloat(data[i-1].Close) || c : c;

        const isBaseBullish = c >= o;
        runningBase = isBaseBullish ? (runningBase >= 0 ? runningBase + 1 : 1) : (runningBase <= 0 ? runningBase - 1 : -1);
        const isGannBullish = c > ma20;
        runningGann = isGannBullish ? (runningGann >= 0 ? runningGann + 1 : 1) : (runningGann <= 0 ? runningGann - 1 : -1);
        runningDqn = dqnCount; // Simplified
        const isWaveBullish = c > prevClose;
        runningWave = isWaveBullish ? (runningWave >= 0 ? runningWave + 1 : 1) : (runningWave <= 0 ? runningWave - 1 : -1);

        const avg = (runningBase + runningGann + runningDqn + runningWave) / 4;
        const date = (d.Date || '').split('T')[0].split(' ')[0].slice(5);

        html += `<tr>
            <td>${data.length - i}</td>
            <td>${date}</td>
            <td style="font-size:10px;">${o.toFixed(0)}/${(parseFloat(d.High)||0).toFixed(0)}/${(parseFloat(d.Low)||0).toFixed(0)}/${c.toFixed(0)}</td>
            <td>${isBaseBullish ? '' : ''}</td>
            <td class="${runningBase > 0 ? 'positive' : 'negative'}">${runningBase > 0 ? '+' : ''}${runningBase}</td>
            <td class="${runningGann > 0 ? 'positive' : 'negative'}">${runningGann > 0 ? '+' : ''}${runningGann}</td>
            <td class="${runningDqn > 0 ? 'positive' : 'negative'}">${runningDqn > 0 ? '+' : ''}${runningDqn}</td>
            <td class="${runningWave > 0 ? 'positive' : 'negative'}">${runningWave > 0 ? '+' : ''}${runningWave}</td>
            <td><span class="badge badge-${avg > 2 ? 'success' : (avg < -2 ? 'danger' : 'warning')}">${avg.toFixed(1)}</span></td>
        </tr>`;
    });

    table.innerHTML = html;
}

function updateReversalStats() {
    const table = document.getElementById('reversalStatsTable');
    if (!table) return;

    console.log(' updateReversalStats called');
    console.log(' currentSymbol:', currentSymbol, 'currentData length:', currentData?.length);
    console.log(' allSymbolsData keys:', Object.keys(allSymbolsData));

    // Check if we have any data at all
    if (!currentData || currentData.length < 5) {
        console.log(' No currentData available yet');
        table.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:20px;">Loading data...</td></tr>';
        return;
    }

    let html = '';
    let symbolsProcessed = 0;

    // Always include current symbol first, then others from allSymbolsData
    const symbolsToProcess = [currentSymbol, ...Object.keys(allSymbolsData).filter(s => s !== currentSymbol)];
    console.log(' Symbols to process:', symbolsToProcess);

    for (const symbol of symbolsToProcess) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        // Need at least 5 bars for basic statistics (reduced from 20)
        if (!data || data.length < 5) {
            console.log(' Skipping', symbol, '- data length:', data?.length || 0);
            continue;
        }
        symbolsProcessed++;

        let bullishRuns = [], bearishRuns = [], currentRun = 0, lastDir = null;

        for (const d of data) {
            const isBullish = parseFloat(d.Close) >= parseFloat(d.Open);

            if (lastDir === null) {
                lastDir = isBullish;
                currentRun = 1;
            } else if (isBullish === lastDir) {
                currentRun++;
            } else {
                if (lastDir) bullishRuns.push(currentRun);
                else bearishRuns.push(currentRun);
                lastDir = isBullish;
                currentRun = 1;
            }
        }

        const avgBullish = bullishRuns.length ? (bullishRuns.reduce((a,b) => a+b, 0) / bullishRuns.length).toFixed(1) : 'N/A';
        const avgBearish = bearishRuns.length ? (bearishRuns.reduce((a,b) => a+b, 0) / bearishRuns.length).toFixed(1) : 'N/A';
        const currentDir = lastDir ? 'Bullish' : 'Bearish';
        const avgForDir = lastDir ? parseFloat(avgBullish) : parseFloat(avgBearish);
        const pctOfAvg = avgForDir ? ((currentRun / avgForDir) * 100).toFixed(0) : 'N/A';

        let risk = 'LOW', riskClass = 'success';
        if (pctOfAvg !== 'N/A') {
            const pct = parseInt(pctOfAvg);
            if (pct > 150) { risk = 'HIGH'; riskClass = 'danger'; }
            else if (pct > 100) { risk = 'MEDIUM'; riskClass = 'warning'; }
        }

        const isCurrentSymbol = symbol === currentSymbol;
        html += `<tr ${isCurrentSymbol ? 'style="background:rgba(59,130,246,0.1);font-weight:600;"' : ''}>
            <td>${isCurrentSymbol ? ' ' : ''}${symbol}</td>
            <td>${avgBullish} bars</td>
            <td>${avgBearish} bars</td>
            <td>${currentRun} (${currentDir})</td>
            <td>${pctOfAvg}%</td>
            <td><span class="badge badge-${riskClass}">${risk}</span></td>
        </tr>`;
    }

    if (html === '') {
        html = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:20px;">No symbol data available. Check console for details.</td></tr>';
    }
    console.log(' Reversal stats: processed', symbolsProcessed, 'symbols, html length:', html.length);
    table.innerHTML = html;
}

function updatePriceChart() {
    const data = currentData.slice(-60);
    const ctx = document.getElementById('priceChart');
    if (!ctx) return;
    
    if (priceChart) priceChart.destroy();
    
    const fib = window.fibLevels || {};
    const colors = data.map(d => parseFloat(d.Close) >= parseFloat(d.Open) ? '#10b981' : '#ef4444');
    
    priceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => (d.Date || '').split('T')[0].split(' ')[0].slice(5)),
            datasets: [{ label: 'Price', data: data.map(d => parseFloat(d.Close) || 0), backgroundColor: colors, borderColor: colors }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false },
                annotation: { annotations: {
                    r1: { type: 'line', yMin: fib.fib100, yMax: fib.fib100, borderColor: '#ef4444', borderWidth: 1, borderDash: [5,5] },
                    s1: { type: 'line', yMin: fib.fib382, yMax: fib.fib382, borderColor: '#10b981', borderWidth: 1, borderDash: [5,5] },
                    s2: { type: 'line', yMin: fib.fib500, yMax: fib.fib500, borderColor: '#14b8a6', borderWidth: 1, borderDash: [5,5] }
                }}
            },
            scales: { y: { ticks: { callback: v => '$' + v } } }
        }
    });
}

// ============================================
// AI ASSISTANT - IMPROVED
// ============================================

function askAi(question) {
    document.getElementById('aiInput').value = question;
    sendAiMessage();
}

async function sendAiMessage() {
    const input = document.getElementById('aiInput');
    const message = input.value.trim();
    if (!message) return;
    
    const messagesDiv = document.getElementById('aiChatMessages');
    
    messagesDiv.innerHTML += `<div class="ai-message user">${escapeHtml(message)}</div>`;
    input.value = '';
    
    messagesDiv.innerHTML += `<div class="ai-message assistant" id="typingIndicator"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    document.getElementById('aiSendBtn').disabled = true;
    
    // Add to conversation history
    conversationHistory.push({ role: 'user', content: message });
    
    try {
        const response = await generateAiResponse(message);
        document.getElementById('typingIndicator')?.remove();
        messagesDiv.innerHTML += `<div class="ai-message assistant"><div class="message-content">${response}</div></div>`;
        conversationHistory.push({ role: 'assistant', content: response });
    } catch (e) {
        document.getElementById('typingIndicator')?.remove();
        messagesDiv.innerHTML += `<div class="ai-message assistant"><div class="message-content">Sorry, I encountered an error. Please try again.</div></div>`;
    }
    
    document.getElementById('aiSendBtn').disabled = false;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Ollama Configuration
// Groq Cloud Configuration (FREE & Fast!)
const OLLAMA_CONFIG = {
    enabled: true,
    endpoint: 'https://api.groq.com/openai/v1',
    model: 'llama-3.1-70b-versatile',
    apiKey: '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'
};

// Check Ollama connection status
async function checkOllamaConnection() {
    // Skip check if running on GitHub Pages (CORS will block it)
    if (window.location.hostname.includes('github.io')) {
        updateOllamaStatus(false, 'Local only');
        return false;
    }

    try {
        const response = await fetch(`${OLLAMA_CONFIG.endpoint}/api/tags`, {
            method: 'GET',
            signal: AbortSignal.timeout(3000)
        });
        if (response.ok) {
            const data = await response.json();
            const models = data.models || [];
            const hasModel = models.some(m => m.name.includes('gemma'));
            updateOllamaStatus(true, hasModel ? OLLAMA_CONFIG.model : 'Connected');
            return true;
        }
    } catch (e) {
        // Silently handle CORS/connection errors
    }
    updateOllamaStatus(false);
    return false;
}

// Update Ollama status indicator in UI
function updateOllamaStatus(connected, model = null) {
    const statusEl = document.getElementById('ollamaStatus');
    const modelEl = document.getElementById('ollamaModel');
    if (statusEl) {
        statusEl.innerHTML = connected
            ? '<span style="color: var(--success);"> Connected</span>'
            : '<span style="color: var(--danger);"> Offline</span>';
    }
    if (modelEl && model) {
        modelEl.textContent = model;
    }
}

async function generateAiResponse(userMessage) {
    const lowerMsg = userMessage.toLowerCase();

    // Build context
    const dashboardContext = buildDashboardContext();
    const systemPrompt = buildSystemPrompt(dashboardContext);

    // Try Ollama first (local LLM) - skip if on GitHub Pages
    if (OLLAMA_CONFIG.enabled) {
        try {
            console.log(' Calling Ollama with model:', OLLAMA_CONFIG.model);

            const response = await fetch(`${OLLAMA_CONFIG.endpoint}/chat/completions`, {
    method: 'POST',
    headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${OLLAMA_CONFIG.apiKey}`
    },
    body: JSON.stringify({
        model: OLLAMA_CONFIG.model,
        messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: userMessage }
        ],
        temperature: 0.7,
        max_tokens: 1000
    }),

            if (response.ok) {
                const data = await response.json();
                console.log(' Ollama response received');
                updateOllamaStatus(true, OLLAMA_CONFIG.model);
                return data.response || 'No response generated';
            } else {
                console.log(' Ollama error:', response.status);
            }
        } catch (e) {
            // Silently handle CORS/connection errors
            updateOllamaStatus(false);
        }
    }

    // Fallback to local responses if Ollama fails
    console.log(' Using local fallback responses');
    return generateLocalResponse(userMessage, dashboardContext);
}

function buildSystemPrompt(context) {
    return `You are the Gann Trading Assistant for Q5D Options Platform.

KNOWLEDGE BASE:
${GANN_KNOWLEDGE.tunnelThroughAir}
${GANN_KNOWLEDGE.mystifyingSquare}
${GANN_KNOWLEDGE.divineProportions}
${GANN_KNOWLEDGE.timeCycles}
${GANN_KNOWLEDGE.platformPrinciples}

CURRENT DATA:
${context}

RULES:
1. Give specific, actionable trading guidance
2. Use actual dashboard data - never hallucinate
3. Reference Gann principles when relevant
4. Format responses clearly with tables when helpful
5. Be concise but thorough`;
}

function buildDashboardContext() {
    let context = `CURRENT: ${currentSymbol} | Mode: ${tradingMode.toUpperCase()}\n\n`;
    
    if (currentData.length) {
        const lat = currentData[currentData.length - 1];
        const price = parseFloat(lat.Close);
        const atr = parseFloat(lat.ATR) || 5;
        context += `${currentSymbol}: $${price.toFixed(2)} | Signal: ${lat.Bias || 'HOLD'} | Consensus: ${lat.PriceConfluence || 0}/4 | ATR: $${atr.toFixed(2)}\n\n`;
        
        // Square of 9 levels
        const sqrtPrice = Math.sqrt(price);
        context += `Square of 9 for ${currentSymbol}:\n`;
        context += ` +90 (${(sqrtPrice + 0.25)}) = $${Math.pow(sqrtPrice + 0.25, 2).toFixed(2)}\n`;
        context += ` +180 = $${Math.pow(sqrtPrice + 0.5, 2).toFixed(2)}\n`;
        context += ` -90 = $${Math.pow(sqrtPrice - 0.25, 2).toFixed(2)}\n`;
        context += ` -180 = $${Math.pow(sqrtPrice - 0.5, 2).toFixed(2)}\n\n`;
    }
    
    context += `ALL SYMBOLS:\n`;
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            context += `${symbol}: $${parseFloat(lat.Close).toFixed(2)} | ${lat.Bias || 'HOLD'} | ${lat.PriceConfluence || 0}/4\n`;
        }
    }
    
    return context;
}

function generateLocalResponse(message, context) {
    const lowerMsg = message.toLowerCase();
    
    // MORNING BREAKOUT PATTERN
    if (lowerMsg.includes('breakout') || lowerMsg.includes('breaking out') || lowerMsg.includes('breaking above')) {
        return generateBreakoutResponse();
    }
    
    // PATTERN SCAN - General
    if (lowerMsg.includes('pattern') || lowerMsg.includes('setup') || lowerMsg.includes('forming')) {
        return generatePatternScanResponse();
    }
    
    // MOMENTUM / TRENDING
    if (lowerMsg.includes('momentum') || lowerMsg.includes('trending') || lowerMsg.includes('strongest') || lowerMsg.includes('weakest')) {
        return generateMomentumResponse();
    }
    
    // REVERSAL PATTERNS
    if (lowerMsg.includes('reversal') || lowerMsg.includes('turning') || lowerMsg.includes('bottom') || lowerMsg.includes('top')) {
        return generateReversalResponse();
    }
    
    // BAR COUNT / CONSECUTIVE BARS
    if (lowerMsg.includes('bar') && (lowerMsg.includes('count') || lowerMsg.includes('consecutive') || lowerMsg.includes('yesterday') || lowerMsg.includes('closing'))) {
        return generateBarCountResponse();
    }
    
    // OPTIMAL TIME TO TRADE
    if ((lowerMsg.includes('optimal') || lowerMsg.includes('best')) && (lowerMsg.includes('time') || lowerMsg.includes('when'))) {
        return generateOptimalTimeResponse();
    }
    
    // WHEN TO TRADE / TRADING HOURS
    if (lowerMsg.includes('when') && (lowerMsg.includes('trade') || lowerMsg.includes('buy') || lowerMsg.includes('sell'))) {
        return generateOptimalTimeResponse();
    }
    
    // HIGH CONSENSUS TRADES
    if (lowerMsg.includes('consensus') || lowerMsg.includes('3/4') || lowerMsg.includes('4/4') || lowerMsg.includes('high consensus')) {
        let trades = [];
        for (const symbol of SYMBOLS) {
            const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
            if (data && data.length) {
                const lat = data[data.length - 1];
                const consensus = parseInt(lat.PriceConfluence) || 0;
                if (consensus >= 3) {
                    const price = parseFloat(lat.Close);
                    const atr = parseFloat(lat.ATR) || 5;
                    trades.push({ symbol, signal: lat.Bias || 'HOLD', consensus, price: price.toFixed(2), strike: Math.round(price), target: (price + atr * 2).toFixed(2) });
                }
            }
        }
        
        if (trades.length === 0) {
            return ` No ETFs currently have 3/4 or 4/4 consensus.

This could mean:
 Markets are consolidating
 Agents are conflicting
 Wait for clearer signals

 TIP: Check individual symbols for developing setups, or review the Bar Count tab for trend direction.`;
        }
        
        let response = ` **HIGH CONSENSUS TRADES TODAY:**\n\n`;
        trades.sort((a, b) => b.consensus - a.consensus);
        trades.forEach(t => {
            const emoji = t.consensus === 4 ? '' : '';
            response += `${emoji} **${t.symbol}** - ${t.signal} (${t.consensus}/4)\n`;
            response += `   Price: $${t.price} | Strike: $${t.strike} | Target: $${t.target}\n\n`;
        });
        
        const ultra = trades.filter(t => t.consensus === 4);
        if (ultra.length) {
            response += ` **TOP PICK:** ${ultra[0].symbol} has ULTRA signal (4/4 consensus)`;
        }
        
        return response;
    }
    
    // BEST CALLS
    if (lowerMsg.includes('call') && (lowerMsg.includes('best') || lowerMsg.includes('2 day'))) {
        return generateOptionRecommendations('CALL');
    }
    
    // BEST PUTS
    if (lowerMsg.includes('put') && (lowerMsg.includes('best') || lowerMsg.includes('2 day'))) {
        return generateOptionRecommendations('PUT');
    }
    
    // SQUARE OF 9 / MYSTIFYING SQUARE
    if (lowerMsg.includes('square of 9') || lowerMsg.includes('mystifying')) {
        const price = currentData.length ? parseFloat(currentData[currentData.length - 1].Close) : 675;
        const sqrtPrice = Math.sqrt(price);
        
        return ` **MYSTIFYING SQUARE (SQUARE OF 9) FOR ${currentSymbol}**

Current Price: $${price.toFixed(2)}
Square Root: ${sqrtPrice.toFixed(4)}

**RESISTANCE LEVELS (Price Targets):**
 +45 = $${Math.pow(sqrtPrice + 0.125, 2).toFixed(2)} (minor)
 +90 = $${Math.pow(sqrtPrice + 0.25, 2).toFixed(2)} (important)
 +180 = $${Math.pow(sqrtPrice + 0.5, 2).toFixed(2)} (major)
 +360 = $${Math.pow(sqrtPrice + 1.0, 2).toFixed(2)} (full cycle)

**SUPPORT LEVELS (Stop Areas):**
 -45 = $${Math.pow(sqrtPrice - 0.125, 2).toFixed(2)} (minor)
 -90 = $${Math.pow(sqrtPrice - 0.25, 2).toFixed(2)} (important)
 -180 = $${Math.pow(sqrtPrice - 0.5, 2).toFixed(2)} (major)

 **HOW TO USE:**
- Buy at support levels
- Take profits at resistance
- 90 moves are most common
- 180 = major reversal zones`;
    }
    
    // DIVINE PROPORTIONS / FIBONACCI
    if (lowerMsg.includes('divine') || lowerMsg.includes('proportion') || lowerMsg.includes('phi') || lowerMsg.includes('golden')) {
        const fib = window.fibLevels || {};
        return ` **DIVINE PROPORTIONS (PHI/FIBONACCI)**

The Golden Ratio ( = 1.618) governs natural growth patterns and markets follow these proportions.

**${currentSymbol} FIBONACCI LEVELS:**

 Resistance (Targets):
 R1 (100%) = $${fib.fib100?.toFixed(2) || '--'} (Swing High)
 R2 (127.2%) = $${fib.fib1272?.toFixed(2) || '--'} ( extension)
 R3 (161.8%) = $${fib.fib1618?.toFixed(2) || '--'} ( extension)

 Support (Stops):
 S1 (38.2%) = $${fib.fib382?.toFixed(2) || '--'} (First support)
 S2 (50.0%) = $${fib.fib500?.toFixed(2) || '--'} (Key level)
 S3 (61.8%) = $${fib.fib618?.toFixed(2) || '--'} (Golden ratio)

**TRADING RULES:**
 Enter CALL at 61.8% retracement
 Target 161.8% extension
 Stop below 78.6% level

**PHI RELATIONSHIPS:**
 1.618  1.618 = 2.618
 1/1.618 = 0.618
 1.618 = 1.272`;
    }
    
    // TIME CYCLES
    if (lowerMsg.includes('time cycle') || lowerMsg.includes('gann cycle') || lowerMsg.includes('when')) {
        return ` **GANN TIME CYCLES**

"When time is up, the trend changes" - W.D. Gann

**KEY CYCLE LENGTHS:**
 30 days - Minor cycle
 45 days - Important (1/8 year)
 60 days - Significant
 90 days - Major (quarter)
 120 days - 1/3 year
 144 days - Fibonacci/sacred
 180 days - Half year
 360 days - Full annual cycle

**SEASONAL TURN DATES:**
 Mar 21 - Spring Equinox
 Jun 21 - Summer Solstice
 Sep 21 - Fall Equinox
 Dec 21 - Winter Solstice

**HOW TO APPLY:**
1. Mark the last major high or low date
2. Add Gann numbers (30, 45, 60, 90...)
3. Watch for reversals on those dates
4. Combine with price levels for confirmation`;
    }
    
    // OPTIMAL STRIKE
    if (lowerMsg.includes('strike') || lowerMsg.includes('optimal')) {
        if (currentData.length) {
            const lat = currentData[currentData.length - 1];
            const price = parseFloat(lat.Close);
            const atr = parseFloat(lat.ATR) || 5;
            const signal = lat.Bias || 'CALL';
            const sqrtPrice = Math.sqrt(price);
            
            return ` **OPTIMAL STRIKE FOR ${currentSymbol}**

Current Price: $${price.toFixed(2)}
Signal: ${signal}
ATR: $${atr.toFixed(2)}

**INTRADAY (0DTE):**
 ATM Strike: $${Math.round(price)} (Delta ~0.50)
 Target: $${(signal === 'PUT' ? price - atr : price + atr).toFixed(2)}
 Stop: $${(signal === 'PUT' ? price + atr * 0.5 : price - atr * 0.5).toFixed(2)}

**SWING (3-5 DTE):**
 Strike: $${Math.round(price/5)*5} (slightly OTM)
 Target: $${(signal === 'PUT' ? price - atr * 2.5 : price + atr * 2.5).toFixed(2)}
 Stop: $${(signal === 'PUT' ? price + atr * 1.5 : price - atr * 1.5).toFixed(2)}

**SQUARE OF 9 TARGETS:**
 90 target: $${Math.pow(sqrtPrice + (signal === 'PUT' ? -0.25 : 0.25), 2).toFixed(2)}
 180 target: $${Math.pow(sqrtPrice + (signal === 'PUT' ? -0.5 : 0.5), 2).toFixed(2)}`;
        }
        return "Please select a symbol to calculate optimal strike.";
    }
    
    // SECTOR COMPARISON
    if (lowerMsg.includes('sector') || lowerMsg.includes('compare') || lowerMsg.includes('strongest')) {
        let sectors = [];
        for (const symbol of ['XLK', 'XLF', 'XLV', 'XLE']) {
            const data = allSymbolsData[symbol];
            if (data && data.length > 20) {
                const lat = data[data.length - 1];
                const prev20 = data[data.length - 21];
                const perf = ((parseFloat(lat.Close) - parseFloat(prev20.Close)) / parseFloat(prev20.Close) * 100);
                sectors.push({ symbol, name: SYMBOL_NAMES[symbol], perf: perf.toFixed(2), signal: lat.Bias || 'HOLD', consensus: lat.PriceConfluence || 0 });
            }
        }
        
        sectors.sort((a, b) => parseFloat(b.perf) - parseFloat(a.perf));
        
        let response = ` **SECTOR COMPARISON (20-Day Performance)**\n\n`;
        sectors.forEach((s, i) => {
            const emoji = i === 0 ? '' : (i === 1 ? '' : (i === 2 ? '' : ''));
            const perfColor = parseFloat(s.perf) >= 0 ? '+' : '';
            response += `${emoji} **${s.name}** (${s.symbol})\n`;
            response += `   ${perfColor}${s.perf}% | ${s.signal} | ${s.consensus}/4 consensus\n\n`;
        });
        
        response += `\n **RECOMMENDATION:**\n`;
        response += ` Strongest: ${sectors[0].symbol} - consider for CALL trades\n`;
        response += ` Weakest: ${sectors[sectors.length-1].symbol} - consider for PUT trades`;
        
        return response;
    }
    
    // TUNNEL THROUGH THE AIR
    if (lowerMsg.includes('tunnel') || lowerMsg.includes('through the air')) {
        return GANN_KNOWLEDGE.tunnelThroughAir;
    }
    
    // PLATFORM / PRINCIPLES
    if (lowerMsg.includes('platform') || lowerMsg.includes('principle') || lowerMsg.includes('how does') || lowerMsg.includes('q5d')) {
        return GANN_KNOWLEDGE.platformPrinciples;
    }
    
    // CURRENT PRICE / STATUS
    if ((lowerMsg.includes('price') || lowerMsg.includes('status') || lowerMsg.includes('current')) && !lowerMsg.includes('strike')) {
        return generateCurrentStatusResponse();
    }
    
    // WHAT SHOULD I TRADE / RECOMMENDATION
    if (lowerMsg.includes('should i') || lowerMsg.includes('recommend') || lowerMsg.includes('what to trade') || lowerMsg.includes('trade today')) {
        return generateTradeRecommendation();
    }
    
    // RISK / STOP LOSS
    if (lowerMsg.includes('risk') || lowerMsg.includes('stop loss') || lowerMsg.includes('position size')) {
        return generateRiskManagementResponse();
    }
    
    // NEWS / MARKET UPDATE
    if (lowerMsg.includes('news') || lowerMsg.includes('market') || lowerMsg.includes('update')) {
        return generateMarketUpdateResponse();
    }
    
    // HELP / WHAT CAN YOU DO
    if (lowerMsg.includes('help') || lowerMsg.includes('what can you') || lowerMsg.includes('how to use')) {
        return generateHelpResponse();
    }
    
    // DEFAULT RESPONSE - More intelligent
    return await generateSmartDefaultResponse(message, context);
}

function generateOptionRecommendations(direction) {
    let recommendations = [];
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            const signal = (lat.Bias || '').toUpperCase();
            if (signal === direction) {
                const price = parseFloat(lat.Close);
                const atr = parseFloat(lat.ATR) || 5;
                recommendations.push({
                    symbol,
                    price: price.toFixed(2),
                    strike: Math.round(price),
                    target: (direction === 'CALL' ? price + atr * 2 : price - atr * 2).toFixed(2),
                    stop: (direction === 'CALL' ? price - atr : price + atr).toFixed(2),
                    consensus: parseInt(lat.PriceConfluence) || 0,
                    rr: ((atr * 2) / atr).toFixed(1)
                });
            }
        }
    }
    
    recommendations.sort((a, b) => b.consensus - a.consensus);
    
    if (recommendations.length === 0) {
        return ` No strong ${direction} signals found across ETFs.

The agents are not aligned for ${direction} trades currently. Consider:
 Waiting for better setups
 Checking individual symbols
 Looking at the opposite direction`;
    }
    
    let response = ` **BEST ${direction} OPTIONS (Next 2 Days)**\n\n`;
    
    recommendations.slice(0, 5).forEach((r, i) => {
        const emoji = r.consensus >= 3 ? '' : '';
        response += `${emoji} **#${i+1} ${r.symbol}** (${r.consensus}/4 consensus)\n`;
        response += `   Strike: $${r.strike} ${direction}\n`;
        response += `   Entry: $${r.price} | Target: $${r.target} | Stop: $${r.stop}\n`;
        response += `   Risk/Reward: 1:${r.rr}\n\n`;
    });
    
    if (recommendations.length > 0) {
        const best = recommendations[0];
        response += `\n **TOP PICK:** ${best.symbol} $${best.strike} ${direction}\n`;
        response += ` ${best.consensus}/4 agent consensus\n`;
        response += ` Target: $${best.target} (${best.rr}:1 R/R)`;
    }
    
    return response;
}

// NEW: Generate Bar Count Response with actual data
function generateBarCountResponse() {
    let response = ` **BAR COUNT ANALYSIS (as of last close)**\n\n`;
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 20) continue;
        
        // Calculate consecutive bars
        let bullCount = 0, bearCount = 0, currentStreak = 0, lastDir = null;
        
        for (let i = Math.max(0, data.length - 50); i < data.length; i++) {
            const d = data[i];
            const isBullish = parseFloat(d.Close) >= parseFloat(d.Open);
            
            if (lastDir === null) {
                lastDir = isBullish;
                currentStreak = 1;
            } else if (isBullish === lastDir) {
                currentStreak++;
            } else {
                lastDir = isBullish;
                currentStreak = 1;
            }
            
            if (isBullish) bullCount++;
            else bearCount++;
        }
        
        const lat = data[data.length - 1];
        const price = parseFloat(lat.Close).toFixed(2);
        const signal = lat.Bias || 'HOLD';
        const streakDir = lastDir ? ' Bullish' : ' Bearish';
        const streakEmoji = currentStreak >= 5 ? '' : (currentStreak >= 3 ? '' : '');
        
        response += `**${symbol}** - $${price} | ${signal}\n`;
        response += `   Current Streak: ${currentStreak} bars ${streakDir} ${streakEmoji}\n`;
        response += `   Last 50 bars: ${bullCount} bullish / ${bearCount} bearish\n\n`;
    }
    
    // Add interpretation
    response += `\n **INTERPRETATION:**\n`;
    response += ` 5+ consecutive bars = Strong trend, consider continuation\n`;
    response += ` 7+ consecutive bars = Possible exhaustion, watch for reversal\n`;
    response += ` Mixed (1-2 bars) = Choppy market, wait for direction`;
    
    return response;
}

// NEW: Morning Breakout Pattern Detection
function generateBreakoutResponse() {
    let breakouts = [];
    let potentialBreakouts = [];
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 20) continue;
        
        const lat = data[data.length - 1];
        const prev = data[data.length - 2];
        const prev5 = data.slice(-6, -1);
        
        const price = parseFloat(lat.Close);
        const open = parseFloat(lat.Open);
        const high = parseFloat(lat.High);
        const low = parseFloat(lat.Low);
        const prevHigh = parseFloat(prev.High);
        const prevClose = parseFloat(prev.Close);
        const atr = parseFloat(lat.ATR) || 5;
        const volume = parseFloat(lat.Volume) || 0;
        
        // Calculate average volume
        const avgVol = data.slice(-20).reduce((sum, d) => sum + (parseFloat(d.Volume) || 0), 0) / 20;
        const volRatio = volume / avgVol;
        
        // Calculate 5-day high
        const fiveDayHigh = Math.max(...prev5.map(d => parseFloat(d.High) || 0));
        
        // Breakout criteria
        const aboveOpen = price > open;
        const nearHigh = (high - price) < (atr * 0.25); // Within 25% of ATR from high
        const abovePrevHigh = price > prevHigh;
        const above5DayHigh = price > fiveDayHigh;
        const highVolume = volRatio > 1.2;
        const strongMove = ((price - open) / open) * 100 > 0.5; // >0.5% move
        
        const breakoutScore = (aboveOpen ? 1 : 0) + (nearHigh ? 1 : 0) + (abovePrevHigh ? 1 : 0) + 
                             (above5DayHigh ? 2 : 0) + (highVolume ? 1 : 0) + (strongMove ? 1 : 0);
        
        const breakoutData = {
            symbol,
            price: price.toFixed(2),
            change: ((price - prevClose) / prevClose * 100).toFixed(2),
            volRatio: (volRatio * 100).toFixed(0),
            score: breakoutScore,
            above5Day: above5DayHigh,
            signal: lat.Bias || 'HOLD',
            consensus: lat.PriceConfluence || 0,
            target: (price + atr * 1.5).toFixed(2),
            stop: (price - atr * 0.75).toFixed(2)
        };
        
        if (breakoutScore >= 5 && above5DayHigh) {
            breakouts.push(breakoutData);
        } else if (breakoutScore >= 3) {
            potentialBreakouts.push(breakoutData);
        }
    }
    
    let response = ` **MORNING BREAKOUT SCAN**\n\n`;
    
    if (breakouts.length > 0) {
        response += `** CONFIRMED BREAKOUTS:**\n`;
        breakouts.sort((a, b) => b.score - a.score);
        breakouts.forEach(b => {
            response += `\n**${b.symbol}** - BREAKOUT! \n`;
            response += `   Price: $${b.price} (+${b.change}%)\n`;
            response += `   Volume: ${b.volRatio}% of avg ${parseFloat(b.volRatio) > 150 ? '' : ''}\n`;
            response += `   Breaking 5-day high: ${b.above5Day ? ' YES' : ' No'}\n`;
            response += `   Agent Signal: ${b.signal} (${b.consensus}/4)\n`;
            response += `   Target: $${b.target} | Stop: $${b.stop}\n`;
        });
    } else {
        response += `**No confirmed breakouts at this time.**\n`;
    }
    
    if (potentialBreakouts.length > 0) {
        response += `\n** POTENTIAL BREAKOUTS (Watch List):**\n`;
        potentialBreakouts.sort((a, b) => b.score - a.score).slice(0, 4).forEach(b => {
            response += ` ${b.symbol}: $${b.price} (+${b.change}%) - ${b.signal}\n`;
        });
    }
    
    response += `\n** BREAKOUT CRITERIA:**\n`;
    response += ` Price above open \n`;
    response += ` Near session high \n`;
    response += ` Above 5-day high \n`;
    response += ` Volume > 120% avg \n`;
    response += ` Move > 0.5% \n`;
    
    response += `\n** BEST TIME:** Trade breakouts 9:45-10:30 AM ET`;
    
    return response;
}

// NEW: Pattern Scan Response
function generatePatternScanResponse() {
    let patterns = {
        breakout: [],
        pullback: [],
        reversal: [],
        consolidation: []
    };
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 20) continue;
        
        const lat = data[data.length - 1];
        const recent = data.slice(-10);
        
        const price = parseFloat(lat.Close);
        const open = parseFloat(lat.Open);
        const high = parseFloat(lat.High);
        const low = parseFloat(lat.Low);
        const atr = parseFloat(lat.ATR) || 5;
        const signal = lat.Bias || 'HOLD';
        
        // Get recent highs/lows
        const recentHighs = recent.map(d => parseFloat(d.High) || 0);
        const recentLows = recent.map(d => parseFloat(d.Low) || 0);
        const highestHigh = Math.max(...recentHighs);
        const lowestLow = Math.min(...recentLows);
        const range = highestHigh - lowestLow;
        
        // Pattern detection
        const nearHigh = price > highestHigh - (range * 0.1);
        const nearLow = price < lowestLow + (range * 0.1);
        const inMiddle = !nearHigh && !nearLow;
        const tightRange = range < atr * 2;
        const bullishCandle = price > open;
        
        const symbolData = { symbol, price: price.toFixed(2), signal, consensus: lat.PriceConfluence || 0 };
        
        if (nearHigh && bullishCandle && signal === 'CALL') {
            patterns.breakout.push({...symbolData, type: 'Bullish Breakout'});
        } else if (nearLow && !bullishCandle && signal === 'PUT') {
            patterns.breakout.push({...symbolData, type: 'Bearish Breakdown'});
        } else if (inMiddle && signal === 'CALL') {
            patterns.pullback.push({...symbolData, type: 'Bullish Pullback'});
        } else if (inMiddle && signal === 'PUT') {
            patterns.pullback.push({...symbolData, type: 'Bearish Rally'});
        } else if (tightRange) {
            patterns.consolidation.push({...symbolData, type: 'Tight Range'});
        }
    }
    
    let response = ` **PATTERN SCAN RESULTS**\n\n`;
    
    if (patterns.breakout.length) {
        response += `** BREAKOUT PATTERNS:**\n`;
        patterns.breakout.forEach(p => {
            response += ` ${p.symbol}: ${p.type} @ $${p.price} (${p.consensus}/4)\n`;
        });
        response += `\n`;
    }
    
    if (patterns.pullback.length) {
        response += `** PULLBACK/RETRACEMENT:**\n`;
        patterns.pullback.forEach(p => {
            response += ` ${p.symbol}: ${p.type} @ $${p.price} (${p.consensus}/4)\n`;
        });
        response += `\n`;
    }
    
    if (patterns.consolidation.length) {
        response += `** CONSOLIDATION (Watch for breakout):**\n`;
        patterns.consolidation.forEach(p => {
            response += ` ${p.symbol}: ${p.type} @ $${p.price}\n`;
        });
        response += `\n`;
    }
    
    if (patterns.breakout.length === 0 && patterns.pullback.length === 0) {
        response += `No clear patterns detected. Market may be choppy.\n\n`;
    }
    
    response += ` **TIP:** Breakouts need volume confirmation. Pullbacks offer better risk/reward.`;
    
    return response;
}

// NEW: Momentum Response
function generateMomentumResponse() {
    let momentum = [];
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 20) continue;
        
        const lat = data[data.length - 1];
        const prev5 = data[data.length - 6];
        const prev20 = data[data.length - 21];
        
        const price = parseFloat(lat.Close);
        const price5 = parseFloat(prev5?.Close) || price;
        const price20 = parseFloat(prev20?.Close) || price;
        
        const chg5 = ((price - price5) / price5 * 100);
        const chg20 = ((price - price20) / price20 * 100);
        
        // Count consecutive bars
        let streak = 0;
        for (let i = data.length - 1; i >= Math.max(0, data.length - 10); i--) {
            const d = data[i];
            const bullish = parseFloat(d.Close) >= parseFloat(d.Open);
            if (i === data.length - 1) {
                streak = bullish ? 1 : -1;
            } else if ((bullish && streak > 0) || (!bullish && streak < 0)) {
                streak += bullish ? 1 : -1;
            } else {
                break;
            }
        }
        
        momentum.push({
            symbol,
            price: price.toFixed(2),
            chg5: chg5.toFixed(2),
            chg20: chg20.toFixed(2),
            streak,
            signal: lat.Bias || 'HOLD',
            consensus: lat.PriceConfluence || 0,
            score: chg5 + (streak * 0.5)
        });
    }
    
    // Sort by momentum score
    momentum.sort((a, b) => b.score - a.score);
    
    let response = ` **MOMENTUM RANKINGS**\n\n`;
    
    response += `** STRONGEST (Bullish Momentum):**\n`;
    momentum.slice(0, 3).forEach((m, i) => {
        const emoji = i === 0 ? '' : (i === 1 ? '' : '');
        response += `${emoji} **${m.symbol}** - $${m.price}\n`;
        response += `   5-Day: ${parseFloat(m.chg5) >= 0 ? '+' : ''}${m.chg5}% | 20-Day: ${parseFloat(m.chg20) >= 0 ? '+' : ''}${m.chg20}%\n`;
        response += `   Streak: ${m.streak > 0 ? '+' : ''}${m.streak} bars | Signal: ${m.signal} (${m.consensus}/4)\n\n`;
    });
    
    response += `** WEAKEST (Bearish Momentum):**\n`;
    momentum.slice(-3).reverse().forEach((m, i) => {
        response += `${i + 1}. **${m.symbol}** - $${m.price}\n`;
        response += `   5-Day: ${parseFloat(m.chg5) >= 0 ? '+' : ''}${m.chg5}% | Streak: ${m.streak > 0 ? '+' : ''}${m.streak} bars\n\n`;
    });
    
    response += ` **TRADING TIP:**\n`;
    response += ` Strong momentum + 3/4 consensus = High probability CALL\n`;
    response += ` Weak momentum + PUT signal = Consider PUT trades`;
    
    return response;
}

// NEW: Reversal Pattern Response
function generateReversalResponse() {
    let reversals = [];
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 20) continue;
        
        const lat = data[data.length - 1];
        const prev = data[data.length - 2];
        const prev2 = data[data.length - 3];
        
        const price = parseFloat(lat.Close);
        const open = parseFloat(lat.Open);
        const high = parseFloat(lat.High);
        const low = parseFloat(lat.Low);
        const prevClose = parseFloat(prev.Close);
        const prevOpen = parseFloat(prev.Open);
        const atr = parseFloat(lat.ATR) || 5;
        
        // Calculate bar counts
        let bearStreak = 0, bullStreak = 0;
        for (let i = data.length - 2; i >= Math.max(0, data.length - 10); i--) {
            const d = data[i];
            if (parseFloat(d.Close) < parseFloat(d.Open)) bearStreak++;
            else break;
        }
        for (let i = data.length - 2; i >= Math.max(0, data.length - 10); i--) {
            const d = data[i];
            if (parseFloat(d.Close) >= parseFloat(d.Open)) bullStreak++;
            else break;
        }
        
        // Reversal patterns
        const bullishEngulfing = prevClose < prevOpen && price > open && price > prevOpen && open < prevClose;
        const bearishEngulfing = prevClose > prevOpen && price < open && price < prevOpen && open > prevClose;
        const hammer = (open - low) > (high - open) * 2 && price > open && bearStreak >= 3;
        const shootingStar = (high - open) > (open - low) * 2 && price < open && bullStreak >= 3;
        
        let pattern = null;
        let direction = null;
        
        if (bullishEngulfing || hammer) {
            pattern = bullishEngulfing ? 'Bullish Engulfing' : 'Hammer';
            direction = 'BULLISH';
        } else if (bearishEngulfing || shootingStar) {
            pattern = bearishEngulfing ? 'Bearish Engulfing' : 'Shooting Star';
            direction = 'BEARISH';
        } else if (bearStreak >= 5 && price > open) {
            pattern = 'Potential Bullish Reversal';
            direction = 'BULLISH';
        } else if (bullStreak >= 5 && price < open) {
            pattern = 'Potential Bearish Reversal';
            direction = 'BEARISH';
        }
        
        if (pattern) {
            reversals.push({
                symbol,
                pattern,
                direction,
                price: price.toFixed(2),
                priorStreak: direction === 'BULLISH' ? bearStreak : bullStreak,
                signal: lat.Bias || 'HOLD',
                consensus: lat.PriceConfluence || 0
            });
        }
    }
    
    let response = ` **REVERSAL PATTERN SCAN**\n\n`;
    
    if (reversals.length === 0) {
        response += `No clear reversal patterns detected.\n\n`;
        response += `**What to look for:**\n`;
        response += ` 5+ bar downtrend + bullish candle = Potential bottom\n`;
        response += ` 5+ bar uptrend + bearish candle = Potential top\n`;
        response += ` Engulfing patterns at key Fibonacci levels\n`;
    } else {
        const bullish = reversals.filter(r => r.direction === 'BULLISH');
        const bearish = reversals.filter(r => r.direction === 'BEARISH');
        
        if (bullish.length) {
            response += `** BULLISH REVERSALS (Potential Bottoms):**\n`;
            bullish.forEach(r => {
                response += ` **${r.symbol}**: ${r.pattern} @ $${r.price}\n`;
                response += `  Prior downtrend: ${r.priorStreak} bars | Signal: ${r.signal}\n\n`;
            });
        }
        
        if (bearish.length) {
            response += `** BEARISH REVERSALS (Potential Tops):**\n`;
            bearish.forEach(r => {
                response += ` **${r.symbol}**: ${r.pattern} @ $${r.price}\n`;
                response += `  Prior uptrend: ${r.priorStreak} bars | Signal: ${r.signal}\n\n`;
            });
        }
    }
    
    response += ` **CAUTION:** Reversals need confirmation. Wait for follow-through!`;
    
    return response;
}

// NEW: Generate Optimal Trading Time Response
function generateOptimalTimeResponse() {
    const lat = currentData.length ? currentData[currentData.length - 1] : null;
    const price = lat ? parseFloat(lat.Close).toFixed(2) : '--';
    const signal = lat ? (lat.Bias || 'HOLD') : '--';
    
    return ` **OPTIMAL TIMES TO TRADE ${currentSymbol} OPTIONS**

**INTRADAY (0DTE) BEST WINDOWS:**

 **9:30-10:00 AM ET - Opening Range**
 Highest volatility & liquidity
 Wait for first 5-15 min to establish range
 Best for momentum plays
  Avoid trading first 5 minutes (too erratic)

 **10:00-11:30 AM ET - Morning Trend**
 Trend typically established
 Best time for directional trades
 Options premiums still reasonable
  RECOMMENDED for 0DTE entries

 **11:30 AM-2:00 PM ET - Midday Lull**
 Lower volatility, choppy action
  Avoid new positions
 Good for managing existing trades

 **2:00-3:00 PM ET - Power Hour Setup**
 Institutional positioning begins
 Good for swing entries (1-5 DTE)
 Watch for trend continuation/reversal

 **3:00-4:00 PM ET - Power Hour**
 High volume, strong moves
 Last chance for 0DTE
  Wide spreads near close
 Best for experienced traders

**SWING TRADES (3-5 DTE) BEST TIMES:**
 Enter: 10:00-11:00 AM (after opening noise)
 Avoid: Fridays (weekend theta decay)
 Best days: Tuesday-Thursday

**CURRENT ${currentSymbol} STATUS:**
 Price: $${price}
 Signal: ${signal}
 Mode: ${tradingMode.toUpperCase()}

**GANN TIME FACTORS:**
 Strongest moves: First hour, last hour
 Weakest: 12:00-1:00 PM (lunch hour)
 Watch 90-minute cycles intraday (Gann)

** MY RECOMMENDATION:**
For ${currentSymbol} ${signal} signal:
${signal === 'CALL' ? ' Enter on pullback to support 10:00-11:00 AM' : ' Enter on rally to resistance 10:00-11:00 AM'}
 Set stop based on ATR ($${lat ? parseFloat(lat.ATR).toFixed(2) : '--'})
 Take profits before 3:30 PM for 0DTE`;
}

// Current Status Response
function generateCurrentStatusResponse() {
    let response = ` **CURRENT MARKET STATUS**\n\n`;
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            const prev = data[data.length - 2] || lat;
            const price = parseFloat(lat.Close);
            const prevPrice = parseFloat(prev.Close);
            const chg = price - prevPrice;
            const pct = ((chg / prevPrice) * 100).toFixed(2);
            const signal = lat.Bias || 'HOLD';
            const consensus = lat.PriceConfluence || 0;
            const isCurrentSym = symbol === currentSymbol;
            
            response += `${isCurrentSym ? ' ' : ''}**${symbol}**: $${price.toFixed(2)} (${chg >= 0 ? '+' : ''}${pct}%)\n`;
            response += `   Signal: ${signal} | Consensus: ${consensus}/4\n\n`;
        }
    }
    
    return response;
}

// Trade Recommendation
function generateTradeRecommendation() {
    let bestTrade = null;
    let bestScore = 0;
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            const consensus = parseInt(lat.PriceConfluence) || 0;
            const signal = lat.Bias || 'HOLD';
            
            if (consensus > bestScore && signal !== 'HOLD') {
                bestScore = consensus;
                bestTrade = {
                    symbol,
                    signal,
                    consensus,
                    price: parseFloat(lat.Close),
                    atr: parseFloat(lat.ATR) || 5
                };
            }
        }
    }
    
    if (!bestTrade || bestScore < 2) {
        return ` **NO STRONG TRADE RECOMMENDATIONS RIGHT NOW**

Current market conditions don't show clear setups:
 No symbols have 3/4 or 4/4 consensus
 Agents are conflicting
 Consider staying flat or reducing size

**WHAT TO DO:**
 Wait for clearer signals
 Review the Bar Count tab for trend direction
 Check back after market open for fresh data`;
    }
    
    const strike = Math.round(bestTrade.price);
    const target = bestTrade.signal === 'CALL' 
        ? bestTrade.price + bestTrade.atr * 2 
        : bestTrade.price - bestTrade.atr * 2;
    const stop = bestTrade.signal === 'CALL'
        ? bestTrade.price - bestTrade.atr
        : bestTrade.price + bestTrade.atr;
    
    return ` **TODAY'S TOP TRADE RECOMMENDATION**

**${bestTrade.symbol} ${bestTrade.signal}**
Agent Consensus: ${bestTrade.consensus}/4 ${bestTrade.consensus >= 3 ? '' : ''}

 **ENTRY:**
 Price: $${bestTrade.price.toFixed(2)}
 Strike: $${strike} ${bestTrade.signal}
 Mode: ${tradingMode === 'intraday' ? '0DTE' : '3-5 DTE'}

 **TARGETS:**
 Target 1: $${(bestTrade.signal === 'CALL' ? bestTrade.price + bestTrade.atr : bestTrade.price - bestTrade.atr).toFixed(2)}
 Target 2: $${target.toFixed(2)}

 **RISK:**
 Stop Loss: $${stop.toFixed(2)}
 Risk/Reward: 1:2

 **TIMING:**
 Best entry: 10:00-11:00 AM ET
 Avoid: First 15 min, last 30 min (0DTE)`;
}

// Risk Management Response
function generateRiskManagementResponse() {
    const lat = currentData.length ? currentData[currentData.length - 1] : null;
    const price = lat ? parseFloat(lat.Close) : 675;
    const atr = lat ? parseFloat(lat.ATR) || 5 : 5;
    
    return ` **RISK MANAGEMENT GUIDELINES**

**POSITION SIZING (Kelly Criterion):**
 Risk 0.5-1% per trade (intraday)
 Risk 1-2% per trade (swing)
 Never risk more than 5% daily

**EXAMPLE for $10,000 Account:**
 1% risk = $100 max loss per trade
 If stop is $${atr.toFixed(2)} away (1 ATR)
 Max position = $100  $${atr.toFixed(2)} = ${(100/atr).toFixed(0)} contracts

**STOP LOSS PLACEMENT:**
 Intraday: 0.5-1.0 ATR = $${(atr * 0.75).toFixed(2)}
 Swing: 1.5-2.0 ATR = $${(atr * 1.5).toFixed(2)}

**${currentSymbol} CURRENT LEVELS:**
 Price: $${price.toFixed(2)}
 ATR: $${atr.toFixed(2)}
 Intraday Stop: $${(price - atr * 0.75).toFixed(2)} (CALL) / $${(price + atr * 0.75).toFixed(2)} (PUT)
 Swing Stop: $${(price - atr * 1.5).toFixed(2)} (CALL) / $${(price + atr * 1.5).toFixed(2)} (PUT)

**GANN'S RISK RULES:**
 Never let a profit turn into a loss
 Move stop to breakeven after 1 ATR profit
 Scale out: 50% at T1, 50% at T2
 Max 3 losses in a row = stop trading for day`;
}

// Market Update Response
function generateMarketUpdateResponse() {
    let bullish = 0, bearish = 0, neutral = 0;
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (data && data.length) {
            const signal = data[data.length - 1].Bias || 'HOLD';
            if (signal === 'CALL') bullish++;
            else if (signal === 'PUT') bearish++;
            else neutral++;
        }
    }
    
    const marketBias = bullish > bearish ? 'BULLISH' : (bearish > bullish ? 'BEARISH' : 'MIXED');
    const biasEmoji = marketBias === 'BULLISH' ? '' : (marketBias === 'BEARISH' ? '' : '');
    
    return ` **MARKET UPDATE**

${biasEmoji} **OVERALL BIAS: ${marketBias}**
 Bullish signals: ${bullish}/${SYMBOLS.length} ETFs
 Bearish signals: ${bearish}/${SYMBOLS.length} ETFs
 Neutral: ${neutral}/${SYMBOLS.length} ETFs

**SECTOR BREAKDOWN:**
${generateQuickSectorSummary()}

**TRADING IMPLICATION:**
${marketBias === 'BULLISH' ? ' Favor CALL trades\n Look for pullbacks to support\n Sector leaders: Check XLK, XLF' : 
  marketBias === 'BEARISH' ? ' Favor PUT trades\n Look for rallies to resistance\n Defensive sectors may outperform' :
  ' Mixed signals - reduce position size\n Wait for clearer direction\n Focus on highest consensus trades'}

 Use "high consensus trades" to find specific setups.`;
}

function generateQuickSectorSummary() {
    let summary = '';
    for (const symbol of ['XLK', 'XLF', 'XLV', 'XLE']) {
        const data = allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            const signal = lat.Bias || 'HOLD';
            const emoji = signal === 'CALL' ? '' : (signal === 'PUT' ? '' : '');
            summary += `${emoji} ${SYMBOL_NAMES[symbol]}: ${signal}\n`;
        }
    }
    return summary;
}

// Help Response
function generateHelpResponse() {
    return ` **HOW TO USE THE AI ASSISTANT**

**QUICK ACTIONS (Click the buttons!):**
  High Consensus - Find best trades
  Best CALLs - Top bullish plays
  Best PUTs - Top bearish plays
  Optimal Strike - Get strike recommendations

**EXAMPLE QUESTIONS:**

 **Data & Analysis:**
 "Show me bar count for all ETFs"
 "What's the current status?"
 "Compare all sectors"

 **Trade Ideas:**
 "What should I trade today?"
 "Best CALL options for 2 days"
 "Optimal strike for SPY"
 "Show high consensus trades"

 **Timing:**
 "When is the best time to trade?"
 "What are Gann time cycles?"

 **Education:**
 "Explain Square of 9"
 "What is Divine Proportions?"
 "Tunnel Through the Air principles"

 **Risk:**
 "How should I size my position?"
 "Where to place stop loss?"

Just type naturally - I understand most trading questions!`;
}

// Smart Default Response
function generateSmartDefaultResponse(message, context) {
    // GLM-4 Cloud Configuration
// Groq Cloud Configuration
const GLM4_CONFIG = {
    apiUrl: 'https://api.groq.com/openai/v1/chat/completions',
    apiKey: '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',
    model: 'llama-3.1-70b-versatile'
};

// Call Groq Cloud API
async function callGLM4(prompt) {
    try {
        const response = await fetch(GLM4_CONFIG.apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${GLM4_CONFIG.apiKey}`
            },
            body: JSON.stringify({
                model: GLM4_CONFIG.model,
                messages: [
                    { role: 'system', content: 'You are a Gann Trading Assistant. Be concise and actionable.' },
                    { role: 'user', content: prompt }
                ],
                temperature: 0.3,
                max_tokens: 600
            })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        return data.choices?.[0]?.message?.content || 'No response from Groq';
    } catch (error) {
        console.error('[Groq] Error:', error);
        return null;
    }
}
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        return data.choices?.[0]?.message?.content || 'No response from AI';
    } catch (error) {
        console.error('[GLM-4] Error:', error);
        return null;
    }
}

// Smart Default Response - Now with GLM-4!
async function generateSmartDefaultResponse(message, context) {
    const lowerMsg = message.toLowerCase();
    const mentionedSymbol = SYMBOLS.find(s => lowerMsg.includes(s.toLowerCase())) || currentSymbol;
    
    // Build context for GLM-4
    let marketContext = '';
    const data = allSymbolsData[mentionedSymbol] || currentData;
    if (data && data.length) {
        const lat = data[data.length - 1];
        marketContext = `
Symbol: ${mentionedSymbol}
Price: $${parseFloat(lat.Close).toFixed(2)}
Signal: ${lat.Bias || 'HOLD'}
Consensus: ${lat.PriceConfluence || 0}/4 agents
ATR: $${parseFloat(lat.ATR).toFixed(2)}`;
    }
    
    const prompt = `You are a Gann Trading Assistant. Answer this trading question concisely.

MARKET DATA:${marketContext}

USER QUESTION: ${message}

Provide a helpful, actionable response. If recommending a trade, include:
- Direction (BUY CALLS or BUY PUTS)
- Entry price
- Stop loss
- Target levels`;

    // Try GLM-4 first
    const glm4Response = await callGLM4(prompt);
    
    if (glm4Response) {
        return ` **GLM-4 Analysis:**\n\n${glm4Response}`;
    }
    
    // Fallback if GLM-4 fails
    let response = ` I want to help! Let me clarify...\n\n`;
    response += `You asked: "${message}"\n\n`;
    
    if (data && data.length) {
        const lat = data[data.length - 1];
        response += `**${mentionedSymbol} Quick Info:**\n`;
        response += ` Price: $${parseFloat(lat.Close).toFixed(2)}\n`;
        response += ` Signal: ${lat.Bias || 'HOLD'}\n`;
        response += ` Consensus: ${lat.PriceConfluence || 0}/4\n\n`;
    }
    
    response += `**Try asking:**\n`;
    response += ` "What should I trade today?"\n`;
    response += ` "Show me ${currentSymbol} bar count"\n`;
    response += ` "Best time to trade options"\n`;
    response += ` "High consensus trades"\n\n`;
    response += `Or click a Quick Action button on the right `;
    
    return response;
    }
    
    // Check for symbol mentions
    const mentionedSymbol = SYMBOLS.find(s => lowerMsg.includes(s.toLowerCase()));
    
    let response = ` I want to help! Let me clarify...\n\n`;
    response += `You asked: "${message}"\n\n`;
    
    if (mentionedSymbol) {
        const data = allSymbolsData[mentionedSymbol] || currentData;
        if (data && data.length) {
            const lat = data[data.length - 1];
            response += `**${mentionedSymbol} Quick Info:**\n`;
            response += ` Price: $${parseFloat(lat.Close).toFixed(2)}\n`;
            response += ` Signal: ${lat.Bias || 'HOLD'}\n`;
            response += ` Consensus: ${lat.PriceConfluence || 0}/4\n\n`;
        }
    }
    
    response += `**Try asking:**\n`;
    response += ` "What should I trade today?"\n`;
    response += ` "Show me ${currentSymbol} bar count"\n`;
    response += ` "Best time to trade options"\n`;
    response += ` "Calculate Square of 9 for ${currentSymbol}"\n`;
    response += ` "High consensus trades"\n\n`;
    response += `Or click a Quick Action button on the right `;
    
    return response;
}

// ============================================
// TRADE LOG SYSTEM
// ============================================

// Initialize trades from localStorage
let trades = [];

function loadTrades() {
    const stored = localStorage.getItem('sa4_trades');
    if (stored) {
        try {
            trades = JSON.parse(stored);
        } catch (e) {
            trades = [];
        }
    }
    renderTrades();
    updateTradeStats();
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('tradeDate');
    if (dateInput) dateInput.value = today;
}

function saveTrades() {
    localStorage.setItem('sa4_trades', JSON.stringify(trades));
}

function logTrade(event) {
    event.preventDefault();
    
    const trade = {
        id: Date.now(),
        date: document.getElementById('tradeDate').value,
        symbol: document.getElementById('tradeSymbol').value,
        direction: document.getElementById('tradeDirection').value,
        type: document.getElementById('tradeType').value,
        strike: parseFloat(document.getElementById('tradeStrike').value),
        contracts: parseInt(document.getElementById('tradeContracts').value),
        entry: parseFloat(document.getElementById('tradeEntry').value),
        exit: parseFloat(document.getElementById('tradeExit').value) || null,
        consensus: document.getElementById('tradeConsensus').value,
        status: document.getElementById('tradeStatus').value,
        notes: document.getElementById('tradeNotes').value,
        createdAt: new Date().toISOString()
    };
    
    // Calculate P&L if closed
    if (trade.exit && trade.status !== 'OPEN') {
        trade.pnl = (trade.exit - trade.entry) * trade.contracts * 100;
    } else {
        trade.pnl = null;
    }
    
    trades.unshift(trade); // Add to beginning
    saveTrades();
    renderTrades();
    updateTradeStats();
    clearTradeForm();
    
    // Show success message
    alert(' Trade logged successfully!');
}

function clearTradeForm() {
    document.getElementById('tradeForm').reset();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('tradeDate').value = today;
    document.getElementById('tradeSymbol').value = currentSymbol;
}

function toggleExitField() {
    const status = document.getElementById('tradeStatus').value;
    const exitField = document.getElementById('tradeExit');
    if (status === 'OPEN') {
        exitField.value = '';
        exitField.disabled = true;
    } else {
        exitField.disabled = false;
    }
}

function renderTrades() {
    const tbody = document.getElementById('tradeTableBody');
    if (!tbody) return;
    
    const filterSymbol = document.getElementById('filterSymbol')?.value || 'ALL';
    const filterDirection = document.getElementById('filterDirection')?.value || 'ALL';
    const filterStatus = document.getElementById('filterStatus')?.value || 'ALL';
    
    let filteredTrades = trades.filter(t => {
        if (filterSymbol !== 'ALL' && t.symbol !== filterSymbol) return false;
        if (filterDirection !== 'ALL' && t.direction !== filterDirection) return false;
        if (filterStatus !== 'ALL' && t.status !== filterStatus) return false;
        return true;
    });
    
    document.getElementById('tradeCount').textContent = `(${filteredTrades.length} trades)`;
    
    if (filteredTrades.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" style="text-align:center;color:var(--muted);padding:30px;">No trades match your filters.</td></tr>';
        return;
    }
    
    let html = '';
    filteredTrades.forEach((trade, index) => {
        const pnlClass = trade.pnl > 0 ? 'pnl-positive' : (trade.pnl < 0 ? 'pnl-negative' : '');
        const pnlDisplay = trade.pnl !== null ? `${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(2)}` : '--';
        const statusClass = trade.status.toLowerCase();
        const directionEmoji = trade.direction === 'CALL' ? '' : '';
        const typeEmoji = trade.type === 'INTRADAY' ? '' : '';
        
        html += `<tr>
            <td>${filteredTrades.length - index}</td>
            <td>${trade.date}</td>
            <td><strong>${trade.symbol}</strong></td>
            <td>${directionEmoji} ${trade.direction} ${typeEmoji}</td>
            <td>$${trade.strike}</td>
            <td>${trade.contracts}</td>
            <td>$${trade.entry.toFixed(2)}</td>
            <td>${trade.exit ? '$' + trade.exit.toFixed(2) : '--'}</td>
            <td class="${pnlClass}">${pnlDisplay}</td>
            <td><span class="badge badge-${trade.consensus === '4/4' ? 'ultra' : (trade.consensus === '3/4' ? 'success' : 'warning')}">${trade.consensus}</span></td>
            <td><span class="status-badge-trade ${statusClass}">${trade.status}</span></td>
            <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${trade.notes || ''}">${trade.notes || '--'}</td>
            <td>
                <button class="trade-action-btn edit" onclick="editTrade(${trade.id})"></button>
                <button class="trade-action-btn delete" onclick="deleteTrade(${trade.id})"></button>
            </td>
        </tr>`;
    });
    
    tbody.innerHTML = html;
}

function filterTrades() {
    renderTrades();
}

function editTrade(id) {
    const trade = trades.find(t => t.id === id);
    if (!trade) return;
    
    document.getElementById('tradeDate').value = trade.date;
    document.getElementById('tradeSymbol').value = trade.symbol;
    document.getElementById('tradeDirection').value = trade.direction;
    document.getElementById('tradeType').value = trade.type;
    document.getElementById('tradeStrike').value = trade.strike;
    document.getElementById('tradeContracts').value = trade.contracts;
    document.getElementById('tradeEntry').value = trade.entry;
    document.getElementById('tradeExit').value = trade.exit || '';
    document.getElementById('tradeConsensus').value = trade.consensus;
    document.getElementById('tradeStatus').value = trade.status;
    document.getElementById('tradeNotes').value = trade.notes || '';
    
    // Remove the old trade
    trades = trades.filter(t => t.id !== id);
    saveTrades();
    
    // Scroll to form
    document.getElementById('tradeForm').scrollIntoView({ behavior: 'smooth' });
}

function deleteTrade(id) {
    if (!confirm('Are you sure you want to delete this trade?')) return;
    
    trades = trades.filter(t => t.id !== id);
    saveTrades();
    renderTrades();
    updateTradeStats();
}

function clearAllTrades() {
    if (!confirm(' Are you sure you want to delete ALL trades? This cannot be undone!')) return;
    if (!confirm('This will permanently delete your entire trade history. Continue?')) return;
    
    trades = [];
    saveTrades();
    renderTrades();
    updateTradeStats();
}

function updateTradeStats() {
    const closedTrades = trades.filter(t => t.status !== 'OPEN' && t.pnl !== null);
    const wins = closedTrades.filter(t => t.pnl > 0);
    const losses = closedTrades.filter(t => t.pnl <= 0);
    
    // Basic stats
    document.getElementById('statTotalTrades').textContent = trades.length;
    
    // Win rate
    const winRate = closedTrades.length > 0 ? (wins.length / closedTrades.length * 100).toFixed(1) : 0;
    document.getElementById('statWinRate').textContent = winRate + '%';
    document.getElementById('statWinRate').className = `metric-value ${parseFloat(winRate) >= 50 ? 'positive' : 'negative'}`;
    document.getElementById('statWinLoss').textContent = `${wins.length}W / ${losses.length}L`;
    
    // Total P&L
    const totalPnL = closedTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
    document.getElementById('statTotalPnL').textContent = `${totalPnL >= 0 ? '+' : ''}$${totalPnL.toFixed(2)}`;
    document.getElementById('statTotalPnL').className = `metric-value ${totalPnL >= 0 ? 'positive' : 'negative'}`;
    
    // Average trade
    const avgTrade = closedTrades.length > 0 ? totalPnL / closedTrades.length : 0;
    document.getElementById('statAvgTrade').textContent = `Avg: ${avgTrade >= 0 ? '+' : ''}$${avgTrade.toFixed(2)}`;
    
    // Best/Worst trade
    if (closedTrades.length > 0) {
        const best = closedTrades.reduce((max, t) => t.pnl > max.pnl ? t : max);
        const worst = closedTrades.reduce((min, t) => t.pnl < min.pnl ? t : min);
        
        document.getElementById('statBestTrade').textContent = `+$${best.pnl.toFixed(2)}`;
        document.getElementById('statBestSymbol').textContent = `${best.symbol} ${best.direction}`;
        document.getElementById('statWorstTrade').textContent = `$${worst.pnl.toFixed(2)}`;
        document.getElementById('statWorstSymbol').textContent = `${worst.symbol} ${worst.direction}`;
    }
    
    // Trades this week
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    const weekTrades = trades.filter(t => new Date(t.date) >= oneWeekAgo);
    document.getElementById('statTradesThisWeek').textContent = `${weekTrades.length} this week`;
    
    // Update analytics
    updateSymbolPerformance();
    updateDirectionPerformance();
    updateConsensusAnalysis();
}

function updateSymbolPerformance() {
    const container = document.getElementById('symbolPerformance');
    if (!container) return;
    
    const closedTrades = trades.filter(t => t.status !== 'OPEN' && t.pnl !== null);
    if (closedTrades.length === 0) {
        container.innerHTML = '<p style="color:var(--muted);font-size:12px;">Log closed trades to see performance breakdown</p>';
        return;
    }
    
    const bySymbol = {};
    closedTrades.forEach(t => {
        if (!bySymbol[t.symbol]) {
            bySymbol[t.symbol] = { wins: 0, losses: 0, pnl: 0 };
        }
        bySymbol[t.symbol].pnl += t.pnl;
        if (t.pnl > 0) bySymbol[t.symbol].wins++;
        else bySymbol[t.symbol].losses++;
    });
    
    let html = '<div style="display:flex;flex-direction:column;gap:8px;">';
    Object.entries(bySymbol).sort((a, b) => b[1].pnl - a[1].pnl).forEach(([symbol, data]) => {
        const winRate = ((data.wins / (data.wins + data.losses)) * 100).toFixed(0);
        const pnlClass = data.pnl >= 0 ? 'positive' : 'negative';
        html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px;background:var(--bg);border-radius:4px;">
            <span style="font-weight:600;">${symbol}</span>
            <span>${data.wins}W/${data.losses}L (${winRate}%)</span>
            <span class="${pnlClass}" style="font-weight:600;">${data.pnl >= 0 ? '+' : ''}$${data.pnl.toFixed(2)}</span>
        </div>`;
    });
    html += '</div>';
    container.innerHTML = html;
}

function updateDirectionPerformance() {
    const container = document.getElementById('directionPerformance');
    if (!container) return;
    
    const closedTrades = trades.filter(t => t.status !== 'OPEN' && t.pnl !== null);
    if (closedTrades.length === 0) {
        container.innerHTML = '<p style="color:var(--muted);font-size:12px;">Log closed trades to see CALL vs PUT performance</p>';
        return;
    }
    
    const calls = closedTrades.filter(t => t.direction === 'CALL');
    const puts = closedTrades.filter(t => t.direction === 'PUT');
    
    const callWins = calls.filter(t => t.pnl > 0).length;
    const callPnL = calls.reduce((sum, t) => sum + t.pnl, 0);
    const putWins = puts.filter(t => t.pnl > 0).length;
    const putPnL = puts.reduce((sum, t) => sum + t.pnl, 0);
    
    const callWinRate = calls.length > 0 ? ((callWins / calls.length) * 100).toFixed(0) : 0;
    const putWinRate = puts.length > 0 ? ((putWins / puts.length) * 100).toFixed(0) : 0;
    
    container.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:10px;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(16,185,129,0.1);border-radius:6px;border-left:4px solid var(--success);">
                <div>
                    <div style="font-weight:700;font-size:14px;"> CALLS</div>
                    <div style="font-size:11px;color:var(--muted);">${calls.length} trades | ${callWinRate}% win rate</div>
                </div>
                <div style="font-size:18px;font-weight:700;" class="${callPnL >= 0 ? 'positive' : 'negative'}">${callPnL >= 0 ? '+' : ''}$${callPnL.toFixed(2)}</div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(239,68,68,0.1);border-radius:6px;border-left:4px solid var(--danger);">
                <div>
                    <div style="font-weight:700;font-size:14px;"> PUTS</div>
                    <div style="font-size:11px;color:var(--muted);">${puts.length} trades | ${putWinRate}% win rate</div>
                </div>
                <div style="font-size:18px;font-weight:700;" class="${putPnL >= 0 ? 'positive' : 'negative'}">${putPnL >= 0 ? '+' : ''}$${putPnL.toFixed(2)}</div>
            </div>
        </div>
    `;
}

function updateConsensusAnalysis() {
    const consensusLevels = ['4/4', '3/4', '2/4', '1/4'];
    const ids = ['ultra44', 'super34', 'single24', 'weak14'];
    
    consensusLevels.forEach((level, i) => {
        const levelTrades = trades.filter(t => t.consensus === level && t.status !== 'OPEN' && t.pnl !== null);
        const wins = levelTrades.filter(t => t.pnl > 0).length;
        const winRate = levelTrades.length > 0 ? ((wins / levelTrades.length) * 100).toFixed(0) : '--';
        
        document.getElementById(`${ids[i]}WinRate`).textContent = winRate + '%';
        document.getElementById(`${ids[i]}WinRate`).style.color = winRate !== '--' && parseFloat(winRate) >= 50 ? 'var(--success)' : 'var(--danger)';
        document.getElementById(`${ids[i]}Count`).textContent = `${levelTrades.length} trades`;
    });
}

// Export Functions
function printTrades() {
    window.print();
}

function exportCSV() {
    if (trades.length === 0) {
        alert('No trades to export!');
        return;
    }
    
    const headers = ['Date', 'Symbol', 'Direction', 'Type', 'Strike', 'Contracts', 'Entry', 'Exit', 'P&L', 'Consensus', 'Status', 'Notes'];
    const rows = trades.map(t => [
        t.date,
        t.symbol,
        t.direction,
        t.type,
        t.strike,
        t.contracts,
        t.entry,
        t.exit || '',
        t.pnl || '',
        t.consensus,
        t.status,
        `"${(t.notes || '').replace(/"/g, '""')}"`
    ]);
    
    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `trade_log_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    
    URL.revokeObjectURL(url);
}

function shareTrades() {
    const closedTrades = trades.filter(t => t.status !== 'OPEN' && t.pnl !== null);
    const wins = closedTrades.filter(t => t.pnl > 0).length;
    const winRate = closedTrades.length > 0 ? ((wins / closedTrades.length) * 100).toFixed(1) : 0;
    const totalPnL = closedTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
    
    const text = ` Stock Agent 4 - Trade Summary

 Total Trades: ${trades.length}
 Win Rate: ${winRate}%
 Total P&L: ${totalPnL >= 0 ? '+' : ''}$${totalPnL.toFixed(2)}
 Period: ${trades.length > 0 ? trades[trades.length-1].date : 'N/A'} to ${trades.length > 0 ? trades[0].date : 'N/A'}

Powered by Q5D Options Platform & Gann Principles `;

    if (navigator.share) {
        navigator.share({
            title: 'Stock Agent 4 Trade Summary',
            text: text
        }).catch(console.log);
    } else {
        // Fallback - copy to clipboard
        navigator.clipboard.writeText(text).then(() => {
            alert(' Trade summary copied to clipboard!');
        }).catch(() => {
            prompt('Copy this trade summary:', text);
        });
    }
}

function emailTrades() {
    const closedTrades = trades.filter(t => t.status !== 'OPEN' && t.pnl !== null);
    const wins = closedTrades.filter(t => t.pnl > 0).length;
    const winRate = closedTrades.length > 0 ? ((wins / closedTrades.length) * 100).toFixed(1) : 0;
    const totalPnL = closedTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
    
    const subject = encodeURIComponent('Stock Agent 4 - Trade Summary');
    const body = encodeURIComponent(`Stock Agent 4 - Trade Summary

Total Trades: ${trades.length}
Win Rate: ${winRate}%
Total P&L: ${totalPnL >= 0 ? '+' : ''}$${totalPnL.toFixed(2)}

Recent Trades:
${trades.slice(0, 10).map(t => `- ${t.date}: ${t.symbol} ${t.direction} ${t.contracts}x $${t.strike} | P&L: ${t.pnl !== null ? '$' + t.pnl.toFixed(2) : 'Open'}`).join('\n')}

---
Powered by Q5D Options Platform`);
    
    window.open(`mailto:?subject=${subject}&body=${body}`);
}

// Initialize trade log when app loads
async function initializeApp() {
    initTabs();
    await loadAllData();  // Wait for data to load
    await loadAllSymbolsData();
    loadTrades(); // Load trade history
    runHealthCheck(); // Now run health check AFTER data is loaded

    // Update Reversal Stats after ALL symbol data is loaded
    updateReversalStats();

    // Refresh Gann Analysis tab if active (now that all data is loaded)
    if (document.getElementById('gann-analysis')?.classList.contains('active')) {
        initMonthlyTradingDashboard();
    }

    setInterval(loadAllData, 60000);
    setInterval(runHealthCheck, 300000); // Health check every 5 minutes
}

// ============================================
// HEALTH MONITORING SYSTEM
// ============================================

let healthStatus = {
    dataFreshness: 'unknown',
    marketStatus: 'unknown',
    workflowStatus: 'unknown',
    dataQuality: 'unknown',
    alerts: []
};

function runHealthCheck() {
    console.log('Running health check...');
    healthStatus.alerts = [];
    
    // Check data freshness
    checkDataFreshness();
    
    // Check market status
    checkMarketStatus();
    
    // Check data quality
    checkDataQuality();
    
    // Check connections
    checkConnections();
    
    // Update overall status
    updateOverallHealth();
    
    // Update last check time
    const lastCheckEl = document.getElementById('lastHealthCheck');
    if (lastCheckEl) lastCheckEl.textContent = new Date().toLocaleString();
    
    // Update health section timestamp
    updateSectionTimestamp('health');
}

function checkDataFreshness() {
    console.log(' checkDataFreshness running...');
    
    // Get elements directly
    const lastDateEl = document.getElementById('lastDataDate');
    const daysSinceEl = document.getElementById('daysSinceUpdate');
    const expectedEl = document.getElementById('expectedUpdate');
    const totalBarsEl = document.getElementById('totalBarsLoaded');
    const dateRangeEl = document.getElementById('dataDateRange');
    const valueEl = document.getElementById('dataFreshnessValue');
    const statusEl = document.getElementById('dataFreshnessStatus');
    const freshEl = document.getElementById('healthDataFresh');
    
    // Check if we have data
    if (!currentData || currentData.length === 0) {
        console.log(' No data available');
        if (valueEl) valueEl.textContent = 'No Data';
        if (statusEl) statusEl.textContent = 'CRITICAL';
        healthStatus.dataFreshness = 'critical';
        healthStatus.alerts.push({ type: 'critical', message: 'No data loaded' });
        return;
    }
    
    console.log(' Data length:', currentData.length);
    
    // Get last bar directly
    const lastBar = currentData[currentData.length - 1];
    console.log(' Last bar:', lastBar);
    console.log(' Last bar Date:', lastBar.Date);
    
    // Parse the date - handle ISO format WITHOUT timezone conversion
    let lastDate;
    if (lastBar.Date) {
        // Extract just the date part (YYYY-MM-DD) to avoid timezone issues
        const dateStr = lastBar.Date.split('T')[0].split(' ')[0];
        const [year, month, day] = dateStr.split('-').map(Number);
        lastDate = new Date(year, month - 1, day); // month is 0-indexed
        console.log(' Parsed lastDate (no TZ):', lastDate);
    }
    
    if (!lastDate || isNaN(lastDate.getTime())) {
        console.log(' Invalid date');
        if (valueEl) valueEl.textContent = 'Invalid Date';
        healthStatus.dataFreshness = 'critical';
        return;
    }
    
    // Calculate days difference
    const now = new Date();
    const diffMs = now - lastDate;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    console.log(' Now:', now);
    console.log(' Diff days:', diffDays);
    
    // Format the date string
    const dateStr = lastDate.toLocaleDateString('en-US', { 
        weekday: 'short', 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
    });
    console.log(' Formatted date:', dateStr);
    
    // UPDATE THE ELEMENTS DIRECTLY
    if (lastDateEl) {
        lastDateEl.textContent = dateStr;
        lastDateEl.innerHTML = dateStr;
        console.log(' Updated lastDataDate to:', dateStr);
    } else {
        console.log(' lastDataDate element not found!');
    }
    
    if (daysSinceEl) {
        const daysText = diffDays === 0 ? 'Today' : (diffDays === 1 ? '1 day ago' : diffDays + ' days ago');
        daysSinceEl.textContent = daysText;
        console.log(' Updated daysSinceUpdate to:', daysText);
    }
    
    if (totalBarsEl) {
        totalBarsEl.textContent = currentData.length + ' bars';
    }
    
    // First date for range
    const firstBar = currentData[0];
    if (firstBar && firstBar.Date && dateRangeEl) {
        const firstDateStr = firstBar.Date.split('T')[0].split(' ')[0];
        const [fy, fm, fd] = firstDateStr.split('-').map(Number);
        const firstDate = new Date(fy, fm - 1, fd);
        dateRangeEl.textContent = firstDate.toLocaleDateString() + ' - ' + lastDate.toLocaleDateString();
    }
    
    // Expected update
    if (expectedEl) {
        const nextUpdate = getNextMarketDay(lastDate);
        expectedEl.textContent = nextUpdate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }
    
    // Status based on days
    if (diffDays === 0) {
        if (valueEl) valueEl.textContent = 'Up to Date';
        if (statusEl) { statusEl.textContent = 'FRESH'; statusEl.className = 'health-metric-status ok'; }
        if (freshEl) freshEl.className = 'health-metric healthy';
        healthStatus.dataFreshness = 'healthy';
        healthStatus.alerts.push({ type: 'success', message: 'Data is current' });
    } else if (diffDays === 1) {
        if (valueEl) valueEl.textContent = '1 Day Old';
        if (statusEl) { statusEl.textContent = 'OK'; statusEl.className = 'health-metric-status ok'; }
        if (freshEl) freshEl.className = 'health-metric healthy';
        healthStatus.dataFreshness = 'healthy';
    } else if (diffDays <= 3) {
        const isWeekend = isWeekendGap(lastDate, now);
        if (isWeekend) {
            if (valueEl) valueEl.textContent = diffDays + ' Days (Weekend)';
            if (statusEl) { statusEl.textContent = 'OK'; statusEl.className = 'health-metric-status ok'; }
            if (freshEl) freshEl.className = 'health-metric healthy';
            healthStatus.dataFreshness = 'healthy';
        } else {
            if (valueEl) valueEl.textContent = diffDays + ' Days Old';
            if (statusEl) { statusEl.textContent = 'STALE'; statusEl.className = 'health-metric-status warn'; }
            if (freshEl) freshEl.className = 'health-metric warning';
            healthStatus.dataFreshness = 'warning';
            healthStatus.alerts.push({ type: 'warning', message: 'Data is ' + diffDays + ' days old' });
        }
    } else {
        if (valueEl) valueEl.textContent = diffDays + ' Days Old';
        if (statusEl) { statusEl.textContent = 'OUTDATED'; statusEl.className = 'health-metric-status error'; }
        if (freshEl) freshEl.className = 'health-metric critical';
        healthStatus.dataFreshness = 'critical';
        healthStatus.alerts.push({ type: 'critical', message: 'Data is ' + diffDays + ' days old!' });
    }
    
    console.log(' checkDataFreshness complete');
}

// Get detailed market status based on Eastern Time
function getMarketStatus() {
    const now = new Date();
    const etOffset = getETOffset();
    const etNow = new Date(now.getTime() + etOffset);
    
    const day = etNow.getDay();
    const hours = etNow.getHours();
    const minutes = etNow.getMinutes();
    const timeNum = hours * 100 + minutes;
    
    // Weekend check
    if (day === 0 || day === 6) {
        return {
            status: 'Weekend - CLOSED',
            code: 'weekend',
            color: '#6b7280', // gray
            className: 'warning',
            trading: false
        };
    }
    
    // Pre-Market: 4:00 AM - 9:30 AM ET
    if (timeNum >= 400 && timeNum < 930) {
        return {
            status: 'Pre-Market',
            code: 'premarket',
            color: '#eab308', // yellow
            className: 'warning',
            trading: false
        };
    }
    
    // Market Open: 9:30 AM - 4:00 PM ET
    if (timeNum >= 930 && timeNum < 1600) {
        return {
            status: 'Market Open',
            code: 'open',
            color: '#22c55e', // green
            className: 'healthy',
            trading: true
        };
    }
    
    // After Hours: 4:00 PM - 8:00 PM ET
    if (timeNum >= 1600 && timeNum < 2000) {
        return {
            status: 'After Hours',
            code: 'afterhours',
            color: '#f97316', // orange
            className: 'warning',
            trading: false
        };
    }
    
    // Market Closed: 8:00 PM - 4:00 AM ET
    return {
        status: 'Market Closed',
        code: 'closed',
        color: '#6b7280', // gray
        className: 'warning',
        trading: false
    };
}

function checkMarketStatus() {
    const marketEl = document.getElementById('healthMarket');
    const valueEl = document.getElementById('marketStatusValue');
    const statusEl = document.getElementById('marketStatusStatus');
    
    const market = getMarketStatus();
    
    if (valueEl) {
        valueEl.textContent = market.status;
        valueEl.style.color = market.color;
    }
    
    if (statusEl) {
        statusEl.textContent = market.trading ? 'TRADING' : (market.code === 'premarket' ? 'WAITING' : 'CLOSED');
        statusEl.className = 'health-metric-status ' + (market.trading ? 'ok' : 'warn');
    }
    
    if (marketEl) {
        marketEl.className = 'health-metric ' + market.className;
    }
    
    healthStatus.marketStatus = market.code;
    
    // Also update header health badge if market status display exists there
    updateHeaderMarketStatus(market);
}

function updateHeaderMarketStatus(market) {
    // Update any header market status elements
    const headerHealthText = document.getElementById('headerHealthText');
    if (headerHealthText && market.trading) {
        // Only show market status if system is healthy
        const currentText = headerHealthText.textContent;
        if (currentText === 'HEALTHY') {
            headerHealthText.textContent = 'HEALTHY  TRADING';
        }
    }
}

// Run market status check every 60 seconds
setInterval(checkMarketStatus, 60000);

function checkDataQuality() {
    const qualityEl = document.getElementById('healthDataQuality');
    const valueEl = document.getElementById('dataQualityValue');
    const statusEl = document.getElementById('dataQualityStatus');
    
    if (!currentData || currentData.length === 0) {
        valueEl.textContent = 'No Data';
        statusEl.textContent = 'N/A';
        statusEl.className = 'health-metric-status error';
        qualityEl.className = 'health-metric critical';
        healthStatus.dataQuality = 'critical';
        return;
    }
    
    let issues = 0;
    let checks = 0;
    
    // Check for required fields
    const lastBar = currentData[currentData.length - 1];
    const requiredFields = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume'];
    
    requiredFields.forEach(field => {
        checks++;
        if (!lastBar[field] && lastBar[field] !== 0) {
            issues++;
        }
    });
    
    // Check for valid price data
    checks++;
    if (lastBar.Close && (lastBar.Close < 0 || lastBar.Close > 10000)) {
        issues++;
        healthStatus.alerts.push({ type: 'warning', message: 'Unusual price detected - verify data integrity' });
    }
    
    // Check for signal data
    checks++;
    if (!lastBar.Bias) {
        issues++;
    }
    
    // Calculate quality score
    const score = Math.round(((checks - issues) / checks) * 100);
    
    if (score >= 90) {
        valueEl.textContent = score + '%';
        statusEl.textContent = 'EXCELLENT';
        statusEl.className = 'health-metric-status ok';
        qualityEl.className = 'health-metric healthy';
        healthStatus.dataQuality = 'healthy';
    } else if (score >= 70) {
        valueEl.textContent = score + '%';
        statusEl.textContent = 'GOOD';
        statusEl.className = 'health-metric-status ok';
        qualityEl.className = 'health-metric healthy';
        healthStatus.dataQuality = 'healthy';
    } else if (score >= 50) {
        valueEl.textContent = score + '%';
        statusEl.textContent = 'FAIR';
        statusEl.className = 'health-metric-status warn';
        qualityEl.className = 'health-metric warning';
        healthStatus.dataQuality = 'warning';
    } else {
        valueEl.textContent = score + '%';
        statusEl.textContent = 'POOR';
        statusEl.className = 'health-metric-status error';
        qualityEl.className = 'health-metric critical';
        healthStatus.dataQuality = 'critical';
        healthStatus.alerts.push({ type: 'critical', message: 'Data quality issues detected - check CSV files' });
    }
}

function checkConnections() {
    // GitHub Pages - if page loaded, it's working
    document.getElementById('connGitHub').className = 'connection-indicator online';
    document.getElementById('connGitHubStatus').textContent = 'Connected';
    
    // Data feed - based on whether data loaded
    if (currentData && currentData.length > 0) {
        document.getElementById('connData').className = 'connection-indicator online';
        document.getElementById('connDataStatus').textContent = 'Loaded';
    } else {
        document.getElementById('connData').className = 'connection-indicator offline';
        document.getElementById('connDataStatus').textContent = 'Failed';
    }
    
    // Portfolio feed
    // This would be checked based on portfolio data
    document.getElementById('connPortfolio').className = 'connection-indicator online';
    document.getElementById('connPortfolioStatus').textContent = 'Active';
    
    // Local Storage
    try {
        localStorage.setItem('health_test', 'test');
        localStorage.removeItem('health_test');
        document.getElementById('connLocalStorage').className = 'connection-indicator online';
        document.getElementById('connLocalStorageStatus').textContent = 'Available';
    } catch (e) {
        document.getElementById('connLocalStorage').className = 'connection-indicator offline';
        document.getElementById('connLocalStorageStatus').textContent = 'Blocked';
        healthStatus.alerts.push({ type: 'warning', message: 'Local storage unavailable - trade log may not persist' });
    }
}

function updateOverallHealth() {
    const banner = document.getElementById('healthBanner');
    const icon = document.getElementById('healthBannerIcon');
    const title = document.getElementById('healthBannerTitle');
    const subtitle = document.getElementById('healthBannerSubtitle');
    const workflowEl = document.getElementById('healthWorkflow');
    const workflowValue = document.getElementById('workflowStatusValue');
    const workflowStatus = document.getElementById('workflowStatusStatus');

    // Traffic light helper
    const setTrafficLight = (id, status) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (status === 'healthy' || status === 'ok') el.textContent = '';
        else if (status === 'warning') el.textContent = '';
        else el.textContent = '';
    };

    // Determine workflow status based on data freshness
    if (healthStatus.dataFreshness === 'healthy') {
        workflowValue.textContent = 'Running';
        workflowStatus.textContent = 'ACTIVE';
        workflowStatus.className = 'health-metric-status ok';
        workflowEl.className = 'health-metric healthy';
        healthStatus.workflowStatus = 'healthy';
    } else if (healthStatus.dataFreshness === 'warning') {
        workflowValue.textContent = 'Delayed';
        workflowStatus.textContent = 'CHECK';
        workflowStatus.className = 'health-metric-status warn';
        workflowEl.className = 'health-metric warning';
        healthStatus.workflowStatus = 'warning';
    } else {
        workflowValue.textContent = 'Stopped?';
        workflowStatus.textContent = 'ERROR';
        workflowStatus.className = 'health-metric-status error';
        workflowEl.className = 'health-metric critical';
        healthStatus.workflowStatus = 'critical';
    }

    // Update traffic lights for each component
    setTrafficLight('dataFreshnessLight', healthStatus.dataFreshness);
    setTrafficLight('marketStatusLight', healthStatus.marketStatus || 'ok');
    setTrafficLight('workflowStatusLight', healthStatus.workflowStatus);
    setTrafficLight('dataQualityLight', healthStatus.dataQuality);

    // Overall status - count greens, yellows, reds
    const statuses = [healthStatus.dataFreshness, healthStatus.dataQuality, healthStatus.workflowStatus, healthStatus.marketStatus || 'healthy'];
    let greenCount = statuses.filter(s => s === 'healthy').length;
    let yellowCount = statuses.filter(s => s === 'warning').length;
    let redCount = statuses.filter(s => s === 'critical').length;

    if (statuses.includes('critical')) {
        banner.className = 'health-banner critical';
        icon.textContent = '';
        title.textContent = 'ATTENTION NEEDED';
        subtitle.textContent = `${greenCount}/4 Green, ${yellowCount} Yellow, ${redCount} Red`;
    } else if (statuses.includes('warning')) {
        banner.className = 'health-banner warning';
        icon.textContent = '';
        title.textContent = 'MINOR ISSUES';
        subtitle.textContent = `${greenCount}/4 Green, ${yellowCount} Yellow`;
    } else {
        banner.className = 'health-banner';
        icon.textContent = '';
        title.textContent = 'ALL SYSTEMS OPERATIONAL';
        subtitle.textContent = '4/4 Green';
    }

    // Update time since last update
    updateTimeSinceLastUpdate();

    // Update connection traffic lights
    updateConnectionLights();

    // Update system info times
    updateSystemInfoTimes();

    // Log health check event
    addSystemLogEntry('Health Check Run', 'success');

    // Render alerts
    renderHealthAlerts();

    // Update header badge
    updateHeaderHealthBadge();
}

// Update time since last data update
function updateTimeSinceLastUpdate() {
    if (!currentData || currentData.length === 0) return;

    const lastBar = currentData[currentData.length - 1];
    if (!lastBar.Date) return;

    const dateStr = lastBar.Date.split('T')[0].split(' ')[0];
    const [year, month, day] = dateStr.split('-').map(Number);
    const lastDate = new Date(year, month - 1, day);

    const now = new Date();
    const diffMs = now - lastDate;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    const lightEl = document.getElementById('timeSinceLight');
    const textEl = document.getElementById('timeSinceText');

    let timeText = '';
    let light = '';

    if (diffHours < 1) {
        timeText = 'Data updated less than 1 hour ago';
        light = '';
    } else if (diffHours < 12) {
        timeText = `Data updated ${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        light = '';
    } else if (diffHours < 24) {
        timeText = `Data updated ${diffHours} hours ago`;
        light = '';
    } else {
        timeText = `Data updated ${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        light = diffDays > 1 ? '' : '';
    }

    if (lightEl) lightEl.textContent = light;
    if (textEl) textEl.textContent = timeText;
}

// Update connection status traffic lights
function updateConnectionLights() {
    const setLight = (id, status) => {
        const el = document.getElementById(id);
        if (el) el.textContent = status === 'connected' ? '' : (status === 'partial' ? '' : '');
    };

    // GitHub Pages - check if we're on github.io
    const isGitHub = window.location.hostname.includes('github.io');
    setLight('connGitHubLight', isGitHub ? 'connected' : 'connected'); // Always green if page loads

    // Data Feed - check if we have data
    setLight('connDataLight', currentData && currentData.length > 0 ? 'connected' : 'disconnected');

    // Portfolio - check localStorage
    const trades = JSON.parse(localStorage.getItem('trades') || '[]');
    setLight('connPortfolioLight', 'connected'); // Always connected if page loads

    // Local Storage
    try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        setLight('connLocalStorageLight', 'connected');
    } catch(e) {
        setLight('connLocalStorageLight', 'disconnected');
    }
}

// Update system info times
function updateSystemInfoTimes() {
    const now = new Date();
    const timeStr = now.toLocaleString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true });

    // Health check time
    const healthEl = document.getElementById('sysInfoHealthCheckTime');
    if (healthEl) healthEl.textContent = timeStr;

    // Data fetch time - use last data date
    if (currentData && currentData.length > 0) {
        const lastBar = currentData[currentData.length - 1];
        const dataFetchEl = document.getElementById('sysInfoDataFetchTime');
        const workflowEl = document.getElementById('sysInfoWorkflowTime');
        const deployEl = document.getElementById('sysInfoDeployTime');

        if (lastBar.Date) {
            const dateStr = lastBar.Date.split('T')[0];
            if (dataFetchEl) dataFetchEl.textContent = dateStr + ', 4:05 PM';
            if (workflowEl) workflowEl.textContent = dateStr + ', 4:05 PM';
            if (deployEl) deployEl.textContent = dateStr + ', 4:10 PM';
        }
    }
}

// System Log Management
function getSystemLog() {
    return JSON.parse(localStorage.getItem('systemLog') || '[]');
}

function saveSystemLog(log) {
    // Keep only last 20 entries
    const trimmed = log.slice(-20);
    localStorage.setItem('systemLog', JSON.stringify(trimmed));
}

function addSystemLogEntry(event, status) {
    const log = getSystemLog();
    const now = new Date();
    const dateTime = now.toLocaleString('en-US', {
        month: 'numeric', day: 'numeric', year: 'numeric',
        hour: 'numeric', minute: '2-digit', hour12: true
    });

    // Avoid duplicate entries within 1 minute
    const lastEntry = log[log.length - 1];
    if (lastEntry && lastEntry.event === event) {
        const lastTime = new Date(lastEntry.timestamp);
        if (now - lastTime < 60000) return; // Skip if less than 1 minute
    }

    log.push({
        timestamp: now.toISOString(),
        dateTime: dateTime,
        event: event,
        status: status
    });

    saveSystemLog(log);
    renderSystemLog();
}

function renderSystemLog() {
    const log = getSystemLog();
    const tbody = document.getElementById('systemLogBody');
    if (!tbody) return;

    if (log.length === 0) {
        tbody.innerHTML = `<tr>
            <td style="padding: 8px; color: var(--muted);">--</td>
            <td style="padding: 8px;">No events logged yet</td>
            <td style="padding: 8px;"><span></span> Waiting</td>
        </tr>`;
        return;
    }

    // Show last 10 entries, newest first
    const recent = log.slice(-10).reverse();
    tbody.innerHTML = recent.map(entry => {
        const statusIcon = entry.status === 'success' ? '' : (entry.status === 'warning' ? '' : '');
        const statusText = entry.status === 'success' ? 'Success' : (entry.status === 'warning' ? 'Warning' : 'Error');
        return `<tr>
            <td style="padding: 8px; color: var(--muted); font-size: 10px;">${entry.dateTime}</td>
            <td style="padding: 8px;">${entry.event}</td>
            <td style="padding: 8px;"><span>${statusIcon}</span> ${statusText}</td>
        </tr>`;
    }).join('');
}

function clearSystemLog() {
    localStorage.removeItem('systemLog');
    renderSystemLog();
}

function renderHealthAlerts() {
    const container = document.getElementById('healthAlerts');
    
    if (healthStatus.alerts.length === 0) {
        container.innerHTML = `
            <div class="health-alert success">
                <span class="alert-icon"></span>
                <span>No issues detected - system running normally</span>
            </div>
        `;
        return;
    }
    
    let html = '';
    healthStatus.alerts.forEach(alert => {
        const iconMap = { critical: '', warning: '', info: '', success: '' };
        html += `
            <div class="health-alert ${alert.type}">
                <span class="alert-icon">${iconMap[alert.type] || ''}</span>
                <span>${alert.message}</span>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Helper functions
function getETOffset() {
    // Rough ET offset (doesn't account for DST perfectly)
    const now = new Date();
    const jan = new Date(now.getFullYear(), 0, 1);
    const jul = new Date(now.getFullYear(), 6, 1);
    const stdOffset = Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
    const isDST = now.getTimezoneOffset() < stdOffset;
    return isDST ? -4 * 60 * 60 * 1000 : -5 * 60 * 60 * 1000;
}

function getNextMarketDay(fromDate) {
    const next = new Date(fromDate);
    next.setDate(next.getDate() + 1);
    
    // Skip weekends
    while (next.getDay() === 0 || next.getDay() === 6) {
        next.setDate(next.getDate() + 1);
    }
    
    return next;
}

function isWeekendGap(lastDate, currentDate) {
    const lastDay = lastDate.getDay();
    const diff = Math.floor((currentDate - lastDate) / (1000 * 60 * 60 * 24));
    
    // If last data was Friday and it's been 2-3 days, it's a weekend gap
    if (lastDay === 5 && diff <= 3) return true;
    
    return false;
}

function toggleTroubleshoot(header) {
    const content = header.nextElementSibling;
    const toggle = header.querySelector('.troubleshoot-toggle');
    
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        toggle.textContent = '+';
    } else {
        content.classList.add('show');
        toggle.textContent = '';
    }
}

function updateHeaderHealthBadge() {
    const badge = document.getElementById('headerHealthBadge');
    const dot = document.getElementById('headerHealthDot');
    const text = document.getElementById('headerHealthText');
    
    if (!badge) return;
    
    const statuses = [healthStatus.dataFreshness, healthStatus.dataQuality, healthStatus.workflowStatus];
    
    if (statuses.includes('critical')) {
        badge.className = 'status-badge critical';
        badge.style.background = 'rgba(239,68,68,0.3)';
        text.textContent = 'ISSUES';
    } else if (statuses.includes('warning')) {
        badge.className = 'status-badge warning';
        badge.style.background = 'rgba(245,158,11,0.3)';
        text.textContent = 'WARNING';
    } else if (statuses.includes('unknown')) {
        badge.className = 'status-badge';
        badge.style.background = 'rgba(255,255,255,0.2)';
        text.textContent = 'CHECKING';
    } else {
        badge.className = 'status-badge online';
        badge.style.background = 'rgba(16,185,129,0.3)';
        text.textContent = 'HEALTHY';
    }
}

function switchToHealthTab() {
    // Activate health tab
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    const healthTab = document.querySelector('[data-tab="health"]');
    const healthContent = document.getElementById('health');
    
    if (healthTab) healthTab.classList.add('active');
    if (healthContent) healthContent.classList.add('active');
    
    // Run health check when switching
    runHealthCheck();
}

// ============================================
// ENHANCED MULTI-CHARTS SYSTEM
// ============================================

let lwChartInstances = { intraday: null, swing: null, position: null };
let mtfChartData = { intraday: [], swing: [], position: [] };

function toggleMTFSettings(panel) {
    const el = document.getElementById(`${panel}Settings`);
    if (el) el.classList.toggle('show');
}

function getMTFSettings(panel) {
    return {
        showEMA: document.getElementById(`${panel}ShowEMA`)?.checked ?? true,
        showFib: document.getElementById(`${panel}ShowFib`)?.checked ?? true,
        showPatterns: document.getElementById(`${panel}ShowPatterns`)?.checked ?? true,
        showVolume: document.getElementById(`${panel}ShowVolume`)?.checked ?? true
    };
}

function initMultiCharts() {
    console.log('Initializing enhanced multi-charts...');
    updateAllMultiCharts();
}

// Sync all Multi-Charts displays with the current symbol (uses global currentSymbol)
function syncChartsWithSymbol() {
    const symbol = currentSymbol || 'SPY';

    // Update all chart panel symbol displays
    ['intraday', 'swing', 'position'].forEach(panel => {
        const symbolEl = document.getElementById(`${panel}Symbol`);
        if (symbolEl) symbolEl.textContent = symbol;
    });

    // Update chart titles if they exist
    document.querySelectorAll('.chart-title .symbol, .chart-header .symbol').forEach(el => {
        el.textContent = symbol;
    });

    // Update MTF summary title to include symbol
    const mtfTitle = document.querySelector('.mtf-summary-title');
    if (mtfTitle) {
        mtfTitle.textContent = ` ${symbol} Multi-Timeframe Bias Summary`;
    }

    console.log(` Charts synced with symbol: ${symbol}`);
}

async function updateAllMultiCharts() {
    const symbol = currentSymbol || 'SPY';

    // Sync all symbol displays first
    syncChartsWithSymbol();

    // Then update charts
    await updateChart('intraday');
    await updateChart('swing');
    await updateChart('position');

    // Update Trend Direction Log
    if (typeof updateTrendLog === 'function') {
        updateTrendLog();
    }
}

function refreshAllCharts() {
    updateAllMultiCharts();
    updateSectionTimestamp('multiCharts');
}

async function updateChart(panelType) {
    const symbol = currentSymbol || 'SPY';
    const timeframe = document.getElementById(`${panelType}Timeframe`)?.value;
    const chartType = document.getElementById(`${panelType}ChartType`)?.value;
    const container = document.getElementById(`${panelType}ChartContainer`);
    const loading = document.getElementById(`${panelType}Loading`);
    const settings = getMTFSettings(panelType);
    
    if (loading) loading.style.display = 'block';
    
    try {
        let data = getMultiChartData(panelType, timeframe);
        mtfChartData[panelType] = data;
        
        if (!data || data.length === 0) {
            if (loading) loading.textContent = 'No data available';
            return;
        }
        
        if (chartType === 'heikinashi') {
            data = convertToHeikinAshi(data);
        }
        
        if (chartType === 'pf') {
            renderEnhancedPF(panelType, mtfChartData[panelType], container, settings);
            document.getElementById(`${panelType}Legend`).style.display = 'none';
        } else {
            renderLWChart(panelType, data, chartType, container, settings);
            document.getElementById(`${panelType}Legend`).style.display = 'flex';
        }
        
        // Update price display
        const lastBar = data[data.length - 1];
        const priceEl = document.getElementById(`${panelType}Price`);
        if (priceEl && lastBar) {
            priceEl.textContent = `$${lastBar.close.toFixed(2)}`;
            priceEl.className = lastBar.close >= lastBar.open ? 'price' : 'price down';
        }
        
        // Update signal and bias
        const signal = lastBar.close > (data[data.length - 2]?.close || lastBar.close) ? 'CALL' : 'PUT';
        updateMTFSignal(panelType, signal);
        
        // Calculate and display Fibonacci levels
        if (settings.showFib && chartType !== 'pf') {
            displayMTFFib(panelType, data);
        } else {
            document.getElementById(`${panelType}Fib`).innerHTML = '';
        }
        
        if (loading) loading.style.display = 'none';
        
    } catch (error) {
        console.error(`Error updating ${panelType} chart:`, error);
        if (loading) loading.textContent = 'Error loading chart';
    }
}

function updateMTFSignal(panel, signal) {
    const signalEl = document.getElementById(`${panel}Signal`);
    const biasEl = document.getElementById(`${panel}Bias`);
    
    if (signalEl) {
        signalEl.textContent = signal;
        signalEl.className = `signal-badge-mtf ${signal.toLowerCase()}`;
    }
    
    if (biasEl) {
        const bias = signal === 'CALL' ? 'BULLISH' : 'BEARISH';
        biasEl.textContent = bias;
        biasEl.className = `value ${bias.toLowerCase()}`;
    }
    
    // Update overall confluence
    const intraday = document.getElementById('intradaySignal')?.textContent || 'HOLD';
    const swing = document.getElementById('swingSignal')?.textContent || 'HOLD';
    const position = document.getElementById('positionSignal')?.textContent || 'HOLD';
    
    let bullish = 0;
    [intraday, swing, position].forEach(s => { if (s === 'CALL') bullish++; });
    
    const overallEl = document.getElementById('overallBias');
    if (overallEl) {
        overallEl.textContent = `${bullish}/3 ${bullish >= 2 ? 'BULLISH' : 'BEARISH'}`;
        overallEl.className = `value ${bullish >= 2 ? 'bullish' : 'bearish'}`;
    }
}

function displayMTFFib(panelType, data) {
    const high = Math.max(...data.map(d => d.high));
    const low = Math.min(...data.map(d => d.low));
    const range = high - low;
    
    const fib = {
        high: high,
        low: low,
        level382: high - range * 0.382,
        level618: high - range * 0.618
    };
    
    const fibEl = document.getElementById(`${panelType}Fib`);
    if (fibEl) {
        fibEl.innerHTML = `
            <div class="fib-level-mtf resistance">R: $${fib.high.toFixed(2)}</div>
            <div class="fib-level-mtf resistance">38.2%: $${fib.level382.toFixed(2)}</div>
            <div class="fib-level-mtf support">61.8%: $${fib.level618.toFixed(2)}</div>
            <div class="fib-level-mtf support">S: $${fib.low.toFixed(2)}</div>
        `;
    }
}

function renderLWChart(panelType, data, chartType, container, settings) {
    // Clear existing chart
    if (lwChartInstances[panelType]) {
        lwChartInstances[panelType].remove();
        lwChartInstances[panelType] = null;
    }
    container.innerHTML = '';
    
    // Check if LightweightCharts is available
    if (typeof LightweightCharts === 'undefined') {
        console.warn('LightweightCharts not loaded, falling back to basic chart');
        renderFallbackChart(panelType, data, chartType, container);
        return;
    }
    
    const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: container.clientHeight || 350,
        layout: { background: { color: '#ffffff' }, textColor: '#333' },
        grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
        rightPriceScale: { borderColor: '#e0e0e0' },
        timeScale: { borderColor: '#e0e0e0', timeVisible: true }
    });
    
    lwChartInstances[panelType] = chart;
    
    // Convert data to LightweightCharts format
    const lwData = data.map((bar, i) => ({
        time: Math.floor(Date.now() / 1000) - (data.length - i) * 86400,
        open: bar.open,
        high: bar.high,
        low: bar.low,
        close: bar.close
    }));
    
    let mainSeries;
    if (chartType === 'line') {
        mainSeries = chart.addLineSeries({ color: '#2962FF', lineWidth: 2 });
        mainSeries.setData(lwData.map(d => ({ time: d.time, value: d.close })));
    } else {
        mainSeries = chart.addCandlestickSeries({
            upColor: chartType === 'heikinashi' ? '#4caf50' : '#26a69a',
            downColor: chartType === 'heikinashi' ? '#f44336' : '#ef5350',
            borderVisible: false,
            wickUpColor: chartType === 'heikinashi' ? '#4caf50' : '#26a69a',
            wickDownColor: chartType === 'heikinashi' ? '#f44336' : '#ef5350'
        });
        mainSeries.setData(lwData);
    }
    
    // Add EMAs if enabled
    if (settings.showEMA) {
        const ema9 = calculateEMAForLW(data, 9);
        const ema21 = calculateEMAForLW(data, 21);
        const ema50 = calculateEMAForLW(data, 50);
        
        const ema9Data = ema9.map((val, i) => ({ time: lwData[i].time, value: val }));
        const ema21Data = ema21.map((val, i) => ({ time: lwData[i].time, value: val }));
        const ema50Data = ema50.map((val, i) => ({ time: lwData[i].time, value: val }));
        
        chart.addLineSeries({ color: '#f59e0b', lineWidth: 1, crosshairMarkerVisible: false, priceLineVisible: false, lastValueVisible: false }).setData(ema9Data);
        chart.addLineSeries({ color: '#3b82f6', lineWidth: 1, crosshairMarkerVisible: false, priceLineVisible: false, lastValueVisible: false }).setData(ema21Data);
        chart.addLineSeries({ color: '#8b5cf6', lineWidth: 1, crosshairMarkerVisible: false, priceLineVisible: false, lastValueVisible: false }).setData(ema50Data);
    }
    
    // Add volume if enabled
    if (settings.showVolume) {
        const volSeries = chart.addHistogramSeries({
            priceFormat: { type: 'volume' },
            priceScaleId: '',
            scaleMargins: { top: 0.85, bottom: 0 }
        });
        volSeries.setData(lwData.map((d, i) => ({
            time: d.time,
            value: data[i].volume || 1000000,
            color: d.close >= d.open ? 'rgba(38,166,154,0.5)' : 'rgba(239,83,80,0.5)'
        })));
    }
    
    chart.timeScale().fitContent();
}

function calculateEMAForLW(data, period) {
    const k = 2 / (period + 1);
    const result = [];
    let ema = data[0]?.close || 0;
    
    for (let i = 0; i < data.length; i++) {
        ema = i === 0 ? data[i].close : data[i].close * k + ema * (1 - k);
        result.push(ema);
    }
    return result;
}

function renderFallbackChart(panelType, data, chartType, container) {
    // Create canvas for fallback
    container.innerHTML = '<canvas style="width:100%;height:100%"></canvas>';
    const canvas = container.querySelector('canvas');
    renderMultiCandlestickChart(panelType, data, chartType, canvas);
}

// P&F Pattern Detection
function detectPFPatterns(columns) {
    if (columns.length < 3) return { pattern: null, signal: 'HOLD' };
    
    const patterns = [];
    const len = columns.length;
    const c1 = columns[len - 1];
    const c3 = len >= 3 ? columns[len - 3] : null;
    const c5 = len >= 5 ? columns[len - 5] : null;
    
    if (c3 && c1.type === 'X' && c3.type === 'X') {
        const c1High = Math.max(...c1.boxes);
        const c3High = Math.max(...c3.boxes);
        if (c1High > c3High) {
            patterns.push({ name: 'Double Top Breakout', type: 'bullish', strength: 85 });
        }
    }
    
    if (c3 && c1.type === 'O' && c3.type === 'O') {
        const c1Low = Math.min(...c1.boxes);
        const c3Low = Math.min(...c3.boxes);
        if (c1Low < c3Low) {
            patterns.push({ name: 'Double Bottom Breakdown', type: 'bearish', strength: 85 });
        }
    }
    
    if (c5 && c1.type === 'X' && c3.type === 'X' && c5.type === 'X') {
        const c1High = Math.max(...c1.boxes);
        const c3High = Math.max(...c3.boxes);
        const c5High = Math.max(...c5.boxes);
        if (c1High > c3High && c1High > c5High) {
            patterns.push({ name: 'Triple Top Breakout', type: 'bullish', strength: 95 });
        }
    }
    
    if (c5 && c1.type === 'O' && c3.type === 'O' && c5.type === 'O') {
        const c1Low = Math.min(...c1.boxes);
        const c3Low = Math.min(...c3.boxes);
        const c5Low = Math.min(...c5.boxes);
        if (c1Low < c3Low && c1Low < c5Low) {
            patterns.push({ name: 'Triple Bottom Breakdown', type: 'bearish', strength: 95 });
        }
    }
    
    if (patterns.length === 0) {
        patterns.push(c1.type === 'X' 
            ? { name: 'Uptrend in Progress', type: 'bullish', strength: 60 }
            : { name: 'Downtrend in Progress', type: 'bearish', strength: 60 });
    }
    
    const strongest = patterns.sort((a, b) => b.strength - a.strength)[0];
    return { pattern: strongest, signal: strongest.type === 'bullish' ? 'CALL' : 'PUT' };
}

function renderEnhancedPF(panelType, data, container, settings) {
    if (lwChartInstances[panelType]) {
        lwChartInstances[panelType].remove();
        lwChartInstances[panelType] = null;
    }
    
    container.innerHTML = '';
    const canvas = document.createElement('canvas');
    canvas.width = container.clientWidth || 400;
    canvas.height = container.clientHeight || 350;
    container.appendChild(canvas);
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width, height = canvas.height;
    
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, width, height);
    
    if (!data || data.length < 10) {
        ctx.fillStyle = '#666';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Not enough data for P&F', width/2, height/2);
        return;
    }
    
    // Calculate box size
    const avgPrice = data.reduce((s, b) => s + b.close, 0) / data.length;
    let boxSize = avgPrice < 5 ? 0.25 : avgPrice < 20 ? 0.5 : avgPrice < 100 ? 1 : avgPrice < 200 ? 2 : avgPrice < 500 ? 4 : 8;
    if (panelType === 'intraday') boxSize *= 0.5;
    if (panelType === 'position') boxSize *= 1.5;
    
    const columns = generatePFCols(data, boxSize, 3);
    const patternResult = detectPFPatterns(columns);
    
    // Display pattern alert
    const patternEl = document.getElementById(`${panelType}Pattern`);
    if (settings.showPatterns && patternResult.pattern) {
        patternEl.style.display = 'block';
        patternEl.className = `pattern-alert-mtf ${patternResult.pattern.type}`;
        patternEl.innerHTML = `${patternResult.pattern.type === 'bullish' ? '' : ''} <strong>${patternResult.pattern.name}</strong> <span style="float:right;">Strength: ${patternResult.pattern.strength}%</span>`;
        updateMTFSignal(panelType, patternResult.signal);
    } else {
        patternEl.style.display = 'none';
    }
    
    if (columns.length === 0) {
        ctx.fillStyle = '#666';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No P&F reversals', width/2, height/2);
        return;
    }
    
    // Find price range
    let minP = Infinity, maxP = -Infinity;
    columns.forEach(c => c.boxes.forEach(p => { minP = Math.min(minP, p); maxP = Math.max(maxP, p); }));
    minP -= boxSize * 2;
    maxP += boxSize * 2;
    
    const pad = { top: 40, right: 50, bottom: 20, left: 50 };
    const cw = width - pad.left - pad.right;
    const ch = height - pad.top - pad.bottom;
    const maxCols = Math.min(columns.length, 35);
    const dispCols = columns.slice(-maxCols);
    const colW = Math.min(14, cw / dispCols.length);
    
    // Draw grid
    ctx.strokeStyle = '#f0f0f0';
    ctx.lineWidth = 0.5;
    for (let p = minP; p <= maxP; p += boxSize) {
        const y = pad.top + ch - ((p - minP) / (maxP - minP)) * ch;
        ctx.beginPath();
        ctx.moveTo(pad.left, y);
        ctx.lineTo(width - pad.right, y);
        ctx.stroke();
    }
    
    // Draw price labels
    ctx.fillStyle = '#666';
    ctx.font = '9px Arial';
    ctx.textAlign = 'right';
    const step = Math.max(1, Math.floor((maxP - minP) / boxSize / 10)) * boxSize;
    for (let p = Math.ceil(minP / step) * step; p <= maxP; p += step) {
        const y = pad.top + ch - ((p - minP) / (maxP - minP)) * ch;
        ctx.fillText(p.toFixed(0), pad.left - 5, y + 3);
    }
    
    // Draw X's and O's
    const fs = Math.max(8, Math.min(12, colW - 1));
    ctx.font = `bold ${fs}px Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    dispCols.forEach((col, i) => {
        const x = pad.left + (i + 0.5) * colW;
        col.boxes.forEach(price => {
            const y = pad.top + ch - ((price - minP) / (maxP - minP)) * ch;
            ctx.fillStyle = col.type === 'X' ? '#26a69a' : '#ef5350';
            ctx.fillText(col.type, x, y);
        });
    });
    
    // Title
    ctx.fillStyle = '#333';
    ctx.font = 'bold 11px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('Point & Figure Chart', pad.left, 15);
    ctx.font = '10px Arial';
    ctx.fillStyle = '#666';
    ctx.fillText(`Box: $${boxSize.toFixed(2)} | Rev: 3`, pad.left + 110, 15);
    
    // Pattern name
    if (settings.showPatterns && patternResult.pattern) {
        ctx.font = 'bold 10px Arial';
        ctx.fillStyle = patternResult.pattern.type === 'bullish' ? '#059669' : '#dc2626';
        ctx.textAlign = 'center';
        ctx.fillText(patternResult.pattern.name, width / 2, 30);
    }
}

function getMultiChartData(panelType, timeframe) {
    if (!currentData || currentData.length === 0) return [];
    
    let data = currentData.map(bar => ({
        date: bar.Date,
        open: parseFloat(bar.Open) || 0,
        high: parseFloat(bar.High) || 0,
        low: parseFloat(bar.Low) || 0,
        close: parseFloat(bar.Close) || 0,
        volume: parseFloat(bar.Volume) || 0
    })).filter(bar => bar.close > 0);
    
    if (panelType === 'intraday') {
        return simulateIntradayBars(data.slice(-5), parseInt(timeframe) || 15);
    }
    
    if (panelType === 'swing') {
        if (timeframe === 'W') return aggregateWeekly(data);
        return data.slice(-60);
    }
    
    if (panelType === 'position') {
        if (timeframe === 'Q') return aggregateQuarterly(data);
        return aggregateMonthly(data);
    }
    
    return data;
}

function simulateIntradayBars(dailyData, minutes) {
    const intradayBars = [];
    const barsPerDay = Math.floor(390 / minutes);
    
    dailyData.forEach(day => {
        const range = day.high - day.low;
        for (let i = 0; i < barsPerDay; i++) {
            const progress = i / barsPerDay;
            const basePrice = day.open + (day.close - day.open) * progress;
            const noise = (Math.random() - 0.5) * range * 0.3;
            
            const open = i === 0 ? day.open : intradayBars[intradayBars.length - 1]?.close || basePrice;
            const close = basePrice + noise;
            
            intradayBars.push({
                date: day.date,
                time: `${Math.floor(9.5 + (i * minutes) / 60)}:${String((30 + i * minutes) % 60).padStart(2, '0')}`,
                open: open,
                high: Math.max(open, close) + Math.random() * range * 0.1,
                low: Math.min(open, close) - Math.random() * range * 0.1,
                close: close,
                volume: day.volume / barsPerDay
            });
        }
    });
    return intradayBars.slice(-50);
}

function aggregateWeekly(dailyData) {
    const weeks = {};
    dailyData.forEach(bar => {
        const date = new Date(bar.date);
        const weekStart = new Date(date);
        weekStart.setDate(date.getDate() - date.getDay());
        const weekKey = weekStart.toISOString().split('T')[0];
        
        if (!weeks[weekKey]) {
            weeks[weekKey] = { date: weekKey, open: bar.open, high: bar.high, low: bar.low, close: bar.close, volume: bar.volume };
        } else {
            weeks[weekKey].high = Math.max(weeks[weekKey].high, bar.high);
            weeks[weekKey].low = Math.min(weeks[weekKey].low, bar.low);
            weeks[weekKey].close = bar.close;
            weeks[weekKey].volume += bar.volume;
        }
    });
    return Object.values(weeks).slice(-30);
}

function aggregateMonthly(dailyData) {
    const months = {};
    dailyData.forEach(bar => {
        const date = new Date(bar.date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        
        if (!months[monthKey]) {
            months[monthKey] = { date: monthKey + '-01', open: bar.open, high: bar.high, low: bar.low, close: bar.close, volume: bar.volume };
        } else {
            months[monthKey].high = Math.max(months[monthKey].high, bar.high);
            months[monthKey].low = Math.min(months[monthKey].low, bar.low);
            months[monthKey].close = bar.close;
            months[monthKey].volume += bar.volume;
        }
    });
    return Object.values(months).slice(-24);
}

function aggregateQuarterly(dailyData) {
    const quarters = {};
    dailyData.forEach(bar => {
        const date = new Date(bar.date);
        const quarter = Math.floor(date.getMonth() / 3) + 1;
        const quarterKey = `${date.getFullYear()}-Q${quarter}`;
        
        if (!quarters[quarterKey]) {
            quarters[quarterKey] = { date: `${date.getFullYear()}-${String((quarter - 1) * 3 + 1).padStart(2, '0')}-01`, open: bar.open, high: bar.high, low: bar.low, close: bar.close, volume: bar.volume };
        } else {
            quarters[quarterKey].high = Math.max(quarters[quarterKey].high, bar.high);
            quarters[quarterKey].low = Math.min(quarters[quarterKey].low, bar.low);
            quarters[quarterKey].close = bar.close;
            quarters[quarterKey].volume += bar.volume;
        }
    });
    return Object.values(quarters).slice(-12);
}

function convertToHeikinAshi(data) {
    if (!data || data.length === 0) return [];
    const haData = [];
    
    data.forEach((bar, i) => {
        const haBar = { ...bar };
        if (i === 0) {
            haBar.open = (bar.open + bar.close) / 2;
            haBar.close = (bar.open + bar.high + bar.low + bar.close) / 4;
        } else {
            const prevHA = haData[i - 1];
            haBar.open = (prevHA.open + prevHA.close) / 2;
            haBar.close = (bar.open + bar.high + bar.low + bar.close) / 4;
        }
        haBar.high = Math.max(bar.high, haBar.open, haBar.close);
        haBar.low = Math.min(bar.low, haBar.open, haBar.close);
        haData.push(haBar);
    });
    return haData;
}

function generatePFCols(data, boxSize, reversal) {
    if (!data || data.length === 0) return [];
    
    const columns = [];
    let currentCol = { type: 'X', boxes: [Math.floor(data[0].close / boxSize) * boxSize] };
    
    data.forEach(bar => {
        const high = Math.floor(bar.high / boxSize) * boxSize;
        const low = Math.floor(bar.low / boxSize) * boxSize;
        const lastBox = currentCol.boxes[currentCol.boxes.length - 1];
        
        if (currentCol.type === 'X') {
            if (high > lastBox) {
                for (let p = lastBox + boxSize; p <= high; p += boxSize) currentCol.boxes.push(p);
            } else if (lastBox - low >= reversal * boxSize) {
                columns.push(currentCol);
                currentCol = { type: 'O', boxes: [] };
                for (let p = lastBox - boxSize; p >= low; p -= boxSize) currentCol.boxes.push(p);
            }
        } else {
            if (low < lastBox) {
                for (let p = lastBox - boxSize; p >= low; p -= boxSize) currentCol.boxes.push(p);
            } else if (high - lastBox >= reversal * boxSize) {
                columns.push(currentCol);
                currentCol = { type: 'X', boxes: [] };
                for (let p = lastBox + boxSize; p <= high; p += boxSize) currentCol.boxes.push(p);
            }
        }
    });
    
    if (currentCol.boxes.length > 0) columns.push(currentCol);
    return columns.slice(-30);
}

// Keep old function for fallback
function renderMultiCandlestickChart(panelType, data, chartType, canvas) {
    const ctx = canvas.getContext('2d');
    
    if (multiChartInstances && multiChartInstances[panelType]) {
        multiChartInstances[panelType].destroy();
    }
    
    const labels = data.map((bar, i) => {
        if (bar.time) return bar.time;
        const dateStr = (bar.date || bar.Date || '').split('T')[0].split(' ')[0];
        return dateStr.slice(5);
    });
    
    const upColor = chartType === 'heikinashi' ? '#4caf50' : '#26a69a';
    const downColor = chartType === 'heikinashi' ? '#f44336' : '#ef5350';
    
    if (typeof Chart !== 'undefined') {
        multiChartInstances[panelType] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Price',
                    data: data.map(bar => bar.close),
                    backgroundColor: data.map(bar => bar.close >= bar.open ? upColor : downColor),
                    borderColor: data.map(bar => bar.close >= bar.open ? upColor : downColor),
                    borderWidth: 1,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: '#787b86', maxTicksLimit: 8, font: { size: 9 } } },
                    y: { display: true, position: 'right', grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: '#787b86', font: { size: 9 } } }
                }
            }
        });
    }
}

// Initialize multi-charts when tab is clicked
document.addEventListener('DOMContentLoaded', function() {
    const multiChartsTab = document.querySelector('[data-tab="multi-charts"]');
    if (multiChartsTab) {
        multiChartsTab.addEventListener('click', function() {
            setTimeout(initMultiCharts, 100);
            setTimeout(updateTrendLog, 200);
        });
    }
});

// ============================================
// TREND DIRECTION LOG SYSTEM
// ============================================

const TREND_STORAGE_KEY = 'q5d_trend_history';
const MAX_TREND_DAYS = 30;

// Get trend history from localStorage
function getTrendHistory() {
    try {
        const stored = localStorage.getItem(TREND_STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
    } catch (e) {
        console.warn('Error reading trend history:', e);
        return [];
    }
}

// Save trend history to localStorage
function saveTrendHistory(history) {
    try {
        // Keep only last 30 days
        const trimmed = history.slice(-MAX_TREND_DAYS);
        localStorage.setItem(TREND_STORAGE_KEY, JSON.stringify(trimmed));
    } catch (e) {
        console.warn('Error saving trend history:', e);
    }
}

// Log today's trend reading
function logDailyTrend() {
    const today = new Date().toISOString().split('T')[0];
    const history = getTrendHistory();

    // Check if already logged today
    if (history.some(h => h.date === today)) {
        console.log('Trend already logged for today');
        return;
    }

    // Get current bias readings from MTF Summary
    const intradayEl = document.getElementById('intradayBias');
    const swingEl = document.getElementById('swingBias');
    const positionEl = document.getElementById('positionBias');

    const intraday = intradayEl?.textContent?.includes('BULL') ? 'BULL' : 'BEAR';
    const swing = swingEl?.textContent?.includes('BULL') ? 'BULL' : 'BEAR';
    const position = positionEl?.textContent?.includes('BULL') ? 'BULL' : 'BEAR';

    // Calculate score: +1 for each BULL, -1 for each BEAR
    const score = (intraday === 'BULL' ? 1 : -1) + (swing === 'BULL' ? 1 : -1) + (position === 'BULL' ? 1 : -1);
    const bullCount = [intraday, swing, position].filter(b => b === 'BULL').length;

    const entry = {
        date: today,
        intraday,
        swing,
        position,
        score,
        bullCount,
        finalDirection: bullCount >= 2 ? 'CALL' : 'PUT'
    };

    history.push(entry);
    saveTrendHistory(history);
    console.log('Logged trend for today:', entry);
}

// Calculate current streak
function calculateTrendStreak(history) {
    if (!history || history.length === 0) return { days: 0, direction: 'NEUTRAL' };

    const sorted = [...history].sort((a, b) => b.date.localeCompare(a.date));
    const latestDirection = sorted[0].finalDirection;
    let streak = 0;

    for (const entry of sorted) {
        if (entry.finalDirection === latestDirection) {
            streak++;
        } else {
            break;
        }
    }

    return { days: streak, direction: latestDirection === 'CALL' ? 'BULLISH' : 'BEARISH' };
}

// Render the visual trend chart (bar chart)
function renderTrendChart(history) {
    const container = document.getElementById('trendChartContainer');
    if (!container) return;

    // Take last 14 days
    const last14 = history.slice(-14);
    if (last14.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--muted); font-size: 11px; padding: 20px;">No trend data yet. Data will accumulate over time.</div>';
        return;
    }

    // Create bars
    const maxHeight = 60; // pixels
    let html = '';

    last14.forEach((entry, i) => {
        const score = entry.score; // -3 to +3
        const height = Math.abs(score) * (maxHeight / 3);
        const color = score > 0 ? 'var(--success)' : score < 0 ? 'var(--danger)' : 'var(--muted)';
        const dateLabel = entry.date.slice(5); // MM-DD

        html += `
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                <div style="width: 100%; max-width: 20px; height: ${height}px; background: ${color}; border-radius: 2px 2px 0 0;" title="${entry.date}: ${score > 0 ? '+' : ''}${score}"></div>
                <div style="font-size: 8px; color: var(--muted); margin-top: 2px;">${dateLabel}</div>
            </div>
        `;
    });

    container.innerHTML = html;

    // Update date labels
    const startDateEl = document.getElementById('trendChartStartDate');
    const endDateEl = document.getElementById('trendChartEndDate');
    if (startDateEl && last14.length > 0) startDateEl.textContent = last14[0].date;
    if (endDateEl) endDateEl.textContent = 'Today';
}

// Update the trend log table
function updateTrendLogTable(history) {
    const table = document.getElementById('trendLogTable');
    if (!table) return;

    // Sort by date descending (most recent first)
    const sorted = [...history].sort((a, b) => b.date.localeCompare(a.date)).slice(0, 14);

    if (sorted.length === 0) {
        table.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--muted); padding: 20px;">No trend history yet</td></tr>';
        return;
    }

    let html = '';
    sorted.forEach(entry => {
        const intradayIcon = entry.intraday === 'BULL' ? '' : '';
        const swingIcon = entry.swing === 'BULL' ? '' : '';
        const positionIcon = entry.position === 'BULL' ? '' : '';
        const finalIcon = entry.bullCount === 3 ? '' : entry.bullCount === 0 ? '' : '';
        const finalText = `${entry.bullCount}/3 ${entry.finalDirection}`;
        const dateDisplay = entry.date.slice(5); // MM-DD

        html += `
            <tr>
                <td style="padding: 8px;">${dateDisplay}</td>
                <td style="padding: 8px; text-align: center;">${intradayIcon} ${entry.intraday}</td>
                <td style="padding: 8px; text-align: center;">${swingIcon} ${entry.swing}</td>
                <td style="padding: 8px; text-align: center;">${positionIcon} ${entry.position}</td>
                <td style="padding: 8px; text-align: center; font-weight: 600;">${finalIcon} ${finalText}</td>
            </tr>
        `;
    });

    table.innerHTML = html;
}

// Update trend statistics
function updateTrendStats(history) {
    const last14 = history.slice(-14);

    // Current streak
    const streak = calculateTrendStreak(history);
    const streakEl = document.getElementById('trendStreak');
    if (streakEl) {
        const icon = streak.direction === 'BULLISH' ? '' : streak.direction === 'BEARISH' ? '' : '';
        streakEl.innerHTML = `${streak.days} days ${streak.direction} ${icon}`;
        streakEl.style.color = streak.direction === 'BULLISH' ? 'var(--success)' : streak.direction === 'BEARISH' ? 'var(--danger)' : 'var(--muted)';
    }

    // Last 14 days breakdown
    const bullDays = last14.filter(e => e.finalDirection === 'CALL').length;
    const bearDays = last14.length - bullDays;
    const last14El = document.getElementById('trendLast14');
    if (last14El) {
        last14El.textContent = `${bullDays} Bull, ${bearDays} Bear`;
    }

    // Dominant trend
    const dominantEl = document.getElementById('trendDominant');
    if (dominantEl && last14.length > 0) {
        const pct = Math.round((bullDays / last14.length) * 100);
        const dominant = bullDays > bearDays ? 'BULLISH' : bullDays < bearDays ? 'BEARISH' : 'NEUTRAL';
        dominantEl.textContent = `${dominant} (${pct}%)`;
        dominantEl.style.color = dominant === 'BULLISH' ? 'var(--success)' : dominant === 'BEARISH' ? 'var(--danger)' : 'var(--muted)';
    }

    // Average alignment
    const avgAlignEl = document.getElementById('trendAvgAlignment');
    if (avgAlignEl && last14.length > 0) {
        const avgBullCount = last14.reduce((sum, e) => sum + e.bullCount, 0) / last14.length;
        avgAlignEl.textContent = `${avgBullCount.toFixed(1)}/3`;
    }
}

// Main function to update the entire Trend Log section
function updateTrendLog() {
    // First, try to log today's trend if not already logged
    logDailyTrend();

    // Get history
    const history = getTrendHistory();

    // Update all components
    updateTrendStats(history);
    renderTrendChart(history);
    updateTrendLogTable(history);
}

// Also update trend log when data changes
function refreshTrendLog() {
    // Re-log today's data (will update if readings changed)
    const today = new Date().toISOString().split('T')[0];
    let history = getTrendHistory();

    // Remove today's entry if it exists (to re-log with updated data)
    history = history.filter(h => h.date !== today);
    saveTrendHistory(history);

    // Now log fresh data
    updateTrendLog();
}


// ============================================
// DAILY ANALYSIS SYSTEM
// ============================================

let currentAnalysisMode = 'morning';
let currentTradeMode = 'intraday';    
let dailyAnalysisData = null;

// Initialize Daily Analysis when tab is clicked
document.addEventListener('DOMContentLoaded', function() {
    const analysisTab = document.querySelector('[data-tab="daily-analysis"]');
    if (analysisTab) {
        analysisTab.addEventListener('click', async function() {
            await loadRealAgentSignals();
            setTimeout(generateDailyReport, 100);
        });
    }
    
    // Pre-load agent signals on page load
    loadRealAgentSignals();
    
    // Auto-generate reports at scheduled times
    checkScheduledAnalysis();
    setInterval(checkScheduledAnalysis, 60000); // Check every minute
});

function checkScheduledAnalysis() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    
    // Morning analysis at 9:35 AM
    if (hours === 9 && minutes === 35) {
        currentAnalysisMode = 'morning';
        generateDailyReport();
    }
    
    // Evening analysis at 6:00 PM
    if (hours === 18 && minutes === 0) {
        currentAnalysisMode = 'evening';
        generateDailyReport();
    }
}

function switchAnalysisMode(mode) {
    currentAnalysisMode = mode;

    const dailyAnalysisMain = document.getElementById('dailyAnalysisMain');
    const tradingPlanContainer = document.getElementById('tradingPlanContainer');
    const eveningReviewSection = document.getElementById('eveningReviewSection');
    const intradaySwingBtns = document.getElementById('intradaySwingContainer');

    // Update button states
    document.getElementById('morningBtn')?.classList.toggle('active', mode === 'morning');
    document.getElementById('eveningBtn')?.classList.toggle('active', mode === 'evening');

    // Show/hide sections based on mode
    if (mode === 'main') {
        if (dailyAnalysisMain) dailyAnalysisMain.style.display = 'block';
        if (tradingPlanContainer) tradingPlanContainer.style.display = 'none';
        if (eveningReviewSection) eveningReviewSection.style.display = 'none';
        if (intradaySwingBtns) intradaySwingBtns.style.display = 'none';
        // Clear active state on morning/evening buttons when in main view
        document.getElementById('morningBtn')?.classList.remove('active');
        document.getElementById('eveningBtn')?.classList.remove('active');
    } else if (mode === 'morning') {
        if (dailyAnalysisMain) dailyAnalysisMain.style.display = 'none';
        if (tradingPlanContainer) tradingPlanContainer.style.display = 'block';
        if (eveningReviewSection) eveningReviewSection.style.display = 'none';
        if (intradaySwingBtns) intradaySwingBtns.style.display = 'flex';
        // Update title
        const planTitle = document.getElementById('planTitle');
        if (planTitle) {
            planTitle.textContent = ' Morning Trading Plan';
        }
        generateDailyReport();
    } else if (mode === 'evening') {
        if (dailyAnalysisMain) dailyAnalysisMain.style.display = 'none';
        if (tradingPlanContainer) tradingPlanContainer.style.display = 'none';
        if (eveningReviewSection) eveningReviewSection.style.display = 'block';
        if (intradaySwingBtns) intradaySwingBtns.style.display = 'none';
        generateDailyReport();
    }
}

function refreshAnalysis() {
    generateDailyReport();
    updateSectionTimestamp('dailyAnalysis');
}

function generateDailyReport() {
    console.log('Generating daily report...', currentAnalysisMode);
    
    if (!currentData || currentData.length === 0) {
        console.warn('No data available for analysis');
        return;
    }
    
    // Get current symbol data
    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close) || 0;
    const prevClose = parseFloat(currentData[currentData.length - 2]?.Close) || price;
    
    // Calculate all signal components
    const signals = calculateAllSignals(currentData, price, prevClose);
    
    // Update the UI
    updateConfluenceScore(signals);
    updateTradeRecommendations(signals);
    updateAgentSignalsTable(signals);
    updateGannAnalysis(price);
    updateFibonacciLevels(currentData);
    updateHighConsensusTrades(signals);
    updateMarketContext(signals);
    updateAISummary(signals, price);
    updatePlanDateTime();

    // Update ATR display in dailyAnalysisMain
    const atr = parseFloat(lastBar.ATR) || price * 0.015;
    const atrEl = document.getElementById('currentATR');
    if (atrEl) atrEl.textContent = '$' + atr.toFixed(2);
    
    // Store for download
    dailyAnalysisData = {
        mode: currentAnalysisMode,
        timestamp: new Date().toISOString(),
        symbol: currentSymbol,
        price: price,
        signals: signals
    };
}

function calculateAllSignals(data, price, prevClose) {
    const signals = {
        agentConsensus: { score: 0, detail: '', count: 0, agentDetails: null, isReal: false },
        barCount: { score: 0, detail: '', count: 0 },
        patterns: { score: 0, detail: '', found: [] },
        gann: { score: 0, detail: '' },
        fibonacci: { score: 0, detail: '', level: '' },
        volume: { score: 0, detail: '' },
        masterScore: 0,
        direction: 'NEUTRAL',
        confidence: 50
    };
    
    // 1. Agent Consensus Score (with individual agent breakdown)
    const agentSignals = getAgentSignals();
    signals.agentConsensus.count = agentSignals.agreeing;
    signals.agentConsensus.score = (agentSignals.agreeing / 4) * 4; // Max 4 points
    signals.agentConsensus.signal = agentSignals.signal;
    signals.agentConsensus.isReal = agentSignals.isReal;
    signals.agentConsensus.agentDetails = agentSignals.agentDetails;
    signals.agentConsensus.timestamp = agentSignals.timestamp;
    signals.agentConsensus.detail = `${agentSignals.agreeing}/4 agents: ${agentSignals.signal}${agentSignals.isReal ? ' (LIVE)' : ' (calc)'}`;
    
    // 2. Bar Count Score
    const barCount = calculateBarCountSignal(data);
    signals.barCount.count = barCount.count;
    signals.barCount.score = Math.min(Math.abs(barCount.count) / 5, 2) * (barCount.count > 0 ? 1 : -1); // Max 2
    signals.barCount.detail = `${barCount.count > 0 ? '+' : ''}${barCount.count} consecutive ${barCount.direction} bars`;
    
    // 3. Pattern Score
    const patterns = detectAllPatterns(data);
    signals.patterns.found = patterns.found;
    signals.patterns.score = patterns.score; // Max 3
    signals.patterns.detail = patterns.found.length > 0 ? patterns.found.join(', ') : 'No patterns detected';
    
    // 4. Gann Cycle Score
    const gann = calculateGannCycleScore(data, price);
    signals.gann.score = gann.score; // Max 2
    signals.gann.detail = gann.detail;
    
    // 5. Fibonacci Score
    const fib = calculateFibonacciScore(data, price);
    signals.fibonacci.score = fib.score; // Max 2
    signals.fibonacci.detail = fib.detail;
    signals.fibonacci.level = fib.level;
    
    // 6. Volume Score
    const volume = calculateVolumeScore(data);
    signals.volume.score = volume.score; // Max 1.5
    signals.volume.detail = volume.detail;
    
    // Calculate Master Score
    signals.masterScore = (
        signals.agentConsensus.score +
        signals.barCount.score +
        signals.patterns.score +
        signals.gann.score +
        signals.fibonacci.score +
        signals.volume.score
    );
    
    // Determine direction and confidence
    if (signals.masterScore >= 3) {
        signals.direction = 'BULLISH';
        signals.confidence = Math.min(50 + signals.masterScore * 5, 95);
    } else if (signals.masterScore <= -3) {
        signals.direction = 'BEARISH';
        signals.confidence = Math.min(50 + Math.abs(signals.masterScore) * 5, 95);
    } else {
        signals.direction = 'NEUTRAL';
        signals.confidence = 50 + Math.abs(signals.masterScore) * 3;
    }
    
    return signals;
}

// Real agent voting data (loaded from voting_log.json)
let realAgentVotes = null;

async function loadRealAgentSignals() {
    // Try multiple paths for voting_log.json
    const paths = ['voting_log.json', 'data/voting_log.json', './voting_log.json'];

    for (const path of paths) {
        try {
            const response = await fetch(path);
            if (response.ok) {
                const data = await response.json();
                realAgentVotes = data;
                console.log(` Loaded real agent signals from ${path}`);
                return true;
            }
        } catch (e) {
            // Try next path
        }
    }

    // Silently fall back to calculated signals - this is expected if file doesn't exist
    console.log(' Using calculated agent signals (voting_log.json not found)');
    return false;
}

function getAgentSignals() {
    // Try to get REAL signals from voting_log.json first
    if (realAgentVotes && realAgentVotes.votes && realAgentVotes.votes.length > 0) {
        const latestVote = realAgentVotes.votes[realAgentVotes.votes.length - 1];
        
        // Parse individual agent signals
        const agentDetails = {
            base: { signal: 'HOLD', confidence: 0 },
            gann: { signal: 'HOLD', confidence: 0 },
            dqn: { signal: 'HOLD', confidence: 0 },
            wave: { signal: 'HOLD', confidence: 0 }
        };
        
        let callCount = 0, putCount = 0, holdCount = 0;
        
        if (latestVote.component_signals) {
            latestVote.component_signals.forEach(sig => {
                const agentName = sig.agent?.toLowerCase() || '';
                const signal = sig.signal?.toUpperCase() || 'HOLD';
                const confidence = sig.confidence || 0;
                
                if (agentName.includes('base') || agentName.includes('confluence')) {
                    agentDetails.base = { signal, confidence };
                } else if (agentName.includes('gann') || agentName.includes('elliott')) {
                    agentDetails.gann = { signal, confidence };
                } else if (agentName.includes('dqn') || agentName.includes('ml')) {
                    agentDetails.dqn = { signal, confidence };
                } else if (agentName.includes('wave') || agentName.includes('3')) {
                    agentDetails.wave = { signal, confidence };
                }
                
                if (signal === 'CALL') callCount++;
                else if (signal === 'PUT') putCount++;
                else holdCount++;
            });
        }
        
        const finalSignal = latestVote.final_signal?.toUpperCase() || 'HOLD';
        const agreementLevel = latestVote.agreement_level || Math.max(callCount, putCount, holdCount);
        
        return { 
            signal: finalSignal, 
            agreeing: agreementLevel, 
            callCount, 
            putCount, 
            holdCount,
            isReal: true,
            agentDetails,
            timestamp: latestVote.timestamp
        };
    }
    
    // FALLBACK: Calculate signals from price data if voting_log.json not available
    let callCount = 0, putCount = 0, holdCount = 0;
    const agentDetails = {
        base: { signal: 'HOLD', confidence: 50 },
        gann: { signal: 'HOLD', confidence: 50 },
        dqn: { signal: 'HOLD', confidence: 50 },
        wave: { signal: 'HOLD', confidence: 50 }
    };
    
    const lastBars = currentData.slice(-5);
    const trend = lastBars[lastBars.length - 1]?.Close > lastBars[0]?.Close;
    const momentum = calculateMomentum(currentData);
    
    // Base Confluence Agent
    if (trend && momentum > 0) {
        callCount++;
        agentDetails.base = { signal: 'CALL', confidence: 60 + momentum * 20 };
    } else if (!trend && momentum < 0) {
        putCount++;
        agentDetails.base = { signal: 'PUT', confidence: 60 + Math.abs(momentum) * 20 };
    } else {
        holdCount++;
        agentDetails.base = { signal: 'HOLD', confidence: 50 };
    }
    
    // Gann-Elliott Agent
    if (trend) {
        callCount++;
        agentDetails.gann = { signal: 'CALL', confidence: 65 };
    } else {
        putCount++;
        agentDetails.gann = { signal: 'PUT', confidence: 65 };
    }
    
    // DQN Agent
    if (momentum > 0.5) {
        callCount++;
        agentDetails.dqn = { signal: 'CALL', confidence: 70 + momentum * 15 };
    } else if (momentum < -0.5) {
        putCount++;
        agentDetails.dqn = { signal: 'PUT', confidence: 70 + Math.abs(momentum) * 15 };
    } else {
        holdCount++;
        agentDetails.dqn = { signal: 'HOLD', confidence: 50 };
    }
    
    // 3-Wave Agent
    if (trend) {
        callCount++;
        agentDetails.wave = { signal: 'CALL', confidence: 60 };
    } else {
        putCount++;
        agentDetails.wave = { signal: 'PUT', confidence: 60 };
    }
    
    const maxCount = Math.max(callCount, putCount, holdCount);
    let signal = 'HOLD';
    let agreeing = holdCount;
    
    if (callCount === maxCount && callCount > putCount) {
        signal = 'CALL';
        agreeing = callCount;
    } else if (putCount === maxCount) {
        signal = 'PUT';
        agreeing = putCount;
    }
    
    return { 
        signal, 
        agreeing, 
        callCount, 
        putCount, 
        holdCount,
        isReal: false,
        agentDetails,
        timestamp: null
    };
}

function calculateMomentum(data) {
    if (data.length < 14) return 0;
    const recent = data.slice(-14);
    const gains = [], losses = [];
    
    for (let i = 1; i < recent.length; i++) {
        const change = parseFloat(recent[i].Close) - parseFloat(recent[i-1].Close);
        if (change > 0) gains.push(change);
        else losses.push(Math.abs(change));
    }
    
    const avgGain = gains.length > 0 ? gains.reduce((a,b) => a+b, 0) / 14 : 0;
    const avgLoss = losses.length > 0 ? losses.reduce((a,b) => a+b, 0) / 14 : 0;
    
    if (avgLoss === 0) return 1;
    const rs = avgGain / avgLoss;
    const rsi = 100 - (100 / (1 + rs));
    
    return (rsi - 50) / 50; // Normalize to -1 to 1
}

function calculateBarCountSignal(data) {
    if (data.length < 20) return { count: 0, direction: 'neutral' };

    const recentBars = 10; // Analyze last 10 bars
    const recent = data.slice(-recentBars);

    // Calculate 20-period MA
    function calc20MA() {
        if (data.length < 20) return null;
        let sum = 0;
        for (let i = data.length - 20; i < data.length; i++) {
            sum += parseFloat(data[i].Close) || 0;
        }
        return sum / 20;
    }

    // Calculate RSI
    function calcRSI() {
        if (data.length < 15) return 50;
        const changes = [];
        for (let i = data.length - 14; i < data.length; i++) {
            changes.push(parseFloat(data[i].Close) - parseFloat(data[i-1].Close));
        }
        const gains = changes.filter(c => c > 0);
        const losses = changes.filter(c => c < 0).map(c => Math.abs(c));
        const avgGain = gains.length ? gains.reduce((a,b) => a+b, 0) / 14 : 0;
        const avgLoss = losses.length ? losses.reduce((a,b) => a+b, 0) / 14 : 0;
        if (avgLoss === 0) return 100;
        return 100 - (100 / (1 + avgGain / avgLoss));
    }

    const ma20 = calc20MA();
    const rsi = calcRSI();

    // BASE: Count bullish candles (Close >= Open)
    let baseScore = 0;
    recent.forEach(d => {
        if (parseFloat(d.Close) >= parseFloat(d.Open)) baseScore++;
        else baseScore--;
    });

    // GANN: Count bars above 20-MA
    let gannScore = 0;
    if (ma20) {
        recent.forEach(d => {
            if (parseFloat(d.Close) > ma20) gannScore++;
            else gannScore--;
        });
    } else {
        gannScore = baseScore; // Fallback
    }

    // DQN: RSI-based momentum score
    let dqnScore = 0;
    if (rsi > 70) dqnScore = recentBars;
    else if (rsi > 50) dqnScore = Math.round((rsi - 50) / 5);
    else if (rsi < 30) dqnScore = -recentBars;
    else dqnScore = Math.round((rsi - 50) / 5);

    // WAVE: Count higher closes
    let waveScore = 0;
    for (let i = 1; i < recent.length; i++) {
        if (parseFloat(recent[i].Close) > parseFloat(recent[i-1].Close)) waveScore++;
        else waveScore--;
    }

    // Weighted combination (25% each)
    const weightedScore = (baseScore * 0.25) + (gannScore * 0.25) + (dqnScore * 0.25) + (waveScore * 0.25);

    // Normalize to reasonable count
    const normalizedCount = Math.round(weightedScore);

    let direction = 'neutral';
    if (normalizedCount > 2) direction = 'bullish';
    else if (normalizedCount < -2) direction = 'bearish';

    return {
        count: normalizedCount,
        direction,
        details: { baseScore, gannScore, dqnScore, waveScore, weightedScore }
    };
}

function detectAllPatterns(data) {
    const found = [];
    let score = 0;
    
    if (data.length < 20) return { found, score };
    
    const recent = data.slice(-20);
    const closes = recent.map(d => parseFloat(d.Close));
    const highs = recent.map(d => parseFloat(d.High));
    const lows = recent.map(d => parseFloat(d.Low));
    
    // Bull Flag
    const highestHigh = Math.max(...highs.slice(0, 10));
    const recentHigh = Math.max(...highs.slice(-5));
    const recentLow = Math.min(...lows.slice(-5));
    
    if (recentHigh < highestHigh * 0.98 && recentLow > highestHigh * 0.95) {
        found.push('Bull Flag');
        score += 1.5;
    }
    
    // Bear Flag
    const lowestLow = Math.min(...lows.slice(0, 10));
    if (recentLow > lowestLow * 1.02 && recentHigh < lowestLow * 1.05) {
        found.push('Bear Flag');
        score -= 1.5;
    }
    
    // Golden Cross (9 SMA > 21 SMA)
    const sma9 = closes.slice(-9).reduce((a,b) => a+b, 0) / 9;
    const sma21 = closes.slice(-21).reduce((a,b) => a+b, 0) / 21;
    
    if (sma9 > sma21) {
        found.push('Golden Cross');
        score += 1;
    } else {
        found.push('Death Cross');
        score -= 1;
    }
    
    // Higher Highs / Lower Lows
    const recentHighs = highs.slice(-5);
    const recentLows = lows.slice(-5);
    
    let higherHighs = 0, lowerLows = 0;
    for (let i = 1; i < recentHighs.length; i++) {
        if (recentHighs[i] > recentHighs[i-1]) higherHighs++;
        if (recentLows[i] < recentLows[i-1]) lowerLows++;
    }
    
    if (higherHighs >= 3) {
        found.push('Higher Highs');
        score += 0.5;
    }
    if (lowerLows >= 3) {
        found.push('Lower Lows');
        score -= 0.5;
    }
    
    return { found, score: Math.max(-3, Math.min(3, score)) };
}

function calculateGannCycleScore(data, price) {
    const today = new Date();
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    
    // Gann believed in natural cycles
    const cycle30 = dayOfYear % 30;
    const cycle90 = dayOfYear % 90;
    const cycle180 = dayOfYear % 180;
    
    let score = 0;
    let details = [];
    
    // 30-day cycle
    if (cycle30 < 7) {
        details.push('30-day: Bottoming');
        score += 0.5;
    } else if (cycle30 > 23) {
        details.push('30-day: Topping');
        score -= 0.5;
    } else {
        details.push('30-day: Mid-cycle');
    }
    
    // 90-day cycle
    if (cycle90 < 20) {
        details.push('90-day: Accumulation');
        score += 0.5;
    } else if (cycle90 > 70) {
        details.push('90-day: Distribution');
        score -= 0.5;
    } else {
        details.push('90-day: Trend phase');
        score += 0.25;
    }
    
    // Seasonal (Q4 typically bullish)
    const month = today.getMonth();
    if (month >= 9) { // Oct-Dec
        details.push('Seasonal: Q4 bullish');
        score += 0.5;
    } else if (month >= 4 && month <= 6) { // May-Jul
        details.push('Seasonal: Summer lull');
        score -= 0.25;
    }
    
    return { score: Math.max(-2, Math.min(2, score)), detail: details.join('; ') };
}

function calculateFibonacciScore(data, price) {
    if (data.length < 50) return { score: 0, detail: 'Insufficient data', level: '' };
    
    const recent = data.slice(-50);
    const high = Math.max(...recent.map(d => parseFloat(d.High)));
    const low = Math.min(...recent.map(d => parseFloat(d.Low)));
    const range = high - low;
    
    // Calculate Fibonacci levels
    const levels = {
        '23.6%': high - range * 0.236,
        '38.2%': high - range * 0.382,
        '50%': high - range * 0.5,
        '61.8%': high - range * 0.618,
        '78.6%': high - range * 0.786
    };
    
    // Find nearest level
    let nearestLevel = '';
    let nearestDist = Infinity;
    
    for (const [name, levelPrice] of Object.entries(levels)) {
        const dist = Math.abs(price - levelPrice);
        if (dist < nearestDist) {
            nearestDist = dist;
            nearestLevel = name;
        }
    }
    
    let score = 0;
    let detail = '';
    
    // Score based on position relative to Fibonacci levels
    const pricePosition = (high - price) / range;
    
    if (pricePosition < 0.236) {
        score = 1.5; // Near highs - bullish continuation
        detail = 'Above 23.6% - Strong bullish';
    } else if (pricePosition < 0.382) {
        score = 1; // Shallow pullback
        detail = 'At 23.6-38.2% - Bullish pullback';
    } else if (pricePosition < 0.5) {
        score = 0.5; // Normal retracement
        detail = 'At 38.2-50% - Moderate support';
    } else if (pricePosition < 0.618) {
        score = 0; // Neutral
        detail = 'At 50-61.8% - Critical zone';
    } else if (pricePosition < 0.786) {
        score = -0.5; // Deep retracement
        detail = 'At 61.8-78.6% - Deep pullback';
    } else {
        score = -1.5; // Near lows - bearish
        detail = 'Below 78.6% - Bearish';
    }
    
    return { score, detail, level: nearestLevel };
}

function calculateVolumeScore(data) {
    if (data.length < 20) return { score: 0, detail: 'Insufficient data' };
    
    const volumes = data.slice(-20).map(d => parseFloat(d.Volume) || 0);
    const avgVolume = volumes.slice(0, -1).reduce((a,b) => a+b, 0) / 19;
    const todayVolume = volumes[volumes.length - 1];
    
    const volumeRatio = todayVolume / avgVolume;
    
    let score = 0;
    let detail = '';
    
    if (volumeRatio > 1.5) {
        score = 1.5;
        detail = `Volume ${(volumeRatio * 100).toFixed(0)}% of avg - High conviction`;
    } else if (volumeRatio > 1.2) {
        score = 1;
        detail = `Volume ${(volumeRatio * 100).toFixed(0)}% of avg - Above average`;
    } else if (volumeRatio > 0.8) {
        score = 0;
        detail = `Volume ${(volumeRatio * 100).toFixed(0)}% of avg - Normal`;
    } else {
        score = -0.5;
        detail = `Volume ${(volumeRatio * 100).toFixed(0)}% of avg - Low interest`;
    }
    
    return { score, detail };
}

function updateConfluenceScore(signals) {
    const scoreEl = document.getElementById('masterConfluenceScore');
    const directionEl = document.getElementById('confluenceDirection');
    const confidenceEl = document.getElementById('confluenceConfidence');
    const symbolEl = document.getElementById('confluenceSymbol');
    
    if (scoreEl) {
        scoreEl.textContent = (signals.masterScore > 0 ? '+' : '') + signals.masterScore.toFixed(1);
        scoreEl.className = 'confluence-score ' + (signals.masterScore > 0 ? 'bullish' : signals.masterScore < 0 ? 'bearish' : 'neutral');
    }
    
    if (directionEl) {
        directionEl.textContent = signals.direction + ' BIAS';
        directionEl.style.color = signals.direction === 'BULLISH' ? 'var(--success)' : 
                                  signals.direction === 'BEARISH' ? 'var(--danger)' : 'var(--muted)';
    }
    
    if (confidenceEl) confidenceEl.textContent = signals.confidence.toFixed(0) + '%';
    if (symbolEl) symbolEl.textContent = currentSymbol + ' Analysis';
    
    // Update individual signal scores
    updateSignalItem('agentScore', signals.agentConsensus.count + '/4', signals.agentConsensus.score > 0);
    updateSignalItem('agentDetail', signals.agentConsensus.detail);
    
    updateSignalItem('barCountScore', (signals.barCount.count > 0 ? '+' : '') + signals.barCount.count, signals.barCount.score > 0);
    updateSignalItem('barCountDetail', signals.barCount.detail);
    
    updateSignalItem('patternScore', (signals.patterns.score > 0 ? '+' : '') + signals.patterns.score.toFixed(1), signals.patterns.score > 0);
    updateSignalItem('patternDetail', signals.patterns.detail);
    
    updateSignalItem('gannScore', (signals.gann.score > 0 ? '+' : '') + signals.gann.score.toFixed(1), signals.gann.score > 0);
    updateSignalItem('gannDetail', signals.gann.detail);
    
    updateSignalItem('fibScore', (signals.fibonacci.score > 0 ? '+' : '') + signals.fibonacci.score.toFixed(1), signals.fibonacci.score > 0);
    updateSignalItem('fibDetail', signals.fibonacci.detail);
    
    updateSignalItem('volumeScore', (signals.volume.score > 0 ? '+' : '') + signals.volume.score.toFixed(1), signals.volume.score > 0);
    updateSignalItem('volumeDetail', signals.volume.detail);
}

function updateSignalItem(id, value, isBullish) {
    const el = document.getElementById(id);
    if (!el) return;
    
    if (id.includes('Score')) {
        el.textContent = value;
        el.className = 'signal-item-score ' + (isBullish ? 'bullish' : isBullish === false ? 'bearish' : 'neutral');
    } else {
        el.textContent = value;
    }
}

function updateAgentSignalsTable(signals) {
    // Update Agent Signals table with calculated data from getAgentSignals()
    if (!signals || !signals.agentConsensus || !signals.agentConsensus.agentDetails) return;

    const agents = signals.agentConsensus.agentDetails;

    // Helper to update an agent row
    function updateAgent(prefix, data) {
        const intradaySignalEl = document.getElementById(prefix + 'IntradaySignal');
        const intradayConfEl = document.getElementById(prefix + 'IntradayConf');
        const swingSignalEl = document.getElementById(prefix + 'SwingSignal');
        const swingConfEl = document.getElementById(prefix + 'SwingConf');

        const signal = data.signal || 'HOLD';
        const conf = Math.min(99, Math.max(0, data.confidence || 50)).toFixed(0) + '%';
        const badgeClass = 'badge ' + (signal === 'CALL' ? 'badge-success' :
                                       signal === 'PUT' ? 'badge-danger' : 'badge-warning');

        // Update both intraday and swing columns
        if (intradaySignalEl) {
            intradaySignalEl.textContent = signal;
            intradaySignalEl.className = badgeClass;
        }
        if (intradayConfEl) intradayConfEl.textContent = conf;
        if (swingSignalEl) {
            swingSignalEl.textContent = signal;
            swingSignalEl.className = badgeClass;
        }
        if (swingConfEl) swingConfEl.textContent = conf;
    }

    // Update each agent's signals
    updateAgent('base', agents.base || { signal: 'HOLD', confidence: 50 });
    updateAgent('gann', agents.gann || { signal: 'HOLD', confidence: 50 });
    updateAgent('dqn', agents.dqn || { signal: 'HOLD', confidence: 50 });
    updateAgent('wave', agents.wave || { signal: 'HOLD', confidence: 50 });

    // Update consensus row
    const allAgents = [agents.base, agents.gann, agents.dqn, agents.wave];
    const callCount = allAgents.filter(a => a && a.signal === 'CALL').length;
    const putCount = allAgents.filter(a => a && a.signal === 'PUT').length;

    const intradayConsensusEl = document.getElementById('intradayConsensus');
    const swingConsensusEl = document.getElementById('swingConsensus');
    const intradayConsensusConfEl = document.getElementById('intradayConsensusConf');
    const swingConsensusConfEl = document.getElementById('swingConsensusConf');

    const agreeing = Math.max(callCount, putCount);
    const consensusText = agreeing + '/4';
    const consensusClass = 'badge ' + (agreeing >= 4 ? 'badge-ultra' : agreeing >= 3 ? 'badge-success' : 'badge-warning');

    if (intradayConsensusEl) {
        intradayConsensusEl.textContent = consensusText;
        intradayConsensusEl.className = consensusClass;
    }
    if (swingConsensusEl) {
        swingConsensusEl.textContent = consensusText;
        swingConsensusEl.className = consensusClass;
    }

    const avgConf = allAgents.reduce((sum, a) => sum + (a?.confidence || 50), 0) / 4;
    const avgConfText = avgConf.toFixed(0) + '%';
    if (intradayConsensusConfEl) intradayConsensusConfEl.textContent = avgConfText;
    if (swingConsensusConfEl) swingConsensusConfEl.textContent = avgConfText;
}

function updateTradeRecommendations(signals) {
    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close);
    const atr = parseFloat(lastBar.ATR) || price * 0.015;

    const signal = signals.direction === 'BULLISH' ? 'CALL' : signals.direction === 'BEARISH' ? 'PUT' : 'HOLD';

    // Calculate ATR multipliers based on mode combination
    // Morning/Intraday: Entry 0.3, Stop 0.3/0.5, Target 0.8/1.5, DTE 0-1
    // Morning/Swing: Entry 0.5, Stop 0.7/1.2, Target 2.0/3.5, DTE 3-5
    // Evening: Entry 0.5, Stop 1.0/1.5, Target 2.5/4.0, DTE 1-2
    let entryATR, stopATR1, stopATR2, target1ATR, target2ATR, dteValue, dteExplain;

    if (currentAnalysisMode === 'evening') {
        // Evening: Next-day setups with wider ranges
        entryATR = 0.5;
        stopATR1 = 1.0;
        stopATR2 = 1.5;
        target1ATR = 2.5;
        target2ATR = 4.0;
        dteValue = '1-2';
        dteExplain = 'Next-day setup. Allows time for overnight gap and morning momentum.';
    } else if (currentTradeMode === 'swing') {
        // Swing: Wider stops, larger targets
        entryATR = 0.5;
        stopATR1 = 0.7;
        stopATR2 = 1.2;
        target1ATR = 2.0;
        target2ATR = 3.5;
        dteValue = '3-5';
        dteExplain = 'Swing trade timeframe. Gives position time to develop over multiple sessions.';
    } else {
        // Intraday (default): Tight stops, quick targets
        entryATR = 0.3;
        stopATR1 = 0.3;
        stopATR2 = 0.5;
        target1ATR = 0.8;
        target2ATR = 1.5;
        dteValue = '0-1';
        dteExplain = 'Same day/next day expiry. High gamma, quick profits, rapid time decay.';
    }

    const entryLow = price - atr * entryATR;
    const entryHigh = price + atr * (entryATR * 0.4);
    const bestEntry = signal === 'CALL' ? entryLow : entryHigh;
    const stop05 = signal === 'CALL' ? price - atr * stopATR1 : price + atr * stopATR1;
    const stop10 = signal === 'CALL' ? price - atr * stopATR2 : price + atr * stopATR2;
    const target1 = signal === 'CALL' ? price + atr * target1ATR : price - atr * target1ATR;
    const target2 = signal === 'CALL' ? price + atr * target2ATR : price - atr * target2ATR;

    // Calculate optimal strike
    const strike = Math.round(price / 5) * 5; // Round to nearest $5

    // Determine which container to update based on mode
    let containerId;
    if (currentAnalysisMode === 'evening') {
        containerId = 'eveningTradeRecommendations';
    } else if (currentTradeMode === 'swing') {
        containerId = 'swingTradeRecommendations';
    } else {
        containerId = 'intradayTradeRecommendations';
    }

    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            <!-- Main Trade Card -->
            <div style="background: ${signal === 'CALL' ? 'rgba(16,185,129,0.1)' : signal === 'PUT' ? 'rgba(239,68,68,0.1)' : 'rgba(100,116,139,0.1)'}; padding: 15px; border-radius: 8px; border-left: 4px solid ${signal === 'CALL' ? 'var(--success)' : signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="font-weight: 700; font-size: 18px;">${currentSymbol}</span>
                    <span style="background: ${signal === 'CALL' ? 'var(--success)' : signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'}; color: white; padding: 6px 14px; border-radius: 4px; font-size: 14px; font-weight: 700;">${signal}</span>
                </div>
                
                <div style="font-size: 12px; line-height: 2;">
                    <div style="background: rgba(255,255,255,0.5); padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                        <strong> Best Entry Price:</strong> <span style="color:var(--primary);font-weight:700;font-size:14px;">$${bestEntry.toFixed(2)}</span><br>
                        <span style="font-size:10px;color:var(--muted);">Wait for pullback to this level for optimal risk/reward</span>
                    </div>
                    
                    <div><strong>Entry Range:</strong> $${entryLow.toFixed(2)} - $${entryHigh.toFixed(2)}</div>
                    
                    <div style="margin-top: 6px;">
                        <strong> Stop Loss Options:</strong><br>
                        <div style="padding-left: 10px; font-size: 11px;">
                             Tight (${stopATR1} ATR): <span style="color: var(--danger);font-weight:600;">$${stop05.toFixed(2)}</span>
                            <span style="color:var(--muted);">(=$${(atr * stopATR1).toFixed(2)} risk)</span><br>
                             Standard (${stopATR2} ATR): <span style="color: var(--danger);font-weight:600;">$${stop10.toFixed(2)}</span>
                            <span style="color:var(--muted);">(=$${(atr * stopATR2).toFixed(2)} risk)</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 6px;">
                        <strong> Profit Targets:</strong><br>
                        <div style="padding-left: 10px; font-size: 11px;">
                             Target 1: <span style="color: var(--success);font-weight:600;">$${target1.toFixed(2)}</span> (take 50%)<br>
                             Target 2: <span style="color: var(--success);font-weight:600;">$${target2.toFixed(2)}</span> (close position)
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border);">
                        <strong> Options Setup:</strong><br>
                        <div style="padding-left: 10px; font-size: 11px;">
                             Strike: <strong>$${strike} ${signal}</strong><br>
                             DTE: <strong>${dteValue} DTE</strong> (Days To Expiration)<br>
                            <span style="color:var(--muted);font-size:10px;"> ${dteExplain}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Signal Breakdown Card -->
            <div style="background: var(--bg); padding: 15px; border-radius: 8px;">
                <h4 style="font-size: 13px; margin-bottom: 12px;">
                     Why This Signal? 
                    ${signals.agentConsensus.isReal ? '<span style="background: var(--success); color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px;">LIVE DATA</span>' : '<span style="background: var(--muted); color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px;">CALCULATED</span>'}
                </h4>
                
                <!-- Individual Agent Breakdown -->
                <div style="background: white; border-radius: 6px; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border);">
                    <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px; color: var(--text);"> Individual Agent Votes:</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 10px;">
                        ${signals.agentConsensus.agentDetails ? `
                        <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: ${signals.agentConsensus.agentDetails.base.signal === 'CALL' ? 'rgba(16,185,129,0.1)' : signals.agentConsensus.agentDetails.base.signal === 'PUT' ? 'rgba(239,68,68,0.1)' : 'rgba(100,116,139,0.1)'}; border-radius: 4px;">
                            <span> Base Confluence:</span>
                            <strong style="color: ${signals.agentConsensus.agentDetails.base.signal === 'CALL' ? 'var(--success)' : signals.agentConsensus.agentDetails.base.signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'};">${signals.agentConsensus.agentDetails.base.signal} (${signals.agentConsensus.agentDetails.base.confidence.toFixed(0)}%)</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: ${signals.agentConsensus.agentDetails.gann.signal === 'CALL' ? 'rgba(16,185,129,0.1)' : signals.agentConsensus.agentDetails.gann.signal === 'PUT' ? 'rgba(239,68,68,0.1)' : 'rgba(100,116,139,0.1)'}; border-radius: 4px;">
                            <span> Gann-Elliott:</span>
                            <strong style="color: ${signals.agentConsensus.agentDetails.gann.signal === 'CALL' ? 'var(--success)' : signals.agentConsensus.agentDetails.gann.signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'};">${signals.agentConsensus.agentDetails.gann.signal} (${signals.agentConsensus.agentDetails.gann.confidence.toFixed(0)}%)</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: ${signals.agentConsensus.agentDetails.dqn.signal === 'CALL' ? 'rgba(16,185,129,0.1)' : signals.agentConsensus.agentDetails.dqn.signal === 'PUT' ? 'rgba(239,68,68,0.1)' : 'rgba(100,116,139,0.1)'}; border-radius: 4px;">
                            <span> DQN (ML):</span>
                            <strong style="color: ${signals.agentConsensus.agentDetails.dqn.signal === 'CALL' ? 'var(--success)' : signals.agentConsensus.agentDetails.dqn.signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'};">${signals.agentConsensus.agentDetails.dqn.signal} (${signals.agentConsensus.agentDetails.dqn.confidence.toFixed(0)}%)</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: ${signals.agentConsensus.agentDetails.wave.signal === 'CALL' ? 'rgba(16,185,129,0.1)' : signals.agentConsensus.agentDetails.wave.signal === 'PUT' ? 'rgba(239,68,68,0.1)' : 'rgba(100,116,139,0.1)'}; border-radius: 4px;">
                            <span> 3-Wave:</span>
                            <strong style="color: ${signals.agentConsensus.agentDetails.wave.signal === 'CALL' ? 'var(--success)' : signals.agentConsensus.agentDetails.wave.signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'};">${signals.agentConsensus.agentDetails.wave.signal} (${signals.agentConsensus.agentDetails.wave.confidence.toFixed(0)}%)</strong>
                        </div>
                        ` : '<div style="grid-column: span 2; text-align: center; color: var(--muted);">Agent data not available</div>'}
                    </div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border); text-align: center;">
                        <strong style="color: ${signals.agentConsensus.count >= 3 ? 'var(--success)' : 'var(--warning)'};">
                            Consensus: ${signals.agentConsensus.count}/4 agents  ${signals.agentConsensus.signal}
                        </strong>
                    </div>
                </div>
                
                <!-- Other Signals -->
                <div style="font-size: 11px; line-height: 1.9;">
                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border);">
                        <span> Bar Count:</span>
                        <strong style="color: ${signals.barCount.count > 0 ? 'var(--success)' : signals.barCount.count < 0 ? 'var(--danger)' : 'var(--muted)'};">${signals.barCount.count > 0 ? '+' : ''}${signals.barCount.count} bars</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border);">
                        <span> Patterns:</span>
                        <strong>${signals.patterns.found.length > 0 ? signals.patterns.found.slice(0,2).join(', ') : 'None'}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border);">
                        <span> Gann Cycle:</span>
                        <strong>${signals.gann.score > 0 ? ' Bullish' : signals.gann.score < 0 ? ' Bearish' : ' Neutral'}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border);">
                        <span> Fibonacci:</span>
                        <strong>${signals.fibonacci.level}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                        <span> Volume:</span>
                        <strong>${signals.volume.score > 0 ? ' Above Avg' : ' Below Avg'}</strong>
                    </div>
                </div>
                
                <div style="margin-top: 12px; padding: 10px; background: ${signals.confidence >= 70 ? 'rgba(16,185,129,0.15)' : signals.confidence >= 50 ? 'rgba(245,158,11,0.15)' : 'rgba(239,68,68,0.15)'}; border-radius: 6px; text-align: center;">
                    <div style="font-size: 10px; color: var(--muted);">Overall Confidence</div>
                    <div style="font-size: 24px; font-weight: 700; color: ${signals.confidence >= 70 ? 'var(--success)' : signals.confidence >= 50 ? 'var(--warning)' : 'var(--danger)'};">${signals.confidence.toFixed(0)}%</div>
                </div>
            </div>
        </div>
        
        <!-- ATR Explanation -->
        <div style="background: rgba(59,130,246,0.05); padding: 12px; border-radius: 6px; margin-top: 15px; font-size: 11px; color: var(--muted);">
            <strong> Understanding ATR (Average True Range):</strong><br>
            Current ATR = <strong>$${atr.toFixed(2)}</strong>  This means ${currentSymbol} typically moves $${atr.toFixed(2)} per day.<br>
             <strong>0.5 ATR stop</strong> = $${(atr * 0.5).toFixed(2)} risk  Tighter stop, less room for normal fluctuation<br>
             <strong>1.0 ATR stop</strong> = $${atr.toFixed(2)} risk  Standard stop, accounts for normal daily volatility<br>
             Use tighter stops for day trades, wider stops for swing trades
        </div>
    `;
}

function updateGannAnalysis(price) {
    const timeCyclesEl = document.getElementById('gannTimeCycles');
    const sq9El = document.getElementById('squareOf9');
    
    const today = new Date();
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    
    // Time cycles
    const cycle30 = dayOfYear % 30;
    const cycle90 = dayOfYear % 90;
    const cycle180 = dayOfYear % 180;
    
    // Get cycle phases with explanations
    let cycle30Phase, cycle30Action;
    if (cycle30 < 7) {
        cycle30Phase = 'Bottoming';
        cycle30Action = ' Look for reversal longs';
    } else if (cycle30 > 23) {
        cycle30Phase = 'Topping';
        cycle30Action = ' Caution, take profits';
    } else if (cycle30 < 15) {
        cycle30Phase = 'Rising';
        cycle30Action = ' Favor bullish plays';
    } else {
        cycle30Phase = 'Declining';
        cycle30Action = ' Patience, wait for bottom';
    }
    
    let cycle90Phase, cycle90Action;
    if (cycle90 < 20) {
        cycle90Phase = 'Accumulation';
        cycle90Action = ' Smart money buying';
    } else if (cycle90 > 70) {
        cycle90Phase = 'Distribution';
        cycle90Action = ' Smart money selling';
    } else {
        cycle90Phase = 'Trend Phase';
        cycle90Action = ' Ride the momentum';
    }
    
    if (timeCyclesEl) {
        timeCyclesEl.innerHTML = `
            <div style="margin-bottom: 8px;">
                <strong>30-day cycle:</strong> Day ${cycle30}/30 - <span style="color:var(--primary);font-weight:600;">${cycle30Phase}</span><br>
                <span style="font-size:10px;color:var(--muted);">${cycle30Action} | ${cycle30Phase === 'Bottoming' ? 'Market finding floor, reversal expected' : cycle30Phase === 'Topping' ? 'Market at peak, reversal risk high' : cycle30Phase === 'Rising' ? 'Upward momentum active' : 'Downward pressure, wait for cycle bottom'}</span>
            </div>
            <div style="margin-bottom: 8px;">
                <strong>90-day cycle:</strong> Day ${cycle90}/90 - <span style="color:var(--primary);font-weight:600;">${cycle90Phase}</span><br>
                <span style="font-size:10px;color:var(--muted);">${cycle90Action} | ${cycle90Phase === 'Accumulation' ? 'Institutional buying phase' : cycle90Phase === 'Distribution' ? 'Institutional selling phase' : 'Strong trending, follow direction'}</span>
            </div>
            <div>
                <strong>Next Gann Date:</strong> ${getNextGannDate()}<br>
                <span style="font-size:10px;color:var(--muted);"> Gann dates (equinoxes/solstices) often mark trend reversals</span>
            </div>
        `;
    }
    
    // Square of 9 calculations with explanations
    if (sq9El) {
        const sq9Levels = calculateSquareOf9(price);
        sq9El.innerHTML = `
            <div style="margin-bottom: 8px;">
                <strong>Resistance Levels:</strong><br>
                 R1: <span style="color:var(--danger);font-weight:600;">$${sq9Levels.r1.toFixed(2)}</span> (45 up)<br>
                 R2: <span style="color:var(--danger);font-weight:600;">$${sq9Levels.r2.toFixed(2)}</span> (90 up)
            </div>
            <div style="margin-bottom: 8px;">
                <strong>Support Levels:</strong><br>
                 S1: <span style="color:var(--success);font-weight:600;">$${sq9Levels.s1.toFixed(2)}</span> (45 down)<br>
                 S2: <span style="color:var(--success);font-weight:600;">$${sq9Levels.s2.toFixed(2)}</span> (90 down)
            </div>
            <div style="font-size:10px;color:var(--muted);margin-top:8px;">
                 <strong>What is Square of 9?</strong><br>
                Gann's geometric calculator that finds natural price levels. Each 45 rotation = 1 step. Prices tend to find support/resistance at these harmonic levels.
            </div>
        `;
    }
}

function getNextGannDate() {
    const today = new Date();
    const gannDates = [
        { month: 0, day: 21 },  // Jan 21
        { month: 2, day: 21 },  // Mar 21 (Equinox)
        { month: 5, day: 21 },  // Jun 21 (Solstice)
        { month: 8, day: 21 },  // Sep 21 (Equinox)
        { month: 11, day: 21 }, // Dec 21 (Solstice)
    ];
    
    for (const gd of gannDates) {
        const date = new Date(today.getFullYear(), gd.month, gd.day);
        if (date > today) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
    }
    
    return new Date(today.getFullYear() + 1, 0, 21).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function calculateSquareOf9(price) {
    // Gann Square of 9 calculations
    const sqrt = Math.sqrt(price);
    const increment = 0.125; // 45 degrees = 0.125
    
    return {
        r1: Math.pow(sqrt + increment, 2),
        r2: Math.pow(sqrt + increment * 2, 2),
        s1: Math.pow(sqrt - increment, 2),
        s2: Math.pow(sqrt - increment * 2, 2)
    };
}

function updateFibonacciLevels(data) {
    if (data.length < 50) return;
    
    const recent = data.slice(-50);
    const high = Math.max(...recent.map(d => parseFloat(d.High)));
    const low = Math.min(...recent.map(d => parseFloat(d.Low)));
    const range = high - low;
    
    const levels = {
        'phi236': high - range * 0.236,
        'phi382': high - range * 0.382,
        'phi50': high - range * 0.5,
        'phi618': high - range * 0.618,
        'phi786': high - range * 0.786,
        'phi1618': high + range * 0.618
    };
    
    for (const [id, value] of Object.entries(levels)) {
        const el = document.getElementById(id);
        if (el) el.textContent = '$' + value.toFixed(2);
    }
}

function updateHighConsensusTrades(signals) {
    const tableBody = document.getElementById('highConsensusTable');
    if (!tableBody) return;
    
    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close);
    const atr = parseFloat(lastBar.ATR) || price * 0.015;
    
    const signal = signals.direction === 'BULLISH' ? 'CALL' : signals.direction === 'BEARISH' ? 'PUT' : 'HOLD';
    const consensus = signals.agentConsensus.count;
    
    if (consensus >= 3) {
        const stop = signal === 'CALL' ? price - atr * 1.5 : price + atr * 1.5;
        const target = signal === 'CALL' ? price + atr * 2 : price - atr * 2;
        const strike = Math.round(price / 5) * 5;
        
        tableBody.innerHTML = `
            <tr>
                <td><strong>${currentSymbol}</strong></td>
                <td><span class="badge ${signal === 'CALL' ? 'call' : 'put'}">${signal}</span></td>
                <td><strong>${consensus}/4</strong></td>
                <td>${signals.masterScore > 0 ? '+' : ''}${signals.masterScore.toFixed(1)}</td>
                <td>$${(price - atr * 0.3).toFixed(2)} - $${(price + atr * 0.3).toFixed(2)}</td>
                <td style="color: var(--danger);">$${stop.toFixed(2)}</td>
                <td style="color: var(--success);">$${target.toFixed(2)}</td>
                <td>$${strike} ${signal}</td>
            </tr>
        `;
    } else {
        tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);">No high-consensus trades at this time</td></tr>';
    }
}

function updateMarketContext(signals) {
    const biasEl = document.getElementById('contextOverallBias');
    const leadersEl = document.getElementById('sectorLeaders');
    const riskEl = document.getElementById('riskLevel');
    
    if (biasEl) {
        biasEl.textContent = signals.direction;
        biasEl.style.color = signals.direction === 'BULLISH' ? 'var(--success)' : 
                            signals.direction === 'BEARISH' ? 'var(--danger)' : 'var(--muted)';
    }
    
    if (leadersEl) {
        leadersEl.textContent = signals.direction === 'BULLISH' ? 'XLK, QQQ' : 
                                signals.direction === 'BEARISH' ? 'XLU, XLP' : 'Mixed';
    }
    
    if (riskEl) {
        const risk = signals.confidence > 75 ? 'LOW' : signals.confidence > 60 ? 'MODERATE' : 'HIGH';
        riskEl.textContent = risk;
        riskEl.style.color = risk === 'LOW' ? 'var(--success)' : risk === 'MODERATE' ? 'var(--warning)' : 'var(--danger)';
    }
}

function updateAISummary(signals, price) {
    const lastBar = currentData[currentData.length - 1];
    const atr = parseFloat(lastBar.ATR) || price * 0.015;
    const sq9 = calculateSquareOf9(price);

    const signalWord = signals.direction === 'BULLISH' ? 'bullish' : signals.direction === 'BEARISH' ? 'bearish' : 'neutral';
    const optionType = signals.direction === 'BULLISH' ? 'CALL' : signals.direction === 'BEARISH' ? 'PUT' : 'neutral';

    // Get Gann cycle explanations
    const gannExplanations = getGannCycleExplanations();

    // Calculate optimal strike
    const optimalStrike = Math.round(price / 5) * 5;

    // Mode-specific ATR multipliers and calculations
    let entryATR, stopATR1, stopATR2, target1ATR, target2ATR, dteText, summaryElId;

    if (currentAnalysisMode === 'evening') {
        entryATR = 0.5; stopATR1 = 1.0; stopATR2 = 1.5; target1ATR = 2.5; target2ATR = 4.0;
        dteText = '1-2 DTE';
        summaryElId = 'eveningAISummary';
    } else if (currentTradeMode === 'swing') {
        entryATR = 0.5; stopATR1 = 0.7; stopATR2 = 1.2; target1ATR = 2.0; target2ATR = 3.5;
        dteText = '3-5 DTE';
        summaryElId = 'swingAISummary';
    } else {
        entryATR = 0.3; stopATR1 = 0.3; stopATR2 = 0.5; target1ATR = 0.8; target2ATR = 1.5;
        dteText = '0-1 DTE';
        summaryElId = 'intradayAISummary';
    }

    const summaryEl = document.getElementById(summaryElId);
    if (!summaryEl) return;

    const entryLow = (price - atr * entryATR).toFixed(2);
    const entryHigh = (price + atr * (entryATR * 0.4)).toFixed(2);
    const bestEntry = signals.direction === 'BULLISH' ? entryLow : entryHigh;
    const stopLoss1 = signals.direction === 'BULLISH' ? (price - atr * stopATR1).toFixed(2) : (price + atr * stopATR1).toFixed(2);
    const stopLoss2 = signals.direction === 'BULLISH' ? (price - atr * stopATR2).toFixed(2) : (price + atr * stopATR2).toFixed(2);
    const target1 = signals.direction === 'BULLISH' ? (price + atr * target1ATR).toFixed(2) : (price - atr * target1ATR).toFixed(2);
    const target2 = signals.direction === 'BULLISH' ? (price + atr * target2ATR).toFixed(2) : (price - atr * target2ATR).toFixed(2);

    if (currentAnalysisMode === 'morning' && currentTradeMode === 'intraday') {
        // INTRADAY MODE - Tight stops, quick targets, 0-1 DTE
        summaryEl.innerHTML = `
            <strong> Morning Analysis - Intraday (${new Date().toLocaleDateString()}):</strong>
            Market conditions favor ${signalWord} positions today. ${currentSymbol} showing ${signals.agentConsensus.count}/4 agent consensus for ${signals.agentConsensus.signal}.
            Master confluence score: ${signals.masterScore > 0 ? '+' : ''}${signals.masterScore.toFixed(1)} with ${signals.confidence.toFixed(0)}% confidence.
            <br><br>

            <strong> Recommended Entry Zone (Tight - ${entryATR} ATR):</strong><br>
            <div style="background: rgba(245,158,11,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Best Entry Price:</strong> <span style="color:var(--primary);font-weight:700;">$${bestEntry}</span><br>
                 <strong>Entry Range:</strong> $${entryLow} - $${entryHigh}<br>
                 <strong>Why tight range?</strong> Intraday trades need precise entries for optimal risk/reward on quick moves
            </div>

            <strong> Recommended Strategy (0-1 DTE):</strong><br>
            <div style="background: rgba(59,130,246,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Trade:</strong> ${optionType} on ${currentSymbol}<br>
                 <strong>Strike:</strong> $${optimalStrike} ${optionType}<br>
                 <strong>DTE:</strong> 0-1 DTE (same day or next day expiry)<br>
                <div style="font-size:10px;color:var(--muted);margin-top:5px;">
                     <em>0-1 DTE = High gamma exposure for quick profits. Rapid time decay requires fast execution.</em>
                </div>
            </div>

            <strong> Stop Loss Levels (Tight Stops):</strong><br>
            <div style="background: rgba(239,68,68,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Tight Stop (${stopATR1} ATR):</strong> <span style="color:var(--danger);font-weight:600;">$${stopLoss1}</span><br>
                  <span style="font-size:10px;color:var(--muted);"> ${stopATR1}  $${atr.toFixed(2)} = $${(atr * stopATR1).toFixed(2)} risk per share</span><br><br>
                 <strong>Max Stop (${stopATR2} ATR):</strong> <span style="color:var(--danger);font-weight:600;">$${stopLoss2}</span><br>
                  <span style="font-size:10px;color:var(--muted);"> Cut losses quickly on intraday trades - don't let losers run</span>
            </div>

            <strong> Profit Targets (Quick Targets):</strong><br>
            <div style="background: rgba(16,185,129,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Target 1 (${target1ATR} ATR):</strong> <span style="color:var(--success);font-weight:600;">$${target1}</span> - Take 50% profits<br>
                 <strong>Target 2 (${target2ATR} ATR):</strong> <span style="color:var(--success);font-weight:600;">$${target2}</span> - Close remainder<br>
                <span style="font-size:10px;color:var(--muted);"> Don't get greedy on intraday - take profits quickly</span>
            </div>

            <strong> Gann Cycle Analysis:</strong><br>
            <div style="background: rgba(139,92,246,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                ${gannExplanations}
            </div>

            <strong> Key Terms Explained:</strong><br>
            <div style="font-size:10px;color:var(--muted);line-height:1.6;margin-top:5px;">
                 <strong>0-1 DTE:</strong> Options expiring same day or tomorrow - maximum gamma, fastest decay<br>
                 <strong>ATR:</strong> Average True Range ($${atr.toFixed(2)}) - typical daily price movement<br>
                 <strong>Tight Stops:</strong> ${stopATR1}-${stopATR2} ATR keeps risk minimal on quick trades
            </div>
        `;
    } else if (currentAnalysisMode === 'morning' && currentTradeMode === 'swing') {
        // SWING MODE - Wider stops, larger targets, 3-5 DTE
        summaryEl.innerHTML = `
            <strong> Morning Analysis - Swing (${new Date().toLocaleDateString()}):</strong>
            Market conditions favor ${signalWord} positions over multiple days. ${currentSymbol} showing ${signals.agentConsensus.count}/4 agent consensus for ${signals.agentConsensus.signal}.
            Master confluence score: ${signals.masterScore > 0 ? '+' : ''}${signals.masterScore.toFixed(1)} with ${signals.confidence.toFixed(0)}% confidence.
            <br><br>

            <strong> Recommended Entry Zone (Wider - ${entryATR} ATR):</strong><br>
            <div style="background: rgba(139,92,246,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Best Entry Price:</strong> <span style="color:var(--primary);font-weight:700;">$${bestEntry}</span><br>
                 <strong>Entry Range:</strong> $${entryLow} - $${entryHigh}<br>
                 <strong>Why wider range?</strong> Swing trades allow for overnight gaps and multi-day volatility
            </div>

            <strong> Recommended Strategy (3-5 DTE):</strong><br>
            <div style="background: rgba(59,130,246,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Trade:</strong> ${optionType} spreads on ${currentSymbol}<br>
                 <strong>Strike:</strong> $${optimalStrike} ${optionType}<br>
                 <strong>DTE:</strong> 3-5 DTE (expires in 3-5 days)<br>
                <div style="font-size:10px;color:var(--muted);margin-top:5px;">
                     <em>3-5 DTE = Time for the move to develop. Less theta decay pressure than 0-1 DTE.</em>
                </div>
            </div>

            <strong> Stop Loss Levels (Room to Breathe):</strong><br>
            <div style="background: rgba(239,68,68,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Initial Stop (${stopATR1} ATR):</strong> <span style="color:var(--danger);font-weight:600;">$${stopLoss1}</span><br>
                  <span style="font-size:10px;color:var(--muted);"> ${stopATR1}  $${atr.toFixed(2)} = $${(atr * stopATR1).toFixed(2)} risk per share</span><br><br>
                 <strong>Max Stop (${stopATR2} ATR):</strong> <span style="color:var(--danger);font-weight:600;">$${stopLoss2}</span><br>
                  <span style="font-size:10px;color:var(--muted);"> Give swing trades room for normal multi-day volatility</span>
            </div>

            <strong> Profit Targets (Let Winners Run):</strong><br>
            <div style="background: rgba(16,185,129,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Target 1 (${target1ATR} ATR):</strong> <span style="color:var(--success);font-weight:600;">$${target1}</span> - Take 50% profits<br>
                 <strong>Target 2 (${target2ATR} ATR):</strong> <span style="color:var(--success);font-weight:600;">$${target2}</span> - Close remainder<br>
                 <strong>Sq9 Resistance:</strong> $${sq9.r1.toFixed(2)} - Major level from Square of 9<br>
                <span style="font-size:10px;color:var(--muted);"> Patience is key for swing trades - let winners develop</span>
            </div>

            <strong> Gann Cycle Analysis:</strong><br>
            <div style="background: rgba(139,92,246,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                ${gannExplanations}
            </div>

            <strong> Key Terms Explained:</strong><br>
            <div style="font-size:10px;color:var(--muted);line-height:1.6;margin-top:5px;">
                 <strong>3-5 DTE:</strong> Options expiring in 3-5 days - balanced theta decay and time for move<br>
                 <strong>ATR:</strong> Average True Range ($${atr.toFixed(2)}) - typical daily price movement<br>
                 <strong>Wider Stops:</strong> ${stopATR1}-${stopATR2} ATR allows for overnight gaps
            </div>
        `;
    } else {
        // EVENING MODE - Next-day setups, widest stops, largest targets, 1-2 DTE
        summaryEl.innerHTML = `
            <strong> Evening Review (${new Date().toLocaleDateString()}):</strong>
            Today's session ended with ${currentSymbol} at $${price.toFixed(2)}.
            ${signals.direction === 'BULLISH' ? 'Bulls maintained control' : signals.direction === 'BEARISH' ? 'Bears dominated' : 'Mixed price action'} with ${signals.agentConsensus.count}/4 agent agreement.
            <br><br>

            <strong> Day Summary:</strong><br>
            <div style="background: var(--bg); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 Master Score: ${signals.masterScore > 0 ? '+' : ''}${signals.masterScore.toFixed(1)} (${signals.direction})<br>
                 Patterns: ${signals.patterns.found.length > 0 ? signals.patterns.found.join(', ') : 'None detected'}<br>
                 Bar Count: ${signals.barCount.count > 0 ? '+' : ''}${signals.barCount.count} consecutive ${signals.barCount.count > 0 ? 'bullish' : 'bearish'} bars<br>
                 Volume: ${signals.volume.detail}
            </div>

            <strong> Tomorrow's Trading Plan (1-2 DTE):</strong><br>
            <div style="background: rgba(59,130,246,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                ${signals.confidence >= 65 ? `
                <strong>Bias:</strong> Continue ${signalWord} outlook<br>
                <strong>Watch for:</strong> Gap ${signals.direction === 'BULLISH' ? 'up' : 'down'} at open<br>
                <strong>Entry Zone (${entryATR} ATR):</strong> $${entryLow} - $${entryHigh}<br>
                <strong>Best Entry:</strong> $${bestEntry} (wait for pullback)<br>
                <strong>Stop Loss (${stopATR1}/${stopATR2} ATR):</strong> $${stopLoss1} / $${stopLoss2}<br>
                <strong>Targets (${target1ATR}/${target2ATR} ATR):</strong> $${target1} / $${target2}
                ` : `
                 <strong>Low confidence setup for tomorrow.</strong><br>
                Wait for clearer signals before committing capital.<br>
                Key levels: Support $${sq9.s1.toFixed(2)} / Resistance $${sq9.r1.toFixed(2)}
                `}
            </div>

            <strong> Gann Cycle Outlook:</strong><br>
            <div style="background: rgba(139,92,246,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                ${gannExplanations}
            </div>

            <strong> Pre-Market Checklist for Tomorrow:</strong><br>
            <div style="background: var(--bg); padding: 10px; border-radius: 6px; margin: 8px 0; font-size: 11px;">
                 Check overnight futures direction (ES, NQ)<br>
                 Review any earnings/economic news<br>
                 Confirm agent consensus at 9:35 AM<br>
                 Size positions based on confidence (${signals.confidence.toFixed(0)}%)<br>
                 Set alerts at $${sq9.s1.toFixed(2)} (support) and $${sq9.r1.toFixed(2)} (resistance)
            </div>
        `;
    }
}

function getGannCycleExplanations() {
    const today = new Date();
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    
    const cycle30 = dayOfYear % 30;
    const cycle90 = dayOfYear % 90;
    const month = today.getMonth();
    
    let explanations = '';
    
    // 30-day cycle explanation
    let cycle30Phase, cycle30Explain;
    if (cycle30 < 7) {
        cycle30Phase = 'Bottoming';
        cycle30Explain = 'Market finding a floor - look for reversal signals to go long';
    } else if (cycle30 > 23) {
        cycle30Phase = 'Topping';
        cycle30Explain = 'Market reaching peak - be cautious of reversals, consider taking profits';
    } else if (cycle30 < 15) {
        cycle30Phase = 'Rising';
        cycle30Explain = 'Upward momentum phase - favor bullish positions';
    } else {
        cycle30Phase = 'Declining';
        cycle30Explain = 'Downward momentum phase - favor bearish positions or wait';
    }
    
    // 90-day cycle explanation
    let cycle90Phase, cycle90Explain;
    if (cycle90 < 20) {
        cycle90Phase = 'Accumulation';
        cycle90Explain = 'Smart money buying - early bullish opportunity';
    } else if (cycle90 > 70) {
        cycle90Phase = 'Distribution';
        cycle90Explain = 'Smart money selling - late in cycle, increased risk';
    } else {
        cycle90Phase = 'Trend Phase';
        cycle90Explain = 'Strong trending period - follow the momentum';
    }
    
    // Seasonal explanation
    let seasonal, seasonalExplain;
    if (month >= 9) { // Oct-Dec
        seasonal = 'Q4 Bullish';
        seasonalExplain = 'Historically strongest quarter - Santa Rally, year-end positioning';
    } else if (month >= 4 && month <= 6) {
        seasonal = 'Summer Lull';
        seasonalExplain = '"Sell in May" period - typically lower volatility and returns';
    } else if (month >= 0 && month <= 2) {
        seasonal = 'January Effect';
        seasonalExplain = 'New year inflows, tax-loss harvesting reversals';
    } else {
        seasonal = 'Transitional';
        seasonalExplain = 'Between major seasonal patterns';
    }
    
    explanations = `
         <strong>30-Day Cycle:</strong> ${cycle30Phase} (Day ${cycle30}/30)<br>
          <span style="font-size:10px;color:var(--muted);"> ${cycle30Explain}</span><br><br>
         <strong>90-Day Cycle:</strong> ${cycle90Phase} (Day ${cycle90}/90)<br>
          <span style="font-size:10px;color:var(--muted);"> ${cycle90Explain}</span><br><br>
         <strong>Seasonal:</strong> ${seasonal}<br>
          <span style="font-size:10px;color:var(--muted);"> ${seasonalExplain}</span>
    `;
    
    return explanations;
}

function updatePlanDateTime() {
    const now = new Date();
    
    const dateEl = document.getElementById('planDate');
    const timeEl = document.getElementById('planTime');
    
    if (dateEl) {
        dateEl.textContent = now.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    }
    
    if (timeEl) {
        timeEl.textContent = now.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true
        }) + ' ET';
    }
}

function downloadReport() {
    if (!dailyAnalysisData) {
        alert('Please generate a report first');
        return;
    }
    
    const content = generateReportHTML();
    const blob = new Blob([content], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `Q5D_${currentSymbol}_${currentAnalysisMode}_${new Date().toISOString().split('T')[0]}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function generateReportHTML() {
    const signals = dailyAnalysisData.signals;
    const price = dailyAnalysisData.price;
    const sq9 = calculateSquareOf9(price);
    
    return `
<!DOCTYPE html>
<html>
<head>
    <title>Q5D Trading Report - ${currentSymbol} - ${new Date().toLocaleDateString()}</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
        h1 { color: #1e40af; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; }
        h2 { color: #374151; margin-top: 30px; }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .score { font-size: 48px; font-weight: bold; text-align: center; padding: 20px; border-radius: 10px; }
        .bullish { background: #dcfce7; color: #16a34a; }
        .bearish { background: #fee2e2; color: #dc2626; }
        .neutral { background: #f3f4f6; color: #6b7280; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f3f4f6; }
        .signal-call { color: #16a34a; font-weight: bold; }
        .signal-put { color: #dc2626; font-weight: bold; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280; }
        @media print { body { margin: 0; } }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1> Q5D Trading Report</h1>
            <p><strong>${currentAnalysisMode === 'morning' ? ' Morning Plan' : ' Evening Review'}</strong></p>
        </div>
        <div style="text-align: right;">
            <p><strong>${currentSymbol}</strong></p>
            <p>${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
            <p>${new Date().toLocaleTimeString()}</p>
        </div>
    </div>
    
    <div class="score ${signals.direction.toLowerCase()}">${signals.masterScore > 0 ? '+' : ''}${signals.masterScore.toFixed(1)}</div>
    <p style="text-align: center; font-size: 18px;"><strong>${signals.direction} BIAS</strong> | Confidence: ${signals.confidence.toFixed(0)}%</p>
    
    <h2> Signal Breakdown</h2>
    <table>
        <tr><th>Signal Component</th><th>Score</th><th>Details</th></tr>
        <tr><td> Agent Consensus</td><td>${signals.agentConsensus.count}/4</td><td>${signals.agentConsensus.detail}</td></tr>
        <tr><td> Bar Count</td><td>${signals.barCount.score > 0 ? '+' : ''}${signals.barCount.score.toFixed(1)}</td><td>${signals.barCount.detail}</td></tr>
        <tr><td> Patterns</td><td>${signals.patterns.score > 0 ? '+' : ''}${signals.patterns.score.toFixed(1)}</td><td>${signals.patterns.detail}</td></tr>
        <tr><td> Gann Cycles</td><td>${signals.gann.score > 0 ? '+' : ''}${signals.gann.score.toFixed(1)}</td><td>${signals.gann.detail}</td></tr>
        <tr><td> Fibonacci</td><td>${signals.fibonacci.score > 0 ? '+' : ''}${signals.fibonacci.score.toFixed(1)}</td><td>${signals.fibonacci.detail}</td></tr>
        <tr><td> Volume</td><td>${signals.volume.score > 0 ? '+' : ''}${signals.volume.score.toFixed(1)}</td><td>${signals.volume.detail}</td></tr>
    </table>
    
    <h2> Trade Recommendation</h2>
    <div class="card">
        <p><strong>Symbol:</strong> ${currentSymbol} | <strong>Current Price:</strong> $${price.toFixed(2)}</p>
        <p><strong>Signal:</strong> <span class="signal-${signals.direction === 'BULLISH' ? 'call' : 'put'}">${signals.direction === 'BULLISH' ? 'CALL' : signals.direction === 'BEARISH' ? 'PUT' : 'HOLD'}</span></p>
        <p><strong>Optimal Strike:</strong> $${Math.round(price / 5) * 5}</p>
        <p><strong>Stop Loss:</strong> $${sq9.s1.toFixed(2)}</p>
        <p><strong>Target:</strong> $${sq9.r1.toFixed(2)}</p>
    </div>
    
    <h2> Gann Square of 9 Levels</h2>
    <div class="grid">
        <div class="card">
            <h3>Resistance</h3>
            <p>R1: $${sq9.r1.toFixed(2)}</p>
            <p>R2: $${sq9.r2.toFixed(2)}</p>
        </div>
        <div class="card">
            <h3>Support</h3>
            <p>S1: $${sq9.s1.toFixed(2)}</p>
            <p>S2: $${sq9.s2.toFixed(2)}</p>
        </div>
    </div>
    
    <div class="footer">
        <p>Generated by Q5D Options Trading Platform | ${new Date().toISOString()}</p>
        <p> This report is for educational purposes only. Always do your own research before trading.</p>
    </div>
</body>
</html>
    `;
}

// TRADE MODE SWITCHING
function switchTradeMode(mode) {
    currentTradeMode = mode;

    const intradayBtn = document.getElementById('intradayModeBtn');
    const swingBtn = document.getElementById('swingModeBtn');
    if (intradayBtn && swingBtn) {
        if (mode === 'intraday') {
            intradayBtn.style.background = 'linear-gradient(135deg, var(--intraday), #d97706)';
            intradayBtn.style.color = 'white';
            swingBtn.style.background = 'transparent';
            swingBtn.style.color = 'var(--muted)';
        } else {
            swingBtn.style.background = 'linear-gradient(135deg, var(--swing), #6d28d9)';
            swingBtn.style.color = 'white';
            intradayBtn.style.background = 'transparent';
            intradayBtn.style.color = 'var(--muted)';
        }
    }

    // Show/hide intraday and swing sections
    const intradaySection = document.getElementById('intradaySection');
    const swingSection = document.getElementById('swingSection');

    if (intradaySection) intradaySection.style.display = mode === 'intraday' ? 'block' : 'none';
    if (swingSection) swingSection.style.display = mode === 'swing' ? 'block' : 'none';

    // Regenerate trade recommendations for the active mode
    generateDailyReport();
}

// Charts tab handler
document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('[data-tab="charts"]')?.addEventListener('click', () => {
        setTimeout(() => { if (typeof updatePriceChart === 'function') updatePriceChart(); }, 300);
    });
    document.querySelector('[data-tab="patterns"]')?.addEventListener('click', () => {
        setTimeout(() => { if (typeof updateFibonacciLevels === 'function' && currentData?.length) updateFibonacciLevels(currentData); }, 300);
    });
});

// ==========================================
// MTF BIAS TAB FUNCTIONS
// ==========================================
function updateMTFBias() {
    if (!currentData || currentData.length < 50) {
        console.log('MTF Bias: Insufficient data');
        return;
    }

    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close) || 0;

    // Update symbol display
    const mtfSymbolEl = document.getElementById('mtfBiasSymbol');
    if (mtfSymbolEl) mtfSymbolEl.textContent = currentSymbol;

    // Update current price
    const priceEl = document.getElementById('mtfCurrentPrice');
    if (priceEl) priceEl.textContent = '$' + price.toFixed(2);

    // Calculate bias for each timeframe using TODAY's data
    const biasResults = {
        '5m': calculateDayBias(currentData, 1),   // Last 1 bar
        '15m': calculateDayBias(currentData, 3),  // Last 3 bars
        '1h': calculateDayBias(currentData, 12),  // Last 12 bars
        '4h': calculateDayBias(currentData, 48),  // Last 48 bars
        'D': calculateDayBias(currentData, 252)   // Last 252 bars (1 year for daily trend)
    };

    // Update quick bias badges
    Object.entries(biasResults).forEach(([tf, result]) => {
        const el = document.getElementById('mtfBias' + tf.replace('m', 'm').replace('h', 'h'));
        if (el) {
            el.textContent = tf + ': ' + result.bias.charAt(0);
            el.className = 'signal-badge ' + (result.bias === 'BULLISH' ? 'call' : result.bias === 'BEARISH' ? 'put' : 'neutral');
        }
    });

    // Calculate alignment score
    let bullishCount = 0, bearishCount = 0;
    Object.values(biasResults).forEach(r => {
        if (r.bias === 'BULLISH') bullishCount++;
        else if (r.bias === 'BEARISH') bearishCount++;
    });

    const alignmentEl = document.getElementById('mtfAlignmentScore');
    const recommendationEl = document.getElementById('mtfRecommendation');
    const summaryEl = document.getElementById('mtfSummary');

    if (alignmentEl) {
        if (bullishCount >= 4) {
            alignmentEl.textContent = bullishCount + '/5 Bullish';
            alignmentEl.style.color = 'var(--success)';
        } else if (bearishCount >= 4) {
            alignmentEl.textContent = bearishCount + '/5 Bearish';
            alignmentEl.style.color = 'var(--danger)';
        } else {
            alignmentEl.textContent = 'Mixed (' + bullishCount + 'B/' + bearishCount + 'B)';
            alignmentEl.style.color = 'var(--warning)';
        }
    }

    if (recommendationEl) {
        if (bullishCount >= 4) {
            recommendationEl.textContent = 'CALL bias';
            recommendationEl.style.color = 'var(--success)';
        } else if (bearishCount >= 4) {
            recommendationEl.textContent = 'PUT bias';
            recommendationEl.style.color = 'var(--danger)';
        } else {
            recommendationEl.textContent = 'Wait for alignment';
            recommendationEl.style.color = 'var(--warning)';
        }
    }

    if (summaryEl) {
        const neutralCount = 5 - bullishCount - bearishCount;
        summaryEl.textContent = currentSymbol + ' @ $' + price.toFixed(2) + ' | ' +
            bullishCount + ' bullish, ' + bearishCount + ' bearish, ' + neutralCount + ' neutral timeframes';
    }

    // Generate historical bias log (last 30 days)
    generateMTFHistoryLog();
}

function calculateDayBias(data, lookback) {
    if (data.length < lookback + 1) lookback = Math.max(1, data.length - 1);

    const recentData = data.slice(-lookback);
    if (recentData.length < 2) return { bias: 'NEUTRAL', score: 0 };

    const firstClose = parseFloat(recentData[0].Close) || 0;
    const lastClose = parseFloat(recentData[recentData.length - 1].Close) || 0;
    const change = firstClose > 0 ? ((lastClose - firstClose) / firstClose) * 100 : 0;

    // Calculate simple momentum
    let ups = 0, downs = 0;
    for (let i = 1; i < recentData.length; i++) {
        const curr = parseFloat(recentData[i].Close) || 0;
        const prev = parseFloat(recentData[i-1].Close) || 0;
        if (curr > prev) ups++;
        else if (curr < prev) downs++;
    }
    const momentum = (ups - downs) / (recentData.length - 1);

    let bias = 'NEUTRAL';
    let score = 0;

    if (change > 0.2 && momentum > 0.1) {
        bias = 'BULLISH';
        score = Math.min(2, change / 0.5 + momentum);
    } else if (change < -0.2 && momentum < -0.1) {
        bias = 'BEARISH';
        score = Math.max(-2, change / 0.5 + momentum);
    } else {
        score = momentum;
    }

    return { bias, score, change };
}

function generateMTFHistoryLog() {
    const tableBody = document.getElementById('mtfHistoryTable');
    if (!tableBody || !currentData || currentData.length < 30) {
        if (tableBody) tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);">Insufficient data for history</td></tr>';
        return;
    }

    // Get last 30 unique dates
    const dailyData = [];
    const seenDates = new Set();

    for (let i = currentData.length - 1; i >= 0 && dailyData.length < 30; i--) {
        const bar = currentData[i];
        const dateStr = (bar.Date || '').split('T')[0].split(' ')[0];
        if (dateStr && !seenDates.has(dateStr)) {
            seenDates.add(dateStr);
            dailyData.push({
                date: dateStr,
                close: parseFloat(bar.Close) || 0,
                index: i
            });
        }
    }

    // Calculate bias for each historical day
    let bullishDays = 0, bearishDays = 0, neutralDays = 0;
    let html = '';

    dailyData.forEach(day => {
        // Get data up to this day
        const dataToDate = currentData.slice(0, day.index + 1);

        // Calculate biases with different lookbacks
        const bias5m = calculateDayBias(dataToDate, 1);
        const bias15m = calculateDayBias(dataToDate, 3);
        const bias1h = calculateDayBias(dataToDate, 12);
        const bias4h = calculateDayBias(dataToDate, 48);
        const biasD = calculateDayBias(dataToDate, 252);

        // Count bullish/bearish
        let dayBullish = 0, dayBearish = 0;
        [bias5m, bias15m, bias1h, bias4h, biasD].forEach(b => {
            if (b.bias === 'BULLISH') dayBullish++;
            else if (b.bias === 'BEARISH') dayBearish++;
        });

        // Overall score
        let overallBias = 'NEUTRAL';
        let overallScore = dayBullish - dayBearish;
        if (dayBullish >= 3) { overallBias = 'BULLISH'; bullishDays++; }
        else if (dayBearish >= 3) { overallBias = 'BEARISH'; bearishDays++; }
        else { neutralDays++; }

        const biasClass = (b) => b.bias === 'BULLISH' ? 'call' : b.bias === 'BEARISH' ? 'put' : 'neutral';
        const biasIcon = (b) => b.bias === 'BULLISH' ? '' : b.bias === 'BEARISH' ? '' : '';

        html += '<tr>' +
            '<td style="font-size:11px;">' + day.date + '</td>' +
            '<td style="font-weight:600;">$' + day.close.toFixed(2) + '</td>' +
            '<td><span class="signal-badge ' + biasClass(bias5m) + '" style="font-size:10px;">' + biasIcon(bias5m) + '</span></td>' +
            '<td><span class="signal-badge ' + biasClass(bias15m) + '" style="font-size:10px;">' + biasIcon(bias15m) + '</span></td>' +
            '<td><span class="signal-badge ' + biasClass(bias1h) + '" style="font-size:10px;">' + biasIcon(bias1h) + '</span></td>' +
            '<td><span class="signal-badge ' + biasClass(bias4h) + '" style="font-size:10px;">' + biasIcon(bias4h) + '</span></td>' +
            '<td><span class="signal-badge ' + biasClass(biasD) + '" style="font-size:10px;">' + biasIcon(biasD) + '</span></td>' +
            '<td><span class="signal-badge ' + biasClass({bias: overallBias}) + '" style="font-size:10px;">' + overallScore + '</span></td>' +
            '</tr>';
    });

    tableBody.innerHTML = html;

    // Update summary stats
    const bullishEl = document.getElementById('mtfBullishDays');
    const bearishEl = document.getElementById('mtfBearishDays');
    const neutralEl = document.getElementById('mtfNeutralDays');

    if (bullishEl) bullishEl.textContent = bullishDays;
    if (bearishEl) bearishEl.textContent = bearishDays;
    if (neutralEl) neutralEl.textContent = neutralDays;
}


function calculateEMA(data, period) {
    if (data.length < period) return data[data.length - 1];
    const k = 2 / (period + 1);
    let ema = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
    for (let i = period; i < data.length; i++) {
        ema = data[i] * k + ema * (1 - k);
    }
    return ema;
}

// ==========================================
// TRADE JOURNAL TAB FUNCTIONS
// ==========================================
let tradeJournalData = {
    openPositions: [],
    tradeHistory: []
};

function loadTradeJournal() {
    // Load from localStorage
    const saved = localStorage.getItem('q5d_trade_journal');
    if (saved) {
        tradeJournalData = JSON.parse(saved);
    }

    updateJournalDisplay();
    updateJournalStats();
}

function updateJournalDisplay() {
    // Update open positions table
    const openBody = document.getElementById('openPositionsBody');
    if (openBody) {
        if (tradeJournalData.openPositions.length === 0) {
            openBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:20px;">No open positions. Add a trade to get started.</td></tr>';
        } else {
            openBody.innerHTML = tradeJournalData.openPositions.map((pos, idx) => {
                const currentPrice = currentData?.length ? currentData[currentData.length - 1].close : pos.entry;
                const pnl = pos.type === 'LONG'
                    ? ((currentPrice - pos.entry) / pos.entry * 100).toFixed(2)
                    : ((pos.entry - currentPrice) / pos.entry * 100).toFixed(2);
                const pnlClass = parseFloat(pnl) >= 0 ? 'var(--success)' : 'var(--danger)';

                return `<tr>
                    <td>${pos.date}</td>
                    <td><strong>${pos.symbol}</strong></td>
                    <td><span class="badge ${pos.type === 'LONG' ? 'badge-success' : 'badge-danger'}">${pos.type}</span></td>
                    <td>$${pos.entry.toFixed(2)}</td>
                    <td>$${pos.stop.toFixed(2)}</td>
                    <td>$${pos.target.toFixed(2)}</td>
                    <td style="color:${pnlClass};font-weight:600;">${pnl}%</td>
                </tr>`;
            }).join('');
        }
    }

    // Update trade history table
    const historyBody = document.getElementById('tradeHistoryBody');
    if (historyBody) {
        if (tradeJournalData.tradeHistory.length === 0) {
            historyBody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:20px;">No trade history yet.</td></tr>';
        } else {
            historyBody.innerHTML = tradeJournalData.tradeHistory.slice(-20).reverse().map(trade => {
                const resultClass = trade.result === 'WIN' ? 'badge-success' : trade.result === 'LOSS' ? 'badge-danger' : 'badge-warning';
                const pnlClass = trade.pnl >= 0 ? 'var(--success)' : 'var(--danger)';

                return `<tr>
                    <td>${trade.date}</td>
                    <td><strong>${trade.symbol}</strong></td>
                    <td><span class="badge ${trade.type === 'LONG' ? 'badge-success' : 'badge-danger'}">${trade.type}</span></td>
                    <td>$${trade.entry.toFixed(2)}</td>
                    <td>$${trade.exit.toFixed(2)}</td>
                    <td style="color:${pnlClass};font-weight:600;">${trade.pnl >= 0 ? '+' : ''}${trade.pnl.toFixed(2)}%</td>
                    <td><span class="badge ${resultClass}">${trade.result}</span></td>
                    <td style="font-size:10px;color:var(--muted);">${trade.notes || '-'}</td>
                </tr>`;
            }).join('');
        }
    }
}

function updateJournalStats() {
    const history = tradeJournalData.tradeHistory;

    const totalTrades = history.length;
    const wins = history.filter(t => t.result === 'WIN').length;
    const winRate = totalTrades > 0 ? ((wins / totalTrades) * 100).toFixed(1) : '0.0';
    const totalPnL = history.reduce((sum, t) => sum + t.pnl, 0);
    const bestTrade = history.length > 0 ? Math.max(...history.map(t => t.pnl)) : 0;
    const worstTrade = history.length > 0 ? Math.min(...history.map(t => t.pnl)) : 0;

    const totalEl = document.getElementById('journalTotalTrades');
    const winRateEl = document.getElementById('journalWinRate');
    const pnlEl = document.getElementById('journalTotalPnL');
    const bestEl = document.getElementById('journalBestTrade');
    const worstEl = document.getElementById('journalWorstTrade');

    if (totalEl) totalEl.textContent = totalTrades;
    if (winRateEl) {
        winRateEl.textContent = winRate + '%';
        winRateEl.style.color = parseFloat(winRate) >= 50 ? 'var(--success)' : 'var(--danger)';
    }
    if (pnlEl) {
        pnlEl.textContent = (totalPnL >= 0 ? '+' : '') + totalPnL.toFixed(2) + '%';
        pnlEl.style.color = totalPnL >= 0 ? 'var(--success)' : 'var(--danger)';
    }
    if (bestEl) {
        bestEl.textContent = '+' + bestTrade.toFixed(2) + '%';
        bestEl.style.color = 'var(--success)';
    }
    if (worstEl) {
        worstEl.textContent = worstTrade.toFixed(2) + '%';
        worstEl.style.color = 'var(--danger)';
    }
}

function addTrade() {
    const symbol = currentSymbol || 'SPY';
    const price = currentData?.length ? currentData[currentData.length - 1].close : 0;
    const atr = currentData?.length ? calculateATR(currentData) : price * 0.01;

    const newPosition = {
        date: new Date().toLocaleDateString(),
        symbol: symbol,
        type: 'LONG',
        entry: price,
        stop: parseFloat((price - atr * 0.5).toFixed(2)),
        target: parseFloat((price + atr * 1.5).toFixed(2))
    };

    tradeJournalData.openPositions.push(newPosition);
    saveTradeJournal();
    updateJournalDisplay();
}

function saveTradeJournal() {
    localStorage.setItem('q5d_trade_journal', JSON.stringify(tradeJournalData));
}

function exportTradeJournal() {
    const data = JSON.stringify(tradeJournalData, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `Q5D_TradeJournal_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ==========================================
// REPORTS TAB FUNCTIONS
// ==========================================
const GITHUB_PAGES_BASE = 'https://aadey002.github.io/Stock-agent-/data/';

// CSV Parser helper - parses ALL rows
function parseCSV(csvText) {
    const lines = csvText.trim().split('\n');
    const headers = lines[0].split(',');
    const data = [];
    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        const row = {};
        headers.forEach((header, idx) => {
            row[header.trim()] = values[idx]?.trim() || '';
        });
        data.push(row);
    }
    return data;
}

async function loadReportsData() {
    // Load all three data sources in parallel
    await Promise.all([
        updatePlaybookComparison(),
        updateUltraConfluence(),
        updateSectorRotation()
    ]);
}

async function updatePlaybookComparison() {
    const tbody = document.getElementById('playbookComparisonBody');
    if (!tbody) return;

    // Show loading state
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:20px;">Loading playbook data...</td></tr>';

    const countEl = document.getElementById('playbookCount');

    try {
        const response = await fetch(GITHUB_PAGES_BASE + 'playbook_comparison.csv');
        if (!response.ok) throw new Error('Failed to fetch');

        const csvText = await response.text();
        const data = parseCSV(csvText);

        if (data.length === 0) throw new Error('No data');

        // Show ALL data, sorted by date descending (most recent first)
        const allSignals = data.reverse();

        // Update count display
        if (countEl) {
            countEl.textContent = `(${allSignals.length} signals)`;
        }

        tbody.innerHTML = allSignals.map(row => {
            // Parse CSV date format: "2023-05-01T00:00:00.000Z" - ISO format
            // Column name is lowercase 'date' not 'Date'
            const rawDate = row.date || row.Date || '';
            const dateStr = rawDate.split('T')[0]; // Split on T for ISO format
            const date = dateStr || 'N/A';
            const signal = row.majority || 'NEUTRAL';
            const signalClass = signal === 'CALL' ? 'badge-success' : signal === 'PUT' ? 'badge-danger' : 'badge-warning';
            const confluence = row.confluence_level || 'NONE';
            const confluenceClass = confluence.includes('ULTRA') ? 'badge-success' : confluence.includes('SUPER') ? 'badge-primary' : 'badge-warning';
            const confidence = (parseFloat(row.avg_confidence || 0) * 100).toFixed(0);

            return `<tr>
                <td>${date}</td>
                <td><span class="badge ${signalClass}">${signal}</span></td>
                <td><span class="badge ${confluenceClass}">${confluence}</span></td>
                <td>$${parseFloat(row.entry || 0).toFixed(2)}</td>
                <td>$${parseFloat(row.stop || 0).toFixed(2)}</td>
                <td>$${parseFloat(row.target1 || 0).toFixed(2)}</td>
                <td style="font-weight:600;color:${parseInt(confidence) >= 60 ? 'var(--success)' : 'var(--warning)'};">${confidence}%</td>
            </tr>`;
        }).join('');

    } catch (error) {
        console.error('Playbook fetch error:', error);
        console.error('URL attempted:', GITHUB_PAGES_BASE + 'playbook_comparison.csv');
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--danger);padding:20px;">Data unavailable - check console for errors</td></tr>';
        if (countEl) countEl.textContent = '';
    }
}

async function updateUltraConfluence() {
    const tbody = document.getElementById('ultraConfluenceBody');
    const totalEl = document.getElementById('ultraConfluenceTotal');
    if (!tbody) return;

    // Show loading state
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:20px;">Loading ultra confluence data...</td></tr>';

    try {
        const response = await fetch(GITHUB_PAGES_BASE + 'ultra_confluence_4of4.csv');
        if (!response.ok) throw new Error('Failed to fetch');

        const csvText = await response.text();
        const data = parseCSV(csvText);

        if (data.length === 0) throw new Error('No data');

        // Show ALL data, sorted by date descending (most recent first)
        const allSignals = data.reverse();

        tbody.innerHTML = allSignals.map(row => {
            // Parse CSV date format: "2023-05-01T00:00:00.000Z" - ISO format
            // Column name is lowercase 'date' not 'Date'
            const rawDate = row.date || row.Date || '';
            const dateStr = rawDate.split('T')[0]; // Split on T for ISO format
            const date = dateStr || 'N/A';
            const signal = row.majority || 'NEUTRAL';
            const signalClass = signal === 'CALL' ? 'badge-success' : signal === 'PUT' ? 'badge-danger' : 'badge-warning';
            const agents = `${row.call_votes || 0}C/${row.put_votes || 0}P/${row.hold_votes || 0}H`;
            const confidence = (parseFloat(row.avg_confidence || 0) * 100).toFixed(0);
            const wave = row.A2_wave || '-';
            const trend = row.A2_trend || '-';

            return `<tr>
                <td>${date}</td>
                <td><span class="badge ${signalClass}">${signal}</span></td>
                <td style="font-size:11px;">${agents}</td>
                <td style="color:${trend === 'UP' ? 'var(--success)' : trend === 'DOWN' ? 'var(--danger)' : 'var(--muted)'};">Wave ${wave} ${trend}</td>
                <td style="font-weight:600;color:${parseInt(confidence) >= 60 ? 'var(--success)' : 'var(--warning)'};">${confidence}%</td>
            </tr>`;
        }).join('');

        // Update total count
        if (totalEl) {
            const callCount = allSignals.filter(r => r.majority === 'CALL').length;
            const putCount = allSignals.filter(r => r.majority === 'PUT').length;
            totalEl.textContent = `(${allSignals.length} signals: ${callCount} CALL, ${putCount} PUT)`;
            totalEl.style.color = callCount > putCount ? 'var(--success)' : putCount > callCount ? 'var(--danger)' : 'var(--primary)';
        }

    } catch (error) {
        console.error('Ultra confluence fetch error:', error);
        console.error('URL attempted:', GITHUB_PAGES_BASE + 'ultra_confluence_4of4.csv');
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--danger);padding:20px;">Data unavailable - check console for errors</td></tr>';
        if (totalEl) {
            totalEl.textContent = '';
        }
    }
}

async function updateSectorRotation() {
    const tbody = document.getElementById('sectorRotationBody');
    const leadersEl = document.getElementById('sectorLeadersReport');
    const laggardsEl = document.getElementById('sectorLaggardsReport');
    const rotationEl = document.getElementById('sectorRotationSignal');
    if (!tbody) return;

    // Show loading state
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:20px;">Loading sector data...</td></tr>';

    try {
        const response = await fetch(GITHUB_PAGES_BASE + 'sector_rotation.csv');
        if (!response.ok) throw new Error('Failed to fetch');

        const csvText = await response.text();
        const data = parseCSV(csvText);

        // Filter for 1-month timeframe (most relevant for rotation)
        const monthData = data.filter(row => row.Timeframe === '1_month');

        if (monthData.length === 0) throw new Error('No data');

        // Sort by performance
        monthData.sort((a, b) => parseFloat(b.Performance) - parseFloat(a.Performance));

        tbody.innerHTML = monthData.map(row => {
            const perf = parseFloat(row.Performance || 0);
            const perfColor = perf > 0 ? 'var(--success)' : perf < 0 ? 'var(--danger)' : 'var(--muted)';
            const typeClass = row.Type === 'cyclical' ? 'badge-primary' : 'badge-warning';
            const bias = perf > 2 ? 'BULLISH' : perf < -2 ? 'BEARISH' : 'NEUTRAL';
            const biasClass = bias === 'BULLISH' ? 'badge-success' : bias === 'BEARISH' ? 'badge-danger' : 'badge-warning';

            return `<tr>
                <td><strong>${row.Ticker}</strong> <span style="font-size:10px;color:var(--muted);">${row.Name}</span></td>
                <td><span class="badge ${biasClass}">${bias}</span></td>
                <td><span class="badge ${typeClass}">${row.Type}</span></td>
                <td style="color:${perfColor};font-weight:600;">${perf > 0 ? '+' : ''}${perf.toFixed(2)}%</td>
            </tr>`;
        }).join('');

        // Update leaders/laggards
        const leaders = monthData.slice(0, 3).map(r => r.Ticker).join(', ');
        const laggards = monthData.slice(-3).map(r => r.Ticker).join(', ');

        if (leadersEl) leadersEl.textContent = leaders;
        if (laggardsEl) laggardsEl.textContent = laggards;

        // Determine rotation signal
        const cyclicalPerf = monthData.filter(r => r.Type === 'cyclical').reduce((sum, r) => sum + parseFloat(r.Performance), 0);
        const defensivePerf = monthData.filter(r => r.Type === 'defensive').reduce((sum, r) => sum + parseFloat(r.Performance), 0);

        if (rotationEl) {
            if (cyclicalPerf > defensivePerf + 5) {
                rotationEl.textContent = 'Risk-On';
                rotationEl.style.color = 'var(--success)';
            } else if (defensivePerf > cyclicalPerf + 5) {
                rotationEl.textContent = 'Risk-Off';
                rotationEl.style.color = 'var(--danger)';
            } else {
                rotationEl.textContent = 'Neutral';
                rotationEl.style.color = 'var(--warning)';
            }
        }

    } catch (error) {
        console.error('Sector rotation fetch error:', error);
        console.error('URL attempted:', GITHUB_PAGES_BASE + 'sector_rotation.csv');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--danger);padding:20px;">Data unavailable - check console for errors</td></tr>';
        if (leadersEl) leadersEl.textContent = '-';
        if (laggardsEl) laggardsEl.textContent = '-';
        if (rotationEl) {
            rotationEl.textContent = 'Unavailable';
            rotationEl.style.color = 'var(--danger)';
        }
    }
}

function downloadReportPDF() {
    // Generate a printable HTML report
    const reportContent = `
<!DOCTYPE html>
<html>
<head>
    <title>Q5D Full Report - ${currentSymbol} - ${new Date().toLocaleDateString()}</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; }
        h1 { color: #1e40af; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; }
        h2 { color: #374151; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 10px; text-align: left; border: 1px solid #e5e7eb; }
        th { background: #f3f4f6; }
        .section { margin-bottom: 30px; page-break-inside: avoid; }
        @media print { body { margin: 0; } }
    </style>
</head>
<body>
    <h1>Q5D Trading Report - ${currentSymbol}</h1>
    <p>Generated: ${new Date().toLocaleString()}</p>

    <div class="section">
        <h2>Multi-Timeframe Bias</h2>
        <p>See MTF Bias tab for current readings</p>
    </div>

    <div class="section">
        <h2>Confluence Analysis</h2>
        <p>See Reports tab for full confluence breakdown</p>
    </div>

    <div class="section">
        <h2>Trade Journal Summary</h2>
        <p>Total Trades: ${tradeJournalData.tradeHistory.length}</p>
        <p>Open Positions: ${tradeJournalData.openPositions.length}</p>
    </div>
</body>
</html>`;

    const blob = new Blob([reportContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `Q5D_FullReport_${currentSymbol}_${new Date().toISOString().split('T')[0]}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Initialize new tabs when clicked
document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('[data-tab="mtf-bias"]')?.addEventListener('click', () => {
        setTimeout(updateMTFBias, 300);
    });
    document.querySelector('[data-tab="trade-journal"]')?.addEventListener('click', () => {
        setTimeout(loadTradeJournal, 300);
    });
    document.querySelector('[data-tab="reports"]')?.addEventListener('click', () => {
        setTimeout(loadReportsData, 300);
    });
    // Initialize historical data on Overview tab load
    document.querySelector('[data-tab="overview"]')?.addEventListener('click', () => {
        setTimeout(updateHistoricalData, 300);
    });
});

// ==========================================
// HISTORICAL DATA FUNCTIONS
// ==========================================
let historicalData = []; // Global variable for AI access

function updateHistoricalData() {
    const tbody = document.getElementById('historicalDataBody');
    const countEl = document.getElementById('historicalDataCount');
    const periodSelect = document.getElementById('historicalPeriod');

    if (!tbody || !currentData || currentData.length === 0) {
        if (tbody) tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:var(--muted);padding:20px;">No data available. Select a symbol first.</td></tr>';
        return;
    }

    const period = parseInt(periodSelect?.value || 30);

    // Get the last N days of data
    const dataToShow = currentData.slice(-period).reverse();
    historicalData = dataToShow; // Store for AI access

    if (countEl) {
        countEl.textContent = `Showing ${dataToShow.length} days of ${currentSymbol} data`;
    }

    tbody.innerHTML = dataToShow.map((row, index) => {
        const date = row.Date ? new Date(row.Date.split(' ')[0]).toLocaleDateString() : '-';
        const open = parseFloat(row.Open || 0);
        const high = parseFloat(row.High || 0);
        const low = parseFloat(row.Low || 0);
        const close = parseFloat(row.Close || 0);
        const volume = parseInt(row.Volume || 0);
        const dailyChange = close - open;
        const dailyChangePct = open > 0 ? ((dailyChange / open) * 100) : 0;

        const changeColor = dailyChange >= 0 ? 'var(--success)' : 'var(--danger)';
        const changeSign = dailyChange >= 0 ? '+' : '';

        // OH Signal: If Open near Low = Bullish, If Open near High = Bearish
        const openToLow = open - low;
        const highToOpen = high - open;
        const ohSignal = openToLow < highToOpen ?
            '<span style="color:var(--success);"> Bull</span>' :
            '<span style="color:var(--danger);"> Bear</span>';

        // Pattern detection
        const prevRow = index < dataToShow.length - 1 ? dataToShow[index + 1] : null;
        const pattern = detectCandlePattern(row, prevRow);

        return `<tr>
            <td style="padding:6px 4px;">${date}</td>
            <td style="padding:6px 4px;">$${open.toFixed(2)}</td>
            <td style="padding:6px 4px;color:var(--success);">$${high.toFixed(2)}</td>
            <td style="padding:6px 4px;color:var(--danger);">$${low.toFixed(2)}</td>
            <td style="padding:6px 4px;font-weight:600;">$${close.toFixed(2)}</td>
            <td style="padding:6px 4px;">${formatVolume(volume)}</td>
            <td style="padding:6px 4px;color:${changeColor};font-weight:600;">${changeSign}$${dailyChange.toFixed(2)}</td>
            <td style="padding:6px 4px;color:${changeColor};font-weight:600;">${changeSign}${dailyChangePct.toFixed(1)}%</td>
            <td style="padding:6px 4px;">${ohSignal}</td>
            <td style="padding:6px 4px;">${pattern.emoji}</td>
            <td style="padding:6px 4px;font-size:10px;">${pattern.implication}</td>
        </tr>`;
    }).join('');

    // Update historical analysis summary
    updateHistoricalAnalysis(dataToShow);

    // Update trade statistics
    updateTradeStatistics(dataToShow);
}

// Detect candlestick patterns
function detectCandlePattern(current, prev) {
    const open = parseFloat(current.Open || 0);
    const high = parseFloat(current.High || 0);
    const low = parseFloat(current.Low || 0);
    const close = parseFloat(current.Close || 0);

    const body = Math.abs(close - open);
    const upperWick = high - Math.max(open, close);
    const lowerWick = Math.min(open, close) - low;
    const range = high - low;
    const isBullish = close >= open;

    // Doji: Open  Close (within 0.1% of range)
    if (body < range * 0.1 && range > 0) {
        return { emoji: ' Doji', implication: ' Indecision' };
    }

    // Hammer: Small body at top, long lower wick (2x body)
    if (lowerWick >= body * 2 && upperWick < body * 0.5 && body > 0) {
        return { emoji: ' Hammer', implication: ' Bullish reversal' };
    }

    // Shooting Star: Small body at bottom, long upper wick (2x body)
    if (upperWick >= body * 2 && lowerWick < body * 0.5 && body > 0) {
        return { emoji: ' Star', implication: ' Bearish reversal' };
    }

    if (prev) {
        const prevOpen = parseFloat(prev.Open || 0);
        const prevHigh = parseFloat(prev.High || 0);
        const prevLow = parseFloat(prev.Low || 0);
        const prevClose = parseFloat(prev.Close || 0);
        const prevIsBullish = prevClose >= prevOpen;

        // Bullish Engulfing
        if (isBullish && !prevIsBullish &&
            open < prevClose && close > prevOpen &&
            body > Math.abs(prevClose - prevOpen)) {
            return { emoji: ' Engulf', implication: ' Strong reversal' };
        }

        // Bearish Engulfing
        if (!isBullish && prevIsBullish &&
            open > prevClose && close < prevOpen &&
            body > Math.abs(prevClose - prevOpen)) {
            return { emoji: ' Engulf', implication: ' Strong reversal' };
        }

        // Inside Bar
        if (high < prevHigh && low > prevLow) {
            return { emoji: ' Inside', implication: ' Breakout coming' };
        }

        // Outside Bar
        if (high > prevHigh && low < prevLow) {
            return { emoji: ' Outside', implication: ' Volatility' };
        }
    }

    return { emoji: '--', implication: '--' };
}

// Update Historical Analysis Summary
function updateHistoricalAnalysis(data) {
    if (!data || data.length < 5) return;

    const last5 = data.slice(0, 5);
    const last20 = data.slice(0, Math.min(20, data.length));

    // Gap Analysis
    let gapUps = 0, gapDowns = 0;
    for (let i = 0; i < last5.length - 1; i++) {
        const todayOpen = parseFloat(last5[i].Open || 0);
        const yesterdayClose = parseFloat(last5[i + 1].Close || 0);
        if (todayOpen > yesterdayClose) gapUps++;
        else if (todayOpen < yesterdayClose) gapDowns++;
    }

    const gapText = document.getElementById('gapAnalysisText');
    const gapImpl = document.getElementById('gapImplication');
    if (gapText) gapText.textContent = `Last 5 Days: ${gapUps} Gap Ups, ${gapDowns} Gap Downs`;
    if (gapImpl) {
        if (gapUps > gapDowns + 1) {
            gapImpl.innerHTML = '<span style="color:var(--success);"> BULLISH MOMENTUM - Buyers eager overnight</span>';
        } else if (gapDowns > gapUps + 1) {
            gapImpl.innerHTML = '<span style="color:var(--danger);"> BEARISH PRESSURE - Sellers active overnight</span>';
        } else {
            gapImpl.innerHTML = '<span style="color:var(--warning);"> INDECISION - No clear overnight bias</span>';
        }
    }

    // Pattern Detection - most recent
    const pattern = detectCandlePattern(last5[0], last5[1]);
    const patternText = document.getElementById('patternDetectedText');
    const patternImpl = document.getElementById('patternImplication');
    if (patternText) patternText.textContent = pattern.emoji !== '--' ?
        `${pattern.emoji} on latest day` : 'No significant pattern';
    if (patternImpl) patternImpl.innerHTML = pattern.implication !== '--' ?
        `<span style="color:${pattern.implication.includes('') ? 'var(--success)' : pattern.implication.includes('') ? 'var(--danger)' : 'var(--warning)'};">${pattern.implication}</span>` : '--';

    // Volume Trend
    const avgVol20 = last20.reduce((sum, d) => sum + parseInt(d.Volume || 0), 0) / last20.length;
    const avgVol5 = last5.reduce((sum, d) => sum + parseInt(d.Volume || 0), 0) / last5.length;
    const volRatio = avgVol20 > 0 ? (avgVol5 / avgVol20 * 100) : 100;

    const volText = document.getElementById('volumeTrendText');
    const volImpl = document.getElementById('volumeImplication');
    if (volText) {
        if (volRatio > 150) {
            volText.textContent = ` Increasing (${volRatio.toFixed(0)}% of avg)`;
        } else if (volRatio > 80) {
            volText.textContent = ` Normal (${volRatio.toFixed(0)}% of avg)`;
        } else {
            volText.textContent = ` Declining (${volRatio.toFixed(0)}% of avg)`;
        }
    }
    if (volImpl) {
        if (volRatio > 200) {
            volImpl.innerHTML = '<span style="color:var(--warning);"> CLIMAX POSSIBLE - Extreme volume may signal exhaustion</span>';
        } else if (volRatio > 130) {
            volImpl.innerHTML = '<span style="color:var(--success);"> STRONG CONVICTION - High volume confirms trend</span>';
        } else if (volRatio < 70) {
            volImpl.innerHTML = '<span style="color:var(--warning);"> WEAK CONVICTION - Low volume rally may fail</span>';
        } else {
            volImpl.innerHTML = '<span style="color:var(--muted);"> NEUTRAL - No unusual activity</span>';
        }
    }

    // Price vs Volume divergence
    const priceChange = parseFloat(last5[0].Close || 0) - parseFloat(last5[last5.length - 1].Close || 0);
    const priceUp = priceChange > 0;
    const volUp = volRatio > 100;

    const pvText = document.getElementById('priceVsVolumeText');
    const pvImpl = document.getElementById('priceVsVolumeImplication');
    if (pvText) {
        pvText.textContent = `${priceUp ? ' Price Up' : ' Price Down'} + ${volUp ? ' Volume Up' : ' Volume Down'}`;
    }
    if (pvImpl) {
        if (priceUp && volUp) {
            pvImpl.innerHTML = '<span style="color:var(--success);"> Healthy uptrend - confirmed</span>';
        } else if (priceUp && !volUp) {
            pvImpl.innerHTML = '<span style="color:var(--warning);"> Weak rally - divergence warning</span>';
        } else if (!priceUp && volUp) {
            pvImpl.innerHTML = '<span style="color:var(--danger);"> Strong selling - more downside likely</span>';
        } else {
            pvImpl.innerHTML = '<span style="color:var(--warning);"> Weak selling - may be near bottom</span>';
        }
    }

    // Conclusion
    const conclusion = document.getElementById('analysisConclusion');
    if (conclusion) {
        let conclusionText = '';
        if (gapUps > gapDowns && priceUp && volUp) {
            conclusionText = 'Strong bullish momentum confirmed by volume. Trend likely to continue.';
        } else if (gapUps > gapDowns && priceUp && !volUp) {
            conclusionText = 'Uptrend intact but showing fatigue. Watch for pullback to support before adding positions.';
        } else if (gapDowns > gapUps && !priceUp) {
            conclusionText = 'Bearish pressure building. Consider defensive positioning or wait for reversal signals.';
        } else {
            conclusionText = 'Mixed signals. Wait for clearer direction before taking new positions.';
        }
        if (pattern.emoji !== '--') {
            conclusionText += ` ${pattern.emoji} pattern suggests ${pattern.implication.replace(/[]/g, '').trim()}.`;
        }
        conclusion.textContent = conclusionText;
    }
}

// Update Trade Statistics
function updateTradeStatistics(data) {
    if (!data || data.length === 0) return;

    // Update symbol title
    const symbolTitle = document.getElementById('tradeStatsSymbol');
    if (symbolTitle) {
        symbolTitle.textContent = `${currentSymbol} - ${SYMBOL_NAMES[currentSymbol] || currentSymbol}`;
    }

    let wins = 0, losses = 0;
    let totalWin = 0, totalLoss = 0;
    let bestDay = -Infinity, worstDay = Infinity;
    let currentStreak = 0;
    let lastWasWin = null;

    data.forEach((row, index) => {
        const open = parseFloat(row.Open || 0);
        const close = parseFloat(row.Close || 0);
        const change = close - open;

        if (change >= 0) {
            wins++;
            totalWin += change;
            if (change > bestDay) bestDay = change;
            if (index === 0) { currentStreak = 1; lastWasWin = true; }
            else if (lastWasWin) currentStreak++;
            else lastWasWin = true;
        } else {
            losses++;
            totalLoss += Math.abs(change);
            if (change < worstDay) worstDay = change;
            if (index === 0) { currentStreak = 1; lastWasWin = false; }
            else if (!lastWasWin) currentStreak++;
            else lastWasWin = false;
        }
    });

    const totalDays = wins + losses;
    const winRate = totalDays > 0 ? (wins / totalDays * 100) : 0;
    const avgWin = wins > 0 ? totalWin / wins : 0;
    const avgLoss = losses > 0 ? totalLoss / losses : 0;

    const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };

    setEl('statWinRate', `${winRate.toFixed(1)}%`);
    setEl('statAvgWin', `$${avgWin.toFixed(2)}`);
    setEl('statAvgLoss', `$${avgLoss.toFixed(2)}`);
    setEl('statTotalDays', totalDays.toString());
    setEl('statBestDay', `+$${bestDay === -Infinity ? 0 : bestDay.toFixed(2)}`);
    setEl('statWorstDay', `$${worstDay === Infinity ? 0 : worstDay.toFixed(2)}`);
    setEl('statCurrentStreak', `${currentStreak} ${lastWasWin ? 'win' : 'loss'} days`);
}

function formatVolume(vol) {
    if (vol >= 1000000000) return (vol / 1000000000).toFixed(2) + 'B';
    if (vol >= 1000000) return (vol / 1000000).toFixed(2) + 'M';
    if (vol >= 1000) return (vol / 1000).toFixed(1) + 'K';
    return vol.toString();
}

// ==========================================
// AI ANALYSIS FUNCTIONS
// ==========================================
function askAIAnalysis(predefinedQuestion) {
    const inputEl = document.getElementById('aiQuestionInput');
    const responseArea = document.getElementById('aiResponseArea');
    const responseContent = document.getElementById('aiResponseContent');
    const loadingIndicator = document.getElementById('aiLoadingIndicator');

    const question = predefinedQuestion || inputEl?.value?.trim();

    if (!question) {
        alert('Please enter a question or click a quick analysis button.');
        return;
    }

    if (!historicalData || historicalData.length === 0) {
        alert('No historical data available. Please wait for data to load.');
        return;
    }

    // Show loading
    if (loadingIndicator) loadingIndicator.style.display = 'block';
    if (responseArea) responseArea.style.display = 'none';

    // Perform local analysis (no external API needed)
    setTimeout(() => {
        const analysis = performLocalAnalysis(question, historicalData);

        if (loadingIndicator) loadingIndicator.style.display = 'none';
        if (responseArea) responseArea.style.display = 'block';
        if (responseContent) responseContent.textContent = analysis;

        // Clear input if it was a custom question
        if (!predefinedQuestion && inputEl) inputEl.value = '';
    }, 500);
}

function performLocalAnalysis(question, data) {
    const lowerQuestion = question.toLowerCase();

    // Debug: Log data structure to help identify issues
    console.log('AI Analysis - Data length:', data.length);
    if (data.length > 0) {
        console.log('AI Analysis - Sample row:', data[0]);
        console.log('AI Analysis - Keys:', Object.keys(data[0]));
    }

    // Helper function to safely parse numbers
    const safeParseFloat = (val) => {
        const num = parseFloat(val);
        return isNaN(num) ? null : num;
    };

    // Extract key metrics from data - handle both lowercase and uppercase keys (CSV uses uppercase)
    const closes = data.map(d => safeParseFloat(d.Close ?? d.close)).filter(v => v !== null && v > 0);
    const opens = data.map(d => safeParseFloat(d.Open ?? d.open)).filter(v => v !== null && v > 0);
    const highs = data.map(d => safeParseFloat(d.High ?? d.high)).filter(v => v !== null && v > 0);
    const lows = data.map(d => safeParseFloat(d.Low ?? d.low)).filter(v => v !== null && v > 0);
    const volumes = data.map(d => parseInt(d.Volume ?? d.volume ?? 0) || 0);

    // Safety check: Ensure we have valid data
    if (closes.length === 0) {
        console.warn('AI Analysis - No valid close prices found');
        return "No valid price data found. Please ensure data is loaded correctly.";
    }

    console.log('AI Analysis - Parsed closes (first 5):', closes.slice(0, 5));

    const avgClose = closes.length > 0 ? closes.reduce((a, b) => a + b, 0) / closes.length : 0;
    const avgVolume = volumes.length > 0 ? volumes.reduce((a, b) => a + b, 0) / volumes.length : 0;
    const maxHigh = highs.length > 0 ? Math.max(...highs) : 0;
    const minLow = lows.length > 0 ? Math.min(...lows) : 0;
    const latestClose = closes.length > 0 ? closes[0] : 0;
    const oldestClose = closes.length > 0 ? closes[closes.length - 1] : 0;
    const periodReturn = oldestClose > 0 ? ((latestClose - oldestClose) / oldestClose * 100) : 0;

    // Calculate daily ranges
    const dailyRanges = data.map(d => {
        const high = parseFloat(d.High ?? d.high ?? 0);
        const low = parseFloat(d.Low ?? d.low ?? 0);
        return (isNaN(high) || isNaN(low)) ? 0 : high - low;
    }).filter(v => v > 0);
    const avgRange = dailyRanges.reduce((a, b) => a + b, 0) / dailyRanges.length;

    // Helper function to format date as "Mon DD"
    const formatDateShort = (dateStr) => {
        if (!dateStr) return 'N/A';
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const d = new Date(dateStr.split(' ')[0]);
        if (isNaN(d.getTime())) return 'N/A';
        return months[d.getMonth()] + ' ' + d.getDate();
    };

    // Find patterns
    if (lowerQuestion.includes('pattern')) {
        let patterns = [];

        // Check for uptrend/downtrend with dates
        const recentData = data.slice(0, 5);
        const recentCloses = recentData.map(d => parseFloat(d.Close ?? d.close ?? 0));
        const trendUp = recentCloses.every((c, i) => i === 0 || c >= recentCloses[i - 1] * 0.99);
        const trendDown = recentCloses.every((c, i) => i === 0 || c <= recentCloses[i - 1] * 1.01);

        if (trendUp && recentData.length >= 2) {
            const startDate = formatDateShort(recentData[recentData.length - 1].Date ?? recentData[recentData.length - 1].date);
            const endDate = formatDateShort(recentData[0].Date ?? recentData[0].date);
            const trendPct = recentCloses[recentCloses.length - 1] > 0 ? 
                ((recentCloses[0] - recentCloses[recentCloses.length - 1]) / recentCloses[recentCloses.length - 1] * 100).toFixed(1) : 0;
            patterns.push(` UPTREND detected: ${startDate}  ${endDate} (5 days, ${trendPct >= 0 ? '+' : ''}${trendPct}%)`);
        }
        if (trendDown && recentData.length >= 2) {
            const startDate = formatDateShort(recentData[recentData.length - 1].Date ?? recentData[recentData.length - 1].date);
            const endDate = formatDateShort(recentData[0].Date ?? recentData[0].date);
            const trendPct = recentCloses[recentCloses.length - 1] > 0 ? 
                ((recentCloses[0] - recentCloses[recentCloses.length - 1]) / recentCloses[recentCloses.length - 1] * 100).toFixed(1) : 0;
            patterns.push(` DOWNTREND detected: ${startDate}  ${endDate} (5 days, ${trendPct >= 0 ? '+' : ''}${trendPct}%)`);
        }

        // Check for consolidation
        const priceRange = (maxHigh - minLow) / avgClose * 100;
        if (priceRange < 3) patterns.push(' CONSOLIDATION: Price range is tight (' + priceRange.toFixed(2) + '%)');

        // Check for high volume days with dates and percentages
        const highVolDaysData = data.map((d, i) => {
            const vol = parseInt(d.Volume ?? d.volume ?? 0);
            const pct = avgVolume > 0 ? Math.round((vol / avgVolume) * 100) : 0;
            return { date: d.Date ?? d.date, vol, pct, idx: i };
        }).filter(d => d.pct > 150).sort((a, b) => b.pct - a.pct);

        if (highVolDaysData.length > 0) {
            const maxShow = 5;
            const shown = highVolDaysData.slice(0, maxShow);
            const dateStrs = shown.map(d => `${formatDateShort(d.date)} (${d.pct}%)`).join(', ');
            const moreCount = highVolDaysData.length - maxShow;
            const moreStr = moreCount > 0 ? ` +${moreCount} more` : '';
            patterns.push(` ${highVolDaysData.length} HIGH VOLUME days (>150% avg):
   ${dateStrs}${moreStr}`);
        }

        // Check for gaps with dates and dollar amounts
        let gapUpsData = [], gapDownsData = [];
        for (let i = 0; i < data.length - 1; i++) {
            const currLow = parseFloat(data[i].Low ?? data[i].low ?? 0);
            const currHigh = parseFloat(data[i].High ?? data[i].high ?? 0);
            const prevHigh = parseFloat(data[i + 1].High ?? data[i + 1].high ?? 0);
            const prevLow = parseFloat(data[i + 1].Low ?? data[i + 1].low ?? 0);
            const currDate = data[i].Date ?? data[i].date;
            
            if (currLow > prevHigh) {
                const gapSize = currLow - prevHigh;
                gapUpsData.push({ date: currDate, size: gapSize });
            }
            if (currHigh < prevLow) {
                const gapSize = prevLow - currHigh;
                gapDownsData.push({ date: currDate, size: gapSize });
            }
        }

        if (gapUpsData.length > 0) {
            gapUpsData.sort((a, b) => b.size - a.size);
            const maxShow = 3;
            const shown = gapUpsData.slice(0, maxShow);
            const dateStrs = shown.map(d => `${formatDateShort(d.date)}: +$${d.size.toFixed(2)}`).join(', ');
            const moreCount = gapUpsData.length - maxShow;
            const moreStr = moreCount > 0 ? ` +${moreCount} more` : '';
            patterns.push(` ${gapUpsData.length} GAP UPs detected:
   ${dateStrs}${moreStr}`);
        }

        if (gapDownsData.length > 0) {
            gapDownsData.sort((a, b) => b.size - a.size);
            const maxShow = 3;
            const shown = gapDownsData.slice(0, maxShow);
            const dateStrs = shown.map(d => `${formatDateShort(d.date)}: -$${d.size.toFixed(2)}`).join(', ');
            const moreCount = gapDownsData.length - maxShow;
            const moreStr = moreCount > 0 ? ` +${moreCount} more` : '';
            patterns.push(` ${gapDownsData.length} GAP DOWNs detected:
   ${dateStrs}${moreStr}`);
        }

        return ` PATTERN ANALYSIS for ${currentSymbol} (${data.length} days)\n\n` +
               (patterns.length > 0 ? patterns.join('\n') : 'No significant patterns detected') +
               `\n\n Summary:\n` +
               ` Period Return: ${periodReturn >= 0 ? '+' : ''}${periodReturn.toFixed(2)}%\n` +
               ` Price Range: $${minLow.toFixed(2)} - $${maxHigh.toFixed(2)}\n` +
               ` Avg Daily Range: $${avgRange.toFixed(2)}`;
    }

    // Calculate averages
    if (lowerQuestion.includes('average')) {
        const avgOpen = opens.reduce((a, b) => a + b, 0) / opens.length;
        const avgHigh = highs.reduce((a, b) => a + b, 0) / highs.length;
        const avgLow = lows.reduce((a, b) => a + b, 0) / lows.length;

        // Daily change averages
        const dailyChanges = data.map(d => {
            const close = parseFloat(d.Close ?? d.close ?? 0);
            const open = parseFloat(d.Open ?? d.open ?? 0);
            return (isNaN(close) || isNaN(open)) ? 0 : close - open;
        });
        const avgDailyChange = dailyChanges.reduce((a, b) => a + b, 0) / dailyChanges.length;
        const positiveDays = dailyChanges.filter(c => c > 0).length;
        const negativeDays = dailyChanges.filter(c => c < 0).length;

        return ` AVERAGE CALCULATIONS for ${currentSymbol} (${data.length} days)\n\n` +
               ` Price Averages:\n` +
               ` Average Open: $${avgOpen.toFixed(2)}\n` +
               ` Average High: $${avgHigh.toFixed(2)}\n` +
               ` Average Low: $${avgLow.toFixed(2)}\n` +
               ` Average Close: $${avgClose.toFixed(2)}\n\n` +
               ` Movement Averages:\n` +
               ` Average Daily Range: $${avgRange.toFixed(2)}\n` +
               ` Average Daily Change: ${avgDailyChange >= 0 ? '+' : ''}$${avgDailyChange.toFixed(2)}\n` +
               ` Average Volume: ${formatVolume(avgVolume)}\n\n` +
               ` Day Breakdown:\n` +
               ` Positive Days: ${positiveDays} (${(positiveDays/data.length*100).toFixed(1)}%)\n` +
               ` Negative Days: ${negativeDays} (${(negativeDays/data.length*100).toFixed(1)}%)`;
    }

    // Support and resistance
    if (lowerQuestion.includes('support') || lowerQuestion.includes('resistance')) {
        // Find pivot points
        const pivotHigh = maxHigh;
        const pivotLow = minLow;
        const pivot = (maxHigh + minLow + latestClose) / 3;

        const r1 = 2 * pivot - minLow;
        const r2 = pivot + (maxHigh - minLow);
        const s1 = 2 * pivot - maxHigh;
        const s2 = pivot - (maxHigh - minLow);

        // Find price clusters (simple approach)
        const priceRounded = closes.map(c => Math.round(c));
        const priceCounts = {};
        priceRounded.forEach(p => priceCounts[p] = (priceCounts[p] || 0) + 1);
        const sortedPrices = Object.entries(priceCounts).sort((a, b) => b[1] - a[1]);

        return ` SUPPORT & RESISTANCE for ${currentSymbol}\n\n` +
               ` Resistance Levels:\n` +
               ` R2 (Strong): $${r2.toFixed(2)}\n` +
               ` R1 (Moderate): $${r1.toFixed(2)}\n` +
               ` Period High: $${maxHigh.toFixed(2)}\n\n` +
               ` Support Levels:\n` +
               ` Period Low: $${minLow.toFixed(2)}\n` +
               ` S1 (Moderate): $${s1.toFixed(2)}\n` +
               ` S2 (Strong): $${s2.toFixed(2)}\n\n` +
               ` Pivot Point: $${pivot.toFixed(2)}\n` +
               ` Current Price: $${latestClose.toFixed(2)} (${latestClose > pivot ? 'Above' : 'Below'} Pivot)`;
    }

    // Trend analysis
    if (lowerQuestion.includes('trend')) {
        // Calculate moving averages
        const sma5 = closes.slice(0, 5).reduce((a, b) => a + b, 0) / 5;
        const sma10 = closes.slice(0, 10).reduce((a, b) => a + b, 0) / Math.min(10, closes.length);
        const sma20 = closes.slice(0, 20).reduce((a, b) => a + b, 0) / Math.min(20, closes.length);

        // Determine trend
        let trend = 'NEUTRAL';
        let trendStrength = 'Moderate';

        if (latestClose > sma5 && sma5 > sma10 && sma10 > sma20) {
            trend = 'BULLISH';
            trendStrength = 'Strong';
        } else if (latestClose < sma5 && sma5 < sma10 && sma10 < sma20) {
            trend = 'BEARISH';
            trendStrength = 'Strong';
        } else if (latestClose > sma10) {
            trend = 'BULLISH';
            trendStrength = 'Weak';
        } else if (latestClose < sma10) {
            trend = 'BEARISH';
            trendStrength = 'Weak';
        }

        // Calculate momentum
        const momentum5 = ((latestClose - closes[4]) / closes[4] * 100);
        const momentum10 = closes.length >= 10 ? ((latestClose - closes[9]) / closes[9] * 100) : 0;

        const trendEmoji = trend === 'BULLISH' ? '' : trend === 'BEARISH' ? '' : '';

        return ` TREND ANALYSIS for ${currentSymbol}\n\n` +
               `${trendEmoji} Overall Trend: ${trend} (${trendStrength})\n\n` +
               ` Moving Averages:\n` +
               ` 5-Day SMA: $${sma5.toFixed(2)}\n` +
               ` 10-Day SMA: $${sma10.toFixed(2)}\n` +
               ` 20-Day SMA: $${sma20.toFixed(2)}\n\n` +
               ` Momentum:\n` +
               ` 5-Day: ${momentum5 >= 0 ? '+' : ''}${momentum5.toFixed(2)}%\n` +
               ` 10-Day: ${momentum10 >= 0 ? '+' : ''}${momentum10.toFixed(2)}%\n\n` +
               ` Period Performance:\n` +
               ` Total Return: ${periodReturn >= 0 ? '+' : ''}${periodReturn.toFixed(2)}%\n` +
               ` Start: $${oldestClose.toFixed(2)}  End: $${latestClose.toFixed(2)}`;
    }

    // Default response for other questions
    return ` DATA SUMMARY for ${currentSymbol} (${data.length} days)\n\n` +
           `Current Price: $${latestClose.toFixed(2)}\n` +
           `Period Range: $${minLow.toFixed(2)} - $${maxHigh.toFixed(2)}\n` +
           `Average Close: $${avgClose.toFixed(2)}\n` +
           `Average Volume: ${formatVolume(avgVolume)}\n` +
           `Period Return: ${periodReturn >= 0 ? '+' : ''}${periodReturn.toFixed(2)}%\n\n` +
           ` Try asking:\n` +
           ` "Find patterns"\n` +
           ` "Calculate averages"\n` +
           ` "Identify support and resistance"\n` +
           ` "Show trend analysis"`;
}

// Auto-update historical data when symbol changes
const originalLoadSymbolData = typeof loadSymbolData === 'function' ? loadSymbolData : null;
if (originalLoadSymbolData) {
    loadSymbolData = function(symbol) {
        originalLoadSymbolData(symbol);
        setTimeout(updateHistoricalData, 1000);
    };
}

// ==================== MARKET CONDITIONS GUARD RAIL ====================

// Load market conditions from JSON file
async function loadMarketConditions() {
    try {
        const paths = [
            'data/market_conditions.json',
            'web/data/market_conditions.json',
            'https://aadey002.github.io/Stock-agent-/data/market_conditions.json'
        ];
        
        let data = null;
        for (const path of paths) {
            try {
                const response = await fetch(path + '?t=' + Date.now());
                if (response.ok) {
                    data = await response.json();
                    console.log(' Loaded market_conditions.json from:', path);
                    break;
                }
            } catch (e) {
                continue;
            }
        }
        
        if (!data) {
            console.warn(' Could not load market_conditions.json, using calculated values');
            updateMarketConditions();
            return;
        }
        
        // Update VIX
        const vixEl = document.getElementById('vixValue');
        const vixStatusEl = document.getElementById('vixStatus');
        if (vixEl && data.vix_level !== undefined) {
            vixEl.textContent = parseFloat(data.vix_level).toFixed(1);
            const vix = parseFloat(data.vix_level);
            if (vix < 20) {
                vixEl.style.color = 'var(--success)';
            } else if (vix < 30) {
                vixEl.style.color = 'var(--warning)';
            } else {
                vixEl.style.color = 'var(--danger)';
            }
        }
        if (vixStatusEl && data.vix_status) {
            vixStatusEl.textContent = data.vix_status;
            if (data.vix_status.toLowerCase().includes('low')) {
                vixStatusEl.style.color = 'var(--success)';
            } else if (data.vix_status.toLowerCase().includes('high')) {
                vixStatusEl.style.color = 'var(--danger)';
            } else {
                vixStatusEl.style.color = 'var(--warning)';
            }
        }
        
        // Update SPY Trend
        const spyTrendEl = document.getElementById('spyTrendStatus');
        const spyDetailEl = document.getElementById('spyTrendDetail');
        if (spyTrendEl && data.spy_trend) {
            spyTrendEl.textContent = data.spy_trend;
            if (data.spy_trend.toLowerCase().includes('above')) {
                spyTrendEl.style.color = 'var(--success)';
            } else {
                spyTrendEl.style.color = 'var(--danger)';
            }
        }
        if (spyDetailEl && data.spy_trend_pct !== undefined) {
            const pct = parseFloat(data.spy_trend_pct);
            spyDetailEl.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(1) + '% from MA';
        }
        
        // Update Sector Rotation
        const sectorEl = document.getElementById('sectorRotation');
        const sectorDetailEl = document.getElementById('sectorDetail');
        if (sectorEl && data.sector_rotation) {
            sectorEl.textContent = data.sector_rotation;
            if (data.sector_rotation.toLowerCase().includes('on')) {
                sectorEl.style.color = 'var(--success)';
            } else if (data.sector_rotation.toLowerCase().includes('off')) {
                sectorEl.style.color = 'var(--danger)';
            } else {
                sectorEl.style.color = 'var(--warning)';
            }
        }
        if (sectorDetailEl && data.sector_rotation_desc) {
            sectorDetailEl.textContent = data.sector_rotation_desc;
        }
        
        // Update Trade Conditions
        const conditionsEl = document.getElementById('tradeConditions');
        const conditionsDetailEl = document.getElementById('conditionsDetail');
        if (conditionsEl && data.trade_conditions) {
            conditionsEl.textContent = data.trade_conditions;
            if (data.trade_conditions.toLowerCase().includes('favorable')) {
                conditionsEl.style.color = 'var(--success)';
            } else if (data.trade_conditions.toLowerCase().includes('unfavorable')) {
                conditionsEl.style.color = 'var(--danger)';
            } else {
                conditionsEl.style.color = 'var(--warning)';
            }
        }
        if (conditionsDetailEl && data.conditions_detail) {
            conditionsDetailEl.textContent = data.conditions_detail;
        }
        
        // Update Overall Status (Safe to Trade)
        const overallEl = document.getElementById('overallMarketStatus');
        const recommendationEl = document.getElementById('marketRecommendation');
        if (overallEl) {
            if (data.safe_to_trade === true) {
                overallEl.textContent = ' SAFE TO TRADE';
                overallEl.style.background = 'var(--success)';
                overallEl.style.color = 'white';
            } else if (data.safe_to_trade === false) {
                overallEl.textContent = ' CAUTION';
                overallEl.style.background = 'var(--danger)';
                overallEl.style.color = 'white';
            } else {
                overallEl.textContent = ' MIXED';
                overallEl.style.background = 'var(--warning)';
                overallEl.style.color = 'white';
            }
        }
        
        if (recommendationEl && data.recommendation) {
            const isSafe = data.safe_to_trade === true;
            const borderColor = isSafe ? 'var(--success)' : 'var(--danger)';
            const bgColor = isSafe ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
            recommendationEl.style.borderLeft = '4px solid ' + borderColor;
            recommendationEl.style.background = bgColor;
            recommendationEl.innerHTML = '<span style="font-weight: 600; color: ' + borderColor + ';">' + 
                (isSafe ? ' ' : ' ') + '</span>' +
                '<span style="font-size: 11px; color: var(--muted);">' + data.recommendation + '</span>';
        }
        
        console.log(' Market conditions updated from JSON');
        
    } catch (error) {
        console.error('Error loading market conditions:', error);
        // Fall back to calculated values
        updateMarketConditions();
    }
}

function updateMarketConditions() {
    // This function analyzes overall market conditions
    // and provides a "guard rail" before trade recommendations

    if (!currentData || currentData.length < 20) return;

    const data = currentData;
    const latestPrice = data[data.length - 1].Close;

    // Calculate 20-MA for SPY trend
    let ma20 = 0;
    for (let i = data.length - 20; i < data.length; i++) {
        ma20 += data[i].Close;
    }
    ma20 /= 20;

    const pctFromMA = ((latestPrice - ma20) / ma20) * 100;
    const aboveMA = latestPrice > ma20;

    // Simulate VIX (in production, you'd fetch real VIX data)
    // Use recent volatility as a proxy
    let volatility = 0;
    for (let i = data.length - 10; i < data.length; i++) {
        const dailyRange = (data[i].High - data[i].Low) / data[i].Close;
        volatility += dailyRange;
    }
    volatility = (volatility / 10) * 100 * 16; // Annualized proxy
    const estimatedVIX = Math.max(10, Math.min(50, volatility * 2));

    // Analyze sector rotation (using available sector data)
    let riskOn = true;
    let leadingSector = 'Tech';

    // Calculate recent momentum
    const recentReturn = ((data[data.length - 1].Close - data[data.length - 6].Close) / data[data.length - 6].Close) * 100;

    // Determine overall market status
    let overallStatus = 'SAFE TO TRADE';
    let statusColor = 'var(--success)';
    let statusEmoji = '';
    let statusBg = 'rgba(16, 185, 129, 0.1)';

    let greenCount = 0;

    // VIX analysis
    const vixEl = document.getElementById('vixValue');
    const vixStatusEl = document.getElementById('vixStatus');
    if (vixEl && vixStatusEl) {
        vixEl.textContent = estimatedVIX.toFixed(1);
        if (estimatedVIX < 20) {
            vixEl.style.color = 'var(--success)';
            vixStatusEl.textContent = 'Low Volatility';
            vixStatusEl.style.color = 'var(--success)';
            greenCount++;
        } else if (estimatedVIX < 30) {
            vixEl.style.color = 'var(--warning)';
            vixStatusEl.textContent = 'Elevated';
            vixStatusEl.style.color = 'var(--warning)';
        } else {
            vixEl.style.color = 'var(--danger)';
            vixStatusEl.textContent = 'High Fear';
            vixStatusEl.style.color = 'var(--danger)';
        }
    }

    // SPY Trend analysis
    const spyTrendEl = document.getElementById('spyTrendStatus');
    const spyDetailEl = document.getElementById('spyTrendDetail');
    if (spyTrendEl && spyDetailEl) {
        if (aboveMA) {
            spyTrendEl.textContent = 'Above 20MA';
            spyTrendEl.style.color = 'var(--success)';
            spyDetailEl.textContent = `+${pctFromMA.toFixed(1)}% from MA`;
            greenCount++;
        } else {
            spyTrendEl.textContent = 'Below 20MA';
            spyTrendEl.style.color = pctFromMA < -2 ? 'var(--danger)' : 'var(--warning)';
            spyDetailEl.textContent = `${pctFromMA.toFixed(1)}% from MA`;
        }
    }

    // Sector rotation
    const sectorEl = document.getElementById('sectorRotation');
    const sectorDetailEl = document.getElementById('sectorDetail');
    if (sectorEl && sectorDetailEl) {
        if (recentReturn > 1) {
            sectorEl.textContent = 'Risk-On';
            sectorEl.style.color = 'var(--success)';
            sectorDetailEl.textContent = 'Momentum Strong';
            greenCount++;
        } else if (recentReturn > -1) {
            sectorEl.textContent = 'Neutral';
            sectorEl.style.color = 'var(--warning)';
            sectorDetailEl.textContent = 'Mixed Signals';
        } else {
            sectorEl.textContent = 'Risk-Off';
            sectorEl.style.color = 'var(--danger)';
            sectorDetailEl.textContent = 'Defensive Mode';
        }
    }

    // Trade conditions
    const conditionsEl = document.getElementById('tradeConditions');
    const conditionsDetailEl = document.getElementById('conditionsDetail');
    if (conditionsEl && conditionsDetailEl) {
        conditionsDetailEl.textContent = `${greenCount}/3 Green`;
        if (greenCount >= 2) {
            conditionsEl.textContent = 'Favorable';
            conditionsEl.style.color = 'var(--success)';
        } else if (greenCount >= 1) {
            conditionsEl.textContent = 'Caution';
            conditionsEl.style.color = 'var(--warning)';
        } else {
            conditionsEl.textContent = 'Unfavorable';
            conditionsEl.style.color = 'var(--danger)';
        }
    }

    // Overall status
    if (greenCount >= 2 && estimatedVIX < 25) {
        overallStatus = 'SAFE TO TRADE';
        statusColor = 'var(--success)';
        statusEmoji = '';
        statusBg = 'rgba(16, 185, 129, 0.1)';
    } else if (greenCount >= 1 || estimatedVIX < 30) {
        overallStatus = 'CAUTION';
        statusColor = 'var(--warning)';
        statusEmoji = '';
        statusBg = 'rgba(245, 158, 11, 0.1)';
    } else {
        overallStatus = 'SIT OUT';
        statusColor = 'var(--danger)';
        statusEmoji = '';
        statusBg = 'rgba(239, 68, 68, 0.1)';
    }

    const overallEl = document.getElementById('overallMarketStatus');
    if (overallEl) {
        overallEl.innerHTML = `${statusEmoji} ${overallStatus}`;
        overallEl.style.background = statusColor;
    }

    // Update recommendation
    const recEl = document.getElementById('marketRecommendation');
    if (recEl) {
        let recText = '';
        let recIcon = '';
        let borderColor = '';

        if (overallStatus === 'SAFE TO TRADE') {
            recIcon = '';
            recText = `<span style="font-weight: 600; color: var(--success);">${recIcon} Market conditions support trading.</span>`;
            recText += `<span style="font-size: 11px; color: var(--muted);"> VIX at ${estimatedVIX.toFixed(0)}, trend ${aboveMA ? 'bullish' : 'weak'}, momentum ${recentReturn > 0 ? 'positive' : 'negative'}. Proceed with normal position sizing.</span>`;
            borderColor = 'var(--success)';
        } else if (overallStatus === 'CAUTION') {
            recIcon = '';
            recText = `<span style="font-weight: 600; color: var(--warning);">${recIcon} Trade with caution.</span>`;
            recText += `<span style="font-size: 11px; color: var(--muted);"> Some conditions unfavorable. Consider reducing position size by 50% and tightening stops.</span>`;
            borderColor = 'var(--warning)';
        } else {
            recIcon = '';
            recText = `<span style="font-weight: 600; color: var(--danger);">${recIcon} Consider sitting out.</span>`;
            recText += `<span style="font-size: 11px; color: var(--muted);"> Market conditions are unfavorable. High volatility and weak trend suggest waiting for better entry conditions.</span>`;
            borderColor = 'var(--danger)';
        }

        recEl.innerHTML = recText;
        recEl.style.background = statusBg;
        recEl.style.borderLeftColor = borderColor;
    }
}

// Call updateMarketConditions when data loads
const originalUpdateDailyAnalysis = typeof updateDailyAnalysis === 'function' ? updateDailyAnalysis : null;
if (originalUpdateDailyAnalysis) {
    const wrappedUpdateDailyAnalysis = updateDailyAnalysis;
    updateDailyAnalysis = function() {
        wrappedUpdateDailyAnalysis();
        setTimeout(updateMarketConditions, 100);
    };
}

// Also trigger on symbol load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(updateMarketConditions, 1000);
});

// ==================== OPTIONS CALCULATOR (Black-Scholes) ====================

let optionPnLChart = null;

// Standard normal cumulative distribution function
function normCDF(x) {
    const a1 = 0.254829592;
    const a2 = -0.284496736;
    const a3 = 1.421413741;
    const a4 = -1.453152027;
    const a5 = 1.061405429;
    const p = 0.3275911;

    const sign = x < 0 ? -1 : 1;
    x = Math.abs(x) / Math.sqrt(2);

    const t = 1.0 / (1.0 + p * x);
    const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);

    return 0.5 * (1.0 + sign * y);
}

// Standard normal probability density function
function normPDF(x) {
    return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
}

// Black-Scholes pricing and Greeks
function blackScholes(S, K, T, r, sigma, optionType) {
    // S = Stock price, K = Strike, T = Time to expiry (years)
    // r = Risk-free rate (decimal), sigma = volatility (decimal)

    // Validate inputs
    if (!S || S <= 0) S = 100;
    if (!K || K <= 0) K = 100;
    if (T <= 0) T = 0.0001; // Prevent division by zero for 0DTE
    if (!sigma || sigma <= 0) sigma = 0.01; // Minimum 1% IV
    if (r === undefined || r === null) r = 0.05;

    console.log(` Black-Scholes inputs: S=${S}, K=${K}, T=${T}, r=${r}, sigma=${sigma}, type=${optionType}`);

    const sqrtT = Math.sqrt(T);
    const d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * sqrtT);
    const d2 = d1 - sigma * sqrtT;

    let price, delta, gamma, theta, vega;

    if (optionType === 'call') {
        price = S * normCDF(d1) - K * Math.exp(-r * T) * normCDF(d2);
        delta = normCDF(d1);
        theta = (-S * normPDF(d1) * sigma / (2 * sqrtT) - r * K * Math.exp(-r * T) * normCDF(d2)) / 365;
    } else {
        price = K * Math.exp(-r * T) * normCDF(-d2) - S * normCDF(-d1);
        delta = normCDF(d1) - 1;
        theta = (-S * normPDF(d1) * sigma / (2 * sqrtT) + r * K * Math.exp(-r * T) * normCDF(-d2)) / 365;
    }

    gamma = normPDF(d1) / (S * sigma * sqrtT);
    vega = S * normPDF(d1) * sqrtT / 100; // Per 1% change in IV

    // Ensure no NaN values
    if (isNaN(price)) price = 0;
    if (isNaN(delta)) delta = 0;
    if (isNaN(gamma)) gamma = 0;
    if (isNaN(theta)) theta = 0;
    if (isNaN(vega)) vega = 0;

    console.log(` Black-Scholes result: price=${price.toFixed(4)}, delta=${delta.toFixed(4)}`);

    return { price, delta, gamma, theta, vega, d1, d2 };
}

function calculateOptionPrice() {
    console.log(' calculateOptionPrice() called');

    try {
        // Get input elements
        const stockPriceEl = document.getElementById('optStockPrice');
        const strikePriceEl = document.getElementById('optStrikePrice');
        const dteEl = document.getElementById('optDTE');
        const ivEl = document.getElementById('optIV');
        const rateEl = document.getElementById('optRate');
        const typeEl = document.getElementById('optType');
        const contractsEl = document.getElementById('optContracts');

        // Validate elements exist
        if (!stockPriceEl || !strikePriceEl || !dteEl || !ivEl || !rateEl || !typeEl || !contractsEl) {
            console.error(' Options Calculator: Missing input elements');
            return;
        }

        const S = parseFloat(stockPriceEl.value) || 600;
        const K = parseFloat(strikePriceEl.value) || 605;
        const DTE = parseInt(dteEl.value) || 7;
        const IV = (parseFloat(ivEl.value) || 20) / 100;
        const r = (parseFloat(rateEl.value) || 5) / 100;
        const optionType = typeEl.value || 'call';
        const contracts = parseInt(contractsEl.value) || 1;

        console.log(` Inputs: S=${S}, K=${K}, DTE=${DTE}, IV=${IV}, r=${r}, type=${optionType}, contracts=${contracts}`);

        const T = DTE / 365;

        const result = blackScholes(S, K, T, r, IV, optionType);
        console.log(' Black-Scholes result:', result);

        // Validate result
        if (!result || isNaN(result.price)) {
            console.error(' Invalid Black-Scholes result');
            return;
        }

        // Option price and total cost
        const optionPrice = result.price;
        const totalCost = optionPrice * 100 * contracts;

        // Update display elements with safety checks
        const setEl = (id, val) => {
            const el = document.getElementById(id);
            if (el) el.textContent = val;
            else console.warn(`Element ${id} not found`);
        };

        setEl('optPriceResult', `$${optionPrice.toFixed(2)}`);
        setEl('optTotalCost', `Total: $${totalCost.toFixed(2)} (${contracts} contract${contracts > 1 ? 's' : ''})`);

        // Intrinsic and extrinsic value
        let intrinsic = optionType === 'call' ? Math.max(0, S - K) : Math.max(0, K - S);
        let extrinsic = Math.max(0, optionPrice - intrinsic);

        setEl('optIntrinsic', `$${intrinsic.toFixed(2)}`);
        setEl('optExtrinsic', `Extrinsic: $${extrinsic.toFixed(2)}`);

        // Breakeven
        const breakeven = optionType === 'call' ? K + optionPrice : K - optionPrice;
        setEl('optBreakeven', `$${breakeven.toFixed(2)}`);

        // Max profit and loss
        const maxLoss = totalCost;
        setEl('optMaxLoss', `-$${maxLoss.toFixed(2)}`);

        if (optionType === 'call') {
            setEl('optMaxProfit', 'Unlimited');
        } else {
            const maxProfit = (K - optionPrice) * 100 * contracts;
            setEl('optMaxProfit', `$${Math.max(0, maxProfit).toFixed(2)}`);
        }

        // Greeks
        setEl('optDelta', result.delta.toFixed(4));
        setEl('optGamma', result.gamma.toFixed(4));
        setEl('optTheta', result.theta.toFixed(4));
        setEl('optVega', result.vega.toFixed(4));

        console.log(' Options Calculator updated successfully');

        // Draw P&L chart
        drawOptionPnLChart(S, K, optionPrice, optionType, contracts);

    } catch (error) {
        console.error(' Options Calculator error:', error);
    }
}

function drawOptionPnLChart(stockPrice, strike, premium, optionType, contracts) {
    const ctx = document.getElementById('optionPnLChart');
    if (!ctx) return;

    // Generate price range (+/-30% from current stock price)
    const minPrice = stockPrice * 0.7;
    const maxPrice = stockPrice * 1.3;
    const step = (maxPrice - minPrice) / 50;

    const labels = [];
    const pnlData = [];

    for (let price = minPrice; price <= maxPrice; price += step) {
        labels.push(price.toFixed(0));

        let pnl;
        if (optionType === 'call') {
            pnl = (Math.max(0, price - strike) - premium) * 100 * contracts;
        } else {
            pnl = (Math.max(0, strike - price) - premium) * 100 * contracts;
        }
        pnlData.push(pnl);
    }

    // Destroy existing chart
    if (optionPnLChart) {
        optionPnLChart.destroy();
    }

    const breakeven = optionType === 'call' ? strike + premium : strike - premium;

    optionPnLChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'P&L at Expiration',
                data: pnlData,
                borderColor: '#3B82F6',
                backgroundColor: pnlData.map(v => v >= 0 ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'),
                fill: true,
                tension: 0.1,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                annotation: {
                    annotations: {
                        zeroLine: {
                            type: 'line',
                            yMin: 0,
                            yMax: 0,
                            borderColor: 'rgba(255, 255, 255, 0.5)',
                            borderWidth: 1,
                            borderDash: [5, 5]
                        },
                        strikeLine: {
                            type: 'line',
                            xMin: labels.findIndex(l => parseFloat(l) >= strike),
                            xMax: labels.findIndex(l => parseFloat(l) >= strike),
                            borderColor: 'rgba(245, 158, 11, 0.7)',
                            borderWidth: 2,
                            label: {
                                display: true,
                                content: `Strike: $${strike}`,
                                position: 'start'
                            }
                        },
                        breakevenLine: {
                            type: 'line',
                            xMin: labels.findIndex(l => parseFloat(l) >= breakeven),
                            xMax: labels.findIndex(l => parseFloat(l) >= breakeven),
                            borderColor: 'rgba(16, 185, 129, 0.7)',
                            borderWidth: 2,
                            borderDash: [3, 3],
                            label: {
                                display: true,
                                content: `BE: $${breakeven.toFixed(2)}`,
                                position: 'end'
                            }
                        },
                        currentPrice: {
                            type: 'line',
                            xMin: labels.findIndex(l => parseFloat(l) >= stockPrice),
                            xMax: labels.findIndex(l => parseFloat(l) >= stockPrice),
                            borderColor: 'rgba(59, 130, 246, 0.7)',
                            borderWidth: 2,
                            label: {
                                display: true,
                                content: `Current: $${stockPrice}`,
                                position: 'center'
                            }
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Stock Price at Expiration ($)', color: '#9CA3AF' },
                    ticks: { color: '#9CA3AF', maxTicksLimit: 10 },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    title: { display: true, text: 'Profit/Loss ($)', color: '#9CA3AF' },
                    ticks: {
                        color: '#9CA3AF',
                        callback: function(value) {
                            return value >= 0 ? `+$${value}` : `-$${Math.abs(value)}`;
                        }
                    },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        }
    });
}

// ==========================================
// OPTIONS CALCULATOR MANUAL UPDATE HELPERS
// ==========================================

// Adjust any input value by a delta
function adjustOptValue(inputId, delta) {
    const el = document.getElementById(inputId);
    if (!el) return;
    const current = parseFloat(el.value) || 0;
    const newVal = Math.max(0, current + delta);
    el.value = inputId === 'optContracts' ? Math.max(1, Math.round(newVal)) : newVal.toFixed(2);
    calculateOptionPrice();
}

// Set strike to ATM (at the money)
function setStrikeATM() {
    const stockPrice = parseFloat(document.getElementById('optStockPrice').value) || 600;
    const nearestStrike = Math.round(stockPrice / 5) * 5;
    document.getElementById('optStrikePrice').value = nearestStrike;
    calculateOptionPrice();
}

// Set strike OTM (out of the money)
function setStrikeOTM(amount) {
    const stockPrice = parseFloat(document.getElementById('optStockPrice').value) || 600;
    const optType = document.getElementById('optType').value;
    const nearestStrike = Math.round(stockPrice / 5) * 5;
    // For calls: OTM = above stock price; For puts: OTM = below stock price
    const strike = optType === 'call' ? nearestStrike + amount : nearestStrike - amount;
    document.getElementById('optStrikePrice').value = strike;
    calculateOptionPrice();
}

// Set strike ITM (in the money)
function setStrikeITM(amount) {
    const stockPrice = parseFloat(document.getElementById('optStockPrice').value) || 600;
    const optType = document.getElementById('optType').value;
    const nearestStrike = Math.round(stockPrice / 5) * 5;
    // For calls: ITM = below stock price; For puts: ITM = above stock price
    const strike = optType === 'call' ? nearestStrike - amount : nearestStrike + amount;
    document.getElementById('optStrikePrice').value = strike;
    calculateOptionPrice();
}

// Set DTE preset
function setDTE(days) {
    document.getElementById('optDTE').value = days;
    calculateOptionPrice();
}

// Set IV preset
function setIV(iv) {
    document.getElementById('optIV').value = iv;
    calculateOptionPrice();
}

// Set option type with visual toggle
function setOptionType(type) {
    document.getElementById('optType').value = type;
    const btnCall = document.getElementById('btnCall');
    const btnPut = document.getElementById('btnPut');

    if (type === 'call') {
        btnCall.style.background = 'var(--success)';
        btnCall.style.color = 'white';
        btnCall.style.border = 'none';
        btnPut.style.background = 'var(--card-bg)';
        btnPut.style.color = 'var(--text)';
        btnPut.style.border = '1px solid var(--border)';
    } else {
        btnPut.style.background = 'var(--danger)';
        btnPut.style.color = 'white';
        btnPut.style.border = 'none';
        btnCall.style.background = 'var(--card-bg)';
        btnCall.style.color = 'var(--text)';
        btnCall.style.border = '1px solid var(--border)';
    }
    calculateOptionPrice();
}

// Set contracts preset
function setContracts(num) {
    document.getElementById('optContracts').value = num;
    calculateOptionPrice();
}

// Reset options calculator to defaults
function resetOptionsCalc() {
    document.getElementById('optStockPrice').value = '600';
    document.getElementById('optStrikePrice').value = '605';
    document.getElementById('optDTE').value = '7';
    document.getElementById('optIV').value = '20';
    document.getElementById('optRate').value = '5.0';
    document.getElementById('optContracts').value = '1';
    setOptionType('call');
    calculateOptionPrice();
}

function useCurrentSymbolPrice() {
    // Try currentData first, then tickerPrice display
    let price = null;
    
    if (currentData && currentData.length > 0) {
        price = parseFloat(currentData[currentData.length - 1].Close);
    } else {
        // Fallback to header ticker price
        const tickerPrice = document.getElementById('tickerPrice');
        if (tickerPrice) {
            price = parseFloat(tickerPrice.textContent.replace('$', ''));
        }
    }
    
    if (price && !isNaN(price)) {
        document.getElementById('optStockPrice').value = price.toFixed(2);
        // Also suggest a reasonable strike (nearest $5)
        const nearestStrike = Math.round(price / 5) * 5;
        document.getElementById('optStrikePrice').value = nearestStrike;
        calculateOptionPrice();
    } else {
        alert('No price data loaded. Please select a symbol first.');
    }
}

// Auto-update Options Calculator price when symbol changes
function updateOptionsCalcPrice() {
    let price = null;
    
    // Try currentData first
    if (currentData && currentData.length > 0) {
        price = parseFloat(currentData[currentData.length - 1].Close);
    } else {
        // Fallback to header ticker price
        const tickerPrice = document.getElementById('tickerPrice');
        if (tickerPrice) {
            price = parseFloat(tickerPrice.textContent.replace('$', ''));
        }
    }
    
    if (price && !isNaN(price)) {
        const stockPriceInput = document.getElementById('optStockPrice');
        if (stockPriceInput) {
            stockPriceInput.value = price.toFixed(2);
            // Update strike to nearest $5
            const strikeInput = document.getElementById('optStrikePrice');
            if (strikeInput) {
                strikeInput.value = Math.round(price / 5) * 5;
            }
            // Recalculate if the options calc tab is active
            const optionsTab = document.getElementById('options-calc');
            if (optionsTab && optionsTab.classList.contains('active')) {
                calculateOptionPrice();
            }
        }
    }
}

// Initialize options calculator on page load
document.addEventListener('DOMContentLoaded', function() {
    // Run initial calculation with default values after a short delay
    setTimeout(calculateOptionPrice, 500);

    // Update options calc price when Options Calc tab is clicked
    document.querySelector('[data-tab="options-calc"]')?.addEventListener('click', () => {
        setTimeout(updateOptionsCalcPrice, 100);
        setTimeout(initializeStrikeSlider, 200);
        setTimeout(calculateOptionPrice, 300);
    });

    // Add auto-recalculate on input change
    setTimeout(() => {
        const inputIds = ['optStockPrice', 'optStrikePrice', 'optDTE', 'optIV', 'optRate', 'optContracts'];
        inputIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', calculateOptionPrice);
                el.addEventListener('change', calculateOptionPrice);
            }
        });
        // Option type select
        const typeEl = document.getElementById('optType');
        if (typeEl) {
            typeEl.addEventListener('change', calculateOptionPrice);
        }
        console.log(' Options Calculator event listeners attached');
    }, 1000);
});

// ==========================================
// INTERACTIVE STRIKE SLIDER FUNCTIONS
// ==========================================

// Store current slider range for calculations
let sliderStrikeRange = { min: 0, max: 0, stockPrice: 0 };

function initializeStrikeSlider() {
    const stockPrice = parseFloat(document.getElementById('optStockPrice').value) || 600;
    const strike = parseFloat(document.getElementById('optStrikePrice').value) || 605;

    // Set slider range to +/- 30% of stock price
    sliderStrikeRange.min = Math.floor(stockPrice * 0.7);
    sliderStrikeRange.max = Math.ceil(stockPrice * 1.3);
    sliderStrikeRange.stockPrice = stockPrice;

    // Update labels
    const minLabel = document.getElementById('sliderMinLabel');
    const maxLabel = document.getElementById('sliderMaxLabel');
    const currentLabel = document.getElementById('currentPriceLabel');
    const strikeDisplay = document.getElementById('strikeDisplay');

    if (minLabel) minLabel.textContent = '$' + sliderStrikeRange.min;
    if (maxLabel) maxLabel.textContent = '$' + sliderStrikeRange.max;
    if (currentLabel) currentLabel.textContent = '$' + stockPrice.toFixed(2);
    if (strikeDisplay) strikeDisplay.textContent = '$' + strike.toFixed(0);

    // Set slider position based on current strike
    const slider = document.getElementById('strikeSlider');
    if (slider) {
        const range = sliderStrikeRange.max - sliderStrikeRange.min;
        const position = ((strike - sliderStrikeRange.min) / range) * 100;
        slider.value = Math.max(0, Math.min(100, position));
    }
}

function updateStrikeFromSlider(sliderValue) {
    const range = sliderStrikeRange.max - sliderStrikeRange.min;
    const strike = sliderStrikeRange.min + (range * sliderValue / 100);

    // Round to nearest dollar
    const roundedStrike = Math.round(strike);

    // Update input and display
    document.getElementById('optStrikePrice').value = roundedStrike;
    const strikeDisplay = document.getElementById('strikeDisplay');
    if (strikeDisplay) strikeDisplay.textContent = '$' + roundedStrike;

    // Recalculate options
    calculateOptionPrice();
}

function adjustStrike(delta) {
    const strikeInput = document.getElementById('optStrikePrice');
    let currentStrike = parseFloat(strikeInput.value) || 600;
    currentStrike += delta;

    // Clamp to slider range
    currentStrike = Math.max(sliderStrikeRange.min, Math.min(sliderStrikeRange.max, currentStrike));

    strikeInput.value = currentStrike;

    // Update slider position
    const slider = document.getElementById('strikeSlider');
    if (slider) {
        const range = sliderStrikeRange.max - sliderStrikeRange.min;
        const position = ((currentStrike - sliderStrikeRange.min) / range) * 100;
        slider.value = Math.max(0, Math.min(100, position));
    }

    // Update display
    const strikeDisplay = document.getElementById('strikeDisplay');
    if (strikeDisplay) strikeDisplay.textContent = '$' + currentStrike.toFixed(0);

    // Recalculate options
    calculateOptionPrice();
}

// Also update slider when stock price input changes
const optStockPriceInput = document.getElementById('optStockPrice');
if (optStockPriceInput) {
    optStockPriceInput.addEventListener('change', initializeStrikeSlider);
}

// Initialize slider shortly after page load
setTimeout(initializeStrikeSlider, 1000);


// ==========================================
// GANN ANALYSIS TAB FUNCTIONS (ENHANCED)
// ==========================================

// List of all ETFs to track
const GANN_ETF_LIST = ['SPY', 'QQQ', 'IWM', 'DIA', 'XLK', 'XLF', 'XLE', 'XLV', 'XLI', 'XLP', 'XLU', 'XLB', 'XLC', 'XLRE', 'XLY'];
const GANN_ETF_NAMES = {
    'SPY': 'S&P 500',
    'QQQ': 'Nasdaq Tech',
    'IWM': 'Small Caps',
    'DIA': 'Dow Jones',
    'XLK': 'Technology',
    'XLF': 'Financials',
    'XLE': 'Energy',
    'XLV': 'Healthcare',
    'XLI': 'Industrials',
    'XLP': 'Consumer Staples',
    'XLU': 'Utilities',
    'XLB': 'Materials',
    'XLC': 'Communication',
    'XLRE': 'Real Estate',
    'XLY': 'Consumer Disc'
};

// Calculate Square of 9 levels
function calculateSquareOf9Levels(price) {
    if (!price || price <= 0) return { s1: 0, s2: 0, r1: 0, r2: 0 };

    // Square of 9 calculation: sqrt(price) +/- degrees/180
    const sqrtPrice = Math.sqrt(price);

    // 45 degrees = 0.25 on the wheel, 90 degrees = 0.5
    const r1 = Math.pow(sqrtPrice + 0.25, 2);  // 45 degrees up
    const r2 = Math.pow(sqrtPrice + 0.5, 2);   // 90 degrees up
    const s1 = Math.pow(sqrtPrice - 0.25, 2);  // 45 degrees down
    const s2 = Math.pow(sqrtPrice - 0.5, 2);   // 90 degrees down

    return {
        r1: Math.round(r1 * 100) / 100,
        r2: Math.round(r2 * 100) / 100,
        s1: Math.round(s1 * 100) / 100,
        s2: Math.round(s2 * 100) / 100
    };
}

// Calculate time cycles
function calculateGannCycles() {
    const today = new Date();
    const startOfYear = new Date(today.getFullYear(), 0, 1);
    const dayOfYear = Math.floor((today - startOfYear) / (24 * 60 * 60 * 1000)) + 1;

    // 30-day cycle
    const cycle30Day = dayOfYear % 30;
    const daysTo30Turn = 30 - cycle30Day;
    let cycle30Phase = 'TRENDING';
    let cycle30Simple = 'Going sideways';
    if (cycle30Day >= 25 || cycle30Day <= 5) {
        cycle30Phase = 'BOTTOMING';
        cycle30Simple = 'NEAR BOTTOM';
    }
    else if (cycle30Day >= 12 && cycle30Day <= 18) {
        cycle30Phase = 'TOPPING';
        cycle30Simple = 'NEAR TOP';
    }

    // 90-day cycle
    const cycle90Day = dayOfYear % 90;
    const daysTo90Turn = 90 - cycle90Day;
    let cycle90Phase = 'TRENDING UP';
    let cycle90Simple = 'Going UP';
    if (cycle90Day >= 80 || cycle90Day <= 10) {
        cycle90Phase = 'BOTTOMING';
        cycle90Simple = 'Near bottom';
    }
    else if (cycle90Day >= 40 && cycle90Day <= 50) {
        cycle90Phase = 'TOPPING';
        cycle90Simple = 'Near top';
    }

    // Next turn date
    const nextTurnDate = new Date(today);
    nextTurnDate.setDate(nextTurnDate.getDate() + daysTo30Turn);

    // Seasonal bias
    const quarter = Math.floor(today.getMonth() / 3) + 1;
    const month = today.getMonth();
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    const seasonalBias = {
        1: 'January is usually BULLISH - "January Effect"!',
        2: 'February is usually NEUTRAL to BULLISH',
        3: 'March is usually BULLISH',
        4: 'April is usually BULLISH - "Best 6 months" continues',
        5: 'May is usually WEAK - "Sell in May" pattern',
        6: 'June is usually NEUTRAL',
        7: 'July is usually BULLISH',
        8: 'August is usually WEAK - Summer doldrums',
        9: 'September is usually BEARISH - Worst month historically',
        10: 'October is usually VOLATILE but often bottoms here',
        11: 'November is usually BULLISH - Best month historically',
        12: 'December is usually BULLISH - "Santa Rally" time!'
    };

    return {
        cycle30Day,
        cycle30Phase,
        cycle30Simple,
        daysTo30Turn,
        cycle90Day,
        cycle90Phase,
        cycle90Simple,
        daysTo90Turn,
        nextTurnDate,
        quarter,
        month: monthNames[month],
        seasonalBias: seasonalBias[month + 1]
    };
}

// ===============================================
// UNIFIED GANN SCORING SYSTEM
// One master function used across entire dashboard
// ===============================================

// Cache for scores to ensure consistency within same calculation cycle
let gannScoreCache = {};
let gannScoreCacheTime = 0;

// Master scoring function - use this EVERYWHERE
function calculateGannScore(symbol) {
    // Clear cache every 60 seconds to allow updates
    const now = Date.now();
    if (now - gannScoreCacheTime > 60000) {
        gannScoreCache = {};
        gannScoreCacheTime = now;
    }

    // Return cached score if available
    if (gannScoreCache[symbol]) {
        return gannScoreCache[symbol];
    }

    let score = 0;
    const details = {
        timing: 0,
        price: 0,
        trend: 0,
        agents: 0,
        confluence: 0
    };

    // Get cycles with safety check
    let cycles;
    try {
        cycles = calculateGannCycles();
    } catch (e) {
        console.warn('Error calculating Gann cycles:', e);
        cycles = {
            cycle30Phase: 'TRENDING',
            cycle30Day: 15,
            daysTo30Turn: 15,
            cycle90Phase: 'TRENDING',
            cycle90Simple: 'Neutral'
        };
    }

    // Get price data for this symbol
    let price = 0;
    let atr = 0;
    let bias = 'HOLD';
    let priceConfluence = 0;

    if (typeof allSymbolsData !== 'undefined' && allSymbolsData[symbol] && allSymbolsData[symbol].length > 0) {
        const latestBar = allSymbolsData[symbol][allSymbolsData[symbol].length - 1];
        price = parseFloat(latestBar.Close) || parseFloat(latestBar.close) || 0;
        atr = parseFloat(latestBar.ATR) || parseFloat(latestBar.atr) || 0;
        bias = (latestBar.Bias || latestBar.bias || 'HOLD').toUpperCase();
        priceConfluence = parseInt(latestBar.PriceConfluence) || parseInt(latestBar.priceConfluence) || 0;
    } else if (symbol === currentSymbol && currentData && currentData.length > 0) {
        const latestBar = currentData[currentData.length - 1];
        price = parseFloat(latestBar.Close) || parseFloat(latestBar.close) || 0;
        atr = parseFloat(latestBar.ATR) || parseFloat(latestBar.atr) || 0;
        bias = (latestBar.Bias || latestBar.bias || 'HOLD').toUpperCase();
        priceConfluence = parseInt(latestBar.PriceConfluence) || parseInt(latestBar.priceConfluence) || 0;
    }

    // Fallback price from DOM if no data
    if (price === 0) {
        price = parseFloat(document.getElementById('tickerPrice')?.textContent?.replace('$', '')) || 100;
    }

    // ========== 1. TIMING SCORE (0-30 points) ==========
    // Is it the right time based on Gann cycles?
    let timingScore = 0;

    // 30-day cycle phase (up to 20 points) - with safety checks
    const phase30 = cycles?.cycle30Phase || 'TRENDING';
    if (phase30 === 'BOTTOMING') timingScore += 20;
    else if (phase30 === 'TOPPING') timingScore += 15;
    else timingScore += 5; // TRENDING

    // Proximity to turn date (up to 10 points) - with safety checks
    const daysTo30 = cycles?.daysTo30Turn ?? 15;
    if (daysTo30 <= 2) timingScore += 10;
    else if (daysTo30 <= 5) timingScore += 7;
    else if (daysTo30 <= 10) timingScore += 4;
    else timingScore += 1;

    details.timing = Math.min(30, Math.max(0, timingScore || 0));
    score += details.timing;

    // ========== 2. PRICE LOCATION (0-25 points) ==========
    // Is price at a good Gann level?
    let priceScore = 5; // Base score

    if (price > 0) {
        const sq9 = calculateSquareOf9Levels(price);
        const distToS1 = Math.abs(price - sq9.s1);
        const distToR1 = Math.abs(price - sq9.r1);
        const distToS2 = Math.abs(price - sq9.s2);
        const distToR2 = Math.abs(price - sq9.r2);
        const nearestDist = Math.min(distToS1, distToR1, distToS2, distToR2);
        const pctFromLevel = (nearestDist / price) * 100;

        if (pctFromLevel <= 0.5) priceScore = 25;
        else if (pctFromLevel <= 1.0) priceScore = 20;
        else if (pctFromLevel <= 1.5) priceScore = 16;
        else if (pctFromLevel <= 2.0) priceScore = 12;
        else if (pctFromLevel <= 3.0) priceScore = 8;
        else priceScore = 5;
    }

    details.price = Math.max(0, priceScore || 0);
    score += details.price;

    // ========== 3. TREND ALIGNMENT (0-20 points) ==========
    // Are multiple timeframes pointing same direction?
    let trendScore = 10; // Base score

    // Check bias direction
    if (bias === 'CALL' || bias === 'PUT') {
        trendScore += 5; // Clear direction
    }

    // Check if 90-day cycle aligns with 30-day - with safety checks
    const phase90 = cycles?.cycle90Phase || 'TRENDING';
    const simple90 = cycles?.cycle90Simple || '';
    const cycle90Bullish = phase90 === 'BOTTOMING' || (typeof simple90 === 'string' && simple90.includes('UP'));
    const cycle30Bullish = phase30 === 'BOTTOMING';

    if ((cycle90Bullish && cycle30Bullish) || (!cycle90Bullish && !cycle30Bullish)) {
        trendScore += 5; // Cycles aligned
    }

    details.trend = Math.min(20, Math.max(0, trendScore || 0));
    score += details.trend;

    // ========== 4. AI AGENTS AGREEMENT (0-15 points) ==========
    // Do the AI agents agree on direction?
    let agentScore = 4; // Base score

    // Use priceConfluence from data (0-4 agents agreeing)
    if (priceConfluence >= 4) agentScore = 15;
    else if (priceConfluence >= 3) agentScore = 11;
    else if (priceConfluence >= 2) agentScore = 8;
    else agentScore = 4;

    details.agents = Math.max(0, agentScore || 0);
    score += details.agents;

    // ========== 5. MULTIPLE SIGNALS (0-10 points) ==========
    // Are there multiple confirming signals?
    let confluenceScore = 3; // Base score

    // Check for signal strength
    if (bias === 'CALL' || bias === 'PUT') {
        confluenceScore += 3; // Has clear bias
    }

    // Check if near key level AND in cycle turn
    if (details.timing >= 20 && details.price >= 15) {
        confluenceScore += 4; // Multiple factors aligned
    }

    details.confluence = Math.min(10, confluenceScore);
    score += details.confluence;

    // ========== FINAL SCORE ==========
    const finalScore = Math.min(100, Math.max(0, score));

    const result = {
        score: finalScore,
        details: details,
        symbol: symbol,
        price: price,
        bias: bias
    };

    // Cache the result
    gannScoreCache[symbol] = result;

    return result;
}

// Legacy wrapper for backward compatibility
function calculateTradeSetupScore() {
    const symbol = currentSymbol || 'SPY';
    return calculateGannScore(symbol);
}

// Generate trade recommendation for both directions
function generateDualTradeRecommendation() {
    const price = parseFloat(document.getElementById('tickerPrice')?.textContent?.replace('$', '')) || 600;
    const symbol = currentSymbol || 'SPY';
    const scoreData = calculateTradeSetupScore();
    const cycles = calculateGannCycles();
    const sq9 = calculateSquareOf9Levels(price);

    // Calculate strikes for both directions (nearest $5, then OTM)
    const rounded = Math.round(price / 5) * 5;
    const callStrike = rounded + 5;
    const putStrike = rounded - 5;

    // Calculate expiration (next cycle turn + 7 days, round to Friday)
    const expDate = new Date(cycles.nextTurnDate);
    expDate.setDate(expDate.getDate() + 7);
    // Round to next Friday
    const dayOfWeek = expDate.getDay();
    const daysToFriday = (5 - dayOfWeek + 7) % 7;
    expDate.setDate(expDate.getDate() + daysToFriday);

    const dte = Math.round((expDate - new Date()) / (24 * 60 * 60 * 1000));

    // Estimate option price (rough ATM estimate)
    const estimatedPrice = (price * 0.005 * Math.sqrt(dte / 365)).toFixed(2);
    const maxPrice = (parseFloat(estimatedPrice) * 1.1).toFixed(2);

    // Calculate stops and targets (same for both directions)
    const stopLoss = (parseFloat(estimatedPrice) * 0.5).toFixed(2);
    const target1 = (parseFloat(estimatedPrice) * 1.5).toFixed(2);
    const target2 = (parseFloat(estimatedPrice) * 2.0).toFixed(2);

    // Position sizing
    const positionPct = scoreData.score >= 70 ? 0.10 : scoreData.score >= 50 ? 0.07 : 0.05;
    const positionSize = 10000 * positionPct;
    const contracts = Math.max(1, Math.floor(positionSize / (parseFloat(estimatedPrice) * 100)));
    const totalCost = contracts * parseFloat(estimatedPrice) * 100;

    // Risk/reward amounts
    const riskAmount = (totalCost * 0.5).toFixed(0);
    const profitAmount = (totalCost * 0.5).toFixed(0);

    return {
        symbol,
        callStrike,
        putStrike,
        expDate,
        dte,
        estimatedPrice,
        maxPrice,
        stopLoss,
        target1,
        target2,
        contracts,
        totalCost,
        riskAmount,
        profitAmount,
        score: scoreData.score,
        // Stop loss levels based on price
        callStopLevel: sq9.s1.toFixed(2),
        putStopLevel: sq9.r1.toFixed(2)
    };
}

// Format date as "Mon DD, YYYY"
function formatGannDate(date) {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
}

// Format date as "Mon DD"
function formatGannDateShort(date) {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return `${months[date.getMonth()]} ${date.getDate()}`;
}

// Generate monthly calendar HTML
function generateGannCalendar(turnDate, today) {
    const year = today.getFullYear();
    const month = today.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay();

    // Entry window: 2 days before to 1 day after turn date
    const entryStart = new Date(turnDate);
    entryStart.setDate(entryStart.getDate() - 2);
    const entryEnd = new Date(turnDate);
    entryEnd.setDate(entryEnd.getDate() + 1);

    let html = '';

    // Empty cells before first day
    for (let i = 0; i < startDay; i++) {
        html += '<div style="padding: 8px; text-align: center;"></div>';
    }

    // Days of month
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const currentDate = new Date(year, month, day);
        const isToday = day === today.getDate();
        const isTurnDate = turnDate.getMonth() === month && turnDate.getDate() === day;
        const isEntryWindow = currentDate >= entryStart && currentDate <= entryEnd && turnDate.getMonth() === month;

        let bgColor = 'var(--bg)';
        let borderStyle = '';

        if (isTurnDate) {
            bgColor = 'var(--primary)';
            borderStyle = 'border: 2px solid var(--primary);';
        } else if (isEntryWindow) {
            bgColor = 'rgba(16,185,129,0.3)';
        }

        if (isToday) {
            borderStyle = 'border: 2px solid var(--warning);';
        }

        const textColor = isTurnDate ? 'white' : 'var(--text)';
        const fontWeight = isToday || isTurnDate ? '700' : '400';

        html += `<div style="padding: 8px; text-align: center; background: ${bgColor}; border-radius: 4px; ${borderStyle} color: ${textColor}; font-weight: ${fontWeight};">${day}</div>`;
    }

    return html;
}

// Calculate ETF rankings (simplified - actual implementation would fetch real data)
function calculateETFRankings() {
    // This would normally fetch real data - for now we use a scoring based on available info
    const rankings = [];
    const baseSymbol = currentSymbol || 'SPY';
    const basePrice = parseFloat(document.getElementById('tickerPrice')?.textContent?.replace('$', '')) || 600;

    // Create mock rankings based on available data
    GANN_ETF_LIST.forEach((symbol, index) => {
        const price = symbol === baseSymbol ? basePrice : (100 + Math.random() * 500).toFixed(2);
        const score = Math.round(85 - index * 3 + Math.random() * 10);
        const trend = score > 70 ? 'UP' : score > 55 ? 'FLAT' : 'DOWN';

        rankings.push({
            symbol,
            name: GANN_ETF_NAMES[symbol],
            price: parseFloat(price),
            score,
            trend
        });
    });

    // Sort by score descending
    rankings.sort((a, b) => b.score - a.score);

    return rankings;
}

// Main update function for Gann Analysis tab
function updateGannAnalysisTab() {
    console.log(' Updating Enhanced Gann Analysis Tab');

    const price = parseFloat(document.getElementById('tickerPrice')?.textContent?.replace('$', '')) || 0;
    if (price <= 0) {
        console.warn(' Gann Analysis: No price data available');
        return;
    }

    const symbol = currentSymbol || 'SPY';
    const today = new Date();
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    // Calculate all data using UNIFIED scoring
    const sq9 = calculateSquareOf9Levels(price);
    const cycles = calculateGannCycles();
    const scoreData = calculateGannScore(symbol); // Use unified scoring function
    const trade = generateDualTradeRecommendation();

    console.log(` Gann Score for ${symbol}: ${scoreData.score}/100`);

    // Entry window calculations
    const entryStart = new Date(cycles.nextTurnDate);
    entryStart.setDate(entryStart.getDate() - 2);
    const entryEnd = new Date(cycles.nextTurnDate);
    entryEnd.setDate(entryEnd.getDate() + 1);
    const daysToEntry = Math.max(0, Math.round((entryStart - today) / (24 * 60 * 60 * 1000)));
    const isInEntryWindow = today >= entryStart && today <= entryEnd;

    // ===== UPDATE HEADER =====
    const titleEl = document.getElementById('gannTradeTitle');
    if (titleEl) {
        titleEl.textContent = ` ${months[today.getMonth()].toUpperCase()} ${today.getFullYear()} TRADING PLAN`;
    }

    const statusEl = document.getElementById('gannTradeStatus');
    if (statusEl) {
        statusEl.textContent = 'Your monthly guide to when and what to trade';
    }

    // ===== UPDATE TRAFFIC LIGHT =====
    const trafficEl = document.getElementById('gannTrafficLight');
    if (trafficEl) {
        if (scoreData.score >= 70 && isInEntryWindow) {
            trafficEl.innerHTML = '<span style="font-size: 28px;"></span><div><div style="font-size: 16px; font-weight: 700; color: var(--success);">GO!</div><div style="font-size: 10px; color: var(--muted);">Trade now!</div></div>';
        } else if (scoreData.score >= 50 || daysToEntry <= 3) {
            trafficEl.innerHTML = '<span style="font-size: 28px;"></span><div><div style="font-size: 16px; font-weight: 700; color: var(--warning);">SOON</div><div style="font-size: 10px; color: var(--muted);">Almost time</div></div>';
        } else {
            trafficEl.innerHTML = '<span style="font-size: 28px;"></span><div><div style="font-size: 16px; font-weight: 700; color: var(--danger);">WAIT</div><div style="font-size: 10px; color: var(--muted);">Not time yet</div></div>';
        }
    }

    // ===== UPDATE TODAY'S ACTION =====
    const actionEl = document.getElementById('gannTodayAction');
    const reasonEl = document.getElementById('gannActionReason');
    if (actionEl && reasonEl) {
        if (scoreData.score >= 70 && isInEntryWindow) {
            actionEl.innerHTML = ' BUY TODAY!';
            actionEl.style.color = 'var(--success)';
            reasonEl.innerHTML = `<strong>Why?</strong> All conditions are met! The turn date is here and the setup looks good. Pick CALL or PUT based on price direction.`;
        } else if (daysToEntry <= 0 && !isInEntryWindow) {
            actionEl.innerHTML = ' WAIT - Entry window passed';
            actionEl.style.color = 'var(--muted)';
            reasonEl.innerHTML = `<strong>Why?</strong> The entry window for this cycle has passed. Wait for the next turn date.`;
        } else {
            actionEl.innerHTML = ' WAIT - Don\'t buy anything yet';
            actionEl.style.color = 'var(--warning)';
            reasonEl.innerHTML = `<strong>Why?</strong> The market usually changes direction around <span id="gannTurnDateSimple">${formatGannDateShort(cycles.nextTurnDate)}</span>. Wait until then to buy. You have <span style="font-weight: 700; color: var(--primary);">${cycles.daysTo30Turn} days</span> to wait.`;
        }
    }

    // ===== UPDATE DUAL TRADE OPTIONS (CALL and PUT) =====
    // CALL side
    const callSymbolEl = document.getElementById('gannCallSymbol');
    if (callSymbolEl) callSymbolEl.textContent = `${symbol} CALL`;
    const callStrikeEl = document.getElementById('gannCallStrike');
    if (callStrikeEl) callStrikeEl.textContent = `$${trade.callStrike}`;
    const callExpiryEl = document.getElementById('gannCallExpiry');
    if (callExpiryEl) callExpiryEl.textContent = formatGannDateShort(trade.expDate);
    const callMaxPayEl = document.getElementById('gannCallMaxPay');
    if (callMaxPayEl) callMaxPayEl.textContent = `$${trade.maxPrice}`;
    const callStopEl = document.getElementById('gannCallStop');
    if (callStopEl) callStopEl.textContent = `Sell at $${trade.stopLoss}`;
    const callTargetEl = document.getElementById('gannCallTarget');
    if (callTargetEl) callTargetEl.textContent = `Sell at $${trade.target1}`;
    const callProfitEl = document.getElementById('gannCallProfit');
    if (callProfitEl) callProfitEl.textContent = `+$${trade.profitAmount} (50%)`;
    const callLossEl = document.getElementById('gannCallLoss');
    if (callLossEl) callLossEl.textContent = `-$${trade.riskAmount} (50%)`;

    // PUT side
    const putSymbolEl = document.getElementById('gannPutSymbol');
    if (putSymbolEl) putSymbolEl.textContent = `${symbol} PUT`;
    const putStrikeEl = document.getElementById('gannPutStrike');
    if (putStrikeEl) putStrikeEl.textContent = `$${trade.putStrike}`;
    const putExpiryEl = document.getElementById('gannPutExpiry');
    if (putExpiryEl) putExpiryEl.textContent = formatGannDateShort(trade.expDate);
    const putMaxPayEl = document.getElementById('gannPutMaxPay');
    if (putMaxPayEl) putMaxPayEl.textContent = `$${trade.maxPrice}`;
    const putStopEl = document.getElementById('gannPutStop');
    if (putStopEl) putStopEl.textContent = `Sell at $${trade.stopLoss}`;
    const putTargetEl = document.getElementById('gannPutTarget');
    if (putTargetEl) putTargetEl.textContent = `Sell at $${trade.target1}`;
    const putProfitEl = document.getElementById('gannPutProfit');
    if (putProfitEl) putProfitEl.textContent = `+$${trade.profitAmount} (50%)`;
    const putLossEl = document.getElementById('gannPutLoss');
    if (putLossEl) putLossEl.textContent = `-$${trade.riskAmount} (50%)`;

    // ===== UPDATE TURN DIRECTION =====
    const cycle30El = document.getElementById('gann30DayCycle');
    if (cycle30El) cycle30El.textContent = cycles.cycle30Simple;
    const cycle30PhaseEl = document.getElementById('gann30DayPhase');
    if (cycle30PhaseEl) cycle30PhaseEl.textContent = `Day ${cycles.cycle30Day} of 30`;

    const nextTurnEl = document.getElementById('gannNextTurnDate');
    if (nextTurnEl) nextTurnEl.textContent = formatGannDateShort(cycles.nextTurnDate);
    const daysToTurnTextEl = document.getElementById('gannDaysToTurnText');
    if (daysToTurnTextEl) daysToTurnTextEl.textContent = `in ${cycles.daysTo30Turn} days`;

    const turnExplainEl = document.getElementById('gannTurnExplain');
    if (turnExplainEl) {
        if (cycles.cycle30Phase === 'BOTTOMING') {
            turnExplainEl.innerHTML = ' <strong>NEAR BOTTOM</strong> = Price is low and about to go UP<br> Best time to buy CALLs (bet on price going up)';
        } else if (cycles.cycle30Phase === 'TOPPING') {
            turnExplainEl.innerHTML = ' <strong>NEAR TOP</strong> = Price is high and about to go DOWN<br> Best time to buy PUTs (bet on price going down)';
        } else {
            turnExplainEl.innerHTML = ' <strong>MIDDLE OF CYCLE</strong> = Price is moving, wait for clearer signal<br> Best to wait for the next turn date';
        }
    }

    const cycle90El = document.getElementById('gann90DayCycle');
    if (cycle90El) cycle90El.textContent = cycles.cycle90Simple;
    const cycle90PhaseEl = document.getElementById('gann90DayPhase');
    if (cycle90PhaseEl) cycle90PhaseEl.textContent = `Day ${cycles.cycle90Day} of 90`;

    // ===== UPDATE ETF RANKINGS =====
    const rankings = calculateETFRankings();
    const rankingsBody = document.getElementById('gannETFRankingsBody');
    if (rankingsBody) {
        let html = '';
        rankings.slice(0, 10).forEach((etf, idx) => {
            const trendIcon = etf.trend === 'UP' ? '' : etf.trend === 'DOWN' ? '' : '';
            const trendColor = etf.trend === 'UP' ? 'var(--success)' : etf.trend === 'DOWN' ? 'var(--danger)' : 'var(--muted)';
            const scoreColor = etf.score >= 75 ? 'var(--success)' : etf.score >= 60 ? 'var(--warning)' : 'var(--danger)';
            const rec = idx === 0 ? 'BEST PICK' : idx < 3 ? 'Good' : 'OK';
            const recColor = idx === 0 ? 'var(--success)' : idx < 3 ? 'var(--text)' : 'var(--muted)';

            html += `<tr>
                <td>${idx + 1}</td>
                <td style="cursor:pointer; color: var(--primary); font-weight: 600;" onclick="selectETFAndShowScore('${etf.symbol}')">${etf.symbol}</td>
                <td>${etf.name}</td>
                <td>$${etf.price.toFixed(2)}</td>
                <td style="color: ${trendColor};">${trendIcon} ${etf.trend}</td>
                <td style="color: ${scoreColor}; font-weight: 600;">${etf.score}</td>
                <td style="color: ${recColor};">${rec}</td>
            </tr>`;
        });
        rankingsBody.innerHTML = html;
    }

    // ===== UPDATE STOP LOSS COMPARISON =====
    const stopPaidEl = document.getElementById('gannStopPaid');
    if (stopPaidEl) stopPaidEl.textContent = `$${trade.maxPrice}`;
    const stop50PctEl = document.getElementById('gannStop50Pct');
    if (stop50PctEl) stop50PctEl.textContent = `$${trade.stopLoss}`;
    const stopCallLevelEl = document.getElementById('gannStopCallLevel');
    if (stopCallLevelEl) stopCallLevelEl.textContent = `$${trade.callStopLevel}`;
    const stopPutLevelEl = document.getElementById('gannStopPutLevel');
    if (stopPutLevelEl) stopPutLevelEl.textContent = `$${trade.putStopLevel}`;

    // ===== UPDATE CALENDAR =====
    const calendarDaysEl = document.getElementById('gannCalendarDays');
    if (calendarDaysEl) {
        calendarDaysEl.innerHTML = generateGannCalendar(cycles.nextTurnDate, today);
    }

    // ===== UPDATE TRADE TRACKER =====
    const pendingDateEl = document.getElementById('gannPendingDate');
    if (pendingDateEl) pendingDateEl.textContent = formatGannDateShort(cycles.nextTurnDate);
    const pendingSymbolEl = document.getElementById('gannPendingSymbol');
    if (pendingSymbolEl) pendingSymbolEl.textContent = symbol;

    // ===== UPDATE PRICE LEVELS =====
    const currentPriceEl = document.getElementById('gannCurrentPrice');
    if (currentPriceEl) currentPriceEl.textContent = `$${price.toFixed(2)}`;
    const currentPrice2El = document.getElementById('gannCurrentPrice2');
    if (currentPrice2El) currentPrice2El.textContent = `$${price.toFixed(2)}`;

    const r1El = document.getElementById('gannR1');
    if (r1El) r1El.textContent = `$${sq9.r1.toFixed(2)}`;
    const r2El = document.getElementById('gannR2');
    if (r2El) r2El.textContent = `$${sq9.r2.toFixed(2)}`;
    const s1El = document.getElementById('gannS1');
    if (s1El) s1El.textContent = `$${sq9.s1.toFixed(2)}`;
    const s2El = document.getElementById('gannS2');
    if (s2El) s2El.textContent = `$${sq9.s2.toFixed(2)}`;

    // Nearest level
    const distToS1 = Math.abs(price - sq9.s1);
    const distToR1 = Math.abs(price - sq9.r1);
    const nearestEl = document.getElementById('gannNearestLevel');
    const distEl = document.getElementById('gannDistanceToLevel');
    if (nearestEl && distEl) {
        if (distToS1 < distToR1) {
            nearestEl.textContent = `Floor 1 @ $${sq9.s1.toFixed(2)}`;
            distEl.textContent = `$${distToS1.toFixed(2)} away`;
        } else {
            nearestEl.textContent = `Ceiling 1 @ $${sq9.r1.toFixed(2)}`;
            distEl.textContent = `$${distToR1.toFixed(2)} away`;
        }
    }

    // ===== UPDATE SCORE CARD =====
    const overallScoreEl = document.getElementById('gannOverallScore');
    if (overallScoreEl) {
        // Use unified score from calculateGannScore
        const symbol = currentSymbol || 'SPY';
        const unifiedScore = calculateGannScore(symbol);
        overallScoreEl.textContent = unifiedScore.score;
        overallScoreEl.style.color = unifiedScore.score >= 70 ? 'var(--success)' : unifiedScore.score >= 50 ? 'var(--warning)' : 'var(--danger)';

        // Also update the score breakdown
        const scoreCycleEl = document.getElementById('gannScoreCycle');
        const scorePriceEl = document.getElementById('gannScorePrice');
        const scoreMTFEl = document.getElementById('gannScoreMTF');
        const scoreAgentsEl = document.getElementById('gannScoreAgents');
        const scoreConfluenceEl = document.getElementById('gannScoreConfluence');

        if (scoreCycleEl) scoreCycleEl.textContent = `${unifiedScore.details.timing || 0}/30`;
        if (scorePriceEl) scorePriceEl.textContent = `${unifiedScore.details.price || 0}/25`;
        if (scoreMTFEl) scoreMTFEl.textContent = `${unifiedScore.details.trend || 0}/20`;
        if (scoreAgentsEl) scoreAgentsEl.textContent = `${unifiedScore.details.agents || 0}/15`;
        if (scoreConfluenceEl) scoreConfluenceEl.textContent = `${unifiedScore.details.confluence || 0}/10`;

        // Debug logging for score breakdown
        console.log('Gann Score Breakdown:', {
            symbol: symbol,
            timing: unifiedScore.details.timing,
            price: unifiedScore.details.price,
            trend: unifiedScore.details.trend,
            agents: unifiedScore.details.agents,
            confluence: unifiedScore.details.confluence,
            total: unifiedScore.score
        });
    }

    // Go/No-Go indicator
    const goNoGoEl = document.getElementById('gannGoNoGo');
    if (goNoGoEl) {
        if (scoreData.score >= 70) {
            goNoGoEl.innerHTML = '<div style="font-size: 20px; font-weight: 700; color: var(--success);"> GOOD SETUP</div><div style="font-size: 11px; color: var(--muted);">Trade when entry window opens</div>';
            goNoGoEl.style.background = 'rgba(16,185,129,0.15)';
            goNoGoEl.style.borderColor = 'var(--success)';
        } else if (scoreData.score >= 50) {
            goNoGoEl.innerHTML = '<div style="font-size: 20px; font-weight: 700; color: var(--warning);"> OK SETUP</div><div style="font-size: 11px; color: var(--muted);">Consider smaller position</div>';
            goNoGoEl.style.background = 'rgba(245,158,11,0.15)';
            goNoGoEl.style.borderColor = 'var(--warning)';
        } else {
            goNoGoEl.innerHTML = '<div style="font-size: 20px; font-weight: 700; color: var(--danger);"> WEAK SETUP</div><div style="font-size: 11px; color: var(--muted);">Better to skip this month</div>';
            goNoGoEl.style.background = 'rgba(239,68,68,0.15)';
            goNoGoEl.style.borderColor = 'var(--danger)';
        }
    }

    // ===== UPDATE CHECKLIST =====
    const mtfBullish = Math.round(scoreData.details.trend / 4);
    const agentBullish = Math.round(scoreData.details.agents / 4);

    const checks = [
        { id: 'gannCheck1', condition: cycles.cycle30Phase === 'BOTTOMING' || cycles.cycle30Phase === 'TOPPING', text: 'Near a turn date (time is right)' },
        { id: 'gannCheck2', condition: scoreData.details.price >= 20, text: 'Price at support or resistance' },
        { id: 'gannCheck3', condition: scoreData.details.trend >= 12, text: 'Most timeframes agree on direction' },
        { id: 'gannCheck4', condition: scoreData.details.agents >= 11, text: 'AI agents mostly agree' },
        { id: 'gannCheck5', condition: scoreData.score >= 70, text: 'Score is 70 or higher' },
        { id: 'gannCheck6', condition: isInEntryWindow, text: 'Entry window is open' }
    ];

    let checksPass = 0;
    checks.forEach(check => {
        const el = document.getElementById(check.id);
        if (el) {
            const span = el.querySelector('span:last-child');
            if (span) span.textContent = check.text;
            const icon = el.querySelector('span:first-child');
            if (check.condition) {
                checksPass++;
                el.style.background = 'rgba(16,185,129,0.1)';
                if (icon) icon.textContent = '';
            } else {
                el.style.background = 'rgba(245,158,11,0.1)';
                if (icon) icon.textContent = '';
            }
        }
    });

    const summaryEl = document.getElementById('gannChecklistSummary');
    if (summaryEl) {
        if (checksPass === 6) {
            summaryEl.innerHTML = `${checksPass} of 6 checks passed - <span style="color: var(--success);">ALL CLEAR - TRADE!</span>`;
        } else if (checksPass >= 4) {
            summaryEl.innerHTML = `${checksPass} of 6 checks passed - <span style="color: var(--warning);">ALMOST READY</span>`;
        } else {
            summaryEl.innerHTML = `${checksPass} of 6 checks passed - <span style="color: var(--danger);">NOT READY</span>`;
        }
    }

    // ===== UPDATE SEASONAL INFO =====
    const seasonalEl = document.getElementById('gannSeasonalBias');
    if (seasonalEl) {
        seasonalEl.textContent = ` ${cycles.seasonalBias}`;
    }

    console.log(' Enhanced Gann Analysis Tab updated successfully');
}

// Initialize Gann Analysis tab when clicked
document.querySelector('[data-tab="gann-analysis"]')?.addEventListener('click', () => {
    setTimeout(updateGannAnalysisTab, 200);
});

// Also update when symbol changes
const originalLoadSymbol = typeof loadSymbolData === 'function' ? loadSymbolData : null;
if (originalLoadSymbol) {
    const wrappedLoadSymbol = loadSymbolData;
    loadSymbolData = function(symbol) {
        wrappedLoadSymbol(symbol);
        setTimeout(() => {
            if (document.getElementById('gann-analysis')?.classList.contains('active')) {
                updateGannAnalysisTab();
            }
        }, 1000);
    };
}


// ==========================================
// EXIT ALERT SYSTEM
// ==========================================

// Store for open positions (persisted to localStorage)
let openPositions = [];
let exitPerformanceLog = [];
let pendingExitPosition = null;

// Load positions from localStorage
function loadOpenPositions() {
    try {
        const saved = localStorage.getItem('gann_open_positions');
        if (saved) {
            openPositions = JSON.parse(saved);
        }
        const perfLog = localStorage.getItem('gann_exit_performance');
        if (perfLog) {
            exitPerformanceLog = JSON.parse(perfLog);
        }
    } catch (e) {
        console.warn('Could not load positions:', e);
        openPositions = [];
    }
}

// Save positions to localStorage
function saveOpenPositions() {
    try {
        localStorage.setItem('gann_open_positions', JSON.stringify(openPositions));
        localStorage.setItem('gann_exit_performance', JSON.stringify(exitPerformanceLog));
    } catch (e) {
        console.warn('Could not save positions:', e);
    }
}

// Add a new position
function addOpenPosition(position) {
    const newPos = {
        id: Date.now(),
        symbol: position.symbol || currentSymbol || 'SPY',
        type: position.type || 'CALL',
        strike: position.strike || 600,
        expiry: position.expiry || new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(),
        entryDate: position.entryDate || new Date().toISOString(),
        entryPrice: position.entryPrice || 3.50,
        currentPrice: position.currentPrice || position.entryPrice || 3.50,
        contracts: position.contracts || 1,
        stopLoss: position.stopLoss || (position.entryPrice || 3.50) * 0.5,
        target1: position.target1 || (position.entryPrice || 3.50) * 1.5,
        target2: position.target2 || (position.entryPrice || 3.50) * 2.0,
        stopPriceLevel: position.stopPriceLevel || 590,
        status: 'open',
        alerts: [],
        halfSold: false
    };
    openPositions.push(newPos);
    saveOpenPositions();
    updateExitAlertSystem();
    return newPos;
}

// Update position current price (would normally come from market data)
function updatePositionPrice(positionId, newPrice) {
    const pos = openPositions.find(p => p.id === positionId);
    if (pos) {
        pos.currentPrice = newPrice;
        saveOpenPositions();
        checkExitConditions(pos);
    }
}

// Calculate days until expiration
function getDaysToExpiry(expiryDate) {
    const expiry = new Date(expiryDate);
    const today = new Date();
    return Math.ceil((expiry - today) / (24 * 60 * 60 * 1000));
}

// Calculate P&L
function calculatePnL(position) {
    const pnlPercent = ((position.currentPrice - position.entryPrice) / position.entryPrice) * 100;
    const pnlDollar = (position.currentPrice - position.entryPrice) * position.contracts * 100;
    return { percent: pnlPercent, dollar: pnlDollar };
}

// Check all exit conditions for a position
function checkExitConditions(position) {
    const alerts = [];
    const daysToExpiry = getDaysToExpiry(position.expiry);
    const pnl = calculatePnL(position);
    const cycles = calculateGannCycles();
    const scoreData = calculateTradeSetupScore();
    const price = parseFloat(document.getElementById('tickerPrice')?.textContent?.replace('$', '')) || 600;
    const sq9 = calculateSquareOf9Levels(price);

    // ===== TIME-BASED EXITS =====
    if (daysToExpiry <= 1) {
        alerts.push({
            type: 'TIME_EXIT',
            icon: '',
            reason: '1 day until expiration - Close immediately!',
            urgency: 'CRITICAL',
            urgencyColor: 'var(--danger)',
            action: 'CLOSE NOW'
        });
    } else if (daysToExpiry <= 2) {
        alerts.push({
            type: 'TIME_EXIT',
            icon: '',
            reason: `${daysToExpiry} days until expiration`,
            urgency: 'URGENT',
            urgencyColor: 'var(--danger)',
            action: 'CLOSE NOW'
        });
    } else if (daysToExpiry <= 3) {
        alerts.push({
            type: 'TIME_WARNING',
            icon: '',
            reason: `${daysToExpiry} days until expiration`,
            urgency: 'WARNING',
            urgencyColor: 'var(--warning)',
            action: 'CONSIDER CLOSING'
        });
    }

    // Check if cycle turn + 5 days passed
    const daysSinceTurn = 30 - cycles.daysTo30Turn;
    if (daysSinceTurn >= 5 && daysSinceTurn <= 10) {
        alerts.push({
            type: 'CYCLE_COMPLETE',
            icon: '',
            reason: 'Expected move may be complete (5+ days since turn)',
            urgency: 'INFO',
            urgencyColor: 'var(--primary)',
            action: 'TAKE PROFITS'
        });
    }

    // ===== PROFIT TARGET EXITS =====
    if (pnl.percent >= 100 && !position.halfSold) {
        alerts.push({
            type: 'TARGET_HIT',
            icon: '',
            reason: `Reached Target 2 (${pnl.percent.toFixed(0)}% profit!)`,
            urgency: 'TAKE PROFIT',
            urgencyColor: 'var(--success)',
            action: 'SELL ALL'
        });
    } else if (pnl.percent >= 50 && !position.halfSold) {
        alerts.push({
            type: 'TARGET_HIT',
            icon: '',
            reason: `Reached Target 1 (${pnl.percent.toFixed(0)}% profit)`,
            urgency: 'TAKE PROFIT',
            urgencyColor: 'var(--success)',
            action: 'SELL HALF'
        });
    } else if (pnl.percent >= 30 && daysToExpiry <= 5) {
        alerts.push({
            type: 'EARLY_PROFIT',
            icon: '',
            reason: `Up ${pnl.percent.toFixed(0)}% with only ${daysToExpiry} days left`,
            urgency: 'CONSIDER',
            urgencyColor: 'var(--success)',
            action: 'TAKE EARLY PROFITS'
        });
    }

    // ===== STOP LOSS EXITS =====
    if (position.currentPrice <= position.stopLoss) {
        alerts.push({
            type: 'STOP_LOSS',
            icon: '',
            reason: `Stop loss hit ($${position.stopLoss.toFixed(2)})`,
            urgency: 'URGENT',
            urgencyColor: 'var(--danger)',
            action: 'CLOSE NOW'
        });
    } else if (pnl.percent <= -40) {
        alerts.push({
            type: 'STOP_WARNING',
            icon: '',
            reason: `Down ${Math.abs(pnl.percent).toFixed(0)}% - approaching stop`,
            urgency: 'WARNING',
            urgencyColor: 'var(--warning)',
            action: 'WATCH CLOSELY'
        });
    }

    // Check price level stops
    if (position.type === 'CALL' && price <= sq9.s2) {
        alerts.push({
            type: 'LEVEL_BROKEN',
            icon: '',
            reason: `Support level S2 ($${sq9.s2.toFixed(2)}) broken`,
            urgency: 'URGENT',
            urgencyColor: 'var(--danger)',
            action: 'CLOSE NOW'
        });
    } else if (position.type === 'PUT' && price >= sq9.r2) {
        alerts.push({
            type: 'LEVEL_BROKEN',
            icon: '',
            reason: `Resistance level R2 ($${sq9.r2.toFixed(2)}) broken`,
            urgency: 'URGENT',
            urgencyColor: 'var(--danger)',
            action: 'CLOSE NOW'
        });
    }

    // ===== TREND CHANGE EXITS =====
    const mtfScore = scoreData.details.trend;
    const agentScore = scoreData.details.agents;
    const confluenceScore = scoreData.details.confluence;

    if (mtfScore <= 4) { // 1/5 or less bullish
        alerts.push({
            type: 'TREND_REVERSED',
            icon: '',
            reason: 'Trend fully reversed - MTF now bearish',
            urgency: 'URGENT',
            urgencyColor: 'var(--danger)',
            action: 'CLOSE POSITION'
        });
    } else if (mtfScore <= 8) { // 2/5 bullish
        alerts.push({
            type: 'TREND_WEAKENING',
            icon: '',
            reason: 'Trend weakening - only 2/5 timeframes bullish',
            urgency: 'CAUTION',
            urgencyColor: 'var(--warning)',
            action: 'TIGHTEN STOP'
        });
    }

    if (agentScore <= 4) {
        alerts.push({
            type: 'AGENTS_FLIPPED',
            icon: '',
            reason: 'AI agents changed opinion (now bearish)',
            urgency: 'CAUTION',
            urgencyColor: 'var(--warning)',
            action: 'REVIEW'
        });
    }

    if (confluenceScore <= 3) {
        alerts.push({
            type: 'CONFLUENCE_DROP',
            icon: '',
            reason: 'Conviction dropped - signals weakening',
            urgency: 'INFO',
            urgencyColor: 'var(--warning)',
            action: 'WATCH'
        });
    }

    position.alerts = alerts;
    return alerts;
}

// Generate position health check data
function updatePositionHealth(position) {
    const daysToExpiry = getDaysToExpiry(position.expiry);
    const pnl = calculatePnL(position);
    const cycles = calculateGannCycles();
    const scoreData = calculateTradeSetupScore();
    const price = parseFloat(document.getElementById('tickerPrice')?.textContent?.replace('$', '')) || 600;

    const health = {
        daysRemaining: {
            value: daysToExpiry,
            status: daysToExpiry > 7 ? 'good' : daysToExpiry > 3 ? 'warning' : 'danger',
            text: daysToExpiry > 7 ? 'Plenty of time' : daysToExpiry > 3 ? 'Getting short' : 'Very little time!'
        },
        stopLoss: {
            value: position.currentPrice > position.stopLoss,
            distance: ((position.currentPrice - position.stopLoss) / position.stopLoss * 100).toFixed(0),
            status: position.currentPrice > position.stopLoss * 1.2 ? 'good' : position.currentPrice > position.stopLoss ? 'warning' : 'danger',
            text: position.currentPrice <= position.stopLoss ? 'STOP HIT!' : `${((position.currentPrice - position.stopLoss) / position.stopLoss * 100).toFixed(0)}% above stop`
        },
        target1: {
            hit: position.currentPrice >= position.target1,
            distance: ((position.target1 - position.currentPrice) / position.currentPrice * 100).toFixed(0),
            status: position.currentPrice >= position.target1 ? 'good' : 'pending',
            text: position.currentPrice >= position.target1 ? 'TARGET HIT!' : `${((position.target1 - position.currentPrice) / position.currentPrice * 100).toFixed(0)}% away`
        },
        target2: {
            hit: position.currentPrice >= position.target2,
            distance: ((position.target2 - position.currentPrice) / position.currentPrice * 100).toFixed(0),
            status: position.currentPrice >= position.target2 ? 'good' : 'pending',
            text: position.currentPrice >= position.target2 ? 'TARGET HIT!' : `${((position.target2 - position.currentPrice) / position.currentPrice * 100).toFixed(0)}% away`
        },
        mtfAlignment: {
            value: Math.round(scoreData.details.trend / 4),
            status: scoreData.details.trend >= 12 ? 'good' : scoreData.details.trend >= 8 ? 'warning' : 'danger',
            text: scoreData.details.trend >= 12 ? 'Trend intact' : scoreData.details.trend >= 8 ? 'Trend weakening' : 'TREND REVERSED'
        },
        agentConsensus: {
            value: Math.round(scoreData.details.agents / 4),
            status: scoreData.details.agents >= 11 ? 'good' : scoreData.details.agents >= 8 ? 'warning' : 'danger',
            text: scoreData.details.agents >= 11 ? 'Agents agree' : scoreData.details.agents >= 8 ? 'Agents split' : 'Agents bearish'
        },
        gannCycle: {
            phase: cycles.cycle30Phase,
            day: cycles.cycle30Day,
            status: cycles.daysTo30Turn > 20 ? 'good' : cycles.daysTo30Turn > 10 ? 'warning' : 'info',
            text: cycles.daysTo30Turn > 20 ? 'Move in progress' : `Day ${cycles.cycle30Day} of cycle`
        },
        confluenceScore: {
            value: scoreData.details.confluence,
            status: scoreData.details.confluence >= 7 ? 'good' : scoreData.details.confluence >= 5 ? 'warning' : 'danger',
            text: scoreData.details.confluence >= 7 ? 'Strong conviction' : scoreData.details.confluence >= 5 ? 'Moderate' : 'Weak conviction'
        },
        pnl: pnl,
        overallStatus: 'HOLD'
    };

    // Determine overall status
    const dangerCount = Object.values(health).filter(h => h.status === 'danger').length;
    const warningCount = Object.values(health).filter(h => h.status === 'warning').length;

    if (dangerCount >= 2 || health.stopLoss.status === 'danger') {
        health.overallStatus = 'CLOSE';
        health.overallColor = 'var(--danger)';
        health.overallIcon = '';
        health.nextAction = 'Close position to limit losses';
    } else if (health.target1.hit || health.target2.hit) {
        health.overallStatus = 'TAKE PROFIT';
        health.overallColor = 'var(--success)';
        health.overallIcon = '';
        health.nextAction = health.target2.hit ? 'Sell all - Target 2 reached!' : 'Sell half - Target 1 reached';
    } else if (warningCount >= 3 || dangerCount >= 1) {
        health.overallStatus = 'CAUTION';
        health.overallColor = 'var(--warning)';
        health.overallIcon = '';
        health.nextAction = 'Tighten stop loss and watch closely';
    } else {
        health.overallStatus = 'HOLD';
        health.overallColor = 'var(--success)';
        health.overallIcon = '';
        health.nextAction = 'Continue holding, no action needed';
    }

    return health;
}

// Generate exit alert HTML for a position
function generateExitAlertRow(position, alert) {
    const pnl = calculatePnL(position);
    const pnlColor = pnl.percent >= 0 ? 'var(--success)' : 'var(--danger)';

    return `
        <tr>
            <td style="font-weight: 600;">${position.symbol} ${position.type} $${position.strike}</td>
            <td>${alert.icon} ${alert.type.replace(/_/g, ' ')}</td>
            <td style="font-size: 11px;">${alert.reason}</td>
            <td style="color: ${alert.urgencyColor}; font-weight: 600;">${alert.urgency}</td>
            <td>
                <button onclick="handleExitAction('${position.id}', '${alert.action}')"
                    style="padding: 6px 12px; background: ${alert.urgencyColor}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">
                    ${alert.action}
                </button>
            </td>
        </tr>
    `;
}

// Generate position card HTML
function generatePositionCard(position) {
    const health = updatePositionHealth(position);
    const pnl = health.pnl;
    const pnlColor = pnl.percent >= 0 ? 'var(--success)' : 'var(--danger)';
    const pnlSign = pnl.percent >= 0 ? '+' : '';
    const expiryDate = new Date(position.expiry);
    const entryDate = new Date(position.entryDate);

    const statusIcon = (status) => {
        if (status === 'good') return '';
        if (status === 'warning') return '';
        if (status === 'danger') return '';
        return '';
    };

    return `
        <div style="background: var(--bg); border: 2px solid ${health.overallColor}; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                <div>
                    <div style="font-size: 16px; font-weight: 700;">${position.symbol} ${position.type} $${position.strike}</div>
                    <div style="font-size: 11px; color: var(--muted);">Expires: ${formatGannDate(expiryDate)}</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 14px; color: ${pnlColor}; font-weight: 700;">${pnlSign}$${pnl.dollar.toFixed(0)} (${pnlSign}${pnl.percent.toFixed(0)}%)</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; font-size: 11px;">
                <div><span style="color: var(--muted);">Entry:</span> ${formatGannDateShort(entryDate)} @ $${position.entryPrice.toFixed(2)}</div>
                <div><span style="color: var(--muted);">Current:</span> $${position.currentPrice.toFixed(2)}</div>
                <div><span style="color: var(--muted);">Contracts:</span> ${position.contracts}</div>
            </div>

            <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px;"> HEALTH CHECK:</div>
            <div style="display: grid; gap: 4px; font-size: 11px;">
                <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: var(--card); border-radius: 4px;">
                    <span>Days Remaining:</span>
                    <span>${statusIcon(health.daysRemaining.status)} ${health.daysRemaining.value} days - ${health.daysRemaining.text}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: var(--card); border-radius: 4px;">
                    <span>Stop Loss ($${position.stopLoss.toFixed(2)}):</span>
                    <span>${statusIcon(health.stopLoss.status)} ${health.stopLoss.text}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: var(--card); border-radius: 4px;">
                    <span>Target 1 ($${position.target1.toFixed(2)}):</span>
                    <span>${statusIcon(health.target1.status)} ${health.target1.text}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: var(--card); border-radius: 4px;">
                    <span>Target 2 ($${position.target2.toFixed(2)}):</span>
                    <span>${statusIcon(health.target2.status)} ${health.target2.text}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: var(--card); border-radius: 4px;">
                    <span>MTF Alignment:</span>
                    <span>${statusIcon(health.mtfAlignment.status)} ${health.mtfAlignment.value}/5 - ${health.mtfAlignment.text}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: var(--card); border-radius: 4px;">
                    <span>Agent Consensus:</span>
                    <span>${statusIcon(health.agentConsensus.status)} ${health.agentConsensus.value}/4 - ${health.agentConsensus.text}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: var(--card); border-radius: 4px;">
                    <span>Gann Cycle:</span>
                    <span>${statusIcon(health.gannCycle.status)} ${health.gannCycle.text}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: var(--card); border-radius: 4px;">
                    <span>Confluence Score:</span>
                    <span>${statusIcon(health.confluenceScore.status)} ${health.confluenceScore.value}/10 - ${health.confluenceScore.text}</span>
                </div>
            </div>

            <div style="margin-top: 12px; padding: 12px; background: ${health.overallColor}20; border: 1px solid ${health.overallColor}; border-radius: 8px;">
                <div style="font-size: 14px; font-weight: 700; color: ${health.overallColor};">
                    ${health.overallIcon} OVERALL STATUS: ${health.overallStatus}
                </div>
                <div style="font-size: 12px; color: var(--text); margin-top: 4px;">
                    <strong>Next Action:</strong> ${health.nextAction}
                </div>
            </div>

            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="showPositionAlert(${position.id})" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;"> Details</button>
                <button onclick="openExitModal(${position.id}, 'manual')" style="padding: 8px 16px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;"> Close Position</button>
                ${health.target1.hit && !position.halfSold ? `<button onclick="sellHalf(${position.id})" style="padding: 8px 16px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;"> Sell Half</button>` : ''}
            </div>
        </div>
    `;
}

// Show detailed alert message
function showPositionAlert(positionId) {
    const position = openPositions.find(p => p.id === positionId);
    if (!position) return;

    const health = updatePositionHealth(position);
    const pnl = health.pnl;
    const alerts = position.alerts || [];

    const modal = document.getElementById('alertMessageModal');
    const header = document.getElementById('alertMessageHeader');
    const content = document.getElementById('alertMessageContent');
    const actions = document.getElementById('alertMessageActions');

    const pnlColor = pnl.percent >= 0 ? 'var(--success)' : 'var(--danger)';
    const pnlSign = pnl.percent >= 0 ? '+' : '';

    header.innerHTML = `${health.overallIcon} ${position.symbol} ${position.type} $${position.strike} - ${health.overallStatus}`;
    header.style.color = health.overallColor;

    let alertsHtml = '';
    if (alerts.length > 0) {
        alertsHtml = `
            <div style="margin-top: 16px; padding: 12px; background: var(--bg); border-radius: 8px;">
                <div style="font-weight: 700; margin-bottom: 8px;"> ACTIVE ALERTS:</div>
                ${alerts.map(a => `<div style="padding: 6px 0; border-bottom: 1px solid var(--border);">${a.icon} <strong>${a.urgency}:</strong> ${a.reason}</div>`).join('')}
            </div>
        `;
    }

    content.innerHTML = `
        <div style="margin-bottom: 16px;">
            <strong>Current P&L:</strong> <span style="color: ${pnlColor}; font-weight: 700;">${pnlSign}$${pnl.dollar.toFixed(0)} (${pnlSign}${pnl.percent.toFixed(0)}%)</span>
        </div>

        <div style="margin-bottom: 16px;">
            <strong>Position Details:</strong>
            <ul style="margin: 8px 0; padding-left: 20px;">
                <li>Entry: $${position.entryPrice.toFixed(2)} on ${formatGannDateShort(new Date(position.entryDate))}</li>
                <li>Current: $${position.currentPrice.toFixed(2)}</li>
                <li>Stop Loss: $${position.stopLoss.toFixed(2)}</li>
                <li>Target 1: $${position.target1.toFixed(2)} (${position.halfSold ? 'SOLD' : 'pending'})</li>
                <li>Target 2: $${position.target2.toFixed(2)}</li>
                <li>Days to Expiry: ${getDaysToExpiry(position.expiry)}</li>
            </ul>
        </div>

        ${alertsHtml}

        <div style="margin-top: 16px; padding: 12px; background: ${health.overallColor}20; border-radius: 8px;">
            <strong>Recommended Action:</strong> ${health.nextAction}
        </div>
    `;

    actions.innerHTML = `
        <button onclick="closeAlertModal()" style="padding: 10px 20px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text);">Close</button>
        <button onclick="closeAlertModal(); openExitModal(${position.id}, 'manual')" style="padding: 10px 20px; background: var(--danger); border: none; border-radius: 6px; cursor: pointer; color: white;">Exit Position</button>
    `;

    modal.style.display = 'flex';
}

// Close alert modal
function closeAlertModal() {
    document.getElementById('alertMessageModal').style.display = 'none';
}

// Handle exit action from alert banner
function handleExitAction(positionId, action) {
    const position = openPositions.find(p => p.id === parseInt(positionId));
    if (!position) return;

    if (action === 'CLOSE NOW' || action === 'CLOSE POSITION') {
        openExitModal(position.id, 'stop_loss');
    } else if (action === 'SELL HALF') {
        sellHalf(position.id);
    } else if (action === 'SELL ALL') {
        openExitModal(position.id, 'target_hit');
    } else if (action === 'TIGHTEN STOP') {
        // Tighten stop to 25% loss instead of 50%
        position.stopLoss = position.entryPrice * 0.75;
        saveOpenPositions();
        updateExitAlertSystem();
        alert(`Stop loss tightened to $${position.stopLoss.toFixed(2)}`);
    } else {
        showPositionAlert(position.id);
    }
}

// Sell half of position
function sellHalf(positionId) {
    const position = openPositions.find(p => p.id === positionId);
    if (!position || position.halfSold) return;

    position.halfSold = true;
    position.contracts = Math.ceil(position.contracts / 2);

    // Log the partial exit
    const pnl = calculatePnL(position);
    exitPerformanceLog.push({
        date: new Date().toISOString(),
        symbol: position.symbol,
        type: position.type,
        exitTrigger: 'TARGET_HIT',
        pnlPercent: pnl.percent,
        action: 'SELL_HALF'
    });

    saveOpenPositions();
    updateExitAlertSystem();
    alert(`Sold half of ${position.symbol} ${position.type} at $${position.currentPrice.toFixed(2)} for ${pnl.percent.toFixed(0)}% profit!`);
}

// Open exit confirmation modal
function openExitModal(positionId, reason) {
    const position = openPositions.find(p => p.id === positionId);
    if (!position) return;

    pendingExitPosition = { position, reason };
    const pnl = calculatePnL(position);
    const pnlColor = pnl.percent >= 0 ? 'var(--success)' : 'var(--danger)';
    const pnlSign = pnl.percent >= 0 ? '+' : '';

    const content = document.getElementById('exitConfirmContent');
    content.innerHTML = `
        <div style="margin-bottom: 16px;">
            <strong>${position.symbol} ${position.type} $${position.strike}</strong>
        </div>

        <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
            <div style="display: grid; gap: 8px; font-size: 13px;">
                <div>Entry: $${position.entryPrice.toFixed(2)} on ${formatGannDateShort(new Date(position.entryDate))}</div>
                <div>Exit: $${position.currentPrice.toFixed(2)} on ${formatGannDateShort(new Date())}</div>
                <div style="color: ${pnlColor}; font-weight: 700;">P&L: ${pnlSign}$${pnl.dollar.toFixed(0)} (${pnlSign}${pnl.percent.toFixed(0)}%)</div>
            </div>
        </div>

        <div style="margin-bottom: 16px;">
            <strong>Reason for Exit:</strong>
            <div style="margin-top: 8px;">
                <label style="display: block; padding: 8px; background: var(--bg); border-radius: 4px; margin-bottom: 4px; cursor: pointer;">
                    <input type="radio" name="exitReason" value="stop_loss" ${reason === 'stop_loss' ? 'checked' : ''}>  Stop loss hit
                </label>
                <label style="display: block; padding: 8px; background: var(--bg); border-radius: 4px; margin-bottom: 4px; cursor: pointer;">
                    <input type="radio" name="exitReason" value="target_hit" ${reason === 'target_hit' ? 'checked' : ''}>  Target reached
                </label>
                <label style="display: block; padding: 8px; background: var(--bg); border-radius: 4px; margin-bottom: 4px; cursor: pointer;">
                    <input type="radio" name="exitReason" value="trend_reversed" ${reason === 'trend_reversed' ? 'checked' : ''}>  Trend reversed
                </label>
                <label style="display: block; padding: 8px; background: var(--bg); border-radius: 4px; margin-bottom: 4px; cursor: pointer;">
                    <input type="radio" name="exitReason" value="time_exit" ${reason === 'time_exit' ? 'checked' : ''}>  Time exit (expiration)
                </label>
                <label style="display: block; padding: 8px; background: var(--bg); border-radius: 4px; cursor: pointer;">
                    <input type="radio" name="exitReason" value="manual" ${reason === 'manual' ? 'checked' : ''}>  Manual decision
                </label>
            </div>
        </div>
    `;

    document.getElementById('exitConfirmModal').style.display = 'flex';
}

// Close exit modal
function closeExitModal() {
    document.getElementById('exitConfirmModal').style.display = 'none';
    pendingExitPosition = null;
}

// Confirm and execute exit
function confirmExit() {
    if (!pendingExitPosition) return;

    const { position } = pendingExitPosition;
    const selectedReason = document.querySelector('input[name="exitReason"]:checked')?.value || 'manual';
    const pnl = calculatePnL(position);

    // Log the exit
    logTradeExit(position, selectedReason, position.currentPrice);

    // Remove from open positions
    openPositions = openPositions.filter(p => p.id !== position.id);
    saveOpenPositions();

    closeExitModal();
    updateExitAlertSystem();

    // Update trade tracker counts
    const completedCount = document.getElementById('gannCompletedCount');
    if (completedCount) {
        completedCount.textContent = parseInt(completedCount.textContent) + 1;
    }

    alert(`Position closed: ${position.symbol} ${position.type} at $${position.currentPrice.toFixed(2)} (${pnl.percent >= 0 ? '+' : ''}${pnl.percent.toFixed(0)}%)`);
}

// Log trade exit for performance tracking
function logTradeExit(position, exitReason, exitPrice) {
    const pnl = calculatePnL(position);

    exitPerformanceLog.push({
        date: new Date().toISOString(),
        symbol: position.symbol,
        type: position.type,
        strike: position.strike,
        entryPrice: position.entryPrice,
        exitPrice: exitPrice,
        entryDate: position.entryDate,
        exitTrigger: exitReason,
        pnlPercent: pnl.percent,
        pnlDollar: pnl.dollar,
        result: pnl.percent >= 0 ? 'WIN' : 'LOSS'
    });

    saveOpenPositions();
}

// Calculate exit performance statistics
function calculateExitPerformance() {
    const performance = {
        TARGET_HIT: { count: 0, totalPnl: 0, wins: 0 },
        STOP_LOSS: { count: 0, totalPnl: 0, wins: 0 },
        TREND_REVERSED: { count: 0, totalPnl: 0, wins: 0 },
        TIME_EXIT: { count: 0, totalPnl: 0, wins: 0 },
        MANUAL: { count: 0, totalPnl: 0, wins: 0 }
    };

    exitPerformanceLog.forEach(exit => {
        const key = exit.exitTrigger?.toUpperCase() || 'MANUAL';
        if (performance[key]) {
            performance[key].count++;
            performance[key].totalPnl += exit.pnlPercent;
            if (exit.pnlPercent >= 0) performance[key].wins++;
        }
    });

    // Calculate averages and win rates
    Object.keys(performance).forEach(key => {
        const p = performance[key];
        p.avgPnl = p.count > 0 ? (p.totalPnl / p.count).toFixed(1) : 0;
        p.winRate = p.count > 0 ? ((p.wins / p.count) * 100).toFixed(0) : 0;
    });

    return performance;
}

// Update the entire exit alert system
function updateExitAlertSystem() {
    loadOpenPositions();

    // Check all positions for alerts
    const allAlerts = [];
    openPositions.forEach(pos => {
        const alerts = checkExitConditions(pos);
        alerts.forEach(alert => {
            allAlerts.push({ position: pos, alert });
        });
    });

    // Sort alerts by urgency
    const urgencyOrder = { 'CRITICAL': 0, 'URGENT': 1, 'WARNING': 2, 'CAUTION': 3, 'TAKE PROFIT': 4, 'CONSIDER': 5, 'INFO': 6 };
    allAlerts.sort((a, b) => (urgencyOrder[a.alert.urgency] || 99) - (urgencyOrder[b.alert.urgency] || 99));

    // Update alert banner
    const banner = document.getElementById('exitAlertBanner');
    const alertBody = document.getElementById('exitAlertBody');

    if (banner && alertBody) {
        const urgentAlerts = allAlerts.filter(a => ['CRITICAL', 'URGENT', 'TAKE PROFIT'].includes(a.alert.urgency));

        if (urgentAlerts.length > 0) {
            banner.style.display = 'block';
            alertBody.innerHTML = urgentAlerts.map(a => generateExitAlertRow(a.position, a.alert)).join('');
        } else {
            banner.style.display = 'none';
        }
    }

    // Update positions dashboard
    const dashboard = document.getElementById('positionsDashboard');
    const container = document.getElementById('positionsContainer');

    if (dashboard && container) {
        if (openPositions.length > 0) {
            dashboard.style.display = 'block';
            container.innerHTML = openPositions.map(pos => generatePositionCard(pos)).join('');
        } else {
            dashboard.style.display = 'none';
        }
    }

    // Update daily review (show in morning hours)
    const hour = new Date().getHours();
    const dailyReview = document.getElementById('dailyPositionReview');
    if (dailyReview && openPositions.length > 0 && hour >= 6 && hour <= 10) {
        dailyReview.style.display = 'block';
        updateDailyReview();
    } else if (dailyReview) {
        dailyReview.style.display = 'none';
    }

    // Update trade tracker counts
    const waitingCount = document.getElementById('gannWaitingCount');
    const activeCount = document.getElementById('gannActiveCount');

    if (waitingCount) waitingCount.textContent = openPositions.length > 0 ? '0' : '1';
    if (activeCount) activeCount.textContent = openPositions.length.toString();

    console.log(' Exit Alert System updated:', openPositions.length, 'positions,', allAlerts.length, 'alerts');
}

// Update daily position review
function updateDailyReview() {
    const reviewDate = document.getElementById('reviewDate');
    const posCount = document.getElementById('openPositionCount');
    const reviewBody = document.getElementById('dailyReviewBody');
    const keyLevels = document.getElementById('dailyKeyLevels');

    if (reviewDate) {
        reviewDate.textContent = formatGannDate(new Date());
    }
    if (posCount) {
        posCount.textContent = openPositions.length.toString();
    }

    if (reviewBody) {
        let html = '';
        openPositions.forEach(pos => {
            const pnl = calculatePnL(pos);
            const pnlColor = pnl.percent >= 0 ? 'var(--success)' : 'var(--danger)';
            const outlook = pnl.percent >= 0 ? ' Bullish' : pnl.percent >= -10 ? ' Flat' : ' Bearish';
            const action = pnl.percent >= 0 ? ' HOLD' : pnl.percent >= -30 ? ' HOLD' : ' WATCH';

            html += `
                <tr>
                    <td style="font-weight: 600;">${pos.symbol} ${pos.type}</td>
                    <td style="color: ${pnlColor};">${pnl.percent >= 0 ? '+' : ''}${pnl.percent.toFixed(0)}%</td>
                    <td>${outlook}</td>
                    <td>${action}</td>
                </tr>
            `;
        });
        reviewBody.innerHTML = html;
    }

    if (keyLevels) {
        const price = parseFloat(document.getElementById('tickerPrice')?.textContent?.replace('$', '')) || 600;
        const sq9 = calculateSquareOf9Levels(price);
        const symbol = currentSymbol || 'SPY';

        keyLevels.innerHTML = `
            <div> ${symbol}: Support at $${sq9.s1.toFixed(2)}, Resistance at $${sq9.r1.toFixed(2)}</div>
        `;
    }
}

// Add a demo position for testing (can be removed in production)
function addDemoPosition() {
    const price = parseFloat(document.getElementById('tickerPrice')?.textContent?.replace('$', '')) || 600;
    const symbol = currentSymbol || 'SPY';

    addOpenPosition({
        symbol: symbol,
        type: 'CALL',
        strike: Math.round(price / 5) * 5 + 5,
        expiry: new Date(Date.now() + 12 * 24 * 60 * 60 * 1000).toISOString(),
        entryPrice: 4.20,
        currentPrice: 4.50,
        contracts: 2,
        stopLoss: 2.10,
        target1: 6.30,
        target2: 8.40
    });
}

// Update exit performance display
function updateExitPerformanceDisplay() {
    const perf = calculateExitPerformance();
    const tbody = document.getElementById('exitPerformanceBody');
    const insight = document.getElementById('exitInsight');

    if (!tbody) return;

    const triggers = [
        { key: 'TARGET_HIT', icon: '', name: 'Target Hit' },
        { key: 'STOP_LOSS', icon: '', name: 'Stop Loss' },
        { key: 'TREND_REVERSED', icon: '', name: 'Trend Reversed' },
        { key: 'TIME_EXIT', icon: '', name: 'Time Exit' },
        { key: 'MANUAL', icon: '', name: 'Manual' }
    ];

    let html = '';
    let bestTrigger = null;
    let bestWinRate = 0;

    triggers.forEach(t => {
        const p = perf[t.key] || { count: 0, avgPnl: 0, winRate: 0 };
        const assessment = p.count === 0 ? 'No data yet' :
            p.winRate >= 80 ? ' Excellent' :
            p.winRate >= 60 ? ' Good' :
            p.winRate >= 40 ? ' Mixed' : ' Review needed';

        const assessmentColor = p.count === 0 ? 'var(--muted)' :
            p.winRate >= 80 ? 'var(--success)' :
            p.winRate >= 60 ? 'var(--success)' :
            p.winRate >= 40 ? 'var(--warning)' : 'var(--danger)';

        if (p.count > 0 && p.winRate > bestWinRate) {
            bestWinRate = p.winRate;
            bestTrigger = t.name;
        }

        html += '<tr>';
        html += '<td>' + t.icon + ' ' + t.name + '</td>';
        html += '<td>' + p.count + '</td>';
        html += '<td style="color: ' + (parseFloat(p.avgPnl) >= 0 ? 'var(--success)' : 'var(--danger)') + ';">' + (p.count > 0 ? (parseFloat(p.avgPnl) >= 0 ? '+' : '') + p.avgPnl + '%' : '-') + '</td>';
        html += '<td>' + (p.count > 0 ? p.winRate + '%' : '-') + '</td>';
        html += '<td style="color: ' + assessmentColor + ';">' + assessment + '</td>';
        html += '</tr>';
    });

    tbody.innerHTML = html;

    // Update insight
    if (insight) {
        const totalTrades = Object.values(perf).reduce((sum, p) => sum + p.count, 0);
        if (totalTrades === 0) {
            insight.textContent = 'Complete more trades to see which exit signals work best for you.';
        } else if (bestTrigger) {
            insight.textContent = '"' + bestTrigger + '" exits have the best win rate at ' + bestWinRate + '%. Consider prioritizing these signals.';
        } else {
            insight.textContent = 'You have ' + totalTrades + ' completed trades. Keep tracking to identify patterns.';
        }
    }
}

// Initialize exit alert system
function initExitAlertSystem() {
    loadOpenPositions();
    updateExitAlertSystem();
    updateExitPerformanceDisplay();

    // Add CSS for pulse animation
    if (!document.getElementById('exitAlertStyles')) {
        const style = document.createElement('style');
        style.id = 'exitAlertStyles';
        style.textContent = `
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
        `;
        document.head.appendChild(style);
    }
}

// Hook into Gann tab activation
const origGannTabHandler = document.querySelector('[data-tab="gann-analysis"]')?.onclick;
document.querySelector('[data-tab="gann-analysis"]')?.addEventListener('click', () => {
    setTimeout(initExitAlertSystem, 300);
});

// Also check on page load if tab is active
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        if (document.getElementById('gann-analysis')?.classList.contains('active')) {
            initExitAlertSystem();
        }
    }, 1000);
});

// Check alerts when data refreshes
if (typeof originalRefreshData === 'undefined') {
    var originalRefreshData = window.refreshData;
}
if (originalRefreshData) {
    window.refreshData = function() {
        originalRefreshData.apply(this, arguments);
        setTimeout(updateExitAlertSystem, 500);
    };
}

// ===============================================
// MONTHLY TRADING DASHBOARD SYSTEM
// Trade Each When Ready - Multiple Position Management
// ===============================================

// All ETF data with sector information
// Calculate Turn Direction based on cycle and price position
// Returns: { direction: 'RALLY (UP)' or 'PULLBACK (DN)', trade: 'CALL' or 'PUT', isUp: boolean }
function calculateTurnDirection(symbol, currentTrend, cycleDay, priceLevel, supportLevel, resistanceLevel) {
    // Determine if near support or resistance
    const priceRange = resistanceLevel - supportLevel;
    const positionInRange = priceRange > 0 ? (priceLevel - supportLevel) / priceRange : 0.5;
    const atResistance = positionInRange > 0.8;
    const atSupport = positionInRange < 0.2;

    // Determine cycle position (near high = days 25-30 or 1-5, near low = days 12-18)
    const nearCycleHigh = cycleDay >= 25 || cycleDay <= 5;
    const nearCycleLow = cycleDay >= 12 && cycleDay <= 18;
    const midCycle = !nearCycleHigh && !nearCycleLow;

    // Determine current trend (simplified)
    const isUptrend = currentTrend === 'ASCENDING' || currentTrend === 'BULLISH' || currentTrend === 'UP';
    const isDowntrend = currentTrend === 'DESCENDING' || currentTrend === 'BEARISH' || currentTrend === 'DOWN';

    let direction = '';
    let trade = '';
    let isUp = true;

    // Apply turn direction logic
    if (isUptrend && nearCycleHigh && atResistance) {
        // Uptrend + near cycle high + at resistance = PULLBACK (DN) = PUT
        direction = 'PULLBACK (DN)';
        trade = 'PUT';
        isUp = false;
    } else if (isUptrend && (midCycle || nearCycleLow) && atSupport) {
        // Uptrend + mid cycle or low + at support = RALLY (UP) = CALL
        direction = 'RALLY (UP)';
        trade = 'CALL';
        isUp = true;
    } else if (isDowntrend && nearCycleLow && atSupport) {
        // Downtrend + near cycle low + at support = RALLY (UP) = CALL
        direction = 'RALLY (UP)';
        trade = 'CALL';
        isUp = true;
    } else if (isDowntrend && (midCycle || nearCycleHigh) && atResistance) {
        // Downtrend + mid cycle + at resistance = PULLBACK (DN) = PUT
        direction = 'PULLBACK (DN)';
        trade = 'PUT';
        isUp = false;
    } else if (isUptrend) {
        // Default for uptrend: expect continuation or pullback near highs
        if (nearCycleHigh) {
            direction = 'PULLBACK (DN)';
            trade = 'PUT';
            isUp = false;
        } else {
            direction = 'RALLY (UP)';
            trade = 'CALL';
            isUp = true;
        }
    } else if (isDowntrend) {
        // Default for downtrend: expect continuation or bounce near lows
        if (nearCycleLow) {
            direction = 'RALLY (UP)';
            trade = 'CALL';
            isUp = true;
        } else {
            direction = 'PULLBACK (DN)';
            trade = 'PUT';
            isUp = false;
        }
    } else {
        // Neutral/sideways: use cycle position
        if (nearCycleLow) {
            direction = 'RALLY (UP)';
            trade = 'CALL';
            isUp = true;
        } else {
            direction = 'PULLBACK (DN)';
            trade = 'PUT';
            isUp = false;
        }
    }

    return { direction, trade, isUp };
}

// Detect candlestick patterns from price data
// Returns: { name: string, timeframe: string, dateDetected: string, implication: 'bullish'|'bearish'|'neutral' }
function detectPatterns(candles, symbol) {
    if (!candles || candles.length < 10) {
        return { name: 'No Data', timeframe: '--', dateDetected: '--', implication: 'neutral' };
    }

    const patterns = [];
    const today = new Date();

    // Get last few candles for pattern detection
    const recent = candles.slice(-5);
    const current = recent[recent.length - 1];
    const prev = recent[recent.length - 2];
    const prev2 = recent.length > 2 ? recent[recent.length - 3] : null;

    if (!current || !prev) {
        return { name: 'Analyzing...', timeframe: 'Daily', dateDetected: formatShortDate(today), implication: 'neutral' };
    }

    // Parse candle values
    const currOpen = parseFloat(current.Open || current.open) || 0;
    const currClose = parseFloat(current.Close || current.close) || 0;
    const currHigh = parseFloat(current.High || current.high) || 0;
    const currLow = parseFloat(current.Low || current.low) || 0;

    const prevOpen = parseFloat(prev.Open || prev.open) || 0;
    const prevClose = parseFloat(prev.Close || prev.close) || 0;
    const prevHigh = parseFloat(prev.High || prev.high) || 0;
    const prevLow = parseFloat(prev.Low || prev.low) || 0;

    const currBody = Math.abs(currClose - currOpen);
    const currRange = currHigh - currLow;
    const currUpperWick = currHigh - Math.max(currOpen, currClose);
    const currLowerWick = Math.min(currOpen, currClose) - currLow;

    const prevBody = Math.abs(prevClose - prevOpen);
    const prevRange = prevHigh - prevLow;

    const isCurrGreen = currClose > currOpen;
    const isPrevGreen = prevClose > prevOpen;

    // Pattern Detection Logic

    // 1. Hammer - long lower wick, small body at top (bullish reversal)
    if (currLowerWick > currBody * 2 && currUpperWick < currBody * 0.5 && currRange > 0) {
        patterns.push({ name: 'Hammer', implication: 'bullish', weight: 3 });
    }

    // 2. Shooting Star - long upper wick, small body at bottom (bearish reversal)
    if (currUpperWick > currBody * 2 && currLowerWick < currBody * 0.5 && currRange > 0) {
        patterns.push({ name: 'Shooting Star', implication: 'bearish', weight: 3 });
    }

    // 3. Doji - very small body relative to range (indecision)
    if (currBody < currRange * 0.1 && currRange > 0) {
        patterns.push({ name: 'Doji', implication: 'neutral', weight: 2 });
    }

    // 4. Bullish Engulfing - green candle completely engulfs prior red candle
    if (isCurrGreen && !isPrevGreen &&
        currOpen <= prevClose && currClose >= prevOpen &&
        currBody > prevBody * 1.1) {
        patterns.push({ name: 'Bullish Engulfing', implication: 'bullish', weight: 4 });
    }

    // 5. Bearish Engulfing - red candle completely engulfs prior green candle
    if (!isCurrGreen && isPrevGreen &&
        currOpen >= prevClose && currClose <= prevOpen &&
        currBody > prevBody * 1.1) {
        patterns.push({ name: 'Bearish Engulfing', implication: 'bearish', weight: 4 });
    }

    // 6. Double Bottom Detection (simplified - check last 20 candles)
    if (candles.length >= 20) {
        const last20 = candles.slice(-20);
        const lows = last20.map(c => parseFloat(c.Low || c.low) || 0);
        const minLow = Math.min(...lows);
        const minIndices = lows.map((l, i) => Math.abs(l - minLow) < minLow * 0.02 ? i : -1).filter(i => i >= 0);

        // Check for two lows at similar levels with gap between them
        if (minIndices.length >= 2) {
            const gap = minIndices[minIndices.length - 1] - minIndices[0];
            if (gap >= 5) {
                patterns.push({ name: 'Double Bottom', implication: 'bullish', weight: 5 });
            }
        }
    }

    // 7. Double Top Detection (simplified - check last 20 candles)
    if (candles.length >= 20) {
        const last20 = candles.slice(-20);
        const highs = last20.map(c => parseFloat(c.High || c.high) || 0);
        const maxHigh = Math.max(...highs);
        const maxIndices = highs.map((h, i) => Math.abs(h - maxHigh) < maxHigh * 0.02 ? i : -1).filter(i => i >= 0);

        // Check for two highs at similar levels with gap between them
        if (maxIndices.length >= 2) {
            const gap = maxIndices[maxIndices.length - 1] - maxIndices[0];
            if (gap >= 5) {
                patterns.push({ name: 'Double Top', implication: 'bearish', weight: 5 });
            }
        }
    }

    // Sort by weight and return strongest pattern
    if (patterns.length > 0) {
        patterns.sort((a, b) => b.weight - a.weight);
        return {
            name: patterns[0].name,
            timeframe: 'Daily',
            dateDetected: formatShortDate(today),
            implication: patterns[0].implication
        };
    }

    // Default - no significant pattern detected
    return { name: 'None', timeframe: 'Daily', dateDetected: formatShortDate(today), implication: 'neutral' };
}

// Helper function to format date as "Dec 21"
function formatShortDate(date) {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return `${months[date.getMonth()]} ${date.getDate()}`;
}

const allETFData = [
    { symbol: 'SPY', name: 'S&P 500', sector: 'Broad Market', type: 'index' },
    { symbol: 'QQQ', name: 'Nasdaq 100', sector: 'Tech Heavy', type: 'index' },
    { symbol: 'IWM', name: 'Russell 2000', sector: 'Small Cap', type: 'index' },
    { symbol: 'DIA', name: 'Dow Jones', sector: 'Blue Chip', type: 'index' },
    { symbol: 'XLK', name: 'Technology', sector: 'Technology', type: 'sector' },
    { symbol: 'XLF', name: 'Financials', sector: 'Financials', type: 'sector' },
    { symbol: 'XLE', name: 'Energy', sector: 'Energy', type: 'sector' },
    { symbol: 'XLV', name: 'Healthcare', sector: 'Healthcare', type: 'sector' },
    { symbol: 'XLI', name: 'Industrials', sector: 'Industrials', type: 'sector' },
    { symbol: 'XLY', name: 'Consumer Disc', sector: 'Consumer', type: 'sector' },
    { symbol: 'XLP', name: 'Consumer Stap', sector: 'Defensive', type: 'sector' },
    { symbol: 'XLU', name: 'Utilities', sector: 'Defensive', type: 'sector' },
    { symbol: 'XLB', name: 'Materials', sector: 'Cyclical', type: 'sector' },
    { symbol: 'XLC', name: 'Communication', sector: 'Tech/Media', type: 'sector' },
    { symbol: 'XLRE', name: 'Real Estate', sector: 'Real Estate', type: 'sector' }
];

// Position limits configuration
const positionLimits = {
    maxPositions: 5,
    maxPerTrade: 10, // percent of portfolio
    maxTotalExposure: 50, // percent of portfolio
    portfolioSize: 10000 // default portfolio size
};

// Calculate entry window for each ETF based on Gann cycles
function calculateETFEntryWindows() {
    const today = new Date();
    const windows = [];

    allETFData.forEach((etf, index) => {
        // Each ETF has a slightly different cycle offset based on its characteristics
        const cycleOffset = (index * 2) % 30; // Stagger cycles across ETFs
        const baseCycleDay = calculateGannCycles().cycle30Day || 15;

        // Calculate this ETF's turn date
        const etfTurnDate = new Date(today);
        const daysUntilTurn = (30 - baseCycleDay + cycleOffset) % 30;
        etfTurnDate.setDate(today.getDate() + daysUntilTurn);

        // Entry window is 2 days before to 1 day after turn date
        const windowStart = new Date(etfTurnDate);
        windowStart.setDate(windowStart.getDate() - 2);
        const windowEnd = new Date(etfTurnDate);
        windowEnd.setDate(windowEnd.getDate() + 1);

        // Determine status
        let status = 'WAITING';
        let daysUntilWindow = Math.ceil((windowStart - today) / (24 * 60 * 60 * 1000));

        if (today >= windowStart && today <= windowEnd) {
            status = 'READY';
            daysUntilWindow = 0;
        } else if (daysUntilWindow <= 3) {
            status = 'SOON';
        } else if (daysUntilWindow <= 7) {
            status = 'UPCOMING';
        }

        // Check if already have active position
        const openPositions = JSON.parse(localStorage.getItem('openPositions') || '[]');
        const hasActive = openPositions.some(p => p.symbol === etf.symbol && p.status === 'active');
        if (hasActive) {
            status = 'ACTIVE';
        }

        // Calculate trade score for this ETF
        const score = calculateETFTradeScore(etf, daysUntilWindow);

        // Determine recommended direction based on cycle phase
        const cyclePhase = baseCycleDay <= 15 ? 'ASCENDING' : 'DESCENDING';
        const direction = cyclePhase === 'ASCENDING' ? 'CALL' : 'PUT';

        windows.push({
            ...etf,
            turnDate: etfTurnDate,
            windowStart,
            windowEnd,
            status,
            daysUntilWindow,
            score,
            direction,
            cyclePhase
        });
    });

    // Sort by readiness (READY first, then by days until window)
    windows.sort((a, b) => {
        const statusOrder = { 'READY': 0, 'ACTIVE': 1, 'SOON': 2, 'UPCOMING': 3, 'WAITING': 4 };
        if (statusOrder[a.status] !== statusOrder[b.status]) {
            return statusOrder[a.status] - statusOrder[b.status];
        }
        return a.daysUntilWindow - b.daysUntilWindow;
    });

    return windows;
}

// Calculate trade score for individual ETF - uses unified scoring system
function calculateETFTradeScore(etf, daysUntilWindow) {
    // Use the master scoring function
    const gannScore = calculateGannScore(etf.symbol);

    // Return the unified score (no modifications to ensure consistency)
    return gannScore.score;
}

// Get sector rotation phase
function getSectorRotationPhase() {
    const month = new Date().getMonth();

    // Simple sector rotation model
    if (month >= 2 && month <= 5) {
        // Spring: Growth/Cyclical
        return {
            phase: 'RISK-ON',
            description: 'Money flowing into growth sectors (Tech, Consumer). Good for aggressive trades.',
            hotSectors: ['Technology', 'Consumer', 'Tech/Media'],
            warmSectors: ['Cyclical', 'Small Cap', 'Industrials'],
            coldSectors: ['Defensive', 'Utilities']
        };
    } else if (month >= 6 && month <= 8) {
        // Summer: Mixed/Defensive
        return {
            phase: 'NEUTRAL',
            description: 'Markets typically quiet. Mixed sector performance. Selective trading recommended.',
            hotSectors: ['Healthcare', 'Consumer', 'Tech Heavy'],
            warmSectors: ['Broad Market', 'Blue Chip'],
            coldSectors: ['Energy', 'Financials']
        };
    } else if (month >= 9 && month <= 10) {
        // Fall: Volatility/Value
        return {
            phase: 'RISK-OFF',
            description: 'Volatility rising. Money moving to defensive sectors and value.',
            hotSectors: ['Defensive', 'Financials', 'Healthcare'],
            warmSectors: ['Utilities', 'Consumer', 'Blue Chip'],
            coldSectors: ['Technology', 'Small Cap', 'Cyclical']
        };
    } else {
        // Winter: Year-end rally
        return {
            phase: 'RISK-ON',
            description: 'Year-end rally typically lifts growth stocks. Santa Claus rally effect.',
            hotSectors: ['Technology', 'Consumer', 'Tech Heavy', 'Small Cap'],
            warmSectors: ['Broad Market', 'Financials', 'Industrials'],
            coldSectors: ['Utilities', 'Defensive']
        };
    }
}

// Populate the trading opportunities table
// STATUS and COLORS are based on SCORE, not just entry window timing
function populateOpportunitiesTable() {
    const tbody = document.getElementById('mtOpportunitiesBody');
    if (!tbody) return;

    const windows = calculateETFEntryWindows();
    const openPositions = JSON.parse(localStorage.getItem('openPositions') || '[]');

    let html = '';
    windows.forEach(etf => {
        // Determine status based on SCORE (not just entry window)
        // If entry window is open (etf.status was 'READY'), use score to determine actual status
        let displayStatus = etf.status;
        let statusIcon = '';
        let statusColor = '';
        let rowBg = '';

        // Check if this is an active position
        const isActive = openPositions.some(p => p.symbol === etf.symbol && p.status === 'active');

        if (isActive) {
            // Active position - always show ACTIVE
            displayStatus = 'ACTIVE';
            statusIcon = '';
            statusColor = 'var(--danger)';
            rowBg = 'rgba(239,68,68,0.1)';
        } else if (etf.status === 'READY') {
            // Entry window is open - status depends on SCORE
            if (etf.score >= 70) {
                displayStatus = 'READY';
                statusIcon = '';
                statusColor = 'var(--success)';
                rowBg = 'rgba(16,185,129,0.1)';
            } else if (etf.score >= 50) {
                displayStatus = 'WAIT';
                statusIcon = '';
                statusColor = 'var(--warning)';
                rowBg = 'rgba(245,158,11,0.05)';
            } else {
                displayStatus = 'SKIP';
                statusIcon = '';
                statusColor = 'var(--danger)';
                rowBg = 'rgba(239,68,68,0.05)';
            }
        } else if (etf.status === 'SOON') {
            displayStatus = 'SOON';
            statusIcon = '';
            statusColor = 'var(--warning)';
            rowBg = 'rgba(245,158,11,0.03)';
        } else if (etf.status === 'UPCOMING') {
            displayStatus = 'UPCOMING';
            statusIcon = '';
            statusColor = 'var(--primary)';
            rowBg = '';
        } else {
            displayStatus = 'WAITING';
            statusIcon = '';
            statusColor = 'var(--muted)';
            rowBg = '';
        }

        // Entry window text
        const windowText = etf.status === 'READY' ? 'NOW!' :
                          isActive ? 'OPEN' :
                          `${etf.daysUntilWindow || 0}d`;

        // Setup Score column (WEAK/OK/GOOD/GREAT)
        let setupText = '';
        let setupColor = '';
        if (etf.score >= 80) {
            setupText = 'GREAT';
            setupColor = 'var(--success)';
        } else if (etf.score >= 70) {
            setupText = 'GOOD';
            setupColor = 'var(--success)';
        } else if (etf.score >= 50) {
            setupText = 'OK';
            setupColor = 'var(--warning)';
        } else {
            setupText = 'WEAK';
            setupColor = 'var(--danger)';
        }

        // Score color
        const scoreColor = etf.score >= 70 ? 'var(--success)' :
                          etf.score >= 50 ? 'var(--warning)' : 'var(--danger)';

        // Direction
        const directionIcon = etf.direction === 'CALL' ? '' : '';
        const directionColor = etf.direction === 'CALL' ? 'var(--success)' : 'var(--danger)';

        // Action button based on SCORE
        let actionBtn = '';
        if (isActive) {
            actionBtn = `<button onclick="openTradeDetail('${etf.symbol}')" style="padding: 4px 8px; background: var(--danger); border: none; border-radius: 4px; color: white; font-size: 10px; cursor: pointer;">MANAGE</button>`;
        } else if (etf.status === 'READY' && etf.score >= 70) {
            // Good score + entry window open = TRADE
            actionBtn = `<button onclick="openTradeDetail('${etf.symbol}')" style="padding: 4px 8px; background: var(--success); border: none; border-radius: 4px; color: white; font-size: 10px; cursor: pointer;">TRADE</button>`;
        } else if (etf.status === 'READY' && etf.score >= 50) {
            // OK score + entry window open = VIEW (yellow)
            actionBtn = `<button onclick="openTradeDetail('${etf.symbol}')" style="padding: 4px 8px; background: var(--warning); border: none; border-radius: 4px; color: black; font-size: 10px; cursor: pointer;">VIEW</button>`;
        } else if (etf.status === 'READY' && etf.score < 50) {
            // Weak score + entry window open = SKIP (red/disabled)
            actionBtn = `<button onclick="openTradeDetail('${etf.symbol}')" style="padding: 4px 8px; background: var(--danger); border: none; border-radius: 4px; color: white; font-size: 10px; cursor: pointer; opacity: 0.7;">SKIP</button>`;
        } else {
            // Entry window not open = VIEW (gray)
            actionBtn = `<button onclick="openTradeDetail('${etf.symbol}')" style="padding: 4px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 10px; cursor: pointer;">VIEW</button>`;
        }

        // Get current price for this ETF from multiple sources
        let currentPrice = 0;

        // Source 1: allSymbolsData (loaded from CSV files)
        if (typeof allSymbolsData !== 'undefined' && allSymbolsData[etf.symbol] && allSymbolsData[etf.symbol].length > 0) {
            const latestBar = allSymbolsData[etf.symbol][allSymbolsData[etf.symbol].length - 1];
            currentPrice = parseFloat(latestBar.Close) || parseFloat(latestBar.close) || 0;
        }

        // Source 2: currentData (if this is the currently selected symbol)
        if (currentPrice === 0 && etf.symbol === currentSymbol && typeof currentData !== 'undefined' && currentData.length > 0) {
            const latestBar = currentData[currentData.length - 1];
            currentPrice = parseFloat(latestBar.Close) || parseFloat(latestBar.close) || 0;
        }

        // Source 3: window.symbolData (populated by various functions)
        if (currentPrice === 0 && typeof window.symbolData !== 'undefined' && window.symbolData[etf.symbol]) {
            currentPrice = window.symbolData[etf.symbol].price || 0;
        }

        const priceDisplay = currentPrice > 0 ? `$${currentPrice.toFixed(2)}` : '--';

        // Get candle data for pattern detection
        let candles = [];
        if (typeof allSymbolsData !== 'undefined' && allSymbolsData[etf.symbol]) {
            candles = allSymbolsData[etf.symbol];
        } else if (etf.symbol === currentSymbol && typeof currentData !== 'undefined') {
            candles = currentData;
        }

        // Calculate support and resistance levels from recent price data
        let supportLevel = currentPrice * 0.95;
        let resistanceLevel = currentPrice * 1.05;
        if (candles.length >= 20) {
            const last20 = candles.slice(-20);
            const lows = last20.map(c => parseFloat(c.Low || c.low) || currentPrice);
            const highs = last20.map(c => parseFloat(c.High || c.high) || currentPrice);
            supportLevel = Math.min(...lows);
            resistanceLevel = Math.max(...highs);
        }

        // Get Gann cycle day
        const gannCycles = calculateGannCycles();
        const cycleDay = gannCycles.cycle30Day || 15;

        // Calculate turn direction using new function
        const turnInfo = calculateTurnDirection(
            etf.symbol,
            etf.cyclePhase,
            cycleDay,
            currentPrice,
            supportLevel,
            resistanceLevel
        );

        // Detect patterns using new function
        const patternInfo = detectPatterns(candles, etf.symbol);

        // Format next turn date
        const nextTurnDate = etf.turnDate ? formatShortDate(etf.turnDate) : '--';

        // Calculate days until turn
        const daysUntilTurn = etf.turnDate ? Math.max(0, Math.ceil((etf.turnDate - new Date()) / (24 * 60 * 60 * 1000))) : 0;

        // Calculate price target (estimate based on direction and recent range)
        let targetPrice = currentPrice;
        if (currentPrice > 0) {
            const priceRange = resistanceLevel - supportLevel;
            if (turnInfo.isUp) {
                targetPrice = currentPrice + (priceRange * 0.5);
            } else {
                targetPrice = currentPrice - (priceRange * 0.5);
            }
        }
        const targetDisplay = targetPrice > 0 ? `$${targetPrice.toFixed(0)}` : '--';

        // Pattern class based on implication
        const patternClass = patternInfo.implication === 'bullish' ? 'pattern-bullish' :
                            patternInfo.implication === 'bearish' ? 'pattern-bearish' : 'pattern-neutral';

        html += `
            <tr style="background: ${rowBg}; cursor: pointer;" onclick="openTradeDetail('${etf.symbol}')">
                <td style="color: ${statusColor}; font-weight: 600;">${statusIcon} ${displayStatus}</td>
                <td style="font-weight: 700; color: var(--primary);">${etf.symbol}</td>
                <td style="font-size: 10px;">${etf.sector}</td>
                <td style="font-weight: 600;">${priceDisplay}</td>
                <td style="font-weight: 600;">${nextTurnDate}</td>
                <td style="font-weight: 600;">${daysUntilTurn}</td>
                <td class="${turnInfo.isUp ? 'turn-up' : 'turn-down'}">${turnInfo.direction}</td>
                <td class="${turnInfo.trade === 'CALL' ? 'trade-call' : 'trade-put'}">${turnInfo.trade}</td>
                <td style="font-weight: 600;">${targetDisplay}</td>
                <td class="${patternClass}">${patternInfo.name}</td>
                <td style="font-size: 10px; color: var(--muted);">${patternInfo.timeframe}</td>
                <td style="font-size: 10px; color: var(--muted);">${patternInfo.dateDetected}</td>
                <td style="color: ${scoreColor}; font-weight: 600;">${etf.score}</td>
                <td onclick="event.stopPropagation();">${actionBtn}</td>
            </tr>
        `;
    });

    tbody.innerHTML = html;

    // Update summary counts
    updatePositionSummary(windows);
}

// Update position summary display
function updatePositionSummary(windows) {
    const openPositions = JSON.parse(localStorage.getItem('openPositions') || '[]');
    const activeCount = openPositions.filter(p => p.status === 'active').length;
    const readyCount = windows.filter(w => w.status === 'READY').length;
    const waitingCount = windows.filter(w => w.status === 'WAITING' || w.status === 'UPCOMING').length;

    // Update display elements
    const mtActiveEl = document.getElementById('mtActivePositions');
    const mtReadyEl = document.getElementById('mtReadyCount');
    const mtWaitingEl = document.getElementById('mtWaitingCount');
    const mtPositionBar = document.getElementById('mtPositionBar');
    const mtCapitalBar = document.getElementById('mtCapitalBar');
    const mtCapitalDeployed = document.getElementById('mtCapitalDeployed');

    if (mtActiveEl) mtActiveEl.textContent = activeCount;
    if (mtReadyEl) mtReadyEl.textContent = readyCount;
    if (mtWaitingEl) mtWaitingEl.textContent = waitingCount;

    // Update position bar
    const positionPercent = (activeCount / positionLimits.maxPositions) * 100;
    if (mtPositionBar) mtPositionBar.style.width = `${Math.min(100, positionPercent)}%`;

    // Calculate capital deployed (rough estimate)
    const capitalDeployed = activeCount * positionLimits.maxPerTrade;
    if (mtCapitalDeployed) mtCapitalDeployed.textContent = `${capitalDeployed}%`;
    if (mtCapitalBar) mtCapitalBar.style.width = `${Math.min(100, (capitalDeployed / positionLimits.maxTotalExposure) * 100)}%`;

    // Show entry alert if trades are ready
    showEntryAlerts(windows.filter(w => w.status === 'READY'));
}

// Show entry alerts for ready trades - WITH SCORE-BASED LOGIC
function showEntryAlerts(readyTrades) {
    const banner = document.getElementById('entryAlertBanner');
    const content = document.getElementById('entryAlertContent');
    const titleEl = banner?.querySelector('.card-title');

    if (!banner || !content) return;

    if (readyTrades.length === 0) {
        banner.style.display = 'none';
        return;
    }

    // Check if at position limit
    const openPositions = JSON.parse(localStorage.getItem('openPositions') || '[]');
    const activeCount = openPositions.filter(p => p.status === 'active').length;

    if (activeCount >= positionLimits.maxPositions) {
        banner.style.display = 'block';
        banner.style.background = 'linear-gradient(135deg, rgba(245,158,11,0.2), rgba(239,68,68,0.2))';
        banner.style.borderColor = 'var(--warning)';
        if (titleEl) titleEl.innerHTML = ' POSITION LIMIT REACHED ';
        content.innerHTML = `
            <div style="font-weight: 700; margin-bottom: 8px;">You have ${activeCount}/${positionLimits.maxPositions} positions open.</div>
            <div>Close a position to trade: ${readyTrades.map(t => `<strong>${t.symbol}</strong>`).join(', ')}</div>
        `;
        return;
    }

    // Filter trades by score threshold
    const greatTrades = readyTrades.filter(t => t.score >= 80);  // Great setup
    const goodTrades = readyTrades.filter(t => t.score >= 70 && t.score < 80);  // Good setup
    const okTrades = readyTrades.filter(t => t.score >= 50 && t.score < 70);  // OK setup
    const weakTrades = readyTrades.filter(t => t.score < 50);  // Weak setup

    // Determine what to show based on best available trades
    if (greatTrades.length > 0 || goodTrades.length > 0) {
        // SHOW: Trade Now Available (score >= 70)
        const tradesToShow = [...greatTrades, ...goodTrades];
        banner.style.display = 'block';
        banner.style.background = 'linear-gradient(135deg, rgba(16,185,129,0.2), rgba(59,130,246,0.2))';
        banner.style.borderColor = 'var(--success)';
        if (titleEl) {
            titleEl.style.color = 'var(--success)';
            titleEl.innerHTML = ' TRADE NOW - GOOD SETUP! ';
        }
        content.innerHTML = `
            <div style="font-weight: 700; margin-bottom: 8px;"> ${tradesToShow.length} HIGH-QUALITY TRADE${tradesToShow.length > 1 ? 'S' : ''} AVAILABLE</div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                ${tradesToShow.map(t => `
                    <div style="background: var(--bg); padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; gap: 8px; border: 1px solid ${t.score >= 80 ? 'var(--success)' : 'var(--primary)'};">
                        <strong>${t.symbol}</strong>
                        <span style="color: ${t.direction === 'CALL' ? 'var(--success)' : 'var(--danger)'};">${t.direction === 'CALL' ? '' : ''} ${t.direction}</span>
                        <span style="color: ${t.score >= 80 ? 'var(--success)' : 'var(--primary)'}; font-weight: 600;">${t.score >= 80 ? '' : ''} ${t.score}</span>
                        <button onclick="openTradeDetail('${t.symbol}')" style="padding: 4px 10px; background: var(--success); border: none; border-radius: 4px; color: white; font-size: 11px; cursor: pointer;">TRADE</button>
                    </div>
                `).join('')}
            </div>
        `;
    } else if (okTrades.length > 0) {
        // SHOW: Almost Ready (score 50-69)
        banner.style.display = 'block';
        banner.style.background = 'linear-gradient(135deg, rgba(245,158,11,0.15), rgba(139,92,246,0.15))';
        banner.style.borderColor = 'var(--warning)';
        if (titleEl) {
            titleEl.style.color = 'var(--warning)';
            titleEl.innerHTML = ' ALMOST READY - WAIT FOR BETTER SETUP ';
        }
        content.innerHTML = `
            <div style="font-weight: 700; margin-bottom: 8px;"> ${okTrades.length} trade${okTrades.length > 1 ? 's' : ''} in entry window but score is mediocre (50-69)</div>
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 10px;">Consider waiting for better conditions or trade with smaller position size.</div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                ${okTrades.map(t => `
                    <div style="background: var(--bg); padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; gap: 8px; opacity: 0.8;">
                        <strong>${t.symbol}</strong>
                        <span style="color: ${t.direction === 'CALL' ? 'var(--success)' : 'var(--danger)'};">${t.direction === 'CALL' ? '' : ''}</span>
                        <span style="color: var(--warning);"> ${t.score}</span>
                        <button onclick="openTradeDetail('${t.symbol}')" style="padding: 4px 10px; background: var(--warning); border: none; border-radius: 4px; color: black; font-size: 11px; cursor: pointer;">VIEW</button>
                    </div>
                `).join('')}
            </div>
        `;
    } else if (weakTrades.length > 0) {
        // SHOW: Not Ready (score < 50)
        banner.style.display = 'block';
        banner.style.background = 'linear-gradient(135deg, rgba(239,68,68,0.1), rgba(107,114,128,0.1))';
        banner.style.borderColor = 'var(--danger)';
        if (titleEl) {
            titleEl.style.color = 'var(--danger)';
            titleEl.innerHTML = ' NOT READY - DO NOT TRADE ';
        }
        content.innerHTML = `
            <div style="font-weight: 700; margin-bottom: 8px;"> Entry window open but setup is WEAK (score < 50)</div>
            <div style="font-size: 12px; color: var(--muted); margin-bottom: 10px;">Skip this cycle. Wait for next month's better setup.</div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                ${weakTrades.slice(0, 3).map(t => `
                    <div style="background: var(--bg); padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; gap: 8px; opacity: 0.6;">
                        <strong>${t.symbol}</strong>
                        <span style="color: var(--danger);"> ${t.score}</span>
                    </div>
                `).join('')}
                ${weakTrades.length > 3 ? `<span style="color: var(--muted);">+${weakTrades.length - 3} more</span>` : ''}
            </div>
        `;
    } else {
        banner.style.display = 'none';
    }
}

// Populate sector rotation grid
function populateSectorRotation() {
    const grid = document.getElementById('sectorRotationGrid');
    const phaseText = document.getElementById('rotationPhaseText');
    if (!grid) return;

    const rotation = getSectorRotationPhase();
    const windows = calculateETFEntryWindows();

    // Group ETFs by sector strength
    const sectorStrength = {};
    windows.forEach(etf => {
        if (!sectorStrength[etf.sector]) {
            sectorStrength[etf.sector] = { symbols: [], avgScore: 0 };
        }
        sectorStrength[etf.sector].symbols.push(etf.symbol);
        sectorStrength[etf.sector].avgScore += etf.score;
    });

    Object.keys(sectorStrength).forEach(sector => {
        sectorStrength[sector].avgScore = Math.round(sectorStrength[sector].avgScore / sectorStrength[sector].symbols.length);
    });

    let html = '';
    Object.entries(sectorStrength)
        .sort((a, b) => b[1].avgScore - a[1].avgScore)
        .forEach(([sector, data]) => {
            const isHot = rotation.hotSectors.includes(sector);
            const isWarm = rotation.warmSectors.includes(sector);
            const isCold = rotation.coldSectors.includes(sector);

            const bgColor = isHot ? 'rgba(16,185,129,0.15)' :
                           isWarm ? 'rgba(245,158,11,0.1)' :
                           isCold ? 'rgba(239,68,68,0.1)' : 'var(--bg)';

            const borderColor = isHot ? 'var(--success)' :
                               isWarm ? 'var(--warning)' :
                               isCold ? 'var(--danger)' : 'var(--border)';

            const label = isHot ? ' HOT' : isWarm ? ' WARM' : isCold ? ' COLD' : ' NEUTRAL';

            html += `
                <div style="background: ${bgColor}; border: 1px solid ${borderColor}; padding: 10px; border-radius: 6px;">
                    <div style="font-size: 12px; font-weight: 700; margin-bottom: 4px;">${sector}</div>
                    <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;">${data.symbols.join(', ')}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 10px;">${label}</span>
                        <span style="font-size: 12px; font-weight: 600;">${data.avgScore}</span>
                    </div>
                </div>
            `;
        });

    grid.innerHTML = html;

    // Update phase text
    if (phaseText) {
        const phaseColors = {
            'RISK-ON': 'var(--success)',
            'RISK-OFF': 'var(--danger)',
            'NEUTRAL': 'var(--warning)'
        };
        phaseText.innerHTML = `
            <strong style="color: ${phaseColors[rotation.phase]};">${rotation.phase}:</strong> ${rotation.description}
        `;
    }
}

// Generate multi-ETF calendar
function generateMultiETFCalendar() {
    const container = document.getElementById('mtCalendarDays');
    const monthLabel = document.getElementById('mtCalendarMonth');
    if (!container) return;

    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();

    if (monthLabel) {
        monthLabel.textContent = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    }

    // Get first day and total days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Get all ETF windows
    const windows = calculateETFEntryWindows();

    // Build calendar map
    const calendarMap = {};
    windows.forEach(etf => {
        // Mark all days in each ETF's window
        let current = new Date(etf.windowStart);
        while (current <= etf.windowEnd) {
            const dayKey = current.getDate();
            if (current.getMonth() === month) {
                if (!calendarMap[dayKey]) calendarMap[dayKey] = [];
                calendarMap[dayKey].push(etf.symbol);
            }
            current.setDate(current.getDate() + 1);
        }
    });

    let html = '';

    // Empty cells before first day
    for (let i = 0; i < firstDay; i++) {
        html += '<div style="padding: 6px; text-align: center;"></div>';
    }

    // Days of month
    for (let day = 1; day <= daysInMonth; day++) {
        const isToday = day === now.getDate();
        const hasWindows = calendarMap[day] && calendarMap[day].length > 0;
        const windowCount = hasWindows ? calendarMap[day].length : 0;

        let style = 'padding: 6px; text-align: center; border-radius: 4px; position: relative;';

        if (isToday) {
            style += ' background: var(--warning); color: black; font-weight: 700;';
        } else if (hasWindows) {
            const intensity = Math.min(windowCount / 5, 1);
            style += ` background: rgba(16,185,129,${0.1 + intensity * 0.3}); font-weight: 600;`;
        }

        const etfList = hasWindows ? calendarMap[day].join(', ') : '';
        const badge = windowCount > 0 ? `<span style="position: absolute; top: -2px; right: -2px; font-size: 8px; background: var(--success); color: white; border-radius: 50%; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center;">${windowCount}</span>` : '';

        // Create tooltip element for better visibility
        const tooltipDiv = hasWindows ? `<div class="calendar-tooltip" style="display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 8px; font-size: 10px; white-space: nowrap; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
            <div style="font-weight: 700; margin-bottom: 4px; color: var(--success);">Entry Windows Open:</div>
            <div style="color: var(--text);">${etfList}</div>
        </div>` : '';

        html += `<div style="${style} cursor: ${hasWindows ? 'pointer' : 'default'};"
            onmouseenter="this.querySelector('.calendar-tooltip')?.style.setProperty('display', 'block')"
            onmouseleave="this.querySelector('.calendar-tooltip')?.style.setProperty('display', 'none')"
            onclick="${hasWindows ? `alert('Entry windows on day ${day}: ${etfList}')` : ''}"
            >${day}${badge}${tooltipDiv}</div>`;
    }

    container.innerHTML = html;
}

// Open trade detail modal for specific ETF
let currentDetailETF = null;

function openTradeDetail(symbol) {
    const modal = document.getElementById('tradeDetailModal');
    if (!modal) return;

    const windows = calculateETFEntryWindows();
    const etf = windows.find(w => w.symbol === symbol);
    if (!etf) return;

    currentDetailETF = etf;

    // Get price data from allSymbolsData (the actual data source)
    let currentPrice = 100; // fallback
    let atr = 5; // fallback ATR

    if (typeof allSymbolsData !== 'undefined' && allSymbolsData[symbol] && allSymbolsData[symbol].length > 0) {
        const latestBar = allSymbolsData[symbol][allSymbolsData[symbol].length - 1];
        currentPrice = parseFloat(latestBar.Close) || parseFloat(latestBar.close) || 100;
        atr = parseFloat(latestBar.ATR) || parseFloat(latestBar.atr) || (currentPrice * 0.015);
    } else if (symbol === currentSymbol && currentData && currentData.length > 0) {
        // Fallback to current symbol data if it matches
        const latestBar = currentData[currentData.length - 1];
        currentPrice = parseFloat(latestBar.Close) || parseFloat(latestBar.close) || 100;
        atr = parseFloat(latestBar.ATR) || parseFloat(latestBar.atr) || (currentPrice * 0.015);
    }

    const sq9 = calculateSquareOf9Levels(currentPrice);

    // Calculate entry and profit targets using Gann levels
    const entryTarget = etf.direction === 'CALL' ? sq9.s1 : sq9.r1;
    const profitTarget = etf.direction === 'CALL' ? sq9.r1 : sq9.s1;

    // Update modal content
    document.getElementById('tdSymbolTitle').textContent = `${etf.symbol} - ${etf.name}`;
    document.getElementById('tdCurrentPrice').textContent = `$${currentPrice.toFixed(2)}`;
    document.getElementById('tdEntryTarget').textContent = `$${entryTarget.toFixed(2)}`;
    document.getElementById('tdProfitTarget').textContent = `$${profitTarget.toFixed(2)}`;

    // Update status banner
    const statusBanner = document.getElementById('tdStatusBanner');
    if (etf.status === 'READY') {
        statusBanner.style.background = 'rgba(16,185,129,0.15)';
        statusBanner.style.borderColor = 'var(--success)';
        statusBanner.innerHTML = `
            <div style="font-size: 16px; font-weight: 700; color: var(--success);"> READY TO TRADE</div>
            <div style="font-size: 12px; color: var(--muted);">Entry window: ${etf.windowStart.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})} - ${etf.windowEnd.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</div>
        `;
    } else if (etf.status === 'ACTIVE') {
        statusBanner.style.background = 'rgba(239,68,68,0.15)';
        statusBanner.style.borderColor = 'var(--danger)';
        statusBanner.innerHTML = `
            <div style="font-size: 16px; font-weight: 700; color: var(--danger);"> POSITION OPEN</div>
            <div style="font-size: 12px; color: var(--muted);">Manage your active trade</div>
        `;
    } else {
        statusBanner.style.background = 'rgba(245,158,11,0.15)';
        statusBanner.style.borderColor = 'var(--warning)';
        statusBanner.innerHTML = `
            <div style="font-size: 16px; font-weight: 700; color: var(--warning);"> WAITING</div>
            <div style="font-size: 12px; color: var(--muted);">Entry window opens in ${etf.daysUntilWindow || 0} days</div>
        `;
    }

    // Update direction boxes
    const callBox = document.getElementById('tdCallBox');
    const putBox = document.getElementById('tdPutBox');

    if (etf.direction === 'CALL') {
        callBox.style.opacity = '1';
        putBox.style.opacity = '0.5';
    } else {
        callBox.style.opacity = '0.5';
        putBox.style.opacity = '1';
    }

    // Calculate options details with realistic pricing
    const strikePrice = Math.round(currentPrice / 5) * 5;
    const expiry = new Date();
    expiry.setDate(expiry.getDate() + 21); // 3 weeks out
    const expiryStr = expiry.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});

    // More realistic option pricing based on ATR and price level
    // ATM options typically cost around 2-4% of stock price for 3-week expiry
    const baseOptionCost = Math.max(1.50, atr * 1.5); // Use ATR for realistic pricing
    const callCost = baseOptionCost.toFixed(2);
    const putCost = (baseOptionCost * 0.9).toFixed(2); // Puts slightly cheaper typically

    // Stop at 50% loss, target at 50% gain
    const callStop = (baseOptionCost * 0.5).toFixed(2);
    const callTarget = (baseOptionCost * 1.5).toFixed(2);
    const putStop = (baseOptionCost * 0.9 * 0.5).toFixed(2);
    const putTarget = (baseOptionCost * 0.9 * 1.5).toFixed(2);

    document.getElementById('tdCallStrike').textContent = `$${strikePrice}`;
    document.getElementById('tdCallExpiry').textContent = expiryStr;
    document.getElementById('tdCallCost').textContent = `$${callCost}`;
    document.getElementById('tdCallStop').textContent = `$${callStop}`;
    document.getElementById('tdCallTargetPrice').textContent = `$${callTarget}`;

    document.getElementById('tdPutStrike').textContent = `$${strikePrice}`;
    document.getElementById('tdPutExpiry').textContent = expiryStr;
    document.getElementById('tdPutCost').textContent = `$${putCost}`;
    document.getElementById('tdPutStop').textContent = `$${putStop}`;
    document.getElementById('tdPutTargetPrice').textContent = `$${putTarget}`;

    // Update score breakdown using unified scoring system
    const gannScore = calculateGannScore(etf.symbol);
    document.getElementById('tdTimingScore').textContent = `${gannScore.details.timing}/30`;
    document.getElementById('tdPriceScore').textContent = `${gannScore.details.price}/25`;
    document.getElementById('tdTrendScore').textContent = `${gannScore.details.trend}/20`;
    document.getElementById('tdSectorScore').textContent = `${gannScore.details.agents}/15`;
    document.getElementById('tdTotalScore').textContent = `${gannScore.score}/100`;
    document.getElementById('tdTotalScore').style.color = gannScore.score >= 70 ? 'var(--success)' : gannScore.score >= 50 ? 'var(--warning)' : 'var(--muted)';

    // Enable/disable trade button
    const tradeBtn = document.getElementById('tdStartTradeBtn');
    if (etf.status === 'READY') {
        tradeBtn.disabled = false;
        tradeBtn.textContent = ' Start This Trade';
        tradeBtn.style.opacity = '1';
    } else if (etf.status === 'ACTIVE') {
        tradeBtn.disabled = false;
        tradeBtn.textContent = ' Close Position';
        tradeBtn.style.background = 'var(--danger)';
        tradeBtn.style.opacity = '1';
    } else {
        tradeBtn.disabled = true;
        tradeBtn.textContent = `Wait ${etf.daysUntilWindow || 0} Days`;
        tradeBtn.style.opacity = '0.5';
    }

    modal.style.display = 'flex';
}

function closeTradeDetailModal() {
    const modal = document.getElementById('tradeDetailModal');
    if (modal) modal.style.display = 'none';
    currentDetailETF = null;
}

// Start a new trade
function startTrade() {
    if (!currentDetailETF) return;

    if (currentDetailETF.status === 'ACTIVE') {
        // Close position flow
        closeTradeDetailModal();
        // Could trigger exit modal here
        return;
    }

    if (currentDetailETF.status !== 'READY') {
        alert('This trade is not ready yet. Wait for the entry window.');
        return;
    }

    // Check position limits
    const openPositions = JSON.parse(localStorage.getItem('openPositions') || '[]');
    const activeCount = openPositions.filter(p => p.status === 'active').length;

    if (activeCount >= positionLimits.maxPositions) {
        alert(`Position limit reached! You have ${activeCount}/${positionLimits.maxPositions} positions. Close one first.`);
        return;
    }

    // Create new position
    const priceData = window.symbolData?.[currentDetailETF.symbol];
    const currentPrice = priceData?.price || 100;
    const strikePrice = Math.round(currentPrice / 5) * 5;
    const optionCost = currentPrice * 0.02;

    const expiry = new Date();
    expiry.setDate(expiry.getDate() + 21);

    const newPosition = {
        id: Date.now(),
        symbol: currentDetailETF.symbol,
        type: currentDetailETF.direction,
        entryDate: new Date().toISOString(),
        entryPrice: optionCost,
        currentPrice: optionCost,
        strike: strikePrice,
        expiry: expiry.toISOString(),
        contracts: 1,
        status: 'active',
        stopLoss: optionCost * 0.5,
        profitTarget: optionCost * 1.5
    };

    openPositions.push(newPosition);
    localStorage.setItem('openPositions', JSON.stringify(openPositions));

    // Refresh displays
    closeTradeDetailModal();
    initMonthlyTradingDashboard();

    // Show confirmation
    alert(`Trade started: ${currentDetailETF.symbol} ${currentDetailETF.direction} @ $${optionCost.toFixed(2)}`);
}

// Add to watchlist
function addToWatchlist() {
    if (!currentDetailETF) return;

    const watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
    if (!watchlist.includes(currentDetailETF.symbol)) {
        watchlist.push(currentDetailETF.symbol);
        localStorage.setItem('watchlist', JSON.stringify(watchlist));
        alert(`${currentDetailETF.symbol} added to watchlist!`);
    } else {
        alert(`${currentDetailETF.symbol} is already on your watchlist.`);
    }
}

// Initialize the Monthly Trading Dashboard
function initMonthlyTradingDashboard() {
    // Clear score cache to ensure fresh calculations
    if (typeof gannScoreCache !== 'undefined') {
        gannScoreCache = {};
    }

    populateOpportunitiesTable();
    populateSectorRotation();
    generateMultiETFCalendar();

    // Update month/year display
    const now = new Date();
    const mtMonthYear = document.getElementById('mtMonthYear');
    if (mtMonthYear) {
        mtMonthYear.textContent = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    }
}

// Helper function to select ETF from table and show unified score
function selectETFAndShowScore(symbol) {
    // Clear score cache
    if (typeof gannScoreCache !== 'undefined') {
        gannScoreCache = {};
        gannScoreCacheTime = 0;
    }

    // Update the dropdown to the selected symbol
    const select = document.getElementById('symbolSelect');
    if (select) {
        select.value = symbol;
        changeSymbol(); // This will update everything including scores
    }

    // Also load the symbol data
    if (typeof loadSymbolData === 'function') {
        loadSymbolData(symbol);
    }

    // Scroll to Trade Quality Score section if on Gann tab
    const scoreCard = document.getElementById('gannOverallScore');
    if (scoreCard) {
        scoreCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    console.log(` Selected ${symbol} - Score: ${calculateGannScore(symbol).score}/100`);
}

// ===============================================
// GANN'S 28 TRADING LAWS - RULE CHECKING SYSTEM
// ===============================================

// All 28 Gann Rules with categories
const GANN_RULES = [
    { num: 1, text: "Divide your capital into 10 equal parts and never risk more than 1/10 on any single trade", category: "risk", checkable: true },
    { num: 2, text: "Always use stop loss orders to protect your trade", category: "risk", checkable: true },
    { num: 3, text: "Never overtrade - this violates your capital rules", category: "profit", checkable: true },
    { num: 4, text: "Never let a profit run into a loss - trail your stops as profit increases", category: "trend", checkable: true },
    { num: 5, text: "Do not buck the trend - never buy or sell if you are not sure of the trend", category: "trend", checkable: true },
    { num: 6, text: "When in doubt, get out and don't get in when in doubt", category: "discipline", checkable: false },
    { num: 7, text: "Trade only in active markets and avoid slow, dead ones", category: "trend", checkable: true },
    { num: 8, text: "Never limit orders - trade at the market", category: "risk", checkable: false },
    { num: 9, text: "Don't close trades without a good reason - follow up with a stop loss", category: "trend", checkable: false },
    { num: 10, text: "Never average a losing position - this is one of the worst mistakes", category: "risk", checkable: true },
    { num: 11, text: "Never get out of the market just because you have lost patience", category: "discipline", checkable: false },
    { num: 12, text: "Avoid taking small profits and big losses", category: "discipline", checkable: true },
    { num: 13, text: "Never cancel a stop loss order after you have placed it", category: "record", checkable: false },
    { num: 14, text: "Avoid getting in and out of the market too often", category: "record", checkable: true },
    { num: 15, text: "Be willing to make money from both sides of the market", category: "risk", checkable: true },
    { num: 16, text: "Never buy or sell just because the price is low or high", category: "discipline", checkable: false },
    { num: 17, text: "Don't trade to get even or recoup a loss", category: "discipline", checkable: true },
    { num: 18, text: "Never change your position without a good reason", category: "profit", checkable: false },
    { num: 19, text: "Avoid increasing your trading after a long period of success", category: "discipline", checkable: true },
    { num: 20, text: "Don't guess when the market will top or bottom", category: "risk", checkable: false },
    { num: 21, text: "Don't follow a blind man's advice - do your own research", category: "risk", checkable: false },
    { num: 22, text: "Reduce trading after first loss - never increase", category: "risk", checkable: true },
    { num: 23, text: "Avoid getting in wrong and out wrong - or right and out wrong", category: "discipline", checkable: false },
    { num: 24, text: "After a successful trade, take some profits", category: "profit", checkable: true },
    { num: 25, text: "Don't buy just to get a dividend", category: "discipline", checkable: false },
    { num: 26, text: "Don't average up on a declining balance", category: "trend", checkable: true },
    { num: 27, text: "Keep a record of your trades to review mistakes and successes", category: "record", checkable: true },
    { num: 28, text: "Avoid making too many trades in a short period", category: "risk", checkable: true }
];

// Category colors and labels
const GANN_CATEGORIES = {
    risk: { label: "Risk Management", emoji: "", color: "var(--danger)" },
    trend: { label: "Trend & Timing", emoji: "", color: "var(--success)" },
    discipline: { label: "Discipline", emoji: "", color: "var(--primary)" },
    profit: { label: "Profit Protection", emoji: "", color: "var(--warning)" },
    record: { label: "Record Keeping", emoji: "", color: "var(--muted)" }
};

// Load capital settings from localStorage
function loadCapitalSettings() {
    const settings = JSON.parse(localStorage.getItem('gannCapitalSettings') || '{}');

    const capitalInput = document.getElementById('gannCapital');
    const maxRiskInput = document.getElementById('gannMaxRisk');
    const maxTradesInput = document.getElementById('gannMaxTrades');
    const maxMarketsInput = document.getElementById('gannMaxMarkets');

    if (capitalInput) capitalInput.value = settings.capital || 10000;
    if (maxRiskInput) maxRiskInput.value = settings.maxRisk || 10;
    if (maxTradesInput) maxTradesInput.value = settings.maxTrades || 5;
    if (maxMarketsInput) maxMarketsInput.value = settings.maxMarkets || 5;

    updateCapitalDisplay();
}

// Save capital settings to localStorage
function saveCapitalSettings() {
    const settings = {
        capital: parseFloat(document.getElementById('gannCapital')?.value) || 10000,
        maxRisk: parseFloat(document.getElementById('gannMaxRisk')?.value) || 10,
        maxTrades: parseInt(document.getElementById('gannMaxTrades')?.value) || 5,
        maxMarkets: parseInt(document.getElementById('gannMaxMarkets')?.value) || 5
    };

    localStorage.setItem('gannCapitalSettings', JSON.stringify(settings));
    updateCapitalDisplay();
    checkPreTradeRules();
    console.log('[Gann Rules] Settings saved:', settings);
}

// Update the capital display calculations
function updateCapitalDisplay() {
    const capital = parseFloat(document.getElementById('gannCapital')?.value) || 10000;
    const maxRisk = parseFloat(document.getElementById('gannMaxRisk')?.value) || 10;
    const maxTrades = parseInt(document.getElementById('gannMaxTrades')?.value) || 5;

    const maxPerTrade = capital * (maxRisk / 100);
    const maxExposure = maxPerTrade * maxTrades;
    const exposurePct = Math.round((maxExposure / capital) * 100);

    const maxPerTradeEl = document.getElementById('gannMaxPerTrade');
    const maxExposureEl = document.getElementById('gannMaxExposure');

    if (maxPerTradeEl) maxPerTradeEl.textContent = '$' + maxPerTrade.toLocaleString();
    if (maxExposureEl) maxExposureEl.textContent = '$' + maxExposure.toLocaleString() + ' (' + exposurePct + '%)';
}

// Get trade history from localStorage
function getTradeHistory() {
    return JSON.parse(localStorage.getItem('tradeHistory') || '[]');
}

// Get loss tracking data
function getLossTracking() {
    return JSON.parse(localStorage.getItem('gannLossTracking') || '{"consecutiveLosses": 0, "lastResult": null}');
}

// Update loss tracking
function updateLossTracking(result) {
    let tracking = getLossTracking();

    if (result === 'loss') {
        tracking.consecutiveLosses++;
        tracking.lastResult = 'loss';
    } else if (result === 'win') {
        tracking.consecutiveLosses = 0;
        tracking.lastResult = 'win';
    }

    localStorage.setItem('gannLossTracking', JSON.stringify(tracking));
    return tracking;
}

// Check all 28 Gann rules and return status for each
function checkAllGannRules() {
    const results = [];
    const openPositions = JSON.parse(localStorage.getItem('openPositions') || '[]');
    const activeCount = openPositions.filter(p => p.status === 'active').length;
    const settings = JSON.parse(localStorage.getItem('gannCapitalSettings') || '{}');
    const capital = settings.capital || 10000;
    const maxRisk = settings.maxRisk || 10;
    const maxTrades = settings.maxTrades || 5;
    const maxMarkets = settings.maxMarkets || 5;
    const lossTracking = getLossTracking();
    const tradeHistory = getTradeHistory();

    // Get current symbol data
    const symbol = currentSymbol || 'SPY';
    let scoreData = { score: 50 };
    if (typeof calculateGannScore === 'function') {
        scoreData = calculateGannScore(symbol);
    }

    // Count unique markets
    const uniqueMarkets = new Set(openPositions.filter(p => p.status === 'active').map(p => p.symbol));

    // Count recent trades (last 7 days)
    const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
    const recentTrades = tradeHistory.filter(t => t.timestamp > weekAgo).length;

    GANN_RULES.forEach(rule => {
        let status = 'pass'; // Default to pass for non-checkable rules
        let details = '';

        if (rule.checkable) {
            switch(rule.num) {
                case 1: // Position size
                    const maxPosition = capital * (maxRisk / 100);
                    status = 'pass'; // Assume pass - actual check on trade entry
                    details = 'Max position: $' + maxPosition.toLocaleString();
                    break;

                case 3: // Overtrade check
                    status = activeCount <= maxTrades ? 'pass' : 'fail';
                    details = activeCount + '/' + maxTrades + ' positions';
                    break;

                case 4: // Profit protection (check if any position is in profit without trailing stop)
                    const profitableWithoutStop = openPositions.filter(p =>
                        p.status === 'active' && p.currentPnLPct > 30 && !p.trailingStop
                    );
                    status = profitableWithoutStop.length === 0 ? 'pass' : 'warn';
                    details = profitableWithoutStop.length > 0 ? 'Move stops on winners!' : 'Stops trailed';
                    break;

                case 5: // Trading with trend
                    status = scoreData.score >= 50 ? 'pass' : 'warn';
                    details = 'Score: ' + scoreData.score + '/100';
                    break;

                case 7: // Active market check
                    status = scoreData.score >= 60 ? 'pass' : 'warn';
                    details = scoreData.score >= 60 ? 'Market active' : 'Low activity';
                    break;

                case 10: // Never average down
                    const avgDownPositions = openPositions.filter(p =>
                        p.status === 'active' && p.currentPnLPct < 0 && p.addedToPosition
                    );
                    status = avgDownPositions.length === 0 ? 'pass' : 'fail';
                    details = avgDownPositions.length > 0 ? 'Averaging down detected!' : 'Clean';
                    break;

                case 12: // Avoid small profits, big losses
                    const wins = tradeHistory.filter(t => t.pnlPct > 0);
                    const losses = tradeHistory.filter(t => t.pnlPct < 0);
                    const avgWin = wins.length ? wins.reduce((a,b) => a + b.pnlPct, 0) / wins.length : 50;
                    const avgLoss = losses.length ? Math.abs(losses.reduce((a,b) => a + b.pnlPct, 0) / losses.length) : 50;
                    status = avgWin >= avgLoss ? 'pass' : 'warn';
                    details = 'Avg Win: ' + avgWin.toFixed(0) + '% / Avg Loss: ' + avgLoss.toFixed(0) + '%';
                    break;

                case 14: // Avoid overtrading
                    status = recentTrades <= 10 ? 'pass' : 'warn';
                    details = recentTrades + ' trades this week';
                    break;

                case 15: // Both sides of market
                    status = 'pass'; // Our system supports both CALL and PUT
                    details = 'CALL/PUT available';
                    break;

                case 17: // Don't trade to recover
                    status = lossTracking.consecutiveLosses < 2 ? 'pass' : 'warn';
                    details = lossTracking.consecutiveLosses + ' consecutive losses';
                    break;

                case 19: // Don't increase after success
                    status = 'pass'; // Manual check
                    details = 'Manual verification';
                    break;

                case 22: // Max markets
                    status = uniqueMarkets.size <= maxMarkets ? 'pass' : 'fail';
                    details = uniqueMarkets.size + '/' + maxMarkets + ' markets';
                    break;

                case 24: // Take profits
                    const bigWinners = openPositions.filter(p =>
                        p.status === 'active' && p.currentPnLPct > 50
                    );
                    status = bigWinners.length === 0 ? 'pass' : 'warn';
                    details = bigWinners.length > 0 ? 'Take some profits!' : 'No action needed';
                    break;

                case 26: // Don't average up on declining balance
                    status = 'pass';
                    details = 'Manual check';
                    break;

                case 27: // Keep records
                    status = tradeHistory.length > 0 ? 'pass' : 'warn';
                    details = tradeHistory.length + ' trades recorded';
                    break;

                case 28: // Too many trades
                    status = recentTrades <= 15 ? 'pass' : 'fail';
                    details = recentTrades + ' trades in 7 days';
                    break;

                default:
                    status = 'pass';
                    details = 'OK';
            }
        } else {
            details = 'Manual verification';
        }

        results.push({
            ...rule,
            status: status,
            details: details
        });
    });

    return results;
}

// Check pre-trade rules
function checkPreTradeRules() {
    const results = {};
    const openPositions = JSON.parse(localStorage.getItem('openPositions') || '[]');
    const activePositions = openPositions.filter(p => p.status === 'active');
    const settings = JSON.parse(localStorage.getItem('gannCapitalSettings') || '{}');
    const capital = settings.capital || 10000;
    const maxRisk = settings.maxRisk || 10;
    const maxTrades = settings.maxTrades || 5;
    const maxMarkets = settings.maxMarkets || 5;
    const lossTracking = getLossTracking();

    // Get current symbol score and data
    const symbol = currentSymbol || 'SPY';
    let scoreData = { score: 50, bias: 'HOLD' };
    let confluence = 0;

    if (typeof calculateGannScore === 'function') {
        scoreData = calculateGannScore(symbol);
    }

    // Get confluence from current data
    if (typeof currentData !== 'undefined' && currentData && currentData.length > 0) {
        const latestBar = currentData[currentData.length - 1];
        confluence = parseInt(latestBar.PriceConfluence) || parseInt(latestBar.priceConfluence) || 0;
    }

    const maxPosition = capital * (maxRisk / 100);
    const uniqueMarkets = new Set(activePositions.map(p => p.symbol));

    // Rule 1: Position Size
    results.rule1 = {
        pass: true, // Will check at trade time
        details: {
            positionSize: maxPosition,
            capital: capital
        }
    };

    // Rule 2: Stop Loss Defined
    results.rule2 = {
        pass: true, // Our system always defines stops
        details: {}
    };

    // Rule 4: Trend Clear (confluence >= 3 or <= -3)
    results.rule4 = {
        pass: Math.abs(confluence) >= 3,
        details: { confluence: confluence }
    };

    // Rule 5: Trading with trend
    const isBullish = confluence > 0;
    const bias = scoreData.bias || 'HOLD';
    const trendMatch = (isBullish && bias === 'CALL') || (!isBullish && bias === 'PUT') || bias === 'HOLD';
    results.rule5 = {
        pass: trendMatch || Math.abs(confluence) < 3,
        details: {
            direction: bias === 'CALL' ? 'CALL in uptrend' : bias === 'PUT' ? 'PUT in downtrend' : 'Neutral'
        }
    };

    // Rule 7: Clear opportunity
    results.rule7 = {
        pass: scoreData.score >= 70,
        details: { score: scoreData.score }
    };

    // Rule 8: Less than max trades
    results.rule8 = {
        pass: activePositions.length < maxTrades,
        details: {
            openCount: activePositions.length,
            maxTrades: maxTrades
        }
    };

    // Rule 22: Less than max markets
    results.rule22 = {
        pass: uniqueMarkets.size < maxMarkets,
        details: {
            marketCount: uniqueMarkets.size,
            maxMarkets: maxMarkets
        }
    };

    // Update display
    updatePreTradeDisplay(results);

    return results;
}

// Update pre-trade checklist display
function updatePreTradeDisplay(results) {
    // Rule 1
    const rule1El = document.getElementById('preTradeRule1');
    if (rule1El) {
        const icon = rule1El.querySelector('span:first-child');
        const statusSpan = rule1El.querySelector('span:last-child');
        const posSize = document.getElementById('preTradePositionSize');
        const cap = document.getElementById('preTradeCapital');

        if (icon) icon.textContent = results.rule1.pass ? '' : '';
        if (statusSpan) {
            statusSpan.textContent = results.rule1.pass ? 'PASS' : 'FAIL';
            statusSpan.style.color = results.rule1.pass ? 'var(--success)' : 'var(--danger)';
        }
        if (posSize) posSize.textContent = '$' + results.rule1.details.positionSize.toLocaleString();
        if (cap) cap.textContent = '$' + results.rule1.details.capital.toLocaleString();
        rule1El.style.borderLeftColor = results.rule1.pass ? 'var(--success)' : 'var(--danger)';
    }

    // Rule 4
    const rule4El = document.getElementById('preTradeRule4');
    if (rule4El) {
        const icon = rule4El.querySelector('span:first-child');
        const confEl = document.getElementById('preTradeConfluence');
        const statusEl = document.getElementById('preTradeRule4Status');

        if (icon) icon.textContent = results.rule4.pass ? '' : '';
        if (confEl) confEl.textContent = (results.rule4.details.confluence > 0 ? '+' : '') + results.rule4.details.confluence;
        if (statusEl) {
            statusEl.textContent = results.rule4.pass ? 'PASS' : 'WEAK';
            statusEl.style.color = results.rule4.pass ? 'var(--success)' : 'var(--warning)';
        }
        rule4El.style.borderLeftColor = results.rule4.pass ? 'var(--success)' : 'var(--warning)';
    }

    // Rule 5
    const rule5El = document.getElementById('preTradeRule5');
    if (rule5El) {
        const icon = rule5El.querySelector('span:first-child');
        const dirEl = document.getElementById('preTradeTrendDir');
        const statusEl = document.getElementById('preTradeRule5Status');

        if (icon) icon.textContent = results.rule5.pass ? '' : '';
        if (dirEl) dirEl.textContent = results.rule5.details.direction;
        if (statusEl) {
            statusEl.textContent = results.rule5.pass ? 'PASS' : 'WARN';
            statusEl.style.color = results.rule5.pass ? 'var(--success)' : 'var(--warning)';
        }
        rule5El.style.borderLeftColor = results.rule5.pass ? 'var(--success)' : 'var(--warning)';
    }

    // Rule 7
    const rule7El = document.getElementById('preTradeRule7');
    if (rule7El) {
        const icon = rule7El.querySelector('span:first-child');
        const scoreEl = document.getElementById('preTradeScore');
        const statusEl = document.getElementById('preTradeRule7Status');

        if (icon) icon.textContent = results.rule7.pass ? '' : '';
        if (scoreEl) scoreEl.textContent = results.rule7.details.score;
        if (statusEl) {
            statusEl.textContent = results.rule7.pass ? 'PASS' : 'FAIL';
            statusEl.style.color = results.rule7.pass ? 'var(--success)' : 'var(--danger)';
        }
        rule7El.style.borderLeftColor = results.rule7.pass ? 'var(--success)' : 'var(--danger)';
    }

    // Rule 8
    const rule8El = document.getElementById('preTradeRule8');
    if (rule8El) {
        const icon = rule8El.querySelector('span:first-child');
        const countEl = document.getElementById('preTradeOpenCount');
        const maxEl = document.getElementById('preTradeMaxTrades');
        const statusEl = document.getElementById('preTradeRule8Status');

        if (icon) icon.textContent = results.rule8.pass ? '' : '';
        if (countEl) countEl.textContent = results.rule8.details.openCount;
        if (maxEl) maxEl.textContent = results.rule8.details.maxTrades;
        if (statusEl) {
            statusEl.textContent = results.rule8.pass ? 'PASS' : 'FAIL';
            statusEl.style.color = results.rule8.pass ? 'var(--success)' : 'var(--danger)';
        }
        rule8El.style.borderLeftColor = results.rule8.pass ? 'var(--success)' : 'var(--danger)';
    }

    // Rule 22
    const rule22El = document.getElementById('preTradeRule22');
    if (rule22El) {
        const icon = rule22El.querySelector('span:first-child');
        const countEl = document.getElementById('preTradeMarketCount');
        const maxEl = document.getElementById('preTradeMaxMarkets');
        const statusEl = document.getElementById('preTradeRule22Status');

        if (icon) icon.textContent = results.rule22.pass ? '' : '';
        if (countEl) countEl.textContent = results.rule22.details.marketCount;
        if (maxEl) maxEl.textContent = results.rule22.details.maxMarkets;
        if (statusEl) {
            statusEl.textContent = results.rule22.pass ? 'PASS' : 'FAIL';
            statusEl.style.color = results.rule22.pass ? 'var(--success)' : 'var(--danger)';
        }
        rule22El.style.borderLeftColor = results.rule22.pass ? 'var(--success)' : 'var(--danger)';
    }

    // Overall verdict
    const passCount = Object.values(results).filter(r => r.pass).length;
    const totalRules = Object.keys(results).length;
    const verdictEl = document.getElementById('preTradeVerdict');

    if (verdictEl) {
        if (passCount === totalRules) {
            verdictEl.style.background = 'rgba(16,185,129,0.15)';
            verdictEl.innerHTML = '<div style="font-size: 18px; font-weight: 700; color: var(--success);"> CLEARED TO TRADE</div><div style="font-size: 12px; color: var(--muted); margin-top: 5px;">' + passCount + '/' + totalRules + ' Pre-Trade Rules Passed</div>';
        } else if (passCount >= totalRules - 2) {
            verdictEl.style.background = 'rgba(245,158,11,0.15)';
            verdictEl.innerHTML = '<div style="font-size: 18px; font-weight: 700; color: var(--warning);"> CAUTION - PROCEED CAREFULLY</div><div style="font-size: 12px; color: var(--muted); margin-top: 5px;">' + passCount + '/' + totalRules + ' Pre-Trade Rules Passed</div>';
        } else {
            verdictEl.style.background = 'rgba(239,68,68,0.15)';
            verdictEl.innerHTML = '<div style="font-size: 18px; font-weight: 700; color: var(--danger);"> BLOCKED - DO NOT TRADE</div><div style="font-size: 12px; color: var(--muted); margin-top: 5px;">' + passCount + '/' + totalRules + ' Pre-Trade Rules Passed</div>';
        }
    }
}

// Check rules for active positions
function checkActiveTradeRules(position) {
    const alerts = [];

    if (!position) return alerts;

    const pnlPct = position.currentPnLPct || 0;

    // Rule 3/24: Profit > 30% -> Move stop to breakeven
    if (pnlPct > 30) {
        alerts.push({
            rule: 3,
            type: 'profit',
            message: 'Profit > 30% - Move stop to breakeven!',
            severity: 'warning'
        });
    }

    // Rule 18: Target 1 hit
    if (pnlPct > 50) {
        alerts.push({
            rule: 18,
            type: 'profit',
            message: 'Target 1 hit - Take partial profits!',
            severity: 'success'
        });
    }

    // Rule 10: Adding to loser warning
    if (pnlPct < -20 && position.addedToPosition) {
        alerts.push({
            rule: 10,
            type: 'danger',
            message: 'WARNING: Do not average down on losing position!',
            severity: 'danger'
        });
    }

    return alerts;
}

// Update loss recovery guard display
function updateLossRecoveryGuard() {
    const tracking = getLossTracking();
    const lastResultEl = document.getElementById('lastTradeResult');
    const consecutiveEl = document.getElementById('consecutiveLosses');
    const suggestedEl = document.getElementById('suggestedPositionSize');
    const warningEl = document.getElementById('lossWarning');
    const coolingEl = document.getElementById('coolingOffPeriod');

    // Last trade result
    if (lastResultEl) {
        if (tracking.lastResult === 'win') {
            lastResultEl.textContent = ' WIN';
            lastResultEl.style.color = 'var(--success)';
        } else if (tracking.lastResult === 'loss') {
            lastResultEl.textContent = ' LOSS';
            lastResultEl.style.color = 'var(--danger)';
        } else {
            lastResultEl.textContent = '-- N/A --';
            lastResultEl.style.color = 'var(--muted)';
        }
    }

    // Consecutive losses
    if (consecutiveEl) {
        consecutiveEl.textContent = tracking.consecutiveLosses;
        consecutiveEl.style.color = tracking.consecutiveLosses >= 2 ? 'var(--danger)' : 'var(--text)';
    }

    // Suggested position size based on losses
    let suggestedPct = 100;
    if (tracking.consecutiveLosses === 1) suggestedPct = 75;
    else if (tracking.consecutiveLosses === 2) suggestedPct = 50;
    else if (tracking.consecutiveLosses >= 3) suggestedPct = 25;

    if (suggestedEl) {
        suggestedEl.textContent = suggestedPct + '%';
        suggestedEl.style.color = suggestedPct === 100 ? 'var(--success)' : suggestedPct >= 50 ? 'var(--warning)' : 'var(--danger)';
    }

    // Show/hide warnings
    if (warningEl) {
        warningEl.style.display = tracking.consecutiveLosses >= 2 ? 'block' : 'none';
    }

    if (coolingEl) {
        coolingEl.style.display = tracking.consecutiveLosses >= 3 ? 'block' : 'none';
    }
}

// Update active trade monitor
function updateActiveTradeMonitor() {
    const container = document.getElementById('activeTradesContainer');
    const noTradesMsg = document.getElementById('noActiveTradesMsg');

    if (!container) return;

    const openPositions = JSON.parse(localStorage.getItem('openPositions') || '[]');
    const activePositions = openPositions.filter(p => p.status === 'active');

    if (activePositions.length === 0) {
        if (noTradesMsg) noTradesMsg.style.display = 'block';
        container.style.display = 'none';
        return;
    }

    if (noTradesMsg) noTradesMsg.style.display = 'none';
    container.style.display = 'block';

    let html = '';
    activePositions.forEach(position => {
        const alerts = checkActiveTradeRules(position);
        const pnlPct = position.currentPnLPct || 0;
        const pnlColor = pnlPct >= 0 ? 'var(--success)' : 'var(--danger)';

        html += '<div style="padding: 15px; background: var(--bg); border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ' + pnlColor + ';">';
        html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
        html += '<div style="font-weight: 700; font-size: 16px;">' + position.symbol + ' ' + (position.direction || 'CALL') + '</div>';
        html += '<div style="font-size: 18px; font-weight: 700; color: ' + pnlColor + ';">' + (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(1) + '%</div>';
        html += '</div>';

        if (alerts.length > 0) {
            html += '<div style="margin-top: 10px;">';
            alerts.forEach(alert => {
                const alertColor = alert.severity === 'danger' ? 'var(--danger)' : alert.severity === 'warning' ? 'var(--warning)' : 'var(--success)';
                html += '<div style="padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 4px; margin-bottom: 5px; border-left: 3px solid ' + alertColor + ';">';
                html += '<span style="font-weight: 600; color: ' + alertColor + ';">Rule ' + alert.rule + ':</span> ' + alert.message;
                html += '</div>';
            });
            html += '</div>';
        }

        html += '</div>';
    });

    container.innerHTML = html;
}

// Populate the 28 rules table
function populateGannRulesTable(filter = 'all') {
    const tbody = document.getElementById('gannRulesTableBody');
    if (!tbody) return;

    const ruleResults = checkAllGannRules();

    let html = '';
    ruleResults.forEach(rule => {
        if (filter !== 'all' && rule.category !== filter) return;

        const cat = GANN_CATEGORIES[rule.category];
        const statusIcon = rule.status === 'pass' ? '' : rule.status === 'warn' ? '' : '';
        const statusColor = rule.status === 'pass' ? 'var(--success)' : rule.status === 'warn' ? 'var(--warning)' : 'var(--danger)';

        html += '<tr data-category="' + rule.category + '">';
        html += '<td style="font-weight: 700; color: var(--primary);">' + rule.num + '</td>';
        html += '<td>';
        html += '<div style="font-size: 13px;">' + rule.text + '</div>';
        if (rule.details && rule.checkable) {
            html += '<div style="font-size: 11px; color: var(--muted); margin-top: 3px;">' + rule.details + '</div>';
        }
        html += '</td>';
        html += '<td><span style="display: inline-flex; align-items: center; gap: 5px; padding: 4px 8px; background: var(--bg); border-radius: 4px; font-size: 11px;">' + cat.emoji + ' ' + cat.label + '</span></td>';
        html += '<td style="text-align: center;">';
        if (rule.checkable) {
            html += '<span style="font-size: 18px;">' + statusIcon + '</span>';
        } else {
            html += '<span style="color: var(--muted); font-size: 11px;">Manual</span>';
        }
        html += '</td>';
        html += '</tr>';
    });

    tbody.innerHTML = html;

    // Update overall status
    const passCount = ruleResults.filter(r => r.status === 'pass').length;
    const totalCheckable = ruleResults.filter(r => r.checkable).length;

    const passCountEl = document.getElementById('gannRulesPassCount');
    const statusEl = document.getElementById('gannRulesOverallStatus');

    if (passCountEl) {
        passCountEl.textContent = passCount + '/' + totalCheckable;
    }

    if (statusEl) {
        const icon = statusEl.querySelector('span:first-child');
        if (icon) {
            if (passCount >= totalCheckable - 2) {
                icon.textContent = '';
            } else if (passCount >= totalCheckable / 2) {
                icon.textContent = '';
            } else {
                icon.textContent = '';
            }
        }
    }
}

// Filter rules by category
function filterGannRules(category) {
    // Update button states
    document.querySelectorAll('.gann-filter-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'var(--bg)';
        btn.style.color = 'var(--text)';
    });

    event.target.classList.add('active');
    event.target.style.background = 'var(--primary)';
    event.target.style.color = 'white';

    populateGannRulesTable(category);
}

// Update monthly review section
function updateMonthlyReview() {
    const tradeHistory = getTradeHistory();
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

    // Filter this month's trades
    const monthTrades = tradeHistory.filter(t => new Date(t.timestamp) >= monthStart);

    const wins = monthTrades.filter(t => t.pnlPct > 0);
    const losses = monthTrades.filter(t => t.pnlPct < 0);
    const totalPnL = monthTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
    const winRate = monthTrades.length > 0 ? (wins.length / monthTrades.length * 100).toFixed(0) : '--';

    // Update display
    const tradeCountEl = document.getElementById('monthlyTradeCount');
    const winRateEl = document.getElementById('monthlyWinRate');
    const pnlEl = document.getElementById('monthlyPnL');
    const violationsEl = document.getElementById('monthlyViolations');

    if (tradeCountEl) tradeCountEl.textContent = monthTrades.length;
    if (winRateEl) {
        winRateEl.textContent = winRate + '%';
        winRateEl.style.color = parseInt(winRate) >= 50 ? 'var(--success)' : 'var(--danger)';
    }
    if (pnlEl) {
        pnlEl.textContent = (totalPnL >= 0 ? '+' : '') + '$' + totalPnL.toFixed(0);
        pnlEl.style.color = totalPnL >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    // Get rule violations from localStorage
    const violations = JSON.parse(localStorage.getItem('gannRuleViolations') || '{}');
    const violationCount = Object.values(violations).reduce((sum, count) => sum + count, 0);
    if (violationsEl) {
        violationsEl.textContent = violationCount;
        violationsEl.style.color = violationCount === 0 ? 'var(--success)' : 'var(--danger)';
    }

    // Most violated rules
    const violatedEl = document.getElementById('mostViolatedRules');
    if (violatedEl) {
        const sortedViolations = Object.entries(violations).sort((a, b) => b[1] - a[1]).slice(0, 3);
        if (sortedViolations.length > 0) {
            violatedEl.innerHTML = sortedViolations.map(([ruleNum, count]) => {
                const rule = GANN_RULES.find(r => r.num === parseInt(ruleNum));
                return '<div style="margin-bottom: 5px;"> Rule ' + ruleNum + ': ' + (rule?.text?.substring(0, 50) || 'Unknown') + '... (' + count + 'x)</div>';
            }).join('');
        } else {
            violatedEl.innerHTML = 'No rule violations recorded yet. Great discipline!';
        }
    }
}

// Main update function for Gann Rules tab
function updateGannRulesTab() {
    console.log('[Gann Rules] Updating tab...');

    loadCapitalSettings();
    checkPreTradeRules();
    updateLossRecoveryGuard();
    updateActiveTradeMonitor();
    populateGannRulesTable();
    updateMonthlyReview();

    console.log('[Gann Rules] Tab update complete');
}



// Hook into tab activation
const origGannTabHandler2 = document.querySelector('[data-tab="gann-analysis"]')?.onclick;
document.querySelector('[data-tab="gann-analysis"]')?.addEventListener('click', () => {
    setTimeout(initMonthlyTradingDashboard, 350);
});

// Also initialize on page load if tab is active
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        if (document.getElementById('gann-analysis')?.classList.contains('active')) {
            initMonthlyTradingDashboard();
        }
    }, 1100);
});


</script>
</body>
</html>












