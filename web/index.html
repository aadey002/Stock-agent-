<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SPY Trading Dashboard – SMA & Confluence Agent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --bg-soft: #0b1220;
      --bg-softer: #111827;
      --border-subtle: #1f2937;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.14);
      --accent-warn: #f97316;
      --accent-error: #f43f5e;
      --accent-good: #22c55e;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --text-muted: #6b7280;
      --radius-xl: 18px;
      --radius-lg: 14px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.9);
      --shadow-card: 0 14px 35px rgba(15, 23, 42, 0.7);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px;
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      color: var(--text-main);
    }

    .page {
      max-width: 1200px;
      margin: 0 auto 80px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 24px;
      margin-bottom: 24px;
    }

    .title-block h1 {
      margin: 0 0 6px;
      font-size: 30px;
      letter-spacing: 0.04em;
    }

    .title-block p {
      margin: 0;
      font-size: 13px;
      color: var(--text-soft);
    }

    .tag-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 11px;
      border-radius: var(--radius-pill);
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .tag-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
    }

    .meta {
      text-align: right;
      font-size: 11px;
      color: var(--text-muted);
    }

    .meta a {
      color: var(--accent);
      text-decoration: none;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 18px;
      margin-bottom: 18px;
    }

    .card {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.96), #020617);
      border-radius: var(--radius-xl);
      padding: 16px 18px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: var(--shadow-card);
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 17px;
      letter-spacing: 0.02em;
    }

    .card h3 {
      margin: 0 0 6px;
      font-size: 15px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .card-subtitle {
      margin: 0 0 12px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 3px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.45);
      font-size: 11px;
      color: var(--text-soft);
    }

    .pill-strong {
      border-color: rgba(56, 189, 248, 0.5);
      color: var(--accent);
      background: linear-gradient(
        120deg,
        rgba(56, 189, 248, 0.13),
        rgba(15, 23, 42, 0.4)
      );
    }

    .pill-warn {
      border-color: rgba(249, 115, 22, 0.5);
      color: var(--accent-warn);
      background: rgba(249, 115, 22, 0.12);
    }

    .pill-error {
      border-color: rgba(244, 63, 94, 0.5);
      color: var(--accent-error);
      background: rgba(244, 63, 94, 0.12);
    }

    .pill-good {
      border-color: rgba(34, 197, 94, 0.5);
      color: var(--accent-good);
      background: rgba(22, 163, 74, 0.12);
    }

    .cards-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 18px;
    }

    .summary-card {
      background: radial-gradient(circle at top left, #111827 0, #020617 65%);
      border-radius: var(--radius-lg);
      padding: 10px 12px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .summary-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .summary-main {
      font-size: 18px;
      font-weight: 600;
    }

    .summary-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .summary-badge {
      font-size: 10px;
      color: var(--accent);
      background: rgba(56, 189, 248, 0.12);
      border-radius: var(--radius-pill);
      padding: 2px 8px;
      align-self: flex-start;
    }

    .layout-main {
      display: grid;
      grid-template-columns: minmax(0, 1.35fr) minmax(0, 1fr);
      gap: 18px;
      margin-bottom: 18px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .chart-header h2 {
      margin: 0;
      font-size: 15px;
    }

    .chart-meta {
      font-size: 11px;
      color: var(--text-soft);
    }

    .chart-container {
      background: radial-gradient(circle at top, #020617 0, #020617 70%, #000 100%);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 14px;
      min-height: 260px;
      position: relative;
      overflow: hidden;
    }

    canvas {
      width: 100%;
      height: 220px;
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      font-size: 11px;
      margin-bottom: 6px;
      color: var(--text-soft);
    }

    .controls label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .controls input {
      width: 44px;
      padding: 2px 4px;
      border-radius: 6px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 11px;
    }

    .btn {
      border-radius: var(--radius-pill);
      padding: 4px 10px;
      border: 1px solid rgba(56, 189, 248, 0.7);
      background: radial-gradient(circle at top left, #0f172a 0, #020617 65%);
      color: var(--accent);
      font-size: 11px;
      cursor: pointer;
    }

    .btn:hover {
      background: radial-gradient(circle at top left, #020617 0, #020617 65%);
    }

    .backtest-grid {
      display: grid;
      grid-template-columns: 140px minmax(0, 1fr);
      gap: 10px;
      font-size: 12px;
    }

    .backtest-grid table {
      width: 100%;
      border-collapse: collapse;
    }

    .backtest-grid th,
    .backtest-grid td {
      padding: 4px 0;
      font-size: 11px;
    }

    .backtest-grid th {
      text-align: right;
      color: var(--text-muted);
      font-weight: 400;
      padding-right: 8px;
      white-space: nowrap;
    }

    .backtest-grid td {
      color: var(--text-main);
    }

    .backtest-grid tr + tr td,
    .backtest-grid tr + tr th {
      border-top: 1px dashed rgba(31, 41, 55, 0.9);
    }

    .table-card {
      margin-top: 18px;
    }

    table.trade-log {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    table.trade-log th,
    table.trade-log td {
      padding: 6px 6px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
    }

    table.trade-log th {
      text-align: left;
      color: var(--text-muted);
      font-weight: 500;
      white-space: nowrap;
    }

    table.trade-log td.pnl-pos {
      color: var(--accent-good);
    }

    table.trade-log td.pnl-neg {
      color: var(--accent-error);
    }

    .disclaimer {
      margin-top: 14px;
      font-size: 10px;
      color: var(--text-muted);
    }

    /* Setup cards */

    .setup-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 0.95fr);
      gap: 12px;
      margin-bottom: 18px;
    }

    .setup-card {
      background: radial-gradient(circle at top left, #0b1120 0, #020617 70%);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 14px 16px 12px;
      box-shadow: var(--shadow-card);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .setup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
    }

    .setup-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .setup-body {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 14px;
      font-size: 11px;
    }

    .setup-row-label {
      color: var(--text-muted);
      font-size: 11px;
      margin-bottom: 2px;
    }

    .setup-row-main {
      font-size: 12px;
    }

    .setup-footer {
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-muted);
    }

    .status-label {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .status-active {
      border-color: rgba(34, 197, 94, 0.8);
      background: rgba(22, 163, 74, 0.13);
      color: var(--accent-good);
    }

    .status-waiting {
      border-color: rgba(56, 189, 248, 0.8);
      background: rgba(56, 189, 248, 0.12);
      color: var(--accent);
    }

    .status-exited {
      border-color: rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-soft);
    }

    @media (max-width: 900px) {
      body {
        padding: 14px;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .grid,
      .layout-main,
      .setup-grid,
      .cards-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title-block">
        <div class="tag-pill">
          <span class="tag-dot"></span>
          SPY CALLS & PUTS CONFLUENCE AGENT
        </div>
        <h1>SPY Trading Dashboard</h1>
        <p>Powered by Tiingo data • SMA & geometry/φ/time confluence research</p>
      </div>
      <div class="meta">
        <div>DATA FILES: <code>web/data/SPY.csv</code>, <code>SPY_confluence.csv</code>, <code>portfolio_confluence.csv</code></div>
        <div id="meta-date"></div>
      </div>
    </header>

    <!-- Setup cards -->
    <div class="setup-grid">
      <section class="setup-card" id="current-setup-card">
        <div class="setup-header">
          <div>
            <div class="setup-title">Current confluence setup</div>
            <div class="card-subtitle">
              Shows the most recent setup that is still live or awaiting entry, based on geometry × φ × time counts.
            </div>
          </div>
          <div id="current-setup-status" class="status-label status-exited">Loading…</div>
        </div>
        <div class="setup-body" id="current-setup-body">
          <!-- Filled by JS -->
        </div>
        <div class="setup-footer">
          For research only. Use as a structured prompt for your own option selection and risk decisions.
        </div>
      </section>

      <section class="setup-card" id="last-setup-card">
        <div class="setup-header">
          <div>
            <div class="setup-title">Most recent completed setup</div>
            <div class="card-subtitle">
              Shows the outcome of the last fully resolved confluence playbook for P&L calibration.
            </div>
          </div>
          <div id="last-setup-status" class="status-label status-exited">Loading…</div>
        </div>
        <div class="setup-body" id="last-setup-body">
          <!-- Filled by JS -->
        </div>
        <div class="setup-footer">
          Completed setups help calibrate expectations for similar future geometry/φ/time configurations.
        </div>
      </section>
    </div>

    <!-- Top summary -->
    <div class="cards-row">
      <div class="summary-card">
        <div class="summary-label">Latest bias (SMA strategy)</div>
        <div class="summary-main" id="latest-bias">—</div>
        <div class="summary-sub" id="latest-bias-detail">Waiting for data…</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Confluence trades</div>
        <div class="summary-main" id="confluence-trade-count">—</div>
        <div class="summary-sub" id="confluence-trade-pnl">Cumulative P&L: —</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Win / loss (confluence)</div>
        <div class="summary-main" id="confluence-winloss">—</div>
        <div class="summary-sub" id="confluence-winrate">Win rate: —</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Time horizon</div>
        <div class="summary-main"><span id="horizon-days">5</span> days</div>
        <div class="summary-sub">Playbook hold window per setup</div>
      </div>
    </div>

    <!-- Chart + backtest -->
    <div class="layout-main">
      <section class="card">
        <div class="chart-header">
          <div>
            <h2>Price chart (SPY closes)</h2>
            <div class="chart-meta" id="chart-meta">Last 60 trading days</div>
          </div>
        </div>
        <div class="controls">
          <label>Fast SMA <input type="number" id="fastSmaInput" value="5" min="2" max="60" /></label>
          <label>Slow SMA <input type="number" id="slowSmaInput" value="20" min="5" max="120" /></label>
          <label>Hold (days) <input type="number" id="holdDaysInput" value="5" min="1" max="15" /></label>
          <button class="btn" id="recalcBtn">Recalculate SMA strategy</button>
        </div>
        <div class="chart-container">
          <canvas id="priceChart"></canvas>
        </div>
        <div class="disclaimer">
          SMA strategy and confluence strategy are research tools on the underlying SPY. They do not choose strikes or expiries and are not trading advice.
        </div>
      </section>

      <section class="card">
        <h2>Backtest summary (SMA strategy)</h2>
        <p class="card-subtitle">
          Simple rule: Fast SMA crossing Slow SMA generates CALL / PUT, held for N days.
        </p>
        <div class="backtest-grid">
          <div>
            <table>
              <tr><th>Trades</th><td id="sma-trades">—</td></tr>
              <tr><th>Calls</th><td id="sma-calls">—</td></tr>
              <tr><th>Puts</th><td id="sma-puts">—</td></tr>
              <tr><th>Total P&amp;L</th><td id="sma-pnl">—</td></tr>
            </table>
          </div>
          <div>
            <table>
              <tr><th>Win rate</th><td id="sma-winrate">—</td></tr>
              <tr><th>Median P&amp;L</th><td id="sma-median">—</td></tr>
              <tr><th>Max drawdown</th><td id="sma-dd">—</td></tr>
            </table>
          </div>
        </div>
      </section>
    </div>

    <!-- Trade log -->
    <section class="card table-card">
      <h2>Confluence trade log (SPY underlying)</h2>
      <p class="card-subtitle">
        Generated from geometry × φ × Gann time windows. Uses fixed playbook: ATR-based entry band, 1.5 ATR guard rail, 2R/3R targets, and 5-day time stop.
      </p>
      <div style="overflow-x:auto;">
        <table class="trade-log" id="confluence-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Signal</th>
              <th>Entry zone</th>
              <th>Stop</th>
              <th>Target 1</th>
              <th>Target 2</th>
              <th>Exit date</th>
              <th>Exit price</th>
              <th>Status</th>
              <th>P&amp;L</th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows injected by JS -->
          </tbody>
        </table>
      </div>
      <div class="disclaimer">
        Underlying P&amp;L is for calibration only. Option structures (strikes, expiries, sizing) require separate judgment, risk controls, and suitability checks.
      </div>
    </section>
  </div>

  <script>
    // --- CSV helpers --------------------------------------------------------
    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (lines.length < 2) return [];
      const headers = lines[0].split(",").map((h) => h.trim());
      return lines.slice(1).map((line) => {
        const cols = line.split(",");
        const row = {};
        headers.forEach((h, i) => {
          row[h] = (cols[i] ?? "").trim();
        });
        return row;
      });
    }

    function toFloat(v) {
      const x = parseFloat(v);
      return isNaN(x) ? null : x;
    }

    function toDate(v) {
      return v ? new Date(v) : null;
    }

    // --- SMA strategy (unchanged logic, simplified) ------------------------
    function buildSmaSignals(prices, fastLen, slowLen, holdDays) {
      const closes = prices.map((p) => p.Close);
      const smaFast = smaSeries(closes, fastLen);
      const smaSlow = smaSeries(closes, slowLen);

      const trades = [];
      let lastSignal = null;

      for (let i = 1; i < prices.length; i++) {
        if (!isFinite(smaFast[i]) || !isFinite(smaSlow[i])) continue;

        const prevDiff = smaFast[i - 1] - smaSlow[i - 1];
        const diff = smaFast[i] - smaSlow[i];

        let signal = null;
        if (prevDiff <= 0 && diff > 0) signal = "CALL";
        else if (prevDiff >= 0 && diff < 0) signal = "PUT";

        if (signal && signal !== lastSignal) {
          const entryIdx = i;
          const exitIdx = Math.min(prices.length - 1, entryIdx + holdDays);
          const entry = prices[entryIdx];
          const exit = prices[exitIdx];
          const pnl =
            signal === "CALL"
              ? exit.Close - entry.Close
              : entry.Close - exit.Close;

          trades.push({
            signal,
            entryIdx,
            exitIdx,
            entry,
            exit,
            pnl
          });
          lastSignal = signal;
        }
      }

      return { trades, smaFast, smaSlow };
    }

    function smaSeries(values, length) {
      const out = new Array(values.length).fill(NaN);
      if (length <= 0) return out;
      let sum = 0;
      for (let i = 0; i < values.length; i++) {
        sum += values[i];
        if (i >= length) sum -= values[i - length];
        if (i >= length - 1) out[i] = sum / length;
      }
      return out;
    }

    function statsFromTrades(trades) {
      if (!trades.length) {
        return {
          count: 0,
          calls: 0,
          puts: 0,
          totalPnl: 0,
          wins: 0,
          losses: 0,
          winRate: 0,
          median: 0,
          maxDD: 0
        };
      }
      let calls = 0,
        puts = 0,
        totalPnl = 0,
        wins = 0,
        losses = 0;
      const pnls = [];
      let equity = 0;
      let peak = 0;
      let maxDD = 0;

      for (const t of trades) {
        if (t.signal === "CALL") calls++;
        else puts++;
        totalPnl += t.pnl;
        pnls.push(t.pnl);
        if (t.pnl > 0) wins++;
        else if (t.pnl < 0) losses++;

        equity += t.pnl;
        if (equity > peak) peak = equity;
        const dd = peak - equity;
        if (dd > maxDD) maxDD = dd;
      }

      pnls.sort((a, b) => a - b);
      const mid = Math.floor(pnls.length / 2);
      const median =
        pnls.length % 2 ? pnls[mid] : (pnls[mid - 1] + pnls[mid]) / 2;

      const winRate = (wins / trades.length) * 100;

      return {
        count: trades.length,
        calls,
        puts,
        totalPnl,
        wins,
        losses,
        winRate,
        median,
        maxDD
      };
    }

    // --- Chart (minimal, no external libs) ---------------------------------
    function drawPriceChart(canvas, prices) {
      if (!canvas || !prices.length) return;
      const ctx = canvas.getContext("2d");
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0, 0, w, h);

      const closes = prices.map((p) => p.Close);
      const minP = Math.min(...closes);
      const maxP = Math.max(...closes);
      const pad = (maxP - minP) * 0.1 || 1;

      const yMin = minP - pad;
      const yMax = maxP + pad;

      const toX = (i) =>
        ((i / Math.max(1, prices.length - 1)) * (w - 40)) + 20;
      const toY = (p) =>
        h - 20 - ((p - yMin) / (yMax - yMin)) * (h - 40);

      // grid
      ctx.strokeStyle = "rgba(55,65,81,0.7)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(30, 10);
      ctx.lineTo(30, h - 10);
      ctx.lineTo(w - 10, h - 10);
      ctx.stroke();

      // price line
      ctx.beginPath();
      ctx.strokeStyle = "#38bdf8";
      ctx.lineWidth = 1.4;
      prices.forEach((p, i) => {
        const x = toX(i);
        const y = toY(p.Close);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    // --- Confluence helpers -------------------------------------------------
    function parsePortfolioRows(rows) {
      return rows.map((r) => ({
        Symbol: r.Symbol,
        Signal: r.Signal,
        EntryDate: toDate(r.EntryDate),
        EntryPrice: toFloat(r.EntryPrice),
        ExitDate: toDate(r.ExitDate),
        ExitPrice: toFloat(r.ExitPrice),
        PNL: toFloat(r.PNL) ?? 0,
        EntryLow: toFloat(r.EntryLow),
        EntryHigh: toFloat(r.EntryHigh),
        Stop: toFloat(r.Stop),
        Target1: toFloat(r.Target1),
        Target2: toFloat(r.Target2),
        ExpiryDate: toDate(r.ExpiryDate),
        Status: r.Status || ""
      }));
    }

    function isActiveStatus(s) {
      return s === "ACTIVE" || s === "WAITING";
    }

    function isCompletedStatus(s) {
      return (
        s.startsWith("EXITED_") ||
        s === "EXPIRED_UNTRIGGERED" ||
        s === "EXITED_TIME"
      );
    }

    function formatPrice(p) {
      if (p == null || !isFinite(p)) return "—";
      return p.toFixed(2);
    }

    function formatDate(d) {
      if (!d) return "—";
      return d.toISOString().slice(0, 10);
    }

    // --- Render setup cards -------------------------------------------------
    function renderSetupCard(elBody, elStatus, trade, emptyText) {
      if (!trade) {
        elBody.innerHTML =
          '<div style="grid-column:1/-1;color:#9ca3af;font-size:11px;">' +
          emptyText +
          "</div>";
        elStatus.textContent = "No setup";
        elStatus.className = "status-label status-exited";
        return;
      }

      const side =
        trade.Signal === "CALL"
          ? '<span class="pill-good">CALL bias</span>'
          : '<span class="pill-error">PUT bias</span>';

      elBody.innerHTML = `
        <div>
          <div class="setup-row-label">Side</div>
          <div class="setup-row-main">${side}</div>
        </div>
        <div>
          <div class="setup-row-label">Entry zone (underlying)</div>
          <div class="setup-row-main">${formatPrice(
            trade.EntryLow
          )} – ${formatPrice(trade.EntryHigh)}</div>
        </div>
        <div>
          <div class="setup-row-label">Guard-rail stop</div>
          <div class="setup-row-main">${formatPrice(trade.Stop)}</div>
        </div>
        <div>
          <div class="setup-row-label">Targets</div>
          <div class="setup-row-main">T1: ${formatPrice(
            trade.Target1
          )} • T2: ${formatPrice(trade.Target2)}</div>
        </div>
        <div>
          <div class="setup-row-label">Entry date</div>
          <div class="setup-row-main">${formatDate(trade.EntryDate)}</div>
        </div>
        <div>
          <div class="setup-row-label">Time stop (expiry)</div>
          <div class="setup-row-main">${formatDate(trade.ExpiryDate)}</div>
        </div>
      `;

      // status
      let cls = "status-label status-exited";
      let label = trade.Status || "Completed";

      if (trade.Status === "WAITING") {
        cls = "status-label status-waiting";
        label = "Waiting for entry";
      } else if (trade.Status === "ACTIVE") {
        cls = "status-label status-active";
        label = "Active (in zone)";
      } else if (trade.Status.startsWith("EXITED_TP")) {
        cls = "status-label status-exited";
        label = "Completed – Target hit";
      } else if (trade.Status === "EXITED_STOP") {
        cls = "status-label status-exited";
        label = "Completed – Guard rail hit";
      } else if (trade.Status === "EXITED_TIME") {
        cls = "status-label status-exited";
        label = "Completed – Time stop";
      } else if (trade.Status === "EXPIRED_UNTRIGGERED") {
        cls = "status-label status-exited";
        label = "Expired – never entered zone";
      }

      elStatus.textContent = label;
      elStatus.className = cls;
    }

    // --- Render confluence trade table & summary ---------------------------
    function renderConfluenceTable(tbody, trades) {
      tbody.innerHTML = "";
      for (const t of trades) {
        const tr = document.createElement("tr");
        const pnlCls = t.PNL >= 0 ? "pnl-pos" : "pnl-neg";
        tr.innerHTML = `
          <td>${formatDate(t.EntryDate)}</td>
          <td>${t.Signal}</td>
          <td>${formatPrice(t.EntryLow)} – ${formatPrice(t.EntryHigh)}</td>
          <td>${formatPrice(t.Stop)}</td>
          <td>${formatPrice(t.Target1)}</td>
          <td>${formatPrice(t.Target2)}</td>
          <td>${formatDate(t.ExitDate)}</td>
          <td>${formatPrice(t.ExitPrice)}</td>
          <td>${t.Status || "—"}</td>
          <td class="${pnlCls}">${formatPrice(t.PNL)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function confluenceStats(trades) {
      if (!trades.length) {
        return {
          count: 0,
          totalPnl: 0,
          wins: 0,
          losses: 0,
          winRate: 0
        };
      }
      let totalPnl = 0,
        wins = 0,
        losses = 0;
      for (const t of trades) {
        totalPnl += t.PNL;
        if (t.PNL > 0) wins++;
        else if (t.PNL < 0) losses++;
      }
      return {
        count: trades.length,
        totalPnl,
        wins,
        losses,
        winRate: wins ? (wins / trades.length) * 100 : 0
      };
    }

    // --- Main init ---------------------------------------------------------
    async function init() {
      const [spyRaw, portfolioRaw] = await Promise.all([
        fetch("data/SPY.csv").then((r) => r.text()),
        fetch("data/portfolio_confluence.csv").then((r) => r.text())
      ]);

      const spyRows = parseCSV(spyRaw).map((r) => ({
        Date: toDate(r.Date),
        Close: toFloat(r.Close)
      }));
      const prices = spyRows.slice(-60); // last 60 days for chart

      const portRows = parsePortfolioRows(parseCSV(portfolioRaw));

      // meta date
      if (prices.length) {
        const last = prices[prices.length - 1];
        document.getElementById(
          "meta-date"
        ).textContent = `Last close: ${formatPrice(
          last.Close
        )} on ${formatDate(last.Date)}`;
        document.getElementById(
          "chart-meta"
        ).textContent = `Last 60 trading days • Latest: ${formatPrice(
          last.Close
        )}`;
      }

      // draw chart
      const canvas = document.getElementById("priceChart");
      // canvas backing size (for crispness)
      canvas.width = canvas.clientWidth * 2;
      canvas.height = canvas.clientHeight * 2;
      drawPriceChart(canvas, prices);

      // SMA backtest default
      const fastInput = document.getElementById("fastSmaInput");
      const slowInput = document.getElementById("slowSmaInput");
      const holdInput = document.getElementById("holdDaysInput");
      const recalc = () => {
        const fast = parseInt(fastInput.value, 10) || 5;
        const slow = parseInt(slowInput.value, 10) || 20;
        const hold = parseInt(holdInput.value, 10) || 5;
        const { trades } = buildSmaSignals(spyRows, fast, slow, hold);
        const stats = statsFromTrades(trades);
        document.getElementById("sma-trades").textContent = stats.count;
        document.getElementById("sma-calls").textContent = stats.calls;
        document.getElementById("sma-puts").textContent = stats.puts;
        document.getElementById("sma-pnl").textContent = stats.totalPnl.toFixed(2);
        document.getElementById("sma-winrate").textContent =
          stats.count > 0 ? stats.winRate.toFixed(1) + "%" : "—";
        document.getElementById("sma-median").textContent =
          stats.count > 0 ? stats.median.toFixed(2) : "—";
        document.getElementById("sma-dd").textContent =
          stats.count > 0 ? stats.maxDD.toFixed(2) : "—";

        // simple latest bias
        if (trades.length) {
          const last = trades[trades.length - 1];
          document.getElementById("latest-bias").textContent =
            last.signal === "CALL" ? "CALL bias" : "PUT bias";
          document.getElementById(
            "latest-bias-detail"
          ).textContent = `Last SMA cross on ${formatDate(
            last.entry.Date
          )}, entry ${formatPrice(last.entry.Close)}`;
        } else {
          document.getElementById("latest-bias").textContent = "—";
          document.getElementById("latest-bias-detail").textContent =
            "No SMA crosses in window.";
        }
      };
      recalc();
      document.getElementById("recalcBtn").addEventListener("click", recalc);
      document.getElementById("horizon-days").textContent = "5";

      // Confluence stats + table
      const tbody = document.querySelector("#confluence-table tbody");
      renderConfluenceTable(tbody, portRows);
      const cStats = confluenceStats(portRows);
      document.getElementById(
        "confluence-trade-count"
      ).textContent = cStats.count.toString();
      document.getElementById(
        "confluence-trade-pnl"
      ).textContent = `Cumulative P&L: ${cStats.totalPnl.toFixed(2)}`;
      document.getElementById("confluence-winloss").textContent =
        cStats.count > 0 ? `${cStats.wins}/${cStats.losses} (wins/losses)` : "—";
      document.getElementById("confluence-winrate").textContent =
        cStats.count > 0 ? cStats.winRate.toFixed(1) + "%" : "—";

      // Setup cards:
      const currentBody = document.getElementById("current-setup-body");
      const currentStatus = document.getElementById("current-setup-status");
      const lastBody = document.getElementById("last-setup-body");
      const lastStatus = document.getElementById("last-setup-status");

      if (!portRows.length) {
        renderSetupCard(
          currentBody,
          currentStatus,
          null,
          "No confluence setups in available data."
        );
        renderSetupCard(
          lastBody,
          lastStatus,
          null,
          "No completed setups yet."
        );
        return;
      }

      const active = portRows.filter((t) => isActiveStatus(t.Status));
      const completed = portRows.filter((t) => isCompletedStatus(t.Status));

      const latestActive =
        active.length > 0
          ? active.sort((a, b) => a.EntryDate - b.EntryDate)[active.length - 1]
          : null;

      const latestCompleted =
        completed.length > 0
          ? completed.sort((a, b) => a.ExitDate - b.ExitDate)[
              completed.length - 1
            ]
          : null;

      renderSetupCard(
        currentBody,
        currentStatus,
        latestActive,
        "No active or waiting confluence setups right now."
      );
      renderSetupCard(
        lastBody,
        lastStatus,
        latestCompleted,
        "No completed setups yet."
      );
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
