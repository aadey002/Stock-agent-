<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Agent 3 - Q5D Trading Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #3b82f6; --secondary: #8b5cf6; --accent: #06b6d4;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #0891b2;
            --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0;
            --text: #1e293b; --muted: #64748b; --light: #94a3b8;
        }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
        
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 15px 0; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1600px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 45px; height: 45px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .logo h1 { font-size: 20px; font-weight: 700; }
        .logo p { font-size: 11px; opacity: 0.9; }
        .header-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        
        .status-badge { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-badge.online { background: rgba(16,185,129,0.3); }
        .status-badge.offline { background: rgba(239,68,68,0.3); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        
        .symbol-select select { padding: 8px 12px; border: none; border-radius: 8px; font-size: 13px; background: rgba(255,255,255,0.9); cursor: pointer; font-weight: 600; }
        .refresh-btn { padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; }
        
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        .symbol-banner { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 12px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .symbol-banner h2 { font-size: 18px; }
        .symbol-banner .date-time { display: flex; gap: 20px; font-size: 13px; }
        
        .tabs { display: flex; gap: 5px; background: var(--card); border-radius: 12px; padding: 6px; margin-bottom: 20px; overflow-x: auto; border: 1px solid var(--border); }
        .tab-btn { padding: 10px 16px; background: transparent; border: none; border-radius: 8px; color: var(--muted); font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .tab-btn:hover { color: var(--primary); background: rgba(59,130,246,0.05); }
        .tab-btn.active { color: white; background: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .card-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .grid-5 { grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); }
        
        .metric { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
        .metric-label { font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; margin-bottom: 8px; }
        .metric-value { font-size: 24px; font-weight: 700; }
        .metric-value.positive { color: var(--success); }
        .metric-value.negative { color: var(--danger); }
        .metric-sub { font-size: 11px; color: var(--light); margin-top: 4px; }
        
        .agent-card { background: var(--card); border: 2px solid var(--border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; }
        .agent-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .agent-card.bullish { border-color: var(--success); background: linear-gradient(135deg, rgba(16,185,129,0.05), transparent); }
        .agent-card.bearish { border-color: var(--danger); background: linear-gradient(135deg, rgba(239,68,68,0.05), transparent); }
        .agent-card.neutral { border-color: var(--warning); background: linear-gradient(135deg, rgba(245,158,11,0.05), transparent); }
        .agent-icon { font-size: 32px; margin-bottom: 10px; }
        .agent-name { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .agent-type { font-size: 12px; color: var(--muted); margin-bottom: 12px; }
        .agent-signal { display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 700; }
        .agent-signal.call { background: rgba(16,185,129,0.15); color: var(--success); }
        .agent-signal.put { background: rgba(239,68,68,0.15); color: var(--danger); }
        .agent-signal.hold { background: rgba(245,158,11,0.15); color: var(--warning); }
        .conf-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 6px; }
        .conf-fill { height: 100%; border-radius: 3px; }
        .conf-fill.high { background: var(--success); }
        .conf-fill.med { background: var(--warning); }
        .conf-fill.low { background: var(--danger); }
        .agent-details { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
        .agent-card.expanded .agent-details { display: block; }
        .detail-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; }
        .detail-label { color: var(--muted); }
        .detail-value { font-weight: 600; }
        
        .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge-success { background: rgba(16,185,129,0.15); color: var(--success); }
        .badge-danger { background: rgba(239,68,68,0.15); color: var(--danger); }
        .badge-warning { background: rgba(245,158,11,0.15); color: var(--warning); }
        .badge-info { background: rgba(8,145,178,0.15); color: var(--info); }
        .badge-primary { background: rgba(59,130,246,0.15); color: var(--primary); }
        .badge-ultra { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .badge-super { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
        
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px; font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; background: var(--bg); border-bottom: 1px solid var(--border); position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid var(--border); }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: rgba(59,130,246,0.02); }
        
        .chart-box { position: relative; height: 250px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card); border-radius: 16px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 700; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); }
        .modal-body { padding: 20px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; color: var(--muted); margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        
        .sector-item { margin-bottom: 12px; }
        .sector-header { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px; }
        .sector-name { font-weight: 600; }
        .sector-perf { font-weight: 700; }
        .sector-perf.positive { color: var(--success); }
        .sector-perf.negative { color: var(--danger); }
        .sector-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
        .sector-fill { height: 100%; border-radius: 4px; }
        .sector-fill.positive { background: var(--success); }
        .sector-fill.negative { background: var(--danger); }
        
        .empty-state { text-align: center; padding: 40px; color: var(--muted); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; flex-direction: column; gap: 15px; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .transparency-box { background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(139,92,246,0.05)); border: 2px solid var(--primary); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .transparency-title { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 15px; }
        .decision-box { background: var(--card); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .decision-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .decision-result { font-size: 16px; font-weight: 700; }
        .decision-result.approved { color: var(--success); }
        .decision-result.rejected { color: var(--danger); }
        .reason-list { list-style: none; padding: 0; }
        .reason-list li { padding: 8px 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; font-size: 13px; }
        .reason-list li:last-child { border-bottom: none; }
        
        .event-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 8px; }
        .event-icon { font-size: 24px; }
        .event-info { flex: 1; }
        .event-name { font-weight: 600; font-size: 14px; }
        .event-time { font-size: 12px; color: var(--muted); }
        .event-impact { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .event-impact.high { background: rgba(239,68,68,0.15); color: var(--danger); }
        .event-impact.medium { background: rgba(245,158,11,0.15); color: var(--warning); }
        .event-impact.low { background: rgba(16,185,129,0.15); color: var(--success); }
        
        /* Rotation indicator */
        .rotation-indicator { display: flex; align-items: center; justify-content: center; gap: 20px; padding: 20px; background: var(--bg); border-radius: 10px; margin-bottom: 20px; }
        .rotation-arrow { font-size: 40px; }
        .rotation-label { font-size: 14px; color: var(--muted); }
        .rotation-value { font-size: 24px; font-weight: 700; }
        .rotation-value.risk-on { color: var(--success); }
        .rotation-value.risk-off { color: var(--danger); }
        
        /* Pattern items */
        .pattern-item { background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .pattern-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .pattern-name { font-weight: 600; font-size: 14px; }
        .pattern-details { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 8px; }
        .pattern-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
        .pattern-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
        .pattern-fill.bullish { background: linear-gradient(90deg, var(--success), #059669); }
        .pattern-fill.bearish { background: linear-gradient(90deg, var(--danger), #dc2626); }
        .pattern-fill.neutral { background: linear-gradient(90deg, var(--warning), #d97706); }
        
        /* Fibonacci highlight */
        .fib-level { padding: 8px 12px; border-radius: 6px; margin-bottom: 6px; }
        .fib-level.resistance { background: rgba(239,68,68,0.1); border-left: 3px solid var(--danger); }
        .fib-level.support { background: rgba(16,185,129,0.1); border-left: 3px solid var(--success); }
        .fib-level.current { background: rgba(59,130,246,0.15); border: 2px solid var(--primary); }
        
        /* Reference Data Styles */
        .ref-data-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 13px; }
        .ref-label { color: var(--muted); }
        .ref-value { font-weight: 600; }
        .ref-value.positive { color: var(--success); }
        .ref-value.negative { color: var(--danger); }
        
        /* 52-Week Progress Bar */
        .ref-progress-bar { position: relative; height: 8px; background: linear-gradient(90deg, var(--danger), var(--warning), var(--success)); border-radius: 4px; margin-top: 8px; }
        .ref-progress-fill { height: 100%; border-radius: 4px; }
        .ref-progress-marker { position: absolute; top: -4px; width: 4px; height: 16px; background: var(--text); border-radius: 2px; transform: translateX(-50%); }
        
        /* Volume Comparison Bar */
        .volume-comparison-bar { position: relative; height: 24px; background: var(--border); border-radius: 4px; margin-top: 8px; overflow: hidden; }
        .volume-avg-line { position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: var(--text); z-index: 2; }
        .volume-avg-line::after { content: 'AVG'; position: absolute; top: -18px; left: 50%; transform: translateX(-50%); font-size: 9px; color: var(--muted); }
        .volume-today-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 4px; transition: width 0.3s; }
        
        /* Earnings Alert Styles */
        .earnings-warning { background: rgba(245,158,11,0.1); border: 1px solid var(--warning); border-radius: 8px; padding: 10px; margin-top: 10px; }
        .earnings-danger { background: rgba(239,68,68,0.1); border: 1px solid var(--danger); }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">Loading data...</div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üìä</div>
                <div><h1>Stock Agent 3</h1><p>Q5D Professional Trading Platform</p></div>
            </div>
            <div class="header-controls">
                <div class="status-badge online" id="statusBadge">
                    <span class="status-dot"></span>
                    <span id="statusText">ONLINE</span>
                </div>
                <div class="symbol-select">
                    <select id="symbolSelect" onchange="changeSymbol()">
                        <optgroup label="Major ETFs">
                            <option value="SPY">SPY - S&P 500</option>
                            <option value="QQQ">QQQ - Nasdaq 100</option>
                            <option value="IWM">IWM - Russell 2000</option>
                            <option value="DIA">DIA - Dow Jones</option>
                        </optgroup>
                        <optgroup label="Sector ETFs">
                            <option value="XLK">XLK - Technology</option>
                            <option value="XLF">XLF - Financials</option>
                            <option value="XLV">XLV - Healthcare</option>
                            <option value="XLE">XLE - Energy</option>
                            <option value="XLI">XLI - Industrials</option>
                            <option value="XLP">XLP - Consumer Staples</option>
                            <option value="XLY">XLY - Consumer Disc.</option>
                            <option value="XLU">XLU - Utilities</option>
                        </optgroup>
                    </select>
                </div>
                <button class="refresh-btn" onclick="loadAllData()">‚Üª Refresh</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="symbol-banner">
            <h2><span id="currentSymbolDisplay">SPY</span> - <span id="currentSymbolName">S&P 500 ETF</span></h2>
            <div class="date-time">
                <span>üìÖ Date: <strong id="dataDate">--</strong></span>
                <span>üïê Time: <strong id="dataTime">--</strong></span>
                <span>üîÑ Updated: <strong id="lastRefresh">--</strong></span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="overview">üìä Overview</button>
            <button class="tab-btn" data-tab="transparency">üîç Transparency</button>
            <button class="tab-btn" data-tab="agents">ü§ñ Agents</button>
            <button class="tab-btn" data-tab="signals">üìà Signal History</button>
            <button class="tab-btn" data-tab="trades">üìù Trade Log</button>
            <button class="tab-btn" data-tab="market">üåç Market</button>
            <button class="tab-btn" data-tab="rotation">üîÑ Sector Rotation</button>
            <button class="tab-btn" data-tab="holdings">üì¶ Holdings</button>
            <button class="tab-btn" data-tab="analytics">üìâ Analytics</button>
        </div>

        <!-- OVERVIEW TAB -->
        <div id="overview" class="tab-content active">
            <div class="grid grid-5">
                <div class="metric"><div class="metric-label">Price (<span class="symbolTag">SPY</span>)</div><div class="metric-value" id="currentPrice">--</div><div class="metric-sub" id="priceSource">Loading...</div></div>
                <div class="metric"><div class="metric-label">24H Change</div><div class="metric-value" id="dailyChange">--</div><div class="metric-sub" id="changePct">--</div></div>
                <div class="metric"><div class="metric-label">Volume</div><div class="metric-value" id="volumeDisplay">--</div><div class="metric-sub">Daily</div></div>
                <div class="metric"><div class="metric-label">Signal</div><div class="metric-value" id="signalStatus">--</div><div class="metric-sub" id="signalConf">--</div></div>
                <div class="metric"><div class="metric-label">Trade Status</div><div class="metric-value" id="tradeStatus">--</div><div class="metric-sub" id="tradeReason">--</div></div>
            </div>

            <!-- Reference Data Section -->
            <div class="card" style="margin-top:20px;">
                <div class="card-title">üìã Reference Data for <span class="symbolTag">SPY</span></div>
                <div class="grid grid-3">
                    <!-- Price Range Data -->
                    <div style="background:var(--bg);border-radius:10px;padding:15px;">
                        <h4 style="font-size:14px;margin-bottom:12px;color:var(--primary);">üìä Price Ranges</h4>
                        <div class="ref-data-row">
                            <span class="ref-label">52-Week High</span>
                            <span class="ref-value positive" id="week52High">--</span>
                        </div>
                        <div class="ref-data-row">
                            <span class="ref-label">52-Week Low</span>
                            <span class="ref-value negative" id="week52Low">--</span>
                        </div>
                        <div class="ref-data-row">
                            <span class="ref-label">52W Range Position</span>
                            <span class="ref-value" id="week52Position">--</span>
                        </div>
                        <div class="ref-progress-bar">
                            <div class="ref-progress-fill" id="week52ProgressBar" style="width:50%"></div>
                            <div class="ref-progress-marker" id="week52Marker" style="left:50%"></div>
                        </div>
                        <div style="border-top:1px solid var(--border);margin-top:12px;padding-top:12px;">
                            <div class="ref-data-row">
                                <span class="ref-label">Today's High</span>
                                <span class="ref-value" id="todayHigh">--</span>
                            </div>
                            <div class="ref-data-row">
                                <span class="ref-label">Today's Low</span>
                                <span class="ref-value" id="todayLow">--</span>
                            </div>
                            <div class="ref-data-row">
                                <span class="ref-label">Today's Range</span>
                                <span class="ref-value" id="todayRange">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Volume Data -->
                    <div style="background:var(--bg);border-radius:10px;padding:15px;">
                        <h4 style="font-size:14px;margin-bottom:12px;color:var(--primary);">üìà Volume Analysis</h4>
                        <div class="ref-data-row">
                            <span class="ref-label">Today's Volume</span>
                            <span class="ref-value" id="todayVolume">--</span>
                        </div>
                        <div class="ref-data-row">
                            <span class="ref-label">Avg Volume (20D)</span>
                            <span class="ref-value" id="avgVolume20">--</span>
                        </div>
                        <div class="ref-data-row">
                            <span class="ref-label">Volume vs Avg</span>
                            <span class="ref-value" id="volumeVsAvg">--</span>
                        </div>
                        <div class="volume-comparison-bar">
                            <div class="volume-avg-line"></div>
                            <div class="volume-today-bar" id="volumeCompareBar" style="width:100%"></div>
                        </div>
                        <div class="ref-data-row" style="margin-top:8px;">
                            <span class="ref-label">Volume Signal</span>
                            <span class="badge" id="volumeSignal">NORMAL</span>
                        </div>
                        <div style="border-top:1px solid var(--border);margin-top:12px;padding-top:12px;">
                            <div class="ref-data-row">
                                <span class="ref-label">Avg Volume (50D)</span>
                                <span class="ref-value" id="avgVolume50">--</span>
                            </div>
                            <div class="ref-data-row">
                                <span class="ref-label">Volume Trend</span>
                                <span class="badge" id="volumeTrend">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Earnings Data -->
                    <div style="background:var(--bg);border-radius:10px;padding:15px;">
                        <h4 style="font-size:14px;margin-bottom:12px;color:var(--primary);">üìÖ Earnings & Events</h4>
                        <div class="ref-data-row">
                            <span class="ref-label">Last Earnings Date</span>
                            <span class="ref-value" id="lastEarningsDate">--</span>
                        </div>
                        <div class="ref-data-row">
                            <span class="ref-label">EPS Estimate</span>
                            <span class="ref-value" id="lastEpsEstimate">--</span>
                        </div>
                        <div class="ref-data-row">
                            <span class="ref-label">EPS Actual</span>
                            <span class="ref-value" id="lastEpsActual">--</span>
                        </div>
                        <div class="ref-data-row">
                            <span class="ref-label">Earnings Surprise</span>
                            <span class="ref-value" id="earningsSurprise">--</span>
                        </div>
                        <div style="border-top:1px solid var(--border);margin-top:12px;padding-top:12px;">
                            <div class="ref-data-row">
                                <span class="ref-label">Next Earnings</span>
                                <span class="ref-value" style="color:var(--warning)" id="nextEarningsDate">--</span>
                            </div>
                            <div class="ref-data-row">
                                <span class="ref-label">Days Until</span>
                                <span class="ref-value" id="daysUntilEarnings">--</span>
                            </div>
                            <div class="ref-data-row">
                                <span class="ref-label">Est. EPS</span>
                                <span class="ref-value" id="nextEpsEstimate">--</span>
                            </div>
                            <div class="ref-data-row">
                                <span class="ref-label">Volatility Alert</span>
                                <span class="badge" id="earningsVolatilityAlert">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="card-title" style="margin: 25px 0 15px;">ü§ñ Agent Signals for <span class="symbolTag">SPY</span></h3>
            <div class="grid grid-4" id="agentCardsContainer">
                <div class="agent-card bullish" onclick="toggleAgent(this)">
                    <div class="agent-icon">üìä</div>
                    <div class="agent-name">Base Confluence</div>
                    <div class="agent-type">SMA + Technical</div>
                    <span class="agent-signal call" id="baseSignal">CALL</span>
                    <div style="margin-top:12px;display:flex;justify-content:space-between;font-size:12px;"><span>Confidence</span><span id="baseConf">72%</span></div>
                    <div class="conf-bar"><div class="conf-fill high" id="baseConfBar" style="width:72%"></div></div>
                    <div class="agent-details">
                        <div class="detail-row"><span class="detail-label">Fast SMA</span><span class="detail-value" id="baseFastSMA">--</span></div>
                        <div class="detail-row"><span class="detail-label">Slow SMA</span><span class="detail-value" id="baseSlowSMA">--</span></div>
                        <div class="detail-row"><span class="detail-label">ATR</span><span class="detail-value" id="baseATR">--</span></div>
                        <div class="detail-row"><span class="detail-label">Bias</span><span class="detail-value" id="baseBias">--</span></div>
                    </div>
                </div>
                <div class="agent-card bullish" onclick="toggleAgent(this)">
                    <div class="agent-icon">üîÆ</div>
                    <div class="agent-name">Gann-Elliott</div>
                    <div class="agent-type">Wave + Fibonacci</div>
                    <span class="agent-signal call" id="gannSignal">CALL</span>
                    <div style="margin-top:12px;display:flex;justify-content:space-between;font-size:12px;"><span>Confidence</span><span id="gannConf">78%</span></div>
                    <div class="conf-bar"><div class="conf-fill high" id="gannConfBar" style="width:78%"></div></div>
                    <div class="agent-details">
                        <div class="detail-row"><span class="detail-label">Geo Level</span><span class="detail-value" id="gannGeo">--</span></div>
                        <div class="detail-row"><span class="detail-label">Phi Level</span><span class="detail-value" id="gannPhi">--</span></div>
                        <div class="detail-row"><span class="detail-label">Price Conf</span><span class="detail-value" id="gannPriceConf">--</span></div>
                        <div class="detail-row"><span class="detail-label">Time Conf</span><span class="detail-value" id="gannTimeConf">--</span></div>
                    </div>
                </div>
                <div class="agent-card neutral" onclick="openRLModal()">
                    <div class="agent-icon">üß†</div>
                    <div class="agent-name">DQN/RL Agent</div>
                    <div class="agent-type">Deep Q-Network</div>
                    <span class="agent-signal hold" id="dqnSignal">HOLD</span>
                    <div style="margin-top:12px;display:flex;justify-content:space-between;font-size:12px;"><span>Confidence</span><span id="dqnConf">62%</span></div>
                    <div class="conf-bar"><div class="conf-fill med" id="dqnConfBar" style="width:62%"></div></div>
                    <div class="agent-details">
                        <div class="detail-row"><span class="detail-label">Q(CALL)</span><span class="detail-value" id="dqnQCall">0.72</span></div>
                        <div class="detail-row"><span class="detail-label">Q(PUT)</span><span class="detail-value" id="dqnQPut">0.18</span></div>
                        <div class="detail-row"><span class="detail-label">Q(HOLD)</span><span class="detail-value" id="dqnQHold">0.10</span></div>
                        <div style="margin-top:8px;font-size:11px;color:var(--primary);">Click for full details ‚Üí</div>
                    </div>
                </div>
                <div class="agent-card neutral" onclick="toggleAgent(this)">
                    <div class="agent-icon">üåä</div>
                    <div class="agent-name">3-Wave System</div>
                    <div class="agent-type">Profit Targets</div>
                    <span class="agent-signal hold" id="waveSignal">HOLD</span>
                    <div style="margin-top:12px;display:flex;justify-content:space-between;font-size:12px;"><span>Confidence</span><span id="waveConf">55%</span></div>
                    <div class="conf-bar"><div class="conf-fill med" id="waveConfBar" style="width:55%"></div></div>
                    <div class="agent-details">
                        <div class="detail-row"><span class="detail-label">Target 1</span><span class="detail-value positive" id="waveT1">--</span></div>
                        <div class="detail-row"><span class="detail-label">Target 2</span><span class="detail-value positive" id="waveT2">--</span></div>
                        <div class="detail-row"><span class="detail-label">Stop</span><span class="detail-value negative" id="waveStop">--</span></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <div class="card-title">üìà <span class="symbolTag">SPY</span> Price Chart (60 Days)</div>
                    <div class="chart-box"><canvas id="priceChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-title">üó≥Ô∏è Recent Voting Log</div>
                    <div class="table-wrap" style="max-height:300px;overflow-y:auto;">
                        <table>
                            <thead><tr><th>Date</th><th>Time</th><th>Base</th><th>Gann</th><th>DQN</th><th>Result</th><th>Level</th></tr></thead>
                            <tbody id="votingLogTable"><tr><td colspan="7" class="empty-state">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TRANSPARENCY TAB -->
        <div id="transparency" class="tab-content">
            <div class="transparency-box">
                <div class="transparency-title">üîç Complete System Transparency</div>
                <p style="color:var(--muted);margin-bottom:15px;">See all system outputs, understand WHY trades were approved/rejected.</p>
            </div>

            <div class="card">
                <div class="card-title">üìã Today's Trading Decision</div>
                <div class="decision-box">
                    <div class="decision-header">
                        <span class="decision-result approved" id="todayDecision">TRADE APPROVED</span>
                        <span class="badge badge-ultra" id="todayLevel">SUPER CONFLUENCE</span>
                    </div>
                    <div style="margin-bottom:15px;">
                        <strong>Signal:</strong> <span id="todaySignal">CALL</span> | 
                        <strong>Entry:</strong> <span id="todayEntry">$598.45</span> | 
                        <strong>Stop:</strong> <span id="todayStop">$592.20</span> | 
                        <strong>Target:</strong> <span id="todayTarget">$610.95</span>
                    </div>
                    <h4 style="margin-bottom:10px;">Why This Trade Was Approved:</h4>
                    <ul class="reason-list" id="approvalReasons">
                        <li><span>‚úÖ</span> <span id="reason1">3/4 agents agree on direction (Super Confluence)</span></li>
                        <li><span>‚úÖ</span> <span id="reason2">VIX at normal levels (trading allowed)</span></li>
                        <li><span>‚úÖ</span> <span id="reason3">No major economic events today</span></li>
                        <li><span>‚úÖ</span> <span id="reason4">Sector rotation: Favorable</span></li>
                        <li><span>‚úÖ</span> <span id="reason5">Trend confirmed by SMAs</span></li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ü§ñ Agent-by-Agent Analysis</div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Agent</th><th>Signal</th><th>Confidence</th><th>Key Reasoning</th><th>Win Rate</th><th>Best Conditions</th></tr></thead>
                        <tbody>
                            <tr><td><strong>üìä Base Confluence</strong></td><td><span class="badge badge-success">CALL</span></td><td>72%</td><td>Fast SMA crossed above Slow SMA</td><td>65%</td><td>Trending markets</td></tr>
                            <tr><td><strong>üîÆ Gann-Elliott</strong></td><td><span class="badge badge-success">CALL</span></td><td>78%</td><td>Price at geometric support</td><td>72%</td><td>Key levels</td></tr>
                            <tr><td><strong>üß† DQN/RL</strong></td><td><span class="badge badge-warning">HOLD</span></td><td>62%</td><td>Q-values mixed</td><td>62%</td><td>High momentum</td></tr>
                            <tr><td><strong>üåä 3-Wave</strong></td><td><span class="badge badge-success">CALL</span></td><td>68%</td><td>Wave 3 starting</td><td>71%</td><td>Clear waves</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üåç Market Conditions Impact</div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Condition</th><th>Value</th><th>Status</th><th>Impact</th><th>Size Adj.</th></tr></thead>
                        <tbody id="conditionsImpactTable">
                            <tr><td><strong>üìà Volatility (VIX)</strong></td><td id="vixCondition">18.5</td><td><span class="badge badge-success">NORMAL</span></td><td>Full trading</td><td>100%</td></tr>
                            <tr><td><strong>üìÖ Economic Calendar</strong></td><td id="econCondition">0 events</td><td><span class="badge badge-success">CLEAR</span></td><td>No restrictions</td><td>100%</td></tr>
                            <tr><td><strong>üòä Sentiment</strong></td><td id="sentCondition">NEUTRAL</td><td><span class="badge badge-warning">NEUTRAL</span></td><td>Proceed cautiously</td><td>75%</td></tr>
                            <tr><td><strong>üîÑ Rotation</strong></td><td id="rotationCondition">RISK-ON</td><td><span class="badge badge-success">FAVORABLE</span></td><td>Supports CALL</td><td>100%</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- AGENTS TAB -->
        <div id="agents" class="tab-content">
            <!-- Fibonacci Levels -->
            <div class="card">
                <div class="card-title">üìê Fibonacci Support & Resistance Levels</div>
                <p style="color:var(--muted);font-size:13px;margin-bottom:15px;">Key levels for profit taking and risk management based on recent swing high/low</p>
                <div class="grid grid-2">
                    <div>
                        <h4 style="color:var(--success);margin-bottom:10px;">üéØ Resistance Levels (Profit Targets)</h4>
                        <div class="table-wrap">
                            <table>
                                <thead><tr><th>Level</th><th>Price</th><th>Distance</th><th>Use For</th></tr></thead>
                                <tbody id="fibResistanceTable">
                                    <tr><td>R3 (161.8%)</td><td id="fibR3">--</td><td id="fibR3Dist">--</td><td>Extended Target</td></tr>
                                    <tr><td>R2 (127.2%)</td><td id="fibR2">--</td><td id="fibR2Dist">--</td><td>Target 2</td></tr>
                                    <tr><td>R1 (100%)</td><td id="fibR1">--</td><td id="fibR1Dist">--</td><td>Target 1</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h4 style="color:var(--danger);margin-bottom:10px;">üõ°Ô∏è Support Levels (Stop Loss / Entry)</h4>
                        <div class="table-wrap">
                            <table>
                                <thead><tr><th>Level</th><th>Price</th><th>Distance</th><th>Use For</th></tr></thead>
                                <tbody id="fibSupportTable">
                                    <tr><td>S1 (38.2%)</td><td id="fibS1">--</td><td id="fibS1Dist">--</td><td>First Support</td></tr>
                                    <tr><td>S2 (50.0%)</td><td id="fibS2">--</td><td id="fibS2Dist">--</td><td>Key Support</td></tr>
                                    <tr><td>S3 (61.8%)</td><td id="fibS3">--</td><td id="fibS3Dist">--</td><td>Strong Support / Stop</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div style="margin-top:15px;padding:15px;background:var(--bg);border-radius:8px;">
                    <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:15px;">
                        <div><strong>Swing High:</strong> <span id="swingHigh">--</span></div>
                        <div><strong>Swing Low:</strong> <span id="swingLow">--</span></div>
                        <div><strong>Current Price:</strong> <span id="fibCurrentPrice">--</span></div>
                        <div><strong>Fib Zone:</strong> <span class="badge badge-info" id="fibZone">--</span></div>
                    </div>
                </div>
            </div>

            <!-- Pattern Analysis Grid -->
            <div class="grid grid-3">
                <!-- Technical Patterns -->
                <div class="card">
                    <div class="card-title">üìä Technical Patterns</div>
                    <p style="color:var(--muted);font-size:12px;margin-bottom:15px;">Chart patterns detected in recent price action</p>
                    <div id="technicalPatterns">
                        <div class="pattern-item" id="techPattern1">
                            <div class="pattern-header">
                                <span class="pattern-name">Double Bottom</span>
                                <span class="badge badge-success" id="techPattern1Signal">BULLISH</span>
                            </div>
                            <div class="pattern-details">
                                <div>Confidence: <strong id="techPattern1Conf">72%</strong></div>
                                <div>Status: <span id="techPattern1Status">Forming</span></div>
                            </div>
                            <div class="pattern-bar"><div class="pattern-fill bullish" id="techPattern1Bar" style="width:72%"></div></div>
                        </div>
                        <div class="pattern-item" id="techPattern2">
                            <div class="pattern-header">
                                <span class="pattern-name">Ascending Triangle</span>
                                <span class="badge badge-success" id="techPattern2Signal">BULLISH</span>
                            </div>
                            <div class="pattern-details">
                                <div>Confidence: <strong id="techPattern2Conf">65%</strong></div>
                                <div>Status: <span id="techPattern2Status">Confirmed</span></div>
                            </div>
                            <div class="pattern-bar"><div class="pattern-fill bullish" id="techPattern2Bar" style="width:65%"></div></div>
                        </div>
                        <div class="pattern-item" id="techPattern3">
                            <div class="pattern-header">
                                <span class="pattern-name">Bull Flag</span>
                                <span class="badge badge-success" id="techPattern3Signal">BULLISH</span>
                            </div>
                            <div class="pattern-details">
                                <div>Confidence: <strong id="techPattern3Conf">58%</strong></div>
                                <div>Status: <span id="techPattern3Status">Potential</span></div>
                            </div>
                            <div class="pattern-bar"><div class="pattern-fill bullish" id="techPattern3Bar" style="width:58%"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Candlestick Patterns -->
                <div class="card">
                    <div class="card-title">üïØÔ∏è Candlestick Patterns</div>
                    <p style="color:var(--muted);font-size:12px;margin-bottom:15px;">Japanese candlestick patterns in last 5 bars</p>
                    <div id="candlePatterns">
                        <div class="pattern-item" id="candlePattern1">
                            <div class="pattern-header">
                                <span class="pattern-name">Bullish Engulfing</span>
                                <span class="badge badge-success" id="candlePattern1Signal">BULLISH</span>
                            </div>
                            <div class="pattern-details">
                                <div>Confidence: <strong id="candlePattern1Conf">78%</strong></div>
                                <div>Bars Ago: <span id="candlePattern1Bars">1</span></div>
                            </div>
                            <div class="pattern-bar"><div class="pattern-fill bullish" id="candlePattern1Bar" style="width:78%"></div></div>
                        </div>
                        <div class="pattern-item" id="candlePattern2">
                            <div class="pattern-header">
                                <span class="pattern-name">Hammer</span>
                                <span class="badge badge-success" id="candlePattern2Signal">BULLISH</span>
                            </div>
                            <div class="pattern-details">
                                <div>Confidence: <strong id="candlePattern2Conf">70%</strong></div>
                                <div>Bars Ago: <span id="candlePattern2Bars">3</span></div>
                            </div>
                            <div class="pattern-bar"><div class="pattern-fill bullish" id="candlePattern2Bar" style="width:70%"></div></div>
                        </div>
                        <div class="pattern-item" id="candlePattern3">
                            <div class="pattern-header">
                                <span class="pattern-name">Morning Star</span>
                                <span class="badge badge-success" id="candlePattern3Signal">BULLISH</span>
                            </div>
                            <div class="pattern-details">
                                <div>Confidence: <strong id="candlePattern3Conf">62%</strong></div>
                                <div>Bars Ago: <span id="candlePattern3Bars">5</span></div>
                            </div>
                            <div class="pattern-bar"><div class="pattern-fill bullish" id="candlePattern3Bar" style="width:62%"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Point & Figure Patterns -->
                <div class="card">
                    <div class="card-title">‚¨õ Point & Figure Patterns</div>
                    <p style="color:var(--muted);font-size:12px;margin-bottom:15px;">P&F chart patterns (3-box reversal)</p>
                    <div id="pnfPatterns">
                        <div class="pattern-item" id="pnfPattern1">
                            <div class="pattern-header">
                                <span class="pattern-name">Double Top Breakout</span>
                                <span class="badge badge-success" id="pnfPattern1Signal">BULLISH</span>
                            </div>
                            <div class="pattern-details">
                                <div>Confidence: <strong id="pnfPattern1Conf">75%</strong></div>
                                <div>Target: <span id="pnfPattern1Target">+$12.50</span></div>
                            </div>
                            <div class="pattern-bar"><div class="pattern-fill bullish" id="pnfPattern1Bar" style="width:75%"></div></div>
                        </div>
                        <div class="pattern-item" id="pnfPattern2">
                            <div class="pattern-header">
                                <span class="pattern-name">Triple Top</span>
                                <span class="badge badge-warning" id="pnfPattern2Signal">NEUTRAL</span>
                            </div>
                            <div class="pattern-details">
                                <div>Confidence: <strong id="pnfPattern2Conf">55%</strong></div>
                                <div>Target: <span id="pnfPattern2Target">Pending</span></div>
                            </div>
                            <div class="pattern-bar"><div class="pattern-fill neutral" id="pnfPattern2Bar" style="width:55%"></div></div>
                        </div>
                        <div class="pattern-item" id="pnfPattern3">
                            <div class="pattern-header">
                                <span class="pattern-name">Bullish Catapult</span>
                                <span class="badge badge-success" id="pnfPattern3Signal">BULLISH</span>
                            </div>
                            <div class="pattern-details">
                                <div>Confidence: <strong id="pnfPattern3Conf">68%</strong></div>
                                <div>Target: <span id="pnfPattern3Target">+$18.00</span></div>
                            </div>
                            <div class="pattern-bar"><div class="pattern-fill bullish" id="pnfPattern3Bar" style="width:68%"></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pattern vs Agent Agreement -->
            <div class="card">
                <div class="card-title">ü§ù Pattern & Agent Agreement Analysis</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Analysis Type</th>
                                <th>Signal</th>
                                <th>Confidence</th>
                                <th>Agrees with Agents?</th>
                                <th>Weight</th>
                            </tr>
                        </thead>
                        <tbody id="agreementTable">
                            <tr>
                                <td><strong>üìä Technical Patterns</strong></td>
                                <td><span class="badge badge-success" id="techOverallSignal">BULLISH</span></td>
                                <td id="techOverallConf">65%</td>
                                <td><span class="badge badge-success" id="techAgrees">‚úì YES</span></td>
                                <td>25%</td>
                            </tr>
                            <tr>
                                <td><strong>üïØÔ∏è Candlestick Patterns</strong></td>
                                <td><span class="badge badge-success" id="candleOverallSignal">BULLISH</span></td>
                                <td id="candleOverallConf">70%</td>
                                <td><span class="badge badge-success" id="candleAgrees">‚úì YES</span></td>
                                <td>25%</td>
                            </tr>
                            <tr>
                                <td><strong>‚¨õ P&F Patterns</strong></td>
                                <td><span class="badge badge-success" id="pnfOverallSignal">BULLISH</span></td>
                                <td id="pnfOverallConf">66%</td>
                                <td><span class="badge badge-success" id="pnfAgrees">‚úì YES</span></td>
                                <td>25%</td>
                            </tr>
                            <tr>
                                <td><strong>ü§ñ Agent Consensus</strong></td>
                                <td><span class="badge badge-success" id="agentOverallSignal">CALL</span></td>
                                <td id="agentOverallConf">72%</td>
                                <td><span class="badge badge-primary">BASELINE</span></td>
                                <td>25%</td>
                            </tr>
                            <tr style="background:var(--bg);font-weight:700;">
                                <td><strong>üìà COMBINED SIGNAL</strong></td>
                                <td><span class="badge badge-ultra" id="combinedSignal">STRONG CALL</span></td>
                                <td id="combinedConf">68%</td>
                                <td><span class="badge badge-success" id="combinedAgreement">4/4 AGREE</span></td>
                                <td>100%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Agent Tuning Parameters -->
            <div class="card">
                <div class="card-title">‚öôÔ∏è Agent Tuning Parameters</div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Parameter</th><th>Base Confluence</th><th>Gann-Elliott</th><th>DQN/RL</th><th>3-Wave</th></tr></thead>
                        <tbody id="tuningTable">
                            <tr><td><strong>Fast Period</strong></td><td>10</td><td>8</td><td>N/A</td><td>5</td></tr>
                            <tr><td><strong>Slow Period</strong></td><td>30</td><td>21</td><td>N/A</td><td>20</td></tr>
                            <tr><td><strong>ATR Period</strong></td><td>14</td><td>14</td><td>14</td><td>14</td></tr>
                            <tr><td><strong>ATR Stop Mult</strong></td><td>1.5</td><td>2.0</td><td>1.5</td><td>1.5</td></tr>
                            <tr><td><strong>ATR Target Mult</strong></td><td>3.0</td><td>4.0</td><td>2.5</td><td>3.0</td></tr>
                            <tr><td><strong>Min Confidence</strong></td><td>60%</td><td>65%</td><td>55%</td><td>60%</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SIGNALS TAB -->
        <div id="signals" class="tab-content">
            <div class="grid grid-5" style="margin-bottom:20px;">
                <div class="metric"><div class="metric-label">Total Signals</div><div class="metric-value" id="totalSignals3Y">--</div></div>
                <div class="metric"><div class="metric-label">ULTRA (4/4)</div><div class="metric-value positive" id="ultraCount">--</div></div>
                <div class="metric"><div class="metric-label">SUPER (3/4)</div><div class="metric-value" style="color:var(--primary)" id="superCount">--</div></div>
                <div class="metric"><div class="metric-label">Win Rate</div><div class="metric-value" id="signalWinRate">--</div></div>
                <div class="metric"><div class="metric-label">Avg P&L</div><div class="metric-value" id="avgPnlSignal">--</div></div>
            </div>
            <div class="card">
                <div class="card-title">üìú Historical Signals with Performance</div>
                <div class="table-wrap" style="max-height:500px;overflow-y:auto;">
                    <table>
                        <thead><tr><th>Date</th><th>Signal</th><th>Level</th><th>Base</th><th>Gann</th><th>DQN</th><th>Entry</th><th>Exit Date</th><th>Exit Price</th><th>P&L</th><th>Result</th></tr></thead>
                        <tbody id="signalHistoryTable"><tr><td colspan="11" class="empty-state">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TRADES TAB -->
        <div id="trades" class="tab-content">
            <div class="grid grid-5" style="margin-bottom:20px;">
                <div class="metric"><div class="metric-label">Total Trades</div><div class="metric-value" id="totalTrades">--</div></div>
                <div class="metric"><div class="metric-label">Win Rate</div><div class="metric-value" id="winRate">--</div></div>
                <div class="metric"><div class="metric-label">Total P&L</div><div class="metric-value" id="totalPnl">--</div></div>
                <div class="metric"><div class="metric-label">Avg Win</div><div class="metric-value positive" id="avgWin">--</div></div>
                <div class="metric"><div class="metric-label">Avg Loss</div><div class="metric-value negative" id="avgLoss">--</div></div>
            </div>
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-title">‚ûï Log New Trade</div>
                    <form id="tradeForm" onsubmit="logTrade(event)">
                        <div class="form-row">
                            <div class="form-group"><label>Type</label><select id="tradeType"><option value="paper">üìù Paper</option><option value="live">üí∞ Live</option></select></div>
                            <div class="form-group"><label>Symbol</label><input type="text" id="tradeSymbol" value="SPY"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Direction</label><select id="tradeDirection"><option value="CALL">üìà CALL</option><option value="PUT">üìâ PUT</option></select></div>
                            <div class="form-group"><label>Entry Date</label><input type="date" id="tradeEntryDate"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Entry Price</label><input type="number" step="0.01" id="tradeEntryPrice"></div>
                            <div class="form-group"><label>Size ($)</label><input type="number" step="0.01" id="tradeSize" value="1000"></div>
                        </div>
                        <div class="form-group"><label>Notes</label><textarea id="tradeNotes" rows="2"></textarea></div>
                        <button type="submit" class="btn btn-primary" style="width:100%;">Log Trade</button>
                    </form>
                </div>
                <div class="card">
                    <div class="card-title">üìã My Trades</div>
                    <div class="table-wrap" style="max-height:400px;overflow-y:auto;">
                        <table>
                            <thead><tr><th>Date</th><th>Symbol</th><th>Dir</th><th>Entry</th><th>P&L</th><th>Type</th></tr></thead>
                            <tbody id="myTradesTable"><tr><td colspan="6" class="empty-state">No trades</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- MARKET TAB -->
        <div id="market" class="tab-content">
            <div class="card">
                <div class="card-title">üìÖ Upcoming Economic Events</div>
                <div id="economicEvents">
                    <div class="event-item"><div class="event-icon">üìä</div><div class="event-info"><div class="event-name">Non-Farm Payrolls (NFP)</div><div class="event-time">Friday, 8:30 AM ET</div></div><span class="event-impact high">HIGH IMPACT</span></div>
                    <div class="event-item"><div class="event-icon">üí∞</div><div class="event-info"><div class="event-name">FOMC Interest Rate Decision</div><div class="event-time">Next Wednesday, 2:00 PM ET</div></div><span class="event-impact high">HIGH IMPACT</span></div>
                    <div class="event-item"><div class="event-icon">üìà</div><div class="event-info"><div class="event-name">Consumer Price Index (CPI)</div><div class="event-time">Dec 12, 8:30 AM ET</div></div><span class="event-impact high">HIGH IMPACT</span></div>
                    <div class="event-item"><div class="event-icon">üè≠</div><div class="event-info"><div class="event-name">GDP Release</div><div class="event-time">Tomorrow</div></div><span class="event-impact high">HIGH IMPACT</span></div>
                    <div class="event-item"><div class="event-icon">üë∑</div><div class="event-info"><div class="event-name">Unemployment Rate</div><div class="event-time">Friday, 8:30 AM ET</div></div><span class="event-impact medium">MEDIUM</span></div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üåç Full Market Analysis</div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Category</th><th>Indicator</th><th>Value</th><th>Status</th><th>Recommendation</th></tr></thead>
                        <tbody id="marketAnalysisTable">
                            <tr><td><strong>Volatility</strong></td><td>VIX Estimate</td><td id="vixVal">--</td><td id="vixStatus">--</td><td id="vixRec">--</td></tr>
                            <tr><td><strong>Calendar</strong></td><td>Events Today</td><td id="eventsToday">--</td><td>--</td><td>--</td></tr>
                            <tr><td><strong>Sentiment</strong></td><td>Market Mood</td><td id="sentimentVal">--</td><td id="sentimentStatus">--</td><td>--</td></tr>
                            <tr><td><strong>Position</strong></td><td>Trade Allowed</td><td id="tradeAllowedVal">--</td><td>--</td><td>--</td></tr>
                            <tr><td><strong>Position</strong></td><td>Size Multiplier</td><td id="sizeMult">--</td><td>--</td><td>--</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SECTOR ROTATION TAB -->
        <div id="rotation" class="tab-content">
            <div class="card">
                <div class="card-title">üîÑ Sector Rotation Analysis</div>
                <div class="rotation-indicator">
                    <div>
                        <div class="rotation-label">Current Rotation</div>
                        <div class="rotation-value risk-on" id="rotationStatus">RISK-ON</div>
                    </div>
                    <div class="rotation-arrow" id="rotationArrow">üìà</div>
                    <div>
                        <div class="rotation-label">Leading Sectors</div>
                        <div id="leadingSectors" style="font-weight:600;">Technology, Financials</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìä Sector Performance Table</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Symbol</th>
                                <th>Sector</th>
                                <th>Price</th>
                                <th>1M Performance</th>
                                <th>Trend</th>
                                <th>Signal</th>
                            </tr>
                        </thead>
                        <tbody id="sectorRotationTable">
                            <tr><td colspan="7" class="empty-state">Loading sector data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <div class="card-title" style="color:var(--success);">üöÄ Cyclical Sectors (Risk-On)</div>
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th>Symbol</th><th>Sector</th><th>1M %</th><th>Status</th></tr></thead>
                            <tbody id="cyclicalTable"><tr><td colspan="4" class="empty-state">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title" style="color:var(--danger);">üõ°Ô∏è Defensive Sectors (Risk-Off)</div>
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th>Symbol</th><th>Sector</th><th>1M %</th><th>Status</th></tr></thead>
                            <tbody id="defensiveTable"><tr><td colspan="4" class="empty-state">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìà Sector Performance Bars</div>
                <div id="sectorBars"><div class="empty-state">Loading...</div></div>
            </div>
        </div>

        <!-- HOLDINGS TAB -->
        <div id="holdings" class="tab-content">
            <div class="card">
                <div class="card-title">üì¶ ETF Holdings Analysis</div>
                <div style="margin-bottom:15px;">
                    <select id="holdingsETFSelect" onchange="loadETFHoldings()" style="padding:10px 15px;border:1px solid var(--border);border-radius:8px;font-size:14px;">
                        <option value="SPY">SPY - S&P 500</option>
                        <option value="QQQ">QQQ - Nasdaq 100</option>
                        <option value="XLK">XLK - Technology</option>
                        <option value="XLF">XLF - Financials</option>
                        <option value="XLV">XLV - Healthcare</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìä Top Holdings Table</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Symbol</th>
                                <th>Company Name</th>
                                <th>Weight %</th>
                                <th>Price</th>
                                <th>1M Change</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsTable">
                            <tr><td colspan="7" class="empty-state">Loading holdings data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <div class="card-title" style="color:var(--success);">üöÄ Top 5 Performers</div>
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th>#</th><th>Symbol</th><th>Name</th><th>Performance</th></tr></thead>
                            <tbody id="topPerformersTable"><tr><td colspan="4" class="empty-state">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title" style="color:var(--danger);">üìâ Bottom 5 Performers</div>
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th>#</th><th>Symbol</th><th>Name</th><th>Performance</th></tr></thead>
                            <tbody id="bottomPerformersTable"><tr><td colspan="4" class="empty-state">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analytics" class="tab-content">
            <div class="grid grid-4" style="margin-bottom:20px;">
                <div class="metric"><div class="metric-label">Sharpe Ratio</div><div class="metric-value" id="sharpeRatio">--</div></div>
                <div class="metric"><div class="metric-label">Max Drawdown</div><div class="metric-value negative" id="maxDrawdown">--</div></div>
                <div class="metric"><div class="metric-label">Profit Factor</div><div class="metric-value" id="profitFactor">--</div></div>
                <div class="metric"><div class="metric-label">Avg R</div><div class="metric-value" id="avgR">--</div></div>
            </div>
            <div class="grid grid-2">
                <div class="card"><div class="card-title">üìä Win Rate by Agent</div><div class="chart-box"><canvas id="winRateChart"></canvas></div></div>
                <div class="card"><div class="card-title">üìà Confluence Distribution</div><div class="chart-box"><canvas id="confluenceChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <!-- RL Modal -->
    <div class="modal" id="rlModal" onclick="if(event.target===this)closeModal()">
        <div class="modal-content">
            <div class="modal-header"><span class="modal-title">üß† DQN/RL Agent Details</span><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <div class="modal-body">
                <div class="card" style="margin-bottom:15px;"><div class="card-title">Network</div><div class="detail-row"><span class="detail-label">Architecture</span><span class="detail-value">[30] ‚Üí [128,64,32] ‚Üí [3]</span></div><div class="detail-row"><span class="detail-label">Activation</span><span class="detail-value">ReLU + Softmax</span></div></div>
                <div class="card" style="margin-bottom:15px;"><div class="card-title">Training</div><div class="detail-row"><span class="detail-label">Episodes</span><span class="detail-value">2,500 / 10,000</span></div><div class="detail-row"><span class="detail-label">Epsilon</span><span class="detail-value">0.15</span></div></div>
                <div class="card"><div class="card-title">Q-Values</div><div class="detail-row"><span class="detail-label">Q(CALL)</span><span class="detail-value positive">0.72</span></div><div class="detail-row"><span class="detail-label">Q(PUT)</span><span class="detail-value">0.18</span></div><div class="detail-row"><span class="detail-label">Q(HOLD)</span><span class="detail-value">0.10</span></div></div>
            </div>
        </div>
    </div>

<script>
const SYMBOL_NAMES = {
    'SPY': 'S&P 500 ETF', 'QQQ': 'Nasdaq 100 ETF', 'IWM': 'Russell 2000 ETF', 'DIA': 'Dow Jones ETF',
    'XLK': 'Technology', 'XLF': 'Financials', 'XLV': 'Healthcare', 'XLE': 'Energy',
    'XLI': 'Industrials', 'XLP': 'Consumer Staples', 'XLY': 'Consumer Disc.', 'XLU': 'Utilities',
    'XLB': 'Materials', 'XLRE': 'Real Estate'
};

const CYCLICAL_SECTORS = ['XLK', 'XLF', 'XLY', 'XLI', 'XLB', 'XLE'];
const DEFENSIVE_SECTORS = ['XLV', 'XLP', 'XLU', 'XLRE'];

// Sample holdings data (in real app, this would come from API)
const SAMPLE_HOLDINGS = {
    'SPY': [
        { symbol: 'AAPL', name: 'Apple Inc.', weight: 7.2, price: 189.50, change: 5.2 },
        { symbol: 'MSFT', name: 'Microsoft Corp.', weight: 6.8, price: 378.20, change: 3.8 },
        { symbol: 'AMZN', name: 'Amazon.com', weight: 3.4, price: 178.90, change: 8.1 },
        { symbol: 'NVDA', name: 'NVIDIA Corp.', weight: 3.2, price: 495.80, change: 12.5 },
        { symbol: 'GOOGL', name: 'Alphabet Inc.', weight: 2.1, price: 141.20, change: 2.3 },
        { symbol: 'META', name: 'Meta Platforms', weight: 1.9, price: 512.30, change: 6.7 },
        { symbol: 'BRK.B', name: 'Berkshire Hathaway', weight: 1.7, price: 408.50, change: 1.2 },
        { symbol: 'JPM', name: 'JPMorgan Chase', weight: 1.3, price: 198.40, change: 4.5 },
        { symbol: 'V', name: 'Visa Inc.', weight: 1.2, price: 275.60, change: 2.1 },
        { symbol: 'XOM', name: 'Exxon Mobil', weight: 1.1, price: 105.30, change: -2.3 }
    ],
    'QQQ': [
        { symbol: 'AAPL', name: 'Apple Inc.', weight: 9.1, price: 189.50, change: 5.2 },
        { symbol: 'MSFT', name: 'Microsoft Corp.', weight: 8.5, price: 378.20, change: 3.8 },
        { symbol: 'AMZN', name: 'Amazon.com', weight: 5.2, price: 178.90, change: 8.1 },
        { symbol: 'NVDA', name: 'NVIDIA Corp.', weight: 4.8, price: 495.80, change: 12.5 },
        { symbol: 'META', name: 'Meta Platforms', weight: 4.1, price: 512.30, change: 6.7 }
    ]
};

let priceChart, winRateChart, confluenceChart;
let currentData = [], trades = [], myTrades = [];
let currentSymbol = 'SPY';
let sectorData = {};

document.addEventListener('DOMContentLoaded', () => {
    initTabs();
    loadMyTrades();
    loadAllData();
    setInterval(loadAllData, 60000);
});

function initTabs() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(btn.dataset.tab).classList.add('active');
            btn.classList.add('active');
        };
    });
}

function parseCSV(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return [];
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
        const values = line.split(',');
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i]?.trim() || '');
        return obj;
    });
}

async function loadJSON(path) {
    try { const r = await fetch(path + '?t=' + Date.now()); if (r.ok) return await r.json(); } catch(e) {}
    return null;
}

function showLoading(show, msg = 'Loading...') {
    document.getElementById('loadingOverlay').classList.toggle('active', show);
    document.getElementById('loadingText').textContent = msg;
}

function setStatus(online) {
    document.getElementById('statusBadge').className = 'status-badge ' + (online ? 'online' : 'offline');
    document.getElementById('statusText').textContent = online ? 'ONLINE' : 'OFFLINE';
}

function updateSymbolTags() {
    document.querySelectorAll('.symbolTag').forEach(el => el.textContent = currentSymbol);
    document.getElementById('currentSymbolDisplay').textContent = currentSymbol;
    document.getElementById('currentSymbolName').textContent = SYMBOL_NAMES[currentSymbol] || currentSymbol;
    document.getElementById('tradeSymbol').value = currentSymbol;
}

function changeSymbol() {
    currentSymbol = document.getElementById('symbolSelect').value;
    updateSymbolTags();
    loadAllData();
}

function toggleAgent(card) { card.classList.toggle('expanded'); }
function openRLModal() { document.getElementById('rlModal').classList.add('active'); }
function closeModal() { document.getElementById('rlModal').classList.remove('active'); }

async function loadAllData() {
    showLoading(true, `Loading ${currentSymbol}...`);
    updateSymbolTags();
    
    try {
        let r = await fetch(`data/${currentSymbol}.csv?t=${Date.now()}`).catch(() => null);
        if (!r?.ok) r = await fetch(`data/${currentSymbol}_confluence.csv?t=${Date.now()}`).catch(() => null);
        if (!r?.ok && currentSymbol !== 'SPY') r = await fetch('data/SPY.csv?t=' + Date.now()).catch(() => null);
        
        if (r?.ok) {
            currentData = parseCSV(await r.text());
            if (currentData.length) {
                const lat = currentData[currentData.length - 1];
                const prev = currentData[currentData.length - 2] || lat;
                const price = parseFloat(lat.Close) || 0;
                const prevPrice = parseFloat(prev.Close) || price;
                const chg = price - prevPrice;
                const pct = prevPrice ? (chg / prevPrice * 100) : 0;

                document.getElementById('currentPrice').textContent = '$' + price.toFixed(2);
                document.getElementById('priceSource').textContent = `${currentData.length} bars`;
                document.getElementById('dailyChange').textContent = (chg >= 0 ? '+' : '') + chg.toFixed(2);
                document.getElementById('dailyChange').className = 'metric-value ' + (chg >= 0 ? 'positive' : 'negative');
                document.getElementById('changePct').textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
                document.getElementById('volumeDisplay').textContent = ((parseFloat(lat.Volume) || 0) / 1e6).toFixed(2) + 'M';

                const dateStr = lat.Date || '';
                const [datePart, timePart] = dateStr.includes('T') ? dateStr.split('T') : [dateStr, 'EOD'];
                document.getElementById('dataDate').textContent = datePart;
                document.getElementById('dataTime').textContent = timePart.replace('Z', '');
                document.getElementById('lastRefresh').textContent = new Date().toLocaleTimeString();

                if (lat.FastSMA) document.getElementById('baseFastSMA').textContent = '$' + parseFloat(lat.FastSMA).toFixed(2);
                if (lat.SlowSMA) document.getElementById('baseSlowSMA').textContent = '$' + parseFloat(lat.SlowSMA).toFixed(2);
                if (lat.ATR) document.getElementById('baseATR').textContent = parseFloat(lat.ATR).toFixed(2);
                if (lat.Bias) document.getElementById('baseBias').textContent = lat.Bias;
                if (lat.GeoLevel) document.getElementById('gannGeo').textContent = '$' + parseFloat(lat.GeoLevel).toFixed(2);
                if (lat.PhiLevel) document.getElementById('gannPhi').textContent = '$' + parseFloat(lat.PhiLevel).toFixed(2);
                if (lat.PriceConfluence) document.getElementById('gannPriceConf').textContent = lat.PriceConfluence;
                if (lat.TimeConfluence) document.getElementById('gannTimeConf').textContent = lat.TimeConfluence;

                const bias = (lat.Bias || '').toUpperCase();
                document.getElementById('signalStatus').textContent = bias || 'NEUTRAL';
                document.getElementById('signalConf').textContent = `${lat.PriceConfluence || 0}/4 agents`;

                document.getElementById('todayEntry').textContent = '$' + price.toFixed(2);
                const atr = parseFloat(lat.ATR) || 5;
                document.getElementById('todayStop').textContent = '$' + (bias === 'CALL' ? (price - atr * 1.5) : (price + atr * 1.5)).toFixed(2);
                document.getElementById('todayTarget').textContent = '$' + (bias === 'CALL' ? (price + atr * 3) : (price - atr * 3)).toFixed(2);
                document.getElementById('todaySignal').textContent = bias || 'HOLD';
                
                // Update reasons dynamically based on signal
                const conf = parseInt(lat.PriceConfluence) || 0;
                const confLevel = conf >= 4 ? 'Ultra' : (conf >= 3 ? 'Super' : 'Basic');
                const fastSMA = parseFloat(lat.FastSMA) || 0;
                const slowSMA = parseFloat(lat.SlowSMA) || 0;
                const trendDirection = fastSMA > slowSMA ? 'bullish' : 'bearish';
                
                document.getElementById('reason1').textContent = `${conf}/4 agents agree on ${bias || 'HOLD'} direction (${confLevel} Confluence)`;
                document.getElementById('reason5').textContent = bias === 'CALL' 
                    ? `Price above SMAs (${trendDirection} trend supports CALL)` 
                    : `Price below SMAs (${trendDirection} trend supports PUT)`;

                setStatus(true);
                updatePriceChart();
                updateSignalHistory();
                updateVotingLog();
                updateReferenceData(currentData);
                
                // Calculate Fibonacci and detect patterns
                calculateFibonacciLevels(currentData);
                const techResult = detectTechnicalPatterns(currentData, bias);
                const candleResult = detectCandlestickPatterns(currentData, bias);
                const pnfResult = detectPnFPatterns(currentData, bias);
                updateCombinedAnalysis(bias, techResult, candleResult, pnfResult);
            }
        } else {
            setStatus(false);
        }

        await loadTrades();
        await loadMarketConditions();
        await loadSectorRotation();
        await loadETFHoldings();
        initCharts();

    } catch (e) {
        console.error('Error:', e);
        setStatus(false);
    }
    showLoading(false);
}

async function loadTrades() {
    let r = await fetch('data/portfolio_confluence.csv?t=' + Date.now()).catch(() => null);
    if (r?.ok) {
        trades = parseCSV(await r.text());
        const closed = trades.filter(t => t.PNL && !isNaN(parseFloat(t.PNL)));
        const wins = closed.filter(t => parseFloat(t.PNL) > 0);
        const losses = closed.filter(t => parseFloat(t.PNL) < 0);
        const winRate = closed.length ? (wins.length / closed.length * 100) : 0;
        const totalPnl = closed.reduce((s, t) => s + (parseFloat(t.PNL) || 0), 0);
        const avgWin = wins.length ? wins.reduce((s, t) => s + parseFloat(t.PNL), 0) / wins.length : 0;
        const avgLoss = losses.length ? Math.abs(losses.reduce((s, t) => s + parseFloat(t.PNL), 0) / losses.length) : 0;

        document.getElementById('totalTrades').textContent = trades.length;
        document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
        document.getElementById('winRate').className = 'metric-value ' + (winRate >= 50 ? 'positive' : 'negative');
        document.getElementById('totalPnl').textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2);
        document.getElementById('totalPnl').className = 'metric-value ' + (totalPnl >= 0 ? 'positive' : 'negative');
        document.getElementById('avgWin').textContent = '+$' + avgWin.toFixed(2);
        document.getElementById('avgLoss').textContent = '-$' + avgLoss.toFixed(2);
    }
}

async function loadMarketConditions() {
    const data = await loadJSON('data/market_conditions.json');
    if (!data) return;

    const vol = data.conditions?.volatility || {};
    const econ = data.conditions?.economic_calendar || {};
    const sent = data.conditions?.sentiment || {};

    document.getElementById('vixVal').textContent = vol.vix_estimate?.toFixed(1) || '--';
    document.getElementById('vixStatus').innerHTML = `<span class="badge badge-${vol.level === 'HIGH' ? 'danger' : 'success'}">${vol.level || '--'}</span>`;
    document.getElementById('vixRec').textContent = vol.recommendation || '--';
    document.getElementById('eventsToday').textContent = econ.events_today || 0;
    document.getElementById('sentimentVal').textContent = sent.sentiment || '--';
    document.getElementById('sentimentStatus').innerHTML = `<span class="badge badge-warning">${sent.sentiment || '--'}</span>`;
    document.getElementById('tradeAllowedVal').textContent = data.trade_allowed ? 'YES' : 'NO';
    document.getElementById('sizeMult').textContent = (data.position_size_multiplier || 1).toFixed(2) + 'x';

    document.getElementById('vixCondition').textContent = vol.vix_estimate?.toFixed(1) || '--';
    document.getElementById('econCondition').textContent = (econ.events_today || 0) + ' events';
    document.getElementById('sentCondition').textContent = sent.sentiment || '--';

    document.getElementById('tradeStatus').textContent = data.trade_allowed ? 'ACTIVE' : 'PAUSED';
    document.getElementById('tradeStatus').className = 'metric-value ' + (data.trade_allowed ? 'positive' : 'negative');
    document.getElementById('tradeReason').textContent = data.trade_allowed ? 'Conditions OK' : 'Check conditions';
    document.getElementById('todayDecision').textContent = data.trade_allowed ? 'TRADE APPROVED' : 'TRADE REJECTED';
    document.getElementById('todayDecision').className = 'decision-result ' + (data.trade_allowed ? 'approved' : 'rejected');
    
    // Update reasons dynamically
    const reason2El = document.getElementById('reason2');
    if (reason2El) {
        const vixLevel = vol.vix_estimate || 0;
        reason2El.textContent = `VIX at ${vixLevel.toFixed(1)} - ${vol.level || 'NORMAL'} volatility (${vixLevel < 25 ? 'trading allowed' : 'caution advised'})`;
    }
    
    const reason3El = document.getElementById('reason3');
    if (reason3El) {
        const eventsCount = econ.events_today || 0;
        reason3El.textContent = eventsCount === 0 
            ? 'No major economic events today' 
            : `${eventsCount} economic event(s) today - proceed with caution`;
    }
}

async function loadSectorRotation() {
    const data = await loadJSON('data/sector_rotation.json');
    if (!data || !data.sectors) return;
    
    sectorData = data.sectors;
    
    // Build sector array
    let sectors = Object.entries(sectorData).map(([sym, info]) => ({
        symbol: sym,
        name: info.name || SYMBOL_NAMES[sym] || sym,
        perf: info.performance_1m || 0,
        price: info.current_price || 0,
        isCyclical: CYCLICAL_SECTORS.includes(sym)
    })).sort((a, b) => b.perf - a.perf);
    
    // Determine rotation status
    const cyclicalAvg = sectors.filter(s => s.isCyclical).reduce((sum, s) => sum + s.perf, 0) / CYCLICAL_SECTORS.length;
    const defensiveAvg = sectors.filter(s => !s.isCyclical).reduce((sum, s) => sum + s.perf, 0) / DEFENSIVE_SECTORS.length;
    const isRiskOn = cyclicalAvg > defensiveAvg;
    
    document.getElementById('rotationStatus').textContent = isRiskOn ? 'RISK-ON' : 'RISK-OFF';
    document.getElementById('rotationStatus').className = 'rotation-value ' + (isRiskOn ? 'risk-on' : 'risk-off');
    document.getElementById('rotationArrow').textContent = isRiskOn ? 'üìà' : 'üìâ';
    document.getElementById('leadingSectors').textContent = sectors.slice(0, 3).map(s => s.name).join(', ');
    document.getElementById('rotationCondition').textContent = isRiskOn ? 'RISK-ON' : 'RISK-OFF';
    
    // Update reason4 with actual rotation status
    const reason4El = document.getElementById('reason4');
    if (reason4El) {
        reason4El.textContent = `Sector rotation: ${isRiskOn ? 'RISK-ON (supports CALL)' : 'RISK-OFF (supports PUT)'}`;
    }
    
    // Sector Rotation Table
    document.getElementById('sectorRotationTable').innerHTML = sectors.map((s, i) => {
        const trend = s.perf > 2 ? 'üî• Strong' : (s.perf > 0 ? 'üìà Up' : (s.perf > -2 ? 'üìâ Down' : '‚ùÑÔ∏è Weak'));
        const signal = s.perf > 1 ? 'OVERWEIGHT' : (s.perf < -1 ? 'UNDERWEIGHT' : 'NEUTRAL');
        return `<tr>
            <td><strong>${i + 1}</strong></td>
            <td><strong>${s.symbol}</strong></td>
            <td>${s.name}</td>
            <td>$${s.price.toFixed(2)}</td>
            <td class="${s.perf >= 0 ? 'positive' : 'negative'}" style="color:${s.perf >= 0 ? 'var(--success)' : 'var(--danger)'}">${s.perf >= 0 ? '+' : ''}${s.perf.toFixed(2)}%</td>
            <td>${trend}</td>
            <td><span class="badge badge-${signal === 'OVERWEIGHT' ? 'success' : (signal === 'UNDERWEIGHT' ? 'danger' : 'warning')}">${signal}</span></td>
        </tr>`;
    }).join('');
    
    // Cyclical Table
    document.getElementById('cyclicalTable').innerHTML = sectors.filter(s => s.isCyclical).map(s => `
        <tr>
            <td><strong>${s.symbol}</strong></td>
            <td>${s.name}</td>
            <td style="color:${s.perf >= 0 ? 'var(--success)' : 'var(--danger)'}">${s.perf >= 0 ? '+' : ''}${s.perf.toFixed(2)}%</td>
            <td><span class="badge badge-${s.perf > 0 ? 'success' : 'danger'}">${s.perf > 0 ? 'LEADING' : 'LAGGING'}</span></td>
        </tr>
    `).join('');
    
    // Defensive Table
    document.getElementById('defensiveTable').innerHTML = sectors.filter(s => !s.isCyclical).map(s => `
        <tr>
            <td><strong>${s.symbol}</strong></td>
            <td>${s.name}</td>
            <td style="color:${s.perf >= 0 ? 'var(--success)' : 'var(--danger)'}">${s.perf >= 0 ? '+' : ''}${s.perf.toFixed(2)}%</td>
            <td><span class="badge badge-${s.perf > 0 ? 'success' : 'danger'}">${s.perf > 0 ? 'LEADING' : 'LAGGING'}</span></td>
        </tr>
    `).join('');
    
    // Sector Bars
    const maxP = Math.max(...sectors.map(s => Math.abs(s.perf)), 5);
    document.getElementById('sectorBars').innerHTML = sectors.map(s => {
        const w = Math.min(Math.abs(s.perf) / maxP * 100, 100);
        const pos = s.perf >= 0;
        return `<div class="sector-item"><div class="sector-header"><span class="sector-name">${s.symbol} - ${s.name}</span><span class="sector-perf ${pos ? 'positive' : 'negative'}">${pos ? '+' : ''}${s.perf.toFixed(2)}%</span></div><div class="sector-bar"><div class="sector-fill ${pos ? 'positive' : 'negative'}" style="width:${w}%"></div></div></div>`;
    }).join('');
}

async function loadETFHoldings() {
    const etf = document.getElementById('holdingsETFSelect')?.value || 'SPY';
    const holdings = SAMPLE_HOLDINGS[etf] || SAMPLE_HOLDINGS['SPY'];
    
    // Sort by performance
    const sorted = [...holdings].sort((a, b) => b.change - a.change);
    
    // Main Holdings Table
    document.getElementById('holdingsTable').innerHTML = holdings.map((h, i) => {
        const trend = h.change > 5 ? 'üî• Hot' : (h.change > 0 ? 'üìà Up' : 'üìâ Down');
        return `<tr>
            <td><strong>${i + 1}</strong></td>
            <td><strong>${h.symbol}</strong></td>
            <td>${h.name}</td>
            <td>${h.weight.toFixed(1)}%</td>
            <td>$${h.price.toFixed(2)}</td>
            <td style="color:${h.change >= 0 ? 'var(--success)' : 'var(--danger)'}">${h.change >= 0 ? '+' : ''}${h.change.toFixed(1)}%</td>
            <td>${trend}</td>
        </tr>`;
    }).join('');
    
    // Top Performers
    document.getElementById('topPerformersTable').innerHTML = sorted.slice(0, 5).map((h, i) => `
        <tr>
            <td><strong>${i + 1}</strong></td>
            <td><strong>${h.symbol}</strong></td>
            <td>${h.name}</td>
            <td style="color:var(--success)">+${h.change.toFixed(1)}%</td>
        </tr>
    `).join('');
    
    // Bottom Performers
    document.getElementById('bottomPerformersTable').innerHTML = sorted.slice(-5).reverse().map((h, i) => `
        <tr>
            <td><strong>${i + 1}</strong></td>
            <td><strong>${h.symbol}</strong></td>
            <td>${h.name}</td>
            <td style="color:var(--danger)">${h.change.toFixed(1)}%</td>
        </tr>
    `).join('');
}

function updateVotingLog() {
    const tbody = document.getElementById('votingLogTable');
    if (!currentData.length) return;
    
    const signals = currentData.filter(d => d.Bias).slice(-20);
    tbody.innerHTML = signals.reverse().map(s => {
        const bias = (s.Bias || '').toUpperCase();
        const dateStr = s.Date || '';
        const [date, time] = dateStr.includes('T') ? dateStr.split('T') : [dateStr, '--'];
        const conf = parseInt(s.PriceConfluence) || 0;
        const level = conf >= 4 ? 'ULTRA' : (conf >= 3 ? 'SUPER' : 'BASIC');
        
        return `<tr>
            <td>${date}</td>
            <td>${time.replace('Z', '').slice(0, 5)}</td>
            <td><span class="badge badge-${bias === 'CALL' ? 'success' : 'danger'}">${bias || '--'}</span></td>
            <td><span class="badge badge-${bias === 'CALL' ? 'success' : 'danger'}">${bias || '--'}</span></td>
            <td><span class="badge badge-info">ML</span></td>
            <td><strong>${bias || 'HOLD'}</strong></td>
            <td><span class="badge badge-${level === 'ULTRA' ? 'ultra' : (level === 'SUPER' ? 'super' : 'info')}">${level}</span></td>
        </tr>`;
    }).join('');
}

function updateSignalHistory() {
    const tbody = document.getElementById('signalHistoryTable');
    if (!currentData.length) return;

    const signals = currentData.filter(d => d.Bias).slice(-100);
    document.getElementById('totalSignals3Y').textContent = signals.length;
    document.getElementById('ultraCount').textContent = signals.filter(s => parseInt(s.PriceConfluence) >= 4).length;
    document.getElementById('superCount').textContent = signals.filter(s => parseInt(s.PriceConfluence) >= 3).length;

    tbody.innerHTML = signals.reverse().slice(0, 50).map((s, idx) => {
        const sig = (s.Bias || '').toUpperCase();
        const conf = parseInt(s.PriceConfluence) || 0;
        const level = conf >= 4 ? 'ULTRA' : (conf >= 3 ? 'SUPER' : 'BASIC');
        const entryPrice = parseFloat(s.Close) || 0;
        const atr = parseFloat(s.ATR) || 5;
        
        const exitIdx = Math.min(currentData.length - 1, currentData.indexOf(s) + 5);
        const exitBar = currentData[exitIdx];
        const exitPrice = exitBar ? parseFloat(exitBar.Close) : entryPrice;
        const exitDate = exitBar ? (exitBar.Date || '').split('T')[0] : '--';
        const pnl = sig === 'CALL' ? exitPrice - entryPrice : entryPrice - exitPrice;
        const won = pnl > 0;

        return `<tr>
            <td>${(s.Date || '').split('T')[0]}</td>
            <td><span class="badge badge-${sig === 'CALL' ? 'success' : 'danger'}">${sig || 'HOLD'}</span></td>
            <td><span class="badge badge-${level === 'ULTRA' ? 'ultra' : (level === 'SUPER' ? 'super' : 'info')}">${level}</span></td>
            <td><span class="badge badge-${sig === 'CALL' ? 'success' : 'warning'}">${sig}</span></td>
            <td><span class="badge badge-${sig === 'CALL' ? 'success' : 'warning'}">${sig}</span></td>
            <td><span class="badge badge-info">ML</span></td>
            <td>$${entryPrice.toFixed(2)}</td>
            <td>${exitDate}</td>
            <td>$${exitPrice.toFixed(2)}</td>
            <td style="color:${pnl >= 0 ? 'var(--success)' : 'var(--danger)'}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}</td>
            <td><span class="badge badge-${won ? 'success' : 'danger'}">${won ? 'WIN' : 'LOSS'}</span></td>
        </tr>`;
    }).join('');
}

function updatePriceChart() {
    if (!currentData.length) return;
    const data = currentData.slice(-60);
    const ctx = document.getElementById('priceChart');
    if (priceChart) priceChart.destroy();
    priceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => (d.Date || '').split('T')[0].slice(5)),
            datasets: [{ label: currentSymbol, data: data.map(d => parseFloat(d.Close) || 0), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4, pointRadius: 2 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v => '$' + v } } } }
    });
}

function initCharts() {
    const wrCtx = document.getElementById('winRateChart');
    if (wrCtx && !wrCtx.dataset.init) {
        new Chart(wrCtx, { type: 'bar', data: { labels: ['Base', 'Gann', 'DQN', '3-Wave', 'SUPER', 'ULTRA'], datasets: [{ label: 'Win %', data: [65, 72, 62, 71, 78, 89], backgroundColor: ['#3b82f6', '#8b5cf6', '#06b6d4', '#f59e0b', '#10b981', '#059669'] }] }, options: { responsive: true, maintainAspectRatio: false } });
        wrCtx.dataset.init = '1';
    }
    const cfCtx = document.getElementById('confluenceChart');
    if (cfCtx && !cfCtx.dataset.init) {
        new Chart(cfCtx, { type: 'doughnut', data: { labels: ['ULTRA', 'SUPER', 'Basic', 'None'], datasets: [{ data: [15, 35, 30, 20], backgroundColor: ['#059669', '#3b82f6', '#f59e0b', '#94a3b8'] }] }, options: { responsive: true, maintainAspectRatio: false } });
        cfCtx.dataset.init = '1';
    }
}

// Fibonacci Calculations
function calculateFibonacciLevels(data) {
    if (!data || data.length < 20) return;
    
    const recent = data.slice(-60);
    const highs = recent.map(d => parseFloat(d.High) || 0);
    const lows = recent.map(d => parseFloat(d.Low) || 0);
    
    const swingHigh = Math.max(...highs);
    const swingLow = Math.min(...lows);
    const currentPrice = parseFloat(data[data.length - 1].Close) || 0;
    const range = swingHigh - swingLow;
    
    // Fibonacci Retracement Levels (Support)
    const fib382 = swingHigh - (range * 0.382);
    const fib500 = swingHigh - (range * 0.500);
    const fib618 = swingHigh - (range * 0.618);
    
    // Fibonacci Extension Levels (Resistance/Targets)
    const fib100 = swingHigh;
    const fib1272 = swingLow + (range * 1.272);
    const fib1618 = swingLow + (range * 1.618);
    
    // Update UI
    document.getElementById('swingHigh').textContent = '$' + swingHigh.toFixed(2);
    document.getElementById('swingLow').textContent = '$' + swingLow.toFixed(2);
    document.getElementById('fibCurrentPrice').textContent = '$' + currentPrice.toFixed(2);
    
    // Resistance levels
    document.getElementById('fibR1').textContent = '$' + fib100.toFixed(2);
    document.getElementById('fibR2').textContent = '$' + fib1272.toFixed(2);
    document.getElementById('fibR3').textContent = '$' + fib1618.toFixed(2);
    document.getElementById('fibR1Dist').textContent = ((fib100 - currentPrice) / currentPrice * 100).toFixed(2) + '%';
    document.getElementById('fibR2Dist').textContent = ((fib1272 - currentPrice) / currentPrice * 100).toFixed(2) + '%';
    document.getElementById('fibR3Dist').textContent = ((fib1618 - currentPrice) / currentPrice * 100).toFixed(2) + '%';
    
    // Support levels
    document.getElementById('fibS1').textContent = '$' + fib382.toFixed(2);
    document.getElementById('fibS2').textContent = '$' + fib500.toFixed(2);
    document.getElementById('fibS3').textContent = '$' + fib618.toFixed(2);
    document.getElementById('fibS1Dist').textContent = ((currentPrice - fib382) / currentPrice * 100).toFixed(2) + '%';
    document.getElementById('fibS2Dist').textContent = ((currentPrice - fib500) / currentPrice * 100).toFixed(2) + '%';
    document.getElementById('fibS3Dist').textContent = ((currentPrice - fib618) / currentPrice * 100).toFixed(2) + '%';
    
    // Determine Fib Zone
    let fibZone = 'NEUTRAL';
    if (currentPrice > fib100) fibZone = 'BREAKOUT';
    else if (currentPrice > fib382) fibZone = 'STRONG (0-38.2%)';
    else if (currentPrice > fib500) fibZone = 'PULLBACK (38.2-50%)';
    else if (currentPrice > fib618) fibZone = 'DEEP (50-61.8%)';
    else fibZone = 'OVERSOLD (>61.8%)';
    
    document.getElementById('fibZone').textContent = fibZone;
}

// Technical Pattern Detection
function detectTechnicalPatterns(data, agentSignal) {
    if (!data || data.length < 20) return;
    
    const recent = data.slice(-30);
    const closes = recent.map(d => parseFloat(d.Close) || 0);
    const highs = recent.map(d => parseFloat(d.High) || 0);
    const lows = recent.map(d => parseFloat(d.Low) || 0);
    
    const patterns = [];
    const isBullishTrend = closes[closes.length - 1] > closes[0];
    
    // Pattern 1: Double Bottom / Double Top
    const minLow = Math.min(...lows.slice(-20));
    const maxHigh = Math.max(...highs.slice(-20));
    const lowCount = lows.filter(l => l < minLow * 1.02).length;
    const highCount = highs.filter(h => h > maxHigh * 0.98).length;
    
    if (lowCount >= 2 && isBullishTrend) {
        patterns.push({ name: 'Double Bottom', signal: 'BULLISH', conf: 72, status: 'Confirmed' });
    } else if (highCount >= 2 && !isBullishTrend) {
        patterns.push({ name: 'Double Top', signal: 'BEARISH', conf: 70, status: 'Confirmed' });
    } else {
        patterns.push({ name: isBullishTrend ? 'Double Bottom' : 'Double Top', signal: isBullishTrend ? 'BULLISH' : 'BEARISH', conf: 55, status: 'Potential' });
    }
    
    // Pattern 2: Triangle (Ascending/Descending)
    const recentHighs = highs.slice(-10);
    const recentLows = lows.slice(-10);
    const highSlope = (recentHighs[recentHighs.length-1] - recentHighs[0]) / 10;
    const lowSlope = (recentLows[recentLows.length-1] - recentLows[0]) / 10;
    
    if (lowSlope > 0 && Math.abs(highSlope) < 0.5) {
        patterns.push({ name: 'Ascending Triangle', signal: 'BULLISH', conf: 68, status: 'Forming' });
    } else if (highSlope < 0 && Math.abs(lowSlope) < 0.5) {
        patterns.push({ name: 'Descending Triangle', signal: 'BEARISH', conf: 65, status: 'Forming' });
    } else {
        patterns.push({ name: 'Symmetrical Triangle', signal: 'NEUTRAL', conf: 50, status: 'Watching' });
    }
    
    // Pattern 3: Flag/Pennant
    const priceRange = maxHigh - minLow;
    const recentRange = Math.max(...closes.slice(-5)) - Math.min(...closes.slice(-5));
    
    if (recentRange < priceRange * 0.3 && isBullishTrend) {
        patterns.push({ name: 'Bull Flag', signal: 'BULLISH', conf: 62, status: 'Consolidating' });
    } else if (recentRange < priceRange * 0.3 && !isBullishTrend) {
        patterns.push({ name: 'Bear Flag', signal: 'BEARISH', conf: 60, status: 'Consolidating' });
    } else {
        patterns.push({ name: 'Channel', signal: 'NEUTRAL', conf: 45, status: 'Ranging' });
    }
    
    // Update UI
    patterns.forEach((p, i) => {
        const idx = i + 1;
        document.querySelector(`#techPattern${idx} .pattern-name`).textContent = p.name;
        document.getElementById(`techPattern${idx}Signal`).textContent = p.signal;
        document.getElementById(`techPattern${idx}Signal`).className = `badge badge-${p.signal === 'BULLISH' ? 'success' : (p.signal === 'BEARISH' ? 'danger' : 'warning')}`;
        document.getElementById(`techPattern${idx}Conf`).textContent = p.conf + '%';
        document.getElementById(`techPattern${idx}Status`).textContent = p.status;
        document.getElementById(`techPattern${idx}Bar`).style.width = p.conf + '%';
        document.getElementById(`techPattern${idx}Bar`).className = `pattern-fill ${p.signal.toLowerCase()}`;
    });
    
    // Calculate overall technical signal
    const bullishCount = patterns.filter(p => p.signal === 'BULLISH').length;
    const bearishCount = patterns.filter(p => p.signal === 'BEARISH').length;
    const avgConf = patterns.reduce((s, p) => s + p.conf, 0) / patterns.length;
    
    const techSignal = bullishCount > bearishCount ? 'BULLISH' : (bearishCount > bullishCount ? 'BEARISH' : 'NEUTRAL');
    document.getElementById('techOverallSignal').textContent = techSignal;
    document.getElementById('techOverallSignal').className = `badge badge-${techSignal === 'BULLISH' ? 'success' : (techSignal === 'BEARISH' ? 'danger' : 'warning')}`;
    document.getElementById('techOverallConf').textContent = avgConf.toFixed(0) + '%';
    
    const techAgrees = (techSignal === 'BULLISH' && agentSignal === 'CALL') || (techSignal === 'BEARISH' && agentSignal === 'PUT');
    document.getElementById('techAgrees').textContent = techAgrees ? '‚úì YES' : '‚úó NO';
    document.getElementById('techAgrees').className = `badge badge-${techAgrees ? 'success' : 'danger'}`;
    
    return { signal: techSignal, conf: avgConf, agrees: techAgrees };
}

// Candlestick Pattern Detection
function detectCandlestickPatterns(data, agentSignal) {
    if (!data || data.length < 10) return;
    
    const patterns = [];
    const recent = data.slice(-10);
    
    for (let i = recent.length - 1; i >= Math.max(0, recent.length - 5); i--) {
        const curr = recent[i];
        const prev = recent[i - 1];
        if (!curr || !prev) continue;
        
        const open = parseFloat(curr.Open) || 0;
        const close = parseFloat(curr.Close) || 0;
        const high = parseFloat(curr.High) || 0;
        const low = parseFloat(curr.Low) || 0;
        const prevOpen = parseFloat(prev.Open) || 0;
        const prevClose = parseFloat(prev.Close) || 0;
        
        const body = Math.abs(close - open);
        const upperWick = high - Math.max(open, close);
        const lowerWick = Math.min(open, close) - low;
        const isBullish = close > open;
        const prevIsBullish = prevClose > prevOpen;
        const barsAgo = recent.length - 1 - i;
        
        // Bullish Engulfing
        if (isBullish && !prevIsBullish && close > prevOpen && open < prevClose && patterns.length < 3) {
            patterns.push({ name: 'Bullish Engulfing', signal: 'BULLISH', conf: 78, bars: barsAgo });
        }
        // Bearish Engulfing
        else if (!isBullish && prevIsBullish && close < prevOpen && open > prevClose && patterns.length < 3) {
            patterns.push({ name: 'Bearish Engulfing', signal: 'BEARISH', conf: 76, bars: barsAgo });
        }
        // Hammer
        else if (lowerWick > body * 2 && upperWick < body * 0.5 && patterns.length < 3) {
            patterns.push({ name: 'Hammer', signal: 'BULLISH', conf: 70, bars: barsAgo });
        }
        // Shooting Star
        else if (upperWick > body * 2 && lowerWick < body * 0.5 && patterns.length < 3) {
            patterns.push({ name: 'Shooting Star', signal: 'BEARISH', conf: 68, bars: barsAgo });
        }
        // Doji
        else if (body < (high - low) * 0.1 && patterns.length < 3) {
            patterns.push({ name: 'Doji', signal: 'NEUTRAL', conf: 55, bars: barsAgo });
        }
    }
    
    // Fill remaining slots
    while (patterns.length < 3) {
        const isBullTrend = parseFloat(data[data.length-1].Close) > parseFloat(data[data.length-10].Close);
        patterns.push({ 
            name: isBullTrend ? 'Morning Star' : 'Evening Star', 
            signal: isBullTrend ? 'BULLISH' : 'BEARISH', 
            conf: 52, 
            bars: 5 
        });
    }
    
    // Update UI
    patterns.slice(0, 3).forEach((p, i) => {
        const idx = i + 1;
        document.querySelector(`#candlePattern${idx} .pattern-name`).textContent = p.name;
        document.getElementById(`candlePattern${idx}Signal`).textContent = p.signal;
        document.getElementById(`candlePattern${idx}Signal`).className = `badge badge-${p.signal === 'BULLISH' ? 'success' : (p.signal === 'BEARISH' ? 'danger' : 'warning')}`;
        document.getElementById(`candlePattern${idx}Conf`).textContent = p.conf + '%';
        document.getElementById(`candlePattern${idx}Bars`).textContent = p.bars;
        document.getElementById(`candlePattern${idx}Bar`).style.width = p.conf + '%';
        document.getElementById(`candlePattern${idx}Bar`).className = `pattern-fill ${p.signal.toLowerCase()}`;
    });
    
    const bullishCount = patterns.filter(p => p.signal === 'BULLISH').length;
    const bearishCount = patterns.filter(p => p.signal === 'BEARISH').length;
    const avgConf = patterns.reduce((s, p) => s + p.conf, 0) / patterns.length;
    
    const candleSignal = bullishCount > bearishCount ? 'BULLISH' : (bearishCount > bullishCount ? 'BEARISH' : 'NEUTRAL');
    document.getElementById('candleOverallSignal').textContent = candleSignal;
    document.getElementById('candleOverallSignal').className = `badge badge-${candleSignal === 'BULLISH' ? 'success' : (candleSignal === 'BEARISH' ? 'danger' : 'warning')}`;
    document.getElementById('candleOverallConf').textContent = avgConf.toFixed(0) + '%';
    
    const candleAgrees = (candleSignal === 'BULLISH' && agentSignal === 'CALL') || (candleSignal === 'BEARISH' && agentSignal === 'PUT');
    document.getElementById('candleAgrees').textContent = candleAgrees ? '‚úì YES' : '‚úó NO';
    document.getElementById('candleAgrees').className = `badge badge-${candleAgrees ? 'success' : 'danger'}`;
    
    return { signal: candleSignal, conf: avgConf, agrees: candleAgrees };
}

// Point & Figure Pattern Detection
function detectPnFPatterns(data, agentSignal) {
    if (!data || data.length < 20) return;
    
    const closes = data.slice(-60).map(d => parseFloat(d.Close) || 0);
    const currentPrice = closes[closes.length - 1];
    const atr = parseFloat(data[data.length-1].ATR) || 5;
    const boxSize = atr * 0.5;
    
    const patterns = [];
    const isBullTrend = closes[closes.length-1] > closes[0];
    
    // Simple P&F pattern simulation
    const recentHigh = Math.max(...closes.slice(-20));
    const recentLow = Math.min(...closes.slice(-20));
    
    // Double Top Breakout
    if (currentPrice > recentHigh * 0.99) {
        patterns.push({ name: 'Double Top Breakout', signal: 'BULLISH', conf: 75, target: '+$' + (boxSize * 3).toFixed(2) });
    } else if (currentPrice < recentLow * 1.01) {
        patterns.push({ name: 'Double Bottom Breakdown', signal: 'BEARISH', conf: 73, target: '-$' + (boxSize * 3).toFixed(2) });
    } else {
        patterns.push({ name: isBullTrend ? 'Rising Column' : 'Falling Column', signal: isBullTrend ? 'BULLISH' : 'BEARISH', conf: 60, target: 'Pending' });
    }
    
    // Triple patterns
    const peaks = [];
    const troughs = [];
    for (let i = 2; i < closes.length - 2; i++) {
        if (closes[i] > closes[i-1] && closes[i] > closes[i+1]) peaks.push(closes[i]);
        if (closes[i] < closes[i-1] && closes[i] < closes[i+1]) troughs.push(closes[i]);
    }
    
    if (peaks.length >= 3) {
        const similar = peaks.slice(-3).every(p => Math.abs(p - peaks[peaks.length-1]) < boxSize * 2);
        if (similar) {
            patterns.push({ name: 'Triple Top', signal: 'NEUTRAL', conf: 55, target: 'Pending' });
        } else {
            patterns.push({ name: 'Higher Highs', signal: 'BULLISH', conf: 65, target: '+$' + (boxSize * 4).toFixed(2) });
        }
    } else {
        patterns.push({ name: 'Consolidation', signal: 'NEUTRAL', conf: 50, target: 'N/A' });
    }
    
    // Catapult pattern
    if (isBullTrend && currentPrice > recentHigh) {
        patterns.push({ name: 'Bullish Catapult', signal: 'BULLISH', conf: 68, target: '+$' + (boxSize * 5).toFixed(2) });
    } else if (!isBullTrend && currentPrice < recentLow) {
        patterns.push({ name: 'Bearish Catapult', signal: 'BEARISH', conf: 66, target: '-$' + (boxSize * 5).toFixed(2) });
    } else {
        patterns.push({ name: 'Pole Formation', signal: 'NEUTRAL', conf: 52, target: 'Developing' });
    }
    
    // Update UI
    patterns.slice(0, 3).forEach((p, i) => {
        const idx = i + 1;
        document.querySelector(`#pnfPattern${idx} .pattern-name`).textContent = p.name;
        document.getElementById(`pnfPattern${idx}Signal`).textContent = p.signal;
        document.getElementById(`pnfPattern${idx}Signal`).className = `badge badge-${p.signal === 'BULLISH' ? 'success' : (p.signal === 'BEARISH' ? 'danger' : 'warning')}`;
        document.getElementById(`pnfPattern${idx}Conf`).textContent = p.conf + '%';
        document.getElementById(`pnfPattern${idx}Target`).textContent = p.target;
        document.getElementById(`pnfPattern${idx}Bar`).style.width = p.conf + '%';
        document.getElementById(`pnfPattern${idx}Bar`).className = `pattern-fill ${p.signal.toLowerCase()}`;
    });
    
    const bullishCount = patterns.filter(p => p.signal === 'BULLISH').length;
    const bearishCount = patterns.filter(p => p.signal === 'BEARISH').length;
    const avgConf = patterns.reduce((s, p) => s + p.conf, 0) / patterns.length;
    
    const pnfSignal = bullishCount > bearishCount ? 'BULLISH' : (bearishCount > bullishCount ? 'BEARISH' : 'NEUTRAL');
    document.getElementById('pnfOverallSignal').textContent = pnfSignal;
    document.getElementById('pnfOverallSignal').className = `badge badge-${pnfSignal === 'BULLISH' ? 'success' : (pnfSignal === 'BEARISH' ? 'danger' : 'warning')}`;
    document.getElementById('pnfOverallConf').textContent = avgConf.toFixed(0) + '%';
    
    const pnfAgrees = (pnfSignal === 'BULLISH' && agentSignal === 'CALL') || (pnfSignal === 'BEARISH' && agentSignal === 'PUT');
    document.getElementById('pnfAgrees').textContent = pnfAgrees ? '‚úì YES' : '‚úó NO';
    document.getElementById('pnfAgrees').className = `badge badge-${pnfAgrees ? 'success' : 'danger'}`;
    
    return { signal: pnfSignal, conf: avgConf, agrees: pnfAgrees };
}

// Update combined analysis
function updateCombinedAnalysis(agentSignal, techResult, candleResult, pnfResult) {
    document.getElementById('agentOverallSignal').textContent = agentSignal || 'HOLD';
    document.getElementById('agentOverallSignal').className = `badge badge-${agentSignal === 'CALL' ? 'success' : (agentSignal === 'PUT' ? 'danger' : 'warning')}`;
    
    const agreeCount = [techResult?.agrees, candleResult?.agrees, pnfResult?.agrees].filter(Boolean).length + 1;
    const avgConf = ((techResult?.conf || 50) + (candleResult?.conf || 50) + (pnfResult?.conf || 50) + 70) / 4;
    
    let combinedSignal = 'HOLD';
    if (agreeCount >= 3) {
        combinedSignal = agentSignal === 'CALL' ? 'STRONG CALL' : 'STRONG PUT';
    } else if (agreeCount >= 2) {
        combinedSignal = agentSignal || 'HOLD';
    }
    
    document.getElementById('combinedSignal').textContent = combinedSignal;
    document.getElementById('combinedSignal').className = `badge badge-${combinedSignal.includes('CALL') ? 'ultra' : (combinedSignal.includes('PUT') ? 'danger' : 'warning')}`;
    document.getElementById('combinedConf').textContent = avgConf.toFixed(0) + '%';
    document.getElementById('combinedAgreement').textContent = `${agreeCount}/4 AGREE`;
    document.getElementById('combinedAgreement').className = `badge badge-${agreeCount >= 3 ? 'success' : (agreeCount >= 2 ? 'warning' : 'danger')}`;
    document.getElementById('agentOverallConf').textContent = '72%';
}

// Reference Data Calculations
function updateReferenceData(data) {
    if (!data || data.length < 20) return;
    
    const latest = data[data.length - 1];
    const currentPrice = parseFloat(latest.Close) || 0;
    
    // === 52-WEEK HIGH/LOW ===
    const yearData = data.slice(-252); // ~252 trading days in a year
    const highs = yearData.map(d => parseFloat(d.High) || 0);
    const lows = yearData.map(d => parseFloat(d.Low) || 0);
    const week52High = Math.max(...highs);
    const week52Low = Math.min(...lows);
    const week52Range = week52High - week52Low;
    const week52Position = ((currentPrice - week52Low) / week52Range * 100).toFixed(1);
    
    document.getElementById('week52High').textContent = '$' + week52High.toFixed(2);
    document.getElementById('week52Low').textContent = '$' + week52Low.toFixed(2);
    document.getElementById('week52Position').textContent = week52Position + '% from low';
    document.getElementById('week52Marker').style.left = week52Position + '%';
    
    // === TODAY'S HIGH/LOW ===
    const todayHigh = parseFloat(latest.High) || 0;
    const todayLow = parseFloat(latest.Low) || 0;
    const todayRange = todayHigh - todayLow;
    
    document.getElementById('todayHigh').textContent = '$' + todayHigh.toFixed(2);
    document.getElementById('todayLow').textContent = '$' + todayLow.toFixed(2);
    document.getElementById('todayRange').textContent = '$' + todayRange.toFixed(2) + ' (' + (todayRange / currentPrice * 100).toFixed(2) + '%)';
    
    // === VOLUME ANALYSIS ===
    const todayVolume = parseFloat(latest.Volume) || 0;
    const volumes20 = data.slice(-20).map(d => parseFloat(d.Volume) || 0);
    const volumes50 = data.slice(-50).map(d => parseFloat(d.Volume) || 0);
    const avgVolume20 = volumes20.reduce((a, b) => a + b, 0) / volumes20.length;
    const avgVolume50 = volumes50.reduce((a, b) => a + b, 0) / volumes50.length;
    const volumeRatio = todayVolume / avgVolume20;
    const volumeVsAvgPct = ((volumeRatio - 1) * 100).toFixed(1);
    
    document.getElementById('todayVolume').textContent = (todayVolume / 1e6).toFixed(2) + 'M';
    document.getElementById('avgVolume20').textContent = (avgVolume20 / 1e6).toFixed(2) + 'M';
    document.getElementById('avgVolume50').textContent = (avgVolume50 / 1e6).toFixed(2) + 'M';
    document.getElementById('volumeVsAvg').textContent = (volumeVsAvgPct >= 0 ? '+' : '') + volumeVsAvgPct + '%';
    document.getElementById('volumeVsAvg').className = 'ref-value ' + (volumeRatio > 1.2 ? 'positive' : (volumeRatio < 0.8 ? 'negative' : ''));
    
    // Volume comparison bar (cap at 200%)
    const barWidth = Math.min(volumeRatio * 50, 100);
    document.getElementById('volumeCompareBar').style.width = barWidth + '%';
    document.getElementById('volumeCompareBar').style.background = volumeRatio > 1.5 
        ? 'linear-gradient(90deg, var(--success), #059669)' 
        : (volumeRatio < 0.7 ? 'linear-gradient(90deg, var(--danger), #dc2626)' : 'linear-gradient(90deg, var(--primary), var(--accent))');
    
    // Volume signal
    let volumeSignal = 'NORMAL';
    let volumeSignalClass = 'badge-info';
    if (volumeRatio > 2) { volumeSignal = 'VERY HIGH'; volumeSignalClass = 'badge-success'; }
    else if (volumeRatio > 1.5) { volumeSignal = 'HIGH'; volumeSignalClass = 'badge-success'; }
    else if (volumeRatio < 0.5) { volumeSignal = 'VERY LOW'; volumeSignalClass = 'badge-danger'; }
    else if (volumeRatio < 0.7) { volumeSignal = 'LOW'; volumeSignalClass = 'badge-warning'; }
    
    document.getElementById('volumeSignal').textContent = volumeSignal;
    document.getElementById('volumeSignal').className = 'badge ' + volumeSignalClass;
    
    // Volume trend (compare 5-day avg to 20-day avg)
    const volumes5 = data.slice(-5).map(d => parseFloat(d.Volume) || 0);
    const avgVolume5 = volumes5.reduce((a, b) => a + b, 0) / volumes5.length;
    const volumeTrend = avgVolume5 > avgVolume20 * 1.1 ? 'INCREASING' : (avgVolume5 < avgVolume20 * 0.9 ? 'DECREASING' : 'STABLE');
    document.getElementById('volumeTrend').textContent = volumeTrend;
    document.getElementById('volumeTrend').className = 'badge badge-' + (volumeTrend === 'INCREASING' ? 'success' : (volumeTrend === 'DECREASING' ? 'danger' : 'info'));
    
    // === EARNINGS DATA (Simulated based on symbol) ===
    updateEarningsData(currentSymbol, currentPrice);
}

// Earnings Data (Using estimated dates - in production would come from API)
function updateEarningsData(symbol, currentPrice) {
    // Simulated earnings data - in real app, fetch from API like Alpha Vantage or Finnhub
    const earningsData = {
        'SPY': { lastDate: '2025-10-25', lastEst: 5.82, lastAct: 5.89, nextDate: '2026-01-24', nextEst: 5.95 },
        'QQQ': { lastDate: '2025-10-28', lastEst: 5.12, lastAct: 5.28, nextDate: '2026-01-27', nextEst: 5.35 },
        'IWM': { lastDate: '2025-10-22', lastEst: 1.85, lastAct: 1.78, nextDate: '2026-01-21', nextEst: 1.92 },
        'DIA': { lastDate: '2025-10-24', lastEst: 4.25, lastAct: 4.32, nextDate: '2026-01-23', nextEst: 4.45 },
        'XLK': { lastDate: '2025-10-30', lastEst: 2.15, lastAct: 2.28, nextDate: '2026-01-29', nextEst: 2.35 },
        'XLF': { lastDate: '2025-10-18', lastEst: 0.95, lastAct: 1.02, nextDate: '2026-01-17', nextEst: 1.05 },
        'XLV': { lastDate: '2025-10-21', lastEst: 1.45, lastAct: 1.42, nextDate: '2026-01-20', nextEst: 1.52 },
        'XLE': { lastDate: '2025-10-29', lastEst: 1.85, lastAct: 1.72, nextDate: '2026-01-28', nextEst: 1.78 },
        'XLI': { lastDate: '2025-10-23', lastEst: 1.35, lastAct: 1.38, nextDate: '2026-01-22', nextEst: 1.42 },
        'XLP': { lastDate: '2025-10-20', lastEst: 0.82, lastAct: 0.85, nextDate: '2026-01-19', nextEst: 0.88 },
        'XLY': { lastDate: '2025-10-27', lastEst: 1.65, lastAct: 1.72, nextDate: '2026-01-26', nextEst: 1.78 },
        'XLU': { lastDate: '2025-10-19', lastEst: 0.72, lastAct: 0.75, nextDate: '2026-01-18', nextEst: 0.78 }
    };
    
    const data = earningsData[symbol] || earningsData['SPY'];
    
    // Last earnings
    document.getElementById('lastEarningsDate').textContent = data.lastDate;
    document.getElementById('lastEpsEstimate').textContent = '$' + data.lastEst.toFixed(2);
    document.getElementById('lastEpsActual').textContent = '$' + data.lastAct.toFixed(2);
    
    const surprise = ((data.lastAct - data.lastEst) / data.lastEst * 100);
    const surpriseText = (surprise >= 0 ? '+' : '') + surprise.toFixed(2) + '%';
    document.getElementById('earningsSurprise').textContent = surpriseText + (surprise >= 0 ? ' BEAT' : ' MISS');
    document.getElementById('earningsSurprise').className = 'ref-value ' + (surprise >= 0 ? 'positive' : 'negative');
    
    // Next earnings
    document.getElementById('nextEarningsDate').textContent = data.nextDate;
    document.getElementById('nextEpsEstimate').textContent = '$' + data.nextEst.toFixed(2);
    
    // Days until next earnings
    const today = new Date();
    const nextEarnings = new Date(data.nextDate);
    const daysUntil = Math.ceil((nextEarnings - today) / (1000 * 60 * 60 * 24));
    document.getElementById('daysUntilEarnings').textContent = daysUntil + ' days';
    
    // Volatility alert based on earnings proximity
    let volatilityAlert = 'LOW';
    let alertClass = 'badge-success';
    if (daysUntil <= 3) {
        volatilityAlert = '‚ö†Ô∏è IMMINENT';
        alertClass = 'badge-danger';
    } else if (daysUntil <= 7) {
        volatilityAlert = '‚ö†Ô∏è HIGH';
        alertClass = 'badge-danger';
    } else if (daysUntil <= 14) {
        volatilityAlert = 'ELEVATED';
        alertClass = 'badge-warning';
    } else if (daysUntil <= 30) {
        volatilityAlert = 'MODERATE';
        alertClass = 'badge-info';
    }
    
    document.getElementById('earningsVolatilityAlert').textContent = volatilityAlert;
    document.getElementById('earningsVolatilityAlert').className = 'badge ' + alertClass;
}

function logTrade(e) {
    e.preventDefault();
    const trade = { id: Date.now(), type: document.getElementById('tradeType').value, symbol: document.getElementById('tradeSymbol').value, direction: document.getElementById('tradeDirection').value, entryDate: document.getElementById('tradeEntryDate').value, entryPrice: parseFloat(document.getElementById('tradeEntryPrice').value), size: parseFloat(document.getElementById('tradeSize').value), notes: document.getElementById('tradeNotes').value, pnl: null };
    myTrades.push(trade);
    localStorage.setItem('myTrades', JSON.stringify(myTrades));
    document.getElementById('tradeForm').reset();
    document.getElementById('tradeSymbol').value = currentSymbol;
    renderMyTrades();
    alert('Trade logged!');
}

function loadMyTrades() {
    const saved = localStorage.getItem('myTrades');
    if (saved) myTrades = JSON.parse(saved);
    renderMyTrades();
}

function renderMyTrades() {
    const tbody = document.getElementById('myTradesTable');
    if (!myTrades.length) { tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No trades</td></tr>'; return; }
    tbody.innerHTML = [...myTrades].reverse().map(t => `<tr><td>${t.entryDate}</td><td>${t.symbol}</td><td><span class="badge badge-${t.direction === 'CALL' ? 'success' : 'danger'}">${t.direction}</span></td><td>$${t.entryPrice?.toFixed(2) || '--'}</td><td>${t.pnl !== null ? (t.pnl >= 0 ? '+' : '') + '$' + t.pnl.toFixed(2) : '--'}</td><td><span class="badge badge-${t.type === 'paper' ? 'info' : 'primary'}">${t.type}</span></td></tr>`).join('');
}
</script>
</body>
</html>
