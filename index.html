<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Agent 4 - Professional Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #1e40af;
            --secondary: #7c3aed;
            --accent: #ec4899;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #d97706;
            --info: #0891b2;
            --bg-white: #ffffff;
            --bg-light: #f8fafc;
            --bg-gray: #f3f4f6;
            --border: #e5e7eb;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --text-light: #9ca3af;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-white) 50%, #f0f9ff 100%);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .header {
            background: var(--bg-white);
            border-bottom: 2px solid var(--border);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo { display: flex; align-items: center; gap: 15px; }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
        }

        .logo h1 { font-size: 24px; font-weight: 700; color: var(--text-dark); }
        .logo p { font-size: 12px; color: var(--text-gray); }

        .header-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(22, 163, 74, 0.1);
            border: 1px solid var(--success);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--success);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .symbol-selector { display: flex; gap: 10px; align-items: center; }
        .symbol-selector label { font-size: 13px; font-weight: 600; color: var(--text-dark); }
        .symbol-selector select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-white);
            color: var(--text-dark);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 30px; }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 15px;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-gray);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card {
            background: var(--bg-white);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-size: 16px; font-weight: 700; color: var(--text-dark); }

        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px; }

        @media (max-width: 1200px) { .grid-4, .grid-3 { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; } }

        .stat-card {
            background: var(--bg-white);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .stat-card .label { font-size: 12px; color: var(--text-gray); margin-bottom: 5px; }
        .stat-card .value { font-size: 28px; font-weight: 700; color: var(--text-dark); }
        .stat-card .change { font-size: 12px; margin-top: 5px; }
        .stat-card .change.positive { color: var(--success); }
        .stat-card .change.negative { color: var(--danger); }

        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .badge-success { background: rgba(22, 163, 74, 0.1); color: var(--success); }
        .badge-danger { background: rgba(220, 38, 38, 0.1); color: var(--danger); }
        .badge-warning { background: rgba(217, 119, 6, 0.1); color: var(--warning); }
        .badge-info { background: rgba(8, 145, 178, 0.1); color: var(--info); }
        .badge-primary { background: rgba(30, 64, 175, 0.1); color: var(--primary); }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); font-size: 13px; }
        th { background: var(--bg-gray); font-weight: 600; color: var(--text-dark); }
        tr:hover { background: var(--bg-light); }

        /* MTF Chart Styles */
        .mtf-charts-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        @media (max-width: 1200px) { .mtf-charts-container { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .mtf-charts-container { grid-template-columns: 1fr; } }

        .chart-panel {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
        }

        .chart-title {
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chart-title .label { font-weight: bold; color: var(--text-dark); }
        .chart-title .price { color: #26a69a; font-weight: bold; }
        .chart-title .price.down { color: #ef5350; }
        .chart-box { height: 420px; background: #fff; border-radius: 8px; border: 1px solid #e0e0e0; }

        .mtf-select {
            padding: 5px 10px;
            border-radius: 5px;
            background: white;
            color: #333;
            border: 1px solid #ccc;
            cursor: pointer;
            font-size: 12px;
        }

        .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

        .mtf-legend { display: flex; gap: 15px; margin-top: 10px; font-size: 11px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-color { width: 12px; height: 3px; border-radius: 2px; }

        .signal-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 10px;
        }
        .signal-badge.call { background: #26a69a; color: white; }
        .signal-badge.put { background: #ef5350; color: white; }
        .signal-badge.hold { background: #888; color: white; }

        .fib-levels { margin-top: 10px; font-size: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .fib-level { padding: 3px 6px; border-radius: 3px; text-align: center; }
        .fib-level.support { background: rgba(38, 166, 154, 0.1); color: #26a69a; }
        .fib-level.resistance { background: rgba(239, 83, 80, 0.1); color: #ef5350; }

        .settings-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }
        .settings-btn:hover { background: #4f46e5; }

        .settings-panel {
            display: none;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 11px;
        }
        .settings-panel.show { display: block; }
        .settings-row { display: flex; align-items: center; gap: 10px; margin: 5px 0; flex-wrap: wrap; }
        .settings-row label { display: flex; align-items: center; gap: 4px; cursor: pointer; }

        .pattern-alert { margin-top: 8px; padding: 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }
        .pattern-alert.bullish { background: rgba(38, 166, 154, 0.15); color: #00875a; border-left: 3px solid #26a69a; }
        .pattern-alert.bearish { background: rgba(239, 83, 80, 0.15); color: #c62828; border-left: 3px solid #ef5350; }
        .pattern-alert.neutral { background: rgba(100, 100, 100, 0.1); color: #555; border-left: 3px solid #888; }

        .mtf-summary {
            background: linear-gradient(135deg, #f8fafc, #f0f9ff);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .mtf-summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        @media (max-width: 900px) { .mtf-summary-grid { grid-template-columns: repeat(2, 1fr); } }

        .mtf-summary-item { text-align: center; padding: 10px; }
        .mtf-summary-item .title { font-size: 12px; color: var(--text-gray); margin-bottom: 5px; }
        .mtf-summary-item .value { font-size: 20px; font-weight: 700; }
        .mtf-summary-item .value.bullish { color: var(--success); }
        .mtf-summary-item .value.bearish { color: var(--danger); }
        .mtf-summary-item .value.neutral { color: var(--text-gray); }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üìà</div>
                <div>
                    <h1>Stock Agent 4</h1>
                    <p>Multi-Agent Algorithmic Trading System</p>
                </div>
            </div>
            <div class="header-controls">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="systemStatus">SYSTEM ONLINE</span>
                </div>
                <div class="symbol-selector">
                    <label>Symbol:</label>
                    <select id="symbol-select" onchange="loadSymbolData()">
                        <option value="SPY" selected>SPY</option>
                        <option value="QQQ">QQQ</option>
                        <option value="IWM">IWM</option>
                        <option value="AAPL">AAPL</option>
                        <option value="MSFT">MSFT</option>
                        <option value="TSLA">TSLA</option>
                        <option value="NVDA">NVDA</option>
                        <option value="AMD">AMD</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" data-tab="overview">üìä Overview</button>
            <button class="tab-btn" data-tab="signals">üéØ Trading Signals</button>
            <button class="tab-btn" data-tab="mtf-charts">üìà Multi-Timeframe Charts</button>
            <button class="tab-btn" data-tab="portfolio">üíº Portfolio</button>
            <button class="tab-btn" data-tab="performance">üìà Performance</button>
            <button class="tab-btn" data-tab="agents">ü§ñ Agent Analysis</button>
        </div>

        <!-- OVERVIEW TAB -->
        <div id="overview" class="tab-content active">
            <div class="grid-4">
                <div class="stat-card">
                    <div class="label">Current Price</div>
                    <div class="value" id="currentPrice">$598.45</div>
                    <div class="change positive" id="priceChange">+1.2% Today</div>
                </div>
                <div class="stat-card">
                    <div class="label">Signal Status</div>
                    <div class="value" id="signalStatus">SUPER</div>
                    <div class="change" id="signalConfidence">85% Confidence</div>
                </div>
                <div class="stat-card">
                    <div class="label">Active Trades</div>
                    <div class="value" id="activeTrades">3</div>
                    <div class="change positive">2 Winning</div>
                </div>
                <div class="stat-card">
                    <div class="label">Today's P&L</div>
                    <div class="value positive" id="todayPnL">+$1,245</div>
                    <div class="change positive">+2.4%</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìà Price Chart (60 Days)</h3>
                    </div>
                    <canvas id="priceChart" height="300"></canvas>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üéØ Latest Signal</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Price</th>
                                    <th>Base</th>
                                    <th>Gann</th>
                                    <th>DQN</th>
                                    <th>Agree</th>
                                    <th>Signal</th>
                                    <th>Conf</th>
                                </tr>
                            </thead>
                            <tbody id="latestSignalTable">
                                <tr>
                                    <td>SPY</td>
                                    <td>$598.45</td>
                                    <td><span class="badge badge-success">CALL</span></td>
                                    <td><span class="badge badge-success">CALL</span></td>
                                    <td><span class="badge badge-danger">PUT</span></td>
                                    <td>2/3</td>
                                    <td><strong>SUPER</strong></td>
                                    <td>78%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìä Market Overview</h3>
                </div>
                <div class="grid-4">
                    <div class="stat-card">
                        <div class="label">Open</div>
                        <div class="value" id="openPrice">$596.20</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">High/Low</div>
                        <div class="value" id="highLow">$599.10 / $595.80</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Volume</div>
                        <div class="value" id="volumeDisplay">45.2M</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">ATR (14)</div>
                        <div class="value" id="atr">8.45</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIGNALS TAB -->
        <div id="signals" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ü§ñ Agent Signals Breakdown</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Agent</th>
                                <th>Signal</th>
                                <th>Win Rate</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="agentSignalsTable">
                            <tr>
                                <td><strong>Base Confluence</strong></td>
                                <td><span class="badge badge-success">CALL</span></td>
                                <td>65%</td>
                                <td>Geo: 598.20, Phi: 597.80</td>
                            </tr>
                            <tr>
                                <td><strong>Gann-Elliott</strong></td>
                                <td><span class="badge badge-success">CALL</span></td>
                                <td>72%</td>
                                <td>Wave: 3, Support: 595.50, Resistance: 602.30</td>
                            </tr>
                            <tr>
                                <td><strong>RL/DQN</strong></td>
                                <td><span class="badge badge-danger">PUT</span></td>
                                <td>71%</td>
                                <td>ML prediction based on momentum</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="grid-3">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìê Technical Levels</h3>
                    </div>
                    <div class="stat-card"><div class="label">SMA 20</div><div class="value" id="sma20">$596.50</div></div>
                    <div class="stat-card"><div class="label">SMA 50</div><div class="value" id="sma50">$592.30</div></div>
                    <div class="stat-card"><div class="label">SMA 200</div><div class="value" id="sma200">$575.80</div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üéØ Entry Parameters</h3>
                    </div>
                    <div class="stat-card"><div class="label">Entry Zone</div><div class="value">$597.50 - $598.50</div></div>
                    <div class="stat-card"><div class="label">Stop Loss</div><div class="value" style="color:var(--danger)">$594.20</div></div>
                    <div class="stat-card"><div class="label">Target 1</div><div class="value" style="color:var(--success)">$603.50</div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìä Position Sizing</h3>
                    </div>
                    <div class="stat-card"><div class="label">Kelly %</div><div class="value">12.5%</div></div>
                    <div class="stat-card"><div class="label">Risk/Trade</div><div class="value">$500</div></div>
                    <div class="stat-card"><div class="label">Contracts</div><div class="value">5</div></div>
                </div>
            </div>
        </div>

        <!-- MULTI-TIMEFRAME CHARTS TAB -->
        <div id="mtf-charts" class="tab-content">
            <div class="mtf-summary">
                <h3 style="margin-bottom: 15px; color: var(--text-dark);">üìä Multi-Timeframe Analysis Summary</h3>
                <div class="mtf-summary-grid">
                    <div class="mtf-summary-item">
                        <div class="title">Intraday Bias</div>
                        <div class="value bullish" id="intradayBias">BULLISH</div>
                    </div>
                    <div class="mtf-summary-item">
                        <div class="title">Swing Bias</div>
                        <div class="value bullish" id="swingBias">BULLISH</div>
                    </div>
                    <div class="mtf-summary-item">
                        <div class="title">Position Bias</div>
                        <div class="value bearish" id="positionBias">BEARISH</div>
                    </div>
                    <div class="mtf-summary-item">
                        <div class="title">Overall Confluence</div>
                        <div class="value bullish" id="overallBias">2/3 BULLISH</div>
                    </div>
                </div>
            </div>

            <div class="mtf-charts-container">
                <!-- INTRADAY -->
                <div class="chart-panel">
                    <div class="chart-title">
                        <div>
                            <span class="label">‚ö° Intraday (15 Min)</span>
                            <span class="price" id="intradayPrice">$600.00</span>
                            <span class="signal-badge call" id="intradaySignal">CALL</span>
                        </div>
                        <div class="controls">
                            <select class="mtf-select" id="intradayType" onchange="updateIntraday()">
                                <option value="candle">Candlestick</option>
                                <option value="heikinashi">Heikin Ashi</option>
                                <option value="line">Line</option>
                                <option value="pf">Point & Figure</option>
                            </select>
                            <button class="settings-btn" onclick="toggleSettings('intraday')">‚öôÔ∏è</button>
                        </div>
                    </div>
                    <div class="settings-panel" id="intradaySettings">
                        <div class="settings-row">
                            <label><input type="checkbox" id="intradayShowGrid" checked onchange="updateIntraday()"> Grid</label>
                            <label><input type="checkbox" id="intradayShowPriceLabels" checked onchange="updateIntraday()"> Price Labels</label>
                            <label><input type="checkbox" id="intradayShowPatterns" checked onchange="updateIntraday()"> Patterns</label>
                            <label><input type="checkbox" id="intradayShowTrendlines" checked onchange="updateIntraday()"> Trendlines</label>
                        </div>
                    </div>
                    <div class="chart-box" id="intradayChart"></div>
                    <div class="mtf-legend" id="intradayLegend">
                        <div class="legend-item"><div class="legend-color" style="background:#f59e0b;"></div> EMA 9</div>
                        <div class="legend-item"><div class="legend-color" style="background:#3b82f6;"></div> EMA 21</div>
                        <div class="legend-item"><div class="legend-color" style="background:#8b5cf6;"></div> EMA 50</div>
                    </div>
                    <div id="intradayPattern" class="pattern-alert" style="display:none;"></div>
                    <div class="fib-levels" id="intradayFib"></div>
                </div>

                <!-- SWING -->
                <div class="chart-panel">
                    <div class="chart-title">
                        <div>
                            <span class="label">üìà Swing (Daily)</span>
                            <span class="price" id="swingPrice">$595.00</span>
                            <span class="signal-badge call" id="swingSignal">CALL</span>
                        </div>
                        <div class="controls">
                            <select class="mtf-select" id="swingType" onchange="updateSwing()">
                                <option value="candle">Candlestick</option>
                                <option value="heikinashi">Heikin Ashi</option>
                                <option value="line">Line</option>
                                <option value="pf">Point & Figure</option>
                            </select>
                            <button class="settings-btn" onclick="toggleSettings('swing')">‚öôÔ∏è</button>
                        </div>
                    </div>
                    <div class="settings-panel" id="swingSettings">
                        <div class="settings-row">
                            <label><input type="checkbox" id="swingShowGrid" checked onchange="updateSwing()"> Grid</label>
                            <label><input type="checkbox" id="swingShowPriceLabels" checked onchange="updateSwing()"> Price Labels</label>
                            <label><input type="checkbox" id="swingShowPatterns" checked onchange="updateSwing()"> Patterns</label>
                            <label><input type="checkbox" id="swingShowTrendlines" checked onchange="updateSwing()"> Trendlines</label>
                        </div>
                    </div>
                    <div class="chart-box" id="swingChart"></div>
                    <div class="mtf-legend" id="swingLegend">
                        <div class="legend-item"><div class="legend-color" style="background:#f59e0b;"></div> EMA 9</div>
                        <div class="legend-item"><div class="legend-color" style="background:#3b82f6;"></div> EMA 21</div>
                        <div class="legend-item"><div class="legend-color" style="background:#8b5cf6;"></div> EMA 50</div>
                    </div>
                    <div id="swingPattern" class="pattern-alert" style="display:none;"></div>
                    <div class="fib-levels" id="swingFib"></div>
                </div>

                <!-- POSITION -->
                <div class="chart-panel">
                    <div class="chart-title">
                        <div>
                            <span class="label">üéØ Position (Monthly)</span>
                            <span class="price" id="positionPrice">$500.00</span>
                            <span class="signal-badge put" id="positionSignal">PUT</span>
                        </div>
                        <div class="controls">
                            <select class="mtf-select" id="positionType" onchange="updatePosition()">
                                <option value="candle">Candlestick</option>
                                <option value="heikinashi">Heikin Ashi</option>
                                <option value="line">Line</option>
                                <option value="pf">Point & Figure</option>
                            </select>
                            <button class="settings-btn" onclick="toggleSettings('position')">‚öôÔ∏è</button>
                        </div>
                    </div>
                    <div class="settings-panel" id="positionSettings">
                        <div class="settings-row">
                            <label><input type="checkbox" id="positionShowGrid" checked onchange="updatePosition()"> Grid</label>
                            <label><input type="checkbox" id="positionShowPriceLabels" checked onchange="updatePosition()"> Price Labels</label>
                            <label><input type="checkbox" id="positionShowPatterns" checked onchange="updatePosition()"> Patterns</label>
                            <label><input type="checkbox" id="positionShowTrendlines" checked onchange="updatePosition()"> Trendlines</label>
                        </div>
                    </div>
                    <div class="chart-box" id="positionChart"></div>
                    <div class="mtf-legend" id="positionLegend">
                        <div class="legend-item"><div class="legend-color" style="background:#f59e0b;"></div> EMA 9</div>
                        <div class="legend-item"><div class="legend-color" style="background:#3b82f6;"></div> EMA 21</div>
                        <div class="legend-item"><div class="legend-color" style="background:#8b5cf6;"></div> EMA 50</div>
                    </div>
                    <div id="positionPattern" class="pattern-alert" style="display:none;"></div>
                    <div class="fib-levels" id="positionFib"></div>
                </div>
            </div>
        </div>

        <!-- PORTFOLIO TAB -->
        <div id="portfolio" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üíº Active Positions</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Entry</th>
                                <th>Current</th>
                                <th>Stop</th>
                                <th>Target</th>
                                <th>P&L</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="portfolioTable">
                            <tr>
                                <td>SPY</td>
                                <td><span class="badge badge-success">CALL</span></td>
                                <td>$596.50</td>
                                <td>$598.45</td>
                                <td>$594.20</td>
                                <td>$603.50</td>
                                <td style="color:var(--success)">+$1,950</td>
                                <td><span class="badge badge-success">WINNING</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PERFORMANCE TAB -->
        <div id="performance" class="tab-content">
            <div class="grid-4">
                <div class="stat-card">
                    <div class="label">Total Trades</div>
                    <div class="value">156</div>
                </div>
                <div class="stat-card">
                    <div class="label">Win Rate</div>
                    <div class="value" style="color:var(--success)">72.4%</div>
                </div>
                <div class="stat-card">
                    <div class="label">Avg Win</div>
                    <div class="value" style="color:var(--success)">+$1,245</div>
                </div>
                <div class="stat-card">
                    <div class="label">Avg Loss</div>
                    <div class="value" style="color:var(--danger)">-$485</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìä Win Rate by Signal Type</h3>
                    </div>
                    <canvas id="winRateChart" height="250"></canvas>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìà Average Return (R)</h3>
                    </div>
                    <canvas id="avgReturnChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- AGENTS TAB -->
        <div id="agents" class="tab-content">
            <div class="grid-3">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üéØ Base Confluence Agent</h3>
                    </div>
                    <p style="color:var(--text-gray);font-size:13px;margin-bottom:15px;">
                        Geometric and Phi-based price level analysis with time cycle confluence.
                    </p>
                    <div class="stat-card"><div class="label">Win Rate</div><div class="value">65%</div></div>
                    <div class="stat-card"><div class="label">Avg R</div><div class="value">1.8R</div></div>
                    <div class="stat-card"><div class="label">Total Signals</div><div class="value">312</div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìê Gann-Elliott Agent</h3>
                    </div>
                    <p style="color:var(--text-gray);font-size:13px;margin-bottom:15px;">
                        Gann Square of 9 with Elliott Wave pattern overlay analysis.
                    </p>
                    <div class="stat-card"><div class="label">Win Rate</div><div class="value">72%</div></div>
                    <div class="stat-card"><div class="label">Avg R</div><div class="value">2.1R</div></div>
                    <div class="stat-card"><div class="label">Total Signals</div><div class="value">287</div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ü§ñ RL/DQN Agent</h3>
                    </div>
                    <p style="color:var(--text-gray);font-size:13px;margin-bottom:15px;">
                        Deep Q-Network reinforcement learning for adaptive trading.
                    </p>
                    <div class="stat-card"><div class="label">Win Rate</div><div class="value">71%</div></div>
                    <div class="stat-card"><div class="label">Avg R</div><div class="value">1.9R</div></div>
                    <div class="stat-card"><div class="label">Total Signals</div><div class="value">298</div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSymbol = 'SPY';
        let priceChartInstance = null;
        let mtfCharts = { intraday: null, swing: null, position: null };
        let mtfChartData = { intraday: [], swing: [], position: [] };
        const API_BASE = 'http://localhost:5000/api';

        function initializeTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.getElementById(tabName).classList.add('active');
                    this.classList.add('active');
                    if (tabName === 'mtf-charts') setTimeout(initMTFCharts, 100);
                });
            });
        }

        function toggleSettings(panel) {
            document.getElementById(`${panel}Settings`).classList.toggle('show');
        }

        function getSettings(panel) {
            return {
                showGrid: document.getElementById(`${panel}ShowGrid`)?.checked ?? true,
                showPriceLabels: document.getElementById(`${panel}ShowPriceLabels`)?.checked ?? true,
                showPatterns: document.getElementById(`${panel}ShowPatterns`)?.checked ?? true,
                showTrendlines: document.getElementById(`${panel}ShowTrendlines`)?.checked ?? true
            };
        }

        function generateSampleData(count, basePrice, volatility, isMonthly) {
            const data = [];
            let price = basePrice;
            const now = Math.floor(Date.now() / 1000);
            const interval = isMonthly ? 86400 * 30 : 86400;
            for (let i = 0; i < count; i++) {
                const change = (Math.random() - 0.48) * volatility;
                const open = price;
                const close = price + change;
                const high = Math.max(open, close) + Math.random() * volatility * 0.5;
                const low = Math.min(open, close) - Math.random() * volatility * 0.5;
                data.push({ time: now - (count - i) * interval, open: parseFloat(open.toFixed(2)), high: parseFloat(high.toFixed(2)), low: parseFloat(low.toFixed(2)), close: parseFloat(close.toFixed(2)), volume: Math.floor(Math.random() * 10000000) + 1000000 });
                price = close;
            }
            return data;
        }

        function generateIntradayData() {
            const data = [];
            let price = 600;
            const today = new Date();
            today.setHours(9, 30, 0, 0);
            for (let i = 0; i < 78; i++) {
                const time = new Date(today.getTime() + i * 5 * 60 * 1000);
                const change = (Math.random() - 0.48) * 1.5;
                const open = price;
                const close = price + change;
                const high = Math.max(open, close) + Math.random() * 0.5;
                const low = Math.min(open, close) - Math.random() * 0.5;
                data.push({ time: Math.floor(time.getTime() / 1000), open: parseFloat(open.toFixed(2)), high: parseFloat(high.toFixed(2)), low: parseFloat(low.toFixed(2)), close: parseFloat(close.toFixed(2)), volume: Math.floor(Math.random() * 1000000) + 100000 });
                price = close;
            }
            return data;
        }

        function detectPFPatterns(columns) {
            if (columns.length < 3) return { pattern: null, signal: 'HOLD' };
            const patterns = [];
            const len = columns.length;
            const c1 = columns[len - 1], c2 = columns[len - 2], c3 = columns[len - 3];
            const c4 = len >= 4 ? columns[len - 4] : null;
            const c5 = len >= 5 ? columns[len - 5] : null;

            if (c1.type === 'X' && c3.type === 'X') {
                const c1High = Math.max(...c1.boxes), c3High = Math.max(...c3.boxes);
                if (c1High > c3High) patterns.push({ name: 'Double Top Breakout', type: 'bullish', strength: 85 });
            }
            if (c1.type === 'O' && c3.type === 'O') {
                const c1Low = Math.min(...c1.boxes), c3Low = Math.min(...c3.boxes);
                if (c1Low < c3Low) patterns.push({ name: 'Double Bottom Breakdown', type: 'bearish', strength: 85 });
            }
            if (c5 && c1.type === 'X' && c3.type === 'X' && c5.type === 'X') {
                const c1High = Math.max(...c1.boxes), c3High = Math.max(...c3.boxes), c5High = Math.max(...c5.boxes);
                if (c1High > c3High && c1High > c5High) patterns.push({ name: 'Triple Top Breakout', type: 'bullish', strength: 95 });
                if (c1High > c3High && c3High > c5High) patterns.push({ name: 'Ascending Triple Top', type: 'bullish', strength: 90 });
            }
            if (c5 && c1.type === 'O' && c3.type === 'O' && c5.type === 'O') {
                const c1Low = Math.min(...c1.boxes), c3Low = Math.min(...c3.boxes), c5Low = Math.min(...c5.boxes);
                if (c1Low < c3Low && c1Low < c5Low) patterns.push({ name: 'Triple Bottom Breakdown', type: 'bearish', strength: 95 });
            }
            if (patterns.length === 0) {
                patterns.push(c1.type === 'X' ? { name: 'Uptrend in Progress', type: 'bullish', strength: 60 } : { name: 'Downtrend in Progress', type: 'bearish', strength: 60 });
            }
            const strongest = patterns.sort((a, b) => b.strength - a.strength)[0];
            return { pattern: strongest, signal: strongest.type === 'bullish' ? 'CALL' : 'PUT', allPatterns: patterns };
        }

        function renderPointAndFigure(container, data, panel, settings) {
            container.innerHTML = '';
            const canvas = document.createElement('canvas');
            canvas.width = container.clientWidth || 400;
            canvas.height = container.clientHeight || 420;
            container.appendChild(canvas);
            const ctx = canvas.getContext('2d');
            const width = canvas.width, height = canvas.height;
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(0, 0, width, height);
            if (!data || data.length < 10) { ctx.fillStyle = '#666'; ctx.font = '14px Arial'; ctx.textAlign = 'center'; ctx.fillText('Not enough data', width/2, height/2); return { columns: [], pattern: null }; }

            const avgPrice = data.reduce((sum, bar) => sum + bar.close, 0) / data.length;
            let boxSize = avgPrice < 5 ? 0.25 : avgPrice < 20 ? 0.50 : avgPrice < 100 ? 1.00 : avgPrice < 200 ? 2.00 : avgPrice < 500 ? 4.00 : 8.00;
            if (panel === 'intraday') boxSize *= 0.5;
            if (panel === 'position') boxSize *= 1.5;
            const reversal = 3;

            const columns = [];
            let currentCol = { type: null, boxes: [] };
            let lastBoxPrice = Math.floor(data[0].close / boxSize) * boxSize;

            for (let i = 0; i < data.length; i++) {
                const high = data[i].high, low = data[i].low;
                if (currentCol.type === null) {
                    const highBox = Math.floor(high / boxSize) * boxSize, lowBox = Math.floor(low / boxSize) * boxSize;
                    if (highBox > lastBoxPrice) { currentCol.type = 'X'; for (let p = lastBoxPrice; p <= highBox; p += boxSize) currentCol.boxes.push(p); lastBoxPrice = highBox; }
                    else if (lowBox < lastBoxPrice) { currentCol.type = 'O'; for (let p = lastBoxPrice; p >= lowBox; p -= boxSize) currentCol.boxes.push(p); lastBoxPrice = lowBox; }
                    continue;
                }
                if (currentCol.type === 'X') {
                    const highBox = Math.floor(high / boxSize) * boxSize, lowBox = Math.floor(low / boxSize) * boxSize;
                    if (highBox > lastBoxPrice) { for (let p = lastBoxPrice + boxSize; p <= highBox; p += boxSize) currentCol.boxes.push(p); lastBoxPrice = highBox; }
                    else if (lowBox <= lastBoxPrice - boxSize * reversal) { columns.push({ ...currentCol, boxes: [...currentCol.boxes] }); currentCol = { type: 'O', boxes: [] }; for (let p = lastBoxPrice - boxSize; p >= lowBox; p -= boxSize) currentCol.boxes.push(p); lastBoxPrice = lowBox; }
                } else {
                    const highBox = Math.floor(high / boxSize) * boxSize, lowBox = Math.floor(low / boxSize) * boxSize;
                    if (lowBox < lastBoxPrice) { for (let p = lastBoxPrice - boxSize; p >= lowBox; p -= boxSize) currentCol.boxes.push(p); lastBoxPrice = lowBox; }
                    else if (highBox >= lastBoxPrice + boxSize * reversal) { columns.push({ ...currentCol, boxes: [...currentCol.boxes] }); currentCol = { type: 'X', boxes: [] }; for (let p = lastBoxPrice + boxSize; p <= highBox; p += boxSize) currentCol.boxes.push(p); lastBoxPrice = highBox; }
                }
            }
            if (currentCol.boxes.length > 0) columns.push(currentCol);
            const patternResult = detectPFPatterns(columns);
            if (columns.length === 0) { ctx.fillStyle = '#666'; ctx.font = '14px Arial'; ctx.textAlign = 'center'; ctx.fillText('No P&F reversals', width/2, height/2); return { columns: [], pattern: null }; }

            let minPrice = Infinity, maxPrice = -Infinity;
            columns.forEach(col => { col.boxes.forEach(p => { minPrice = Math.min(minPrice, p); maxPrice = Math.max(maxPrice, p); }); });
            minPrice -= boxSize * 2; maxPrice += boxSize * 2;
            const padding = { top: 50, right: 55, bottom: 25, left: 55 };
            const chartWidth = width - padding.left - padding.right, chartHeight = height - padding.top - padding.bottom;
            const numRows = Math.ceil((maxPrice - minPrice) / boxSize);
            const maxCols = Math.min(columns.length, 35);
            const dispCols = columns.slice(-maxCols);
            const colWidth = Math.min(14, chartWidth / dispCols.length);

            if (settings.showGrid) {
                ctx.strokeStyle = '#ddd'; ctx.lineWidth = 0.5;
                for (let p = minPrice; p <= maxPrice; p += boxSize) { const y = padding.top + chartHeight - ((p - minPrice) / (maxPrice - minPrice)) * chartHeight; ctx.beginPath(); ctx.moveTo(padding.left, y); ctx.lineTo(width - padding.right, y); ctx.stroke(); }
                for (let i = 0; i <= dispCols.length; i++) { const x = padding.left + i * colWidth; ctx.beginPath(); ctx.moveTo(x, padding.top); ctx.lineTo(x, height - padding.bottom); ctx.stroke(); }
            }
            if (settings.showPriceLabels) {
                ctx.fillStyle = '#333'; ctx.font = '9px Arial';
                const labelStep = Math.max(1, Math.floor(numRows / 12)) * boxSize;
                for (let p = Math.ceil(minPrice / labelStep) * labelStep; p <= maxPrice; p += labelStep) { const y = padding.top + chartHeight - ((p - minPrice) / (maxPrice - minPrice)) * chartHeight; ctx.textAlign = 'right'; ctx.fillText(p.toFixed(2), padding.left - 5, y + 3); ctx.textAlign = 'left'; ctx.fillText(p.toFixed(2), width - padding.right + 5, y + 3); }
            }
            if (settings.showTrendlines && dispCols.length >= 3) {
                const oColumns = dispCols.map((col, idx) => ({ ...col, idx })).filter(c => c.type === 'O');
                if (oColumns.length >= 2) { const first = oColumns[0], last = oColumns[oColumns.length - 1]; const firstLow = Math.min(...first.boxes), lastLow = Math.min(...last.boxes); if (lastLow >= firstLow) { ctx.strokeStyle = 'rgba(38, 166, 154, 0.7)'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(padding.left + (first.idx + 0.5) * colWidth, padding.top + chartHeight - ((firstLow - minPrice) / (maxPrice - minPrice)) * chartHeight); ctx.lineTo(padding.left + (last.idx + 0.5) * colWidth, padding.top + chartHeight - ((lastLow - minPrice) / (maxPrice - minPrice)) * chartHeight); ctx.stroke(); } }
                const xColumns = dispCols.map((col, idx) => ({ ...col, idx })).filter(c => c.type === 'X');
                if (xColumns.length >= 2) { const first = xColumns[0], last = xColumns[xColumns.length - 1]; const firstHigh = Math.max(...first.boxes), lastHigh = Math.max(...last.boxes); if (lastHigh <= firstHigh) { ctx.strokeStyle = 'rgba(239, 83, 80, 0.7)'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(padding.left + (first.idx + 0.5) * colWidth, padding.top + chartHeight - ((firstHigh - minPrice) / (maxPrice - minPrice)) * chartHeight); ctx.lineTo(padding.left + (last.idx + 0.5) * colWidth, padding.top + chartHeight - ((lastHigh - minPrice) / (maxPrice - minPrice)) * chartHeight); ctx.stroke(); } }
            }

            const fontSize = Math.max(8, Math.min(12, colWidth - 1));
            ctx.font = `bold ${fontSize}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            dispCols.forEach((col, colIdx) => { const x = padding.left + (colIdx + 0.5) * colWidth; col.boxes.forEach(price => { const y = padding.top + chartHeight - ((price - minPrice) / (maxPrice - minPrice)) * chartHeight; ctx.fillStyle = col.type === 'X' ? '#00aa00' : '#cc0000'; ctx.fillText(col.type, x, y); }); });

            ctx.fillStyle = '#333'; ctx.font = 'bold 11px Arial'; ctx.textAlign = 'left'; ctx.fillText('P&F Pattern', padding.left, 15);
            ctx.font = '10px Arial'; ctx.fillStyle = '#666'; ctx.fillText(`Box: $${boxSize.toFixed(2)} | Rev: ${reversal}`, padding.left + 75, 15);
            if (settings.showPatterns && patternResult.pattern) { ctx.font = 'bold 10px Arial'; ctx.fillStyle = patternResult.pattern.type === 'bullish' ? '#00875a' : '#c62828'; ctx.textAlign = 'center'; ctx.fillText(patternResult.pattern.name, width / 2, 32); }
            ctx.fillStyle = '#333'; ctx.font = 'bold 10px Arial'; ctx.textAlign = 'right'; ctx.fillText(`Last: $${data[data.length - 1].close.toFixed(2)}`, width - padding.right, 15);
            return { columns, pattern: patternResult };
        }

        function convertToHeikinAshi(data) { const ha = []; for (let i = 0; i < data.length; i++) { const d = data[i]; const haClose = (d.open + d.high + d.low + d.close) / 4; const haOpen = i === 0 ? (d.open + d.close) / 2 : (ha[i-1].open + ha[i-1].close) / 2; ha.push({ time: d.time, open: parseFloat(haOpen.toFixed(2)), high: parseFloat(Math.max(d.high, haOpen, haClose).toFixed(2)), low: parseFloat(Math.min(d.low, haOpen, haClose).toFixed(2)), close: parseFloat(haClose.toFixed(2)), volume: d.volume }); } return ha; }
        function calculateEMA(data, period) { const k = 2 / (period + 1); const result = []; let ema = data[0]?.close || 0; for (let i = 0; i < data.length; i++) { ema = i === 0 ? data[i].close : data[i].close * k + ema * (1 - k); result.push({ time: data[i].time, value: parseFloat(ema.toFixed(2)) }); } return result; }
        function calculateFibonacci(data) { const high = Math.max(...data.map(d => d.high)), low = Math.min(...data.map(d => d.low)), range = high - low; return { high, low, level236: high - range * 0.236, level382: high - range * 0.382, level500: high - range * 0.5, level618: high - range * 0.618, level786: high - range * 0.786 }; }
        function displayFibLevels(id, fib) { document.getElementById(id).innerHTML = `<div class="fib-level resistance">R: $${fib.high.toFixed(2)}</div><div class="fib-level resistance">23.6%: $${fib.level236.toFixed(2)}</div><div class="fib-level resistance">38.2%: $${fib.level382.toFixed(2)}</div><div class="fib-level support">50%: $${fib.level500.toFixed(2)}</div><div class="fib-level support">61.8%: $${fib.level618.toFixed(2)}</div><div class="fib-level support">78.6%: $${fib.level786.toFixed(2)}</div><div class="fib-level support">S: $${fib.low.toFixed(2)}</div>`; }

        function createMTFChart(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return null;
            return LightweightCharts.createChart(container, { width: container.clientWidth, height: container.clientHeight, layout: { background: { color: '#ffffff' }, textColor: '#333' }, grid: { vertLines: { color: '#e0e0e0' }, horzLines: { color: '#e0e0e0' } }, crosshair: { mode: LightweightCharts.CrosshairMode.Normal }, rightPriceScale: { borderColor: '#e0e0e0', scaleMargins: { top: 0.1, bottom: 0.2 } }, timeScale: { borderColor: '#e0e0e0', timeVisible: true, secondsVisible: false } });
        }

        function addChartSeries(chart, data, type, fib) {
            let mainSeries;
            if (type === 'candle' || type === 'heikinashi') { mainSeries = chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350', borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350' }); mainSeries.setData(data); }
            else { mainSeries = chart.addLineSeries({ color: '#2962FF', lineWidth: 2 }); mainSeries.setData(data.map(d => ({ time: d.time, value: d.close }))); }
            chart.addLineSeries({ color: '#f59e0b', lineWidth: 1, crosshairMarkerVisible: false, priceLineVisible: false, lastValueVisible: false }).setData(calculateEMA(data, 9));
            chart.addLineSeries({ color: '#3b82f6', lineWidth: 1, crosshairMarkerVisible: false, priceLineVisible: false, lastValueVisible: false }).setData(calculateEMA(data, 21));
            chart.addLineSeries({ color: '#8b5cf6', lineWidth: 1, crosshairMarkerVisible: false, priceLineVisible: false, lastValueVisible: false }).setData(calculateEMA(data, 50));
            if (fib && mainSeries) { [{ price: fib.level236, color: 'rgba(239,83,80,0.5)', title: '23.6%' }, { price: fib.level382, color: 'rgba(239,83,80,0.4)', title: '38.2%' }, { price: fib.level500, color: 'rgba(156,39,176,0.5)', title: '50%' }, { price: fib.level618, color: 'rgba(38,166,154,0.4)', title: '61.8%' }, { price: fib.level786, color: 'rgba(38,166,154,0.5)', title: '78.6%' }].forEach(l => mainSeries.createPriceLine({ price: l.price, color: l.color, lineWidth: 1, lineStyle: 2, axisLabelVisible: true, title: l.title })); }
            chart.addHistogramSeries({ priceFormat: { type: 'volume' }, priceScaleId: '', scaleMargins: { top: 0.85, bottom: 0 } }).setData(data.map(d => ({ time: d.time, value: d.volume, color: d.close >= d.open ? 'rgba(38,166,154,0.5)' : 'rgba(239,83,80,0.5)' })));
            const markers = []; for (let i = 3; i < data.length; i++) { if (data[i-2].close < data[i-2].open && data[i-1].close < data[i-1].open && data[i].close > data[i].open) markers.push({ time: data[i].time, position: 'belowBar', color: '#26a69a', shape: 'arrowUp', text: 'BUY' }); if (data[i-2].close > data[i-2].open && data[i-1].close > data[i-1].open && data[i].close < data[i].open) markers.push({ time: data[i].time, position: 'aboveBar', color: '#ef5350', shape: 'arrowDown', text: 'SELL' }); }
            if (markers.length > 0 && mainSeries) mainSeries.setMarkers(markers.slice(-5));
            chart.timeScale().fitContent();
            return { mainSeries, signal: data[data.length-1].close > data[data.length-2]?.close ? 'CALL' : 'PUT' };
        }

        function displayPattern(panel, patternResult) { const patternEl = document.getElementById(`${panel}Pattern`); if (!patternResult || !patternResult.pattern) { patternEl.style.display = 'none'; return; } const p = patternResult.pattern; patternEl.style.display = 'block'; patternEl.className = `pattern-alert ${p.type}`; patternEl.innerHTML = `<span style="font-size:14px;">${p.type === 'bullish' ? 'üü¢' : 'üî¥'}</span> <strong>${p.name}</strong> <span style="float:right;">Strength: ${p.strength}%</span>`; }

        function updateMTFChart(panel) {
            const type = document.getElementById(`${panel}Type`).value;
            const priceEl = document.getElementById(`${panel}Price`);
            const signalEl = document.getElementById(`${panel}Signal`);
            const container = document.getElementById(`${panel}Chart`);
            const legendEl = document.getElementById(`${panel}Legend`);
            const fibEl = document.getElementById(`${panel}Fib`);
            const settings = getSettings(panel);
            let data = mtfChartData[panel];

            if (type === 'pf') {
                if (mtfCharts[panel]) { mtfCharts[panel].remove(); mtfCharts[panel] = null; }
                const result = renderPointAndFigure(container, data, panel, settings);
                legendEl.style.display = 'none'; fibEl.innerHTML = '';
                priceEl.textContent = `$${data[data.length-1].close.toFixed(2)}`;
                if (settings.showPatterns) { displayPattern(panel, result.pattern); if (result.pattern) { signalEl.textContent = result.pattern.signal; signalEl.className = `signal-badge ${result.pattern.signal.toLowerCase()}`; updateBiasSummary(panel, result.pattern.signal); } }
                else { document.getElementById(`${panel}Pattern`).style.display = 'none'; }
                return;
            }

            document.getElementById(`${panel}Pattern`).style.display = 'none';
            legendEl.style.display = 'flex';
            if (type === 'heikinashi') data = convertToHeikinAshi(mtfChartData[panel]);
            if (mtfCharts[panel]) mtfCharts[panel].remove();
            mtfCharts[panel] = createMTFChart(`${panel}Chart`);
            const fib = calculateFibonacci(data); displayFibLevels(`${panel}Fib`, fib);
            const { signal } = addChartSeries(mtfCharts[panel], data, type, fib);
            const lastPrice = data[data.length-1].close, prevPrice = data[data.length-2]?.close || lastPrice;
            priceEl.textContent = `$${lastPrice.toFixed(2)}`; priceEl.className = lastPrice >= prevPrice ? 'price' : 'price down';
            signalEl.textContent = signal; signalEl.className = `signal-badge ${signal.toLowerCase()}`;
            updateBiasSummary(panel, signal);
        }

        function updateBiasSummary(panel, signal) {
            const biasEl = document.getElementById(`${panel}Bias`);
            if (biasEl) { const bias = signal === 'CALL' ? 'BULLISH' : 'BEARISH'; biasEl.textContent = bias; biasEl.className = `value ${bias.toLowerCase()}`; }
            const intraday = document.getElementById('intradaySignal')?.textContent || 'HOLD';
            const swing = document.getElementById('swingSignal')?.textContent || 'HOLD';
            const position = document.getElementById('positionSignal')?.textContent || 'HOLD';
            let bullish = 0; [intraday, swing, position].forEach(s => { if (s === 'CALL') bullish++; });
            const overallEl = document.getElementById('overallBias');
            if (overallEl) { overallEl.textContent = `${bullish}/3 ${bullish >= 2 ? 'BULLISH' : 'BEARISH'}`; overallEl.className = `value ${bullish >= 2 ? 'bullish' : 'bearish'}`; }
        }

        function updateIntraday() { updateMTFChart('intraday'); }
        function updateSwing() { updateMTFChart('swing'); }
        function updatePosition() { updateMTFChart('position'); }

        function initMTFCharts() {
            mtfChartData.intraday = generateIntradayData();
            mtfChartData.swing = generateSampleData(120, 595, 8, false);
            mtfChartData.position = generateSampleData(60, 500, 25, true);
            updateIntraday(); updateSwing(); updatePosition();
        }

        async function loadSymbolData() {
            currentSymbol = document.getElementById('symbol-select').value;
            try {
                const priceResponse = await axios.get(`${API_BASE}/price/${currentSymbol}`);
                const priceData = priceResponse.data;
                document.getElementById('currentPrice').textContent = `$${priceData.price.toFixed(2)}`;
                document.getElementById('openPrice').textContent = `$${priceData.open.toFixed(2)}`;
                document.getElementById('highLow').textContent = `$${priceData.low.toFixed(2)} - $${priceData.high.toFixed(2)}`;
                document.getElementById('volumeDisplay').textContent = (priceData.volume / 1000000).toFixed(2) + 'M';
                const histResponse = await axios.get(`${API_BASE}/historical/${currentSymbol}?days=60`);
                if (histResponse.data.indicators) { document.getElementById('sma20').textContent = `$${histResponse.data.indicators.sma20?.toFixed(2) || '--'}`; document.getElementById('sma50').textContent = `$${histResponse.data.indicators.sma50?.toFixed(2) || '--'}`; document.getElementById('sma200').textContent = `$${histResponse.data.indicators.sma200?.toFixed(2) || '--'}`; document.getElementById('atr').textContent = histResponse.data.indicators.atr?.toFixed(2) || '--'; }
                updatePriceChart(histResponse.data.data);
            } catch (error) { console.log('API not available, using demo data'); }
        }

        function updatePriceChart(data) {
            if (!data || data.length === 0) return;
            const dates = data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const closes = data.map(d => d.close);
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;
            if (priceChartInstance) priceChartInstance.destroy();
            priceChartInstance = new Chart(ctx, { type: 'line', data: { labels: dates, datasets: [{ label: 'Close Price', data: closes, borderColor: '#1e40af', backgroundColor: 'rgba(30, 64, 175, 0.05)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 3, pointBackgroundColor: '#1e40af' }] }, options: { responsive: true, plugins: { legend: { display: true, labels: { color: '#1f2937' } } }, scales: { y: { ticks: { color: '#6b7280' } }, x: { ticks: { color: '#6b7280' } } } } });
            initializeCharts();
        }

        function initializeCharts() {
            const winRateCtx = document.getElementById('winRateChart');
            if (winRateCtx && !winRateCtx.dataset.initialized) { new Chart(winRateCtx, { type: 'bar', data: { labels: ['Base', 'Gann', 'DQN', 'SUPER', 'ULTRA'], datasets: [{ label: 'Win Rate %', data: [65, 72, 71, 78, 89], backgroundColor: ['#1e40af', '#7c3aed', '#ec4899', '#16a34a', '#059669'] }] }, options: { responsive: true } }); winRateCtx.dataset.initialized = true; }
            const avgCtx = document.getElementById('avgReturnChart');
            if (avgCtx && !avgCtx.dataset.initialized) { new Chart(avgCtx, { type: 'bar', data: { labels: ['Base', 'Gann', 'DQN', 'SUPER', 'ULTRA'], datasets: [{ label: 'Avg Return (R)', data: [1.8, 2.1, 1.9, 2.4, 3.2], backgroundColor: ['#1e40af', '#7c3aed', '#ec4899', '#16a34a', '#059669'] }] }, options: { responsive: true } }); avgCtx.dataset.initialized = true; }
        }

        document.addEventListener('DOMContentLoaded', function() { initializeTabs(); loadSymbolData(); setInterval(loadSymbolData, 30000); });
    </script>
</body>
</html>