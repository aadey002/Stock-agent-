<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Agent 4 - Q5D Options Trading Platform</title>
    <!-- v2.1 - Market Trade Timeframe Buttons -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #3b82f6; --secondary: #8b5cf6; --accent: #06b6d4;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #0891b2;
            --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0;
            --text: #1e293b; --muted: #64748b; --light: #94a3b8;
            --intraday: #f59e0b; --swing: #8b5cf6;
            --ai-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
        
        /* LOGIN SCREEN STYLES */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d1b4e 50%, #1a1a2e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .login-screen.hidden { display: none; }
        
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 420px;
            text-align: center;
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }
        
        .login-title {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        
        .login-subtitle {
            color: var(--muted);
            font-size: 14px;
            margin-bottom: 30px;
        }
        
        .login-form { text-align: left; }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            outline: none;
        }
        
        .form-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        .form-group input.error {
            border-color: var(--danger);
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }
        
        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .login-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }
        
        .login-error.show { display: block; }
        
        .login-footer {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--muted);
        }
        
        .login-footer a {
            color: var(--primary);
            text-decoration: none;
        }
        
        /* Remember me checkbox */
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .remember-me input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }
        
        .remember-me label {
            font-size: 13px;
            color: var(--muted);
            cursor: pointer;
        }
        
        /* Logout Button in Header */
        .logout-btn {
            padding: 5px 12px;
            background: rgba(239, 68, 68, 0.2);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 5px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.4);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
        }
        
        .user-avatar {
            width: 24px;
            height: 24px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Main app hidden until logged in */
        .main-app { display: none; }
        .main-app.visible { display: block; }
        
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 10px 0; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1600px; margin: 0 auto; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .logo h1 { font-size: 16px; font-weight: 700; }
        .logo p { font-size: 9px; opacity: 0.9; }
        
        .live-price-ticker { display: flex; align-items: center; gap: 12px; background: rgba(0,0,0,0.2); padding: 6px 14px; border-radius: 8px; }
        .ticker-symbol { font-size: 13px; font-weight: 700; }
        .ticker-price { font-size: 20px; font-weight: 800; }
        .ticker-change { font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        .ticker-change.positive { background: rgba(16,185,129,0.3); }
        .ticker-change.negative { background: rgba(239,68,68,0.3); }
        
        .header-controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .status-badge { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 15px; font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .status-badge:hover { transform: scale(1.05); }
        .status-badge.online { background: rgba(16,185,129,0.3); }
        .status-badge.warning { background: rgba(245,158,11,0.3); }
        .status-badge.critical { background: rgba(239,68,68,0.3); }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

        /* SQ9 Alert Animations */
        @keyframes sq9Pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 0 20px 5px rgba(34, 197, 94, 0.2); }
        }
        .sq9-alert-pulse { animation: sq9Pulse 2s ease-in-out infinite; }
        @keyframes sq9Flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .sq9-flash { animation: sq9Flash 0.5s ease-in-out 3; }

        .symbol-select select { padding: 5px 8px; border: none; border-radius: 5px; font-size: 11px; background: rgba(255,255,255,0.9); cursor: pointer; font-weight: 600; }
        .refresh-btn { padding: 5px 12px; background: #22c55e; color: white; border: none; border-radius: 5px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .refresh-btn:hover { background: #16a34a; transform: scale(1.02); }
        .refresh-btn:active { transform: scale(0.98); }
        .refresh-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        #refreshIcon { display: inline-block; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .container { max-width: 1600px; margin: 0 auto; padding: 12px; }
        
        .mode-toggle-container { display: flex; justify-content: center; margin-bottom: 12px; }
        .mode-toggle { display: flex; background: var(--card); border-radius: 8px; padding: 3px; border: 1px solid var(--border); }
        .mode-btn { padding: 8px 20px; border: none; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 5px; }
        .mode-btn.intraday { background: transparent; color: var(--muted); }
        .mode-btn.swing { background: transparent; color: var(--muted); }
        .mode-btn.active.intraday { background: linear-gradient(135deg, var(--intraday), #d97706); color: white; }
        .mode-btn.active.swing { background: linear-gradient(135deg, var(--swing), #6d28d9); color: white; }
        
        .symbol-banner { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 8px 14px; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; font-size: 14px; }
        .symbol-banner.intraday-mode { background: linear-gradient(135deg, var(--intraday), #d97706); }
        .symbol-banner.swing-mode { background: linear-gradient(135deg, var(--swing), #6d28d9); }
        
        .tabs { display: flex; gap: 3px; background: var(--card); border-radius: 8px; padding: 4px; margin-bottom: 12px; overflow-x: auto; border: 1px solid var(--border); }
        .tab-btn { padding: 7px 12px; background: transparent; border: none; border-radius: 5px; color: var(--muted); font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .tab-btn:hover { color: var(--primary); background: rgba(59,130,246,0.05); }
        .tab-btn.active { color: white; background: var(--primary); }
        .tab-btn.ai-tab { background: var(--ai-gradient); color: white; }
        .tab-btn.ai-tab:not(.active) { background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2)); color: var(--secondary); }
        .tab-btn.health-tab { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .tab-btn.health-tab:not(.active) { background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.2)); color: var(--success); }
        .tab-btn.charts-tab { background: linear-gradient(135deg, #0891b2, #0e7490); color: white; }
        .tab-btn.charts-tab:not(.active) { background: linear-gradient(135deg, rgba(8,145,178,0.2), rgba(14,116,144,0.2)); color: var(--accent); }
        .tab-btn.analysis-tab { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .tab-btn.analysis-tab:not(.active) { background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(217,119,6,0.2)); color: var(--warning); }
        
                /* Enhanced Multi-Charts Styles */
        .multi-charts-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px; }
        @media (max-width: 1200px) { .multi-charts-container { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .multi-charts-container { grid-template-columns: 1fr; } }
        
        .mtf-summary { background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(139,92,246,0.05)); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .mtf-summary-title { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--text); }
        .mtf-summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        @media (max-width: 900px) { .mtf-summary-grid { grid-template-columns: repeat(2, 1fr); } }
        .mtf-summary-item { text-align: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid var(--border); }
        .mtf-summary-item .title { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
        .mtf-summary-item .value { font-size: 18px; font-weight: 700; }
        .mtf-summary-item .value.bullish { color: var(--success); }
        .mtf-summary-item .value.bearish { color: var(--danger); }
        .mtf-summary-item .value.neutral { color: var(--warning); }
        
        .chart-panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .chart-panel-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--bg); border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 8px; }
        .chart-panel-title { display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 13px; }
        .chart-panel-title .icon { width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .chart-panel-title .icon.intraday { background: rgba(245,158,11,0.2); }
        .chart-panel-title .icon.swing { background: rgba(139,92,246,0.2); }
        .chart-panel-title .icon.position { background: rgba(16,185,129,0.2); }
        .chart-controls { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .chart-select { padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 10px; background: white; cursor: pointer; }
        .chart-body { position: relative; height: 350px; background: #fff; }
        .chart-canvas-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
        .chart-legend { position: absolute; top: 8px; left: 10px; z-index: 10; display: flex; align-items: center; gap: 8px; }
        .chart-legend .symbol { background: rgba(59,130,246,0.9); color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        .chart-legend .price { font-size: 13px; font-weight: 700; color: var(--success); }
        .chart-legend .price.down { color: var(--danger); }
        .chart-loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; color: var(--muted); display: none; }
        
        .signal-badge-mtf { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 8px; }
        .signal-badge-mtf.call { background: var(--success); color: white; }
        .signal-badge-mtf.put { background: var(--danger); color: white; }
        .signal-badge-mtf.hold { background: var(--warning); color: white; }
        
        .settings-btn-mtf { background: var(--secondary); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .settings-btn-mtf:hover { opacity: 0.9; }
        .settings-panel-mtf { display: none; background: var(--bg); border-top: 1px solid var(--border); padding: 10px 12px; font-size: 11px; }
        .settings-panel-mtf.show { display: block; }
        .settings-row-mtf { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .settings-row-mtf label { display: flex; align-items: center; gap: 4px; cursor: pointer; color: var(--muted); }
        .settings-row-mtf input[type="checkbox"] { width: 14px; height: 14px; accent-color: var(--primary); }
        
        .pattern-alert-mtf { margin: 0 12px 10px; padding: 8px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .pattern-alert-mtf.bullish { background: rgba(16,185,129,0.15); color: #059669; border-left: 3px solid var(--success); }
        .pattern-alert-mtf.bearish { background: rgba(239,68,68,0.15); color: #dc2626; border-left: 3px solid var(--danger); }
        
        .fib-levels-mtf { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; padding: 8px 12px; background: var(--bg); border-top: 1px solid var(--border); }
        .fib-level-mtf { padding: 4px 6px; border-radius: 4px; text-align: center; font-size: 9px; }
        .fib-level-mtf.support { background: rgba(16,185,129,0.1); color: var(--success); }
        .fib-level-mtf.resistance { background: rgba(239,68,68,0.1); color: var(--danger); }
        
        .mtf-legend { display: flex; gap: 12px; padding: 6px 12px; background: var(--bg); border-top: 1px solid var(--border); font-size: 10px; flex-wrap: wrap; }
        .legend-item-mtf { display: flex; align-items: center; gap: 4px; color: var(--muted); }
        .legend-color-mtf { width: 12px; height: 3px; border-radius: 2px; }

        /* Chart Level Overlay Labels - Compact Left Side */
        .chart-level-label { position: absolute; left: 2px; padding: 1px 4px; border-radius: 3px; font-size: 8px; font-weight: 600; z-index: 100; white-space: nowrap; pointer-events: none; }
        .chart-level-label.fib-resistance { background: rgba(239, 68, 68, 0.85); color: white; }
        .chart-level-label.fib-support { background: rgba(34, 197, 94, 0.85); color: white; }
        .chart-level-label.sq9-support { background: rgba(59, 130, 246, 0.85); color: white; }
        .chart-level-label.sq9-resistance { background: rgba(249, 115, 22, 0.85); color: white; }
        .chart-level-line { position: absolute; left: 60px; right: 0; height: 1px; z-index: 50; pointer-events: none; }
        .chart-level-line.resistance { border-top: 1px dashed rgba(239, 68, 68, 0.5); }
        .chart-level-line.support { border-top: 1px dashed rgba(34, 197, 94, 0.5); }
        .chart-level-line.sq9 { border-top: 1px dashed rgba(59, 130, 246, 0.5); }

        /* Daily Analysis Styles */
        .daily-report { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 15px; }
        .report-header { background: linear-gradient(135deg, #1e3a5f 0%, #2d1b4e 50%, #1a1a2e 100%); color: white; padding: 20px; }
        .report-header h2 { font-size: 20px; margin-bottom: 5px; }
        .report-header .report-meta { font-size: 12px; opacity: 0.8; }
        .report-body { padding: 20px; }
        .report-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .report-section:last-child { margin-bottom: 0; border-bottom: none; }
        .report-section-title { font-size: 14px; font-weight: 700; color: var(--primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .signal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .signal-card { background: var(--bg); border-radius: 8px; padding: 12px; border-left: 4px solid var(--primary); }
        .signal-card.bullish { border-left-color: var(--success); }
        .signal-card.bearish { border-left-color: var(--danger); }
        .signal-card.neutral { border-left-color: var(--warning); }
        .signal-card-title { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
        .signal-card-value { font-size: 16px; font-weight: 700; }
        .signal-card-detail { font-size: 10px; color: var(--muted); margin-top: 4px; }
        .consensus-meter { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin: 8px 0; }
        .consensus-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .consensus-fill.high { background: linear-gradient(90deg, var(--success), #34d399); }
        .consensus-fill.medium { background: linear-gradient(90deg, var(--warning), #fbbf24); }
        .consensus-fill.low { background: linear-gradient(90deg, var(--danger), #f87171); }
        .trade-recommendation { background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.1)); border: 1px solid rgba(16,185,129,0.3); border-radius: 10px; padding: 15px; }
        .trade-recommendation.put { background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(220,38,38,0.1)); border-color: rgba(239,68,68,0.3); }
        .strike-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .strike-table th, .strike-table td { padding: 8px 12px; text-align: left; font-size: 12px; }
        .strike-table th { background: var(--bg); color: var(--muted); font-weight: 600; }
        .strike-table tr:hover { background: rgba(59,130,246,0.05); }
        .gann-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .gann-item { background: var(--bg); padding: 10px; border-radius: 6px; text-align: center; }
        .gann-item-label { font-size: 10px; color: var(--muted); }
        .gann-item-value { font-size: 14px; font-weight: 700; color: var(--secondary); }
        .phi-levels { display: flex; flex-wrap: wrap; gap: 8px; }
        .phi-level { background: rgba(139,92,246,0.1); padding: 6px 12px; border-radius: 20px; font-size: 11px; }
        .phi-level span { font-weight: 700; color: var(--secondary); }
        .report-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .report-btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .report-btn.primary { background: var(--primary); color: white; }
        .report-btn.secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
        .report-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .eod-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        @media (max-width: 768px) { .eod-summary { grid-template-columns: repeat(2, 1fr); } }
        .eod-metric { text-align: center; padding: 15px; background: var(--bg); border-radius: 8px; }
        .eod-metric-value { font-size: 24px; font-weight: 700; }
        .eod-metric-label { font-size: 11px; color: var(--muted); }
        
        /* Daily Analysis Styles */
        .analysis-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .analysis-time { display: flex; gap: 15px; align-items: center; }
        .analysis-time-btn { padding: 10px 20px; border: 2px solid var(--border); background: white; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .analysis-time-btn.active { border-color: var(--primary); background: var(--primary); color: white; }
        .analysis-time-btn:hover:not(.active) { border-color: var(--primary); }
        .report-actions { display: flex; gap: 10px; }
        .report-btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .report-btn.primary { background: var(--primary); color: white; }
        .report-btn.success { background: var(--success); color: white; }
        .report-btn.warning { background: var(--warning); color: white; }
        .signal-confluence-card { background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(139,92,246,0.05)); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .confluence-score { font-size: 48px; font-weight: 800; text-align: center; margin: 15px 0; }
        .confluence-score.bullish { color: var(--success); }
        .confluence-score.bearish { color: var(--danger); }
        .confluence-score.neutral { color: var(--warning); }
        .signal-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .signal-item { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
        .signal-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .signal-item-name { font-weight: 600; font-size: 12px; }
        .signal-item-score { font-weight: 700; font-size: 14px; padding: 4px 10px; border-radius: 4px; }
        .signal-item-score.bullish { background: rgba(16,185,129,0.1); color: var(--success); }
        .signal-item-score.bearish { background: rgba(239,68,68,0.1); color: var(--danger); }
        .signal-item-score.neutral { background: rgba(245,158,11,0.1); color: var(--warning); }
        .signal-item-detail { font-size: 11px; color: var(--muted); }
        .trading-plan { background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .trading-plan-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 15px 20px; }
        .trading-plan-body { padding: 20px; }
        .plan-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .plan-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .plan-section-title { font-weight: 700; font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .trade-recommendation { background: rgba(16,185,129,0.05); border: 1px solid rgba(16,185,129,0.2); border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .trade-recommendation.put { background: rgba(239,68,68,0.05); border-color: rgba(239,68,68,0.2); }
        .trade-rec-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .trade-rec-symbol { font-weight: 700; font-size: 16px; }
        .trade-rec-signal { padding: 4px 12px; border-radius: 4px; font-weight: 600; font-size: 12px; }
        .trade-rec-signal.call { background: var(--success); color: white; }
        .trade-rec-signal.put { background: var(--danger); color: white; }
        .trade-rec-details { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 11px; }
        .trade-rec-detail { text-align: center; }
        .trade-rec-detail-label { color: var(--muted); }
        .trade-rec-detail-value { font-weight: 600; margin-top: 2px; }
        .gann-analysis { background: linear-gradient(135deg, rgba(139,92,246,0.05), rgba(168,85,247,0.05)); border-radius: 8px; padding: 15px; }
        .phi-levels { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .phi-level { text-align: center; padding: 10px; background: white; border-radius: 6px; }
        .phi-level-name { font-size: 10px; color: var(--muted); }
        .phi-level-value { font-weight: 700; font-size: 14px; color: var(--secondary); }

        /* Gann Analysis Tab Styles */
        #gann-analysis { position: relative; }
        .gann-background-pattern {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 50% 50%, rgba(212,160,23,0.03) 0%, transparent 50%),
                linear-gradient(0deg, transparent 49.5%, rgba(212,160,23,0.05) 50%, transparent 50.5%),
                linear-gradient(90deg, transparent 49.5%, rgba(212,160,23,0.05) 50%, transparent 50.5%);
            background-size: 100% 100%, 50px 50px, 50px 50px;
            pointer-events: none;
            z-index: 0;
        }
        .gann-card { position: relative; z-index: 1; }
        .gann-confluence-card .gann-glow {
            animation: gannPulse 2s ease-in-out infinite;
        }
        @keyframes gannPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(212,160,23,0.3); transform: scale(1); opacity: 1; }
            50% { box-shadow: 0 0 25px rgba(212,160,23,0.6); transform: scale(1.3); opacity: 0.7; }
        }
        .gann-tab:hover { filter: brightness(1.1); }
        .cycle-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.05);
            padding: 6px 10px;
            border-radius: 6px;
        }
        .cycle-bar-label {
            font-size: 10px;
            min-width: 80px;
            color: var(--muted);
        }
        .cycle-bar-track {
            flex: 1;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        .cycle-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .cycle-bar-value {
            font-size: 10px;
            font-weight: 600;
            min-width: 50px;
            text-align: right;
        }
        .angle-badge {
            background: rgba(212,160,23,0.1);
            border: 1px solid rgba(212,160,23,0.2);
            border-radius: 4px;
            padding: 4px 6px;
            text-align: center;
        }
        .angle-badge.active {
            background: rgba(212,160,23,0.3);
            border-color: #d4a017;
        }
        .angle-badge-name {
            font-size: 9px;
            color: var(--muted);
        }
        .angle-badge-value {
            font-size: 11px;
            font-weight: 600;
            color: var(--text);
        }
        .sacred-number {
            background: rgba(245,158,11,0.1);
            border: 1px solid rgba(245,158,11,0.2);
            border-radius: 4px;
            padding: 6px;
            text-align: center;
        }
        .sacred-number-value {
            font-size: 14px;
            font-weight: 700;
            color: #f59e0b;
        }
        .sacred-number-label {
            font-size: 8px;
            color: var(--muted);
        }
        .confluence-factor {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.03);
            border-radius: 6px;
        }
        .confluence-factor-icon {
            font-size: 16px;
            width: 24px;
            text-align: center;
        }
        .confluence-factor-text {
            flex: 1;
            font-size: 11px;
        }
        .confluence-factor-score {
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .confluence-factor-score.active {
            background: rgba(34,197,94,0.2);
            color: #22c55e;
        }
        .confluence-factor-score.inactive {
            background: rgba(107,114,128,0.1);
            color: var(--muted);
        }
        .sq9-level {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px dashed rgba(0,0,0,0.05);
        }
        .sq9-level:last-child { border-bottom: none; }
        .sq9-angle { color: var(--muted); }
        .sq9-price { font-weight: 600; }
        .sq9-diff { font-size: 9px; color: var(--muted); }
        .gann-date-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            background: rgba(255,255,255,0.5);
            border-radius: 4px;
        }
        .gann-date-item.near {
            background: rgba(245,158,11,0.2);
            border: 1px solid #f59e0b;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 14px; margin-bottom: 12px; }
        .card-title { font-size: 14px; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        
        .grid { display: grid; gap: 12px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
        .grid-5 { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
        
        .metric { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 10px; }
        .metric-label { font-size: 9px; font-weight: 600; color: var(--muted); text-transform: uppercase; margin-bottom: 4px; }
        .metric-value { font-size: 18px; font-weight: 700; }
        .metric-value.positive { color: var(--success); }
        .metric-value.negative { color: var(--danger); }
        .metric-sub { font-size: 9px; color: var(--light); margin-top: 2px; }
        
        .badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600; text-transform: uppercase; }
        .badge-success { background: rgba(16,185,129,0.15); color: var(--success); }
        .badge-danger { background: rgba(239,68,68,0.15); color: var(--danger); }
        .badge-warning { background: rgba(245,158,11,0.15); color: var(--warning); }
        .badge-info { background: rgba(8,145,178,0.15); color: var(--info); }
        .badge-primary { background: rgba(59,130,246,0.15); color: var(--primary); }
        .badge-ultra { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .badge-intraday { background: linear-gradient(135deg, var(--intraday), #d97706); color: white; }
        .badge-swing { background: linear-gradient(135deg, var(--swing), #6d28d9); color: white; }
        .badge-secondary { background: rgba(156,163,175,0.2); color: #6b7280; }

        .turn-rally { color: #22c55e; font-weight: 600; }
        .turn-pullback { color: #22c55e; font-weight: 600; }
        .turn-breakdown { color: #ef4444; font-weight: 600; }
        .turn-reversal { color: #f59e0b; font-weight: 600; }

        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { text-align: left; padding: 8px; font-size: 9px; font-weight: 600; color: var(--muted); text-transform: uppercase; background: var(--bg); border-bottom: 1px solid var(--border); }
        td { padding: 8px; border-bottom: 1px solid var(--border); }
        tr:hover { background: rgba(59,130,246,0.02); }
        
        .chart-box { position: relative; height: 280px; }
        
        .dual-signal-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .signal-panel { border-radius: 8px; padding: 14px; }
        .signal-panel.intraday { background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(217,119,6,0.05)); border: 2px solid var(--intraday); }
        .signal-panel.swing { background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(109,40,217,0.05)); border: 2px solid var(--swing); }
        .signal-panel-title { font-size: 13px; font-weight: 700; margin-bottom: 10px; }
        .signal-panel-title.intraday { color: var(--intraday); }
        .signal-panel-title.swing { color: var(--swing); }
        
        .ref-data-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 11px; }
        .ref-label { color: var(--muted); }
        .ref-value { font-weight: 600; }
        .ref-value.positive { color: var(--success); }
        .ref-value.negative { color: var(--danger); }
        
        .bar-count-display { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .bar-count-item { background: var(--bg); border-radius: 6px; padding: 10px; text-align: center; }
        .bar-count-value { font-size: 24px; font-weight: 800; }
        .bar-count-label { font-size: 10px; color: var(--muted); margin-top: 3px; }
        
        .pattern-item { background: var(--bg); border-radius: 6px; padding: 8px; margin-bottom: 6px; }
        .pattern-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .pattern-name { font-weight: 600; font-size: 12px; }
        .pattern-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
        .pattern-fill { height: 100%; border-radius: 2px; }
        .pattern-fill.bullish { background: var(--success); }
        .pattern-fill.bearish { background: var(--danger); }
        .pattern-fill.neutral { background: var(--warning); }

        /* AI Assistant Styles */
        .ai-assistant-container { display: grid; grid-template-columns: 1fr 320px; gap: 15px; min-height: 500px; }
        .ai-chat-panel { display: flex; flex-direction: column; background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .ai-chat-header { background: var(--ai-gradient); color: white; padding: 12px 16px; display: flex; align-items: center; gap: 10px; }
        .ai-avatar { width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .ai-chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; max-height: 450px; }
        .ai-message { max-width: 90%; padding: 10px 14px; border-radius: 12px; font-size: 12px; line-height: 1.6; }
        .ai-message.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai-message.assistant { background: var(--bg); color: var(--text); align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid var(--border); }
        .ai-message.assistant .message-content { white-space: pre-wrap; }
        .ai-chat-input { display: flex; gap: 8px; padding: 12px; border-top: 1px solid var(--border); background: var(--bg); }
        .ai-chat-input input { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 20px; font-size: 12px; outline: none; }
        .ai-chat-input input:focus { border-color: var(--primary); }
        .ai-chat-input button { padding: 10px 20px; background: var(--ai-gradient); color: white; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 12px; }
        .ai-chat-input button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .ai-sidebar { display: flex; flex-direction: column; gap: 12px; }
        .ai-quick-actions { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
        .ai-quick-actions h4 { font-size: 12px; margin-bottom: 8px; color: var(--secondary); }
        .quick-action-btn { display: block; width: 100%; padding: 7px 10px; margin-bottom: 5px; background: var(--bg); border: 1px solid var(--border); border-radius: 5px; font-size: 10px; text-align: left; cursor: pointer; transition: all 0.2s; }
        .quick-action-btn:hover { border-color: var(--primary); background: rgba(59,130,246,0.05); }
        
        .ai-data-context { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
        .ai-data-context h4 { font-size: 11px; margin-bottom: 8px; color: var(--muted); }
        .context-item { font-size: 10px; padding: 3px 0; display: flex; justify-content: space-between; }
        
        .typing-indicator { display: flex; gap: 4px; padding: 10px 14px; }
        .typing-dot { width: 8px; height: 8px; background: var(--muted); border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; flex-direction: column; gap: 15px; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 900px) {
            .ai-assistant-container { grid-template-columns: 1fr; }
            .dual-signal-container { grid-template-columns: 1fr; }
        }

        /* Trade Log Styles */
        .form-group-trade {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .form-group-trade label {
            font-size: 10px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
        }
        .form-group-trade input,
        .form-group-trade select {
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 12px;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-group-trade input:focus,
        .form-group-trade select:focus {
            border-color: var(--primary);
        }
        
        .trade-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .trade-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        .trade-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .trade-btn.secondary {
            background: var(--bg);
            color: var(--muted);
            border: 1px solid var(--border);
        }
        .trade-btn.secondary:hover {
            background: var(--border);
        }
        
        .action-btn {
            padding: 6px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .action-btn:hover {
            background: var(--card);
            border-color: var(--primary);
            color: var(--primary);
        }
        .action-btn.danger:hover {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        #tradeTable th {
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 10;
        }
        #tradeTable td {
            vertical-align: middle;
        }
        
        .trade-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            margin-right: 4px;
        }
        .trade-action-btn.edit {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
        }
        .trade-action-btn.delete {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .pnl-positive { color: var(--success); font-weight: 600; }
        .pnl-negative { color: var(--danger); font-weight: 600; }
        
        .status-badge-trade {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
        }
        .status-badge-trade.open { background: rgba(59, 130, 246, 0.15); color: var(--primary); }
        .status-badge-trade.closed { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .status-badge-trade.stopped { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        

        /* Options Calculator Styles */
        .options-calc-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 900px) {
            .options-calc-container { grid-template-columns: 1fr; }
        }
        .calc-inputs {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        .calc-inputs h3 {
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .calc-form-group {
            margin-bottom: 15px;
        }
        .calc-form-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        .calc-form-group input,
        .calc-form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .calc-form-group input:focus,
        .calc-form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        .calc-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .option-type-toggle {
            display: flex;
            gap: 8px;
        }
        .option-type-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-type-btn.call.active {
            border-color: var(--success);
            background: rgba(16,185,129,0.1);
            color: var(--success);
        }
        .option-type-btn.put.active {
            border-color: var(--danger);
            background: rgba(239,68,68,0.1);
            color: var(--danger);
        }
        .calc-results {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .calc-result-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        .calc-result-card h4 {
            font-size: 14px;
            margin-bottom: 12px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .result-item {
            background: var(--bg);
            padding: 10px;
            border-radius: 6px;
        }
        .result-item .label {
            font-size: 10px;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .result-item .value {
            font-size: 18px;
            font-weight: 700;
        }
        .result-item .value.positive { color: var(--success); }
        .result-item .value.negative { color: var(--danger); }
        .greeks-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .greek-item {
            background: linear-gradient(135deg, rgba(139,92,246,0.05), rgba(168,85,247,0.05));
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .greek-item .greek-name {
            font-size: 10px;
            color: var(--secondary);
            font-weight: 600;
            text-transform: uppercase;
        }
        .greek-item .greek-value {
            font-size: 16px;
            font-weight: 700;
            margin-top: 4px;
        }
        .use-current-btn {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
        }
        .use-current-btn:hover {
            opacity: 0.9;
        }
        .greeks-reference {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg);
            border-radius: 8px;
            font-size: 11px;
        }
        .greeks-reference h5 {
            font-size: 12px;
            margin-bottom: 10px;
            color: var(--text);
        }
        .greeks-reference table {
            width: 100%;
        }
        .greeks-reference td {
            padding: 4px 8px;
            border-bottom: 1px solid var(--border);
        }

        /* Print Styles */
        @media print {
            .login-screen, .header, .tabs, .mode-toggle-container, .symbol-banner,
            .action-btn, .trade-btn, .trade-action-btn, #tradeForm, .ai-sidebar {
                display: none !important;
            }
            .main-app { display: block !important; }
            .card { break-inside: avoid; box-shadow: none; border: 1px solid #ccc; }
            body { background: white; }
        }

        /* Health Monitor Styles */
        .health-banner {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.1));
            border: 2px solid var(--success);
        }
        .health-banner.warning {
            background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(217,119,6,0.1));
            border-color: var(--warning);
        }
        .health-banner.critical {
            background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.1));
            border-color: var(--danger);
        }
        .health-banner-icon { font-size: 32px; }
        .health-banner-content { flex: 1; }
        .health-banner-title { font-size: 18px; font-weight: 700; color: var(--text); }
        .health-banner-subtitle { font-size: 12px; color: var(--muted); margin-top: 2px; }
        .refresh-health-btn {
            padding: 8px 16px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .refresh-health-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16,185,129,0.3); }

        .health-metric {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s;
        }
        .health-metric.healthy { border-color: var(--success); background: rgba(16,185,129,0.05); }
        .health-metric.warning { border-color: var(--warning); background: rgba(245,158,11,0.05); }
        .health-metric.critical { border-color: var(--danger); background: rgba(239,68,68,0.05); }
        .health-metric-icon { font-size: 28px; margin-bottom: 8px; }
        .health-metric-label { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
        .health-metric-value { font-size: 18px; font-weight: 700; margin: 6px 0; }
        .health-metric-status { font-size: 10px; padding: 3px 8px; border-radius: 10px; display: inline-block; }
        .health-metric-status.ok { background: rgba(16,185,129,0.15); color: var(--success); }
        .health-metric-status.warn { background: rgba(245,158,11,0.15); color: var(--warning); }
        .health-metric-status.error { background: rgba(239,68,68,0.15); color: var(--danger); }

        .health-timeline { display: flex; flex-direction: column; gap: 10px; }
        .timeline-item { display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg); border-radius: 6px; }
        .timeline-label { color: var(--muted); font-size: 12px; }
        .timeline-value { font-weight: 600; font-size: 12px; }

        .connection-grid { display: flex; flex-direction: column; gap: 10px; }
        .connection-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg); border-radius: 6px; }
        .connection-indicator { font-size: 14px; }
        .connection-indicator.online { color: var(--success); }
        .connection-indicator.offline { color: var(--danger); }
        .connection-indicator.unknown { color: var(--muted); }
        .connection-status { margin-left: auto; font-size: 11px; color: var(--muted); }

        .health-alerts { display: flex; flex-direction: column; gap: 8px; }
        .health-alert {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 12px;
        }
        .health-alert.info { background: rgba(8,145,178,0.1); color: var(--info); border-left: 3px solid var(--info); }
        .health-alert.warning { background: rgba(245,158,11,0.1); color: #b45309; border-left: 3px solid var(--warning); }
        .health-alert.critical { background: rgba(239,68,68,0.1); color: var(--danger); border-left: 3px solid var(--danger); }
        .health-alert.success { background: rgba(16,185,129,0.1); color: var(--success); border-left: 3px solid var(--success); }
        .alert-icon { font-size: 16px; }

        .sys-info-item { background: var(--bg); padding: 12px; border-radius: 6px; }
        .sys-info-label { font-size: 10px; color: var(--muted); text-transform: uppercase; margin-bottom: 4px; }
        .sys-info-value { font-size: 13px; font-weight: 600; }
        .sys-info-value a { color: var(--primary); text-decoration: none; }

        .troubleshoot-accordion { display: flex; flex-direction: column; gap: 8px; }
        .troubleshoot-item { border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
        .troubleshoot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg);
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }
        .troubleshoot-header:hover { background: var(--border); }
        .troubleshoot-toggle { font-size: 18px; color: var(--muted); }
        .troubleshoot-content {
            display: none;
            padding: 16px;
            font-size: 12px;
            line-height: 1.8;
        }
        .troubleshoot-content.show { display: block; }
        .troubleshoot-content ol { margin-left: 20px; }
        .troubleshoot-content li { margin-bottom: 6px; }
        .troubleshoot-content a { color: var(--primary); }
/* === STICKY HEADER AND TABS === */
header, .main-header { position: sticky !important; top: 0 !important; z-index: 1050 !important; }
.mode-toggle-container { position: sticky !important; top: 52px !important; z-index: 1040 !important; background: #f8fafc !important; }
.symbol-banner, #symbolBanner { position: sticky !important; top: 100px !important; z-index: 1030 !important; }
#marketStatsRow { position: sticky !important; top: 138px !important; z-index: 1020 !important; background: white !important; }
.tabs { position: sticky !important; top: 178px !important; z-index: 1010 !important; background: #f8fafc !important; display: flex !important; flex-wrap: wrap !important; justify-content: center !important; gap: 6px 8px !important; box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important; }
/* === END STICKY === */

/* ==========================================
   GANN CYCLE TRADING - LIGHT THEME
   ========================================== */

.gann-cycle-section {
    background: #ffffff;
    border-radius: 15px;
    padding: 25px;
    margin-top: 20px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}

.gann-cycle-section .section-title {
    font-size: 20px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 10px;
}

.gann-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}

@media (max-width: 1200px) {
    .gann-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 768px) {
    .gann-grid { grid-template-columns: 1fr; }
}

.gann-card {
    background: #f9fafb;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #e5e7eb;
    transition: all 0.2s;
}

.gann-card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    transform: translateY(-2px);
}

.gann-card-title {
    font-size: 14px;
    font-weight: 600;
    color: #6b7280;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.gann-card-title .icon {
    font-size: 18px;
}

/* Alert Cards - Light Theme */
.gann-alert {
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: transform 0.2s;
}

.gann-alert:hover {
    transform: scale(1.02);
}

.gann-alert-critical {
    background: linear-gradient(135deg, #fef2f2, #fee2e2);
    border: 1px solid #fecaca;
}

.gann-alert-warning {
    background: linear-gradient(135deg, #fffbeb, #fef3c7);
    border: 1px solid #fde68a;
}

.gann-alert-info {
    background: linear-gradient(135deg, #eff6ff, #dbeafe);
    border: 1px solid #bfdbfe;
}

.gann-alert-success {
    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
    border: 1px solid #bbf7d0;
}

.gann-alert-title {
    font-weight: 600;
    font-size: 14px;
    color: #1f2937;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.gann-alert-subtitle {
    font-size: 12px;
    color: #6b7280;
}

.gann-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
}

.gann-badge-critical { background: #ef4444; color: white; }
.gann-badge-warning { background: #f59e0b; color: white; }
.gann-badge-info { background: #3b82f6; color: white; }
.gann-badge-success { background: #22c55e; color: white; }

/* Price Cards - Light Theme */
.gann-price-card {
    text-align: center;
    padding: 15px;
    background: #ffffff;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    transition: all 0.3s;
}

.gann-price-card.price-up {
    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
    border-color: #86efac;
}

.gann-price-card.price-down {
    background: linear-gradient(135deg, #fef2f2, #fee2e2);
    border-color: #fca5a5;
}

.gann-price-symbol {
    font-size: 12px;
    color: #6b7280;
    font-weight: 600;
    margin-bottom: 5px;
}

.gann-price-value {
    font-size: 22px;
    font-weight: 700;
    color: #1f2937;
}

.gann-price-change {
    font-size: 12px;
    margin-top: 5px;
    font-weight: 500;
}

.gann-price-change.up { color: #16a34a; }
.gann-price-change.down { color: #dc2626; }

/* Cycle Progress - Light Theme */
.gann-cycle-progress {
    margin-bottom: 15px;
}

.gann-cycle-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.gann-cycle-name {
    font-size: 13px;
    font-weight: 500;
    color: #374151;
}

.gann-cycle-days {
    font-size: 12px;
    color: #6b7280;
}

.gann-progress-bar {
    height: 10px;
    background: #e5e7eb;
    border-radius: 5px;
    overflow: hidden;
}

.gann-progress-fill {
    height: 100%;
    border-radius: 5px;
    transition: width 0.3s;
}

.gann-progress-normal { background: linear-gradient(90deg, #3b82f6, #8b5cf6); }
.gann-progress-warning { background: linear-gradient(90deg, #f59e0b, #ef4444); }
.gann-progress-critical { background: linear-gradient(90deg, #ef4444, #dc2626); }

/* Signal Box - Light Theme */
.gann-signal-box {
    text-align: center;
    padding: 20px;
    border-radius: 12px;
    border: 2px solid;
}

.gann-signal-box.signal-buy {
    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
    border-color: #22c55e;
}

.gann-signal-box.signal-sell {
    background: linear-gradient(135deg, #fef2f2, #fee2e2);
    border-color: #ef4444;
}

.gann-signal-box.signal-wait {
    background: linear-gradient(135deg, #fffbeb, #fef3c7);
    border-color: #f59e0b;
}

.gann-signal-box.signal-caution {
    background: linear-gradient(135deg, #fff7ed, #ffedd5);
    border-color: #f97316;
}

.gann-signal-label {
    font-size: 11px;
    color: #6b7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.gann-signal-value {
    font-size: 28px;
    font-weight: 700;
    margin: 8px 0;
}

.gann-signal-reason {
    font-size: 12px;
    color: #6b7280;
}

/* Pivot Timeline - Light Theme */
.gann-pivot-card {
    background: #ffffff;
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 15px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

.gann-pivot-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.gann-pivot-type {
    font-size: 11px;
    font-weight: 600;
    padding: 5px 12px;
    border-radius: 15px;
}

.gann-pivot-high {
    background: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
}

.gann-pivot-low {
    background: #f0fdf4;
    color: #16a34a;
    border: 1px solid #bbf7d0;
}

.gann-pivot-info {
    text-align: right;
}

.gann-pivot-date {
    font-size: 14px;
    font-weight: 600;
    color: #1f2937;
}

.gann-pivot-price {
    font-size: 12px;
    color: #6b7280;
}

.gann-cycle-timeline {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #e5e7eb;
}

.gann-cycle-dot {
    text-align: center;
    flex: 1;
    min-width: 55px;
    cursor: pointer;
    padding: 8px 5px;
    border-radius: 8px;
    transition: background 0.2s;
}

.gann-cycle-dot:hover {
    background: #f3f4f6;
}

.gann-cycle-dot .dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    margin: 0 auto 6px;
    border: 2px solid transparent;
}

.gann-dot-done {
    background: #22c55e;
    border-color: #16a34a;
}

.gann-dot-active {
    background: #ef4444;
    border-color: #dc2626;
    animation: gannPulse 1s infinite;
}

.gann-dot-future {
    background: #d1d5db;
    border-color: #9ca3af;
}

@keyframes gannPulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
    50% { transform: scale(1.2); box-shadow: 0 0 0 8px rgba(239,68,68,0); }
}

.gann-cycle-dot .label {
    font-size: 11px;
    color: #6b7280;
    font-weight: 500;
}

.gann-cycle-dot .date {
    font-size: 10px;
    color: #9ca3af;
}

.gann-cycle-dot .result {
    font-size: 10px;
    margin-top: 3px;
    color: #22c55e;
}

/* Trade Recommendation - Light Theme */
.gann-trade-rec {
    background: linear-gradient(135deg, #f5f3ff, #ede9fe);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #c4b5fd;
}

.gann-trade-details {
    background: #ffffff;
    border-radius: 10px;
    padding: 15px;
    margin-top: 15px;
    border: 1px solid #e5e7eb;
}

.gann-trade-section-title {
    font-size: 12px;
    font-weight: 600;
    color: #6b7280;
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e5e7eb;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.gann-trade-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #f3f4f6;
    font-size: 13px;
}

.gann-trade-row:last-child {
    border-bottom: none;
}

.gann-trade-row .label {
    color: #6b7280;
}

.gann-trade-row .value {
    font-weight: 600;
    color: #1f2937;
}

/* Sq9 Levels - Light Theme */
.gann-sq9-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.gann-sq9-section {
    background: #ffffff;
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #e5e7eb;
}

.gann-sq9-title {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.gann-sq9-support .gann-sq9-title { color: #16a34a; }
.gann-sq9-resist .gann-sq9-title { color: #dc2626; }

.gann-sq9-level {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    font-size: 12px;
    border-bottom: 1px solid #f3f4f6;
    border-radius: 6px;
    margin-bottom: 5px;
}

.gann-sq9-level:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.gann-sq9-level.near-level {
    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
    border: 1px solid #86efac;
}

.gann-sq9-level .angle {
    color: #6b7280;
    font-weight: 500;
}

.gann-sq9-level .price {
    font-weight: 600;
    color: #1f2937;
}

.gann-sq9-level .distance {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 10px;
    background: #f3f4f6;
    color: #6b7280;
}

.gann-sq9-level .distance.close {
    background: #dcfce7;
    color: #16a34a;
    font-weight: 600;
}

/* ==========================================
   GANN CYCLE OPPORTUNITIES ROADMAP
   ========================================== */

.gann-roadmap-section {
    background: #ffffff;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
}

.gann-roadmap-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e5e7eb;
    flex-wrap: wrap;
    gap: 15px;
}

.gann-roadmap-title {
    display: flex;
    align-items: center;
    gap: 12px;
}

.gann-roadmap-title h2 {
    font-size: 22px;
    font-weight: 800;
    color: #1f2937;
    margin: 0;
}

.gann-roadmap-title .pivot-badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
}

.gann-roadmap-title .pivot-badge.high {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    color: #dc2626;
    border: 1px solid #fca5a5;
}

.gann-roadmap-title .pivot-badge.low {
    background: linear-gradient(135deg, #dcfce7, #bbf7d0);
    color: #16a34a;
    border: 1px solid #86efac;
}

.gann-roadmap-pivot-info {
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 13px;
}

.gann-roadmap-pivot-info .info-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.gann-roadmap-pivot-info .info-label {
    color: #6b7280;
}

.gann-roadmap-pivot-info .info-value {
    font-weight: 700;
    color: #1f2937;
}

.gann-roadmap-pivot-info .info-value.price {
    color: #7c3aed;
    font-size: 16px;
}

.gann-roadmap-summary {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    flex-wrap: wrap;
}

.gann-roadmap-summary-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 15px;
    background: #ffffff;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.gann-roadmap-summary-item .icon { font-size: 16px; }
.gann-roadmap-summary-item .label { font-size: 11px; color: #6b7280; }
.gann-roadmap-summary-item .value { font-size: 14px; font-weight: 700; color: #1f2937; }
.gann-roadmap-summary-item .value.success { color: #16a34a; }
.gann-roadmap-summary-item .value.warning { color: #d97706; }
.gann-roadmap-summary-item .value.danger { color: #dc2626; }
.gann-roadmap-summary-item .value.info { color: #7c3aed; }

.gann-roadmap-table-container {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
}

.gann-roadmap-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1400px;
    font-size: 12px;
}

.gann-roadmap-table thead {
    background: linear-gradient(135deg, #1e3a5f, #2d1b4e);
    color: white;
}

.gann-roadmap-table th {
    padding: 14px 10px;
    text-align: left;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    border-bottom: 2px solid #0f172a;
}

.gann-roadmap-table th:first-child { border-radius: 10px 0 0 0; }
.gann-roadmap-table th:last-child { border-radius: 0 10px 0 0; }

.gann-roadmap-table tbody tr { transition: all 0.2s; }
.gann-roadmap-table tbody tr:hover { background: #f8fafc; }
.gann-roadmap-table tbody tr.row-past { background: #ffffff; }
.gann-roadmap-table tbody tr.row-active {
    background: linear-gradient(135deg, #fefce8, #fef9c3);
    border-left: 4px solid #f59e0b;
}
.gann-roadmap-table tbody tr.row-future {
    background: linear-gradient(135deg, #f5f3ff, #ede9fe);
    opacity: 0.9;
}

.gann-roadmap-table td {
    padding: 14px 10px;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
}

.gann-cycle-cell { display: flex; align-items: center; gap: 8px; }

.gann-cycle-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
}

.gann-cycle-icon.jubilee { background: linear-gradient(135deg, #fee2e2, #fecaca); color: #dc2626; }
.gann-cycle-icon.quarter { background: linear-gradient(135deg, #ffedd5, #fed7aa); color: #ea580c; }
.gann-cycle-icon.third { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #d97706; }
.gann-cycle-icon.sacred { background: linear-gradient(135deg, #f3e8ff, #e9d5ff); color: #9333ea; }
.gann-cycle-icon.half { background: linear-gradient(135deg, #ede9fe, #ddd6fe); color: #7c3aed; }
.gann-cycle-icon.threequarter { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #2563eb; }
.gann-cycle-icon.annual { background: linear-gradient(135deg, #cffafe, #a5f3fc); color: #0891b2; }

.gann-cycle-name-cell { font-weight: 700; color: #1f2937; font-size: 12px; }
.gann-cycle-days-cell { font-size: 10px; color: #6b7280; }

.gann-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 10px;
    font-weight: 700;
}

.gann-status-badge.past { background: #dcfce7; color: #16a34a; }
.gann-status-badge.active {
    background: #fef3c7;
    color: #d97706;
    animation: roadmapPulse 2s infinite;
}

@keyframes roadmapPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
    50% { box-shadow: 0 0 0 6px rgba(245, 158, 11, 0); }
}

.gann-status-badge.future { background: #ede9fe; color: #7c3aed; }

.gann-expected-move { display: flex; align-items: center; gap: 6px; }
.gann-expected-move .direction { font-weight: 700; font-size: 12px; }
.gann-expected-move .direction.low { color: #16a34a; }
.gann-expected-move .direction.high { color: #dc2626; }
.gann-expected-move .from { font-size: 10px; color: #6b7280; }

.gann-actual-result { display: flex; flex-direction: column; gap: 3px; }
.gann-actual-result .result-status { display: inline-flex; align-items: center; gap: 4px; font-weight: 700; font-size: 11px; }
.gann-actual-result .result-status.correct { color: #16a34a; }
.gann-actual-result .result-status.incorrect { color: #dc2626; }
.gann-actual-result .result-status.pending { color: #d97706; }
.gann-actual-result .result-status.predicted { color: #7c3aed; }
.gann-actual-result .result-price { font-weight: 700; font-size: 13px; color: #1f2937; }

.gann-move-percent { font-weight: 700; font-size: 13px; padding: 4px 10px; border-radius: 6px; }
.gann-move-percent.positive { background: #dcfce7; color: #16a34a; }
.gann-move-percent.negative { background: #fee2e2; color: #dc2626; }
.gann-move-percent.neutral { background: #f3f4f6; color: #6b7280; }

.gann-sq9-cell { text-align: center; }
.gann-sq9-level-cell { font-weight: 700; font-size: 12px; color: #7c3aed; }
.gann-sq9-percent { font-size: 11px; padding: 3px 8px; border-radius: 10px; font-weight: 600; }
.gann-sq9-percent.close { background: #dcfce7; color: #16a34a; }
.gann-sq9-percent.medium { background: #fef3c7; color: #d97706; }
.gann-sq9-percent.far { background: #f3f4f6; color: #6b7280; }

.gann-next-cycle { display: flex; align-items: center; gap: 5px; font-size: 11px; color: #6b7280; }
.gann-next-cycle .arrow { color: #d1d5db; }
.gann-next-cycle .name { font-weight: 600; color: #374151; }

.gann-pred-cell { text-align: center; }
.gann-pred-date { font-size: 11px; color: #6b7280; }
.gann-pred-price { font-weight: 700; font-size: 12px; color: #7c3aed; }
.gann-pred-na { color: #d1d5db; font-size: 11px; }

.gann-alignment { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.gann-alignment-bars { display: flex; gap: 3px; }
.gann-alignment-bar { width: 8px; height: 20px; border-radius: 3px; background: #e5e7eb; }
.gann-alignment-bar.filled { background: linear-gradient(180deg, #22c55e, #16a34a); }
.gann-alignment-bar.filled.warning { background: linear-gradient(180deg, #f59e0b, #d97706); }
.gann-alignment-bar.filled.danger { background: linear-gradient(180deg, #ef4444, #dc2626); }
.gann-alignment-score { font-size: 10px; font-weight: 600; color: #6b7280; }

.gann-action { display: flex; align-items: center; justify-content: center; }
.gann-action-badge {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}
.gann-action-badge.buy { background: linear-gradient(135deg, #dcfce7, #bbf7d0); border: 2px solid #86efac; }
.gann-action-badge.sell { background: linear-gradient(135deg, #fee2e2, #fecaca); border: 2px solid #fca5a5; }
.gann-action-badge.caution { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #fcd34d; }
.gann-action-badge.avoid { background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border: 2px solid #d1d5db; }
.gann-action-badge.wait { background: linear-gradient(135deg, #ede9fe, #ddd6fe); border: 2px solid #c4b5fd; }

.gann-current-price-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    background: linear-gradient(135deg, #1e3a5f, #2d1b4e);
    border-radius: 10px;
    margin-top: 15px;
    color: white;
    font-size: 12px;
    flex-wrap: wrap;
    gap: 15px;
}
.gann-current-price-bar .price-item { display: flex; align-items: center; gap: 8px; }
.gann-current-price-bar .price-label { opacity: 0.8; }
.gann-current-price-bar .price-value { font-weight: 700; font-size: 14px; }
.gann-current-price-bar .price-value.support { color: #4ade80; }
.gann-current-price-bar .price-value.resist { color: #f87171; }

.gann-etf-tabs { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
.gann-etf-tab {
    padding: 12px 25px;
    border: 2px solid #e5e7eb;
    background: #ffffff;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}
.gann-etf-tab:hover { border-color: #8b5cf6; background: #f5f3ff; }
.gann-etf-tab.active { background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-color: #7c3aed; color: white; }
.gann-etf-tab .etf-accuracy { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: rgba(255,255,255,0.2); }
.gann-etf-tab.active .etf-accuracy { background: rgba(255,255,255,0.3); }

.gann-pivot-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
.gann-pivot-tab {
    padding: 8px 16px;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.gann-pivot-tab:hover { border-color: #8b5cf6; }
.gann-pivot-tab.active { background: #8b5cf6; border-color: #8b5cf6; color: white; }
.gann-pivot-tab.ath { border-left: 3px solid #dc2626; }
.gann-pivot-tab.atl { border-left: 3px solid #16a34a; }

.gann-roadmap-legend {
    display: flex;
    gap: 20px;
    padding: 15px;
    background: #f9fafb;
    border-radius: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
    font-size: 11px;
}
.gann-legend-item { display: flex; align-items: center; gap: 6px; color: #6b7280; }
.gann-legend-icon { font-size: 14px; }

.gann-sq9-alert {
    margin-top: 15px;
    padding: 12px;
    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
    border-radius: 10px;
    border: 1px solid #86efac;
    font-size: 12px;
    color: #16a34a;
    font-weight: 500;
}

/* ETF Table - Light Theme */
.gann-etf-table {
    width: 100%;
    border-collapse: collapse;
    background: #ffffff;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
}

.gann-etf-table th {
    text-align: left;
    padding: 14px 12px;
    font-size: 11px;
    color: #6b7280;
    background: #f9fafb;
    border-bottom: 2px solid #e5e7eb;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.gann-etf-table td {
    padding: 16px 12px;
    font-size: 13px;
    border-bottom: 1px solid #f3f4f6;
    color: #1f2937;
}

.gann-etf-table tr:hover {
    background: #f9fafb;
}

.gann-etf-table tr:last-child td {
    border-bottom: none;
}

.gann-etf-symbol {
    font-weight: 700;
    font-size: 15px;
    color: #1f2937;
}

.gann-cycle-status {
    display: flex;
    align-items: center;
    gap: 8px;
}

.gann-status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.gann-signal-badge {
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 600;
}

.gann-signal-badge.buy { background: #dcfce7; color: #16a34a; }
.gann-signal-badge.sell { background: #fee2e2; color: #dc2626; }
.gann-signal-badge.wait { background: #fef3c7; color: #d97706; }
.gann-signal-badge.caution { background: #ffedd5; color: #ea580c; }

/* Trade Journal - Light Theme */
.gann-journal-entry {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px;
    background: #ffffff;
    border-radius: 12px;
    margin-bottom: 12px;
    border: 1px solid #e5e7eb;
    transition: all 0.2s;
}

.gann-journal-entry:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    border-color: #d1d5db;
}

.gann-journal-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.gann-journal-result {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
}

.gann-result-win { background: #dcfce7; }
.gann-result-loss { background: #fee2e2; }
.gann-result-open { background: #dbeafe; }

.gann-journal-info .symbol {
    font-weight: 600;
    font-size: 15px;
    color: #1f2937;
    margin-bottom: 4px;
}

.gann-journal-info .details {
    font-size: 12px;
    color: #6b7280;
}

.gann-journal-info .signal-type {
    font-size: 11px;
    color: #9ca3af;
    margin-top: 3px;
}

.gann-journal-pnl {
    text-align: right;
}

.gann-pnl-amount {
    font-weight: 700;
    font-size: 18px;
}

.gann-pnl-positive { color: #16a34a; }
.gann-pnl-negative { color: #dc2626; }
.gann-pnl-open { color: #2563eb; }

.gann-pnl-percent {
    font-size: 12px;
    color: #6b7280;
}

/* Stats Grid - Light Theme */
.gann-stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
}

@media (max-width: 768px) {
    .gann-stats-grid { grid-template-columns: repeat(2, 1fr); }
}

.gann-stat-box {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    border: 1px solid #e5e7eb;
    transition: all 0.2s;
}

.gann-stat-box:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}

.gann-stat-value {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 5px;
    color: #1f2937;
}

.gann-stat-label {
    font-size: 12px;
    color: #6b7280;
    font-weight: 500;
}

/* Form Elements - Light Theme */
.gann-form-group {
    margin-bottom: 15px;
}

.gann-form-label {
    display: block;
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 6px;
    font-weight: 500;
}

.gann-form-input,
.gann-form-select {
    width: 100%;
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    background: #ffffff;
    color: #1f2937;
    font-size: 14px;
    transition: border-color 0.2s;
}

.gann-form-input:focus,
.gann-form-select:focus {
    outline: none;
    border-color: #8b5cf6;
    box-shadow: 0 0 0 3px rgba(139,92,246,0.1);
}

/* Buttons - Light Theme */
.gann-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.gann-btn-primary {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    color: white;
}

.gann-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(139,92,246,0.4);
}

.gann-btn-secondary {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
}

.gann-btn-secondary:hover {
    background: #e5e7eb;
}

.gann-btn-success {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.gann-btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.gann-btn-sm {
    padding: 8px 16px;
    font-size: 12px;
}

.gann-btn-block {
    width: 100%;
    justify-content: center;
}

/* Calendar - Light Theme */
.gann-calendar-container {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #e5e7eb;
}

.gann-calendar-header-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.gann-calendar-month {
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
}

.gann-calendar-nav-btn {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    color: #374151;
    width: 35px;
    height: 35px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
}

.gann-calendar-nav-btn:hover {
    background: #e5e7eb;
}

.gann-calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
}

.gann-calendar-header {
    text-align: center;
    font-size: 11px;
    color: #6b7280;
    padding: 10px 0;
    font-weight: 600;
}

.gann-calendar-day {
    text-align: center;
    padding: 12px 5px;
    font-size: 13px;
    border-radius: 8px;
    background: #f9fafb;
    cursor: pointer;
    transition: all 0.2s;
    color: #374151;
}

.gann-calendar-day:hover {
    background: #e5e7eb;
}

.gann-calendar-day.today {
    background: #dbeafe;
    border: 2px solid #3b82f6;
    font-weight: 600;
}

.gann-calendar-day.cycle-day {
    background: #fee2e2;
    border: 2px solid #ef4444;
    color: #dc2626;
    font-weight: 600;
}

.gann-calendar-day.entry-zone {
    background: #dcfce7;
    border: 2px solid #22c55e;
    color: #16a34a;
    font-weight: 600;
}

/* Full Width */
.gann-full-width {
    grid-column: 1 / -1;
}

/* Modal - Light Theme */
.gann-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.gann-modal-overlay.active {
    display: flex;
}

.gann-modal {
    background: #ffffff;
    border-radius: 16px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 25px 50px rgba(0,0,0,0.25);
    max-height: 90vh;
    overflow-y: auto;
}

.gann-modal-title {
    font-size: 20px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Toast - Light Theme */
.gann-toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 2000;
}

.gann-toast {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 15px 20px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: gannSlideIn 0.3s ease;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
}

@keyframes gannSlideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.gann-toast-success { border-left: 4px solid #22c55e; }
.gann-toast-error { border-left: 4px solid #ef4444; }
.gann-toast-warning { border-left: 4px solid #f59e0b; }
.gann-toast-info { border-left: 4px solid #3b82f6; }

.gann-toast-message {
    font-size: 14px;
    color: #1f2937;
}

/* ==========================================
   GANN CYCLE PREDICTION AUTO TRACKER
   ========================================== */

.gann-tracker-section {
    background: #ffffff;
    border-radius: 15px;
    padding: 25px;
    margin-top: 25px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}

.gann-tracker-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e5e7eb;
    flex-wrap: wrap;
    gap: 15px;
}

.gann-tracker-title {
    font-size: 20px;
    font-weight: 700;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 10px;
}

.gann-tracker-controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.gann-tracker-btn {
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.gann-tracker-btn-primary {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    color: white;
}

.gann-tracker-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(139,92,246,0.4);
}

.gann-tracker-btn-success {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.gann-tracker-btn-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.gann-tracker-btn-secondary {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
}

.gann-tracker-btn-secondary:hover {
    background: #e5e7eb;
}

/* Performance Summary Cards */
.gann-perf-summary {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 15px;
    margin-bottom: 25px;
}

@media (max-width: 1200px) {
    .gann-perf-summary { grid-template-columns: repeat(3, 1fr); }
}

@media (max-width: 768px) {
    .gann-perf-summary { grid-template-columns: repeat(2, 1fr); }
}

.gann-perf-card {
    background: linear-gradient(135deg, #f9fafb, #ffffff);
    border-radius: 12px;
    padding: 18px;
    text-align: center;
    border: 1px solid #e5e7eb;
    transition: all 0.2s;
}

.gann-perf-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
}

.gann-perf-card.highlight {
    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
    border-color: #86efac;
}

.gann-perf-card.warning {
    background: linear-gradient(135deg, #fffbeb, #fef3c7);
    border-color: #fde68a;
}

.gann-perf-card.danger {
    background: linear-gradient(135deg, #fef2f2, #fee2e2);
    border-color: #fecaca;
}

.gann-perf-value {
    font-size: 32px;
    font-weight: 800;
    margin-bottom: 5px;
    color: #1f2937;
}

.gann-perf-value.success { color: #16a34a; }
.gann-perf-value.warning { color: #d97706; }
.gann-perf-value.danger { color: #dc2626; }
.gann-perf-value.info { color: #2563eb; }

.gann-perf-label {
    font-size: 11px;
    color: #6b7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Cycle Type Breakdown */
.gann-cycle-breakdown {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin-bottom: 25px;
}

@media (max-width: 1000px) {
    .gann-cycle-breakdown { grid-template-columns: repeat(2, 1fr); }
}

.gann-cycle-type-card {
    background: #ffffff;
    border-radius: 12px;
    padding: 18px;
    border: 1px solid #e5e7eb;
    position: relative;
    overflow: hidden;
}

.gann-cycle-type-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
}

.gann-cycle-type-card.jubilee::before { background: #ef4444; }
.gann-cycle-type-card.quarter::before { background: #f59e0b; }
.gann-cycle-type-card.half::before { background: #8b5cf6; }
.gann-cycle-type-card.annual::before { background: #3b82f6; }

.gann-cycle-type-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.gann-cycle-type-name {
    font-size: 14px;
    font-weight: 700;
    color: #1f2937;
}

.gann-cycle-type-badge {
    font-size: 10px;
    padding: 4px 10px;
    border-radius: 15px;
    font-weight: 600;
}

.gann-cycle-type-badge.high { background: #dcfce7; color: #16a34a; }
.gann-cycle-type-badge.medium { background: #fef3c7; color: #d97706; }
.gann-cycle-type-badge.low { background: #fee2e2; color: #dc2626; }

.gann-cycle-type-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    text-align: center;
}

.gann-cycle-type-stat {
    padding: 8px;
    background: #f9fafb;
    border-radius: 8px;
}

.gann-cycle-type-stat-value {
    font-size: 16px;
    font-weight: 700;
    color: #1f2937;
}

.gann-cycle-type-stat-label {
    font-size: 9px;
    color: #6b7280;
    text-transform: uppercase;
}

/* Predictions Table */
.gann-predictions-table-container {
    background: #ffffff;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
    margin-bottom: 25px;
}

.gann-predictions-table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
    flex-wrap: wrap;
    gap: 10px;
}

.gann-predictions-table-title {
    font-size: 14px;
    font-weight: 700;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 8px;
}

.gann-predictions-filter {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.gann-filter-btn {
    padding: 6px 12px;
    border: 1px solid #d1d5db;
    background: #ffffff;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    color: #6b7280;
}

.gann-filter-btn:hover {
    border-color: #8b5cf6;
    color: #8b5cf6;
}

.gann-filter-btn.active {
    background: #8b5cf6;
    border-color: #8b5cf6;
    color: white;
}

.gann-predictions-table {
    width: 100%;
    border-collapse: collapse;
}

.gann-predictions-table th {
    text-align: left;
    padding: 14px 16px;
    font-size: 11px;
    color: #6b7280;
    background: #f9fafb;
    border-bottom: 2px solid #e5e7eb;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.gann-predictions-table td {
    padding: 16px;
    font-size: 13px;
    border-bottom: 1px solid #f3f4f6;
    color: #1f2937;
}

.gann-predictions-table tr:hover {
    background: #f9fafb;
}

.gann-predictions-table tr:last-child td {
    border-bottom: none;
}

.gann-pred-symbol {
    font-weight: 700;
    font-size: 14px;
}

.gann-pred-cycle {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 10px;
    font-weight: 600;
}

.gann-pred-cycle.jubilee { background: #fee2e2; color: #dc2626; }
.gann-pred-cycle.quarter { background: #fef3c7; color: #d97706; }
.gann-pred-cycle.half { background: #ede9fe; color: #7c3aed; }
.gann-pred-cycle.annual { background: #dbeafe; color: #2563eb; }

.gann-pred-direction {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 600;
}

.gann-pred-direction.high { background: #fee2e2; color: #dc2626; }
.gann-pred-direction.low { background: #dcfce7; color: #16a34a; }

.gann-pred-result {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 700;
}

.gann-pred-result.correct { background: #dcfce7; color: #16a34a; }
.gann-pred-result.incorrect { background: #fee2e2; color: #dc2626; }
.gann-pred-result.pending { background: #fef3c7; color: #d97706; }

.gann-pred-price-move {
    font-weight: 600;
}

.gann-pred-price-move.positive { color: #16a34a; }
.gann-pred-price-move.negative { color: #dc2626; }

/* Active Predictions Panel */
.gann-active-predictions {
    background: linear-gradient(135deg, #f5f3ff, #ede9fe);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #c4b5fd;
    margin-bottom: 25px;
}

.gann-active-predictions-title {
    font-size: 14px;
    font-weight: 700;
    color: #5b21b6;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.gann-active-pred-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
}

.gann-active-pred-card {
    background: #ffffff;
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #ddd6fe;
    position: relative;
}

.gann-active-pred-card::after {
    content: '';
    position: absolute;
    top: 10px;
    right: 10px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #f59e0b;
    animation: activePulse 2s infinite;
}

@keyframes activePulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.3); }
}

.gann-active-pred-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.gann-active-pred-symbol {
    font-size: 18px;
    font-weight: 700;
    color: #1f2937;
}

.gann-active-pred-countdown {
    font-size: 12px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 15px;
    background: #fef3c7;
    color: #d97706;
}

.gann-active-pred-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    font-size: 12px;
}

.gann-active-pred-detail {
    display: flex;
    justify-content: space-between;
}

.gann-active-pred-detail-label {
    color: #6b7280;
}

.gann-active-pred-detail-value {
    font-weight: 600;
    color: #1f2937;
}

/* Chart Container */
.gann-perf-chart-container {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #e5e7eb;
    margin-bottom: 25px;
}

.gann-perf-chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.gann-perf-chart-title {
    font-size: 14px;
    font-weight: 700;
    color: #1f2937;
}

.gann-perf-chart-legend {
    display: flex;
    gap: 15px;
    font-size: 11px;
}

.gann-perf-chart-legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    color: #6b7280;
}

.gann-perf-chart-legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.gann-perf-chart-legend-dot.correct { background: #22c55e; }
.gann-perf-chart-legend-dot.incorrect { background: #ef4444; }
.gann-perf-chart-legend-dot.pending { background: #f59e0b; }

.gann-perf-chart {
    height: 250px;
    position: relative;
}

/* Rolling Accuracy Bar */
.gann-rolling-accuracy {
    background: #f9fafb;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
}

.gann-rolling-accuracy-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.gann-rolling-accuracy-title {
    font-size: 12px;
    font-weight: 600;
    color: #6b7280;
}

.gann-rolling-accuracy-value {
    font-size: 18px;
    font-weight: 700;
}

.gann-rolling-accuracy-bar {
    height: 12px;
    background: #e5e7eb;
    border-radius: 6px;
    overflow: hidden;
}

.gann-rolling-accuracy-fill {
    height: 100%;
    border-radius: 6px;
    transition: width 0.5s ease;
}

.gann-rolling-accuracy-fill.high { background: linear-gradient(90deg, #22c55e, #16a34a); }
.gann-rolling-accuracy-fill.medium { background: linear-gradient(90deg, #f59e0b, #d97706); }
.gann-rolling-accuracy-fill.low { background: linear-gradient(90deg, #ef4444, #dc2626); }

/* Confidence Intervals */
.gann-confidence-section {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #e5e7eb;
}

.gann-confidence-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
}

@media (max-width: 768px) {
    .gann-confidence-grid { grid-template-columns: 1fr; }
}

.gann-confidence-item {
    text-align: center;
    padding: 15px;
    background: #f9fafb;
    border-radius: 10px;
}

.gann-confidence-item-title {
    font-size: 12px;
    font-weight: 600;
    color: #6b7280;
    margin-bottom: 10px;
}

.gann-confidence-item-value {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 5px;
}

.gann-confidence-item-range {
    font-size: 11px;
    color: #9ca3af;
}

/* Empty State */
.gann-empty-state {
    text-align: center;
    padding: 50px 20px;
    color: #6b7280;
}

.gann-empty-state-icon {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
}

.gann-empty-state-title {
    font-size: 16px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
}

.gann-empty-state-desc {
    font-size: 13px;
    max-width: 400px;
    margin: 0 auto 20px;
}

/* ============================================
   SQ9 ENTRY SIGNAL MONITOR STYLES
   ============================================ */

/* SQ9 Monitor Container */
.sq9-monitor {
    background: linear-gradient(135deg, #1e3a5f 0%, #2d1b4e 100%);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    color: white;
}

.sq9-monitor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.sq9-monitor-title {
    font-size: 18px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
}

.sq9-etf-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.sq9-etf-tab {
    padding: 8px 16px;
    border: 1px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
    color: rgba(255,255,255,0.8);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.sq9-etf-tab:hover {
    background: rgba(255,255,255,0.2);
    color: white;
}

.sq9-etf-tab.active {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-color: transparent;
    color: white;
}

/* Pivot & Current Price Info */
.sq9-info-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.sq9-info-item {
    text-align: center;
}

.sq9-info-label {
    font-size: 10px;
    opacity: 0.7;
    margin-bottom: 4px;
}

.sq9-info-value {
    font-size: 16px;
    font-weight: 700;
}

.sq9-bias-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 700;
}

.sq9-bias-badge.call {
    background: linear-gradient(135deg, #22c55e, #16a34a);
}

.sq9-bias-badge.put {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.sq9-bias-badge.neutral {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

/* SQ9 Levels Table */
.sq9-levels-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
    font-size: 12px;
}

.sq9-levels-table th {
    padding: 12px 8px;
    text-align: left;
    background: rgba(0,0,0,0.3);
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.sq9-levels-table td {
    padding: 12px 8px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.sq9-levels-table tr.active-level {
    background: rgba(245,158,11,0.2);
    animation: sq9RowPulse 2s infinite;
}

.sq9-levels-table tr.ready-level {
    background: rgba(34,197,94,0.3);
    animation: sq9ReadyPulse 1.5s infinite;
}

.sq9-levels-table tr.closed-level {
    background: rgba(239,68,68,0.15);
    opacity: 0.7;
}

.sq9-levels-table tr.current-price-row {
    background: linear-gradient(90deg, rgba(59,130,246,0.3), rgba(139,92,246,0.3));
}

.sq9-levels-table tr.current-price-row td {
    padding: 8px;
    font-weight: 700;
    text-align: center;
    font-size: 14px;
}

@keyframes sq9RowPulse {
    0%, 100% { box-shadow: inset 0 0 0 0 rgba(245,158,11,0.3); }
    50% { box-shadow: inset 0 0 20px 0 rgba(245,158,11,0.2); }
}

@keyframes sq9ReadyPulse {
    0%, 100% { box-shadow: inset 0 0 0 0 rgba(34,197,94,0.4); transform: scale(1); }
    50% { box-shadow: inset 0 0 25px 0 rgba(34,197,94,0.3); }
}

.sq9-level-type {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
}

.sq9-level-type.resist {
    background: rgba(239,68,68,0.3);
    color: #fca5a5;
}

.sq9-level-type.support {
    background: rgba(34,197,94,0.3);
    color: #86efac;
}

.sq9-check-box {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.sq9-check-box.checked {
    background: rgba(34,197,94,0.3);
    color: #4ade80;
}

.sq9-check-box.unchecked {
    background: rgba(255,255,255,0.1);
    color: rgba(255,255,255,0.3);
}

.sq9-check-box.na {
    background: transparent;
    color: rgba(255,255,255,0.2);
}

.sq9-status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 700;
}

.sq9-status-badge.ready {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    animation: statusPulse 1s infinite;
}

.sq9-status-badge.watching {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.sq9-status-badge.partial {
    background: rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.8);
}

.sq9-status-badge.closed {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.sq9-status-badge.target {
    background: rgba(34,197,94,0.2);
    color: #4ade80;
}

@keyframes statusPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* Checklist Panel */
.sq9-checklist-panel {
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
}

.sq9-checklist-title {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.sq9-checklist-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}

@media (max-width: 768px) {
    .sq9-checklist-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

.sq9-check-item {
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    border: 1px solid rgba(255,255,255,0.1);
    transition: all 0.3s;
}

.sq9-check-item.passed {
    background: rgba(34,197,94,0.2);
    border-color: rgba(34,197,94,0.5);
}

.sq9-check-item.failed {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.1);
}

.sq9-check-icon {
    font-size: 24px;
    margin-bottom: 5px;
}

.sq9-check-name {
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 4px;
}

.sq9-check-detail {
    font-size: 9px;
    opacity: 0.7;
}

/* Progress Bar */
.sq9-progress-container {
    margin-bottom: 15px;
}

.sq9-progress-bar {
    height: 10px;
    background: rgba(255,255,255,0.1);
    border-radius: 5px;
    overflow: hidden;
    margin-bottom: 5px;
}

.sq9-progress-fill {
    height: 100%;
    border-radius: 5px;
    transition: width 0.5s;
}

.sq9-progress-fill.low {
    background: linear-gradient(90deg, #ef4444, #f87171);
}

.sq9-progress-fill.medium {
    background: linear-gradient(90deg, #f59e0b, #fbbf24);
}

.sq9-progress-fill.high {
    background: linear-gradient(90deg, #22c55e, #4ade80);
}

.sq9-progress-text {
    font-size: 12px;
    display: flex;
    justify-content: space-between;
}

/* Entry Zone Alert */
.sq9-entry-zone {
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
}

.sq9-entry-zone.ready {
    background: linear-gradient(135deg, rgba(34,197,94,0.3), rgba(22,163,74,0.3));
    border: 2px solid #22c55e;
    animation: entryZonePulse 2s infinite;
}

.sq9-entry-zone.closed {
    background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(220,38,38,0.2));
    border: 2px solid #ef4444;
}

.sq9-entry-zone.waiting {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.2);
}

@keyframes entryZonePulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); }
    50% { box-shadow: 0 0 30px 10px rgba(34,197,94,0.2); }
}

.sq9-entry-title {
    font-size: 18px;
    font-weight: 800;
    margin-bottom: 10px;
}

.sq9-trade-details {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin-top: 15px;
    text-align: center;
}

@media (max-width: 600px) {
    .sq9-trade-details {
        grid-template-columns: repeat(2, 1fr);
    }
}

.sq9-trade-item {
    background: rgba(0,0,0,0.2);
    border-radius: 8px;
    padding: 10px;
}

.sq9-trade-label {
    font-size: 10px;
    opacity: 0.7;
    margin-bottom: 4px;
}

.sq9-trade-value {
    font-size: 14px;
    font-weight: 700;
}

/* Alert Log */
.sq9-alert-log {
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    padding: 15px;
    max-height: 200px;
    overflow-y: auto;
}

.sq9-alert-log-title {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 10px;
    opacity: 0.8;
}

.sq9-alert-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    font-size: 11px;
}

.sq9-alert-item:last-child {
    border-bottom: none;
}

.sq9-alert-time {
    color: rgba(255,255,255,0.5);
    min-width: 70px;
}

.sq9-alert-icon {
    font-size: 14px;
}

.sq9-alert-message {
    flex: 1;
}

/* Opportunities Table SQ9 Column */
.opp-sq9-cell {
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 10px;
    min-width: 100px;
    cursor: pointer;
    transition: all 0.2s;
}

.opp-sq9-cell:hover {
    transform: scale(1.02);
}

.opp-sq9-cell.ready {
    background: linear-gradient(135deg, #dcfce7, #bbf7d0);
    border: 2px solid #22c55e;
    animation: oppSq9Pulse 1.5s infinite;
}

.opp-sq9-cell.watching {
    background: linear-gradient(135deg, #fef9c3, #fef08a);
    border: 1px solid #eab308;
}

.opp-sq9-cell.partial {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
}

.opp-sq9-cell.closed {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    border: 1px solid #ef4444;
}

.opp-sq9-cell.none {
    background: transparent;
    border: 1px solid #e5e7eb;
    color: #9ca3af;
}

@keyframes oppSq9Pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); }
    50% { box-shadow: 0 0 10px 3px rgba(34,197,94,0.2); }
}

.opp-sq9-status {
    font-weight: 700;
    display: block;
}

.opp-sq9-level {
    font-size: 9px;
    opacity: 0.8;
    display: block;
    margin-top: 2px;
}

.opp-sq9-cell.ready .opp-sq9-status { color: #16a34a; }
.opp-sq9-cell.watching .opp-sq9-status { color: #ca8a04; }
.opp-sq9-cell.partial .opp-sq9-status { color: #6b7280; }
.opp-sq9-cell.closed .opp-sq9-status { color: #dc2626; }

/* SQ9 Alignment Badge Styles */
.sq9-align-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    white-space: nowrap;
}

.sq9-align-badge.aligned {
    background: rgba(34, 197, 94, 0.15);
    color: #22c55e;
}

.sq9-align-badge.partial {
    background: rgba(245, 158, 11, 0.15);
    color: #f59e0b;
}

.sq9-align-badge.near {
    background: rgba(59, 130, 246, 0.15);
    color: #3b82f6;
}

.sq9-align-badge.far {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
}

/* Pattern Scanner Styles */
.pattern-filter-btn {
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: white;
    color: var(--text);
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}
.pattern-filter-btn:hover {
    background: var(--card);
    border-color: #2563eb;
}
.pattern-filter-btn.active {
    background: #2563eb;
    border-color: #2563eb;
    color: white;
}
.pattern-signal-call {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 11px;
    background: #dcfce7;
    color: #16a34a;
}
.pattern-signal-put {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 11px;
    background: #fee2e2;
    color: #dc2626;
}
.pattern-signal-wait {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 11px;
    background: #fef3c7;
    color: #ca8a04;
}
.pattern-tf-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
}
.pattern-tf-daily { background: #f3e8ff; color: #7c3aed; }
.pattern-tf-15m { background: #dbeafe; color: #2563eb; }
.pattern-tf-5m { background: #fef3c7; color: #ca8a04; }
.pattern-align-yes { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 600; background: #dcfce7; color: #16a34a; }
.pattern-align-partial { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 600; background: #fef3c7; color: #ca8a04; }
.pattern-align-no { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 600; background: #fee2e2; color: #dc2626; }
.pattern-trade-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 11px;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
}
.pattern-trade-btn-trade { background: #16a34a; color: white; }
.pattern-trade-btn-trade:hover { background: #15803d; }
.pattern-trade-btn-watch { background: #ca8a04; color: white; }
.pattern-trade-btn-monitor { background: #2563eb; color: white; }
.pattern-trade-btn-avoid { background: #94a3b8; color: white; }
#patternScannerBody tr:hover { background: #f8fafc; }
#patternAccuracyTable tr:hover { background: #f8fafc; }
#patternAccuracyTable td { padding: 12px; border-bottom: 1px solid var(--border); }

/* Sortable Table Styles */
.sortable-header {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 16px !important;
    transition: background-color 0.15s ease;
}
.sortable-header:hover {
    background-color: rgba(59, 130, 246, 0.1) !important;
}
.sortable-header::after {
    content: '';
    position: absolute;
    right: 2px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 8px;
    opacity: 0.4;
    color: #666;
}
.sortable-header.sort-asc::after {
    content: '';
    opacity: 1;
    color: #3b82f6;
}
.sortable-header.sort-desc::after {
    content: '';
    opacity: 1;
    color: #3b82f6;
}
.sortable-header.sort-asc,
.sortable-header.sort-desc {
    background-color: rgba(59, 130, 246, 0.08) !important;
}
#oppTableBody tr:hover {
    background-color: #f8fafc;
}

/* Body padding for fixed Last Updated bar */
body {
    padding-top: 45px !important;
}

/* Trade Direction Context Styles */
.trade-context-box {
    background: linear-gradient(135deg, rgba(37,99,235,0.1), rgba(139,92,246,0.1));
    border: 1px solid rgba(37,99,235,0.3);
    border-radius: 12px;
    padding: 16px;
    margin: 12px 0;
}
.phase-current {
    font-size: 15px;
    font-weight: 700;
    color: #f59e0b;
    margin-bottom: 4px;
}
.phase-detail {
    font-size: 12px;
    color: #888;
    margin-bottom: 12px;
    padding-left: 20px;
}
.phase-turn {
    font-size: 15px;
    font-weight: 700;
    color: #22c55e;
    margin-bottom: 4px;
}
.phase-action {
    font-size: 13px;
    color: #22c55e;
    margin-bottom: 12px;
    padding-left: 20px;
}
.entry-strategy {
    background: rgba(34,197,94,0.15);
    border-left: 4px solid #22c55e;
    padding: 10px 12px;
    font-size: 12px;
    font-weight: 600;
    color: #22c55e;
    border-radius: 0 8px 8px 0;
}
/* Bearish variant */
.trade-context-box.bearish .phase-turn {
    color: #ef4444;
}
.trade-context-box.bearish .phase-action {
    color: #ef4444;
}
.trade-context-box.bearish .entry-strategy {
    background: rgba(239,68,68,0.15);
    border-left-color: #ef4444;
    color: #ef4444;
}

/* ============================================
   TRADE SEQUENCE DISPLAY STYLES
   ============================================ */
.trade-sequence-container {
    background: var(--card);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid var(--border);
}

.sequence-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
}

.symbol-info .symbol {
    font-size: 28px;
    font-weight: 700;
}

.symbol-info .price {
    font-size: 18px;
    color: #888;
    margin-left: 12px;
}

.confluence-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 14px;
    background: rgba(34,197,94,0.15);
    color: #22c55e;
}

.confluence-badge.put-bias {
    background: rgba(239,68,68,0.15);
    color: #ef4444;
}

.trade-box {
    border-radius: 12px;
    padding: 16px;
    margin: 12px 0;
}

.trade-box.pullback {
    background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(239,68,68,0.03));
    border: 1px solid rgba(239,68,68,0.3);
}

.trade-box.bounce {
    background: linear-gradient(135deg, rgba(34,197,94,0.08), rgba(34,197,94,0.03));
    border: 1px solid rgba(34,197,94,0.3);
}

.trade-box.rally {
    background: linear-gradient(135deg, rgba(34,197,94,0.08), rgba(34,197,94,0.03));
    border: 1px solid rgba(34,197,94,0.3);
}

.trade-box.drop {
    background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(239,68,68,0.03));
    border: 1px solid rgba(239,68,68,0.3);
}

.trade-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.trade-number {
    font-weight: 700;
    font-size: 14px;
}

.trade-phase {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.pullback .trade-phase, .drop .trade-phase {
    background: rgba(239,68,68,0.15);
    color: #ef4444;
}

.bounce .trade-phase, .rally .trade-phase {
    background: rgba(34,197,94,0.15);
    color: #22c55e;
}

.trade-timing {
    font-size: 12px;
    color: #888;
    margin-left: auto;
}

.trade-direction {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    border-radius: 10px;
    margin-bottom: 14px;
}

.trade-direction.put {
    background: rgba(239,68,68,0.15);
}

.trade-direction.call {
    background: rgba(34,197,94,0.15);
}

.direction-icon {
    font-size: 24px;
}

.direction-text {
    font-size: 18px;
    font-weight: 700;
}

.trade-direction.put .direction-text {
    color: #ef4444;
}

.trade-direction.call .direction-text {
    color: #22c55e;
}

.trade-levels {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 14px;
}

.trade-levels .level {
    text-align: center;
    padding: 10px;
    border-radius: 8px;
    background: rgba(255,255,255,0.03);
}

.trade-levels .label {
    display: block;
    font-size: 10px;
    color: #888;
    margin-bottom: 4px;
}

.trade-levels .value {
    display: block;
    font-size: 16px;
    font-weight: 700;
}

.trade-levels .sublabel {
    display: block;
    font-size: 9px;
    color: #888;
}

.level.entry .value { color: #3b82f6; }
.level.target .value { color: #22c55e; }
.level.stop .value { color: #ef4444; }
.level.rr .value { color: #f59e0b; }

.trade-details {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: #888;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.05);
}

.exit-note {
    color: #f59e0b;
    font-weight: 500;
}

.entry-note {
    color: #22c55e;
    font-weight: 500;
}

/* Timeline between trades */
.trade-timeline {
    display: flex;
    align-items: center;
    padding: 10px 0;
}

.timeline-line {
    flex: 1;
    height: 2px;
    background: linear-gradient(90deg, rgba(239,68,68,0.5), rgba(34,197,94,0.5));
}

.timeline-turn {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px 16px;
    background: rgba(245,158,11,0.15);
    border: 2px solid #f59e0b;
    border-radius: 12px;
    margin: 0 12px;
}

.timeline-turn span:first-child {
    font-weight: 700;
    color: #f59e0b;
}

.timeline-turn span:last-child {
    font-size: 10px;
    color: #888;
}

/* Trade Sequence in Table */
.trade-seq-cell {
    font-size: 10px;
    min-width: 180px;
}

.trade-seq-cell .seq-trade {
    padding: 3px 6px;
    border-radius: 4px;
    margin-bottom: 2px;
}

.trade-seq-cell .seq-trade.put {
    background: rgba(239,68,68,0.1);
    color: #ef4444;
}

.trade-seq-cell .seq-trade.call {
    background: rgba(34,197,94,0.1);
    color: #22c55e;
}

.trade-seq-cell .seq-divider {
    color: #888;
    font-size: 9px;
    text-align: center;
    padding: 2px 0;
}

    </style>
</head>
<body>
    <!-- GLOBAL LAST UPDATED MONITOR -->
    <div id="lastUpdatedBar" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(90deg, #1e293b, #0f172a);
        padding: 8px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 11px;
        z-index: 1000;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    ">
        <div style="display: flex; gap: 20px; align-items: center;">
            <span style="color: #888;"> Stock Agent 4</span>
            <span id="marketStatusBar" style="padding: 3px 10px; border-radius: 10px; font-weight: 600; background: rgba(34,197,94,0.2); color: #22c55e;">
                 MARKET OPEN
            </span>
        </div>
        <div style="display: flex; gap: 24px; align-items: center;">
            <div>
                <span style="color: #888;">Scanner:</span>
                <span id="scannerLastUpdate" style="color: #22c55e; font-weight: 500;">--</span>
            </div>
            <div>
                <span style="color: #888;">Prices:</span>
                <span id="pricesLastUpdate" style="color: #22c55e; font-weight: 500;">--</span>
            </div>
            <div>
                <span style="color: #888;">Signals:</span>
                <span id="signalsLastUpdate" style="color: #22c55e; font-weight: 500;">--</span>
            </div>
            <button onclick="refreshAllData()" style="
                padding: 4px 12px;
                border-radius: 6px;
                border: 1px solid #22c55e;
                background: transparent;
                color: #22c55e;
                cursor: pointer;
                font-size: 10px;
            "> Refresh</button>
        </div>
    </div>

    <!-- LOGIN SCREEN (BYPASSED) -->
    <div class="login-screen" id="loginScreen" style="display: none;">
        <div class="login-container">
            <div class="login-logo"></div>
            <h1 class="login-title">Stock Agent 4</h1>
            <p class="login-subtitle">Q5D Options Trading Platform</p>
            
            <div class="login-error" id="loginError">
                Invalid username or password. Please try again.
            </div>
            
            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter your username" required autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required autocomplete="current-password">
                </div>
                
                <div class="remember-me">
                    <input type="checkbox" id="rememberMe" checked>
                    <label for="rememberMe">Remember me (stay logged in)</label>
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">
                    Sign In
                </button>
            </form>
            
            <div class="login-footer">
                <p> Secure Access | Powered by Gann Principles</p>
            </div>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div class="main-app visible" id="mainApp" style="display: block;">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div>Loading data...</div>
        </div>

        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon"></div>
                    <div><h1>Stock Agent 4</h1><p>Q5D Options Platform</p></div>
                </div>
                
                <div class="live-price-ticker">
                    <div>
                        <div class="ticker-symbol" id="tickerSymbol">SPY</div>
                        <div style="font-size:9px;opacity:0.8;" id="tickerName">S&P 500 ETF</div>
                    </div>
                    <div class="ticker-price" id="tickerPrice">$675.02</div>
                    <div>
                        <div class="ticker-change positive" id="tickerChange">+$6.29</div>
                        <div style="font-size:9px;margin-top:1px;" id="tickerPct">+0.94%</div>
                    </div>
                </div>
                
                <div class="header-controls">
                    <div class="status-badge" id="headerHealthBadge" onclick="switchToHealthTab()"><span class="status-dot" id="headerHealthDot"></span><span id="headerHealthText">CHECKING</span></div>
                    <div class="symbol-select">
                        <select id="symbolSelect" onchange="changeSymbol()">
                            <optgroup label="Index ETFs">
                                <option value="SPY">SPY - S&P 500</option>
                                <option value="QQQ">QQQ - Nasdaq 100</option>
                                <option value="IWM">IWM - Russell 2000</option>
                                <option value="DIA">DIA - Dow 30</option>
                            </optgroup>
                            <optgroup label="Sector ETFs">
                                <option value="XLF">XLF - Financials</option>
                                <option value="XLE">XLE - Energy</option>
                                <option value="XLK">XLK - Technology</option>
                                <option value="XLV">XLV - Healthcare</option>
                                <option value="XLI">XLI - Industrials</option>
                                <option value="XLB">XLB - Materials</option>
                                <option value="XLU">XLU - Utilities</option>
                                <option value="XLP">XLP - Staples</option>
                                <option value="XLY">XLY - Discretionary</option>
                            </optgroup>
                            <optgroup label="Mega Caps">
                                <option value="AAPL">AAPL - Apple</option>
                                <option value="MSFT">MSFT - Microsoft</option>
                                <option value="NVDA">NVDA - Nvidia</option>
                                <option value="TSLA">TSLA - Tesla</option>
                                <option value="AMZN">AMZN - Amazon</option>
                                <option value="GOOGL">GOOGL - Alphabet</option>
                                <option value="META">META - Meta</option>
                                <option value="JPM">JPM - JPMorgan</option>
                                <option value="AMD">AMD - AMD</option>
                                <option value="NFLX">NFLX - Netflix</option>
                            </optgroup>
                            <optgroup label="Additional Stocks">
                                <option value="V">V - Visa</option>
                                <option value="MA">MA - Mastercard</option>
                                <option value="UNH">UNH - UnitedHealth</option>
                                <option value="HD">HD - Home Depot</option>
                                <option value="PG">PG - Procter & Gamble</option>
                                <option value="BAC">BAC - Bank of America</option>
                                <option value="WMT">WMT - Walmart</option>
                                <option value="DIS">DIS - Disney</option>
                                <option value="COST">COST - Costco</option>
                                <option value="CRM">CRM - Salesforce</option>
                                <option value="INTC">INTC - Intel</option>
                                <option value="CSCO">CSCO - Cisco</option>
                                <option value="ADBE">ADBE - Adobe</option>
                                <option value="ORCL">ORCL - Oracle</option>
                                <option value="PFE">PFE - Pfizer</option>
                                <option value="MRK">MRK - Merck</option>
                                <option value="ABBV">ABBV - AbbVie</option>
                                <option value="LLY">LLY - Eli Lilly</option>
                                <option value="CVX">CVX - Chevron</option>
                                <option value="XOM">XOM - Exxon</option>
                            </optgroup>
                        </select>
                    </div>
                    <button id="refreshBtn" class="refresh-btn" onclick="refreshAllData()" style="display: flex; align-items: center; gap: 5px;"><span id="refreshIcon"></span> Refresh</button>
                    <div class="user-info">
                        <div class="user-avatar"></div>
                        <span id="loggedInUser">User</span>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">Logout</button>
                </div>
            </div>
        </header>

    <div class="container">
        <div class="mode-toggle-container">
            <div class="mode-toggle">
                <button class="mode-btn intraday active" onclick="setTradingMode('intraday')"> INTRADAY</button>
                <button class="mode-btn swing" onclick="setTradingMode('swing')"> SWING</button>
            </div>
        </div>

        <div class="symbol-banner intraday-mode" id="symbolBanner">
            <div><strong id="currentSymbolDisplay">SPY</strong> - <span id="currentSymbolName">S&P 500 ETF</span> | <span id="currentModeDisplay">INTRADAY</span></div>
            <div style="font-size:11px;"> <span id="dataDate">--</span>  <span id="dataTime">--</span></div>
        </div>

        <!-- Market Stats Row -->
        <div id="marketStatsRow" style="display: flex; gap: 20px; justify-content: center; align-items: center; padding: 8px 15px; background: var(--card); border-radius: 8px; margin-bottom: 12px; font-size: 12px; border: 1px solid var(--border);">
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="color: var(--muted);">Today:</span>
                <span style="color: #ef4444;" id="statTodayLow">L: $--</span>
                <span style="color: var(--muted);">|</span>
                <span style="color: #22c55e;" id="statTodayHigh">H: $--</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="color: var(--muted);">52W:</span>
                <span id="stat52WRange" style="color: var(--text);">$-- - $--</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="color: var(--muted);">Vol:</span>
                <span id="statVolumeVsAvg" style="color: var(--text);">-- vs Avg</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
                <span style="color: var(--muted);"></span>
                <span id="globalLastUpdated" style="color: var(--muted); font-size: 11px;" title="Last data refresh">--</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="trade-action" style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white;"> Trade Action</button>
            <button class="tab-btn" data-tab="overview"> Overview</button>
            <button class="tab-btn" data-tab="barcount"> Bar Count</button>
            <button class="tab-btn" data-tab="signals"> Signals & Agents</button>
            <button class="tab-btn" data-tab="patterns"> Patterns</button>
            <button class="tab-btn" data-tab="trades"> Trades</button>
            <button class="tab-btn" data-tab="opportunities">Opportunities</button>
            <button class="tab-btn health-tab" data-tab="health"> Health</button>
            <button class="tab-btn ai-tab" data-tab="ai-assistant"> AI Assistant</button>
            <button class="tab-btn analysis-tab" data-tab="daily-analysis"> Daily Analysis</button>
            <button class="tab-btn gann-tab" data-tab="gann-analysis" style="background: linear-gradient(135deg, #d4a017, #b8860b); color: white;"> Gann Analysis</button>
            <button class="tab-btn market-tab" data-tab="market-analysis" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;"> Market Analysis</button>
            <button class="tab-btn performance-tab" data-tab="performance-tracker" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;"> Performance</button>
            <button class="tab-btn charts-tab" data-tab="multi-charts"> Multi-Charts</button>
            <button class="tab-btn" data-tab="options-calc" style="background: linear-gradient(135deg, #10b981, #059669); color: white;"> Options Calc</button>
            <button class="tab-btn" data-tab="mtf-bias" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white;"> MTF Bias</button>
            <button class="tab-btn" data-tab="reports" style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white;"> Reports</button>
            <button class="tab-btn" data-tab="gann-rules" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;"> Gann Rules</button>
            <button class="tab-btn" data-tab="options-calc-advanced" style="background: linear-gradient(135deg, #ec4899, #db2777); color: white;"> Options Pro</button>
            <button class="tab-btn" data-tab="gann-cycles" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;"> Gann Cycles</button>
            <button class="tab-btn" data-tab="action-center" style="background: linear-gradient(135deg, #f97316, #ea580c); color: white;"> Dual Trade Setup</button>
            <button class="tab-btn" data-tab="workflow-center" style="background: linear-gradient(135deg, #059669, #047857); color: white;"> Action Center</button>
            <button class="tab-btn" data-tab="sq9-scanner" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;"> SQ9 Scanner</button>
            <button class="tab-btn" data-tab="sq9-performance" style="background: linear-gradient(135deg, #10b981, #059669); color: white;"> SQ9 Performance</button>
        </div>

        <!-- OVERVIEW TAB -->
        <!-- TIERED ACTION CENTER (Replaces Trade Action) -->
        <div id="trade-action" class="tab-content active">

            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <h2 style="margin: 0; font-size: 20px;"> Action Center</h2>
                    <span id="tieredReadyHeader" style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: rgba(34,197,94,0.15); color: #22c55e;">-- Ready</span>
                </div>
                <button onclick="renderTieredActionCenter()" style="padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; font-size: 12px;">
                     Refresh
                </button>
            </div>

            <!-- Workflow Funnel -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;">
                <div style="background: var(--card); border-radius: 12px; padding: 16px; text-align: center;">
                    <div style="font-size: 32px; font-weight: 700; color: #3b82f6;">50</div>
                    <div style="font-size: 11px; color: #888;">Total Symbols</div>
                </div>
                <div style="background: var(--card); border-radius: 12px; padding: 16px; text-align: center;">
                    <div id="tieredTier1Count" style="font-size: 32px; font-weight: 700; color: #f59e0b;">--</div>
                    <div style="font-size: 11px; color: #888;">Tier 1 Passed</div>
                    <div style="font-size: 9px; color: #666;">3/4 Consensus</div>
                </div>
                <div style="background: var(--card); border-radius: 12px; padding: 16px; text-align: center;">
                    <div id="tieredTier2Count" style="font-size: 32px; font-weight: 700; color: #22c55e;">--</div>
                    <div style="font-size: 11px; color: #888;">Tier 2 Passed</div>
                    <div style="font-size: 9px; color: #666;">2/3 Technical</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05)); border: 1px solid rgba(34,197,94,0.3); border-radius: 12px; padding: 16px; text-align: center;">
                    <div id="tieredReadyCount" style="font-size: 32px; font-weight: 700; color: #22c55e;">--</div>
                    <div style="font-size: 11px; color: #888;">Ready to Trade</div>
                    <div style="font-size: 9px; color: #22c55e;">6-7/7 Score</div>
                </div>
            </div>

            <!-- Filter Pills -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                <button onclick="filterTieredAction('all')" class="tiered-filter-pill active" data-filter="all" style="padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border); background: rgba(59,130,246,0.15); color: #3b82f6; cursor: pointer; font-size: 11px;">All</button>
                <button onclick="filterTieredAction('ready')" class="tiered-filter-pill" data-filter="ready" style="padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; font-size: 11px;"> Ready</button>
                <button onclick="filterTieredAction('approaching')" class="tiered-filter-pill" data-filter="approaching" style="padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; font-size: 11px;"> Approaching</button>
                <button onclick="filterTieredAction('watching')" class="tiered-filter-pill" data-filter="watching" style="padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; font-size: 11px;"> Watching</button>
            </div>

            <!-- Results Table -->
            <div style="overflow-x: auto; background: var(--card); border-radius: 12px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background: rgba(59,130,246,0.1);">
                            <th style="padding: 12px; text-align: left;">Symbol</th>
                            <th style="padding: 12px; text-align: center;">Direction</th>
                            <th style="padding: 12px; text-align: center;">Tier 1<br><span style="font-weight: 400; font-size: 9px;">Consensus</span></th>
                            <th style="padding: 12px; text-align: center;">Tier 2<br><span style="font-weight: 400; font-size: 9px;">Technical</span></th>
                            <th style="padding: 12px; text-align: center;">Score</th>
                            <th style="padding: 12px; text-align: center;">Strike<br><span style="font-weight: 400; font-size: 9px;">($50-75)</span></th>
                            <th style="padding: 12px; text-align: center;">Move Needed</th>
                            <th style="padding: 12px; text-align: center;">Status</th>
                            <th style="padding: 12px; text-align: center;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="tieredActionBody">
                        <tr><td colspan="9" style="text-align: center; padding: 40px; color: #888;">Loading tiered analysis...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Tier Criteria Legend -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px;">
                <div style="background: rgba(245,158,11,0.1); border-radius: 10px; padding: 12px; border-left: 3px solid #f59e0b;">
                    <div style="font-size: 12px; font-weight: 700; color: #f59e0b; margin-bottom: 6px;">Tier 1: Consensus (3/4)</div>
                    <div style="font-size: 10px; color: #888; line-height: 1.5;"> Agent direction<br> SQ9 level<br> Gann turn date<br> MTF score</div>
                </div>
                <div style="background: rgba(59,130,246,0.1); border-radius: 10px; padding: 12px; border-left: 3px solid #3b82f6;">
                    <div style="font-size: 12px; font-weight: 700; color: #3b82f6; margin-bottom: 6px;">Tier 2: Technical (2/3)</div>
                    <div style="font-size: 10px; color: #888; line-height: 1.5;"> Trend aligned<br> SQ9 &lt;2% away<br> R:R 2:1</div>
                </div>
                <div style="background: rgba(34,197,94,0.1); border-radius: 10px; padding: 12px; border-left: 3px solid #22c55e;">
                    <div style="font-size: 12px; font-weight: 700; color: #22c55e; margin-bottom: 6px;">Tier 3: Strike Calculator</div>
                    <div style="font-size: 10px; color: #888; line-height: 1.5;"> $30-75 budget<br> OTM 2-10%<br> Move % required</div>
                </div>
            </div>
        </div>

        <div id="overview" class="tab-content">

            <!-- Overview Tab Header with Last Updated -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 20px; color: var(--text);"> Market Overview</h2>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span id="overviewLastUpdated" style="font-size: 11px; color: #888; padding: 4px 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                        Updated: --
                    </span>
                    <button onclick="refreshOverviewTab()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #22c55e; background: transparent; color: #22c55e; cursor: pointer; font-size: 11px;">
                         Refresh
                    </button>
                </div>
            </div>

            <!-- CRITICAL GANN ALERT BANNER -->
            <div id="gannCriticalBanner" style="display: none; background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: white; border-radius: 10px; padding: 15px 20px; margin-bottom: 20px; animation: gannPulse 2s infinite;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="font-size: 28px;"></div>
                        <div>
                            <div style="font-size: 14px; font-weight: 700;" id="gannCriticalTitle">GANN SQUARE CROSS DETECTED!</div>
                            <div style="font-size: 12px; opacity: 0.9;" id="gannCriticalSubtitle">Major reversal signal - Review immediately</div>
                        </div>
                    </div>
                    <div id="gannCriticalSymbols" style="display: flex; gap: 8px;">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Market Conditions Guard Rail -->
            <div id="marketConditionsGuard" class="card" style="margin-bottom: 20px; border: 2px solid #3b82f6;">
                <div style="padding: 15px; background: linear-gradient(135deg, #eff6ff, #dbeafe);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #1e40af; font-size: 16px;"> Market Conditions Guard Rail</h3>
                        <span id="marketConditionStatus" style="background: #22c55e; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">FAVORABLE</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                        <div style="background: white; border-radius: 8px; padding: 12px; text-align: center; border: 1px solid #e2e8f0;">
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">VIX Level</div>
                            <div id="vixLevel" style="font-size: 20px; font-weight: bold; color: #22c55e;">14.7</div>
                            <div id="vixLabel" style="font-size: 10px; color: #22c55e;">Low Vol </div>
                        </div>
                        <div style="background: white; border-radius: 8px; padding: 12px; text-align: center; border: 1px solid #e2e8f0;">
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">SPY Trend</div>
                            <div id="spyTrend" style="font-size: 20px; font-weight: bold; color: #22c55e;"> UP</div>
                            <div id="spyTrendLabel" style="font-size: 10px; color: #22c55e;">Above 20MA </div>
                        </div>
                        <div style="background: white; border-radius: 8px; padding: 12px; text-align: center; border: 1px solid #e2e8f0;">
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">Breadth</div>
                            <div id="breadthLevel" style="font-size: 20px; font-weight: bold; color: #22c55e;">56%</div>
                            <div id="breadthLabel" style="font-size: 10px; color: #22c55e;">Positive </div>
                        </div>
                        <div style="background: white; border-radius: 8px; padding: 12px; text-align: center; border: 1px solid #e2e8f0;">
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">Conditions</div>
                            <div id="conditionsScore" style="font-size: 20px; font-weight: bold; color: #22c55e;">3/3</div>
                            <div id="conditionsLabel" style="font-size: 10px; color: #22c55e;">Green </div>
                        </div>
                    </div>
                    <div id="marketConditionMessage" style="margin-top: 12px; padding: 10px; background: rgba(34,197,94,0.1); border-radius: 6px; font-size: 12px; color: #166534; text-align: center;">
                         Market conditions support trading. Proceed with normal positioning.
                    </div>
                </div>
            </div>

            <!-- TODAY'S TREND-AWARE SETUPS -->
            <div style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(22,163,74,0.1)); border: 2px solid rgba(34,197,94,0.4); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;"></span>
                        <div>
                            <div style="font-size: 18px; font-weight: 800; color: #166534;">TODAY'S SETUPS</div>
                            <div style="font-size: 11px; color: #22c55e;" id="todaysSetupsTime">Trend + SQ9 Level Alignment</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="scanTodaysSetups()" style="padding: 8px 16px; background: #22c55e; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer;"> SCAN NOW</button>
                    </div>
                </div>

                <!-- Setup Cards Container -->
                <div id="todaysSetupsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 30px; color: #666; grid-column: 1 / -1;">
                        Click "SCAN NOW" to find trend-aligned setups...
                    </div>
                </div>

                <!-- Legend -->
                <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 8px; display: flex; justify-content: center; gap: 20px; font-size: 10px;">
                    <span><span style="color: #22c55e; font-weight: bold;">UPTREND + SUPPORT</span> = BUY CALL</span>
                    <span><span style="color: #ef4444; font-weight: bold;">DOWNTREND + RESISTANCE</span> = BUY PUT</span>
                    <span style="color: #666;">Other = NO SETUP</span>
                </div>
            </div>

            <!-- TODAY'S SQ9 SETUPS WIDGET -->
            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 1px solid rgba(102,126,234,0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;"></span>
                        <div>
                            <div style="font-size: 16px; font-weight: 700;">Today's SQ9 Setups</div>
                            <div style="font-size: 11px; color: var(--muted);" id="sq9WidgetTime">Last scan: --</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="loadSq9ScannerResults()" style="padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer;"> Refresh</button>
                        <button onclick="document.querySelector('[data-tab=sq9-scanner]').click()" style="padding: 6px 12px; background: var(--secondary); color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer;">View All </button>
                    </div>
                </div>

                <!-- Ready Alerts -->
                <div id="sq9ReadyAlerts" style="margin-bottom: 15px;">
                    <!-- Will be populated by JS -->
                </div>

                <!-- Quick Summary -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="background: rgba(34,197,94,0.15); border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 9px; color: #22c55e;"> READY</div>
                        <div id="sq9WidgetReady" style="font-size: 20px; font-weight: 800; color: #22c55e;">0</div>
                    </div>
                    <div style="background: rgba(245,158,11,0.15); border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 9px; color: #f59e0b;"> WATCHING</div>
                        <div id="sq9WidgetWatching" style="font-size: 20px; font-weight: 800; color: #f59e0b;">0</div>
                    </div>
                    <div style="background: rgba(59,130,246,0.15); border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 9px; color: #3b82f6;"> CALLS</div>
                        <div id="sq9WidgetCalls" style="font-size: 20px; font-weight: 800; color: #3b82f6;">0</div>
                    </div>
                    <div style="background: rgba(239,68,68,0.15); border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 9px; color: #ef4444;"> PUTS</div>
                        <div id="sq9WidgetPuts" style="font-size: 20px; font-weight: 800; color: #ef4444;">0</div>
                    </div>
                </div>

                <!-- Top Setups Table -->
                <div style="background: white; border-radius: 8px; overflow: hidden; border: 1px solid var(--border);">
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: var(--bg);">
                                <th style="padding: 8px; text-align: left;">SYMBOL</th>
                                <th style="padding: 8px; text-align: left;">PRICE</th>
                                <th style="padding: 8px; text-align: left;">SQ9 LVL</th>
                                <th style="padding: 8px; text-align: left;">DIST</th>
                                <th style="padding: 8px; text-align: left;">DIR</th>
                                <th style="padding: 8px; text-align: left;">STATUS</th>
                                <th style="padding: 8px; text-align: left;">ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="sq9WidgetTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">Loading scanner results...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- GANN PRICE RULES ALERTS (Rules 3, 4, 5) -->
            <div style="background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(217,119,6,0.05)); border: 1px solid rgba(245,158,11,0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 16px; font-weight: 700;"> Gann Price Rule Alerts</div>
                        <div style="font-size: 11px; color: var(--muted);">Rules 3, 4 & 5: 8ths Levels, 50% Critical, Square Crosses</div>
                    </div>
                    <button onclick="refreshGannAlerts()" style="padding: 6px 12px; background: #f59e0b; color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer;"> Refresh</button>
                </div>

                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 20px; font-weight: 800; color: #f59e0b;" id="gannNear8thCount">0</div>
                        <div style="font-size: 10px; color: #666;">Near 8th Level</div>
                    </div>
                    <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 20px; font-weight: 800; color: #8b5cf6;" id="gannNear50Count">0</div>
                        <div style="font-size: 10px; color: #666;">Near 50% Level</div>
                    </div>
                    <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 20px; font-weight: 800; color: #22c55e;" id="gannBullishCrossCount">0</div>
                        <div style="font-size: 10px; color: #666;">Bullish Crosses</div>
                    </div>
                    <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 20px; font-weight: 800; color: #ef4444;" id="gannBearishCrossCount">0</div>
                        <div style="font-size: 10px; color: #666;">Bearish Crosses</div>
                    </div>
                </div>

                <!-- Active Alerts Container -->
                <div id="gannAlertsContainer">
                    <!-- Rule 5: Square Cross Alerts (Most Important) -->
                    <div id="gannSquareCrossAlerts" style="display: none; margin-bottom: 15px;">
                        <div style="font-size: 12px; font-weight: 700; color: #8b5cf6; margin-bottom: 8px;"> Rule 5: Square Cross Signals (Major Reversals)</div>
                        <div id="gannSquareCrossAlertsList">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Rule 4: 50% Level Alerts -->
                    <div id="gann50Alerts" style="display: none; margin-bottom: 15px;">
                        <div style="font-size: 12px; font-weight: 700; color: #d97706; margin-bottom: 8px;"> Rule 4: Near 50% Critical Level</div>
                        <div id="gann50AlertsList">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Rule 3: 8ths Level Alerts -->
                    <div id="gann8thAlerts" style="display: none; margin-bottom: 15px;">
                        <div style="font-size: 12px; font-weight: 700; color: #f59e0b; margin-bottom: 8px;"> Rule 3: Near Key 8th Levels</div>
                        <div id="gann8thAlertsList">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- No Alerts Message -->
                    <div id="gannNoAlerts" style="text-align: center; padding: 20px; color: #999;">
                        <div style="font-size: 24px; margin-bottom: 10px;"></div>
                        <div>No active Gann alerts. Scanning all symbols...</div>
                    </div>
                </div>

                <!-- View All Link -->
                <div style="text-align: center; margin-top: 10px;">
                    <a href="#" onclick="showTab('daily')" style="color: #f59e0b; font-size: 11px; text-decoration: none;">View Details in Daily Analysis </a>
                </div>
            </div>

            <div id="topTradeSection" style="margin-bottom: 20px;">
                <div class="card" style="background: white; color: #1e293b; border: 2px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-left: 4px solid #ffd700;">
                    <div style="padding: 15px; border-bottom: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;"><h3 style="color: #1e293b; font-size: 24px; margin: 0;"> TODAY'S TOP TRADE</h3><select id="topTradeTimeframeSelect" style="background: #3b82f6; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; border: none; cursor: pointer;"><option value="intraday"> INTRADAY</option><option value="swing" selected> SWING</option><option value="position"> POSITION</option></select></div>
                        <span id="topTradeTime" style="color: #64748b; font-size: 12px;">Updated: --</span>
                    </div>
                    <div style="padding: 20px;">
                        <div style="text-align: center; padding: 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 20px;">
                            <div style="font-size: 14px; color: #aaa; margin-bottom: 5px;">THE TRADE</div>
                            <div id="topTradeSignal" style="font-size: 36px; font-weight: bold; color: #4ade80;">BUY SPY CALL</div>
                            <div id="topTradeConfidence" style="font-size: 18px; color: #d97706; margin-top: 10px;"> 78% Confidence</div>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; color: #1e293b;">
                            <tr>
                                <td style="padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px 0 0 0;">
                                    <div style="color: #64748b; font-size: 12px;"> WHAT TO BUY</div>
                                    <div id="topTradeWhat" style="font-size: 18px; font-weight: bold;">SPY $690 CALL</div>
                                    <div id="topTradeExpiry" style="font-size: 13px; color: #60a5fa;">Expires: Dec 20 (5 days)</div>
                                </td>
                                <td style="padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0;">
                                    <div style="color: #64748b; font-size: 12px;"> WHEN TO BUY</div>
                                    <div id="topTradeEntryZone" style="font-size: 15px; font-weight: bold; color: #1e293b;">SPY: $670 - $675</div>
                                    <div id="topTradeEntry" style="font-size: 12px; color: #60a5fa;">Premium: $0.50 - $1.00</div>
                                    <div id="topTradeBestEntry" style="font-size: 11px; color: #22c55e;">Best Entry: Pullback to $670.50</div>
                                </td>
                                <td style="padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0 8px 0 0;">
                                    <div style="color: #64748b; font-size: 12px;"> WHEN TO EXIT</div>
                                    <div id="topTradeExit50" style="font-size: 13px; font-weight: bold; color: #22c55e;">50%: $678 (Opt: $1.12)</div>
                                    <div id="topTradeExit100" style="font-size: 12px; color: #3b82f6;">100%: $685 (Opt: $1.50)</div>
                                    <div id="topTradeExitStop" style="font-size: 11px; color: #ef4444;">Stop: Below $665 (Opt: $0.45)</div>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; background: rgba(74,222,128,0.2); border: 1px solid #4ade80; border-radius: 0 0 0 8px;">
                                    <div style="color: #16a34a; font-size: 12px; font-weight: 600;"> TAKE PROFIT</div>
                                    <div id="topTradeProfit" style="font-size: 18px; font-weight: bold; color: #4ade80;">+50% ($3.00)</div>
                                    <div id="topTradePriceTarget" style="font-size: 13px; color: #86efac;">When SPY hits $695</div>
                                </td>
                                <td style="padding: 12px; background: rgba(239,68,68,0.2); border: 1px solid #ef4444; border-radius: 0 0 8px 0;">
                                    <div style="color: #dc2626; font-size: 12px; font-weight: 600;"> STOP LOSS</div>
                                    <div id="topTradeStop" style="font-size: 18px; font-weight: bold; color: #ef4444;">-40% ($0.90)</div>
                                    <div id="topTradeStopPrice" style="font-size: 13px; color: #fca5a5;">If SPY drops to $665</div>
                                </td>
                            </tr>
                        </table>
                        <div style="margin-top: 15px; padding: 12px; background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; display: flex; justify-content: space-around; flex-wrap: wrap;">
                            <div><span style="color: #64748b;">Risk/Reward:</span> <span id="topTradeRR" style="font-weight: bold; color: #d97706;">1:1.25</span></div>
                            <div><span style="color: #64748b;">Max Risk:</span> <span id="topTradeMaxRisk" style="font-weight: bold; color: #ef4444;">$60/contract</span></div>
                            <div><span style="color: #64748b;">Max Gain:</span> <span id="topTradeMaxGain" style="font-weight: bold; color: #4ade80;">$75/contract</span></div>
                        </div>
                        <!-- Trade Direction Context Container -->
                        <div id="topTradeContext" style="margin-top: 15px;"></div>
                        <div style="margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="font-weight: bold; color: #1e293b; margin-bottom: 10px;"> PROFIT CALCULATOR</div>
                            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                <div>
                                    <label style="font-size: 12px; color: #64748b;">I want to make:</label>
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span style="font-size: 18px;">$</span>
                                        <input type="number" id="desiredProfit" value="100" min="10" step="10" style="width: 80px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 16px; font-weight: bold;">
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: #64748b;">You need to buy:</div>
                                    <div id="contractsNeeded" style="font-size: 28px; font-weight: bold; color: #3b82f6;">2</div>
                                    <div style="font-size: 12px; color: #64748b;">contracts</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: #64748b;">Total Cost:</div>
                                    <div id="totalCost" style="font-size: 18px; font-weight: bold; color: #1e293b;">$72</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: #64748b;">Max Loss:</div>
                                    <div id="maxLossCalc" style="font-size: 18px; font-weight: bold; color: #ef4444;">$29</div>
                                </div>
                            </div>
                            <div id="profitCalcNote" style="margin-top: 10px; font-size: 11px; color: #64748b; font-style: italic;">
                                Based on entry at $0.36, target at $0.54 (+50%), stop at $0.22 (-40%)
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Confidence Badge based on Alignment -->
            <div id="signalConfidenceBadge" style="margin-top: 15px; padding: 15px; border-radius: 10px; text-align: center; background: #f8f9fa; border: 2px solid #ddd;">
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">SIGNAL CONFIDENCE</div>
                <div id="confidenceLevel" style="font-size: 24px; font-weight: 800;">--</div>
                <div id="confidenceExplain" style="font-size: 11px; color: #666; margin-top: 5px;">Based on backtested accuracy</div>
            </div>

            <!-- Conflict Warning & Market Analysis Trade -->
            <div id="analysisConflictSection" style="display: none; margin-top: 15px;">
                <!-- Conflict Warning Banner -->
                <div id="conflictWarning" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 24px;"></span>
                        <span style="font-size: 16px; font-weight: 700; color: #92400e;">ANALYSIS CONFLICT DETECTED</span>
                    </div>
                    <div style="font-size: 13px; color: #78350f; line-height: 1.6;">
                        <div><strong> Gann Analysis:</strong> <span id="conflictGannSignal" style="color: #22c55e; font-weight: 600;">BUY CALL</span> - Price near support, expects bounce</div>
                        <div><strong> Market Conditions:</strong> <span id="conflictMarketSignal" style="color: #ef4444; font-weight: 600;">FAVOR PUT</span> - Below 20MA, weak breadth</div>
                        <div style="margin-top: 8px; font-style: italic;">Both analyses shown below. Choose based on your trading style.</div>
                    </div>
                </div>

                <!-- Market Analysis Trade Section -->
                <div class="card" style="background: linear-gradient(135deg, rgba(239,68,68,0.05), rgba(220,38,38,0.1)); border: 2px solid #ef4444;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 14px; color: #dc2626; font-weight: 600;"> MARKET CONDITIONS TRADE</div>
                            <div style="font-size: 11px; color: #991b1b;">Based on 20MA, Breadth & VIX</div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="market-tf-btn active" data-tf="INTRADAY" style="padding: 4px 10px; border-radius: 4px; border: 1px solid #ef4444; background: #ef4444; color: white; font-size: 11px; cursor: pointer;"> INTRADAY</button>
                            <button class="market-tf-btn" data-tf="SWING" style="padding: 4px 10px; border-radius: 4px; border: 1px solid #ef4444; background: white; color: #ef4444; font-size: 11px; cursor: pointer;"> SWING</button>
                            <button class="market-tf-btn" data-tf="POSITION" style="padding: 4px 10px; border-radius: 4px; border: 1px solid #ef4444; background: white; color: #ef4444; font-size: 11px; cursor: pointer;"> POSITION</button>
                        </div>
                    </div>

                    <table style="width: 100%; border-collapse: separate; border-spacing: 8px;">
                        <tr>
                            <td style="padding: 12px; background: white; border: 1px solid #fca5a5; border-radius: 8px;">
                                <div style="color: #64748b; font-size: 12px;"> THE TRADE</div>
                                <div id="marketTradeSignal" style="font-size: 20px; font-weight: bold; color: #ef4444;">BUY SPY PUT</div>
                                <div id="marketTradeContract" style="font-size: 13px; color: #dc2626;">SPY $665 PUT</div>
                                <div id="marketTradeExpiry" style="font-size: 12px; color: #f87171;">Expires: Dec 20</div>
                            </td>
                            <td style="padding: 12px; background: white; border: 1px solid #fca5a5; border-radius: 8px;">
                                <div style="color: #64748b; font-size: 12px;"> WHEN TO BUY</div>
                                <div id="marketTradeEntryZone" style="font-size: 14px; font-weight: bold; color: #1e293b;">SPY: $668 - $674</div>
                                <div id="marketTradeEntry" style="font-size: 11px; color: #60a5fa;">Premium: $0.75 - $1.25</div>
                                <div id="marketTradeBestEntry" style="font-size: 10px; color: #ef4444;">Best: Rally to $673</div>
                            </td>
                            <td style="padding: 12px; background: white; border: 1px solid #fca5a5; border-radius: 8px;">
                                <div style="color: #64748b; font-size: 12px;"> WHEN TO EXIT</div>
                                <div id="marketTradeExit50" style="font-size: 12px; font-weight: bold; color: #22c55e;">50%: $664 | Opt $1.50</div>
                                <div id="marketTradeExit100" style="font-size: 11px; color: #3b82f6;">100%: $657 | Opt $2.00</div>
                                <div id="marketTradeStop" style="font-size: 10px; color: #ef4444;">Stop: $680 | Opt $0.50</div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3" style="padding: 10px; background: rgba(239,68,68,0.1); border-radius: 8px; font-size: 11px; color: #991b1b;">
                                <strong> Market Rationale:</strong> <span id="marketTradeRationale">SPY below 20MA, breadth at 25% (weak), conditions favor downside. Trade with trend.</span>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="grid grid-5">
                <div class="metric"><div class="metric-label">Price</div><div class="metric-value" id="currentPrice">--</div><div class="metric-sub" id="priceSource">Loading...</div></div>
                <div class="metric"><div class="metric-label">Change</div><div class="metric-value" id="dailyChange">--</div><div class="metric-sub" id="changePct">--</div></div>
                <div class="metric"><div class="metric-label">Volume</div><div class="metric-value" id="volumeDisplay">--</div><div class="metric-sub" id="volumeVsAvgSmall">vs avg</div></div>
                <div class="metric"><div class="metric-label">Signal</div><div class="metric-value" id="signalStatus">--</div><div class="metric-sub" id="signalConf">--</div></div>
                <div class="metric"><div class="metric-label">ATR</div><div class="metric-value" id="atrDisplay">--</div><div class="metric-sub">Volatility</div></div>
            </div>

            <!-- Fibonacci Zone Display -->
            <div class="card" style="background: linear-gradient(135deg, rgba(139,92,246,0.05), rgba(168,85,247,0.05)); border: 1px solid rgba(139,92,246,0.2);">
                <div class="card-title" style="color: #8b5cf6;"> Fibonacci Price Zones</div>
                <div id="fibZoneDisplay" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; padding: 10px; background: var(--bg); border-radius: 8px; font-size: 11px;">
                    <div class="fib-level" style="text-align: center; padding: 6px 10px; background: rgba(239,68,68,0.1); border-radius: 4px;">
                        <div style="color: var(--muted); font-size: 9px;">S3 (61.8%)</div>
                        <div id="fibS3" style="font-weight: 600; color: #22c55e;">$--</div>
                    </div>
                    <div class="fib-level" style="text-align: center; padding: 6px 10px; background: rgba(239,68,68,0.08); border-radius: 4px;">
                        <div style="color: var(--muted); font-size: 9px;">S2 (50%)</div>
                        <div id="fibS2" style="font-weight: 600; color: #22c55e;">$--</div>
                    </div>
                    <div class="fib-level" style="text-align: center; padding: 6px 10px; background: rgba(239,68,68,0.05); border-radius: 4px;">
                        <div style="color: var(--muted); font-size: 9px;">S1 (38.2%)</div>
                        <div id="fibS1" style="font-weight: 600; color: #22c55e;">$--</div>
                    </div>
                    <div id="currentPriceZone" class="fib-level" style="text-align: center; padding: 8px 12px; background: linear-gradient(135deg, rgba(212,160,23,0.3), rgba(212,160,23,0.1)); border: 2px solid #d4a017; border-radius: 6px;">
                        <div style="color: #d4a017; font-size: 9px; font-weight: 600;"> CURRENT</div>
                        <div id="fibCurrentPrice" style="font-weight: 700; color: #d4a017; font-size: 14px;">$--</div>
                    </div>
                    <div class="fib-level" style="text-align: center; padding: 6px 10px; background: rgba(34,197,94,0.05); border-radius: 4px;">
                        <div style="color: var(--muted); font-size: 9px;">R1 (100%)</div>
                        <div id="fibR1" style="font-weight: 600; color: #ef4444;">$--</div>
                    </div>
                    <div class="fib-level" style="text-align: center; padding: 6px 10px; background: rgba(34,197,94,0.08); border-radius: 4px;">
                        <div style="color: var(--muted); font-size: 9px;">R2 (127.2%)</div>
                        <div id="fibR2" style="font-weight: 600; color: #ef4444;">$--</div>
                    </div>
                    <div class="fib-level" style="text-align: center; padding: 6px 10px; background: rgba(34,197,94,0.1); border-radius: 4px;">
                        <div style="color: var(--muted); font-size: 9px;">R3 (161.8%)</div>
                        <div id="fibR3" style="font-weight: 600; color: #ef4444;">$--</div>
                    </div>
                </div>
                <div id="fibZoneStatus" style="margin-top: 10px; padding: 8px 12px; background: rgba(34,197,94,0.1); border-radius: 6px; font-size: 11px; text-align: center;">
                    <span style="color: var(--muted);">Current Zone:</span>
                    <span id="fibZoneLabel" style="font-weight: 600; color: #22c55e; margin-left: 5px;">Between S1 and R1</span>
                </div>
            </div>

            <!-- Multi-Timeframe Trend Display -->
            <div class="card" style="background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(16,185,129,0.05)); border: 1px solid rgba(59,130,246,0.2);">
                <div class="card-title" style="color: #3b82f6;"> Multi-Timeframe Trend</div>
                <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
                    <div style="text-align: center; padding: 12px 20px; background: var(--bg); border-radius: 8px; min-width: 120px;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;"> INTRADAY</div>
                        <div id="trendIntraday" style="font-size: 16px; font-weight: 700; color: #22c55e;">BULLISH</div>
                    </div>
                    <div style="text-align: center; padding: 12px 20px; background: var(--bg); border-radius: 8px; min-width: 120px;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;"> SWING</div>
                        <div id="trendSwing" style="font-size: 16px; font-weight: 700; color: #22c55e;">BULLISH</div>
                    </div>
                    <div style="text-align: center; padding: 12px 20px; background: var(--bg); border-radius: 8px; min-width: 120px;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;"> POSITION</div>
                        <div id="trendPosition" style="font-size: 16px; font-weight: 700; color: #22c55e;">BULLISH</div>
                    </div>
                </div>
            </div>

            <!-- Gann Quick View Summary Table -->
            <div class="card" style="background: linear-gradient(135deg, rgba(212,160,23,0.08), rgba(184,134,11,0.05)); border: 1px solid rgba(212,160,23,0.3);">
                <div class="card-title" style="color: #d4a017;"> Gann Quick View</div>
                <div class="table-wrap">
                    <table style="font-size: 11px;">
                        <thead>
                            <tr style="background: rgba(212,160,23,0.1);">
                                <th style="color: #d4a017;">Trend</th>
                                <th style="color: #d4a017;">Vol vs Avg</th>
                                <th style="color: #d4a017;">Bars in Trend</th>
                                <th style="color: #d4a017;">Cycle Phase</th>
                                <th style="color: #d4a017;">Next Cycle Turn</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td id="gannQvTrend" style="font-weight: 600; color: #22c55e;">BULLISH</td>
                                <td id="gannQvVolume" style="color: #22c55e;">+12%</td>
                                <td id="gannQvBars">7</td>
                                <td id="gannQvCyclePhase" style="color: #eab308;">MID</td>
                                <td id="gannQvNextTurn">Dec 21</td>
                            </tr>
                        </tbody>
                        <thead>
                            <tr style="background: rgba(212,160,23,0.1);">
                                <th style="color: #d4a017;">Gann Score</th>
                                <th style="color: #d4a017;">Agent Consensus</th>
                                <th style="color: #d4a017;">Reversal Risk</th>
                                <th style="color: #d4a017;">MTF Alignment</th>
                                <th style="color: #d4a017;">Entry Window</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td id="gannQvScore" style="font-weight: 600; color: #22c55e;">75/100</td>
                                <td id="gannQvConsensus" style="color: #22c55e;">3/4</td>
                                <td id="gannQvReversal" style="color: #22c55e;">LOW</td>
                                <td id="gannQvMtf" style="color: #22c55e;">3/3</td>
                                <td id="gannQvEntry" style="color: #22c55e;">OPEN</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reference Data -->
            <div class="card">
                <div class="card-title"> Reference Data</div>
                <div class="grid grid-4">
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">52W High</span><span class="ref-value positive" id="week52High">$609.07</span></div>
                        <div class="ref-data-row"><span class="ref-label">52W Low</span><span class="ref-value negative" id="week52Low">$479.05</span></div>
                    </div>
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">Today High</span><span class="ref-value" id="todayHigh">$607.51</span></div>
                        <div class="ref-data-row"><span class="ref-label">Today Low</span><span class="ref-value" id="todayLow">$604.35</span></div>
                    </div>
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">Avg Vol (20D)</span><span class="ref-value" id="avgVolume20">42.5M</span></div>
                        <div class="ref-data-row"><span class="ref-label">Vol vs Avg</span><span class="ref-value" id="volumeVsAvg">+12%</span></div>
                    </div>
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">Open</span><span class="ref-value" id="todayOpen">$605.20</span></div>
                        <div class="ref-data-row"><span class="ref-label">Prev Close</span><span class="ref-value" id="prevClose">$604.85</span></div>
                    </div>
                </div>
            </div>

            <!-- Trade Statistics Section -->
            <div class="card" style="background: linear-gradient(135deg, rgba(16,185,129,0.05), rgba(6,182,212,0.05)); border: 1px solid rgba(16,185,129,0.2);">
                <div class="card-title" style="color: #10b981;" id="statsTitle">SPY - S&P 500  Trade Statistics (Last 30 Days)</div>
                <div class="grid grid-4" style="gap: 10px;">
                    <div style="background: var(--bg); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Win Rate</div>
                        <div id="statsWinRate" style="font-size: 20px; font-weight: 700; color: #22c55e;">68%</div>
                    </div>
                    <div style="background: var(--bg); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Avg Win</div>
                        <div id="statsAvgWin" style="font-size: 20px; font-weight: 700; color: #22c55e;">+$3.42</div>
                    </div>
                    <div style="background: var(--bg); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Avg Loss</div>
                        <div id="statsAvgLoss" style="font-size: 20px; font-weight: 700; color: #ef4444;">-$1.85</div>
                    </div>
                    <div style="background: var(--bg); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Total Trades</div>
                        <div id="statsTotalTrades" style="font-size: 20px; font-weight: 700; color: var(--text);">22</div>
                    </div>
                </div>
                <div class="grid grid-3" style="gap: 10px; margin-top: 10px;">
                    <div style="background: rgba(34,197,94,0.1); border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Best Day</div>
                        <div id="statsBestDay" style="font-size: 14px; font-weight: 600; color: #22c55e;">+$8.50</div>
                    </div>
                    <div style="background: rgba(239,68,68,0.1); border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Worst Day</div>
                        <div id="statsWorstDay" style="font-size: 14px; font-weight: 600; color: #ef4444;">-$4.20</div>
                    </div>
                    <div style="background: rgba(139,92,246,0.1); border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Current Streak</div>
                        <div id="statsStreak" style="font-size: 14px; font-weight: 600; color: #8b5cf6;">3 wins</div>
                    </div>
                </div>
            </div>

            <!-- Upcoming Events Widget -->
            <div class="card" style="background: linear-gradient(135deg, rgba(245,158,11,0.08), rgba(234,179,8,0.05)); border: 1px solid rgba(245,158,11,0.2);">
                <div class="card-title" style="color: #f59e0b;"> Upcoming Market Events (Next 7 Days)</div>
                <div id="upcomingEventsWidget" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <div style="background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); border-radius: 6px; padding: 8px 12px; font-size: 11px;">
                        <div style="font-weight: 600; color: #ef4444;">Dec 11 (Wed)</div>
                        <div style="color: var(--text);">CPI Report 8:30 AM</div>
                    </div>
                    <div style="background: rgba(245,158,11,0.15); border: 1px solid rgba(245,158,11,0.3); border-radius: 6px; padding: 8px 12px; font-size: 11px;">
                        <div style="font-weight: 600; color: #f59e0b;">Dec 12 (Thu)</div>
                        <div style="color: var(--text);">PPI Report 8:30 AM</div>
                    </div>
                    <div style="background: rgba(139,92,246,0.15); border: 1px solid rgba(139,92,246,0.3); border-radius: 6px; padding: 8px 12px; font-size: 11px;">
                        <div style="font-weight: 600; color: #8b5cf6;">Dec 12 (Thu)</div>
                        <div style="color: var(--text);">Jobless Claims</div>
                    </div>
                    <div style="background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); border-radius: 6px; padding: 8px 12px; font-size: 11px;">
                        <div style="font-weight: 600; color: #ef4444;">Dec 18 (Wed)</div>
                        <div style="color: var(--text);">FOMC Decision 2:00 PM</div>
                    </div>
                    <div style="background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.3); border-radius: 6px; padding: 8px 12px; font-size: 11px;">
                        <div style="font-weight: 600; color: #22c55e;">Dec 13 (Fri)</div>
                        <div style="color: var(--text);">Quad Witching</div>
                    </div>
                    <div style="background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.3); border-radius: 6px; padding: 8px 12px; font-size: 11px;">
                        <div style="font-weight: 600; color: #3b82f6;">Dec 16 (Mon)</div>
                        <div style="color: var(--text);">Retail Sales</div>
                    </div>
                </div>
            </div>

            <!-- Pattern Detection Summary -->
            <div class="card" style="background: linear-gradient(135deg, rgba(139,92,246,0.08), rgba(168,85,247,0.05)); border: 1px solid rgba(139,92,246,0.2);">
                <div class="card-title" id="patternDetectionTitle" style="color: #8b5cf6;"> <span id="patternSymbol">SPY</span> Pattern Detection (Last 14 Days)</div>
                <div id="patternDetectionSummary" style="font-size: 11px; line-height: 1.8;">
                    <div class="table-wrap" style="overflow-x: auto;">
                        <table style="width: 100%; font-size: 11px; border-collapse: collapse;" id="patternDetectionTable">
                            <thead>
                                <tr style="background: rgba(139,92,246,0.1);">
                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid rgba(139,92,246,0.2);">PATTERN</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid rgba(139,92,246,0.2);">TYPE</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid rgba(139,92,246,0.2);">DATE DETECTED</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid rgba(139,92,246,0.2);">TIMEFRAME</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid rgba(139,92,246,0.2);">CONFIDENCE</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid rgba(139,92,246,0.2);">TARGET</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid rgba(139,92,246,0.2);">IMPLICATION</th>
                                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid rgba(139,92,246,0.2);">STATUS</th>
                                </tr>
                            </thead>
                            <tbody id="patternTableBody">
                                <!-- Dynamically populated by updatePatternTableFromCSV() -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Historical Data Table -->
            <div class="card">
                <div class="card-title" id="historicalDataTitle"> <span id="historicalSymbol">SPY</span> Historical Data (Last 10 Days)</div>

                <!-- Summary Row -->
                <div id="historicalSummary" style="background: rgba(59,130,246,0.1); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 11px; display: flex; flex-wrap: wrap; gap: 15px;">
                    <!-- Generated dynamically -->
                </div>

                <div class="table-wrap" style="max-height: 450px; overflow-y: auto; overflow-x: auto;">
                    <table style="font-size: 10px; white-space: nowrap;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>O/H/L/C</th>
                                <th>Change</th>
                                <th>GAP</th>
                                <th>Candle</th>
                                <th>Trend</th>
                                <th>Close Pos</th>
                                <th>Vol</th>
                                <th>OH</th>
                                <th>Events</th>
                            </tr>
                        </thead>
                        <tbody id="historicalDataTable">
                            <tr>
                                <td style="padding: 8px; font-weight: 600;">Dec 10</td>
                                <td style="padding: 8px; text-align: center; font-size: 10px;">605.20/609.00/601.00/607.57</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e; font-weight: 600;">+$2.47</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$0.10</td>
                                <td style="padding: 8px; text-align: center;"><span style="color: #22c55e;">Bullish</span></td>
                                <td style="padding: 8px; text-align: center;"><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 2px 6px; border-radius: 3px;">UP</span></td>
                                <td style="padding: 8px; text-align: center;">Upper</td>
                                <td style="padding: 8px; text-align: center;">+12%</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$3.80</td>
                                <td style="padding: 8px; text-align: center;">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; font-weight: 600;">Dec 9</td>
                                <td style="padding: 8px; text-align: center; font-size: 10px;">600.50/606.20/598.30/605.10</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e; font-weight: 600;">+$4.60</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$0.20</td>
                                <td style="padding: 8px; text-align: center;"><span style="color: #22c55e;">Bullish</span></td>
                                <td style="padding: 8px; text-align: center;"><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 2px 6px; border-radius: 3px;">UP</span></td>
                                <td style="padding: 8px; text-align: center;">Upper</td>
                                <td style="padding: 8px; text-align: center;">+8%</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$5.70</td>
                                <td style="padding: 8px; text-align: center;">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; font-weight: 600;">Dec 6</td>
                                <td style="padding: 8px; text-align: center; font-size: 10px;">595.80/602.40/594.10/600.30</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e; font-weight: 600;">+$4.50</td>
                                <td style="padding: 8px; text-align: center; color: #ef4444;">-$0.30</td>
                                <td style="padding: 8px; text-align: center;"><span style="color: #22c55e;">Bullish</span></td>
                                <td style="padding: 8px; text-align: center;"><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 2px 6px; border-radius: 3px;">UP</span></td>
                                <td style="padding: 8px; text-align: center;">Upper</td>
                                <td style="padding: 8px; text-align: center;">-5%</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$6.60</td>
                                <td style="padding: 8px; text-align: center;"><span style="background: rgba(239,68,68,0.1); color: #ef4444; padding: 2px 4px; border-radius: 3px; font-size: 9px;">NFP</span></td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; font-weight: 600;">Dec 5</td>
                                <td style="padding: 8px; text-align: center; font-size: 10px;">598.90/600.20/592.50/595.60</td>
                                <td style="padding: 8px; text-align: center; color: #ef4444; font-weight: 600;">-$3.30</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$0.50</td>
                                <td style="padding: 8px; text-align: center;"><span style="color: #ef4444;">Bearish</span></td>
                                <td style="padding: 8px; text-align: center;"><span style="background: rgba(239,68,68,0.2); color: #ef4444; padding: 2px 6px; border-radius: 3px;">DN</span></td>
                                <td style="padding: 8px; text-align: center;">Lower</td>
                                <td style="padding: 8px; text-align: center;">+15%</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$1.30</td>
                                <td style="padding: 8px; text-align: center;">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; font-weight: 600;">Dec 4</td>
                                <td style="padding: 8px; text-align: center; font-size: 10px;">602.10/604.30/596.80/598.70</td>
                                <td style="padding: 8px; text-align: center; color: #ef4444; font-weight: 600;">-$3.40</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$1.20</td>
                                <td style="padding: 8px; text-align: center;"><span style="color: #ef4444;">Bearish</span></td>
                                <td style="padding: 8px; text-align: center;"><span style="background: rgba(239,68,68,0.2); color: #ef4444; padding: 2px 6px; border-radius: 3px;">DN</span></td>
                                <td style="padding: 8px; text-align: center;">Lower</td>
                                <td style="padding: 8px; text-align: center;">+3%</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$2.20</td>
                                <td style="padding: 8px; text-align: center;"><span style="background: rgba(59,130,246,0.1); color: #3b82f6; padding: 2px 4px; border-radius: 3px; font-size: 9px;">ISM</span></td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; font-weight: 600;">Dec 3</td>
                                <td style="padding: 8px; text-align: center; font-size: 10px;">599.50/603.80/598.20/602.10</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e; font-weight: 600;">+$2.60</td>
                                <td style="padding: 8px; text-align: center; color: #ef4444;">-$0.80</td>
                                <td style="padding: 8px; text-align: center;"><span style="color: #22c55e;">Bullish</span></td>
                                <td style="padding: 8px; text-align: center;"><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 2px 6px; border-radius: 3px;">UP</span></td>
                                <td style="padding: 8px; text-align: center;">Upper</td>
                                <td style="padding: 8px; text-align: center;">-2%</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$4.30</td>
                                <td style="padding: 8px; text-align: center;">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; font-weight: 600;">Dec 2</td>
                                <td style="padding: 8px; text-align: center; font-size: 10px;">596.20/600.90/595.00/599.50</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e; font-weight: 600;">+$3.30</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$0.40</td>
                                <td style="padding: 8px; text-align: center;"><span style="color: #22c55e;">Bullish</span></td>
                                <td style="padding: 8px; text-align: center;"><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 2px 6px; border-radius: 3px;">UP</span></td>
                                <td style="padding: 8px; text-align: center;">Mid</td>
                                <td style="padding: 8px; text-align: center;">+6%</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$4.70</td>
                                <td style="padding: 8px; text-align: center;">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; font-weight: 600;">Nov 29</td>
                                <td style="padding: 8px; text-align: center; font-size: 10px;">594.80/597.50/593.20/596.20</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e; font-weight: 600;">+$1.40</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$0.60</td>
                                <td style="padding: 8px; text-align: center;"><span style="color: #eab308;">Doji</span></td>
                                <td style="padding: 8px; text-align: center;"><span style="background: rgba(234,179,8,0.2); color: #eab308; padding: 2px 6px; border-radius: 3px;">FLAT</span></td>
                                <td style="padding: 8px; text-align: center;">Mid</td>
                                <td style="padding: 8px; text-align: center;">-45%</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$2.70</td>
                                <td style="padding: 8px; text-align: center;"><span style="background: rgba(234,179,8,0.1); color: #eab308; padding: 2px 4px; border-radius: 3px; font-size: 9px;"> Day</span></td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; font-weight: 600;">Nov 27</td>
                                <td style="padding: 8px; text-align: center; font-size: 10px;">592.50/595.80/591.20/594.80</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e; font-weight: 600;">+$2.30</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$0.30</td>
                                <td style="padding: 8px; text-align: center;"><span style="color: #22c55e;">Bullish</span></td>
                                <td style="padding: 8px; text-align: center;"><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 2px 6px; border-radius: 3px;">UP</span></td>
                                <td style="padding: 8px; text-align: center;">Upper</td>
                                <td style="padding: 8px; text-align: center;">-10%</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$3.30</td>
                                <td style="padding: 8px; text-align: center;">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; font-weight: 600;">Nov 26</td>
                                <td style="padding: 8px; text-align: center; font-size: 10px;">590.80/593.90/589.50/592.50</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e; font-weight: 600;">+$1.70</td>
                                <td style="padding: 8px; text-align: center; color: #ef4444;">-$0.20</td>
                                <td style="padding: 8px; text-align: center;"><span style="color: #22c55e;">Bullish</span></td>
                                <td style="padding: 8px; text-align: center;"><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 2px 6px; border-radius: 3px;">UP</span></td>
                                <td style="padding: 8px; text-align: center;">Upper</td>
                                <td style="padding: 8px; text-align: center;">+2%</td>
                                <td style="padding: 8px; text-align: center; color: #22c55e;">+$3.10</td>
                                <td style="padding: 8px; text-align: center;">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- AI Quick Analysis Card -->
            <div class="card" style="background: linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05)); border: 1px solid rgba(102,126,234,0.2);">
                <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">
                    <span> AI Quick Analysis</span>
                    <button onclick="refreshOverviewAI()" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:5px 12px;border-radius:5px;font-size:11px;cursor:pointer;"> Refresh</button>
                </div>
                <div id="overviewAiAnalysis" style="font-size:12px;line-height:1.8;color:var(--text);">
                    <div style="text-align:center;padding:20px;color:var(--muted);">
                        <div style="font-size:24px;margin-bottom:8px;"></div>
                        Loading AI analysis...
                    </div>
                </div>
            </div>

            <!-- Data Pattern Detection Card -->
            <div class="card" style="background: linear-gradient(135deg, rgba(16,185,129,0.05), rgba(34,197,94,0.05)); border: 1px solid rgba(16,185,129,0.2);">
                <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">
                    <span> Data Pattern Detection</span>
                    <button onclick="updateDataPatternDetection()" style="background:linear-gradient(135deg,#10b981,#22c55e);color:white;border:none;padding:5px 12px;border-radius:5px;font-size:11px;cursor:pointer;"> Scan</button>
                </div>
                <div id="dataPatternDetection" style="font-size:12px;line-height:1.6;color:var(--text);">
                    <div style="text-align:center;padding:20px;color:var(--muted);">
                        <div style="font-size:24px;margin-bottom:8px;"></div>
                        Loading pattern detection...
                    </div>
                </div>
            </div>
        </div>

        <!-- BAR COUNT TAB - FIXED -->
        <div id="barcount" class="tab-content">
            <div class="card">
                <div class="card-title"> Bar Count Analysis</div>
                <div style="display:flex;gap:15px;margin-bottom:15px;flex-wrap:wrap;align-items:center;">
                    <div>
                        <label style="font-size:11px;color:var(--muted);">Bars to Analyze:</label>
                        <select id="barCountSelect" onchange="updateBarCountAnalysis()" style="padding:6px 10px;border:1px solid var(--border);border-radius:5px;margin-left:8px;">
                            <option value="5">5 Bars</option>
                            <option value="10">10 Bars</option>
                            <option value="15">15 Bars</option>
                            <option value="20" selected>20 Bars</option>
                            <option value="25">25 Bars</option>
                            <option value="30">30 Bars</option>
                            <option value="35">35 Bars</option>
                            <option value="40">40 Bars</option>
                            <option value="45">45 Bars</option>
                            <option value="50">50 Bars</option>
                            <option value="55">55 Bars</option>
                            <option value="60">60 Bars</option>
                            <option value="65">65 Bars</option>
                            <option value="70">70 Bars</option>
                            <option value="75">75 Bars</option>
                            <option value="80">80 Bars</option>
                            <option value="85">85 Bars</option>
                            <option value="90">90 Bars</option>
                            <option value="95">95 Bars</option>
                            <option value="100">100 Bars</option>
                        </select>
                    </div>
                    <div style="background:var(--bg);padding:6px 12px;border-radius:5px;font-size:12px;">
                        <strong>Current Symbol:</strong> <span id="barCountCurrentSymbol" style="color:var(--primary);font-weight:700;">SPY</span>
                        <span style="color:var(--muted);font-size:10px;margin-left:5px;">(synced with header)</span>
                    </div>
                </div>
                
                <div class="bar-count-display">
                    <div class="bar-count-item">
                        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;"> Base Confluence</div>
                        <div class="bar-count-value" id="baseBarCount">+5</div>
                        <div class="bar-count-label">Consecutive Bars</div>
                    </div>
                    <div class="bar-count-item">
                        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;"> Gann-Elliott</div>
                        <div class="bar-count-value" id="gannBarCount">+7</div>
                        <div class="bar-count-label">Wave Progress</div>
                    </div>
                    <div class="bar-count-item">
                        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;"> DQN/RL</div>
                        <div class="bar-count-value" id="dqnBarCount">+2</div>
                        <div class="bar-count-label">Momentum</div>
                    </div>
                    <div class="bar-count-item">
                        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;"> 3-Wave</div>
                        <div class="bar-count-value" id="waveBarCount">+4</div>
                        <div class="bar-count-label">Impulse</div>
                    </div>
                </div>
            </div>

            <!-- Trend Reversal Statistics -->
            <div class="card">
                <div class="card-title"> Trend Reversal Statistics</div>
                <p style="font-size:11px;color:var(--muted);margin-bottom:12px;">Average bars before trend reversal based on historical data. Sorted by reversal risk (HIGH first).</p>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr><th>Symbol</th><th>Avg Bullish Run</th><th>Avg Bearish Run</th><th>Current Run</th><th>% of Avg</th><th>Reversal Risk</th></tr>
                        </thead>
                        <tbody id="reversalStatsTable">
                            <tr>
                                <td style="font-weight: 600;">XLV</td>
                                <td style="text-align: center;">9 bars</td>
                                <td style="text-align: center;">7 bars</td>
                                <td style="text-align: center; color: #ef4444; font-weight: 600;">-8 (Bear)</td>
                                <td style="text-align: center;">114%</td>
                                <td><span class="badge badge-danger">HIGH</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLB</td>
                                <td style="text-align: center;">8 bars</td>
                                <td style="text-align: center;">10 bars</td>
                                <td style="text-align: center; color: #ef4444; font-weight: 600;">-9 (Bear)</td>
                                <td style="text-align: center;">90%</td>
                                <td><span class="badge badge-danger">HIGH</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLY</td>
                                <td style="text-align: center;">11 bars</td>
                                <td style="text-align: center;">9 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+10 (Bull)</td>
                                <td style="text-align: center;">91%</td>
                                <td><span class="badge badge-danger">HIGH</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLK</td>
                                <td style="text-align: center;">11 bars</td>
                                <td style="text-align: center;">8 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+8 (Bull)</td>
                                <td style="text-align: center;">73%</td>
                                <td><span class="badge badge-warning">MEDIUM</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLE</td>
                                <td style="text-align: center;">7 bars</td>
                                <td style="text-align: center;">9 bars</td>
                                <td style="text-align: center; color: #ef4444; font-weight: 600;">-6 (Bear)</td>
                                <td style="text-align: center;">67%</td>
                                <td><span class="badge badge-warning">MEDIUM</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLI</td>
                                <td style="text-align: center;">10 bars</td>
                                <td style="text-align: center;">8 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+6 (Bull)</td>
                                <td style="text-align: center;">60%</td>
                                <td><span class="badge badge-warning">MEDIUM</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">SPY</td>
                                <td style="text-align: center;">12 bars</td>
                                <td style="text-align: center;">8 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+7 (Bull)</td>
                                <td style="text-align: center;">58%</td>
                                <td><span class="badge badge-success">LOW</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">QQQ</td>
                                <td style="text-align: center;">10 bars</td>
                                <td style="text-align: center;">7 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+5 (Bull)</td>
                                <td style="text-align: center;">50%</td>
                                <td><span class="badge badge-success">LOW</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLP</td>
                                <td style="text-align: center;">8 bars</td>
                                <td style="text-align: center;">7 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+4 (Bull)</td>
                                <td style="text-align: center;">50%</td>
                                <td><span class="badge badge-success">LOW</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLF</td>
                                <td style="text-align: center;">8 bars</td>
                                <td style="text-align: center;">6 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+3 (Bull)</td>
                                <td style="text-align: center;">38%</td>
                                <td><span class="badge badge-success">LOW</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">IWM</td>
                                <td style="text-align: center;">9 bars</td>
                                <td style="text-align: center;">11 bars</td>
                                <td style="text-align: center; color: #ef4444; font-weight: 600;">-4 (Bear)</td>
                                <td style="text-align: center;">36%</td>
                                <td><span class="badge badge-success">LOW</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLU</td>
                                <td style="text-align: center;">7 bars</td>
                                <td style="text-align: center;">6 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+2 (Bull)</td>
                                <td style="text-align: center;">29%</td>
                                <td><span class="badge badge-success">LOW</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-title"> Bar Count History</div>
                <div class="table-wrap" style="max-height:300px;overflow-y:auto;">
                    <table>
                        <thead><tr><th>#</th><th>Date</th><th>O/H/L/C</th><th>Dir</th><th>Base</th><th>Gann</th><th>DQN</th><th>Wave</th><th>Avg</th></tr></thead>
                        <tbody id="barCountTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Historical Averages Section -->
            <div class="card" style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px;"> Historical Averages (Last 20 Days)</h3>
                <p style="font-size: 11px; color: var(--muted); margin-bottom: 15px;">Use these to set realistic daily targets. Don't expect more than the average move.</p>
                <div class="table-wrap">
                    <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--bg);">
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border);">SYMBOL</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">AVG OH</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">MAX OH</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">AVG OL</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">MAX OL</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">AVG OC</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">AVG RANGE</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">CALL TARGET</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">PUT TARGET</th>
                            </tr>
                        </thead>
                        <tbody id="historicalAvgBody">
                            <tr>
                                <td style="padding: 10px; font-weight: 600;">SPY</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="spyAvgOH">+$4.25</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="spyMaxOH">+$8.50</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="spyAvgOL">-$3.80</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="spyMaxOL">-$7.20</td>
                                <td style="padding: 10px; text-align: center;" id="spyAvgOC">+$1.20</td>
                                <td style="padding: 10px; text-align: center;" id="spyAvgRange">$8.05</td>
                                <td style="padding: 10px; text-align: center; background: rgba(34,197,94,0.1); color: #22c55e; font-weight: 600;" id="spyCallTarget">+$3.50</td>
                                <td style="padding: 10px; text-align: center; background: rgba(239,68,68,0.1); color: #ef4444; font-weight: 600;" id="spyPutTarget">-$3.00</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; font-weight: 600;">QQQ</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="qqqAvgOH">+$5.10</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="qqqMaxOH">+$10.20</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="qqqAvgOL">-$4.50</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="qqqMaxOL">-$9.80</td>
                                <td style="padding: 10px; text-align: center;" id="qqqAvgOC">+$0.85</td>
                                <td style="padding: 10px; text-align: center;" id="qqqAvgRange">$9.60</td>
                                <td style="padding: 10px; text-align: center; background: rgba(34,197,94,0.1); color: #22c55e; font-weight: 600;" id="qqqCallTarget">+$4.25</td>
                                <td style="padding: 10px; text-align: center; background: rgba(239,68,68,0.1); color: #ef4444; font-weight: 600;" id="qqqPutTarget">-$3.75</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; font-weight: 600;">IWM</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="iwmAvgOH">+$2.40</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="iwmMaxOH">+$5.10</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="iwmAvgOL">-$2.20</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="iwmMaxOL">-$4.80</td>
                                <td style="padding: 10px; text-align: center;" id="iwmAvgOC">+$0.45</td>
                                <td style="padding: 10px; text-align: center;" id="iwmAvgRange">$4.60</td>
                                <td style="padding: 10px; text-align: center; background: rgba(34,197,94,0.1); color: #22c55e; font-weight: 600;" id="iwmCallTarget">+$2.00</td>
                                <td style="padding: 10px; text-align: center; background: rgba(239,68,68,0.1); color: #ef4444; font-weight: 600;" id="iwmPutTarget">-$1.80</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; font-weight: 600;">XLF</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="xlfAvgOH">+$0.45</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="xlfMaxOH">+$0.95</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="xlfAvgOL">-$0.40</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="xlfMaxOL">-$0.85</td>
                                <td style="padding: 10px; text-align: center;" id="xlfAvgOC">+$0.12</td>
                                <td style="padding: 10px; text-align: center;" id="xlfAvgRange">$0.85</td>
                                <td style="padding: 10px; text-align: center; background: rgba(34,197,94,0.1); color: #22c55e; font-weight: 600;" id="xlfCallTarget">+$0.38</td>
                                <td style="padding: 10px; text-align: center; background: rgba(239,68,68,0.1); color: #ef4444; font-weight: 600;" id="xlfPutTarget">-$0.33</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; font-weight: 600;">XLE</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="xleAvgOH">+$0.85</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="xleMaxOH">+$1.80</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="xleAvgOL">-$0.75</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="xleMaxOL">-$1.65</td>
                                <td style="padding: 10px; text-align: center;" id="xleAvgOC">+$0.08</td>
                                <td style="padding: 10px; text-align: center;" id="xleAvgRange">$1.60</td>
                                <td style="padding: 10px; text-align: center; background: rgba(34,197,94,0.1); color: #22c55e; font-weight: 600;" id="xleCallTarget">+$0.70</td>
                                <td style="padding: 10px; text-align: center; background: rgba(239,68,68,0.1); color: #ef4444; font-weight: 600;" id="xlePutTarget">-$0.62</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; font-weight: 600;">XLK</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="xlkAvgOH">+$2.80</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="xlkMaxOH">+$5.60</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="xlkAvgOL">-$2.50</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="xlkMaxOL">-$5.20</td>
                                <td style="padding: 10px; text-align: center;" id="xlkAvgOC">+$0.65</td>
                                <td style="padding: 10px; text-align: center;" id="xlkAvgRange">$5.30</td>
                                <td style="padding: 10px; text-align: center; background: rgba(34,197,94,0.1); color: #22c55e; font-weight: 600;" id="xlkCallTarget">+$2.30</td>
                                <td style="padding: 10px; text-align: center; background: rgba(239,68,68,0.1); color: #ef4444; font-weight: 600;" id="xlkPutTarget">-$2.05</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: rgba(59,130,246,0.1); border-radius: 8px; font-size: 11px;">
                    <strong> How to use:</strong> CALL TARGET = 85% of AVG OH (realistic profit). PUT TARGET = 85% of AVG OL. Don't chase moves beyond MAX values - those are rare outliers.
                </div>
            </div>

            <!-- Today vs Average Section -->
            <div class="card" style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px;"> Today vs Average</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div style="border-radius: 8px; padding: 15px; text-align: center; background: rgba(234,179,8,0.1);" id="todayOHvsAvgBox">
                        <div style="font-size: 11px; color: var(--muted);">Today OH vs Avg</div>
                        <div style="font-size: 24px; font-weight: 700;" id="todayOHpct">89%</div>
                        <div style="font-size: 11px; color: var(--muted);" id="todayOHdetail">$3.80 of $4.25 avg</div>
                        <div style="font-size: 11px; color: #eab308; margin-top: 5px;" id="todayOHstatus">Nearing avg - consider taking profits</div>
                    </div>
                    <div style="border-radius: 8px; padding: 15px; text-align: center; background: rgba(239,68,68,0.1);" id="todayOLvsAvgBox">
                        <div style="font-size: 11px; color: var(--muted);">Today OL vs Avg</div>
                        <div style="font-size: 24px; font-weight: 700;" id="todayOLpct">110%</div>
                        <div style="font-size: 11px; color: var(--muted);" id="todayOLdetail">$4.20 of $3.80 avg</div>
                        <div style="font-size: 11px; color: #ef4444; margin-top: 5px;" id="todayOLstatus">Exceeded avg - strong selling pressure</div>
                    </div>
                    <div style="border-radius: 8px; padding: 15px; text-align: center; background: rgba(34,197,94,0.1);" id="todayRangevsAvgBox">
                        <div style="font-size: 11px; color: var(--muted);">Today Range vs Avg</div>
                        <div style="font-size: 24px; font-weight: 700;" id="todayRangePct">99%</div>
                        <div style="font-size: 11px; color: var(--muted);" id="todayRangeDetail">$8.00 of $8.05 avg</div>
                        <div style="font-size: 11px; color: #22c55e; margin-top: 5px;" id="todayRangeStatus">Normal volatility day</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIGNALS TAB -->
        <div id="signals" class="tab-content">
            <!-- Signals Tab Header with Last Updated -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h2 style="margin: 0; font-size: 20px; color: var(--text);"> Signals & Agents</h2>
                    <p style="margin: 4px 0 0; font-size: 12px; color: #888;">Multi-Agent Consensus + Trade Direction</p>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span id="signalsTabLastUpdated" style="font-size: 11px; color: #888; padding: 4px 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                        Updated: --
                    </span>
                    <button onclick="refreshSignalsTab()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #22c55e; background: transparent; color: #22c55e; cursor: pointer; font-size: 11px;">
                         Refresh
                    </button>
                </div>
            </div>

            <!-- Parameters Table -->
            <div class="card">
                <div class="card-title"> Intraday vs  Swing vs  Position Parameters</div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Parameter</th><th style="color:var(--intraday);"> INTRADAY</th><th style="color:var(--swing);"> SWING</th><th style="color:#a855f7;"> POSITION</th></tr></thead>
                        <tbody>
                            <tr><td>Timeframe</td><td>5-min, 15-min</td><td>Daily, 4-Hour</td><td>Weekly, Monthly</td></tr>
                            <tr><td>Options Expiry</td><td>0DTE - 1DTE</td><td>3-5 DTE</td><td>30-45 DTE</td></tr>
                            <tr><td>Fast SMA</td><td>5</td><td>10</td><td>20</td></tr>
                            <tr><td>Slow SMA</td><td>20</td><td>30</td><td>50</td></tr>
                            <tr><td>Stop Loss</td><td>0.5-1.0 ATR</td><td>1.5-2.0 ATR</td><td>2.5-3.0 ATR</td></tr>
                            <tr><td>Target</td><td>1.0-2.0 ATR</td><td>3.0-4.0 ATR</td><td>5.0-8.0 ATR</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Agent Signals Table -->
            <div class="card">
                <div class="card-title"> Agent Signals</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Agent</th>
                                <th style="color:var(--intraday);">Intraday</th>
                                <th>Conf</th>
                                <th style="color:var(--swing);">Swing</th>
                                <th>Conf</th>
                                <th style="color:#a855f7;">Position</th>
                                <th>Conf</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td> Base Confluence Agent</td>
                                <td><span class="badge badge-success" id="sigBaseIntraday">BULLISH</span></td>
                                <td id="sigBaseIntradayConf">72%</td>
                                <td><span class="badge badge-success" id="sigBaseSwing">BULLISH</span></td>
                                <td id="sigBaseSwingConf">68%</td>
                                <td><span class="badge badge-success" id="sigBasePosition">BULLISH</span></td>
                                <td id="sigBasePositionConf">75%</td>
                            </tr>
                            <tr>
                                <td> Gann-Elliott Agent</td>
                                <td><span class="badge badge-success" id="sigGannIntraday">BULLISH</span></td>
                                <td id="sigGannIntradayConf">75%</td>
                                <td><span class="badge badge-success" id="sigGannSwing">BULLISH</span></td>
                                <td id="sigGannSwingConf">70%</td>
                                <td><span class="badge badge-success" id="sigGannPosition">BULLISH</span></td>
                                <td id="sigGannPositionConf">78%</td>
                            </tr>
                            <tr>
                                <td> DQN/RL Agent</td>
                                <td><span class="badge badge-warning" id="sigDqnIntraday">NEUTRAL</span></td>
                                <td id="sigDqnIntradayConf">58%</td>
                                <td><span class="badge badge-success" id="sigDqnSwing">BULLISH</span></td>
                                <td id="sigDqnSwingConf">65%</td>
                                <td><span class="badge badge-success" id="sigDqnPosition">BULLISH</span></td>
                                <td id="sigDqnPositionConf">71%</td>
                            </tr>
                            <tr>
                                <td> 3-Wave Agent</td>
                                <td><span class="badge badge-success" id="sigWaveIntraday">BULLISH</span></td>
                                <td id="sigWaveIntradayConf">68%</td>
                                <td><span class="badge badge-danger" id="sigWaveSwing">BEARISH</span></td>
                                <td id="sigWaveSwingConf">62%</td>
                                <td><span class="badge badge-success" id="sigWavePosition">BULLISH</span></td>
                                <td id="sigWavePositionConf">74%</td>
                            </tr>
                            <tr style="background:var(--bg); font-weight: 600;">
                                <td><strong>CONSENSUS</strong></td>
                                <td><span class="badge badge-ultra" id="sigConsensusIntraday">3/4 BULLISH</span></td>
                                <td id="sigConsensusIntradayConf">68%</td>
                                <td><span class="badge badge-ultra" id="sigConsensusSwing">3/4 BULLISH</span></td>
                                <td id="sigConsensusSwingConf">66%</td>
                                <td><span class="badge badge-ultra" id="sigConsensusPosition">4/4 BULLISH</span></td>
                                <td id="sigConsensusPositionConf">75%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Fibonacci Levels Section -->
            <div class="card">
                <h3 style="margin-bottom: 15px;"> Fibonacci Levels ( <span id="sigFibSymbol">SPY</span> )</h3>

                <!-- Proximity Alert -->
                <div style="background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(239,68,68,0.1)); border: 1px solid #f59e0b; border-radius: 8px; padding: 12px 15px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 18px;"></span>
                    <span style="font-size: 12px;"><strong>SPY</strong> is <span style="color: #f59e0b; font-weight: 700;">0.8%</span> away from <span style="font-weight: 600;">R1</span> (<span style="color: #ef4444;">$692.50</span>)</span>
                </div>

                <!-- Fibonacci Table -->
                <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f0f0f0;">
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">LEVEL</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">PRICE</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">DISTANCE</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;"></th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">DATE SET</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">TF</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">IMPLICATION</th>
                        </tr>
                    </thead>
                    <tbody id="sigFibTable">
                        <tr>
                            <td style="padding: 10px; color: #22c55e; font-weight: 600;">R3 (161.8%)</td>
                            <td style="padding: 10px; text-align: center; font-weight: 600;">$720.40</td>
                            <td style="padding: 10px; text-align: center; color: #22c55e;">+4.8%</td>
                            <td style="padding: 10px; text-align: center;">-</td>
                            <td style="padding: 10px; text-align: center;">Nov 15</td>
                            <td style="padding: 10px; text-align: center;">Weekly</td>
                            <td style="padding: 10px; color: #666;">Strong Resistance - Major Target</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; color: #22c55e; font-weight: 600;">R2 (127.2%)</td>
                            <td style="padding: 10px; text-align: center; font-weight: 600;">$705.20</td>
                            <td style="padding: 10px; text-align: center; color: #22c55e;">+2.6%</td>
                            <td style="padding: 10px; text-align: center;">-</td>
                            <td style="padding: 10px; text-align: center;">Nov 15</td>
                            <td style="padding: 10px; text-align: center;">Daily</td>
                            <td style="padding: 10px; color: #666;">Resistance - Take Partial Profits</td>
                        </tr>
                        <tr style="background: rgba(245,158,11,0.1);">
                            <td style="padding: 10px; color: #f59e0b; font-weight: 600;">R1 (100%)</td>
                            <td style="padding: 10px; text-align: center; font-weight: 700;">$692.50</td>
                            <td style="padding: 10px; text-align: center; color: #f59e0b; font-weight: 600;">+0.8%</td>
                            <td style="padding: 10px; text-align: center;"><span style="color: #f59e0b;"> NEAR</span></td>
                            <td style="padding: 10px; text-align: center;">Dec 1</td>
                            <td style="padding: 10px; text-align: center;">Daily</td>
                            <td style="padding: 10px; color: #f59e0b; font-weight: 600;">APPROACHING - First Target</td>
                        </tr>
                        <tr style="background: rgba(59,130,246,0.1);">
                            <td style="padding: 10px; color: #3b82f6; font-weight: 700;">CURRENT</td>
                            <td style="padding: 10px; text-align: center; font-weight: 700; color: #3b82f6;">$687.57</td>
                            <td style="padding: 10px; text-align: center;">--</td>
                            <td style="padding: 10px; text-align: center;"><span style="color: #3b82f6;"> HERE</span></td>
                            <td style="padding: 10px; text-align: center;">--</td>
                            <td style="padding: 10px; text-align: center;">--</td>
                            <td style="padding: 10px; color: #3b82f6;">Current Price Level</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; color: #eab308; font-weight: 600;">S1 (38.2%)</td>
                            <td style="padding: 10px; text-align: center; font-weight: 600;">$678.20</td>
                            <td style="padding: 10px; text-align: center; color: #ef4444;">-1.4%</td>
                            <td style="padding: 10px; text-align: center;">-</td>
                            <td style="padding: 10px; text-align: center;">Dec 1</td>
                            <td style="padding: 10px; text-align: center;">Daily</td>
                            <td style="padding: 10px; color: #666;">First Support - Bounce Zone</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; color: #ef4444; font-weight: 600;">S2 (50%)</td>
                            <td style="padding: 10px; text-align: center; font-weight: 600;">$672.40</td>
                            <td style="padding: 10px; text-align: center; color: #ef4444;">-2.2%</td>
                            <td style="padding: 10px; text-align: center;">-</td>
                            <td style="padding: 10px; text-align: center;">Nov 15</td>
                            <td style="padding: 10px; text-align: center;">Daily</td>
                            <td style="padding: 10px; color: #666;">Support - Consider Adding</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; color: #ef4444; font-weight: 600;">S3 (61.8%)</td>
                            <td style="padding: 10px; text-align: center; font-weight: 600;">$665.80</td>
                            <td style="padding: 10px; text-align: center; color: #ef4444;">-3.2%</td>
                            <td style="padding: 10px; text-align: center;">-</td>
                            <td style="padding: 10px; text-align: center;">Nov 15</td>
                            <td style="padding: 10px; text-align: center;">Weekly</td>
                            <td style="padding: 10px; color: #666;">Strong Support - Major Buy Zone</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Technical Patterns Section -->
            <div class="card" style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px;"> Technical Patterns Detected</h3>
                <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f0f0f0;">
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">PATTERN</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">TYPE</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">DATE DETECTED</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">TIMEFRAME</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">CONFIDENCE</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">TARGET</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">IMPLICATION</th>
                            <th style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">STATUS</th>
                        </tr>
                    </thead>
                    <tbody id="technicalPatternsTable">
                        <tr>
                            <td style="padding: 10px; font-weight: 600;">Double Bottom</td>
                            <td style="padding: 10px; text-align: center;"><span style="color: #22c55e; font-weight: 600;">Bullish</span></td>
                            <td style="padding: 10px; text-align: center;">Dec 8</td>
                            <td style="padding: 10px; text-align: center;">Daily</td>
                            <td style="padding: 10px; text-align: center;">72%</td>
                            <td style="padding: 10px; text-align: center;">$705.00</td>
                            <td style="padding: 10px; color: #666;">Reversal confirmed at support</td>
                            <td style="padding: 10px; text-align: center;"><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 3px 8px; border-radius: 4px; font-size: 10px;">ACTIVE</span></td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; font-weight: 600;">Ascending Triangle</td>
                            <td style="padding: 10px; text-align: center;"><span style="color: #22c55e; font-weight: 600;">Bullish</span></td>
                            <td style="padding: 10px; text-align: center;">Dec 6</td>
                            <td style="padding: 10px; text-align: center;">4-Hour</td>
                            <td style="padding: 10px; text-align: center;">65%</td>
                            <td style="padding: 10px; text-align: center;">$700.00</td>
                            <td style="padding: 10px; color: #666;">Breakout pending above <span id="patternBreakout1">$692</span></td>
                            <td style="padding: 10px; text-align: center;"><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 3px 8px; border-radius: 4px; font-size: 10px;">ACTIVE</span></td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; font-weight: 600;">Bullish Engulfing</td>
                            <td style="padding: 10px; text-align: center;"><span style="color: #22c55e; font-weight: 600;">Bullish</span></td>
                            <td style="padding: 10px; text-align: center;">Dec 10</td>
                            <td style="padding: 10px; text-align: center;">Daily</td>
                            <td style="padding: 10px; text-align: center;">78%</td>
                            <td style="padding: 10px; text-align: center;">$698.50</td>
                            <td style="padding: 10px; color: #666;">Momentum shift confirmed</td>
                            <td style="padding: 10px; text-align: center;"><span style="background: rgba(234,179,8,0.2); color: #eab308; padding: 3px 8px; border-radius: 4px; font-size: 10px;">FORMING</span></td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; font-weight: 600;">Inv Head & Shoulders</td>
                            <td style="padding: 10px; text-align: center;"><span style="color: #22c55e; font-weight: 600;">Bullish</span></td>
                            <td style="padding: 10px; text-align: center;">Dec 3</td>
                            <td style="padding: 10px; text-align: center;">Weekly</td>
                            <td style="padding: 10px; text-align: center;">58%</td>
                            <td style="padding: 10px; text-align: center;">$720.00</td>
                            <td style="padding: 10px; color: #666;">Major reversal potential</td>
                            <td style="padding: 10px; text-align: center;"><span style="background: rgba(59,130,246,0.2); color: #3b82f6; padding: 3px 8px; border-radius: 4px; font-size: 10px;">WATCH</span></td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; font-weight: 600;">Rising Wedge</td>
                            <td style="padding: 10px; text-align: center;"><span style="color: #ef4444; font-weight: 600;">Bearish</span></td>
                            <td style="padding: 10px; text-align: center;">Dec 5</td>
                            <td style="padding: 10px; text-align: center;">4-Hour</td>
                            <td style="padding: 10px; text-align: center;">45%</td>
                            <td style="padding: 10px; text-align: center;">$675.00</td>
                            <td style="padding: 10px; color: #666;">Potential pullback setup</td>
                            <td style="padding: 10px; text-align: center;"><span style="background: rgba(59,130,246,0.2); color: #3b82f6; padding: 3px 8px; border-radius: 4px; font-size: 10px;">WATCH</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- AGENTS TAB - MERGED INTO SIGNALS & AGENTS TAB -->
        <!-- <div id="agents" class="tab-content">
            Content merged into Signals & Agents tab above
        </div> -->

        <!-- PATTERNS TAB - ENHANCED PATTERN SCANNER -->
        <div id="patterns" class="tab-content">
            <!-- Header with Last Updated -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
                <div>
                    <h2 style="font-size: 22px; color: var(--text); margin: 0;"> PATTERN SCANNER - All Symbols</h2>
                    <span style="color: var(--muted); font-size: 12px;">Scanning 43 symbols for high-probability reversal patterns | Daily, 15 Min, 5 Min</span>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span id="patternsLastUpdated" style="font-size: 11px; color: #888; padding: 4px 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                        Updated: --
                    </span>
                    <button onclick="refreshPatternsTab()" style="padding: 10px 20px; border-radius: 8px; border: 1px solid var(--border); background: white; color: var(--text); cursor: pointer; font-size: 12px; font-weight: 500;"> Refresh Scan</button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 20px;">
                <div class="pattern-summary-card" style="background: var(--card); border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--border); border-left: 4px solid #22c55e;">
                    <div style="font-size: 24px; margin-bottom: 4px;"></div>
                    <div id="patternCountHammer" style="font-size: 28px; font-weight: 700; color: #22c55e;">0</div>
                    <div style="font-size: 10px; color: var(--muted); text-transform: uppercase;">Hammer</div>
                    <div style="font-size: 11px; margin-top: 4px; font-weight: 500; color: #22c55e;">78% accuracy</div>
                </div>
                <div class="pattern-summary-card" style="background: var(--card); border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--border); border-left: 4px solid #22c55e;">
                    <div style="font-size: 24px; margin-bottom: 4px;"></div>
                    <div id="patternCountInvHammer" style="font-size: 28px; font-weight: 700; color: #22c55e;">0</div>
                    <div style="font-size: 10px; color: var(--muted); text-transform: uppercase;">Inv Hammer</div>
                    <div style="font-size: 11px; margin-top: 4px; font-weight: 500; color: #22c55e;">72% accuracy</div>
                </div>
                <div class="pattern-summary-card" style="background: var(--card); border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--border); border-left: 4px solid #ca8a04;">
                    <div style="font-size: 24px; margin-bottom: 4px;"></div>
                    <div id="patternCountDoji" style="font-size: 28px; font-weight: 700; color: #ca8a04;">0</div>
                    <div style="font-size: 10px; color: var(--muted); text-transform: uppercase;">Doji</div>
                    <div style="font-size: 11px; margin-top: 4px; font-weight: 500; color: #ca8a04;">65% accuracy</div>
                </div>
                <div class="pattern-summary-card" style="background: var(--card); border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--border); border-left: 4px solid #dc2626;">
                    <div style="font-size: 24px; margin-bottom: 4px;"></div>
                    <div id="patternCountGravestone" style="font-size: 28px; font-weight: 700; color: #dc2626;">0</div>
                    <div style="font-size: 10px; color: var(--muted); text-transform: uppercase;">Gravestone</div>
                    <div style="font-size: 11px; margin-top: 4px; font-weight: 500; color: #dc2626;">75% accuracy</div>
                </div>
                <div class="pattern-summary-card" style="background: var(--card); border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--border); border-left: 4px solid #22c55e;">
                    <div style="font-size: 24px; margin-bottom: 4px;"></div>
                    <div id="patternCountBullEngulf" style="font-size: 28px; font-weight: 700; color: #22c55e;">0</div>
                    <div style="font-size: 10px; color: var(--muted); text-transform: uppercase;">Bull Engulf</div>
                    <div style="font-size: 11px; margin-top: 4px; font-weight: 500; color: #22c55e;">82% accuracy</div>
                </div>
                <div class="pattern-summary-card" style="background: var(--card); border-radius: 10px; padding: 14px; text-align: center; border: 1px solid var(--border); border-left: 4px solid #dc2626;">
                    <div style="font-size: 24px; margin-bottom: 4px;"></div>
                    <div id="patternCountBearEngulf" style="font-size: 28px; font-weight: 700; color: #dc2626;">0</div>
                    <div style="font-size: 10px; color: var(--muted); text-transform: uppercase;">Bear Engulf</div>
                    <div style="font-size: 11px; margin-top: 4px; font-weight: 500; color: #dc2626;">80% accuracy</div>
                </div>
            </div>

            <!-- Filters Section -->
            <div style="background: var(--card); border-radius: 10px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border);">
                <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;">
                    <span style="font-size: 11px; color: var(--muted); font-weight: 600; min-width: 80px;">TIMEFRAME:</span>
                    <button class="pattern-filter-btn active" onclick="filterPatternTable('tf', 'all', this)">All</button>
                    <button class="pattern-filter-btn" onclick="filterPatternTable('tf', 'daily', this)"> Daily</button>
                    <button class="pattern-filter-btn" onclick="filterPatternTable('tf', '15m', this)"> 15 Min</button>
                    <button class="pattern-filter-btn" onclick="filterPatternTable('tf', '5m', this)"> 5 Min</button>
                </div>
                <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;">
                    <span style="font-size: 11px; color: var(--muted); font-weight: 600; min-width: 80px;">SYMBOL TYPE:</span>
                    <button class="pattern-filter-btn active" onclick="filterPatternTable('type', 'all', this)">All</button>
                    <button class="pattern-filter-btn" onclick="filterPatternTable('type', 'etf', this)"> ETFs Only</button>
                    <button class="pattern-filter-btn" onclick="filterPatternTable('type', 'stock', this)"> Stocks Only</button>
                </div>
                <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;">
                    <span style="font-size: 11px; color: var(--muted); font-weight: 600; min-width: 80px;">PATTERN:</span>
                    <button class="pattern-filter-btn active" onclick="filterPatternTable('pattern', 'all', this)">All Patterns</button>
                    <button class="pattern-filter-btn" onclick="filterPatternTable('pattern', 'hammer', this)"> Hammer</button>
                    <button class="pattern-filter-btn" onclick="filterPatternTable('pattern', 'invhammer', this)"> Inv Hammer</button>
                    <button class="pattern-filter-btn" onclick="filterPatternTable('pattern', 'doji', this)"> Doji</button>
                    <button class="pattern-filter-btn" onclick="filterPatternTable('pattern', 'gravestone', this)"> Gravestone</button>
                    <button class="pattern-filter-btn" onclick="filterPatternTable('pattern', 'bullengulf', this)"> Bull Engulf</button>
                    <button class="pattern-filter-btn" onclick="filterPatternTable('pattern', 'bearengulf', this)"> Bear Engulf</button>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                    <span style="font-size: 11px; color: var(--muted); font-weight: 600; min-width: 80px;">SIGNAL:</span>
                    <button class="pattern-filter-btn active" onclick="filterPatternTable('signal', 'all', this)">All</button>
                    <button class="pattern-filter-btn" onclick="filterPatternTable('signal', 'call', this)" style="border-color: #22c55e; color: #22c55e;"> Bullish</button>
                    <button class="pattern-filter-btn" onclick="filterPatternTable('signal', 'put', this)" style="border-color: #dc2626; color: #dc2626;"> Bearish</button>
                    <button class="pattern-filter-btn" onclick="filterPatternTable('signal', 'trade', this)" style="border-color: #22c55e; color: #22c55e;"> Trade Ready</button>
                </div>
            </div>

            <!-- Main Patterns Table -->
            <div style="background: white; border-radius: 12px; overflow: hidden; margin-bottom: 20px; border: 1px solid var(--border);">
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background: #f1f5f9;">
                            <th style="padding: 14px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border);">PATTERN</th>
                            <th style="padding: 14px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border);">SYMBOL</th>
                            <th style="padding: 14px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border);">PRICE</th>
                            <th style="padding: 14px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border);">TIMEFRAME</th>
                            <th style="padding: 14px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border);">SIGNAL</th>
                            <th style="padding: 14px 12px; text-align: center; font-weight: 600; border-bottom: 2px solid var(--border);">ACCURACY</th>
                            <th style="padding: 14px 12px; text-align: center; font-weight: 600; border-bottom: 2px solid var(--border);">SQ9 ALIGN</th>
                            <th style="padding: 14px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border);">TREND</th>
                            <th style="padding: 14px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border);">ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="patternScannerBody">
                        <tr><td colspan="9" style="text-align: center; padding: 30px; color: var(--muted);">Scanning patterns...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Accuracy Rankings Section -->
            <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                    <h3 style="font-size: 16px; color: var(--text); margin: 0;"> PATTERN ACCURACY RANKINGS (Historical)</h3>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <button class="pattern-filter-btn active" onclick="filterPatternAccuracy('all', this)" id="patAccAll">All Symbols</button>
                        <button class="pattern-filter-btn" onclick="filterPatternAccuracy('etfs', this)" id="patAccETFs"> All ETFs</button>
                        <button class="pattern-filter-btn" onclick="filterPatternAccuracy('stocks', this)" id="patAccStocks"> All Stocks</button>
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f1f5f9; border-radius: 8px;">
                            <label style="font-size: 11px; font-weight: 600; color: var(--muted);"> Individual Symbol:</label>
                            <select id="patternETFSelect" onchange="filterPatternAccuracyByETF(this.value)" style="padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border); background: white; font-size: 12px; cursor: pointer; min-width: 140px;">
                                <option value="">-- Select Symbol --</option>
                                <optgroup label="Index ETFs">
                                    <option value="SPY">SPY - S&P 500</option>
                                    <option value="QQQ">QQQ - Nasdaq 100</option>
                                    <option value="IWM">IWM - Russell 2000</option>
                                    <option value="DIA">DIA - Dow Jones</option>
                                </optgroup>
                                <optgroup label="Sector ETFs">
                                    <option value="XLF">XLF - Financials</option>
                                    <option value="XLE">XLE - Energy</option>
                                    <option value="XLK">XLK - Technology</option>
                                    <option value="XLV">XLV - Healthcare</option>
                                    <option value="XLI">XLI - Industrials</option>
                                    <option value="XLB">XLB - Materials</option>
                                    <option value="XLU">XLU - Utilities</option>
                                    <option value="XLP">XLP - Cons. Staples</option>
                                    <option value="XLY">XLY - Cons. Discret.</option>
                                </optgroup>
                                <optgroup label="Mega Cap Stocks">
                                    <option value="AAPL">AAPL - Apple</option>
                                    <option value="MSFT">MSFT - Microsoft</option>
                                    <option value="NVDA">NVDA - NVIDIA</option>
                                    <option value="TSLA">TSLA - Tesla</option>
                                    <option value="AMZN">AMZN - Amazon</option>
                                    <option value="GOOGL">GOOGL - Alphabet</option>
                                    <option value="META">META - Meta</option>
                                    <option value="JPM">JPM - JPMorgan</option>
                                    <option value="AMD">AMD - AMD</option>
                                    <option value="NFLX">NFLX - Netflix</option>
                                </optgroup>
                                <optgroup label="Liquid Stocks">
                                    <option value="V">V - Visa</option>
                                    <option value="MA">MA - Mastercard</option>
                                    <option value="UNH">UNH - UnitedHealth</option>
                                    <option value="HD">HD - Home Depot</option>
                                    <option value="PG">PG - Procter & Gamble</option>
                                    <option value="BAC">BAC - Bank of America</option>
                                    <option value="WMT">WMT - Walmart</option>
                                    <option value="DIS">DIS - Disney</option>
                                    <option value="COST">COST - Costco</option>
                                    <option value="CRM">CRM - Salesforce</option>
                                    <option value="INTC">INTC - Intel</option>
                                    <option value="CSCO">CSCO - Cisco</option>
                                    <option value="ADBE">ADBE - Adobe</option>
                                    <option value="ORCL">ORCL - Oracle</option>
                                    <option value="PFE">PFE - Pfizer</option>
                                    <option value="MRK">MRK - Merck</option>
                                    <option value="ABBV">ABBV - AbbVie</option>
                                    <option value="LLY">LLY - Eli Lilly</option>
                                    <option value="CVX">CVX - Chevron</option>
                                    <option value="XOM">XOM - ExxonMobil</option>
                                </optgroup>
                            </select>
                            <span id="selectedPatternETF" style="background: #dbeafe; color: #2563eb; padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 12px; display: none;"></span>
                        </div>
                    </div>
                </div>

                <!-- Default Accuracy Table -->
                <table id="patternAccuracyTable" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background: #f1f5f9;">
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Rank</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600;">Pattern</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Daily</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">15 Min</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">5 Min</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Overall</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Best TF</th>
                        </tr>
                    </thead>
                    <tbody id="patternAccuracyBody">
                        <tr><td></td><td style="font-weight:600;">Bullish Engulfing</td><td style="color:#22c55e;font-weight:600;">82%</td><td>76%</td><td>71%</td><td style="font-weight:700;">76%</td><td><span style="padding:4px 10px;background:#f3e8ff;color:#7c3aed;border-radius:6px;font-size:11px;">Daily</span></td></tr>
                        <tr><td></td><td style="font-weight:600;">Bearish Engulfing</td><td style="color:#22c55e;font-weight:600;">80%</td><td>74%</td><td>68%</td><td style="font-weight:700;">74%</td><td><span style="padding:4px 10px;background:#f3e8ff;color:#7c3aed;border-radius:6px;font-size:11px;">Daily</span></td></tr>
                        <tr><td></td><td style="font-weight:600;">Hammer</td><td style="color:#22c55e;">78%</td><td>70%</td><td>65%</td><td style="font-weight:700;">71%</td><td><span style="padding:4px 10px;background:#f3e8ff;color:#7c3aed;border-radius:6px;font-size:11px;">Daily</span></td></tr>
                        <tr><td>4</td><td>Gravestone Doji</td><td>75%</td><td>68%</td><td>62%</td><td>68%</td><td><span style="padding:4px 10px;background:#f3e8ff;color:#7c3aed;border-radius:6px;font-size:11px;">Daily</span></td></tr>
                        <tr><td>5</td><td>Inverted Hammer</td><td>72%</td><td>66%</td><td>60%</td><td>66%</td><td><span style="padding:4px 10px;background:#f3e8ff;color:#7c3aed;border-radius:6px;font-size:11px;">Daily</span></td></tr>
                        <tr><td>6</td><td>Doji</td><td style="color:#ca8a04;">65%</td><td>58%</td><td>52%</td><td>58%</td><td><span style="padding:4px 10px;background:#f3e8ff;color:#7c3aed;border-radius:6px;font-size:11px;">Daily</span></td></tr>
                    </tbody>
                </table>

                <p id="patternAccuracyNote" style="font-size: 11px; color: var(--muted); margin-top: 8px; font-style: italic;">Accuracy based on historical pattern performance across all tracked symbols.</p>

                <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 12px 16px; margin-top: 16px; font-size: 12px; color: #1e40af;">
                    <strong style="color: #2563eb;"> TIP:</strong> Daily patterns have highest accuracy. <strong>Individual symbol analysis</strong> helps identify which patterns work best for specific instruments. AAPL, MSFT, SPY and QQQ typically show highest accuracy due to liquidity. All 43 symbols (13 ETFs + 30 Stocks) available.
                </div>
            </div>
        </div>

        <!-- TRADES TAB - COMPREHENSIVE TRADE LOG -->
        <div id="trades" class="tab-content">
            <!-- Trade Journal Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="font-size: 14px; font-weight: 600; color: var(--text); margin: 0;"> Trade Journal</h3>
                <span id="tradesLastUpdated" class="section-timestamp" style="font-size: 10px; color: var(--muted);" title="Last updated"> --</span>
            </div>
            <!-- Filter Controls -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 8px;">
                <div>
                    <label style="font-size: 10px; color: #64748b; display: block;">Symbol</label>
                    <select id="filterSymbol" onchange="filterTradesTable()" style="padding: 5px 10px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px;">
                        <option value="">All Symbols</option>
                        <optgroup label="Index ETFs">
                            <option value="SPY">SPY</option>
                            <option value="QQQ">QQQ</option>
                            <option value="IWM">IWM</option>
                            <option value="DIA">DIA</option>
                        </optgroup>
                        <optgroup label="Sector ETFs">
                            <option value="XLF">XLF</option>
                            <option value="XLE">XLE</option>
                            <option value="XLK">XLK</option>
                            <option value="XLV">XLV</option>
                            <option value="XLI">XLI</option>
                            <option value="XLB">XLB</option>
                            <option value="XLU">XLU</option>
                            <option value="XLP">XLP</option>
                            <option value="XLY">XLY</option>
                        </optgroup>
                        <optgroup label="Stocks">
                            <option value="AAPL">AAPL</option>
                            <option value="MSFT">MSFT</option>
                            <option value="NVDA">NVDA</option>
                            <option value="TSLA">TSLA</option>
                            <option value="AMZN">AMZN</option>
                            <option value="GOOGL">GOOGL</option>
                            <option value="META">META</option>
                            <option value="JPM">JPM</option>
                            <option value="AMD">AMD</option>
                            <option value="NFLX">NFLX</option>
                            <option value="V">V</option>
                            <option value="MA">MA</option>
                            <option value="UNH">UNH</option>
                            <option value="HD">HD</option>
                            <option value="PG">PG</option>
                            <option value="BAC">BAC</option>
                            <option value="WMT">WMT</option>
                            <option value="DIS">DIS</option>
                            <option value="COST">COST</option>
                            <option value="CRM">CRM</option>
                            <option value="INTC">INTC</option>
                            <option value="CSCO">CSCO</option>
                            <option value="ADBE">ADBE</option>
                            <option value="ORCL">ORCL</option>
                            <option value="PFE">PFE</option>
                            <option value="MRK">MRK</option>
                            <option value="ABBV">ABBV</option>
                            <option value="LLY">LLY</option>
                            <option value="CVX">CVX</option>
                            <option value="XOM">XOM</option>
                        </optgroup>
                    </select>
                </div>
                <div>
                    <label style="font-size: 10px; color: #64748b; display: block;">Type</label>
                    <select id="filterType" onchange="filterTradesTable()" style="padding: 5px 10px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px;">
                        <option value="">All Types</option>
                        <option value="CALL">CALL</option>
                        <option value="PUT">PUT</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 10px; color: #64748b; display: block;">Result</label>
                    <select id="filterResult" onchange="filterTradesTable()" style="padding: 5px 10px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px;">
                        <option value="">All Results</option>
                        <option value="WIN">WIN</option>
                        <option value="LOSS">LOSS</option>
                        <option value="OPEN">OPEN</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 10px; color: #64748b; display: block;">Date Range</label>
                    <select id="filterDate" onchange="filterTradesTable()" style="padding: 5px 10px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px;">
                        <option value="">All Time</option>
                        <option value="7">Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                    </select>
                </div>
                <div style="margin-left: auto; display: flex; align-items: flex-end;">
                    <button onclick="exportTradesToCSV()" style="padding: 5px 15px; background: #22c55e; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;"> Export CSV</button>
                </div>
            </div>
            <!-- Trade Statistics Dashboard -->
            <div class="grid grid-5">
                <div class="metric">
                    <div class="metric-label">Total Trades</div>
                    <div class="metric-value" id="statTotalTrades">0</div>
                    <div class="metric-sub" id="statTradesThisWeek">0 this week</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Win Rate</div>
                    <div class="metric-value positive" id="statWinRate">0%</div>
                    <div class="metric-sub" id="statWinLoss">0W / 0L</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Total P&L</div>
                    <div class="metric-value" id="statTotalPnL">$0.00</div>
                    <div class="metric-sub" id="statAvgTrade">Avg: $0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Best Trade</div>
                    <div class="metric-value positive" id="statBestTrade">$0.00</div>
                    <div class="metric-sub" id="statBestSymbol">--</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Worst Trade</div>
                    <div class="metric-value negative" id="statWorstTrade">$0.00</div>
                    <div class="metric-sub" id="statWorstSymbol">--</div>
                </div>
            </div>

            <!-- Log New Trade Form -->
            <div class="card">
                <div class="card-title"> Log New Trade</div>
                <form id="tradeForm" onsubmit="logTrade(event)">
                    <div class="grid grid-4" style="margin-bottom:12px;">
                        <div class="form-group-trade">
                            <label>Date</label>
                            <input type="date" id="tradeDate" required>
                        </div>
                        <div class="form-group-trade">
                            <label>Symbol</label>
                            <select id="tradeSymbol" required>
                                <optgroup label="Index ETFs">
                                    <option value="SPY">SPY</option>
                                    <option value="QQQ">QQQ</option>
                                    <option value="IWM">IWM</option>
                                    <option value="DIA">DIA</option>
                                </optgroup>
                                <optgroup label="Sector ETFs">
                                    <option value="XLF">XLF</option>
                                    <option value="XLE">XLE</option>
                                    <option value="XLK">XLK</option>
                                    <option value="XLV">XLV</option>
                                    <option value="XLI">XLI</option>
                                    <option value="XLB">XLB</option>
                                    <option value="XLU">XLU</option>
                                    <option value="XLP">XLP</option>
                                    <option value="XLY">XLY</option>
                                </optgroup>
                                <optgroup label="Mega Caps">
                                    <option value="AAPL">AAPL</option>
                                    <option value="MSFT">MSFT</option>
                                    <option value="NVDA">NVDA</option>
                                    <option value="TSLA">TSLA</option>
                                    <option value="AMZN">AMZN</option>
                                    <option value="GOOGL">GOOGL</option>
                                    <option value="META">META</option>
                                    <option value="JPM">JPM</option>
                                    <option value="AMD">AMD</option>
                                    <option value="NFLX">NFLX</option>
                                </optgroup>
                                <optgroup label="Additional Stocks">
                                    <option value="V">V</option>
                                    <option value="MA">MA</option>
                                    <option value="UNH">UNH</option>
                                    <option value="HD">HD</option>
                                    <option value="PG">PG</option>
                                    <option value="BAC">BAC</option>
                                    <option value="WMT">WMT</option>
                                    <option value="DIS">DIS</option>
                                    <option value="COST">COST</option>
                                    <option value="CRM">CRM</option>
                                    <option value="INTC">INTC</option>
                                    <option value="CSCO">CSCO</option>
                                    <option value="ADBE">ADBE</option>
                                    <option value="ORCL">ORCL</option>
                                    <option value="PFE">PFE</option>
                                    <option value="MRK">MRK</option>
                                    <option value="ABBV">ABBV</option>
                                    <option value="LLY">LLY</option>
                                    <option value="CVX">CVX</option>
                                    <option value="XOM">XOM</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group-trade">
                            <label>Direction</label>
                            <select id="tradeDirection" required>
                                <option value="CALL"> CALL</option>
                                <option value="PUT"> PUT</option>
                            </select>
                        </div>
                        <div class="form-group-trade">
                            <label>Trade Type</label>
                            <select id="tradeType" required>
                                <option value="INTRADAY"> Intraday (0DTE)</option>
                                <option value="SWING"> Swing (3-5 DTE)</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-5" style="margin-bottom:12px;">
                        <div class="form-group-trade">
                            <label>Strike Price</label>
                            <input type="number" id="tradeStrike" placeholder="675" step="1" required>
                        </div>
                        <div class="form-group-trade">
                            <label>Contracts</label>
                            <select id="tradeContracts" required>
                                <option value="1">1 Contract</option>
                                <option value="2">2 Contracts</option>
                                <option value="3">3 Contracts</option>
                                <option value="4">4 Contracts</option>
                                <option value="5">5 Contracts</option>
                                <option value="10">10 Contracts</option>
                            </select>
                        </div>
                        <div class="form-group-trade">
                            <label>Entry Premium</label>
                            <input type="number" id="tradeEntry" placeholder="2.50" step="0.01" required>
                        </div>
                        <div class="form-group-trade">
                            <label>Exit Premium</label>
                            <input type="number" id="tradeExit" placeholder="3.75" step="0.01">
                        </div>
                        <div class="form-group-trade">
                            <label>Agent Consensus</label>
                            <select id="tradeConsensus">
                                <option value="4/4">4/4 ULTRA</option>
                                <option value="3/4" selected>3/4 SUPER</option>
                                <option value="2/4">2/4 SINGLE</option>
                                <option value="1/4">1/4 WEAK</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-2" style="margin-bottom:12px;">
                        <div class="form-group-trade">
                            <label>Status</label>
                            <select id="tradeStatus" onchange="toggleExitField()">
                                <option value="CLOSED"> Closed</option>
                                <option value="OPEN"> Open</option>
                                <option value="STOPPED"> Stopped Out</option>
                            </select>
                        </div>
                        <div class="form-group-trade">
                            <label>Notes</label>
                            <input type="text" id="tradeNotes" placeholder="Morning breakout, hit T1...">
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;">
                        <button type="submit" class="trade-btn primary"> Log Trade</button>
                        <button type="button" class="trade-btn secondary" onclick="clearTradeForm()">Clear Form</button>
                    </div>
                </form>
            </div>

            <!-- Trade Actions Bar -->
            <div class="card" style="padding:10px;">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                    <div style="display:flex;gap:8px;align-items:center;">
                        <label style="font-size:11px;color:var(--muted);">Filter:</label>
                        <select id="filterSymbol" onchange="filterTrades()" style="padding:5px;border:1px solid var(--border);border-radius:4px;font-size:11px;">
                            <option value="ALL">All Symbols</option>
                            <optgroup label="Index ETFs">
                                <option value="SPY">SPY</option>
                                <option value="QQQ">QQQ</option>
                                <option value="IWM">IWM</option>
                                <option value="DIA">DIA</option>
                            </optgroup>
                            <optgroup label="Sector ETFs">
                                <option value="XLF">XLF</option>
                                <option value="XLE">XLE</option>
                                <option value="XLK">XLK</option>
                                <option value="XLV">XLV</option>
                                <option value="XLI">XLI</option>
                                <option value="XLB">XLB</option>
                                <option value="XLU">XLU</option>
                                <option value="XLP">XLP</option>
                                <option value="XLY">XLY</option>
                            </optgroup>
                            <optgroup label="Stocks">
                                <option value="AAPL">AAPL</option>
                                <option value="MSFT">MSFT</option>
                                <option value="NVDA">NVDA</option>
                                <option value="TSLA">TSLA</option>
                                <option value="AMZN">AMZN</option>
                                <option value="GOOGL">GOOGL</option>
                                <option value="META">META</option>
                                <option value="JPM">JPM</option>
                                <option value="AMD">AMD</option>
                                <option value="NFLX">NFLX</option>
                                <option value="V">V</option>
                                <option value="MA">MA</option>
                                <option value="UNH">UNH</option>
                                <option value="HD">HD</option>
                                <option value="PG">PG</option>
                                <option value="BAC">BAC</option>
                                <option value="WMT">WMT</option>
                                <option value="DIS">DIS</option>
                                <option value="COST">COST</option>
                                <option value="CRM">CRM</option>
                                <option value="INTC">INTC</option>
                                <option value="CSCO">CSCO</option>
                                <option value="ADBE">ADBE</option>
                                <option value="ORCL">ORCL</option>
                                <option value="PFE">PFE</option>
                                <option value="MRK">MRK</option>
                                <option value="ABBV">ABBV</option>
                                <option value="LLY">LLY</option>
                                <option value="CVX">CVX</option>
                                <option value="XOM">XOM</option>
                            </optgroup>
                        </select>
                        <select id="filterDirection" onchange="filterTrades()" style="padding:5px;border:1px solid var(--border);border-radius:4px;font-size:11px;">
                            <option value="ALL">All Directions</option>
                            <option value="CALL">CALL Only</option>
                            <option value="PUT">PUT Only</option>
                        </select>
                        <select id="filterStatus" onchange="filterTrades()" style="padding:5px;border:1px solid var(--border);border-radius:4px;font-size:11px;">
                            <option value="ALL">All Status</option>
                            <option value="OPEN">Open</option>
                            <option value="CLOSED">Closed</option>
                            <option value="STOPPED">Stopped</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="action-btn" onclick="printTrades()"> Print</button>
                        <button class="action-btn" onclick="exportCSV()"> Export CSV</button>
                        <button class="action-btn" onclick="shareTrades()"> Share</button>
                        <button class="action-btn" onclick="emailTrades()"> Email</button>
                        <button class="action-btn danger" onclick="clearAllTrades()"> Clear All</button>
                    </div>
                </div>
            </div>

            <!-- Trade History Table -->
            <div class="card">
                <div class="card-title"> Trade History <span id="tradeCount" style="font-size:11px;color:var(--muted);margin-left:8px;">(0 trades)</span></div>
                <div class="table-wrap" style="max-height:400px;overflow-y:auto;">
                    <table id="tradeTable">
                        <thead>
                            <tr>
                                <th style="width:30px;">#</th>
                                <th>Date</th>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Strike</th>
                                <th>Contracts</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>P&L</th>
                                <th>Consensus</th>
                                <th>Status</th>
                                <th>Notes</th>
                                <th style="width:80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tradeTableBody">
                            <tr><td colspan="13" style="text-align:center;color:var(--muted);padding:30px;">No trades logged yet. Start by logging your first trade above!</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Trade Analytics -->
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-title"> Performance by Symbol</div>
                    <div id="symbolPerformance">
                        <p style="color:var(--muted);font-size:12px;">Log trades to see performance breakdown</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title"> Performance by Direction</div>
                    <div id="directionPerformance">
                        <p style="color:var(--muted);font-size:12px;">Log trades to see CALL vs PUT performance</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title"> Agent Consensus Analysis</div>
                <div id="consensusAnalysis" class="grid grid-4">
                    <div style="background:var(--bg);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--muted);">4/4 ULTRA</div>
                        <div style="font-size:20px;font-weight:700;" id="ultra44WinRate">--%</div>
                        <div style="font-size:10px;color:var(--muted);" id="ultra44Count">0 trades</div>
                    </div>
                    <div style="background:var(--bg);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--muted);">3/4 SUPER</div>
                        <div style="font-size:20px;font-weight:700;" id="super34WinRate">--%</div>
                        <div style="font-size:10px;color:var(--muted);" id="super34Count">0 trades</div>
                    </div>
                    <div style="background:var(--bg);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--muted);">2/4 SINGLE</div>
                        <div style="font-size:20px;font-weight:700;" id="single24WinRate">--%</div>
                        <div style="font-size:10px;color:var(--muted);" id="single24Count">0 trades</div>
                    </div>
                    <div style="background:var(--bg);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--muted);">1/4 WEAK</div>
                        <div style="font-size:20px;font-weight:700;" id="weak14WinRate">--%</div>
                        <div style="font-size:10px;color:var(--muted);" id="weak14Count">0 trades</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- OPPORTUNITIES TAB -->
        <div id="opportunities" class="tab-content">
            <!-- Opportunities Tab Header with Last Updated -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h2 style="margin: 0; font-size: 20px; color: var(--text);"> Trading Opportunities - All Symbols</h2>
                    <p style="margin: 4px 0 0; font-size: 12px; color: #888;">SQ9 Alignment + Trade Direction Context</p>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span id="oppLastUpdated" style="font-size: 11px; color: #888; padding: 4px 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                        Updated: --
                    </span>
                    <button onclick="refreshOpportunitiesTab()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #22c55e; background: transparent; color: #22c55e; cursor: pointer; font-size: 11px;">
                         Refresh
                    </button>
                </div>
            </div>
            <div class="card">
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 11px; color: #666;">Total Opportunities</div>
                        <div style="font-size: 24px; font-weight: 700;" id="opp-total">27</div>
                    </div>
                    <div style="background: rgba(34,197,94,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 11px; color: #666;"> Aligned</div>
                        <div style="font-size: 24px; font-weight: 700; color: #22c55e;" id="opp-ready">0</div>
                    </div>
                    <div style="background: rgba(234,179,8,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 11px; color: #666;"> Conflict</div>
                        <div style="font-size: 24px; font-weight: 700; color: #eab308;" id="opp-soon">0</div>
                    </div>
                    <div style="background: rgba(59,130,246,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 11px; color: #666;">Calls / Puts</div>
                        <div style="font-size: 24px; font-weight: 700;" id="opp-ratio">7 / 5</div>
                    </div>
                </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <button onclick="filterOppTable('all')" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px;">All</button>
                    <button onclick="filterOppTable('aligned')" style="padding: 8px 16px; background: #e5e7eb; color: #333; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px;"> Aligned Only</button>
                    <button onclick="filterOppTable('ready')" style="padding: 8px 16px; background: #e5e7eb; color: #333; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px;"> Ready (3 days)</button>
                    <button onclick="filterOppTable('calls')" style="padding: 8px 16px; background: #e5e7eb; color: #333; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px;"> Calls</button>
                    <button onclick="filterOppTable('puts')" style="padding: 8px 16px; background: #e5e7eb; color: #333; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px;"> Puts</button>
                    <button onclick="filterOppTable('lowrisk')" style="padding: 8px 16px; background: #e5e7eb; color: #333; border: none; border-radius: 6px; cursor: pointer;">Low Risk</button>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f0f0f0;">
                                <th class="sortable-header" data-sort="align" data-type="align" onclick="sortOppTable('align')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">ALIGN</th>
                                <th class="sortable-header" data-sort="symbol" data-type="text" onclick="sortOppTable('symbol')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">SYMBOL</th>
                                <th class="sortable-header" data-sort="price" data-type="currency" onclick="sortOppTable('price')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">PRICE</th>
                                <th class="sortable-header" data-sort="chg" data-type="percent" onclick="sortOppTable('chg')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">CHG</th>
                                <th class="sortable-header" data-sort="ma20" data-type="position" onclick="sortOppTable('ma20')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">20MA</th>
                                <th class="sortable-header" data-sort="support" data-type="currency" onclick="sortOppTable('support')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">SUPPORT</th>
                                <th class="sortable-header" data-sort="resist" data-type="currency" onclick="sortOppTable('resist')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">RESIST</th>
                                <th class="sortable-header" data-sort="gann" data-type="direction" onclick="sortOppTable('gann')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px; background: rgba(139,92,246,0.1);"> GANN</th>
                                <th class="sortable-header" data-sort="sq9" data-type="direction" onclick="sortOppTable('sq9')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px; background: rgba(102,126,234,0.15);"> SQ9</th>
                                <th class="sortable-header" data-sort="sq9align" data-type="percent" onclick="sortOppTable('sq9align')" style="padding: 6px; text-align: center; border-bottom: 1px solid #ddd; font-size: 9px; background: rgba(34,197,94,0.1);">SQ9 ALIGN</th>
                                <th class="sortable-header" data-sort="mkt" data-type="direction" onclick="sortOppTable('mkt')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px; background: rgba(239,68,68,0.1);"> MKT</th>
                                <th class="sortable-header" data-sort="turn" data-type="text" onclick="sortOppTable('turn')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">TURN</th>
                                <th class="sortable-header" data-sort="next" data-type="date" onclick="sortOppTable('next')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">NEXT</th>
                                <th class="sortable-header" data-sort="days" data-type="number" onclick="sortOppTable('days')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">DAYS</th>
                                <th class="sortable-header" data-sort="stage" data-type="text" onclick="sortOppTable('stage')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">STAGE</th>
                                <th class="sortable-header" data-sort="entry" data-type="currency" onclick="sortOppTable('entry')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">ENTRY</th>
                                <th class="sortable-header" data-sort="expmove" data-type="percent" onclick="sortOppTable('expmove')" style="padding: 6px; text-align: center; border-bottom: 1px solid #ddd; font-size: 9px; background: rgba(34,197,94,0.1);">EXP MOVE</th>
                                <th class="sortable-header" data-sort="target" data-type="currency" onclick="sortOppTable('target')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">TARGET</th>
                                <th class="sortable-header" data-sort="stop" data-type="currency" onclick="sortOppTable('stop')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">STOP</th>
                                <th class="sortable-header" data-sort="risk" data-type="risk" onclick="sortOppTable('risk')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">RISK</th>
                                <th class="sortable-header sort-desc" data-sort="score" data-type="number" onclick="sortOppTable('score')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">SCORE</th>
                                <th class="sortable-header" data-sort="action" data-type="action" onclick="sortOppTable('action')" style="padding: 6px; text-align: left; border-bottom: 1px solid #ddd; font-size: 9px;">ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="oppTableBody">
                            <tr><td colspan="22" style="text-align: center; padding: 30px; color: #666;">Loading opportunities from market data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- HEALTH MONITOR TAB -->
        <div id="health" class="tab-content">
            <!-- System Status Banner -->
            <div class="health-banner" id="healthBanner">
                <div class="health-banner-icon" id="healthBannerIcon"></div>
                <div class="health-banner-content">
                    <div class="health-banner-title" id="healthBannerTitle">System Healthy</div>
                    <div class="health-banner-subtitle" id="healthBannerSubtitle">All systems operational</div>
                </div>
                <div id="healthTrafficSummary" style="display: flex; gap: 8px; align-items: center; margin-right: 15px;">
                    <span id="trafficGreenCount" style="font-size: 14px;"> 4</span>
                    <span id="trafficYellowCount" style="font-size: 14px;"> 0</span>
                    <span id="trafficRedCount" style="font-size: 14px;"> 0</span>
                </div>
                <span id="healthLastUpdated" class="section-timestamp" style="font-size: 10px; color: var(--muted); margin-right: 10px;" title="Last health check"> --</span>
                <button class="refresh-health-btn" onclick="runHealthCheck()"> Run Check</button>
            </div>

            <!-- Health Metrics Grid -->
            <div class="grid grid-4">
                <div class="health-metric" id="healthDataFresh">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="health-metric-icon"></div>
                        <div class="health-traffic-light" id="dataFreshnessLight"></div>
                    </div>
                    <div class="health-metric-label">Data Freshness</div>
                    <div class="health-metric-value" id="dataFreshnessValue">Checking...</div>
                    <div class="health-metric-status" id="dataFreshnessStatus">--</div>
                </div>
                <div class="health-metric" id="healthMarket">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="health-metric-icon"></div>
                        <div class="health-traffic-light" id="marketStatusLight"></div>
                    </div>
                    <div class="health-metric-label">Market Status</div>
                    <div class="health-metric-value" id="marketStatusValue">Checking...</div>
                    <div class="health-metric-status" id="marketStatusStatus">--</div>
                </div>
                <div class="health-metric" id="healthWorkflow">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="health-metric-icon"></div>
                        <div class="health-traffic-light" id="workflowStatusLight"></div>
                    </div>
                    <div class="health-metric-label">Agent Workflow</div>
                    <div class="health-metric-value" id="workflowStatusValue">Checking...</div>
                    <div class="health-metric-status" id="workflowStatusStatus">--</div>
                </div>
                <div class="health-metric" id="healthDataQuality">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="health-metric-icon"></div>
                        <div class="health-traffic-light" id="dataQualityLight"></div>
                    </div>
                    <div class="health-metric-label">Data Quality</div>
                    <div class="health-metric-value" id="dataQualityValue">Checking...</div>
                    <div class="health-metric-status" id="dataQualityStatus">--</div>
                </div>
            </div>

            <!-- Detailed Status Cards -->
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-title"> Data Timeline</div>
                    <div class="health-timeline">
                        <div class="timeline-item">
                            <span class="timeline-label">Last Data Point:</span>
                            <span class="timeline-value" id="lastDataDate">--</span>
                        </div>
                        <div class="timeline-item">
                            <span class="timeline-label">Days Since Update:</span>
                            <span class="timeline-value" id="daysSinceUpdate">--</span>
                        </div>
                        <div class="timeline-item">
                            <span class="timeline-label">Expected Update:</span>
                            <span class="timeline-value" id="expectedUpdate">--</span>
                        </div>
                        <div class="timeline-item">
                            <span class="timeline-label">Total Bars Loaded:</span>
                            <span class="timeline-value" id="totalBarsLoaded">--</span>
                        </div>
                        <div class="timeline-item">
                            <span class="timeline-label">Date Range:</span>
                            <span class="timeline-value" id="dataDateRange">--</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"> Connection Status</div>
                    <div class="table-wrap">
                        <table style="font-size: 11px;">
                            <thead>
                                <tr><th>Connection</th><th>Status</th><th>Light</th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>GitHub Pages</td>
                                    <td id="connGitHubStatus">--</td>
                                    <td id="connGitHubLight"></td>
                                </tr>
                                <tr>
                                    <td>Data Feed (<span id="connDataSymbol">SPY</span>.csv)</td>
                                    <td id="connDataStatus">--</td>
                                    <td id="connDataLight"></td>
                                </tr>
                                <tr>
                                    <td>Portfolio Feed</td>
                                    <td id="connPortfolioStatus">--</td>
                                    <td id="connPortfolioLight"></td>
                                </tr>
                                <tr>
                                    <td>Local Storage</td>
                                    <td id="connLocalStorageStatus">--</td>
                                    <td id="connLocalStorageLight"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Alerts & Issues -->
            <div class="card">
                <div class="card-title"> Alerts & Issues</div>
                <div id="healthAlerts" class="health-alerts">
                    <div class="health-alert info">
                        <span class="alert-icon"></span>
                        <span>Running initial health check...</span>
                    </div>
                </div>
            </div>

            <!-- Component Status with Last Run -->
            <div class="card">
                <div class="card-title"> Component Status</div>
                <div class="table-wrap">
                    <table style="font-size: 11px;">
                        <thead>
                            <tr><th>Component</th><th>Last Run</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Data Fetch</td>
                                <td id="compDataFetchTime">--</td>
                                <td id="compDataFetchLight"></td>
                            </tr>
                            <tr>
                                <td>Agent Workflow</td>
                                <td id="compWorkflowTime">--</td>
                                <td id="compWorkflowLight"></td>
                            </tr>
                            <tr>
                                <td>Health Check</td>
                                <td id="compHealthCheckTime">--</td>
                                <td id="compHealthCheckLight"></td>
                            </tr>
                            <tr>
                                <td>GitHub Deploy</td>
                                <td id="compDeployTime">--</td>
                                <td id="compDeployLight"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- System Log -->
            <div class="card">
                <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span> System Log (Last 10 Events)</span>
                    <button onclick="clearSystemLog()" style="background: var(--danger); color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 10px; cursor: pointer;">Clear Log</button>
                </div>
                <div class="table-wrap" style="max-height: 200px; overflow-y: auto;">
                    <table style="font-size: 10px;">
                        <thead>
                            <tr><th>Date/Time</th><th>Event</th><th>Status</th></tr>
                        </thead>
                        <tbody id="systemLogTable">
                            <tr><td colspan="3" style="text-align: center; color: var(--muted);">No events logged yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- System Info -->
            <div class="card">
                <div class="card-title"> System Information</div>
                <div class="grid grid-3">
                    <div class="sys-info-item">
                        <div class="sys-info-label">Platform Version</div>
                        <div class="sys-info-value">Stock Agent 4 v7.2</div>
                    </div>
                    <div class="sys-info-item">
                        <div class="sys-info-label">Dashboard</div>
                        <div class="sys-info-value">Q5D Options Platform</div>
                    </div>
                    <div class="sys-info-item">
                        <div class="sys-info-label">Last Health Check</div>
                        <div class="sys-info-value" id="lastHealthCheck">--</div>
                    </div>
                    <div class="sys-info-item">
                        <div class="sys-info-label">Workflow Schedule</div>
                        <div class="sys-info-value">9:35 AM & 4:05 PM ET</div>
                    </div>
                    <div class="sys-info-item">
                        <div class="sys-info-label">Data Source</div>
                        <div class="sys-info-value">Tiingo API</div>
                    </div>
                    <div class="sys-info-item">
                        <div class="sys-info-label">Repository</div>
                        <div class="sys-info-value"><a href="https://github.com/aadey002/Stock-agent-" target="_blank">Stock-agent-</a></div>
                    </div>
                </div>
            </div>

            <!-- Troubleshooting Guide -->
            <div class="card">
                <div class="card-title"> Troubleshooting Guide</div>
                <div class="troubleshoot-accordion">
                    <div class="troubleshoot-item">
                        <div class="troubleshoot-header" onclick="toggleTroubleshoot(this)">
                            <span> Data Not Updating</span>
                            <span class="troubleshoot-toggle">+</span>
                        </div>
                        <div class="troubleshoot-content">
                            <ol>
                                <li>Check GitHub Actions: <a href="https://github.com/aadey002/Stock-agent-/actions" target="_blank">View Workflows</a></li>
                                <li>Verify TIINGO_TOKEN secret is set in repository settings</li>
                                <li>Check if market was open (no updates on weekends/holidays)</li>
                                <li>Manually trigger workflow: Actions  Run workflow</li>
                                <li>Check workflow logs for errors</li>
                            </ol>
                        </div>
                    </div>
                    <div class="troubleshoot-item">
                        <div class="troubleshoot-header" onclick="toggleTroubleshoot(this)">
                            <span> Dashboard Shows Stale Data</span>
                            <span class="troubleshoot-toggle">+</span>
                        </div>
                        <div class="troubleshoot-content">
                            <ol>
                                <li>Hard refresh: Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)</li>
                                <li>Clear browser cache</li>
                                <li>Check if gh-pages branch has latest data</li>
                                <li>Verify GitHub Pages deployment completed</li>
                            </ol>
                        </div>
                    </div>
                    <div class="troubleshoot-item">
                        <div class="troubleshoot-header" onclick="toggleTroubleshoot(this)">
                            <span> Workflow Failing</span>
                            <span class="troubleshoot-toggle">+</span>
                        </div>
                        <div class="troubleshoot-content">
                            <ol>
                                <li>Check Actions tab for error messages</li>
                                <li>Common issues: API rate limits, invalid token, network timeouts</li>
                                <li>Verify Python dependencies are installed</li>
                                <li>Check if Tiingo API is operational</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI ASSISTANT TAB -->
        <div id="ai-assistant" class="tab-content">
            <div class="ai-assistant-container">
                <div class="ai-chat-panel">
                    <div class="ai-chat-header">
                        <div class="ai-avatar"></div>
                        <div>
                            <div style="font-weight:700;">Gann Trading Assistant</div>
                            <div style="font-size:10px;opacity:0.9;">Tunnel Through the Air  Mystifying Square  Divine Proportions</div>
                        </div>
                    </div>
                    <div class="ai-chat-messages" id="aiChatMessages">
                        <div class="ai-message assistant">
                            <div class="message-content">Welcome to the Gann Trading Assistant! 

I'm trained on W.D. Gann's principles from "Tunnel Through the Air", the Mystifying Square (Square of 9), and Divine Proportions (Fibonacci/Golden Ratio).

I can help you with:
  Analyze any ETF/stock on the dashboard
  Find high-consensus trades (3/4, 4/4)
  Recommend optimal strikes
  Gann time cycles & Square of 9
  Divine Proportions (Phi/Fibonacci)
  Generate custom reports

Try: "Show me all ETFs with 4/4 consensus"</div>
                        </div>
                    </div>
                    <div class="ai-chat-input">
                        <input type="text" id="aiInput" placeholder="Ask about trades, Gann methods, analysis..." onkeypress="if(event.key==='Enter')sendAiMessage()">
                        <button onclick="sendAiMessage()" id="aiSendBtn">Send</button>
                    </div>
                </div>
                
                <div class="ai-sidebar">
                    <div class="ai-quick-actions">
                        <h4> Quick Actions</h4>
                        <button class="quick-action-btn" onclick="askAi('Show me all ETFs with 3/4 or 4/4 agent consensus today')"> High Consensus Trades</button>
                        <button class="quick-action-btn" onclick="askAi('Which ETFs are breaking out today?')"> Morning Breakouts</button>
                        <button class="quick-action-btn" onclick="askAi('Scan for all patterns')"> Pattern Scan</button>
                        <button class="quick-action-btn" onclick="askAi('Show momentum rankings')"> Momentum Leaders</button>
                        <button class="quick-action-btn" onclick="askAi('Any reversal patterns forming?')"> Reversal Scan</button>
                        <button class="quick-action-btn" onclick="askAi('What are the best CALL options for the next 2 days?')"> Best CALLs</button>
                        <button class="quick-action-btn" onclick="askAi('What are the best PUT options for the next 2 days?')"> Best PUTs</button>
                        <button class="quick-action-btn" onclick="askAi('What is the optimal strike for ' + currentSymbol + '?')"> Optimal Strike</button>
                        <button class="quick-action-btn" onclick="askAi('When is the best time to trade options?')"> Best Time to Trade</button>
                        <button class="quick-action-btn" onclick="askAi('Show bar count for all ETFs')"> Bar Count</button>
                    </div>
                    
                    <div class="ai-data-context">
                        <h4> Current Context</h4>
                        <div class="context-item"><span>Symbol:</span><span id="aiContextSymbol">SPY</span></div>
                        <div class="context-item"><span>Price:</span><span id="aiContextPrice">$675.02</span></div>
                        <div class="context-item"><span>Signal:</span><span id="aiContextSignal">CALL</span></div>
                        <div class="context-item"><span>Consensus:</span><span id="aiContextConsensus">3/4</span></div>
                        <div class="context-item"><span>Mode:</span><span id="aiContextMode">INTRADAY</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DAILY ANALYSIS TAB -->
        <div id="daily-analysis" class="tab-content">
            <div class="analysis-header">
                <div>
                    <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 4px;"> Daily Trading Analysis</h2>
                    <p style="font-size: 12px; color: var(--muted);">Comprehensive signal confluence with Gann & Fibonacci analysis</p>
                </div>
                <div class="analysis-time">
                    <button class="analysis-time-btn active" onclick="switchAnalysisMode('morning')" id="morningBtn"> Morning Plan</button>
                    <button class="analysis-time-btn" onclick="switchAnalysisMode('evening')" id="eveningBtn"> Evening Review</button>
                    <span id="analysisLastUpdated" class="section-timestamp" style="font-size: 10px; color: var(--muted); margin-left: 10px;" title="Last updated"> --</span>
                </div>
                <div class="report-actions">
                    <button class="report-btn primary" onclick="generateDailyReport()"> Generate Report</button>
                    <button class="report-btn success" onclick="downloadReport()"> Download PDF</button>
                    <button class="report-btn warning" onclick="refreshAnalysis()"> Refresh</button>
                </div>
            </div>

            <!-- SQ9 Entry Signal Monitor -->
            <div class="sq9-monitor" id="sq9Monitor">
                <div class="sq9-monitor-header">
                    <div class="sq9-monitor-title"> SQ9 Entry Signal Monitor</div>
                    <div class="sq9-etf-tabs" id="sq9EtfTabs" style="flex-wrap: wrap;">
                        <button class="sq9-etf-tab active" onclick="selectSq9Etf('SPY')">SPY</button>
                        <button class="sq9-etf-tab" onclick="selectSq9Etf('QQQ')">QQQ</button>
                        <button class="sq9-etf-tab" onclick="selectSq9Etf('DIA')">DIA</button>
                        <button class="sq9-etf-tab" onclick="selectSq9Etf('IWM')">IWM</button>
                        <button class="sq9-etf-tab" onclick="selectSq9Etf('XLF')">XLF</button>
                        <button class="sq9-etf-tab" onclick="selectSq9Etf('XLE')">XLE</button>
                        <button class="sq9-etf-tab" onclick="selectSq9Etf('XLK')">XLK</button>
                        <button class="sq9-etf-tab" onclick="selectSq9Etf('XLV')">XLV</button>
                        <button class="sq9-etf-tab" onclick="selectSq9Etf('XLRE')">XLRE</button>
                        <button class="sq9-etf-tab" onclick="selectSq9Etf('XLC')">XLC</button>
                        <button class="sq9-etf-tab" onclick="selectSq9Etf('XLI')">XLI</button>
                        <button class="sq9-etf-tab" onclick="selectSq9Etf('XLB')">XLB</button>
                        <button class="sq9-etf-tab" onclick="selectSq9Etf('XLU')">XLU</button>
                        <button class="sq9-etf-tab" onclick="selectSq9Etf('XLP')">XLP</button>
                        <button class="sq9-etf-tab" onclick="selectSq9Etf('XLY')">XLY</button>
                    </div>
                </div>

                <!-- Info Bar -->
                <div class="sq9-info-bar">
                    <div class="sq9-info-item">
                        <div class="sq9-info-label">PIVOT</div>
                        <div class="sq9-info-value" id="sq9PivotPrice">$481.80</div>
                        <div class="sq9-info-label" id="sq9PivotDate">Apr 7 LOW</div>
                    </div>
                    <div class="sq9-info-item">
                        <div class="sq9-info-label">CURRENT</div>
                        <div class="sq9-info-value" id="sq9CurrentPrice">$683.26</div>
                        <div class="sq9-info-label" id="sq9FromPivot">+41.8%</div>
                    </div>
                    <div class="sq9-info-item">
                        <div class="sq9-info-label">NEAREST LEVEL</div>
                        <div class="sq9-info-value" id="sq9NearestLevel">$685.42</div>
                    </div>
                    <div class="sq9-bias-badge neutral" id="sq9BiasBadge"> NEUTRAL</div>
                </div>

                <div style="font-size: 12px; text-align: center; margin-bottom: 15px; opacity: 0.8;" id="sq9SetupDesc">
                    Price in NO-TRADE ZONE  Wait for approach to Support or Resistance
                </div>

                <!-- Levels Table -->
                <table class="sq9-levels-table">
                    <thead>
                        <tr>
                            <th>TYPE</th>
                            <th>ROT</th>
                            <th>LEVEL</th>
                            <th>DIST</th>
                            <th>TOUCH</th>
                            <th>CANDLE</th>
                            <th>VOL</th>
                            <th>RSI</th>
                            <th>CLOSE</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody id="sq9LevelsBody">
                        <tr><td colspan="10" style="text-align: center; padding: 20px;">Loading SQ9 levels...</td></tr>
                    </tbody>
                </table>

                <!-- Checklist Panel -->
                <div class="sq9-checklist-panel" id="sq9ChecklistPanel" style="display: none;">
                    <div class="sq9-checklist-title">
                         Entry Checklist for <span id="sq9ChecklistLevel">$685.42</span> <span id="sq9ChecklistType">RESISTANCE</span>
                    </div>
                    <div class="sq9-checklist-grid">
                        <div class="sq9-check-item failed" id="sq9Check1">
                            <div class="sq9-check-icon"></div>
                            <div class="sq9-check-name">Touched</div>
                            <div class="sq9-check-detail" id="sq9Check1Detail">Waiting...</div>
                        </div>
                        <div class="sq9-check-item failed" id="sq9Check2">
                            <div class="sq9-check-icon"></div>
                            <div class="sq9-check-name">Candle</div>
                            <div class="sq9-check-detail" id="sq9Check2Detail">Need pattern</div>
                        </div>
                        <div class="sq9-check-item failed" id="sq9Check3">
                            <div class="sq9-check-icon"></div>
                            <div class="sq9-check-name">Volume</div>
                            <div class="sq9-check-detail" id="sq9Check3Detail">Need high vol</div>
                        </div>
                        <div class="sq9-check-item failed" id="sq9Check4">
                            <div class="sq9-check-icon"></div>
                            <div class="sq9-check-name">RSI</div>
                            <div class="sq9-check-detail" id="sq9Check4Detail">Need confirm</div>
                        </div>
                        <div class="sq9-check-item failed" id="sq9Check5">
                            <div class="sq9-check-icon"></div>
                            <div class="sq9-check-name">Closed</div>
                            <div class="sq9-check-detail" id="sq9Check5Detail">Need close</div>
                        </div>
                    </div>
                    <div class="sq9-progress-container">
                        <div class="sq9-progress-bar">
                            <div class="sq9-progress-fill low" id="sq9ProgressFill" style="width: 0%;"></div>
                        </div>
                        <div class="sq9-progress-text">
                            <span id="sq9ProgressText">0/5 Checks</span>
                            <span id="sq9StatusText"> Waiting for setup</span>
                        </div>
                    </div>
                </div>

                <!-- Entry Zone Alert -->
                <div class="sq9-entry-zone waiting" id="sq9EntryZone">
                    <div class="sq9-entry-title" id="sq9EntryTitle"> NO ACTIVE SETUP</div>
                    <div id="sq9EntryMessage">Price is between SQ9 levels - wait for approach to Support or Resistance</div>
                    <div class="sq9-trade-details" id="sq9TradeDetails" style="display: none;">
                        <div class="sq9-trade-item">
                            <div class="sq9-trade-label">ACTION</div>
                            <div class="sq9-trade-value" id="sq9TradeAction">--</div>
                        </div>
                        <div class="sq9-trade-item">
                            <div class="sq9-trade-label">STRIKE</div>
                            <div class="sq9-trade-value" id="sq9TradeStrike">--</div>
                        </div>
                        <div class="sq9-trade-item">
                            <div class="sq9-trade-label">TARGET</div>
                            <div class="sq9-trade-value" style="color: #4ade80;" id="sq9TradeTarget">--</div>
                        </div>
                        <div class="sq9-trade-item">
                            <div class="sq9-trade-label">STOP</div>
                            <div class="sq9-trade-value" style="color: #f87171;" id="sq9TradeStop">--</div>
                        </div>
                    </div>
                </div>

                <!-- Alert Log -->
                <div class="sq9-alert-log">
                    <div class="sq9-alert-log-title"> Recent Alerts</div>
                    <div id="sq9AlertLog">
                        <div class="sq9-alert-item">
                            <span class="sq9-alert-time">--:-- --</span>
                            <span class="sq9-alert-icon"></span>
                            <span class="sq9-alert-message">Waiting for price to approach SQ9 level...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GANN 8THS RETRACEMENT LEVELS (Rules 3 & 4) -->
            <div style="background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(217,119,6,0.1)); border: 1px solid rgba(245,158,11,0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 16px; font-weight: 700;"> Gann 8ths Retracement Levels</div>
                        <div style="font-size: 11px; color: var(--muted);">Rule 3: Range divided by 8ths | Rule 4: 50% is critical</div>
                    </div>
                    <div id="gann8thsPosition" style="padding: 6px 14px; border-radius: 6px; font-weight: 700; font-size: 12px;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Range Info -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="background: white; border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 9px; color: #666;">52W HIGH</div>
                        <div id="gann8thsHigh" style="font-size: 14px; font-weight: 700; color: #22c55e;">--</div>
                    </div>
                    <div style="background: white; border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 9px; color: #666;">52W LOW</div>
                        <div id="gann8thsLow" style="font-size: 14px; font-weight: 700; color: #ef4444;">--</div>
                    </div>
                    <div style="background: rgba(245,158,11,0.2); border: 2px solid #f59e0b; border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 9px; color: #d97706; font-weight: 600;"> 50% LEVEL</div>
                        <div id="gann8ths50" style="font-size: 14px; font-weight: 700; color: #d97706;">--</div>
                    </div>
                    <div style="background: white; border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 9px; color: #666;">RANGE</div>
                        <div id="gann8thsRange" style="font-size: 14px; font-weight: 700;">--</div>
                    </div>
                </div>

                <!-- Visual Level Chart -->
                <div style="background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                    <div style="font-size: 11px; font-weight: 600; margin-bottom: 10px;">Price Position in Range</div>
                    <div id="gann8thsChart" style="position: relative; height: 40px; background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #22c55e 100%); border-radius: 6px;">
                        <!-- Price marker populated by JS -->
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 9px; color: #666;">
                        <span>0% (Bearish)</span>
                        <span>50% (Pivot)</span>
                        <span>100% (Bullish)</span>
                    </div>
                </div>

                <!-- 8ths Levels Table -->
                <div style="background: white; border-radius: 8px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: rgba(245,158,11,0.1);">
                                <th style="padding: 8px; text-align: left;">LEVEL</th>
                                <th style="padding: 8px; text-align: right;">PRICE</th>
                                <th style="padding: 8px; text-align: right;">DISTANCE</th>
                                <th style="padding: 8px; text-align: center;">TYPE</th>
                            </tr>
                        </thead>
                        <tbody id="gann8thsTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <!-- 50% Rule Explanation -->
                <div style="background: rgba(245,158,11,0.1); border-radius: 8px; padding: 12px; margin-top: 15px;">
                    <div style="font-size: 11px; font-weight: 600; color: #d97706; margin-bottom: 5px;"> Rule 4: The 50% Rule</div>
                    <div style="font-size: 10px; color: #666;" id="gann50Explanation">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- GANN SQUARE CROSS DETECTION (Rule 5) -->
            <div id="gannSquareCross" style="display: none; background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(109,40,217,0.1)); border: 1px solid rgba(139,92,246,0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 16px; font-weight: 700;"> Gann Square Cross Detected!</div>
                        <div style="font-size: 11px; color: var(--muted);">Rule 5: Price crosses its own square = major reversal</div>
                    </div>
                    <div id="gannCrossType" style="padding: 6px 14px; border-radius: 6px; font-weight: 700; font-size: 12px;">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div id="gannCrossDetails" style="background: white; border-radius: 8px; padding: 15px;">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Signal Confluence Score -->
            <div class="signal-confluence-card">
                <div style="text-align: center;">
                    <h3 style="font-size: 14px; color: var(--muted); margin-bottom: 5px;"> MASTER SIGNAL CONFLUENCE</h3>
                    <div style="font-size: 12px; color: var(--muted);" id="confluenceSymbol">SPY Analysis</div>
                </div>
                <div class="confluence-score bullish" id="masterConfluenceScore">+7.5</div>
                <div style="text-align: center; margin-bottom: 15px;">
                    <span id="confluenceDirection" style="font-size: 18px; font-weight: 700; color: var(--success);">BULLISH BIAS</span>
                    <span style="font-size: 12px; color: var(--muted); margin-left: 10px;">Confidence: <span id="confluenceConfidence">85%</span></span>
                </div>
                
                <div class="signal-breakdown">
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Agent Consensus</span>
                            <span class="signal-item-score bullish" id="agentScore">4/4</span>
                        </div>
                        <div class="signal-item-detail" id="agentDetail">All 4 agents agree: CALL signal</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Bar Count</span>
                            <span class="signal-item-score bullish" id="barCountScore">+12</span>
                        </div>
                        <div class="signal-item-detail" id="barCountDetail">12 consecutive bullish bars</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Pattern Score</span>
                            <span class="signal-item-score bullish" id="patternScore">+3</span>
                        </div>
                        <div class="signal-item-detail" id="patternDetail">Bull flag + Golden cross detected</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Gann Cycle</span>
                            <span class="signal-item-score bullish" id="gannScore">+2</span>
                        </div>
                        <div class="signal-item-detail" id="gannDetail">Time cycle supports upside</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Fibonacci</span>
                            <span class="signal-item-score neutral" id="fibScore">0</span>
                        </div>
                        <div class="signal-item-detail" id="fibDetail">At 50% retracement level</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Volume</span>
                            <span class="signal-item-score bullish" id="volumeScore">+1.5</span>
                        </div>
                        <div class="signal-item-detail" id="volumeDetail">Above average volume confirmed</div>
                    </div>
                </div>
            </div>

            <!-- Trading Plan -->
            <div class="trading-plan" id="tradingPlanContainer">
                <div class="trading-plan-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="font-size: 16px; margin-bottom: 4px;" id="planTitle"> Morning Trading Plan</h3>
                            <div style="font-size: 11px; opacity: 0.9;" id="planDate">Wednesday, November 26, 2025</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 11px; opacity: 0.9;">Generated at</div>
                            <div style="font-weight: 600;" id="planTime">9:35 AM ET</div>
                        </div>
                    </div>
                </div>
                <div class="trading-plan-body">
                    <!-- Top Trade Recommendations -->
                    <div class="plan-section">
                        <div class="plan-section-title"> Top Trade Recommendations</div>
                        <div id="tradeRecommendations">
                            <!-- Symbol with Timeframe and Signal -->
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <span style="font-size: 18px; font-weight: 700;" id="topTradeSymbol">SPY</span>
                                <span style="background: #8b5cf6; color: white; padding: 3px 10px; border-radius: 4px; font-size: 11px;" id="topTradeTimeframe">Daily Timeframe</span>
                                <span class="signal-badge" id="topTradeSignalBadge" style="padding: 5px 15px; border-radius: 6px; font-weight: 700; background: #22c55e; color: white;">BUY SPY CALL</span>
                            </div>
                            <!-- Agent Consensus -->
                            <div id="agentConsensus" style="font-size: 13px; font-weight: 600; margin-bottom: 12px; color: #22c55e;">
                                Consensus: 3/4 agents  CALL
                            </div>
                            <!-- Trade Levels Grid -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                                <div style="background: var(--bg); padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--muted);">Best Entry</div>
                                    <div id="bestEntry" style="font-size: 14px; font-weight: 700; color: var(--primary);">$607.15</div>
                                </div>
                                <div style="background: var(--bg); padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--muted);">Entry Range</div>
                                    <div id="entryRange" style="font-size: 12px; font-weight: 600;">$605.20 - $607.15</div>
                                </div>
                                <div style="background: var(--bg); padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--muted);">Stop Loss</div>
                                    <div id="stopLoss" style="font-size: 14px; font-weight: 700; color: var(--danger);">$597.40</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <div style="background: var(--bg); padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--muted);">Target 1</div>
                                    <div id="target1" style="font-size: 14px; font-weight: 700; color: var(--success);">$610.20</div>
                                </div>
                                <div style="background: var(--bg); padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--muted);">Target 2</div>
                                    <div id="target2" style="font-size: 14px; font-weight: 700; color: var(--success);">$613.40</div>
                                </div>
                                <div style="background: var(--bg); padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 10px; color: var(--muted);">Option Strike</div>
                                    <div id="optionStrike" style="font-size: 14px; font-weight: 700; color: var(--secondary);">$607 CALL</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gann Analysis -->
                    <div class="plan-section">
                        <div class="plan-section-title"> Gann Time Cycles & Square of 9</div>
                        <div class="gann-analysis" id="gannAnalysis">
                            <div class="grid grid-2" style="gap: 20px;">
                                <div>
                                    <h4 style="font-size: 12px; margin-bottom: 10px;"> Time Cycles</h4>
                                    <div style="font-size: 11px; color: var(--muted); line-height: 1.8;" id="gannTimeCycles">
                                         30-day cycle: Bottoming phase<br>
                                         90-day cycle: Mid-cycle thrust<br>
                                         180-day cycle: Bullish continuation<br>
                                         Annual cycle: Q4 strength expected
                                    </div>
                                </div>
                                <div>
                                    <h4 style="font-size: 12px; margin-bottom: 10px;"> Square of 9 Levels</h4>
                                    <div style="font-size: 11px; color: var(--muted); line-height: 1.8;" id="squareOf9">
                                         Resistance 1: <span style="color:var(--danger);font-weight:600;">$685.00</span><br>
                                         Resistance 2: <span style="color:var(--danger);font-weight:600;">$692.50</span><br>
                                         Support 1: <span style="color:var(--success);font-weight:600;">$672.00</span><br>
                                         Support 2: <span style="color:var(--success);font-weight:600;">$665.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Divine Proportions -->
                    <div class="plan-section">
                        <div class="plan-section-title"> Divine Proportions (Phi/Fibonacci)</div>
                        <div class="phi-levels" id="phiLevels">
                            <div class="phi-level">
                                <div class="phi-level-name">23.6% Retrace</div>
                                <div class="phi-level-value" id="phi236">$678.50</div>
                            </div>
                            <div class="phi-level">
                                <div class="phi-level-name">38.2% Retrace</div>
                                <div class="phi-level-value" id="phi382">$675.20</div>
                            </div>
                            <div class="phi-level">
                                <div class="phi-level-name">50% Retrace</div>
                                <div class="phi-level-value" id="phi50">$672.00</div>
                            </div>
                            <div class="phi-level">
                                <div class="phi-level-name">61.8% (Golden)</div>
                                <div class="phi-level-value" id="phi618">$668.80</div>
                            </div>
                            <div class="phi-level">
                                <div class="phi-level-name">78.6% Retrace</div>
                                <div class="phi-level-value" id="phi786">$664.50</div>
                            </div>
                            <div class="phi-level">
                                <div class="phi-level-name">161.8% Ext</div>
                                <div class="phi-level-value" id="phi1618">$695.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- High Consensus Trades -->
                    <div class="plan-section">
                        <div class="plan-section-title"> High Consensus Trades (3/4 or 4/4)</div>
                        <div class="table-wrap">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Signal</th>
                                        <th>Consensus</th>
                                        <th>Confluence</th>
                                        <th>Entry Zone</th>
                                        <th>Stop</th>
                                        <th>Target</th>
                                        <th>Strike</th>
                                    </tr>
                                </thead>
                                <tbody id="highConsensusTable">
                                    <!-- Generated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Market Context -->
                    <div class="plan-section">
                        <div class="plan-section-title"> Market Context</div>
                        <div class="grid grid-3" style="gap: 15px;" id="marketContext">
                            <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 10px; color: var(--muted);">Overall Bias</div>
                                <div style="font-size: 16px; font-weight: 700; color: var(--success);" id="overallBias">BULLISH</div>
                            </div>
                            <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 10px; color: var(--muted);">Sector Leaders</div>
                                <div style="font-size: 12px; font-weight: 600;" id="sectorLeaders">XLK, XLF</div>
                            </div>
                            <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 10px; color: var(--muted);">Risk Level</div>
                                <div style="font-size: 16px; font-weight: 700; color: var(--warning);" id="riskLevel">MODERATE</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Summary -->
                    <div class="plan-section" style="border-bottom: none;">
                        <div class="plan-section-title"> AI Trading Summary</div>
                        <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); padding: 15px; border-radius: 8px; font-size: 12px; line-height: 1.8;" id="aiSummary">
                            <strong>Morning Analysis:</strong> Market conditions favor bullish positions today. SPY showing strong momentum with 4/4 agent consensus. Key levels to watch: Support at $672 (50% Fib), Resistance at $685 (Square of 9). 
                            <br><br>
                            <strong>Recommended Strategy:</strong> Focus on CALL spreads on high-consensus ETFs (SPY, QQQ). Entry on pullbacks to Fibonacci support levels. Time stops align with Gann 30-day cycle completion around Dec 15.
                            <br><br>
                            <strong>Risk Management:</strong> Position size 1-2% per trade. Stop losses below 61.8% Fibonacci level. Take profits at 161.8% extension or when 3+ agents flip to HOLD.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evening Review Section (Hidden by default) -->
            <div id="eveningReviewSection" style="display: none;">
                <div class="trading-plan">
                    <div class="trading-plan-header" style="background: linear-gradient(135deg, #1e3a5f, #2d1b4e);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="font-size: 16px; margin-bottom: 4px;"> Evening Review & Next Day Plan</h3>
                                <div style="font-size: 11px; opacity: 0.9;" id="eveningDate">Wednesday, November 26, 2025</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 11px; opacity: 0.9;">Market Close</div>
                                <div style="font-weight: 600;">4:00 PM ET</div>
                            </div>
                        </div>
                    </div>
                    <div class="trading-plan-body">
                        <!-- Today's Performance -->
                        <div class="plan-section">
                            <div class="plan-section-title"> Today's Performance</div>
                            <div class="grid grid-4" style="gap: 15px;" id="todayPerformance">
                                <div style="background: rgba(16,185,129,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="spyChange">+0.85%</div>
                                    <div style="font-size: 11px; color: var(--muted);">SPY</div>
                                </div>
                                <div style="background: rgba(16,185,129,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="qqqChange">+1.20%</div>
                                    <div style="font-size: 11px; color: var(--muted);">QQQ</div>
                                </div>
                                <div style="background: rgba(239,68,68,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--danger);" id="iwmChange">-0.35%</div>
                                    <div style="font-size: 11px; color: var(--muted);">IWM</div>
                                </div>
                                <div style="background: rgba(16,185,129,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="diaChange">+0.45%</div>
                                    <div style="font-size: 11px; color: var(--muted);">DIA</div>
                                </div>
                            </div>
                        </div>

                        <!-- Signal Accuracy -->
                        <div class="plan-section">
                            <div class="plan-section-title"> Signal Accuracy Review</div>
                            <div id="signalAccuracy" style="font-size: 12px; line-height: 1.8; color: var(--muted);">
                                 Morning CALL signal on SPY:  Correct (+0.85%)<br>
                                 QQQ breakout prediction:  Correct (+1.20%)<br>
                                 IWM neutral signal:  Missed downside<br>
                                 Overall accuracy today: <span style="color: var(--success); font-weight: 700;">75%</span>
                            </div>
                        </div>

                        <!-- Tomorrow's Outlook -->
                        <div class="plan-section">
                            <div class="plan-section-title"> Tomorrow's Outlook</div>
                            <div id="tomorrowOutlook" style="background: var(--bg); padding: 15px; border-radius: 8px; font-size: 12px; line-height: 1.8;">
                                <strong>Key Events:</strong> Pre-Thanksgiving trading, expect lower volume<br>
                                <strong>Bias:</strong> Continuation of bullish momentum likely<br>
                                <strong>Watch List:</strong> SPY for breakout above $685, QQQ tech rotation<br>
                                <strong>Caution:</strong> Holiday-shortened week, reduced liquidity
                            </div>
                        </div>

                        <!-- Next Day Trade Setups -->
                        <div class="plan-section" style="border-bottom: none;">
                            <div class="plan-section-title"> Next Day Trade Setups</div>
                            <div id="nextDaySetups">
                                <!-- Generated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GANN ANALYSIS TAB -->
        <div id="gann-analysis" class="tab-content">
            <!-- Sacred geometry background pattern -->
            <div class="gann-background-pattern"></div>

            <!-- Timeframe Reference Section -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border: 2px solid #e2e8f0;">
                <div style="padding: 15px;">
                    <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 16px;"> TRADING TIMEFRAMES REFERENCE</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #92400e; font-weight: bold;"> INTRADAY</div>
                            <div style="font-size: 16px; font-weight: bold; color: #d97706; margin: 5px 0;">0-3 Days</div>
                            <div style="font-size: 10px; color: #78716c; line-height: 1.4;">
                                <div><strong>Charts:</strong> 5min, 15min, 1hr</div>
                                <div><strong>Expiry:</strong> 0-3 DTE</div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); border: 2px solid #3b82f6; border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #1e40af; font-weight: bold;"> SWING</div>
                            <div style="font-size: 16px; font-weight: bold; color: #2563eb; margin: 5px 0;">3-14 Days</div>
                            <div style="font-size: 10px; color: #475569; line-height: 1.4;">
                                <div><strong>Charts:</strong> 4hr, Daily</div>
                                <div><strong>Expiry:</strong> 7-21 DTE</div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff); border: 2px solid #8b5cf6; border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #6b21a8; font-weight: bold;"> POSITION</div>
                            <div style="font-size: 16px; font-weight: bold; color: #7c3aed; margin: 5px 0;">14-45 Days</div>
                            <div style="font-size: 10px; color: #64748b; line-height: 1.4;">
                                <div><strong>Charts:</strong> Daily, Weekly</div>
                                <div><strong>Expiry:</strong> 30-60 DTE</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gann Header -->
            <div class="card gann-header-card" style="background: linear-gradient(135deg, rgba(212,160,23,0.15), rgba(184,134,11,0.1)); border: 1px solid rgba(212,160,23,0.3); margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <h2 style="font-size: 20px; font-weight: 700; color: #d4a017; margin: 0; display: flex; align-items: center; gap: 10px;">
                             W.D. Gann Master Analysis
                            <span id="gannLastUpdated" class="section-timestamp" style="font-size: 10px; color: var(--muted); font-weight: normal;"> --</span>
                        </h2>
                        <p style="font-size: 11px; color: var(--muted); margin: 4px 0 0 0;">"Time is more important than price" - W.D. Gann</p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="font-size: 12px; color: var(--muted);">Analyzing:</span>
                        <span id="gannCurrentSymbol" style="font-size: 16px; font-weight: 700; color: #d4a017;">SPY</span>
                        <span id="gannSectorName" style="font-size: 11px; color: var(--muted);">(S&P 500 Index)</span>
                        <span id="gannCurrentPrice" style="font-size: 16px; font-weight: 600; color: var(--text);">$---</span>
                        <button onclick="updateGannAnalysis()" style="background: linear-gradient(135deg, #d4a017, #b8860b); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;"> Recalculate</button>
                    </div>
                </div>
            </div>

            <!-- Enhanced Gann Turn Analysis Section -->
            <div class="card" style="background: linear-gradient(135deg, rgba(139,92,246,0.05), rgba(245,158,11,0.05)); border: 2px solid #8b5cf6; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;"></span>
                        <h3 style="margin: 0; color: #8b5cf6;">Gann Turn Analysis - <span id="gannTurnSymbol">SPY</span></h3>
                    </div>
                    <!-- Timeframe Selector -->
                    <div style="display: flex; gap: 8px;">
                        <button id="gannTfIntraday" onclick="updateGannTimeframe('intraday')" class="gann-tf-btn active" style="padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none;">
                             Intraday (0-1 DTE)
                        </button>
                        <button id="gannTfSwing" onclick="updateGannTimeframe('swing')" class="gann-tf-btn" style="padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; background: rgba(139,92,246,0.1); color: #8b5cf6; border: 1px solid rgba(139,92,246,0.3);">
                             Swing (3-14 DTE)
                        </button>
                        <button id="gannTfPosition" onclick="updateGannTimeframe('position')" class="gann-tf-btn" style="padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; background: rgba(139,92,246,0.1); color: #8b5cf6; border: 1px solid rgba(139,92,246,0.3);">
                             Position (30+ DTE)
                        </button>
                    </div>
                </div>

                <!-- Next Turn Info - 4 Column Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: rgba(139,92,246,0.08); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">TIMEFRAME</div>
                        <div style="font-size: 16px; font-weight: 700; color: #8b5cf6;" id="gannActiveTimeframe"> Intraday</div>
                    </div>
                    <div style="background: rgba(245,158,11,0.08); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">NEXT TURN DATE</div>
                        <div style="font-size: 16px; font-weight: 700; color: #f59e0b;" id="gannNextTurnDate">Dec 11, 2025 2:30 PM</div>
                    </div>
                    <div style="background: rgba(59,130,246,0.08); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">DAYS UNTIL TURN</div>
                        <div style="font-size: 16px; font-weight: 700; color: #3b82f6;" id="gannDaysUntil">~5 hours</div>
                    </div>
                    <div style="background: rgba(34,197,94,0.08); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">CYCLE LENGTH</div>
                        <div style="font-size: 16px; font-weight: 700; color: #22c55e;" id="gannCycleLength">90 min cycle</div>
                    </div>
                </div>

                <!-- Predicted Turn Box -->
                <div id="gannPredictionBox" style="background: rgba(239,68,68,0.1); border: 2px solid #ef4444; border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span id="gannTimeframeLabel" style="background: rgba(139,92,246,0.2); color: #8b5cf6; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;"> INTRADAY</span>
                        <span id="gannAnalysisDate" style="font-size: 11px; color: #666;">Analysis: Dec 11, 2025 9:30 AM</span>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">PREDICTED TURN</div>
                    <div style="font-size: 28px; font-weight: 700; color: #ef4444; margin-bottom: 10px;" id="gannPredictedTurn"> PULLBACK (TOP FORMING)</div>
                    <div style="font-size: 14px; color: #666;">TRADE ACTION:</div>
                    <div style="font-size: 20px; font-weight: 700; color: #ef4444;" id="gannTradeAction">BUY PUT</div>
                </div>

                <!-- Why This Direction -->
                <div style="background: rgba(139,92,246,0.08); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="font-size: 14px; font-weight: 600; color: #8b5cf6; margin-bottom: 10px;" id="gannWhyTitle">WHY PULLBACK?</div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--text); line-height: 1.8;" id="gannWhyList">
                        <li>Current trend: <strong>UP</strong> (rallied from $580  $607)</li>
                        <li>At Gann resistance: <strong>$616.90</strong> (90 level)</li>
                        <li>Cycle position: <strong>Day 22/30</strong> (approaching cycle HIGH)</li>
                        <li>Time symmetry: <strong>21 days up</strong> = reversal window</li>
                    </ul>
                </div>

                <!-- Expected Move -->
                <div style="background: rgba(239,68,68,0.1); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="font-size: 14px; font-weight: 600; color: #333; margin-bottom: 10px;">EXPECTED MOVE</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-size: 11px; color: #666;">Turn Target</div>
                            <div style="font-size: 18px; font-weight: 700; color: #ef4444;" id="gannTurnTarget">$595.00 - $602.00</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #666;">Move Size</div>
                            <div style="font-size: 18px; font-weight: 700; color: #ef4444;" id="gannMoveSize">-$10 to -$15 (-1.5% to -2.2%)</div>
                        </div>
                    </div>
                </div>

                <!-- Multi-Timeframe Turn Predictions Summary -->
                <div style="background: rgba(139,92,246,0.05); border: 1px solid rgba(139,92,246,0.2); border-radius: 8px; padding: 15px;">
                    <div style="font-size: 14px; font-weight: 600; color: #8b5cf6; margin-bottom: 15px;"> Multi-Timeframe Turn Predictions</div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: rgba(139,92,246,0.1);">
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid rgba(139,92,246,0.2);">Timeframe</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid rgba(139,92,246,0.2);">Next Turn</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid rgba(139,92,246,0.2);">Prediction</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid rgba(139,92,246,0.2);">Action</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid rgba(139,92,246,0.2);">Confidence</th>
                            </tr>
                        </thead>
                        <tbody id="gannMultiTimeframeBody">
                            <tr style="border-bottom: 1px solid rgba(139,92,246,0.1);">
                                <td style="padding: 10px;">
                                    <span style="background: rgba(245,158,11,0.2); color: #f59e0b; padding: 2px 8px; border-radius: 4px; font-weight: 600;"> Intraday</span>
                                </td>
                                <td style="padding: 10px; text-align: center;">Dec 11, 2:30 PM</td>
                                <td style="padding: 10px; text-align: center;">
                                    <span style="color: #ef4444; font-weight: 600;"> PULLBACK</span>
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    <span style="background: rgba(239,68,68,0.2); color: #ef4444; padding: 2px 8px; border-radius: 4px; font-weight: 600;">BUY PUT</span>
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    <div style="background: rgba(239,68,68,0.2); border-radius: 4px; height: 8px; width: 100%;">
                                        <div style="background: #ef4444; height: 100%; width: 72%; border-radius: 4px;"></div>
                                    </div>
                                    <span style="font-size: 10px; color: #666;">72%</span>
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid rgba(139,92,246,0.1);">
                                <td style="padding: 10px;">
                                    <span style="background: rgba(59,130,246,0.2); color: #3b82f6; padding: 2px 8px; border-radius: 4px; font-weight: 600;"> Swing</span>
                                </td>
                                <td style="padding: 10px; text-align: center;">Dec 21, 2025</td>
                                <td style="padding: 10px; text-align: center;">
                                    <span style="color: #ef4444; font-weight: 600;"> PULLBACK</span>
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    <span style="background: rgba(239,68,68,0.2); color: #ef4444; padding: 2px 8px; border-radius: 4px; font-weight: 600;">BUY PUT</span>
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    <div style="background: rgba(239,68,68,0.2); border-radius: 4px; height: 8px; width: 100%;">
                                        <div style="background: #ef4444; height: 100%; width: 85%; border-radius: 4px;"></div>
                                    </div>
                                    <span style="font-size: 10px; color: #666;">85%</span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 10px;">
                                    <span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 2px 8px; border-radius: 4px; font-weight: 600;"> Position</span>
                                </td>
                                <td style="padding: 10px; text-align: center;">Jan 20, 2026</td>
                                <td style="padding: 10px; text-align: center;">
                                    <span style="color: #22c55e; font-weight: 600;"> RALLY</span>
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    <span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 2px 8px; border-radius: 4px; font-weight: 600;">BUY CALL</span>
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    <div style="background: rgba(34,197,94,0.2); border-radius: 4px; height: 8px; width: 100%;">
                                        <div style="background: #22c55e; height: 100%; width: 68%; border-radius: 4px;"></div>
                                    </div>
                                    <span style="font-size: 10px; color: #666;">68%</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-2" style="gap: 15px;">
                <!-- SECTION 1: Square of 9 Calculator -->
                <div class="card gann-card" style="background: linear-gradient(135deg, rgba(212,160,23,0.08), rgba(0,0,0,0)); border: 1px solid rgba(212,160,23,0.2);">
                    <div class="card-title" style="color: #d4a017; border-bottom: 1px solid rgba(212,160,23,0.2); padding-bottom: 10px; margin-bottom: 15px;">
                         Square of 9 Calculator
                    </div>
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="font-size: 11px; color: var(--muted); display: block; margin-bottom: 4px;">Input Price</label>
                            <input type="number" id="sq9Input" placeholder="Enter price" style="width: 100%; padding: 8px 12px; border: 1px solid rgba(212,160,23,0.3); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 14px;" onchange="updateSquareOf9()">
                        </div>
                        <button onclick="autoFillSq9Price()" style="background: rgba(212,160,23,0.2); color: #d4a017; border: 1px solid rgba(212,160,23,0.3); padding: 8px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; align-self: flex-end;">Use Current</button>
                    </div>

                    <!-- Visual Square of 9 Spiral -->
                    <div id="sq9Visual" style="position: relative; width: 100%; height: 200px; background: radial-gradient(circle, rgba(212,160,23,0.1) 0%, transparent 70%); border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center;">
                        <div id="sq9Spiral" style="font-size: 11px; text-align: center; color: var(--muted);">
                            Enter price to generate Square of 9
                        </div>
                    </div>

                    <!-- Support & Resistance Levels -->
                    <div class="grid grid-2" style="gap: 10px;">
                        <div style="background: rgba(34,197,94,0.1); border-radius: 8px; padding: 10px;">
                            <h4 style="font-size: 11px; color: #22c55e; margin-bottom: 8px; font-weight: 600;"> SUPPORT LEVELS</h4>
                            <div id="sq9Support" style="font-size: 10px; line-height: 1.6;">
                                <div style="display: flex; justify-content: space-between;"><span>-45:</span><span style="color: #22c55e; font-weight: 600;">$602.15</span></div>
                                <div style="display: flex; justify-content: space-between;"><span>-90:</span><span style="color: #22c55e; font-weight: 600;">$597.28</span></div>
                                <div style="display: flex; justify-content: space-between;"><span>-180:</span><span style="color: #22c55e; font-weight: 600;">$587.54</span></div>
                                <div style="display: flex; justify-content: space-between;"><span>-360:</span><span style="color: #22c55e; font-weight: 600;">$568.06</span></div>
                            </div>
                        </div>
                        <div style="background: rgba(239,68,68,0.1); border-radius: 8px; padding: 10px;">
                            <h4 style="font-size: 11px; color: #ef4444; margin-bottom: 8px; font-weight: 600;"> RESISTANCE LEVELS</h4>
                            <div id="sq9Resistance" style="font-size: 10px; line-height: 1.6;">
                                <div style="display: flex; justify-content: space-between;"><span>+45:</span><span style="color: #ef4444; font-weight: 600;">$612.03</span></div>
                                <div style="display: flex; justify-content: space-between;"><span>+90:</span><span style="color: #ef4444; font-weight: 600;">$616.90</span></div>
                                <div style="display: flex; justify-content: space-between;"><span>+180:</span><span style="color: #ef4444; font-weight: 600;">$626.64</span></div>
                                <div style="display: flex; justify-content: space-between;"><span>+360:</span><span style="color: #ef4444; font-weight: 600;">$646.12</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: Gann Time Cycles -->
                <div class="card gann-card" style="background: linear-gradient(135deg, rgba(212,160,23,0.08), rgba(0,0,0,0)); border: 1px solid rgba(212,160,23,0.2);">
                    <div class="card-title" style="color: #d4a017; border-bottom: 1px solid rgba(212,160,23,0.2); padding-bottom: 10px; margin-bottom: 15px;">
                         Gann Time Cycles
                    </div>

                    <!-- Cycle Turn Alert -->
                    <div id="cycleAlert" style="display: none; background: rgba(245,158,11,0.2); border: 1px solid #f59e0b; border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: center;">
                        <span style="font-size: 14px;"></span>
                        <span style="font-size: 12px; font-weight: 600; color: #f59e0b;"> CYCLE TURN ZONE - High probability reversal window!</span>
                    </div>

                    <!-- Important Gann Dates -->
                    <div style="background: rgba(139,92,246,0.1); border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                        <h4 style="font-size: 11px; color: #8b5cf6; margin-bottom: 8px;"> Sacred Calendar Dates</h4>
                        <div id="gannDates" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; font-size: 10px;">
                            <div style="background: rgba(139,92,246,0.15); padding: 6px 8px; border-radius: 4px;"><span style="color: var(--muted);">Winter Solstice:</span> <span style="color: #8b5cf6; font-weight: 600;">Dec 21</span></div>
                            <div style="background: rgba(139,92,246,0.15); padding: 6px 8px; border-radius: 4px;"><span style="color: var(--muted);">Spring Equinox:</span> <span style="color: #8b5cf6; font-weight: 600;">Mar 20</span></div>
                            <div style="background: rgba(139,92,246,0.15); padding: 6px 8px; border-radius: 4px;"><span style="color: var(--muted);">Summer Solstice:</span> <span style="color: #8b5cf6; font-weight: 600;">Jun 21</span></div>
                            <div style="background: rgba(139,92,246,0.15); padding: 6px 8px; border-radius: 4px;"><span style="color: var(--muted);">Fall Equinox:</span> <span style="color: #8b5cf6; font-weight: 600;">Sep 22</span></div>
                        </div>
                    </div>

                    <!-- Cycle Progress Bars -->
                    <div id="cycleProgress" style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="background: var(--bg); border-radius: 6px; padding: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 10px;">
                                <span style="color: var(--muted);">7-Day Cycle</span>
                                <span style="color: #22c55e; font-weight: 600;">Day 3 of 7</span>
                            </div>
                            <div style="background: var(--border); border-radius: 4px; height: 6px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #22c55e, #10b981); height: 100%; width: 43%; border-radius: 4px;"></div>
                            </div>
                        </div>
                        <div style="background: var(--bg); border-radius: 6px; padding: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 10px;">
                                <span style="color: var(--muted);">30-Day Cycle</span>
                                <span style="color: #f59e0b; font-weight: 600;">Day 22 of 30</span>
                            </div>
                            <div style="background: var(--border); border-radius: 4px; height: 6px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #f59e0b, #eab308); height: 100%; width: 73%; border-radius: 4px;"></div>
                            </div>
                        </div>
                        <div style="background: var(--bg); border-radius: 6px; padding: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 10px;">
                                <span style="color: var(--muted);">90-Day Cycle</span>
                                <span style="color: #3b82f6; font-weight: 600;">Day 68 of 90</span>
                            </div>
                            <div style="background: var(--border); border-radius: 4px; height: 6px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #3b82f6, #6366f1); height: 100%; width: 76%; border-radius: 4px;"></div>
                            </div>
                        </div>
                        <div style="background: var(--bg); border-radius: 6px; padding: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 10px;">
                                <span style="color: var(--muted);">Annual Cycle</span>
                                <span style="color: #8b5cf6; font-weight: 600;">Day 345 of 365</span>
                            </div>
                            <div style="background: var(--border); border-radius: 4px; height: 6px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #8b5cf6, #a855f7); height: 100%; width: 95%; border-radius: 4px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-2" style="gap: 15px; margin-top: 15px;">
                <!-- SECTION 3: Gann Angles -->
                <div class="card gann-card" style="background: linear-gradient(135deg, rgba(212,160,23,0.08), rgba(0,0,0,0)); border: 1px solid rgba(212,160,23,0.2);">
                    <div class="card-title" style="color: #d4a017; border-bottom: 1px solid rgba(212,160,23,0.2); padding-bottom: 10px; margin-bottom: 15px;">
                         Gann Angles from Pivot
                    </div>

                    <!-- Pivot Detection -->
                    <div class="grid grid-2" style="gap: 10px; margin-bottom: 15px;">
                        <div style="background: rgba(34,197,94,0.1); border-radius: 8px; padding: 10px;">
                            <div style="font-size: 10px; color: var(--muted);">Last Significant Low</div>
                            <div id="gannPivotLow" style="font-size: 14px; font-weight: 600; color: #22c55e;">$479.05 (Oct 27)</div>
                        </div>
                        <div style="background: rgba(239,68,68,0.1); border-radius: 8px; padding: 10px;">
                            <div style="font-size: 10px; color: var(--muted);">Last Significant High</div>
                            <div id="gannPivotHigh" style="font-size: 14px; font-weight: 600; color: #ef4444;">$609.07 (Dec 6)</div>
                        </div>
                    </div>

                    <!-- Angles from Low -->
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-size: 11px; color: #22c55e; margin-bottom: 8px;"> Angles from Low (Bullish)</h4>
                        <div id="anglesFromLow" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; font-size: 10px;">
                            <div style="background: rgba(34,197,94,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">1x1</div><div style="color: #22c55e; font-weight: 600;">$523.05</div></div>
                            <div style="background: rgba(34,197,94,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">2x1</div><div style="color: #22c55e; font-weight: 600;">$567.05</div></div>
                            <div style="background: rgba(34,197,94,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">4x1</div><div style="color: #22c55e; font-weight: 600;">$655.05</div></div>
                            <div style="background: rgba(34,197,94,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">1x2</div><div style="color: #22c55e; font-weight: 600;">$501.05</div></div>
                            <div style="background: rgba(34,197,94,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">1x4</div><div style="color: #22c55e; font-weight: 600;">$490.05</div></div>
                            <div style="background: rgba(34,197,94,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">8x1</div><div style="color: #22c55e; font-weight: 600;">$831.05</div></div>
                        </div>
                    </div>

                    <!-- Angles from High -->
                    <div>
                        <h4 style="font-size: 11px; color: #ef4444; margin-bottom: 8px;"> Angles from High (Bearish)</h4>
                        <div id="anglesFromHigh" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; font-size: 10px;">
                            <div style="background: rgba(239,68,68,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">1x1</div><div style="color: #ef4444; font-weight: 600;">$605.07</div></div>
                            <div style="background: rgba(239,68,68,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">2x1</div><div style="color: #ef4444; font-weight: 600;">$601.07</div></div>
                            <div style="background: rgba(239,68,68,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">4x1</div><div style="color: #ef4444; font-weight: 600;">$593.07</div></div>
                            <div style="background: rgba(239,68,68,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">1x2</div><div style="color: #ef4444; font-weight: 600;">$607.07</div></div>
                            <div style="background: rgba(239,68,68,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">1x4</div><div style="color: #ef4444; font-weight: 600;">$608.07</div></div>
                            <div style="background: rgba(239,68,68,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">8x1</div><div style="color: #ef4444; font-weight: 600;">$577.07</div></div>
                        </div>
                    </div>

                    <!-- Current Position -->
                    <div id="gannAnglePosition" style="background: rgba(212,160,23,0.15); border-radius: 8px; padding: 12px; margin-top: 15px; text-align: center;">
                        <span style="font-size: 12px; color: var(--muted);">Current Position: </span>
                        <span id="anglePositionText" style="font-size: 12px; font-weight: 600; color: #d4a017;">Above 2x1 from Low - Strong Bullish</span>
                    </div>
                </div>

                <!-- SECTION 4: Sacred Numbers -->
                <div class="card gann-card" style="background: linear-gradient(135deg, rgba(212,160,23,0.08), rgba(0,0,0,0)); border: 1px solid rgba(212,160,23,0.2);">
                    <div class="card-title" style="color: #d4a017; border-bottom: 1px solid rgba(212,160,23,0.2); padding-bottom: 10px; margin-bottom: 15px;">
                         Sacred Numbers & Proportions
                    </div>

                    <!-- Cardinal Numbers -->
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-size: 11px; color: #8b5cf6; margin-bottom: 8px;">Cardinal Numbers (Degrees)</h4>
                        <div id="cardinalNumbers" class="grid grid-4" style="gap: 6px;">
                            <div style="background: rgba(139,92,246,0.15); padding: 8px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">90</div><div style="color: #8b5cf6; font-weight: 600; font-size: 12px;">$597.28</div></div>
                            <div style="background: rgba(139,92,246,0.15); padding: 8px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">180</div><div style="color: #8b5cf6; font-weight: 600; font-size: 12px;">$587.54</div></div>
                            <div style="background: rgba(139,92,246,0.15); padding: 8px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">270</div><div style="color: #8b5cf6; font-weight: 600; font-size: 12px;">$577.80</div></div>
                            <div style="background: rgba(139,92,246,0.15); padding: 8px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">360</div><div style="color: #8b5cf6; font-weight: 600; font-size: 12px;">$568.06</div></div>
                        </div>
                    </div>

                    <!-- Sacred Numbers -->
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-size: 11px; color: #f59e0b; margin-bottom: 8px;">Sacred Numbers</h4>
                        <div id="sacredNumbers" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px;">
                            <div style="background: rgba(245,158,11,0.15); padding: 6px 4px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">7</div><div style="color: #f59e0b; font-weight: 600; font-size: 11px;">$614.09</div></div>
                            <div style="background: rgba(245,158,11,0.15); padding: 6px 4px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">9</div><div style="color: #f59e0b; font-weight: 600; font-size: 11px;">$616.09</div></div>
                            <div style="background: rgba(245,158,11,0.15); padding: 6px 4px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">12</div><div style="color: #f59e0b; font-weight: 600; font-size: 11px;">$619.09</div></div>
                            <div style="background: rgba(245,158,11,0.15); padding: 6px 4px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">52</div><div style="color: #f59e0b; font-weight: 600; font-size: 11px;">$659.09</div></div>
                            <div style="background: rgba(245,158,11,0.15); padding: 6px 4px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">144</div><div style="color: #f59e0b; font-weight: 600; font-size: 11px;">$751.09</div></div>
                        </div>
                    </div>

                    <!-- Price Relationships -->
                    <div style="background: rgba(59,130,246,0.1); border-radius: 8px; padding: 12px;">
                        <h4 style="font-size: 11px; color: #3b82f6; margin-bottom: 10px;">Price Mathematical Relationships</h4>
                        <div id="priceRelationships" class="grid grid-2" style="gap: 8px; font-size: 11px;">
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--muted);">Price:</span><span style="color: #3b82f6; font-weight: 600;">24.68</span></div>
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--muted);">Price:</span><span style="color: #3b82f6; font-weight: 600;">371,121</span></div>
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--muted);">Price  9:</span><span style="color: #3b82f6; font-weight: 600;">$67.68</span></div>
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--muted);">Price  9:</span><span style="color: #3b82f6; font-weight: 600;">$5,481.63</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 5 & 6: Confluence & Forecast (Full Width) -->
            <div class="grid grid-2" style="gap: 15px; margin-top: 15px;">
                <!-- SECTION 5: Master Confluence -->
                <div class="card gann-card gann-confluence-card" style="background: linear-gradient(135deg, rgba(212,160,23,0.12), rgba(139,92,246,0.08)); border: 1px solid rgba(212,160,23,0.3);">
                    <div class="card-title" style="color: #d4a017; border-bottom: 1px solid rgba(212,160,23,0.2); padding-bottom: 10px; margin-bottom: 15px;">
                         Master Time & Price Confluence
                    </div>

                    <!-- Confluence Score Display -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="position: relative; width: 120px; height: 120px; margin: 0 auto;">
                            <svg viewBox="0 0 120 120" style="transform: rotate(-90deg);">
                                <circle cx="60" cy="60" r="50" fill="none" stroke="var(--border)" stroke-width="10"/>
                                <circle id="confluenceRing" cx="60" cy="60" r="50" fill="none" stroke="#22c55e" stroke-width="10" stroke-dasharray="314" stroke-dashoffset="79" style="transition: stroke-dashoffset 1s ease;"/>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div id="confluenceScore" style="font-size: 28px; font-weight: 700; color: #22c55e;">75</div>
                                <div style="font-size: 10px; color: var(--muted);">/ 100</div>
                            </div>
                        </div>
                        <div id="confluenceLabel" style="font-size: 14px; font-weight: 600; color: #22c55e; margin-top: 10px;">Strong Bullish Confluence</div>
                    </div>

                    <!-- Confluence Factors -->
                    <div id="confluenceFactors" style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(34,197,94,0.1); padding: 8px 10px; border-radius: 6px; font-size: 11px;">
                            <span style="color: var(--text);">Price above 2x1 Gann Angle</span>
                            <span style="color: #22c55e; font-weight: 600;">+20 pts</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(34,197,94,0.1); padding: 8px 10px; border-radius: 6px; font-size: 11px;">
                            <span style="color: var(--text);">Near Sq9 +90 Resistance</span>
                            <span style="color: #22c55e; font-weight: 600;">+15 pts</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(34,197,94,0.1); padding: 8px 10px; border-radius: 6px; font-size: 11px;">
                            <span style="color: var(--text);">30-Day Cycle Maturing</span>
                            <span style="color: #22c55e; font-weight: 600;">+15 pts</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(34,197,94,0.1); padding: 8px 10px; border-radius: 6px; font-size: 11px;">
                            <span style="color: var(--text);">Winter Solstice Approaching</span>
                            <span style="color: #22c55e; font-weight: 600;">+15 pts</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(139,92,246,0.1); padding: 8px 10px; border-radius: 6px; font-size: 11px;">
                            <span style="color: var(--text);">Annual Cycle Near Completion</span>
                            <span style="color: #8b5cf6; font-weight: 600;">+10 pts</span>
                        </div>
                    </div>
                </div>

                <!-- SECTION 6: Gann Forecast -->
                <div class="card gann-card gann-forecast-card" style="background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(212,160,23,0.08)); border: 1px solid rgba(212,160,23,0.3);">
                    <div class="card-title" style="color: #d4a017; border-bottom: 1px solid rgba(212,160,23,0.2); padding-bottom: 10px; margin-bottom: 15px;">
                         Gann Forecast
                    </div>

                    <!-- Direction Bias -->
                    <div id="gannBias" style="text-align: center; padding: 15px; background: rgba(34,197,94,0.15); border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;">GANN DIRECTIONAL BIAS</div>
                        <div id="gannBiasText" style="font-size: 20px; font-weight: 700; color: #22c55e;">BULLISH</div>
                    </div>

                    <!-- Key Levels -->
                    <div class="grid grid-2" style="gap: 10px; margin-bottom: 15px;">
                        <div style="background: rgba(34,197,94,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 10px; color: var(--muted);">Next Support (Sq9)</div>
                            <div id="forecastSupport" style="font-size: 16px; font-weight: 600; color: #22c55e;">$602.15</div>
                        </div>
                        <div style="background: rgba(239,68,68,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 10px; color: var(--muted);">Next Resistance (Sq9)</div>
                            <div id="forecastResistance" style="font-size: 16px; font-weight: 600; color: #ef4444;">$616.90</div>
                        </div>
                    </div>

                    <!-- Cycle Turn -->
                    <div style="background: rgba(139,92,246,0.1); border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                        <div class="grid grid-2" style="gap: 10px;">
                            <div>
                                <div style="font-size: 10px; color: var(--muted);">Next Cycle Turn</div>
                                <div id="forecastCycleDate" style="font-size: 14px; font-weight: 600; color: #8b5cf6;">Dec 21, 2025</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; color: var(--muted);">Days Until</div>
                                <div id="forecastDaysUntil" style="font-size: 14px; font-weight: 600; color: #8b5cf6;">11 days</div>
                            </div>
                        </div>
                    </div>

                    <!-- Projected Move -->
                    <div id="projectedMove" style="background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05)); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;">PROJECTED MOVE</div>
                        <div id="projectedMoveText" style="font-size: 14px; font-weight: 600; color: #22c55e;">Expect +$9.81 move within 7 days to $616.90</div>
                    </div>
                </div>
            </div>

            <!-- Gann Wisdom Quote -->
            <div class="card" style="background: linear-gradient(135deg, rgba(212,160,23,0.05), transparent); border: 1px solid rgba(212,160,23,0.15); margin-top: 15px; text-align: center; padding: 15px;">
                <div id="gannQuote" style="font-style: italic; color: var(--muted); font-size: 12px;">
                    "The future is but a repetition of the past." - W.D. Gann
                </div>
            </div>

        </div>


        <!-- MARKET ANALYSIS TAB -->
        <div id="market-analysis" class="tab-content">
            <!-- Market Analysis Header -->
            <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(220,38,38,0.15)); border-radius: 12px; border: 2px solid #ef4444;">
                <h2 style="margin: 0; color: #dc2626; font-size: 24px;"> Market Conditions Analysis</h2>
                <p style="margin: 5px 0 0 0; color: #991b1b; font-size: 12px;">Trend-Following Approach Based on Moving Averages, Breadth and Volatility</p>
                <div style="margin-top: 12px;">
                    <span style="font-size: 12px; color: #666; margin-right: 8px;">Analyzing:</span>
                    <span id="mktConditionsCurrentSymbol" style="padding: 6px 14px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border-radius: 6px; font-size: 14px; font-weight: 700;">SPY</span>
                    <span style="font-size: 10px; color: #999; margin-left: 8px;">(Uses global symbol)</span>
                </div>
            </div>

            <!-- Market Conditions Dashboard -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-title"> Market Conditions Dashboard</div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <!-- VIX -->
                    <div style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(139,92,246,0.2)); border-radius: 10px; padding: 20px; text-align: center; border: 1px solid rgba(139,92,246,0.3);">
                        <div style="font-size: 11px; color: #7c3aed; font-weight: 600;">VIX LEVEL</div>
                        <div id="mktVixValue" style="font-size: 32px; font-weight: 800; color: #7c3aed;">--</div>
                        <div id="mktVixStatus" style="font-size: 12px; color: #22c55e; font-weight: 600;">Loading...</div>
                        <div id="mktVix20MA" style="font-size: 10px; color: #666; margin-top: 5px;">20MA: --</div>
                    </div>
                    <!-- SPY Trend -->
                    <div style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.2)); border-radius: 10px; padding: 20px; text-align: center; border: 1px solid rgba(59,130,246,0.3);">
                        <div id="mktSymbolLabel" style="font-size: 11px; color: #2563eb; font-weight: 600;">SPY vs 20MA</div>
                        <div id="mktSpyTrend" style="font-size: 28px; font-weight: 800; color: #666;">--</div>
                        <div id="mktSpyTrendStatus" style="font-size: 12px; color: #666; font-weight: 600;">Loading...</div>
                        <div id="mktSpy20MA" style="font-size: 10px; color: #666; margin-top: 5px;">20MA: --</div>
                    </div>
                    <!-- Breadth -->
                    <div style="background: linear-gradient(135deg, rgba(234,179,8,0.1), rgba(234,179,8,0.2)); border-radius: 10px; padding: 20px; text-align: center; border: 1px solid rgba(234,179,8,0.3);">
                        <div style="font-size: 11px; color: #ca8a04; font-weight: 600;">MARKET BREADTH</div>
                        <div id="mktBreadthValue" style="font-size: 32px; font-weight: 800; color: #666;">--%</div>
                        <div id="mktBreadthStatus" style="font-size: 12px; color: #666; font-weight: 600;">Loading...</div>
                        <div id="mktBreadthCount" style="font-size: 10px; color: #666; margin-top: 5px;">--/-- above 20MA</div>
                    </div>
                    <!-- Overall -->
                    <div id="mktOverallBox" style="background: linear-gradient(135deg, rgba(107,114,128,0.1), rgba(107,114,128,0.2)); border-radius: 10px; padding: 20px; text-align: center; border: 2px solid #6b7280;">
                        <div style="font-size: 11px; color: #374151; font-weight: 600;">OVERALL</div>
                        <div id="mktOverallValue" style="font-size: 24px; font-weight: 800; color: #374151;">LOADING</div>
                        <div id="mktOverallScore" style="font-size: 14px; color: #666; font-weight: 600;">--/3</div>
                        <div id="mktOverallAdvice" style="font-size: 10px; color: #666; margin-top: 5px;">...</div>
                    </div>
                </div>
            </div>

            <!-- Market Directional Bias -->
            <div class="card" style="margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                    <div id="mktBiasBox" style="background: linear-gradient(135deg, rgba(107,114,128,0.15), rgba(107,114,128,0.25)); border-radius: 12px; padding: 25px; text-align: center; border: 2px solid #6b7280;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">MARKET DIRECTIONAL BIAS</div>
                        <div id="mktBiasText" style="font-size: 36px; font-weight: 800; color: #374151;">NEUTRAL</div>
                    </div>
                    <div style="padding: 15px;">
                        <div style="font-size: 14px; font-weight: 600; color: #333; margin-bottom: 10px;"> Market Analysis Summary</div>
                        <div id="mktAnalysisSummary" style="font-size: 12px; color: #666; line-height: 1.8;">
                            <div>Loading market conditions...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIX Analysis -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-title"> VIX Volatility Analysis</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #666;">Current</div>
                                <div id="mktVixCurrent" style="font-size: 20px; font-weight: 700; color: #7c3aed;">--</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #666;">20-Day Avg</div>
                                <div id="mktVixAvg" style="font-size: 20px; font-weight: 700; color: #666;">--</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #666;">% vs Avg</div>
                                <div id="mktVixVsAvg" style="font-size: 20px; font-weight: 700; color: #666;">--%</div>
                            </div>
                        </div>
                        <div id="mktVixInterpretation" style="padding: 15px; background: rgba(139,92,246,0.1); border-radius: 8px; font-size: 12px; color: #5b21b6; line-height: 1.6;">
                            <strong>Interpretation:</strong> Loading VIX analysis...
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 12px; font-weight: 600; color: #333; margin-bottom: 10px;">VIX Level Guide</div>
                        <div style="font-size: 11px; line-height: 2.0;">
                            <div style="padding: 8px; background: rgba(34,197,94,0.1); border-radius: 4px; margin-bottom: 4px;">
                                <span style="color: #22c55e; font-weight: 600;">Below 12:</span> Extreme complacency - expect volatility spike
                            </div>
                            <div style="padding: 8px; background: rgba(34,197,94,0.1); border-radius: 4px; margin-bottom: 4px;">
                                <span style="color: #22c55e; font-weight: 600;">12-16:</span> Low vol - favor selling premium strategies
                            </div>
                            <div style="padding: 8px; background: rgba(234,179,8,0.1); border-radius: 4px; margin-bottom: 4px;">
                                <span style="color: #eab308; font-weight: 600;">16-20:</span> Normal volatility - standard trading
                            </div>
                            <div style="padding: 8px; background: rgba(249,115,22,0.1); border-radius: 4px; margin-bottom: 4px;">
                                <span style="color: #f97316; font-weight: 600;">20-25:</span> Elevated fear - use caution, wider stops
                            </div>
                            <div style="padding: 8px; background: rgba(239,68,68,0.1); border-radius: 4px;">
                                <span style="color: #ef4444; font-weight: 600;">Above 25:</span> High fear - contrarian buy opportunities
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Breadth Analysis -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-title"> Market Breadth Analysis</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div style="font-size: 13px; font-weight: 600; color: #22c55e; margin-bottom: 10px;"> Above 20MA (Bullish)</div>
                        <div id="mktBreadthAbove" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span style="padding: 6px 12px; background: rgba(107,114,128,0.15); color: #666; border-radius: 6px; font-size: 11px;">Loading...</span>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 13px; font-weight: 600; color: #ef4444; margin-bottom: 10px;"> Below 20MA (Bearish)</div>
                        <div id="mktBreadthBelow" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span style="padding: 6px 12px; background: rgba(107,114,128,0.15); color: #666; border-radius: 6px; font-size: 11px;">Loading...</span>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 12px; color: #666;">
                        <strong>Breadth Interpretation:</strong> When fewer than 50% of sectors are above their 20MA, the market rally is narrow and vulnerable. Current breadth at <span id="mktBreadthPct" style="color: #666; font-weight: 600;">--%</span> - favor defensive positioning when below 50%.
                    </div>
                </div>
            </div>

            <!-- Moving Average Levels -->
            <div class="card">
                <div class="card-title" id="mktMATitle"> SPY Moving Average Levels</div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: #666;">Current Price</div>
                        <div id="mktSpyPrice" style="font-size: 22px; font-weight: 700; color: #333;">$--</div>
                    </div>
                    <div style="background: rgba(59,130,246,0.1); padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #3b82f6;">
                        <div style="font-size: 10px; color: #2563eb;">20 MA (Key Level)</div>
                        <div id="mktSpy20MALevel" style="font-size: 22px; font-weight: 700; color: #2563eb;">$--</div>
                        <div id="mktSpy20MADist" style="font-size: 10px; color: #666;">--% from price</div>
                    </div>
                    <div style="background: rgba(234,179,8,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: #ca8a04;">50 MA</div>
                        <div id="mktSpy50MALevel" style="font-size: 22px; font-weight: 700; color: #ca8a04;">$--</div>
                        <div id="mktSpy50MADist" style="font-size: 10px; color: #666;">--% from price</div>
                    </div>
                    <div style="background: rgba(139,92,246,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: #7c3aed;">200 MA</div>
                        <div id="mktSpy200MALevel" style="font-size: 22px; font-weight: 700; color: #7c3aed;">$--</div>
                        <div id="mktSpy200MADist" style="font-size: 10px; color: #666;">--% from price</div>
                    </div>
                </div>
                <div style="padding: 12px; background: rgba(59,130,246,0.1); border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <div id="mkt20MARule" style="font-size: 12px; color: #1e40af;">
                        <strong>20MA Rule:</strong> When <span id="mkt20MASymbol">SPY</span> is ABOVE 20MA = favor CALLS. When <span id="mkt20MASymbol2">SPY</span> is BELOW 20MA = favor PUTS. The 20MA acts as dynamic support/resistance.
                    </div>
                </div>
            </div>
        </div>

        <!-- PERFORMANCE TRACKER TAB -->
        <div id="performance-tracker" class="tab-content">
            <!-- Header with Last Updated -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(124,58,237,0.15)); border-radius: 12px; border: 2px solid #8b5cf6;">
                <div>
                    <h2 style="margin: 0; color: #7c3aed; font-size: 24px;"> Prediction Performance Tracker</h2>
                    <p style="margin: 5px 0 0 0; color: #6d28d9; font-size: 12px;">Compare Gann Analysis vs Market Conditions Accuracy</p>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span id="predictionsLastUpdated" style="font-size: 11px; color: #7c3aed; padding: 4px 10px; background: rgba(139,92,246,0.1); border-radius: 6px;">
                        Updated: --
                    </span>
                    <button onclick="refreshPredictionsTab()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #8b5cf6; background: transparent; color: #8b5cf6; cursor: pointer; font-size: 11px;">
                         Refresh
                    </button>
                </div>
            </div>

            <!-- Backtest Summary Cards -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-title"> Historical Backtest Results (SPY)</div>
                <div id="backtestPeriod" style="font-size: 11px; color: #666; margin-bottom: 15px;">Analyzing last 252 trading days...</div>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
                    <!-- Gann Performance -->
                    <div style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(139,92,246,0.2)); border-radius: 10px; padding: 20px; text-align: center; border: 2px solid #8b5cf6;">
                        <div style="font-size: 11px; color: #7c3aed; font-weight: 600;"> GANN ANALYSIS</div>
                        <div id="btGannWinRate" style="font-size: 36px; font-weight: 800; color: #7c3aed;">---%</div>
                        <div id="btGannRecord" style="font-size: 12px; color: #666;">-/- trades</div>
                        <div id="btGannAvgReturn" style="font-size: 10px; color: #22c55e; margin-top: 5px;">Avg: +0.0%</div>
                    </div>
                    <!-- Market Performance -->
                    <div style="background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(239,68,68,0.2)); border-radius: 10px; padding: 20px; text-align: center; border: 2px solid #ef4444;">
                        <div style="font-size: 11px; color: #dc2626; font-weight: 600;"> MARKET CONDITIONS</div>
                        <div id="btMktWinRate" style="font-size: 36px; font-weight: 800; color: #ef4444;">---%</div>
                        <div id="btMktRecord" style="font-size: 12px; color: #666;">-/- trades</div>
                        <div id="btMktAvgReturn" style="font-size: 10px; color: #22c55e; margin-top: 5px;">Avg: +0.0%</div>
                    </div>
                    <!-- SQ9 Performance -->
                    <div style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.2)); border-radius: 10px; padding: 20px; text-align: center; border: 2px solid #3b82f6;">
                        <div style="font-size: 11px; color: #2563eb; font-weight: 600;"> SQ9 LEVELS</div>
                        <div id="btSq9WinRate" style="font-size: 36px; font-weight: 800; color: #3b82f6;">---%</div>
                        <div id="btSq9Record" style="font-size: 12px; color: #666;">-/- trades</div>
                        <div id="btSq9AvgReturn" style="font-size: 10px; color: #22c55e; margin-top: 5px;">Avg: +0.0%</div>
                    </div>
                    <!-- Aligned Performance -->
                    <div style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(34,197,94,0.2)); border-radius: 10px; padding: 20px; text-align: center; border: 2px solid #22c55e;">
                        <div style="font-size: 11px; color: #16a34a; font-weight: 600;"> WHEN ALIGNED</div>
                        <div id="btAlignedWinRate" style="font-size: 36px; font-weight: 800; color: #22c55e;">---%</div>
                        <div id="btAlignedRecord" style="font-size: 12px; color: #666;">-/- trades</div>
                        <div id="btAlignedAvgReturn" style="font-size: 10px; color: #22c55e; margin-top: 5px;">Avg: +0.0%</div>
                    </div>
                    <!-- Conflict Performance -->
                    <div style="background: linear-gradient(135deg, rgba(234,179,8,0.1), rgba(234,179,8,0.2)); border-radius: 10px; padding: 20px; text-align: center; border: 2px solid #eab308;">
                        <div style="font-size: 11px; color: #ca8a04; font-weight: 600;"> WHEN CONFLICT</div>
                        <div id="btConflictGann" style="font-size: 14px; font-weight: 700; color: #7c3aed;">Gann: ---%</div>
                        <div id="btConflictMkt" style="font-size: 14px; font-weight: 700; color: #ef4444;">Mkt: ---%</div>
                        <div id="btConflictCount" style="font-size: 10px; color: #666; margin-top: 5px;">- conflict days</div>
                    </div>
                </div>
            </div>

            <!-- Backtest Details -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-title"> Backtest Methodology & Insights</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div style="font-size: 12px; font-weight: 600; color: #333; margin-bottom: 10px;">How Predictions Are Scored:</div>
                        <div style="font-size: 11px; color: #666; line-height: 1.8;">
                            <div style="padding: 8px; background: rgba(139,92,246,0.1); border-radius: 4px; margin-bottom: 6px;">
                                <strong> Gann:</strong> CALL if price in bottom 35% of 20-day range, PUT if top 35%
                            </div>
                            <div style="padding: 8px; background: rgba(239,68,68,0.1); border-radius: 4px; margin-bottom: 6px;">
                                <strong> Market:</strong> CALL if price > 20MA, PUT if price < 20MA
                            </div>
                            <div style="padding: 8px; background: rgba(59,130,246,0.1); border-radius: 4px; margin-bottom: 6px;">
                                <strong> SQ9:</strong> CALL at support (within 3%), PUT at resistance (within 3%)
                            </div>
                            <div style="padding: 8px; background: rgba(34,197,94,0.1); border-radius: 4px;">
                                <strong> Correct:</strong> If next-day move matches prediction direction
                            </div>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 12px; font-weight: 600; color: #333; margin-bottom: 10px;">Key Insights:</div>
                        <div id="btInsights" style="font-size: 11px; color: #666; line-height: 1.8;">
                            <div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin-bottom: 6px;">
                                 Loading insights...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prediction Log Controls -->
            <div class="card" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="card-title" style="margin: 0;"> Daily Prediction Log</div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="saveTodaysPrediction()" style="padding: 8px 16px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;"> Save Today's Predictions</button>
                        <button onclick="verifyPastPredictions()" style="padding: 8px 16px; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;"> Verify Past Predictions</button>
                        <button onclick="clearPredictionLog()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;"> Clear Log</button>
                        <button onclick="debugPredictionData()" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;"> Debug Data</button>
                        <button onclick="backfillPredictions('2025-11-01')" style="padding: 8px 16px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;"> Nov 2025</button>
                        <button onclick="backfillPredictions('2023-01-03')" style="padding: 8px 16px; background: #7c3aed; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;"> Full 2 Years</button>
                        <button onclick="clearAndBackfill('2023-01-03')" style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;"> Reset & Full</button>
                    </div>
                </div>

                <!-- Recent Predictions Summary -->
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 15px;">
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: #666;">Total Logged</div>
                        <div id="logTotalCount" style="font-size: 24px; font-weight: 700; color: #333;">0</div>
                    </div>
                    <div style="background: rgba(139,92,246,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: #7c3aed;"> Gann Accuracy</div>
                        <div id="logGannAccuracy" style="font-size: 24px; font-weight: 700; color: #7c3aed;">--%</div>
                    </div>
                    <div style="background: rgba(59,130,246,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: #2563eb;"> SQ9 Accuracy</div>
                        <div id="logSq9Accuracy" style="font-size: 24px; font-weight: 700; color: #3b82f6;">--%</div>
                    </div>
                    <div style="background: rgba(239,68,68,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: #dc2626;"> Market Accuracy</div>
                        <div id="logMktAccuracy" style="font-size: 24px; font-weight: 700; color: #ef4444;">--%</div>
                    </div>
                    <div style="background: rgba(34,197,94,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: #16a34a;"> Aligned Accuracy</div>
                        <div id="logAlignedAccuracy" style="font-size: 24px; font-weight: 700; color: #22c55e;">--%</div>
                    </div>
                </div>

                <!-- Symbol Filter -->
                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-size: 12px; font-weight: 600; color: #333;"> Filter by Symbol</div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="selectAllSymbols()" style="padding: 4px 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">Select All</button>
                            <button onclick="clearAllSymbols()" style="padding: 4px 10px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">Clear</button>
                        </div>
                    </div>
                    <div id="symbolFilterCheckboxes" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <!-- Checkboxes generated dynamically -->
                    </div>
                </div>

                <!-- Prediction Log Table -->
                <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background: #f0f0f0;">
                            <tr>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd; font-size: 10px;">DATE</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd; font-size: 10px;">SYMBOL</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd; font-size: 10px;">PRICE</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd; background: rgba(139,92,246,0.1); font-size: 10px;"> GANN</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd; background: rgba(59,130,246,0.1); font-size: 10px;"> SQ9</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd; background: rgba(239,68,68,0.1); font-size: 10px;"> MKT</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd; font-size: 10px;">ALIGNED</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd; font-size: 10px;">NEXT DAY</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd; font-size: 10px;">ACTUAL</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd; background: rgba(139,92,246,0.1); font-size: 10px;">G</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd; background: rgba(59,130,246,0.1); font-size: 10px;">S</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd; background: rgba(239,68,68,0.1); font-size: 10px;">M</th>
                            </tr>
                        </thead>
                        <tbody id="predictionLogBody">
                            <tr><td colspan="12" style="text-align: center; padding: 30px; color: #666;">No predictions logged yet. Click "Save Today's Predictions" to start tracking.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Performance Over Time Chart (placeholder) -->
            <div class="card">
                <div class="card-title"> Cumulative Accuracy Over Time</div>
                <div id="performanceChartContainer" style="height: 250px; background: #f8f9fa; border-radius: 8px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-size: 12px; color: #666;">Accuracy by Date (Most Recent 14 Days)</div>
                        <div style="display: flex; gap: 15px; font-size: 10px;">
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: #8b5cf6; border-radius: 2px;"></span> Gann</span>
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: #ef4444; border-radius: 2px;"></span> Market</span>
                            <span><span style="display: inline-block; width: 12px; height: 12px; background: #22c55e; border-radius: 2px;"></span> Both Correct</span>
                        </div>
                    </div>
                    <div id="accuracyChartBars" style="display: flex; align-items: flex-end; justify-content: space-around; height: 180px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                        <div style="text-align: center; color: #999; font-size: 12px; width: 100%;">No verified predictions yet.<br>Click "Verify Past Predictions" after next trading day.</div>
                    </div>
                    <div id="accuracyChartLabels" style="display: flex; justify-content: space-around; padding-top: 5px; font-size: 9px; color: #666;"></div>
                </div>

                <!-- Running Accuracy Totals -->
                <div id="runningTotalsContainer" style="margin-top: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <div style="background: rgba(139,92,246,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: #7c3aed;"> Gann Running Total</div>
                        <div id="runningGannAccuracy" style="font-size: 20px; font-weight: 700; color: #8b5cf6;">--%</div>
                        <div id="runningGannRecord" style="font-size: 10px; color: #666;">0/0 correct</div>
                    </div>
                    <div style="background: rgba(239,68,68,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: #dc2626;"> Market Running Total</div>
                        <div id="runningMktAccuracy" style="font-size: 20px; font-weight: 700; color: #ef4444;">--%</div>
                        <div id="runningMktRecord" style="font-size: 10px; color: #666;">0/0 correct</div>
                    </div>
                    <div style="background: rgba(34,197,94,0.1); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 10px; color: #16a34a;"> Leader</div>
                        <div id="runningLeader" style="font-size: 16px; font-weight: 700; color: #22c55e;">TBD</div>
                        <div id="runningLeaderMargin" style="font-size: 10px; color: #666;">Need data</div>
                    </div>
                </div>

                <!-- Gann Signal Mode Toggle -->
                <div style="margin-top: 15px; padding: 15px; background: rgba(139,92,246,0.1); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 12px; font-weight: 600; color: #7c3aed;"> Gann Signal Mode</div>
                            <div style="font-size: 11px; color: #666;">Current Gann accuracy: 36% (below 50% = contrarian)</div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="btnGannNormal" onclick="setGannMode(false)" style="padding: 8px 16px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;">Normal (36%)</button>
                            <button id="btnGannInvert" onclick="setGannMode(true)" style="padding: 8px 16px; background: white; color: #8b5cf6; border: 1px solid #8b5cf6; border-radius: 6px; cursor: pointer; font-size: 11px;">Inverted (64%)</button>
                        </div>
                    </div>
                    <div id="gannModeExplain" style="margin-top: 10px; font-size: 10px; color: #666;">
                        Normal mode: CALL when price in bottom 35% of range. Inverted: CALL when price in TOP 35% (momentum following).
                    </div>
                </div>

                <!-- Best Performing Conditions -->
                <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="padding: 15px; background: rgba(139,92,246,0.1); border-radius: 8px;">
                        <div style="font-size: 12px; font-weight: 600; color: #7c3aed; margin-bottom: 8px;"> Gann Works Best When:</div>
                        <div style="font-size: 11px; color: #666; line-height: 1.6;">
                             Price at range extremes (< 25% or > 75%)<br>
                             After extended moves (reversion likely)<br>
                             In ranging/consolidating markets
                        </div>
                    </div>
                    <div style="padding: 15px; background: rgba(239,68,68,0.1); border-radius: 8px;">
                        <div style="font-size: 12px; font-weight: 600; color: #dc2626; margin-bottom: 8px;"> Market Works Best When:</div>
                        <div style="font-size: 11px; color: #666; line-height: 1.6;">
                             Strong trending markets<br>
                             Clear above/below 20MA position<br>
                             Low VIX (< 20) environments
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent Prediction Tracking -->
            <div class="card" style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="card-title" style="margin: 0;"> Agent Prediction Tracking</div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="saveAgentPredictions()" style="padding: 6px 12px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 10px;"> Save Today</button>
                        <button onclick="verifyAgentPredictions()" style="padding: 6px 12px; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 10px;"> Verify</button>
                        <button onclick="clearAndBackfillAgentPredictions('2023-01-03')" style="padding: 6px 12px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 10px; font-weight: 600;"> BACKFILL 2 YEARS</button>
                        <button onclick="localStorage.removeItem('stockAgentAgentLog'); updateAgentPredictionDisplay(); alert('Agent log cleared');" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 10px;"> Clear</button>
                    </div>
                </div>

                <div style="margin-bottom: 15px; padding: 10px; background: rgba(139,92,246,0.1); border-radius: 8px; font-size: 11px; color: #7c3aed;">
                     Track actual agent signal accuracy. Save predictions daily, verify after next trading day.
                    <br>Total logged: <strong id="agentTotalLogged">0</strong> predictions
                </div>

                <!-- Agent Individual Performance -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.2)); border-radius: 10px; padding: 15px; text-align: center; border: 1px solid #3b82f6;">
                        <div style="font-size: 10px; color: #2563eb; font-weight: 600;"> Base Confluence</div>
                        <div id="agentBaseAccuracy" style="font-size: 28px; font-weight: 800; color: #3b82f6;">--%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(139,92,246,0.2)); border-radius: 10px; padding: 15px; text-align: center; border: 1px solid #8b5cf6;">
                        <div style="font-size: 10px; color: #7c3aed; font-weight: 600;"> Gann-Elliott</div>
                        <div id="agentGannElliottAccuracy" style="font-size: 28px; font-weight: 800; color: #8b5cf6;">--%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(234,179,8,0.1), rgba(234,179,8,0.2)); border-radius: 10px; padding: 15px; text-align: center; border: 1px solid #eab308;">
                        <div style="font-size: 10px; color: #ca8a04; font-weight: 600;"> DQN/ML</div>
                        <div id="agentDqnAccuracy" style="font-size: 28px; font-weight: 800; color: #eab308;">--%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(34,197,94,0.2)); border-radius: 10px; padding: 15px; text-align: center; border: 1px solid #22c55e;">
                        <div style="font-size: 10px; color: #16a34a; font-weight: 600;"> 3-Wave</div>
                        <div id="agentWaveAccuracy" style="font-size: 28px; font-weight: 800; color: #22c55e;">--%</div>
                    </div>
                </div>

                <!-- Consensus Level Performance -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div style="background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.25)); border-radius: 10px; padding: 15px; text-align: center; border: 2px solid #22c55e;">
                        <div style="font-size: 11px; color: #16a34a; font-weight: 600;"> ULTRA (4/4 Agree)</div>
                        <div id="agentUltraAccuracy" style="font-size: 24px; font-weight: 800; color: #22c55e;">--% (0/0)</div>
                        <div style="font-size: 10px; color: #666;">Expected: 89%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(59,130,246,0.25)); border-radius: 10px; padding: 15px; text-align: center; border: 2px solid #3b82f6;">
                        <div style="font-size: 11px; color: #2563eb; font-weight: 600;"> SUPER (3/4 Agree)</div>
                        <div id="agentSuperAccuracy" style="font-size: 24px; font-weight: 800; color: #3b82f6;">--% (0/0)</div>
                        <div style="font-size: 10px; color: #666;">Expected: 78%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(234,179,8,0.15), rgba(234,179,8,0.25)); border-radius: 10px; padding: 15px; text-align: center; border: 2px solid #eab308;">
                        <div style="font-size: 11px; color: #ca8a04; font-weight: 600;"> MIXED (2/4 or less)</div>
                        <div id="agentMixedAccuracy" style="font-size: 24px; font-weight: 800; color: #eab308;">--% (0/0)</div>
                        <div style="font-size: 10px; color: #666;">Expected: ~50%</div>
                    </div>
                </div>
            </div>

            <!-- TRUE Gann Backtest Results -->
            <div class="card" style="margin-top: 20px; background: linear-gradient(135deg, rgba(139,92,246,0.05), rgba(124,58,237,0.1)); border: 1px solid rgba(139,92,246,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="card-title" style="margin: 0; color: #8b5cf6;"> TRUE Gann Backtest (Sq9 + Time Cycles)</div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="backtestRealGann()" style="padding: 10px 20px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;"> Run Backtest</button>
                        <button onclick="backtestSq9Tolerances()" style="padding: 10px 20px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;"> Find Optimal Tolerance</button>
                        <button onclick="backtestPivotGann()" style="padding: 10px 20px; background: linear-gradient(135deg, #7c3aed, #5b21b6); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;"> Pivot-Based Gann</button>
                    </div>
                </div>

                <!-- Quick Tolerance Test Buttons -->
                <div style="margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                    <span style="font-size: 11px; color: #666;">Quick Sq9 Test:</span>
                    <button onclick="quickSq9Test(0.005)" style="padding: 6px 12px; background: rgba(139,92,246,0.2); color: #8b5cf6; border: 1px solid rgba(139,92,246,0.4); border-radius: 4px; cursor: pointer; font-size: 11px;">0.5%</button>
                    <button onclick="quickSq9Test(0.0075)" style="padding: 6px 12px; background: rgba(139,92,246,0.2); color: #8b5cf6; border: 1px solid rgba(139,92,246,0.4); border-radius: 4px; cursor: pointer; font-size: 11px;">0.75%</button>
                    <button onclick="quickSq9Test(0.01)" style="padding: 6px 12px; background: rgba(139,92,246,0.2); color: #8b5cf6; border: 1px solid rgba(139,92,246,0.4); border-radius: 4px; cursor: pointer; font-size: 11px;">1.0%</button>
                    <button onclick="quickSq9Test(0.0125)" style="padding: 6px 12px; background: rgba(139,92,246,0.2); color: #8b5cf6; border: 1px solid rgba(139,92,246,0.4); border-radius: 4px; cursor: pointer; font-size: 11px;">1.25%</button>
                    <button onclick="quickSq9Test(0.015)" style="padding: 6px 12px; background: rgba(139,92,246,0.3); color: #7c3aed; border: 1px solid rgba(139,92,246,0.6); border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">1.5% </button>
                    <button onclick="quickSq9Test(0.02)" style="padding: 6px 12px; background: rgba(139,92,246,0.2); color: #8b5cf6; border: 1px solid rgba(139,92,246,0.4); border-radius: 4px; cursor: pointer; font-size: 11px;">2.0%</button>
                </div>

                <!-- Single ETF Test -->
                <div style="margin-bottom: 15px; padding: 12px; background: rgba(34,197,94,0.1); border-radius: 8px; border: 1px solid rgba(34,197,94,0.3);">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 11px; color: #166534; font-weight: 600;"> Test Single ETF:</span>
                        <select id="singleETFSelect" style="padding: 6px 10px; border-radius: 4px; border: 1px solid rgba(34,197,94,0.4); background: white; font-size: 11px; cursor: pointer;">
                            <optgroup label="Index ETFs">
                                <option value="SPY">SPY</option>
                                <option value="QQQ">QQQ</option>
                                <option value="IWM">IWM</option>
                                <option value="DIA">DIA</option>
                            </optgroup>
                            <optgroup label="Sector ETFs">
                                <option value="XLF">XLF</option>
                                <option value="XLE">XLE</option>
                                <option value="XLK">XLK</option>
                                <option value="XLV">XLV</option>
                                <option value="XLI">XLI</option>
                                <option value="XLB">XLB</option>
                                <option value="XLU">XLU</option>
                                <option value="XLP">XLP</option>
                                <option value="XLY">XLY</option>
                            </optgroup>
                            <optgroup label="Mega Caps">
                                <option value="AAPL">AAPL</option>
                                <option value="MSFT">MSFT</option>
                                <option value="NVDA">NVDA</option>
                                <option value="TSLA">TSLA</option>
                                <option value="AMZN">AMZN</option>
                                <option value="GOOGL">GOOGL</option>
                                <option value="META">META</option>
                                <option value="JPM">JPM</option>
                                <option value="AMD">AMD</option>
                                <option value="NFLX">NFLX</option>
                            </optgroup>
                            <optgroup label="Additional Stocks">
                                <option value="V">V</option>
                                <option value="MA">MA</option>
                                <option value="UNH">UNH</option>
                                <option value="HD">HD</option>
                                <option value="PG">PG</option>
                                <option value="BAC">BAC</option>
                                <option value="WMT">WMT</option>
                                <option value="DIS">DIS</option>
                                <option value="COST">COST</option>
                                <option value="CRM">CRM</option>
                                <option value="INTC">INTC</option>
                                <option value="CSCO">CSCO</option>
                                <option value="ADBE">ADBE</option>
                                <option value="ORCL">ORCL</option>
                                <option value="PFE">PFE</option>
                                <option value="MRK">MRK</option>
                                <option value="ABBV">ABBV</option>
                                <option value="LLY">LLY</option>
                                <option value="CVX">CVX</option>
                                <option value="XOM">XOM</option>
                            </optgroup>
                        </select>
                        <span style="font-size: 10px; color: #666;">Tolerance:</span>
                        <select id="singleETFTolerance" style="padding: 6px 8px; border-radius: 4px; border: 1px solid rgba(34,197,94,0.4); background: white; font-size: 11px; cursor: pointer;">
                            <option value="0.005">0.5%</option>
                            <option value="0.0075">0.75%</option>
                            <option value="0.01">1.0%</option>
                            <option value="0.0125">1.25%</option>
                            <option value="0.015" selected>1.5%</option>
                            <option value="0.02">2.0%</option>
                            <option value="0.025">2.5%</option>
                        </select>
                        <button onclick="runSingleETFTest()" style="padding: 6px 14px; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;"> Run Test</button>
                    </div>

                    <!-- Single ETF Results Display -->
                    <div id="singleETFResults" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="font-size: 12px; font-weight: 600; color: #166534;"> <span id="singleETFSymbolTitle">SPY</span> Results @ <span id="singleETFTolTitle">1.5%</span> Tolerance</div>
                        </div>

                        <!-- Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px;">
                            <div style="background: rgba(34,197,94,0.15); border-radius: 6px; padding: 10px; text-align: center;">
                                <div style="font-size: 9px; color: #166534;"> Sq9 Support</div>
                                <div id="singleETFSupport" style="font-size: 20px; font-weight: 700; color: #22c55e;">--%</div>
                            </div>
                            <div style="background: rgba(239,68,68,0.15); border-radius: 6px; padding: 10px; text-align: center;">
                                <div style="font-size: 9px; color: #991b1b;"> Sq9 Resist</div>
                                <div id="singleETFResist" style="font-size: 20px; font-weight: 700; color: #ef4444;">--%</div>
                            </div>
                            <div style="background: rgba(139,92,246,0.15); border-radius: 6px; padding: 10px; text-align: center;">
                                <div style="font-size: 9px; color: #7c3aed;"> 144-Day</div>
                                <div id="singleETFCycle" style="font-size: 20px; font-weight: 700; color: #8b5cf6;">--%</div>
                            </div>
                            <div style="background: rgba(245,158,11,0.15); border-radius: 6px; padding: 10px; text-align: center;">
                                <div style="font-size: 9px; color: #b45309;"> Combined</div>
                                <div id="singleETFCombined" style="font-size: 20px; font-weight: 700; color: #f59e0b;">--%</div>
                            </div>
                        </div>

                        <!-- Detailed Table -->
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                                <thead style="background: #f0f0f0;">
                                    <tr>
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">METRIC</th>
                                        <th style="padding: 8px; text-align: center; border-bottom: 2px solid #ddd;">WIN RATE</th>
                                        <th style="padding: 8px; text-align: center; border-bottom: 2px solid #ddd;">WINS</th>
                                        <th style="padding: 8px; text-align: center; border-bottom: 2px solid #ddd;">TOTAL</th>
                                        <th style="padding: 8px; text-align: center; border-bottom: 2px solid #ddd;">EDGE vs 50%</th>
                                    </tr>
                                </thead>
                                <tbody id="singleETFTableBody">
                                    <tr><td colspan="5" style="text-align: center; padding: 20px; color: #666;">Click "Run Test" to see results</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 15px; padding: 10px; background: rgba(139,92,246,0.1); border-radius: 8px; font-size: 11px; color: #7c3aed;">
                    Tests Square of 9 support/resistance levels and Time Cycle turn dates against 2 years of SPY data.
                    <br>Total combined signals: <strong id="gannTotalSignals">0</strong>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Square of 9 Results -->
                    <div>
                        <h4 style="font-size: 12px; color: #8b5cf6; margin-bottom: 10px; border-bottom: 1px solid rgba(139,92,246,0.3); padding-bottom: 5px;"> Square of 9 Levels</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="background: rgba(34,197,94,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                                <div style="font-size: 10px; color: #166534;">Support Bounce</div>
                                <div id="gannSq9SupportPct" style="font-size: 24px; font-weight: 800; color: #22c55e;">--%</div>
                                <div id="gannSq9SupportStats" style="font-size: 10px; color: #666;">0/0 bounces</div>
                            </div>
                            <div style="background: rgba(239,68,68,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                                <div style="font-size: 10px; color: #991b1b;">Resistance Reject</div>
                                <div id="gannSq9ResistPct" style="font-size: 24px; font-weight: 800; color: #ef4444;">--%</div>
                                <div id="gannSq9ResistStats" style="font-size: 10px; color: #666;">0/0 rejections</div>
                            </div>
                        </div>
                    </div>

                    <!-- Time Cycles Results -->
                    <div>
                        <h4 style="font-size: 12px; color: #8b5cf6; margin-bottom: 10px; border-bottom: 1px solid rgba(139,92,246,0.3); padding-bottom: 5px;"> Time Cycles (Reversals at Turn)</h4>
                        <div style="font-size: 11px; line-height: 1.8;">
                            <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: rgba(139,92,246,0.1); border-radius: 4px; margin-bottom: 4px;">
                                <span>30-Day Minor:</span>
                                <span id="gannCycle30" style="font-weight: 600; color: #8b5cf6;">--% (0/0)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: rgba(139,92,246,0.1); border-radius: 4px; margin-bottom: 4px;">
                                <span>45-Day (1/8 yr):</span>
                                <span id="gannCycle45" style="font-weight: 600; color: #8b5cf6;">--% (0/0)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: rgba(139,92,246,0.1); border-radius: 4px; margin-bottom: 4px;">
                                <span>90-Day Quarter:</span>
                                <span id="gannCycle90" style="font-weight: 600; color: #8b5cf6;">--% (0/0)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: rgba(212,160,23,0.2); border-radius: 4px; margin-bottom: 4px;">
                                <span>144-Day Sacred:</span>
                                <span id="gannCycle144" style="font-weight: 600; color: #d4a017;">--% (0/0)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: rgba(139,92,246,0.1); border-radius: 4px;">
                                <span>180-Day Semi:</span>
                                <span id="gannCycle180" style="font-weight: 600; color: #8b5cf6;">--% (0/0)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Combined Results -->
                <div style="margin-top: 15px; background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(124,58,237,0.3)); border-radius: 10px; padding: 15px; text-align: center; border: 2px solid #8b5cf6;">
                    <div style="font-size: 12px; color: #7c3aed; font-weight: 600;"> COMBINED (Sq9 Level + Cycle Turn)</div>
                    <div id="gannCombinedPct" style="font-size: 32px; font-weight: 800; color: #8b5cf6;">--%</div>
                    <div id="gannCombinedStats" style="font-size: 11px; color: #666;">0/0 correct predictions</div>
                    <div style="font-size: 10px; color: #7c3aed; margin-top: 5px;">Target: >55% = Edge Found</div>
                </div>
            </div>

            <!-- Biblical Numbers Section -->
            <div class="card" style="margin-top: 20px; background: linear-gradient(135deg, rgba(124,58,237,0.05), rgba(37,99,235,0.1)); border: 1px solid rgba(124,58,237,0.3);">
                <div class="card-title" style="color: #7c3aed;"> Gann Biblical Numbers Analysis</div>

                <div style="margin-bottom: 15px; padding: 12px; background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(59,130,246,0.1)); border-radius: 8px;">
                    <div style="font-size: 11px; color: #666; line-height: 1.6;">
                        <strong>Biblical Numbers from "Tunnel Thru the Air":</strong><br>
                        7 (Creation)  12 (Tribes)  40 (Flood/Moses)  49 (Jubilee)  144 (Sacred 1212)  360 (Prophetic Year)<br>
                        <em>"The Bible contains the key to the process by which you may know all there is to know"</em> - W.D. Gann
                    </div>
                </div>

                <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="backtestBiblicalNumbers()" style="padding: 12px 24px; background: linear-gradient(135deg, #7c3aed, #2563eb); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                         Test 2 Years (2023-2025)
                    </button>
                    <button onclick="backtestBiblicalFull()" style="padding: 12px 24px; background: linear-gradient(135deg, #d4a017, #b8860b); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                         Test 32 Years (1993-2025)
                    </button>
                </div>

                <div id="biblicalResultsContainer">
                    <div style="text-align: center; padding: 30px; color: #999; font-size: 12px;">
                        Click the button above to test Gann's Biblical cycles on SPY
                    </div>
                </div>

                <!-- Key Biblical Cycles Reference -->
                <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 11px; font-weight: 600; color: #666; margin-bottom: 8px;"> Key Gann Biblical Cycles:</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 10px;">
                        <div style="padding: 6px; background: white; border-radius: 4px; text-align: center;">
                            <div style="font-weight: 600; color: #7c3aed;">7 Days</div>
                            <div style="color: #999;">Creation</div>
                        </div>
                        <div style="padding: 6px; background: white; border-radius: 4px; text-align: center;">
                            <div style="font-weight: 600; color: #7c3aed;">40 Days</div>
                            <div style="color: #999;">Flood</div>
                        </div>
                        <div style="padding: 6px; background: white; border-radius: 4px; text-align: center;">
                            <div style="font-weight: 600; color: #7c3aed;">49 Days</div>
                            <div style="color: #999;">77 Jubilee</div>
                        </div>
                        <div style="padding: 6px; background: white; border-radius: 4px; text-align: center;">
                            <div style="font-weight: 600; color: #d4a017;">144 Days</div>
                            <div style="color: #999;">1212 Sacred</div>
                        </div>
                        <div style="padding: 6px; background: white; border-radius: 4px; text-align: center;">
                            <div style="font-weight: 600; color: #7c3aed;">150 Days</div>
                            <div style="color: #999;">Flood Duration</div>
                        </div>
                        <div style="padding: 6px; background: white; border-radius: 4px; text-align: center;">
                            <div style="font-weight: 600; color: #7c3aed;">180 Days</div>
                            <div style="color: #999;">Half Year</div>
                        </div>
                        <div style="padding: 6px; background: white; border-radius: 4px; text-align: center;">
                            <div style="font-weight: 600; color: #7c3aed;">216 Days</div>
                            <div style="color: #999;">666</div>
                        </div>
                        <div style="padding: 6px; background: white; border-radius: 4px; text-align: center;">
                            <div style="font-weight: 600; color: #7c3aed;">360 Days</div>
                            <div style="color: #999;">Prophetic Year</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==========================================
                 GANN CYCLE PREDICTION AUTO TRACKER
                 ========================================== -->
            <div class="gann-tracker-section" id="gannPredictionTracker">
                <div class="gann-tracker-header">
                    <div class="gann-tracker-title">
                         Gann Cycle Prediction Auto-Tracker
                        <span style="font-size: 11px; font-weight: 400; color: #6b7280; margin-left: 10px;">
                            Auto-logs & validates cycle predictions
                        </span>
                    </div>
                    <div class="gann-tracker-controls">
                        <button class="gann-tracker-btn gann-tracker-btn-success" onclick="scanForNewPredictions()">
                             Scan Cycles
                        </button>
                        <button class="gann-tracker-btn gann-tracker-btn-warning" onclick="validatePendingPredictions()">
                             Validate All
                        </button>
                        <button class="gann-tracker-btn gann-tracker-btn-secondary" onclick="exportPredictionData()">
                             Export CSV
                        </button>
                    </div>
                </div>

                <!-- Performance Summary -->
                <div class="gann-perf-summary" id="gannPerfSummary">
                    <div class="gann-perf-card highlight">
                        <div class="gann-perf-value success" id="gannOverallAccuracy">--</div>
                        <div class="gann-perf-label">Overall Accuracy</div>
                    </div>
                    <div class="gann-perf-card">
                        <div class="gann-perf-value info" id="gannTotalPredictions">0</div>
                        <div class="gann-perf-label">Total Predictions</div>
                    </div>
                    <div class="gann-perf-card">
                        <div class="gann-perf-value success" id="gannCorrectPredictions">0</div>
                        <div class="gann-perf-label">Correct</div>
                    </div>
                    <div class="gann-perf-card">
                        <div class="gann-perf-value danger" id="gannIncorrectPredictions">0</div>
                        <div class="gann-perf-label">Incorrect</div>
                    </div>
                    <div class="gann-perf-card warning">
                        <div class="gann-perf-value warning" id="gannPendingPredictions">0</div>
                        <div class="gann-perf-label">Pending</div>
                    </div>
                    <div class="gann-perf-card">
                        <div class="gann-perf-value" id="gannAvgMove">--</div>
                        <div class="gann-perf-label">Avg Move %</div>
                    </div>
                </div>

                <!-- Rolling Accuracy -->
                <div class="gann-rolling-accuracy">
                    <div class="gann-rolling-accuracy-header">
                        <div class="gann-rolling-accuracy-title"> Last 20 Predictions Accuracy</div>
                        <div class="gann-rolling-accuracy-value" id="gannRollingAccuracyValue">--</div>
                    </div>
                    <div class="gann-rolling-accuracy-bar">
                        <div class="gann-rolling-accuracy-fill high" id="gannRollingAccuracyFill" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Cycle Type Breakdown -->
                <div class="gann-cycle-breakdown" id="gannCycleBreakdown">
                    <div class="gann-cycle-type-card jubilee">
                        <div class="gann-cycle-type-header">
                            <div class="gann-cycle-type-name"> 49-Day Jubilee</div>
                            <div class="gann-cycle-type-badge high" id="gann49Badge">--</div>
                        </div>
                        <div class="gann-cycle-type-stats">
                            <div class="gann-cycle-type-stat">
                                <div class="gann-cycle-type-stat-value" id="gann49Total">0</div>
                                <div class="gann-cycle-type-stat-label">Total</div>
                            </div>
                            <div class="gann-cycle-type-stat">
                                <div class="gann-cycle-type-stat-value" id="gann49Correct">0</div>
                                <div class="gann-cycle-type-stat-label">Correct</div>
                            </div>
                            <div class="gann-cycle-type-stat">
                                <div class="gann-cycle-type-stat-value" id="gann49Rate">--</div>
                                <div class="gann-cycle-type-stat-label">Rate</div>
                            </div>
                        </div>
                    </div>

                    <div class="gann-cycle-type-card quarter">
                        <div class="gann-cycle-type-header">
                            <div class="gann-cycle-type-name"> 90-Day Quarter</div>
                            <div class="gann-cycle-type-badge medium" id="gann90Badge">--</div>
                        </div>
                        <div class="gann-cycle-type-stats">
                            <div class="gann-cycle-type-stat">
                                <div class="gann-cycle-type-stat-value" id="gann90Total">0</div>
                                <div class="gann-cycle-type-stat-label">Total</div>
                            </div>
                            <div class="gann-cycle-type-stat">
                                <div class="gann-cycle-type-stat-value" id="gann90Correct">0</div>
                                <div class="gann-cycle-type-stat-label">Correct</div>
                            </div>
                            <div class="gann-cycle-type-stat">
                                <div class="gann-cycle-type-stat-value" id="gann90Rate">--</div>
                                <div class="gann-cycle-type-stat-label">Rate</div>
                            </div>
                        </div>
                    </div>

                    <div class="gann-cycle-type-card half">
                        <div class="gann-cycle-type-header">
                            <div class="gann-cycle-type-name"> 180-Day Half</div>
                            <div class="gann-cycle-type-badge medium" id="gann180Badge">--</div>
                        </div>
                        <div class="gann-cycle-type-stats">
                            <div class="gann-cycle-type-stat">
                                <div class="gann-cycle-type-stat-value" id="gann180Total">0</div>
                                <div class="gann-cycle-type-stat-label">Total</div>
                            </div>
                            <div class="gann-cycle-type-stat">
                                <div class="gann-cycle-type-stat-value" id="gann180Correct">0</div>
                                <div class="gann-cycle-type-stat-label">Correct</div>
                            </div>
                            <div class="gann-cycle-type-stat">
                                <div class="gann-cycle-type-stat-value" id="gann180Rate">--</div>
                                <div class="gann-cycle-type-stat-label">Rate</div>
                            </div>
                        </div>
                    </div>

                    <div class="gann-cycle-type-card annual">
                        <div class="gann-cycle-type-header">
                            <div class="gann-cycle-type-name"> 360-Day Annual</div>
                            <div class="gann-cycle-type-badge high" id="gann360Badge">--</div>
                        </div>
                        <div class="gann-cycle-type-stats">
                            <div class="gann-cycle-type-stat">
                                <div class="gann-cycle-type-stat-value" id="gann360Total">0</div>
                                <div class="gann-cycle-type-stat-label">Total</div>
                            </div>
                            <div class="gann-cycle-type-stat">
                                <div class="gann-cycle-type-stat-value" id="gann360Correct">0</div>
                                <div class="gann-cycle-type-stat-label">Correct</div>
                            </div>
                            <div class="gann-cycle-type-stat">
                                <div class="gann-cycle-type-stat-value" id="gann360Rate">--</div>
                                <div class="gann-cycle-type-stat-label">Rate</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Predictions -->
                <div class="gann-active-predictions" id="gannActivePredictions">
                    <div class="gann-active-predictions-title">
                         Active Predictions (Awaiting Validation)
                    </div>
                    <div class="gann-active-pred-grid" id="gannActivePredGrid">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Predictions History Table -->
                <div class="gann-predictions-table-container">
                    <div class="gann-predictions-table-header">
                        <div class="gann-predictions-table-title">
                             Prediction History
                        </div>
                        <div class="gann-predictions-filter">
                            <button class="gann-filter-btn active" onclick="filterPredictions('all')">All</button>
                            <button class="gann-filter-btn" onclick="filterPredictions('correct')"> Correct</button>
                            <button class="gann-filter-btn" onclick="filterPredictions('incorrect')"> Incorrect</button>
                            <button class="gann-filter-btn" onclick="filterPredictions('pending')"> Pending</button>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="gann-predictions-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Cycle Type</th>
                                    <th>Pivot Date</th>
                                    <th>Target Date</th>
                                    <th>Expected</th>
                                    <th>Price @ Target</th>
                                    <th>3-Day Move</th>
                                    <th>Result</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="gannPredictionsTableBody">
                                <tr>
                                    <td colspan="9" class="gann-empty-state">
                                        <div class="gann-empty-state-icon"></div>
                                        <div class="gann-empty-state-title">No Predictions Yet</div>
                                        <div class="gann-empty-state-desc">
                                            Click "Scan Cycles" to auto-detect upcoming cycle dates and log predictions.
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Confidence Intervals -->
                <div class="gann-confidence-section">
                    <div class="gann-perf-chart-header">
                        <div class="gann-perf-chart-title"> Statistical Confidence</div>
                    </div>
                    <div class="gann-confidence-grid">
                        <div class="gann-confidence-item">
                            <div class="gann-confidence-item-title">Expected Accuracy (Backtest)</div>
                            <div class="gann-confidence-item-value" style="color: #8b5cf6;">67%</div>
                            <div class="gann-confidence-item-range">Based on 32 years SPY data</div>
                        </div>
                        <div class="gann-confidence-item">
                            <div class="gann-confidence-item-title">Your Live Accuracy</div>
                            <div class="gann-confidence-item-value" id="gannLiveAccuracy" style="color: #22c55e;">--</div>
                            <div class="gann-confidence-item-range" id="gannLiveConfidence">95% CI: --</div>
                        </div>
                        <div class="gann-confidence-item">
                            <div class="gann-confidence-item-title">Performance vs Expected</div>
                            <div class="gann-confidence-item-value" id="gannPerfVsExpected">--</div>
                            <div class="gann-confidence-item-range" id="gannPerfStatus">Analyzing...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MULTI-CHARTS TAB -->
                <div id="multi-charts" class="tab-content">
            <div class="card" style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div class="card-title" style="margin: 0;"> Multi-Timeframe Chart Analysis <span id="multiChartsLastUpdated" class="section-timestamp" style="font-size: 10px; color: var(--muted); font-weight: normal; margin-left: 10px;" title="Last updated"> --</span></div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <label style="font-size: 11px; color: var(--muted);">Symbol:</label>
                        <select id="multiChartSymbol" onchange="syncSymbolFromMultiCharts()" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; font-weight: 600;">
                            <optgroup label="Index ETFs">
                                <option value="SPY">SPY</option>
                                <option value="QQQ">QQQ</option>
                                <option value="IWM">IWM</option>
                                <option value="DIA">DIA</option>
                            </optgroup>
                            <optgroup label="Sector ETFs">
                                <option value="XLF">XLF</option>
                                <option value="XLE">XLE</option>
                                <option value="XLK">XLK</option>
                                <option value="XLV">XLV</option>
                                <option value="XLI">XLI</option>
                                <option value="XLB">XLB</option>
                                <option value="XLU">XLU</option>
                                <option value="XLP">XLP</option>
                                <option value="XLY">XLY</option>
                            </optgroup>
                            <optgroup label="Mega Caps">
                                <option value="AAPL">AAPL</option>
                                <option value="MSFT">MSFT</option>
                                <option value="NVDA">NVDA</option>
                                <option value="TSLA">TSLA</option>
                                <option value="AMZN">AMZN</option>
                                <option value="GOOGL">GOOGL</option>
                                <option value="META">META</option>
                                <option value="JPM">JPM</option>
                                <option value="AMD">AMD</option>
                                <option value="NFLX">NFLX</option>
                            </optgroup>
                            <optgroup label="Additional Stocks">
                                <option value="V">V</option>
                                <option value="MA">MA</option>
                                <option value="UNH">UNH</option>
                                <option value="HD">HD</option>
                                <option value="PG">PG</option>
                                <option value="BAC">BAC</option>
                                <option value="WMT">WMT</option>
                                <option value="DIS">DIS</option>
                                <option value="COST">COST</option>
                                <option value="CRM">CRM</option>
                                <option value="INTC">INTC</option>
                                <option value="CSCO">CSCO</option>
                                <option value="ADBE">ADBE</option>
                                <option value="ORCL">ORCL</option>
                                <option value="PFE">PFE</option>
                                <option value="MRK">MRK</option>
                                <option value="ABBV">ABBV</option>
                                <option value="LLY">LLY</option>
                                <option value="CVX">CVX</option>
                                <option value="XOM">XOM</option>
                            </optgroup>
                        </select>
                        <button onclick="updateMultiCharts(document.getElementById('multiChartSymbol')?.value || currentSymbol)" style="padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;"> Refresh All</button>
                    </div>
                </div>
            </div>

            <!-- MTF Bias Summary -->
            <div class="mtf-summary">
                <div class="mtf-summary-title"> Multi-Timeframe Bias Summary</div>
                <div class="mtf-summary-grid">
                    <div class="mtf-summary-item">
                        <div class="title"> Intraday</div>
                        <div class="value bullish" id="intradayBias">BULLISH</div>
                    </div>
                    <div class="mtf-summary-item">
                        <div class="title"> Swing</div>
                        <div class="value bullish" id="swingBias">BULLISH</div>
                    </div>
                    <div class="mtf-summary-item">
                        <div class="title"> Position</div>
                        <div class="value bearish" id="positionBias">BEARISH</div>
                    </div>
                    <div class="mtf-summary-item">
                        <div class="title"> Confluence</div>
                        <div class="value bullish" id="overallBias">2/3 BULLISH</div>
                    </div>
                </div>
            </div>

            <div class="multi-charts-container">
                <!-- INTRADAY PANEL -->
                <div class="chart-panel">
                    <div class="chart-panel-header">
                        <div class="chart-panel-title">
                            <span class="icon intraday"></span>
                            <span>Intraday</span>
                            <span class="signal-badge-mtf call" id="intradaySignal">CALL</span>
                            <div id="intradayTfIndicator" style="font-size: 10px; color: #f59e0b; margin-left: 10px;">Showing: 15 Minute data</div>
                        </div>
                        <div class="chart-controls">
                            <select id="intradayTimeframe" class="chart-select" onchange="updateChartTimeframe('intraday', this.value); updateChart('intraday')">
                                <option value="1m">1 Min</option>
                                <option value="5m">5 Min</option>
                                <option value="15m" selected>15 Min</option>
                                <option value="30m">30 Min</option>
                                <option value="1h">1 Hour</option>
                            </select>
                            <select id="intradayChartType" class="chart-select" onchange="updateChart('intraday')">
                                <option value="candlestick">Candlestick</option>
                                <option value="heikinashi">Heikin Ashi</option>
                                <option value="line">Line</option>
                                <option value="pf">Point & Figure</option>
                            </select>
                            <button class="settings-btn-mtf" onclick="toggleMTFSettings('intraday')"></button>
                        </div>
                    </div>
                    <div class="settings-panel-mtf" id="intradaySettings">
                        <div class="settings-row-mtf">
                            <label><input type="checkbox" id="intradayShowEMA" checked onchange="updateChart('intraday')"> EMAs</label>
                            <label><input type="checkbox" id="intradayShowFib" checked onchange="updateChart('intraday')"> Fib Levels</label>
                            <label style="color: #f59e0b;"><input type="checkbox" id="intradayShowSQ9" checked onchange="updateChart('intraday')">  SQ9</label>
                            <label><input type="checkbox" id="intradayShowPatterns" checked onchange="updateChart('intraday')"> Patterns</label>
                            <label><input type="checkbox" id="intradayShowVolume" checked onchange="updateChart('intraday')"> Volume</label>
                        </div>
                    </div>
                    <div id="intradayPattern" class="pattern-alert-mtf" style="display:none;"></div>
                    <div class="chart-body" id="intradayChartBody">
                        <div class="chart-legend">
                            <span class="symbol" id="intradaySymbol">SPY</span>
                            <span class="price" id="intradayPrice">--</span>
                        </div>
                        <div class="chart-canvas-container" id="intradayChartContainer"></div>
                        <div class="chart-loading" id="intradayLoading">Loading chart...</div>
                    </div>
                    <div class="mtf-legend" id="intradayLegend">
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#f59e0b;"></div> EMA 9</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#3b82f6;"></div> EMA 21</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#8b5cf6;"></div> EMA 50</div>
                        <div class="legend-item-mtf" style="border-left: 1px solid var(--border); padding-left: 8px; margin-left: 8px;"><div class="legend-color-mtf" style="background:#22c55e; border-style: dashed;"></div> SQ9 Sup</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#ef4444; border-style: dashed;"></div> SQ9 Res</div>
                    </div>
                    <div class="fib-levels-mtf" id="intradayFib"></div>
                </div>

                <!-- SWING PANEL -->
                <div class="chart-panel">
                    <div class="chart-panel-header">
                        <div class="chart-panel-title">
                            <span class="icon swing"></span>
                            <span>Swing</span>
                            <span class="signal-badge-mtf call" id="swingSignal">CALL</span>
                            <div id="swingTfIndicator" style="font-size: 10px; color: #3b82f6; margin-left: 10px;">Showing: Daily data</div>
                        </div>
                        <div class="chart-controls">
                            <select id="swingTimeframe" class="chart-select" onchange="updateChartTimeframe('swing', this.value); updateChart('swing')">
                                <option value="1h">1 Hour</option>
                                <option value="4h">4 Hour</option>
                                <option value="1d" selected>Daily</option>
                                <option value="1w">Weekly</option>
                            </select>
                            <select id="swingChartType" class="chart-select" onchange="updateChart('swing')">
                                <option value="candlestick">Candlestick</option>
                                <option value="heikinashi">Heikin Ashi</option>
                                <option value="line">Line</option>
                                <option value="pf">Point & Figure</option>
                            </select>
                            <button class="settings-btn-mtf" onclick="toggleMTFSettings('swing')"></button>
                        </div>
                    </div>
                    <div class="settings-panel-mtf" id="swingSettings">
                        <div class="settings-row-mtf">
                            <label><input type="checkbox" id="swingShowEMA" checked onchange="updateChart('swing')"> EMAs</label>
                            <label><input type="checkbox" id="swingShowFib" checked onchange="updateChart('swing')"> Fib Levels</label>
                            <label style="color: #f59e0b;"><input type="checkbox" id="swingShowSQ9" checked onchange="updateChart('swing')">  SQ9</label>
                            <label><input type="checkbox" id="swingShowPatterns" checked onchange="updateChart('swing')"> Patterns</label>
                            <label><input type="checkbox" id="swingShowVolume" checked onchange="updateChart('swing')"> Volume</label>
                        </div>
                    </div>
                    <div id="swingPattern" class="pattern-alert-mtf" style="display:none;"></div>
                    <div class="chart-body" id="swingChartBody">
                        <div class="chart-legend">
                            <span class="symbol" id="swingSymbol">SPY</span>
                            <span class="price" id="swingPrice">--</span>
                        </div>
                        <div class="chart-canvas-container" id="swingChartContainer"></div>
                        <div class="chart-loading" id="swingLoading">Loading chart...</div>
                    </div>
                    <div class="mtf-legend" id="swingLegend">
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#f59e0b;"></div> EMA 9</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#3b82f6;"></div> EMA 21</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#8b5cf6;"></div> EMA 50</div>
                        <div class="legend-item-mtf" style="border-left: 1px solid var(--border); padding-left: 8px; margin-left: 8px;"><div class="legend-color-mtf" style="background:#22c55e; border-style: dashed;"></div> SQ9 Sup</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#ef4444; border-style: dashed;"></div> SQ9 Res</div>
                    </div>
                    <div class="fib-levels-mtf" id="swingFib"></div>
                </div>

                <!-- POSITION PANEL -->
                <div class="chart-panel">
                    <div class="chart-panel-header">
                        <div class="chart-panel-title">
                            <span class="icon position"></span>
                            <span>Position</span>
                            <span class="signal-badge-mtf put" id="positionSignal">PUT</span>
                            <div id="positionTfIndicator" style="font-size: 10px; color: #8b5cf6; margin-left: 10px;">Showing: Monthly data</div>
                        </div>
                        <div class="chart-controls">
                            <select id="positionTimeframe" class="chart-select" onchange="updateChartTimeframe('position', this.value); updateChart('position')">
                                <option value="1d">Daily</option>
                                <option value="1w">Weekly</option>
                                <option value="1M" selected>Monthly</option>
                                <option value="3M">Quarterly</option>
                            </select>
                            <select id="positionChartType" class="chart-select" onchange="updateChart('position')">
                                <option value="candlestick">Candlestick</option>
                                <option value="heikinashi">Heikin Ashi</option>
                                <option value="line">Line</option>
                                <option value="pf">Point & Figure</option>
                            </select>
                            <button class="settings-btn-mtf" onclick="toggleMTFSettings('position')"></button>
                        </div>
                    </div>
                    <div class="settings-panel-mtf" id="positionSettings">
                        <div class="settings-row-mtf">
                            <label><input type="checkbox" id="positionShowEMA" checked onchange="updateChart('position')"> EMAs</label>
                            <label><input type="checkbox" id="positionShowFib" checked onchange="updateChart('position')"> Fib Levels</label>
                            <label style="color: #f59e0b;"><input type="checkbox" id="positionShowSQ9" checked onchange="updateChart('position')">  SQ9</label>
                            <label><input type="checkbox" id="positionShowPatterns" checked onchange="updateChart('position')"> Patterns</label>
                            <label><input type="checkbox" id="positionShowVolume" checked onchange="updateChart('position')"> Volume</label>
                        </div>
                    </div>
                    <div id="positionPattern" class="pattern-alert-mtf" style="display:none;"></div>
                    <div class="chart-body" id="positionChartBody">
                        <div class="chart-legend">
                            <span class="symbol" id="positionSymbol">SPY</span>
                            <span class="price" id="positionPrice">--</span>
                        </div>
                        <div class="chart-canvas-container" id="positionChartContainer"></div>
                        <div class="chart-loading" id="positionLoading">Loading chart...</div>
                    </div>
                    <div class="mtf-legend" id="positionLegend">
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#f59e0b;"></div> EMA 9</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#3b82f6;"></div> EMA 21</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#8b5cf6;"></div> EMA 50</div>
                        <div class="legend-item-mtf" style="border-left: 1px solid var(--border); padding-left: 8px; margin-left: 8px;"><div class="legend-color-mtf" style="background:#22c55e; border-style: dashed;"></div> SQ9 Sup</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#ef4444; border-style: dashed;"></div> SQ9 Res</div>
                    </div>
                    <div class="fib-levels-mtf" id="positionFib"></div>
                </div>
            </div>

            <!-- Chart Info Card -->
            <div class="card">
                <div class="card-title"> Chart Type Guide</div>
                <div class="grid grid-3" style="gap: 15px;">
                    <div style="background: rgba(245,158,11,0.1); padding: 12px; border-radius: 8px;">
                        <h4 style="font-size: 12px; color: var(--intraday); margin-bottom: 6px;"> Intraday (5-15 min)</h4>
                        <p style="font-size: 11px; color: var(--muted);">Short-term scalping & day trading. Best for 0-1 DTE options.</p>
                    </div>
                    <div style="background: rgba(139,92,246,0.1); padding: 12px; border-radius: 8px;">
                        <h4 style="font-size: 12px; color: var(--swing); margin-bottom: 6px;"> Swing (Daily/Weekly)</h4>
                        <p style="font-size: 11px; color: var(--muted);">Medium-term swing trades. Best for 3-14 DTE options.</p>
                    </div>
                    <div style="background: rgba(16,185,129,0.1); padding: 12px; border-radius: 8px;">
                        <h4 style="font-size: 12px; color: var(--success); margin-bottom: 6px;"> Position (Monthly)</h4>
                        <p style="font-size: 11px; color: var(--muted);">Long-term position trades. Best for 30+ DTE options.</p>
                    </div>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                    <div class="grid grid-4" style="gap: 15px;">
                        <div>
                            <h4 style="font-size: 11px; color: var(--text); margin-bottom: 4px;"> Candlestick</h4>
                            <p style="font-size: 10px; color: var(--muted);">Traditional OHLC candles showing price action.</p>
                        </div>
                        <div>
                            <h4 style="font-size: 11px; color: var(--text); margin-bottom: 4px;"> Heikin Ashi</h4>
                            <p style="font-size: 10px; color: var(--muted);">Smoothed candles that filter noise.</p>
                        </div>
                        <div>
                            <h4 style="font-size: 11px; color: var(--text); margin-bottom: 4px;"> Line</h4>
                            <p style="font-size: 10px; color: var(--muted);">Simple line chart for trend clarity.</p>
                        </div>
                        <div>
                            <h4 style="font-size: 11px; color: var(--text); margin-bottom: 4px;"> Point & Figure</h4>
                            <p style="font-size: 10px; color: var(--muted);">X's and O's with pattern detection.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>




        <!-- OPTIONS CALCULATOR TAB -->
        <div id="options-calc" class="tab-content">
            <div class="options-calc-container">
                <div class="calc-inputs">
                    <h3> Options Profit Calculator</h3>
                    <button class="use-current-btn" onclick="useCurrentSymbolPrice()">
                         Use Current Symbol Price
                    </button>

                    <div class="calc-form-group">
                        <label>Selected Symbol</label>
                        <input type="text" id="calcSymbol" value="SPY" readonly style="background: var(--bg); font-weight: 700;">
                    </div>

                    <div class="calc-row">
                        <div class="calc-form-group">
                            <label>Stock Price ($)</label>
                            <input type="number" id="calcStockPrice" value="500" step="0.01" onchange="calculateOptions()">
                        </div>
                        <div class="calc-form-group">
                            <label>Strike Price ($)</label>
                            <input type="number" id="calcStrikePrice" value="500" step="1" onchange="calculateOptions()">
                        </div>
                    </div>

                    <div class="calc-row">
                        <div class="calc-form-group">
                            <label>Days to Expiration</label>
                            <input type="number" id="calcDTE" value="7" min="1" max="365" onchange="calculateOptions()">
                        </div>
                        <div class="calc-form-group">
                            <label>Contracts</label>
                            <input type="number" id="calcContracts" value="1" min="1" max="1000" onchange="calculateOptions()">
                        </div>
                    </div>

                    <div class="calc-row">
                        <div class="calc-form-group">
                            <label>Implied Volatility (%)</label>
                            <input type="number" id="calcIV" value="20" step="0.1" min="1" max="200" onchange="calculateOptions()">
                        </div>
                        <div class="calc-form-group">
                            <label>Risk-Free Rate (%)</label>
                            <input type="number" id="calcRiskFree" value="5.0" step="0.1" min="0" max="20" onchange="calculateOptions()">
                        </div>
                    </div>

                    <div class="calc-form-group">
                        <label>Option Type</label>
                        <div class="option-type-toggle">
                            <button class="option-type-btn call active" onclick="setOptionType('call')"> CALL</button>
                            <button class="option-type-btn put" onclick="setOptionType('put')"> PUT</button>
                        </div>
                    </div>
                </div>

                <div class="calc-results">
                    <div class="calc-result-card">
                        <h4> Option Valuation</h4>
                        <div class="result-grid">
                            <div class="result-item">
                                <div class="label">Option Price</div>
                                <div class="value" id="calcOptionPrice">$0.00</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Total Cost</div>
                                <div class="value" id="calcTotalCost">$0.00</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Intrinsic Value</div>
                                <div class="value" id="calcIntrinsic">$0.00</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Extrinsic Value</div>
                                <div class="value" id="calcExtrinsic">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="calc-result-card">
                        <h4> Profit and Loss</h4>
                        <div class="result-grid">
                            <div class="result-item">
                                <div class="label">Breakeven</div>
                                <div class="value" id="calcBreakeven">$0.00</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Max Loss</div>
                                <div class="value negative" id="calcMaxLoss">$0.00</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Max Profit</div>
                                <div class="value positive" id="calcMaxProfit">Unlimited</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Risk/Reward</div>
                                <div class="value" id="calcRiskReward">--</div>
                            </div>
                        </div>
                    </div>

                    <div class="calc-result-card">
                        <h4> The Greeks</h4>
                        <div class="greeks-grid">
                            <div class="greek-item">
                                <div class="greek-name">Delta</div>
                                <div class="greek-value" id="calcDelta">0.00</div>
                            </div>
                            <div class="greek-item">
                                <div class="greek-name">Gamma</div>
                                <div class="greek-value" id="calcGamma">0.00</div>
                            </div>
                            <div class="greek-item">
                                <div class="greek-name">Theta</div>
                                <div class="greek-value" id="calcTheta">0.00</div>
                            </div>
                            <div class="greek-item">
                                <div class="greek-name">Vega</div>
                                <div class="greek-value" id="calcVega">0.00</div>
                            </div>
                        </div>

                        <div class="greeks-reference">
                            <h5> Greeks Quick Reference</h5>
                            <table>
                                <tr><td><strong>Delta</strong></td><td>Price change per $1 move in stock</td></tr>
                                <tr><td><strong>Gamma</strong></td><td>Rate of change in Delta per $1 move</td></tr>
                                <tr><td><strong>Theta</strong></td><td>Daily time decay (premium lost per day)</td></tr>
                                <tr><td><strong>Vega</strong></td><td>Price change per 1% change in IV</td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MTF BIAS TAB -->
        <div id="mtf-bias" class="tab-content">
            <div class="card" style="margin-bottom: 20px;">
                <h2 style="margin-bottom: 20px;"> Multi-Timeframe Bias Log</h2>

                <!-- Current MTF Summary -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: rgba(245,158,11,0.1); border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 12px; color: #666;"> INTRADAY</div>
                        <div style="font-size: 11px; color: #666;">15 Min / 1 Hour</div>
                        <div style="font-size: 28px; font-weight: 700; color: #22c55e; margin: 10px 0;" id="mtfIntradayBias">BULLISH</div>
                        <div style="font-size: 11px; color: #666;">Updated: 11:30 AM</div>
                    </div>
                    <div style="background: rgba(59,130,246,0.1); border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 12px; color: #666;"> SWING</div>
                        <div style="font-size: 11px; color: #666;">Daily / 4 Hour</div>
                        <div style="font-size: 28px; font-weight: 700; color: #22c55e; margin: 10px 0;" id="mtfSwingBias">BULLISH</div>
                        <div style="font-size: 11px; color: #666;">Updated: Dec 10</div>
                    </div>
                    <div style="background: rgba(139,92,246,0.1); border: 2px solid #8b5cf6; border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 12px; color: #666;"> POSITION</div>
                        <div style="font-size: 11px; color: #666;">Weekly / Monthly</div>
                        <div style="font-size: 28px; font-weight: 700; color: #22c55e; margin: 10px 0;" id="mtfPositionBias">BULLISH</div>
                        <div style="font-size: 11px; color: #666;">Updated: Dec 6</div>
                    </div>
                    <div style="background: rgba(34,197,94,0.1); border: 2px solid #22c55e; border-radius: 12px; padding: 20px; text-align: center;">
                        <div style="font-size: 12px; color: #666;"> CONFLUENCE</div>
                        <div style="font-size: 11px; color: #666;">All Timeframes</div>
                        <div style="font-size: 28px; font-weight: 700; color: #22c55e; margin: 10px 0;" id="mtfConfluence">3/3</div>
                        <div style="font-size: 11px; color: #22c55e;">ALIGNED BULLISH</div>
                    </div>
                </div>

                <!-- Bias History -->
                <h3 style="margin-bottom: 15px;"> Bias Change History</h3>
                <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f0f0f0;">
                            <th style="padding: 10px; text-align: left;">DATE</th>
                            <th style="padding: 10px; text-align: center;">TIME</th>
                            <th style="padding: 10px; text-align: center;">TIMEFRAME</th>
                            <th style="padding: 10px; text-align: center;">PREV BIAS</th>
                            <th style="padding: 10px; text-align: center;">NEW BIAS</th>
                            <th style="padding: 10px; text-align: left;">TRIGGER</th>
                        </tr>
                    </thead>
                    <tbody id="mtfHistoryBody">
                        <!-- Populated by updateMTFBiasHistory() -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- GANN RULES TAB -->
        <div id="gann-rules" class="tab-content">

            <!-- Pre-Trade Checklist -->
            <div class="card" style="margin-bottom: 20px; border: 2px solid #f59e0b;">
                <div style="padding: 12px 15px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 8px 8px 0 0;">
                    <h3 style="margin: 0; color: white; font-size: 16px;"> PRE-TRADE CHECKLIST (All Must Be Met)</h3>
                </div>
                <div style="padding: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- CALLS Checklist -->
                        <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 15px;">
                            <h4 style="margin: 0 0 12px 0; color: #166534; font-size: 14px;"> FOR CALLS (Long)</h4>
                            <div style="font-size: 12px; line-height: 2;">
                                <div> Price at Gann 1x1 angle <strong>support</strong> from major low</div>
                                <div> Within <strong>3 days</strong> of cycle turn date</div>
                                <div> Price <strong>above 50%</strong> retracement level</div>
                                <div> Square of 9 <strong>support</strong> within 1%</div>
                                <div> Volume <strong>above average</strong></div>
                                <div> Master Confluence Score <strong> 50/100</strong></div>
                                <div> Market Guard Rail <strong>2/3 or 3/3</strong></div>
                            </div>
                        </div>
                        <!-- PUTS Checklist -->
                        <div style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 8px; padding: 15px;">
                            <h4 style="margin: 0 0 12px 0; color: #991b1b; font-size: 14px;"> FOR PUTS (Short)</h4>
                            <div style="font-size: 12px; line-height: 2;">
                                <div> Price at Gann 1x1 angle <strong>resistance</strong> from major high</div>
                                <div> Within <strong>3 days</strong> of cycle turn date</div>
                                <div> Price <strong>below 50%</strong> retracement level</div>
                                <div> Square of 9 <strong>resistance</strong> within 1%</div>
                                <div> Volume <strong>above average</strong></div>
                                <div> Master Confluence Score <strong> 50/100</strong></div>
                                <div> Market Guard Rail <strong>2/3 or 3/3</strong></div>
                            </div>
                        </div>
                    </div>

                    <!-- Position Sizing -->
                    <div style="margin-top: 15px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <h4 style="margin: 0 0 10px 0; color: #1e293b; font-size: 13px;"> POSITION SIZING (Gann Rules)</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 11px;">
                            <div style="text-align: center; padding: 8px; background: white; border-radius: 6px;">
                                <div style="color: #64748b;">Per Trade Risk</div>
                                <div style="font-weight: bold; color: #1e293b; font-size: 14px;">3.125%</div>
                                <div style="color: #64748b; font-size: 10px;">(1/32 of account)</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: white; border-radius: 6px;">
                                <div style="color: #64748b;">Max All Positions</div>
                                <div style="font-weight: bold; color: #1e293b; font-size: 14px;">12.5%</div>
                                <div style="color: #64748b; font-size: 10px;">(1/8 of account)</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: white; border-radius: 6px;">
                                <div style="color: #64748b;">Pyramid Units</div>
                                <div style="font-weight: bold; color: #1e293b; font-size: 14px;">3 Units</div>
                                <div style="color: #64748b; font-size: 10px;">(1/3 at entry, 1/3 at +12.5%, 1/3 at +25%)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Stop Loss Rules -->
                    <div style="margin-top: 15px; padding: 12px; background: #fef2f2; border-radius: 8px; border: 1px solid #fca5a5;">
                        <h4 style="margin: 0 0 10px 0; color: #991b1b; font-size: 13px;"> STOP LOSS PLACEMENT</h4>
                        <div style="font-size: 11px; color: #7f1d1d; line-height: 1.8;">
                            <div> Place stop below nearest <strong>1/8 vibration level</strong> (12.5% divisions)</div>
                            <div> Or below <strong>Square of 9 support</strong> level</div>
                            <div> Never risk more than <strong>3.125%</strong> of account per trade</div>
                            <div> Move stop to <strong>breakeven</strong> after +25% profit</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 20px;">
                <h2 style="margin-bottom: 20px;"> W.D. Gann Trading Rules</h2>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                    <div style="background: rgba(139,92,246,0.05); border: 1px solid rgba(139,92,246,0.3); border-radius: 12px; padding: 20px;">
                        <h3 style="color: #8b5cf6; margin-bottom: 15px;"> Time Rules</h3>
                        <ol style="font-size: 12px; line-height: 2; padding-left: 20px;">
                            <li><strong>Time is more important than price</strong> - Wait for cycle dates</li>
                            <li><strong>Markets change trend every 30, 60, 90 days</strong></li>
                            <li><strong>Watch for turns at anniversaries</strong> of major highs/lows</li>
                            <li><strong>Seasonal changes</strong> - Equinoxes and Solstices matter</li>
                            <li><strong>7-day and 52-week cycles</strong> are critical</li>
                        </ol>
                    </div>
                    <div style="background: rgba(245,158,11,0.05); border: 1px solid rgba(245,158,11,0.3); border-radius: 12px; padding: 20px;">
                        <h3 style="color: #f59e0b; margin-bottom: 15px;"> Price Rules</h3>
                        <div style="display: grid; gap: 8px;">
                            <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 6px; padding: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700;"> ACTIVE</span>
                                    <span style="font-weight: 600;">1. Price moves in squares</span>
                                </div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">Using Square of 9 levels  See SQ9 Scanner tab</div>
                            </div>
                            <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 6px; padding: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700;"> ACTIVE</span>
                                    <span style="font-weight: 600;">2. Support/Resistance at 45 angles</span>
                                </div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">SQ9 levels are 45 angle projections from pivot  See Daily Analysis</div>
                            </div>
                            <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 6px; padding: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700;"> ACTIVE</span>
                                    <span style="font-weight: 600;">3. Divide range by 8ths</span>
                                </div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">8ths retracement levels calculated  See Gann 8ths panel in Daily Analysis</div>
                            </div>
                            <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 6px; padding: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700;"> ACTIVE</span>
                                    <span style="font-weight: 600;">4. Watch 50% retracement</span>
                                </div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">50% level highlighted as critical S/R  Controls bullish/bearish bias</div>
                            </div>
                            <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 6px; padding: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700;"> ACTIVE</span>
                                    <span style="font-weight: 600;">5. Price crosses square = reversal</span>
                                </div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">SQ9 level breaks detected  Alerts shown in Daily Analysis</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(34,197,94,0.05); border: 2px solid #22c55e; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #22c55e; margin-bottom: 15px;"> Gann's 28 Trading Rules</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 11px;">
                        <div>1. Never risk more than 10% of capital on single trade</div>
                        <div>2. Always use stop-loss orders</div>
                        <div>3. Never overtrade</div>
                        <div>4. Never let profit turn into loss</div>
                        <div>5. Don't enter if unsure - wait for clear signal</div>
                        <div>6. Trade with the trend</div>
                        <div>7. When in doubt, get out</div>
                        <div>8. Trade active markets only</div>
                        <div>9. Never average a losing position</div>
                        <div>10. Never get out without a good reason</div>
                        <div>11. Bank surplus profits in reserve</div>
                        <div>12. Never buy/sell just for a scalp</div>
                        <div>13. Never move stop loss against you</div>
                        <div>14. Don't get out prematurely</div>
                        <div>15. Avoid small trades, go for big moves</div>
                        <div>16. Don't close trades without reason</div>
                        <div>17. Add to position only when trend confirmed</div>
                        <div>18. Never hedge a losing position</div>
                        <div>19. Never change position without reason</div>
                        <div>20. Avoid increasing bets after wins</div>
                        <div>21. Don't guess tops or bottoms</div>
                        <div>22. Never follow blind tips</div>
                        <div>23. Reduce trading after first loss</div>
                        <div>24. Avoid wrong entries and exits</div>
                        <div>25. Take equal sized profits</div>
                        <div>26. Never cancel a stop loss</div>
                        <div>27. Avoid frequent entries/exits</div>
                        <div>28. Be willing to make money both ways</div>
                    </div>
                </div>

                <div style="background: rgba(59,130,246,0.05); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; padding: 20px;">
                    <h3 style="color: #3b82f6; margin-bottom: 15px;"> Square of 9 Quick Reference</h3>
                    <div style="font-size: 12px; line-height: 1.8;">
                        <p><strong>How to calculate:</strong></p>
                        <ul style="padding-left: 20px;">
                            <li>Find square root of current price: sqrt(687) = 26.21</li>
                            <li>Add/subtract degrees: 45deg = 0.25, 90deg = 0.5, 180deg = 1.0, 360deg = 2.0</li>
                            <li>Square the result for next level</li>
                            <li><strong>Example:</strong> 26.21 + 0.25 = 26.46 squared = $700.13 (45deg up)</li>
                            <li><strong>Example:</strong> 26.21 - 0.25 = 25.96 squared = $673.92 (45deg down)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- REPORTS TAB -->
        <div id="reports" class="tab-content">
            <div class="card" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;"> Performance Reports</h2>
                    <div style="display: flex; gap: 10px;">
                        <select id="reportPeriod" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;">
                            <option>This Week</option>
                            <option>This Month</option>
                            <option>Last 30 Days</option>
                            <option>Last 90 Days</option>
                            <option>Year to Date</option>
                            <option>All Time</option>
                        </select>
                        <button style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;"> Export PDF</button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #22c55e, #16a34a); border-radius: 12px; padding: 20px; color: white;">
                        <div style="font-size: 11px; opacity: 0.9;">NET P&L</div>
                        <div style="font-size: 32px; font-weight: 700; margin: 5px 0;" id="reportNetPnl">+$12,450</div>
                        <div style="font-size: 11px; opacity: 0.8;"> 23% vs last period</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 12px; padding: 20px; color: white;">
                        <div style="font-size: 11px; opacity: 0.9;">TOTAL TRADES</div>
                        <div style="font-size: 32px; font-weight: 700; margin: 5px 0;" id="reportTotalTrades">156</div>
                        <div style="font-size: 11px; opacity: 0.8;">Avg 7.8/day</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 12px; padding: 20px; color: white;">
                        <div style="font-size: 11px; opacity: 0.9;">WIN RATE</div>
                        <div style="font-size: 32px; font-weight: 700; margin: 5px 0;" id="reportWinRate">71.2%</div>
                        <div style="font-size: 11px; opacity: 0.8;">111W / 45L</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 12px; padding: 20px; color: white;">
                        <div style="font-size: 11px; opacity: 0.9;">SHARPE RATIO</div>
                        <div style="font-size: 32px; font-weight: 700; margin: 5px 0;">2.34</div>
                        <div style="font-size: 11px; opacity: 0.8;">Risk-adjusted return</div>
                    </div>
                </div>

                <!-- Performance by Strategy -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div style="background: #f8fafc; border-radius: 12px; padding: 20px;">
                        <h3 style="margin-bottom: 15px; font-size: 14px;"> Performance by Signal Type</h3>
                        <table style="width: 100%; font-size: 11px;">
                            <thead>
                                <tr style="border-bottom: 2px solid #ddd;">
                                    <th style="padding: 8px; text-align: left;">Signal</th>
                                    <th style="padding: 8px; text-align: center;">Trades</th>
                                    <th style="padding: 8px; text-align: center;">Win Rate</th>
                                    <th style="padding: 8px; text-align: right;">P&L</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px;"><span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px;">ULTRA (4/4)</span></td>
                                    <td style="padding: 8px; text-align: center;">23</td>
                                    <td style="padding: 8px; text-align: center; color: #22c55e; font-weight: 600;">89%</td>
                                    <td style="padding: 8px; text-align: right; color: #22c55e; font-weight: 600;">+$5,230</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px;"><span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px;">SUPER (3/4)</span></td>
                                    <td style="padding: 8px; text-align: center;">58</td>
                                    <td style="padding: 8px; text-align: center; color: #22c55e; font-weight: 600;">78%</td>
                                    <td style="padding: 8px; text-align: right; color: #22c55e; font-weight: 600;">+$4,890</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px;"><span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px;">Standard (2/4)</span></td>
                                    <td style="padding: 8px; text-align: center;">52</td>
                                    <td style="padding: 8px; text-align: center; color: #eab308; font-weight: 600;">62%</td>
                                    <td style="padding: 8px; text-align: right; color: #22c55e; font-weight: 600;">+$1,980</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px;"><span style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 4px;">Weak (1/4)</span></td>
                                    <td style="padding: 8px; text-align: center;">23</td>
                                    <td style="padding: 8px; text-align: center; color: #ef4444; font-weight: 600;">48%</td>
                                    <td style="padding: 8px; text-align: right; color: #22c55e; font-weight: 600;">+$350</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="background: #f8fafc; border-radius: 12px; padding: 20px;">
                        <h3 style="margin-bottom: 15px; font-size: 14px;"> Performance by Symbol</h3>
                        <table style="width: 100%; font-size: 11px;">
                            <thead>
                                <tr style="border-bottom: 2px solid #ddd;">
                                    <th style="padding: 8px; text-align: left;">Symbol</th>
                                    <th style="padding: 8px; text-align: center;">Trades</th>
                                    <th style="padding: 8px; text-align: center;">Win Rate</th>
                                    <th style="padding: 8px; text-align: right;">P&L</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px; font-weight: 600;">SPY</td>
                                    <td style="padding: 8px; text-align: center;">78</td>
                                    <td style="padding: 8px; text-align: center; color: #22c55e;">74%</td>
                                    <td style="padding: 8px; text-align: right; color: #22c55e; font-weight: 600;">+$6,450</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px; font-weight: 600;">QQQ</td>
                                    <td style="padding: 8px; text-align: center;">45</td>
                                    <td style="padding: 8px; text-align: center; color: #22c55e;">71%</td>
                                    <td style="padding: 8px; text-align: right; color: #22c55e; font-weight: 600;">+$3,280</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px; font-weight: 600;">IWM</td>
                                    <td style="padding: 8px; text-align: center;">22</td>
                                    <td style="padding: 8px; text-align: center; color: #eab308;">65%</td>
                                    <td style="padding: 8px; text-align: right; color: #22c55e; font-weight: 600;">+$1,890</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; font-weight: 600;">XLF</td>
                                    <td style="padding: 8px; text-align: center;">11</td>
                                    <td style="padding: 8px; text-align: center; color: #22c55e;">72%</td>
                                    <td style="padding: 8px; text-align: right; color: #22c55e; font-weight: 600;">+$830</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Agent Performance -->
                <div style="background: #f8fafc; border-radius: 12px; padding: 20px;">
                    <h3 style="margin-bottom: 15px; font-size: 14px;"> Agent Performance Breakdown</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <div style="font-size: 12px; font-weight: 600; color: #3b82f6; margin-bottom: 10px;">Base Confluence</div>
                            <div style="font-size: 28px; font-weight: 700; color: #22c55e;">68%</div>
                            <div style="font-size: 10px; color: #666;">Win Rate</div>
                            <div style="font-size: 11px; color: #22c55e; margin-top: 5px;">+$3,120 P&L</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <div style="font-size: 12px; font-weight: 600; color: #8b5cf6; margin-bottom: 10px;">Gann-Elliott</div>
                            <div style="font-size: 28px; font-weight: 700; color: #22c55e;">72%</div>
                            <div style="font-size: 10px; color: #666;">Win Rate</div>
                            <div style="font-size: 11px; color: #22c55e; margin-top: 5px;">+$4,560 P&L</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <div style="font-size: 12px; font-weight: 600; color: #f59e0b; margin-bottom: 10px;">DQN (ML)</div>
                            <div style="font-size: 28px; font-weight: 700; color: #22c55e;">71%</div>
                            <div style="font-size: 10px; color: #666;">Win Rate</div>
                            <div style="font-size: 11px; color: #22c55e; margin-top: 5px;">+$3,890 P&L</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <div style="font-size: 12px; font-weight: 600; color: #22c55e; margin-bottom: 10px;">3-Wave</div>
                            <div style="font-size: 28px; font-weight: 700; color: #22c55e;">66%</div>
                            <div style="font-size: 10px; color: #666;">Win Rate</div>
                            <div style="font-size: 11px; color: #22c55e; margin-top: 5px;">+$2,780 P&L</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADVANCED OPTIONS CALCULATOR TAB -->
        <div id="options-calc-advanced" class="tab-content">
            <div class="card" style="margin-bottom: 20px;">
                <h2 style="margin-bottom: 20px;"> Advanced Options Calculator</h2>

                <!-- Input Section -->
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; margin-bottom: 25px; background: #f8fafc; padding: 20px; border-radius: 12px;">
                    <div>
                        <label style="font-size: 10px; color: #666; display: block; margin-bottom: 5px;">UNDERLYING</label>
                        <div id="optCalcSymbolBadge" style="padding: 10px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-radius: 6px; font-size: 13px; font-weight: 700; text-align: center;">SPY - $607</div>
                        <input type="hidden" id="optCalcSymbol" value="607.15">
                    </div>
                    <div>
                        <label style="font-size: 10px; color: #666; display: block; margin-bottom: 5px;">STRIKE PRICE</label>
                        <input type="number" id="optCalcStrike" value="610" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" onchange="updateOptionsCalc()">
                    </div>
                    <div>
                        <label style="font-size: 10px; color: #666; display: block; margin-bottom: 5px;">DAYS TO EXPIRY</label>
                        <input type="number" id="optCalcDTE" value="7" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" onchange="updateOptionsCalc()">
                    </div>
                    <div>
                        <label style="font-size: 10px; color: #666; display: block; margin-bottom: 5px;">IMPLIED VOL %</label>
                        <input type="number" id="optCalcIV" value="18" step="0.5" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" onchange="updateOptionsCalc()">
                    </div>
                    <div>
                        <label style="font-size: 10px; color: #666; display: block; margin-bottom: 5px;">RISK-FREE RATE %</label>
                        <input type="number" id="optCalcRate" value="5.25" step="0.25" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" onchange="updateOptionsCalc()">
                    </div>
                    <div>
                        <label style="font-size: 10px; color: #666; display: block; margin-bottom: 5px;">OPTION TYPE</label>
                        <select id="optCalcType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" onchange="updateOptionsCalc()">
                            <option value="call"> CALL</option>
                            <option value="put"> PUT</option>
                        </select>
                    </div>
                </div>

                <!-- Results Grid -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px;">
                    <!-- Option Price -->
                    <div style="background: linear-gradient(135deg, #22c55e, #16a34a); border-radius: 12px; padding: 20px; color: white; text-align: center;">
                        <div style="font-size: 11px; opacity: 0.9;">THEORETICAL PRICE</div>
                        <div style="font-size: 36px; font-weight: 700; margin: 10px 0;" id="optPriceResult">$4.82</div>
                        <div style="font-size: 11px; opacity: 0.8;">Black-Scholes Model</div>
                    </div>

                    <!-- Intrinsic Value -->
                    <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 12px; padding: 20px; color: white; text-align: center;">
                        <div style="font-size: 11px; opacity: 0.9;">INTRINSIC VALUE</div>
                        <div style="font-size: 36px; font-weight: 700; margin: 10px 0;" id="optIntrinsicResult">$0.00</div>
                        <div style="font-size: 11px; opacity: 0.8;">In/Out of Money</div>
                    </div>

                    <!-- Time Value -->
                    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 12px; padding: 20px; color: white; text-align: center;">
                        <div style="font-size: 11px; opacity: 0.9;">TIME VALUE</div>
                        <div style="font-size: 36px; font-weight: 700; margin: 10px 0;" id="optTimeValueResult">$4.82</div>
                        <div style="font-size: 11px; opacity: 0.8;">Extrinsic Premium</div>
                    </div>

                    <!-- Break Even -->
                    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 12px; padding: 20px; color: white; text-align: center;">
                        <div style="font-size: 11px; opacity: 0.9;">BREAK EVEN</div>
                        <div style="font-size: 36px; font-weight: 700; margin: 10px 0;" id="optBreakEvenResult">$614.82</div>
                        <div style="font-size: 11px; opacity: 0.8;">At Expiration</div>
                    </div>
                </div>

                <!-- Greeks Section -->
                <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px; font-size: 14px;"> The Greeks</h3>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px;">
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 2px solid #22c55e;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">DELTA ()</div>
                            <div style="font-size: 28px; font-weight: 700; color: #22c55e;" id="greekDelta">0.52</div>
                            <div style="font-size: 10px; color: #666; margin-top: 5px;">$52 per $1 move</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 2px solid #3b82f6;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">GAMMA ()</div>
                            <div style="font-size: 28px; font-weight: 700; color: #3b82f6;" id="greekGamma">0.018</div>
                            <div style="font-size: 10px; color: #666; margin-top: 5px;">Delta acceleration</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 2px solid #ef4444;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">THETA ()</div>
                            <div style="font-size: 28px; font-weight: 700; color: #ef4444;" id="greekTheta">-0.42</div>
                            <div style="font-size: 10px; color: #666; margin-top: 5px;">-$42/day decay</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 2px solid #8b5cf6;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">VEGA ()</div>
                            <div style="font-size: 28px; font-weight: 700; color: #8b5cf6;" id="greekVega">0.85</div>
                            <div style="font-size: 10px; color: #666; margin-top: 5px;">$85 per 1% IV</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 2px solid #f59e0b;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">RHO ()</div>
                            <div style="font-size: 28px; font-weight: 700; color: #f59e0b;" id="greekRho">0.08</div>
                            <div style="font-size: 10px; color: #666; margin-top: 5px;">Interest rate sens.</div>
                        </div>
                    </div>
                </div>

                <!-- P&L Scenarios -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="background: #f8fafc; border-radius: 12px; padding: 20px;">
                        <h3 style="margin-bottom: 15px; font-size: 14px;"> P&L Scenarios at Expiration</h3>
                        <table style="width: 100%; font-size: 11px;">
                            <thead>
                                <tr style="border-bottom: 2px solid #ddd;">
                                    <th style="padding: 8px; text-align: left;">Price Move</th>
                                    <th style="padding: 8px; text-align: center;">Underlying</th>
                                    <th style="padding: 8px; text-align: right;">Option P&L</th>
                                    <th style="padding: 8px; text-align: right;">% Return</th>
                                </tr>
                            </thead>
                            <tbody id="pnlScenarios">
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px;">+3%</td>
                                    <td style="padding: 8px; text-align: center;">$625.37</td>
                                    <td style="padding: 8px; text-align: right; color: #22c55e; font-weight: 600;">+$1,055</td>
                                    <td style="padding: 8px; text-align: right; color: #22c55e;">+219%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px;">+2%</td>
                                    <td style="padding: 8px; text-align: center;">$619.29</td>
                                    <td style="padding: 8px; text-align: right; color: #22c55e; font-weight: 600;">+$447</td>
                                    <td style="padding: 8px; text-align: right; color: #22c55e;">+93%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px;">+1%</td>
                                    <td style="padding: 8px; text-align: center;">$613.22</td>
                                    <td style="padding: 8px; text-align: right; color: #22c55e; font-weight: 600;">+$140</td>
                                    <td style="padding: 8px; text-align: right; color: #22c55e;">+29%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px;">0%</td>
                                    <td style="padding: 8px; text-align: center;">$607.15</td>
                                    <td style="padding: 8px; text-align: right; color: #ef4444; font-weight: 600;">-$482</td>
                                    <td style="padding: 8px; text-align: right; color: #ef4444;">-100%</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px;">-1%</td>
                                    <td style="padding: 8px; text-align: center;">$601.08</td>
                                    <td style="padding: 8px; text-align: right; color: #ef4444; font-weight: 600;">-$482</td>
                                    <td style="padding: 8px; text-align: right; color: #ef4444;">-100%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="background: #f8fafc; border-radius: 12px; padding: 20px;">
                        <h3 style="margin-bottom: 15px; font-size: 14px;"> Time Decay Analysis</h3>
                        <table style="width: 100%; font-size: 11px;">
                            <thead>
                                <tr style="border-bottom: 2px solid #ddd;">
                                    <th style="padding: 8px; text-align: left;">Days Left</th>
                                    <th style="padding: 8px; text-align: center;">Option Value</th>
                                    <th style="padding: 8px; text-align: right;">Daily Decay</th>
                                    <th style="padding: 8px; text-align: right;">Cumulative</th>
                                </tr>
                            </thead>
                            <tbody id="thetaDecay">
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px;">7 (Today)</td>
                                    <td style="padding: 8px; text-align: center;">$4.82</td>
                                    <td style="padding: 8px; text-align: right;">-$0.42</td>
                                    <td style="padding: 8px; text-align: right;">$0.00</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px;">5</td>
                                    <td style="padding: 8px; text-align: center;">$3.98</td>
                                    <td style="padding: 8px; text-align: right;">-$0.52</td>
                                    <td style="padding: 8px; text-align: right; color: #ef4444;">-$0.84</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px;">3</td>
                                    <td style="padding: 8px; text-align: center;">$2.94</td>
                                    <td style="padding: 8px; text-align: right;">-$0.68</td>
                                    <td style="padding: 8px; text-align: right; color: #ef4444;">-$1.88</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 8px;">1</td>
                                    <td style="padding: 8px; text-align: center;">$1.58</td>
                                    <td style="padding: 8px; text-align: right;">-$0.95</td>
                                    <td style="padding: 8px; text-align: right; color: #ef4444;">-$3.24</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px;">0 (Expiry)</td>
                                    <td style="padding: 8px; text-align: center;">$0.00</td>
                                    <td style="padding: 8px; text-align: right;">-</td>
                                    <td style="padding: 8px; text-align: right; color: #ef4444;">-$4.82</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- GANN CYCLES TAB -->
        <div id="gann-cycles" class="tab-content">

            <!-- Pivot Timelines -->
            <div class="card" style="margin-bottom: 20px;">
                <h3 style="font-size: 14px; margin-bottom: 15px; color: #1e293b;"> Major Pivots & Cycle Timeline</h3>

                <!-- SPY Low Pivot -->
                <div style="background: #f8fafc; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <span style="font-weight: 600; font-size: 15px; color: #1e293b;">SPY</span>
                            <span style="font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 10px; background: #dcfce7; color: #16a34a; margin-left: 8px;">LOW</span>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: #1e293b;">Apr 7, 2025</div>
                            <div style="font-size: 12px; color: #64748b;">$506.22</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 8px;">
                        <div style="text-align: center; flex: 1; min-width: 55px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e; margin: 0 auto 4px;"></div>
                            <div style="font-size: 10px; color: #888;">49d</div>
                            <div style="font-size: 9px; color: #666;">May 26</div>
                        </div>
                        <div style="text-align: center; flex: 1; min-width: 55px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e; margin: 0 auto 4px;"></div>
                            <div style="font-size: 10px; color: #888;">90d</div>
                            <div style="font-size: 9px; color: #666;">Jul 6</div>
                        </div>
                        <div style="text-align: center; flex: 1; min-width: 55px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e; margin: 0 auto 4px;"></div>
                            <div style="font-size: 10px; color: #888;">120d</div>
                            <div style="font-size: 9px; color: #666;">Aug 5</div>
                        </div>
                        <div style="text-align: center; flex: 1; min-width: 55px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e; margin: 0 auto 4px;"></div>
                            <div style="font-size: 10px; color: #888;">144d</div>
                            <div style="font-size: 9px; color: #666;">Aug 29</div>
                        </div>
                        <div style="text-align: center; flex: 1; min-width: 55px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e; margin: 0 auto 4px;"></div>
                            <div style="font-size: 10px; color: #888;">180d</div>
                            <div style="font-size: 9px; color: #666;">Oct 4</div>
                        </div>
                        <div style="text-align: center; flex: 1; min-width: 55px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #ef4444; margin: 0 auto 4px; animation: gannPulse 1s infinite;"></div>
                            <div style="font-size: 10px; color: #ef4444; font-weight: 600;">270d</div>
                            <div style="font-size: 9px; color: #ef4444;">Jan 2 </div>
                        </div>
                        <div style="text-align: center; flex: 1; min-width: 55px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #9ca3af; margin: 0 auto 4px;"></div>
                            <div style="font-size: 10px; color: #888;">360d</div>
                            <div style="font-size: 9px; color: #666;">Apr 2</div>
                        </div>
                    </div>
                </div>

                <!-- SPY ATH Pivot -->
                <div style="background: #f8fafc; border-radius: 10px; padding: 15px; border: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div>
                            <span style="font-weight: 600; font-size: 15px; color: #1e293b;">SPY</span>
                            <span style="font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 10px; background: #fee2e2; color: #dc2626; margin-left: 8px;">HIGH</span>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: #1e293b;">Feb 19, 2025</div>
                            <div style="font-size: 12px; color: #64748b;">$614.42</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 8px;">
                        <div style="text-align: center; flex: 1; min-width: 55px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e; margin: 0 auto 4px;"></div>
                            <div style="font-size: 10px; color: #22c55e;">49d </div>
                            <div style="font-size: 9px; color: #666;">Apr 7</div>
                        </div>
                        <div style="text-align: center; flex: 1; min-width: 55px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e; margin: 0 auto 4px;"></div>
                            <div style="font-size: 10px; color: #22c55e;">90d </div>
                            <div style="font-size: 9px; color: #666;">May 20</div>
                        </div>
                        <div style="text-align: center; flex: 1; min-width: 55px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e; margin: 0 auto 4px;"></div>
                            <div style="font-size: 10px; color: #888;">180d</div>
                            <div style="font-size: 9px; color: #666;">Aug 18</div>
                        </div>
                        <div style="text-align: center; flex: 1; min-width: 55px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #22c55e; margin: 0 auto 4px;"></div>
                            <div style="font-size: 10px; color: #888;">270d</div>
                            <div style="font-size: 9px; color: #666;">Nov 16</div>
                        </div>
                        <div style="text-align: center; flex: 1; min-width: 55px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: #9ca3af; margin: 0 auto 4px;"></div>
                            <div style="font-size: 10px; color: #f59e0b;">360d</div>
                            <div style="font-size: 9px; color: #f59e0b;">Feb 14 </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trade Rec, Sq9, Calculator Row -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">

                <!-- Trade Recommendation -->
                <div class="card" style="background: white; border: 2px solid #8b5cf6;">
                    <h3 style="font-size: 14px; margin-bottom: 15px; color: #1e293b;"> Trade Recommendation</h3>
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="font-size: 11px; color: #64748b;">CURRENT SIGNAL</div>
                        <div id="gannTradeSignal" style="font-size: 24px; font-weight: 700; color: #d97706;"> WAIT</div>
                    </div>
                    <div style="font-size: 11px; color: #64748b; text-align: center; margin-bottom: 15px;">
                        270-day cycle from Apr 7 low approaches Jan 2, 2026.<br>
                        Expect potential pause or pullback.
                    </div>
                    <div style="background: #f8fafc; border-radius: 8px; padding: 12px; border: 1px solid #e2e8f0;">
                        <div style="font-size: 10px; font-weight: 600; color: #64748b; margin-bottom: 8px;">IF PULLBACK OCCURS (Jan 3-7):</div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 11px; border-bottom: 1px solid #e2e8f0;">
                            <span style="color: #64748b;">Action</span>
                            <span style="font-weight: 600; color: #16a34a;">BUY CALL</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 11px; border-bottom: 1px solid #e2e8f0;">
                            <span style="color: #64748b;">Symbol</span>
                            <span style="font-weight: 500; color: #1e293b;">SPY / QQQ / IWM</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 11px; border-bottom: 1px solid #e2e8f0;">
                            <span style="color: #64748b;">Expiration</span>
                            <span style="font-weight: 500; color: #1e293b;">45-60 DTE</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 11px; border-bottom: 1px solid #e2e8f0;">
                            <span style="color: #64748b;">Target</span>
                            <span style="font-weight: 600; color: #16a34a;">+100%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 11px;">
                            <span style="color: #64748b;">Stop</span>
                            <span style="font-weight: 600; color: #dc2626;">-50%</span>
                        </div>
                    </div>
                </div>

                <!-- Sq9 Levels -->
                <div class="card">
                    <h3 style="font-size: 14px; margin-bottom: 15px; color: #1e293b;"> Sq9 Support/Resistance - SPY</h3>
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="font-size: 11px; color: #64748b;">Current Price</div>
                        <div id="gannDashSq9Price" style="font-size: 24px; font-weight: 700; color: #1e293b;">$--</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div style="background: #f0fdf4; border-radius: 8px; padding: 10px; border: 1px solid #bbf7d0;">
                            <div style="font-size: 10px; font-weight: 600; color: #16a34a; margin-bottom: 8px;"> SUPPORT (62%)</div>
                            <div style="display: flex; justify-content: space-between; font-size: 11px; padding: 3px 0; border-bottom: 1px solid #dcfce7;">
                                <span style="color: #64748b;">-45</span>
                                <span style="font-weight: 500; color: #1e293b;">$591.82</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 11px; padding: 3px 0; border-bottom: 1px solid #dcfce7;">
                                <span style="color: #64748b;">-90</span>
                                <span style="font-weight: 500; color: #1e293b;">$585.42</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 11px; padding: 3px 0;">
                                <span style="color: #64748b;">-180</span>
                                <span style="font-weight: 500; color: #1e293b;">$572.78</span>
                            </div>
                        </div>
                        <div style="background: #fef2f2; border-radius: 8px; padding: 10px; border: 1px solid #fecaca;">
                            <div style="font-size: 10px; font-weight: 600; color: #dc2626; margin-bottom: 8px;"> RESISTANCE (41%)</div>
                            <div style="display: flex; justify-content: space-between; font-size: 11px; padding: 3px 0; border-bottom: 1px solid #fee2e2;">
                                <span style="color: #64748b;">+45</span>
                                <span style="font-weight: 500; color: #1e293b;">$604.75</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 11px; padding: 3px 0; border-bottom: 1px solid #fee2e2;">
                                <span style="color: #64748b;">+90</span>
                                <span style="font-weight: 500; color: #1e293b;">$611.28</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 11px; padding: 3px 0;">
                                <span style="color: #64748b;">+180</span>
                                <span style="font-weight: 500; color: #1e293b;">$624.50</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backtested Stats -->
                <div class="card">
                    <h3 style="font-size: 14px; margin-bottom: 15px; color: #1e293b;"> Backtested Performance</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 22px; font-weight: 700; color: #16a34a;">62%</div>
                            <div style="font-size: 10px; color: #64748b;">Sq9 Support Bounce</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 22px; font-weight: 700; color: #16a34a;">80%</div>
                            <div style="font-size: 10px; color: #64748b;">49-Day Jubilee</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 22px; font-weight: 700; color: #d97706;">67%</div>
                            <div style="font-size: 10px; color: #64748b;">90-Day Quarter</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 22px; font-weight: 700; color: #d97706;">60%</div>
                            <div style="font-size: 10px; color: #64748b;">Continuation</div>
                        </div>
                    </div>
                    <div style="padding: 10px; background: #f0fdf4; border-radius: 8px; font-size: 11px; border: 1px solid #bbf7d0;">
                        <div style="color: #64748b; margin-bottom: 5px;">Confirmed Across:</div>
                        <div style="color: #1e293b;"> SPY (32 years)   QQQ (40 years)   IWM (20 years)</div>
                    </div>
                </div>
            </div>

            <!-- Multi-ETF Status Table -->
            <div class="card" style="margin-bottom: 20px;">
                <h3 style="font-size: 14px; margin-bottom: 15px; color: #1e293b;"> Multi-ETF Cycle Status</h3>
                <div class="table-wrap">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 10px; text-align: left; color: #64748b;">Symbol</th>
                                <th style="padding: 10px; text-align: left; color: #64748b;">Price</th>
                                <th style="padding: 10px; text-align: left; color: #64748b;">From Last HIGH</th>
                                <th style="padding: 10px; text-align: left; color: #64748b;">From Last LOW</th>
                                <th style="padding: 10px; text-align: left; color: #64748b;">Nearest Cycle</th>
                                <th style="padding: 10px; text-align: left; color: #64748b;">Signal</th>
                            </tr>
                        </thead>
                        <tbody id="gannEtfTableBody">
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 12px 10px; font-weight: 600;">SPY</td>
                                <td id="gannDashTableSpyPrice" style="padding: 12px 10px; color: #64748b;">$--</td>
                                <td style="padding: 12px 10px;">
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span style="width: 8px; height: 8px; border-radius: 50%; background: #f59e0b;"></span>
                                        Day 316/360 (88%)
                                    </div>
                                </td>
                                <td style="padding: 12px 10px;">
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span style="width: 8px; height: 8px; border-radius: 50%; background: #ef4444;"></span>
                                        Day 268/270 (99%) 
                                    </div>
                                </td>
                                <td style="padding: 12px 10px;">270d - Jan 2</td>
                                <td style="padding: 12px 10px;"><span style="color: #f59e0b; font-weight: 600;">CAUTION</span></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 12px 10px; font-weight: 600;">QQQ</td>
                                <td id="gannDashTableQqqPrice" style="padding: 12px 10px; color: #64748b;">$--</td>
                                <td style="padding: 12px 10px;">
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span style="width: 8px; height: 8px; border-radius: 50%; background: #f59e0b;"></span>
                                        Day 316/360 (88%)
                                    </div>
                                </td>
                                <td style="padding: 12px 10px;">
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span style="width: 8px; height: 8px; border-radius: 50%; background: #ef4444;"></span>
                                        Day 268/270 (99%) 
                                    </div>
                                </td>
                                <td style="padding: 12px 10px;">270d - Jan 2</td>
                                <td style="padding: 12px 10px;"><span style="color: #f59e0b; font-weight: 600;">CAUTION</span></td>
                            </tr>
                            <tr>
                                <td style="padding: 12px 10px; font-weight: 600;">IWM</td>
                                <td id="gannDashTableIwmPrice" style="padding: 12px 10px; color: #64748b;">$--</td>
                                <td style="padding: 12px 10px;">
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span style="width: 8px; height: 8px; border-radius: 50%; background: #3b82f6;"></span>
                                        Day 401/720 (56%)
                                    </div>
                                </td>
                                <td style="padding: 12px 10px;">
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span style="width: 8px; height: 8px; border-radius: 50%; background: #ef4444;"></span>
                                        Day 268/270 (99%) 
                                    </div>
                                </td>
                                <td style="padding: 12px 10px;">270d - Jan 2</td>
                                <td style="padding: 12px 10px;"><span style="color: #f59e0b; font-weight: 600;">CAUTION</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Calendar Row -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- January Calendar -->
                <div class="card">
                    <h3 style="font-size: 14px; margin-bottom: 15px; color: #1e293b;"> January 2026 Cycle Calendar</h3>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
                        <div style="text-align: center; font-size: 10px; color: #64748b; padding: 6px;">Sun</div>
                        <div style="text-align: center; font-size: 10px; color: #64748b; padding: 6px;">Mon</div>
                        <div style="text-align: center; font-size: 10px; color: #64748b; padding: 6px;">Tue</div>
                        <div style="text-align: center; font-size: 10px; color: #64748b; padding: 6px;">Wed</div>
                        <div style="text-align: center; font-size: 10px; color: #64748b; padding: 6px;">Thu</div>
                        <div style="text-align: center; font-size: 10px; color: #64748b; padding: 6px;">Fri</div>
                        <div style="text-align: center; font-size: 10px; color: #64748b; padding: 6px;">Sat</div>

                        <div style="text-align: center; padding: 8px; font-size: 11px; background: #f8fafc; border-radius: 4px; color: #1e293b;"></div>
                        <div style="text-align: center; padding: 8px; font-size: 11px; background: #f8fafc; border-radius: 4px; color: #1e293b;"></div>
                        <div style="text-align: center; padding: 8px; font-size: 11px; background: #f8fafc; border-radius: 4px; color: #1e293b;"></div>
                        <div style="text-align: center; padding: 8px; font-size: 11px; background: #f8fafc; border-radius: 4px; color: #1e293b;"></div>
                        <div style="text-align: center; padding: 8px; font-size: 11px; background: #f8fafc; border-radius: 4px; color: #1e293b;">1</div>
                        <div style="text-align: center; padding: 8px; font-size: 11px; background: #fee2e2; border: 1px solid #fca5a5; border-radius: 4px; color: #dc2626; font-weight: 600;">2<br><span style="font-size:8px;">270d</span></div>
                        <div style="text-align: center; padding: 8px; font-size: 11px; background: #dcfce7; border: 1px solid #86efac; border-radius: 4px; color: #16a34a;">3</div>

                        <div style="text-align: center; padding: 8px; font-size: 11px; background: #dcfce7; border: 1px solid #86efac; border-radius: 4px; color: #16a34a;">4</div>
                        <div style="text-align: center; padding: 8px; font-size: 11px; background: #dcfce7; border: 1px solid #86efac; border-radius: 4px; color: #16a34a;">5</div>
                        <div style="text-align: center; padding: 8px; font-size: 11px; background: #dcfce7; border: 1px solid #86efac; border-radius: 4px; color: #16a34a;">6</div>
                        <div style="text-align: center; padding: 8px; font-size: 11px; background: #dcfce7; border: 1px solid #86efac; border-radius: 4px; color: #16a34a;">7</div>
                        <div style="text-align: center; padding: 8px; font-size: 11px; background: #f8fafc; border-radius: 4px; color: #1e293b;">8</div>
                        <div style="text-align: center; padding: 8px; font-size: 11px; background: #f8fafc; border-radius: 4px; color: #1e293b;">9</div>
                        <div style="text-align: center; padding: 8px; font-size: 11px; background: #f8fafc; border-radius: 4px; color: #1e293b;">10</div>
                    </div>
                    <div style="margin-top: 12px; font-size: 10px; color: #64748b;">
                        <span style="display: inline-block; width: 10px; height: 10px; background: #fecaca; border-radius: 2px; margin-right: 4px;"></span> Cycle Date
                        <span style="display: inline-block; width: 10px; height: 10px; background: #bbf7d0; border-radius: 2px; margin-left: 12px; margin-right: 4px;"></span> Entry Zone
                    </div>
                </div>

                <!-- Options Calculator -->
                <div class="card">
                    <h3 style="font-size: 14px; margin-bottom: 15px; color: #1e293b;"> Options Calculator</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Symbol</label>
                            <div id="gannOptSymbolBadge" style="width: 100%; padding: 8px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border-radius: 6px; font-size: 12px; font-weight: 700; text-align: center; box-sizing: border-box;">SPY</div>
                            <input type="hidden" id="gannOptSymbol" value="SPY">
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Direction</label>
                            <select id="gannOptDirection" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; background: white; color: #1e293b;">
                                <option value="CALL">CALL (Bullish)</option>
                                <option value="PUT">PUT (Bearish)</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Strike ($)</label>
                            <input type="number" id="gannOptStrike" value="600" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; background: white; color: #1e293b; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">DTE (Days)</label>
                            <input type="number" id="gannOptDte" value="45" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; background: white; color: #1e293b; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Premium ($)</label>
                            <input type="number" id="gannOptPremium" value="8.50" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; background: white; color: #1e293b; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Contracts</label>
                            <input type="number" id="gannOptContracts" value="1" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; background: white; color: #1e293b; box-sizing: border-box;">
                        </div>
                    </div>
                    <button onclick="calculateGannOption()" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; margin-bottom: 15px;">Calculate Risk/Reward</button>
                    <div id="gannOptResult" style="background: #f8fafc; border-radius: 8px; padding: 12px; border: 1px solid #e2e8f0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #64748b;">Max Risk</div>
                                <div id="gannOptMaxRisk" style="font-size: 16px; font-weight: 700; color: #dc2626;">$850</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #64748b;">Break Even</div>
                                <div id="gannOptBreakeven" style="font-size: 16px; font-weight: 700; color: #1e293b;">$608.50</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #64748b;">Target (+100%)</div>
                                <div id="gannOptTarget" style="font-size: 16px; font-weight: 700; color: #16a34a;">$1,700</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 10px; color: #64748b;">R:R Ratio</div>
                                <div id="gannOptRatio" style="font-size: 16px; font-weight: 700; color: #8b5cf6;">2:1</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trade Journal -->
            <div class="card" style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="font-size: 14px; margin: 0; color: #1e293b;"> Gann Cycle Trade Journal</h3>
                    <button onclick="addGannTrade()" style="padding: 6px 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer;">+ Add Trade</button>
                </div>

                <!-- Add Trade Form (hidden by default) -->
                <div id="gannTradeForm" style="display: none; background: #f8fafc; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Date</label>
                            <input type="date" id="gannTradeDate" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px; background: white; color: #1e293b; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Symbol</label>
                            <div id="gannTradeSymbolBadge" style="width: 100%; padding: 8px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border-radius: 6px; font-size: 11px; font-weight: 700; text-align: center; box-sizing: border-box;">SPY</div>
                            <input type="hidden" id="gannTradeSymbol" value="SPY">
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Type</label>
                            <select id="gannTradeType" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px; background: white; color: #1e293b;">
                                <option>CALL</option>
                                <option>PUT</option>
                                <option>STOCK</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Cycle Trigger</label>
                            <select id="gannTradeCycle" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px; background: white; color: #1e293b;">
                                <option>49d Jubilee</option>
                                <option>90d Quarter</option>
                                <option>120d</option>
                                <option>144d Sacred</option>
                                <option>180d Half</option>
                                <option>270d</option>
                                <option>360d Year</option>
                                <option>Sq9 Level</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Entry Price</label>
                            <input type="number" id="gannTradeEntry" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px; background: white; color: #1e293b; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Exit Price</label>
                            <input type="number" id="gannTradeExit" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px; background: white; color: #1e293b; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Contracts/Shares</label>
                            <input type="number" id="gannTradeQty" value="1" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px; background: white; color: #1e293b; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Result</label>
                            <select id="gannTradeResult" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px; background: white; color: #1e293b;">
                                <option value="open">OPEN</option>
                                <option value="win">WIN</option>
                                <option value="loss">LOSS</option>
                                <option value="breakeven">BREAKEVEN</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Notes</label>
                        <textarea id="gannTradeNotes" rows="2" placeholder="Trade reasoning, cycle analysis..." style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px; background: white; color: #1e293b; resize: none; box-sizing: border-box;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="saveGannTrade()" style="flex: 1; padding: 10px; background: #16a34a; color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer;">Save Trade</button>
                        <button onclick="cancelGannTrade()" style="flex: 1; padding: 10px; background: #e2e8f0; color: #64748b; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer;">Cancel</button>
                    </div>
                </div>

                <!-- Trade Journal Stats -->
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <div id="gannJournalTotal" style="font-size: 18px; font-weight: 700; color: #1e293b;">0</div>
                        <div style="font-size: 10px; color: #64748b;">Total Trades</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: #f0fdf4; border-radius: 8px; border: 1px solid #bbf7d0;">
                        <div id="gannJournalWins" style="font-size: 18px; font-weight: 700; color: #16a34a;">0</div>
                        <div style="font-size: 10px; color: #64748b;">Wins</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: #fef2f2; border-radius: 8px; border: 1px solid #fecaca;">
                        <div id="gannJournalLosses" style="font-size: 18px; font-weight: 700; color: #dc2626;">0</div>
                        <div style="font-size: 10px; color: #64748b;">Losses</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <div id="gannJournalWinRate" style="font-size: 18px; font-weight: 700; color: #8b5cf6;">0%</div>
                        <div style="font-size: 10px; color: #64748b;">Win Rate</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <div id="gannJournalPnL" style="font-size: 18px; font-weight: 700; color: #1e293b;">$0</div>
                        <div style="font-size: 10px; color: #64748b;">Total P&L</div>
                    </div>
                </div>

                <!-- Trade History Table -->
                <div class="table-wrap">
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 10px; text-align: left; color: #64748b;">Date</th>
                                <th style="padding: 10px; text-align: left; color: #64748b;">Symbol</th>
                                <th style="padding: 10px; text-align: left; color: #64748b;">Type</th>
                                <th style="padding: 10px; text-align: left; color: #64748b;">Cycle</th>
                                <th style="padding: 10px; text-align: left; color: #64748b;">Entry</th>
                                <th style="padding: 10px; text-align: left; color: #64748b;">Exit</th>
                                <th style="padding: 10px; text-align: left; color: #64748b;">P&L</th>
                                <th style="padding: 10px; text-align: left; color: #64748b;">Result</th>
                                <th style="padding: 10px; text-align: center; color: #64748b;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="gannTradeTableBody">
                            <tr id="gannNoTradesRow">
                                <td colspan="9" style="padding: 30px; text-align: center; color: #94a3b8;">
                                    No trades recorded yet. Click "+ Add Trade" to log your first Gann cycle trade.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Alert Settings -->
            <div class="card" style="margin-top: 20px;">
                <h3 style="font-size: 14px; margin-bottom: 15px; color: #1e293b;"> Cycle Alert Settings</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div style="background: #f8fafc; border-radius: 10px; padding: 15px; border: 1px solid #e2e8f0;">
                        <div style="font-weight: 600; font-size: 12px; color: #1e293b; margin-bottom: 10px;">Alert Timing</div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: #64748b; cursor: pointer;">
                                <input type="checkbox" id="gannAlert7d" checked style="accent-color: #667eea;"> 7 days before cycle
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: #64748b; cursor: pointer;">
                                <input type="checkbox" id="gannAlert3d" checked style="accent-color: #667eea;"> 3 days before cycle
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: #64748b; cursor: pointer;">
                                <input type="checkbox" id="gannAlert1d" checked style="accent-color: #667eea;"> 1 day before cycle
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: #64748b; cursor: pointer;">
                                <input type="checkbox" id="gannAlertDay" checked style="accent-color: #667eea;"> On cycle day
                            </label>
                        </div>
                    </div>
                    <div style="background: #f8fafc; border-radius: 10px; padding: 15px; border: 1px solid #e2e8f0;">
                        <div style="font-weight: 600; font-size: 12px; color: #1e293b; margin-bottom: 10px;">Cycles to Track</div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: #64748b; cursor: pointer;">
                                <input type="checkbox" id="gannCycle49" checked style="accent-color: #667eea;"> 49-day Jubilee
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: #64748b; cursor: pointer;">
                                <input type="checkbox" id="gannCycle90" checked style="accent-color: #667eea;"> 90-day Quarter
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: #64748b; cursor: pointer;">
                                <input type="checkbox" id="gannCycle144" checked style="accent-color: #667eea;"> 144-day Sacred
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: #64748b; cursor: pointer;">
                                <input type="checkbox" id="gannCycle180" checked style="accent-color: #667eea;"> 180-day Half Year
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: #64748b; cursor: pointer;">
                                <input type="checkbox" id="gannCycle270" checked style="accent-color: #667eea;"> 270-day (3/4 Year)
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: #64748b; cursor: pointer;">
                                <input type="checkbox" id="gannCycle360" checked style="accent-color: #667eea;"> 360-day Year
                            </label>
                        </div>
                    </div>
                    <div style="background: #f8fafc; border-radius: 10px; padding: 15px; border: 1px solid #e2e8f0;">
                        <div style="font-weight: 600; font-size: 12px; color: #1e293b; margin-bottom: 10px;">Notification Method</div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: #64748b; cursor: pointer;">
                                <input type="checkbox" id="gannNotifyBrowser" checked style="accent-color: #667eea;"> Browser notifications
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: #64748b; cursor: pointer;">
                                <input type="checkbox" id="gannNotifySound" style="accent-color: #667eea;"> Sound alert
                            </label>
                        </div>
                        <div style="margin-top: 15px;">
                            <button onclick="saveGannAlertSettings()" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer;">Save Settings</button>
                        </div>
                        <div style="margin-top: 10px;">
                            <button onclick="testGannAlert()" style="width: 100%; padding: 10px; background: #e2e8f0; color: #64748b; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer;">Test Alert</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GANN CYCLE OPPORTUNITIES ROADMAP -->
            <div class="card gann-roadmap-section" style="margin-top: 20px;">
                <div class="gann-roadmap-header">
                    <h3> Gann Cycle Opportunities Roadmap</h3>
                    <span class="gann-roadmap-subtitle">Biblical cycles from confirmed major pivots with Sq9 targets</span>
                </div>

                <!-- ETF Selection Tabs -->
                <div class="gann-etf-tabs" id="gannRoadmapEtfTabs" style="flex-wrap: wrap;">
                    <button class="gann-etf-tab active" onclick="selectRoadmapETF('SPY')"> SPY</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('QQQ')"> QQQ</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('IWM')"> IWM</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('DIA')"> DIA</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('XLE')"> XLE</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('XLF')"> XLF</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('XLK')"> XLK</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('XLV')"> XLV</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('XLRE')"> XLRE</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('XLC')"> XLC</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('NVDA')"> NVDA</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('TSLA')"> TSLA</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('AAPL')"> AAPL</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('AMD')"> AMD</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('META')"> META</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('MSFT')"> MSFT</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('AMZN')"> AMZN</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('GOOGL')"> GOOGL</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('JPM')"> JPM</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('MA')"> MA</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('LLY')"> LLY</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('WMT')"> WMT</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('ORCL')"> ORCL</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('CVX')"> CVX</button>
                    <button class="gann-etf-tab" onclick="selectRoadmapETF('CSCO')"> CSCO</button>
                </div>

                <!-- Pivot Selection Tabs -->
                <div class="gann-pivot-tabs" id="gannRoadmapPivotTabs">
                    <button class="gann-pivot-tab ath" onclick="selectRoadmapPivot('HIGH')"> From Major HIGH</button>
                    <button class="gann-pivot-tab atl active" onclick="selectRoadmapPivot('LOW')"> From Major LOW</button>
                </div>

                <!-- Roadmap Container -->
                <div id="gannRoadmapContainer">
                    <!-- Roadmap table will be rendered here -->
                </div>

                <!-- Legend -->
                <div class="gann-roadmap-legend">
                    <div class="legend-item">
                        <span class="legend-color" style="background: linear-gradient(135deg, #10b981, #059669);"></span>
                        <span> CONFIRMED - Price hit Sq9 zone</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: linear-gradient(135deg, #f59e0b, #d97706);"></span>
                        <span> ACTIVE - Cycle window open</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: linear-gradient(135deg, #6366f1, #4f46e5);"></span>
                        <span> UPCOMING - Future opportunity</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: linear-gradient(135deg, #ef4444, #dc2626);"></span>
                        <span> MISSED - Cycle passed, no hit</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: linear-gradient(135deg, #94a3b8, #64748b);"></span>
                        <span> EXPIRED - Cycle complete</span>
                    </div>
                </div>
            </div>

            <!-- Full Dashboard Link -->
            <div style="margin-top: 20px; text-align: center;">
                <a href="gann_cycles.html" target="_blank" style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 13px;">
                     Open Full Standalone Dashboard 
                </a>
            </div>
        </div>

        <!-- SQ9 SCANNER TAB -->
        <div id="sq9-scanner" class="tab-content">
            <div style="background: linear-gradient(135deg, #1e3a5f 0%, #2d1b4e 100%); border-radius: 12px; padding: 20px; color: white; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h2 style="font-size: 20px; margin-bottom: 5px;"> SQ9 Scanner</h2>
                        <p style="font-size: 12px; opacity: 0.8;">Gann Square of 9 + Trade Direction Context</p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span id="sq9LastUpdated" style="font-size: 11px; opacity: 0.7; padding: 4px 10px; background: rgba(255,255,255,0.1); border-radius: 6px;">
                            Updated: <span id="sq9ScanTime">--</span>
                        </span>
                        <button onclick="refreshSQ9ScannerTab()" style="padding: 8px 16px; background: #22c55e; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;"> Refresh</button>
                    </div>
                </div>
            </div>

            <!-- OPTIMAL ENTRY TIMING PANEL -->
            <div style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(139,92,246,0.05)); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <div style="font-size: 14px; font-weight: 700; margin-bottom: 5px;"> Optimal Entry Timing</div>
                        <div style="font-size: 11px; color: var(--muted);">Best windows for options entries</div>
                    </div>
                    <div id="currentMarketStatus" style="padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: 12px; background: rgba(107,114,128,0.2); color: #6b7280;">
                         Loading...
                    </div>
                </div>

                <!-- Timing Recommendation -->
                <div id="timingRecommendation" style="margin-top: 15px; padding: 15px; border-radius: 10px; background: var(--bg); border: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div id="timingIcon" style="font-size: 32px;"></div>
                        <div style="flex: 1;">
                            <div id="timingTitle" style="font-size: 14px; font-weight: 700;">Checking market status...</div>
                            <div id="timingDetail" style="font-size: 11px; color: var(--muted); margin-top: 4px;">Loading timing data</div>
                        </div>
                    </div>
                </div>

                <!-- Time Windows Reference -->
                <div style="margin-top: 15px;">
                    <div style="font-size: 11px; font-weight: 600; margin-bottom: 10px; color: var(--muted);"> Daily Time Windows (ET)</div>
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; font-size: 9px;">
                        <div style="background: rgba(239,68,68,0.1); padding: 8px 4px; border-radius: 6px; text-align: center; border: 1px solid rgba(239,68,68,0.2);">
                            <div style="font-weight: 700; color: #ef4444;">9:30-10</div>
                            <div style="color: #666; margin-top: 2px;"> Avoid</div>
                        </div>
                        <div style="background: rgba(34,197,94,0.15); padding: 8px 4px; border-radius: 6px; text-align: center; border: 2px solid rgba(34,197,94,0.4);">
                            <div style="font-weight: 700; color: #22c55e;">10-11:30</div>
                            <div style="color: #16a34a; margin-top: 2px;"> PRIME</div>
                        </div>
                        <div style="background: rgba(245,158,11,0.1); padding: 8px 4px; border-radius: 6px; text-align: center; border: 1px solid rgba(245,158,11,0.2);">
                            <div style="font-weight: 700; color: #f59e0b;">11:30-1</div>
                            <div style="color: #666; margin-top: 2px;"> Lunch</div>
                        </div>
                        <div style="background: rgba(34,197,94,0.1); padding: 8px 4px; border-radius: 6px; text-align: center; border: 1px solid rgba(34,197,94,0.2);">
                            <div style="font-weight: 700; color: #22c55e;">1-3 PM</div>
                            <div style="color: #666; margin-top: 2px;"> Good</div>
                        </div>
                        <div style="background: rgba(245,158,11,0.1); padding: 8px 4px; border-radius: 6px; text-align: center; border: 1px solid rgba(245,158,11,0.2);">
                            <div style="font-weight: 700; color: #f59e0b;">3-3:30</div>
                            <div style="color: #666; margin-top: 2px;"> Fast</div>
                        </div>
                        <div style="background: rgba(239,68,68,0.1); padding: 8px 4px; border-radius: 6px; text-align: center; border: 1px solid rgba(239,68,68,0.2);">
                            <div style="font-weight: 700; color: #ef4444;">3:30-4</div>
                            <div style="color: #666; margin-top: 2px;"> Risk</div>
                        </div>
                    </div>
                </div>

                <!-- Direction-Specific Tips -->
                <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="background: rgba(34,197,94,0.05); border: 1px solid rgba(34,197,94,0.2); border-radius: 8px; padding: 10px;">
                        <div style="font-size: 11px; font-weight: 700; color: #22c55e; margin-bottom: 6px;"> CALL Entry Tips</div>
                        <div style="font-size: 10px; color: #666; line-height: 1.5;">
                             Buy on RED candles at support<br>
                             Best: 10-11 AM during dips<br>
                             Wait for hammer/doji pattern<br>
                             On red days: wait for VIX spike to fade
                        </div>
                    </div>
                    <div style="background: rgba(239,68,68,0.05); border: 1px solid rgba(239,68,68,0.2); border-radius: 8px; padding: 10px;">
                        <div style="font-size: 11px; font-weight: 700; color: #ef4444; margin-bottom: 6px;"> PUT Entry Tips</div>
                        <div style="font-size: 10px; color: #666; line-height: 1.5;">
                             Buy on GREEN candles at resistance<br>
                             Best: 9:45-10:30 AM rally fades<br>
                             Wait for shooting star/rejection<br>
                             On green days: wait for exhaustion
                        </div>
                    </div>
                </div>
            </div>

            <!-- CANDLE PATTERN VISUAL GUIDE -->
            <div style="background: linear-gradient(135deg, rgba(34,197,94,0.05), rgba(239,68,68,0.05)); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 16px; font-weight: 700;"> Candle Pattern Scanner</div>
                        <div style="font-size: 11px; color: var(--muted);">Reversal patterns at SQ9 levels</div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="togglePatternGuide()" id="patternGuideBtn" style="padding: 6px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; font-size: 10px; cursor: pointer;"> Show Guide</button>
                        <button onclick="scanCandlePatterns()" style="padding: 6px 12px; background: #8b5cf6; color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer;"> Scan Now</button>
                    </div>
                </div>

                <!-- Today's Detected Patterns -->
                <div id="detectedPatterns" style="margin-bottom: 15px;">
                    <div style="font-size: 12px; font-weight: 700; margin-bottom: 10px;"> Today's Detected Patterns</div>
                    <div id="patternsList" style="display: grid; gap: 10px;">
                        <div style="text-align: center; padding: 20px; color: var(--muted); background: var(--bg); border-radius: 8px;">
                            Click "Scan Now" to detect patterns...
                        </div>
                    </div>
                </div>

                <!-- Collapsible Pattern Guide -->
                <div id="patternGuidePanel" style="display: none;">
                    <div style="font-size: 12px; font-weight: 700; margin-bottom: 15px; padding-top: 15px; border-top: 1px solid var(--border);"> Pattern Visual Guide</div>

                    <!-- BULLISH PATTERNS -->
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 11px; font-weight: 700; color: #22c55e; margin-bottom: 10px;">
                            <span style="background: rgba(34,197,94,0.2); padding: 4px 10px; border-radius: 4px;"> BULLISH PATTERNS</span>
                            <span style="font-weight: 400; color: var(--muted); margin-left: 8px;">At SQ9 SUPPORT  Buy CALLS</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;">
                            <div style="background: var(--bg); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; padding: 10px; text-align: center;">
                                <div style="font-weight: 700; font-size: 10px; margin-bottom: 6px;"> Hammer</div>
                                <div style="font-family: monospace; font-size: 11px; line-height: 1.1; color: #22c55e;"><br><br><br><br><br></div>
                                <div style="font-size: 8px; color: var(--muted); margin-top: 4px;">Long lower wick</div>
                            </div>
                            <div style="background: var(--bg); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; padding: 10px; text-align: center;">
                                <div style="font-weight: 700; font-size: 10px; margin-bottom: 6px;"> Engulfing</div>
                                <div style="font-family: monospace; font-size: 11px; line-height: 1.1;"><span style="color: #ef4444;"></span> <span style="color: #22c55e;"></span><br><span style="color: #ef4444;"></span> <span style="color: #22c55e;"></span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #22c55e;"></span></div>
                                <div style="font-size: 8px; color: var(--muted); margin-top: 4px;">Green engulfs red</div>
                            </div>
                            <div style="background: var(--bg); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; padding: 10px; text-align: center;">
                                <div style="font-weight: 700; font-size: 10px; margin-bottom: 6px;"> Dragonfly</div>
                                <div style="font-family: monospace; font-size: 11px; line-height: 1.1; color: #22c55e;"><br><br><br></div>
                                <div style="font-size: 8px; color: var(--muted); margin-top: 4px;">Doji, long lower</div>
                            </div>
                        </div>
                    </div>

                    <!-- BEARISH PATTERNS -->
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 11px; font-weight: 700; color: #ef4444; margin-bottom: 10px;">
                            <span style="background: rgba(239,68,68,0.2); padding: 4px 10px; border-radius: 4px;"> BEARISH PATTERNS</span>
                            <span style="font-weight: 400; color: var(--muted); margin-left: 8px;">At SQ9 RESISTANCE  Buy PUTS</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;">
                            <div style="background: var(--bg); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; padding: 10px; text-align: center;">
                                <div style="font-weight: 700; font-size: 10px; margin-bottom: 6px;"> Shooting Star</div>
                                <div style="font-family: monospace; font-size: 11px; line-height: 1.1; color: #ef4444;"><br><br><br><br><br></div>
                                <div style="font-size: 8px; color: var(--muted); margin-top: 4px;">Long upper wick</div>
                            </div>
                            <div style="background: var(--bg); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; padding: 10px; text-align: center;">
                                <div style="font-weight: 700; font-size: 10px; margin-bottom: 6px;"> Engulfing</div>
                                <div style="font-family: monospace; font-size: 11px; line-height: 1.1;"><span style="color: #22c55e;"></span> <span style="color: #ef4444;"></span><br><span style="color: #22c55e;"></span> <span style="color: #ef4444;"></span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #ef4444;"></span></div>
                                <div style="font-size: 8px; color: var(--muted); margin-top: 4px;">Red engulfs green</div>
                            </div>
                            <div style="background: var(--bg); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; padding: 10px; text-align: center;">
                                <div style="font-weight: 700; font-size: 10px; margin-bottom: 6px;"> Gravestone</div>
                                <div style="font-family: monospace; font-size: 11px; line-height: 1.1; color: #ef4444;"><br><br><br></div>
                                <div style="font-size: 8px; color: var(--muted); margin-top: 4px;">Doji, long upper</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Reference -->
                <div style="padding: 10px; background: rgba(139,92,246,0.05); border-radius: 8px; border: 1px solid rgba(139,92,246,0.2);">
                    <div style="font-size: 10px; font-weight: 700; color: #8b5cf6; margin-bottom: 6px;"> Quick Reference</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 6px; font-size: 9px;">
                        <div><span style="color: #22c55e;"> Hammer</span> = CALL at support</div>
                        <div><span style="color: #ef4444;"> Shooting Star</span> = PUT at resist</div>
                        <div><span style="color: #22c55e;"> Bull Engulf</span> = CALL</div>
                        <div><span style="color: #ef4444;"> Bear Engulf</span> = PUT</div>
                    </div>
                </div>
            </div>

            <!-- MINOR TURN CALCULATOR PANEL -->
            <div style="background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(217,119,6,0.05)); border: 1px solid rgba(245,158,11,0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 16px; font-weight: 700;"> Minor Turn Calculator</div>
                        <div style="font-size: 11px; color: var(--muted);">Predicting next reversal using Gann cycles, Fib time & swing analysis</div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div id="turnCalcCurrentSymbol" style="padding: 6px 12px; background: rgba(245,158,11,0.2); border: 1px solid #f59e0b; border-radius: 6px; font-size: 12px; font-weight: 600; color: #f59e0b;">SPY</div>
                        <div style="font-size: 10px; color: var(--muted);">Using global symbol</div>
                        <button onclick="calculateMinorTurn()" style="padding: 6px 12px; background: #f59e0b; color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer;"> Calculate</button>
                    </div>
                </div>

                <!-- Next Turn Prediction -->
                <div id="nextTurnPrediction" style="background: var(--bg); border-radius: 10px; padding: 20px; margin-bottom: 15px; text-align: center;">
                    <div style="font-size: 12px; color: var(--muted); margin-bottom: 5px;">NEXT PREDICTED MINOR TURN</div>
                    <div id="nextTurnDate" style="font-size: 28px; font-weight: 800; color: #f59e0b;">--</div>
                    <div id="nextTurnDaysAway" style="font-size: 14px; color: var(--muted); margin-top: 5px;">-- days away</div>
                    <div id="nextTurnDirection" style="margin-top: 10px; padding: 8px 20px; border-radius: 20px; display: inline-block; font-weight: 700; font-size: 12px; background: rgba(107,114,128,0.1); color: #6b7280;">
                        Calculating...
                    </div>
                </div>

                <!-- Turn Stats -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="background: var(--bg); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">CONFIDENCE</div>
                        <div id="turnConfidenceVal" style="font-size: 20px; font-weight: 800; color: #f59e0b;">--%</div>
                    </div>
                    <div style="background: var(--bg); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">METHODS AGREE</div>
                        <div id="turnMethodsVal" style="font-size: 20px; font-weight: 800;">-/5</div>
                    </div>
                    <div style="background: var(--bg); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">LAST TURN</div>
                        <div id="lastTurnVal" style="font-size: 12px; font-weight: 700;">--</div>
                    </div>
                    <div style="background: var(--bg); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">AVG SWING</div>
                        <div id="avgSwingVal" style="font-size: 20px; font-weight: 800;">-- days</div>
                    </div>
                </div>

                <!-- Method Breakdown -->
                <div style="background: var(--bg); border-radius: 10px; padding: 15px;">
                    <div style="font-size: 12px; font-weight: 700; margin-bottom: 12px;"> Turn Prediction Methods</div>
                    <div id="turnMethodsDetail" style="display: grid; gap: 8px; font-size: 11px;">
                        <div style="text-align: center; color: var(--muted); padding: 10px;">Click Calculate to analyze...</div>
                    </div>
                </div>
            </div>

            <!-- MULTI-TIMEFRAME SIGNAL SYSTEM -->
            <div style="background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(139,92,246,0.05)); border: 2px solid rgba(99,102,241,0.4); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <!-- Header with Alignment Banner -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 16px; font-weight: 700;"> Multi-Timeframe Signal System</div>
                        <div style="font-size: 11px; color: var(--muted);">Daily  15min  5min Candle Alignment</div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span id="mtfSymbolSelectBadge" style="padding: 6px 14px; background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border-radius: 6px; font-size: 12px; font-weight: 700;">SPY</span>
                        <input type="hidden" id="mtfSymbolSelect" value="SPY">
                        <button onclick="scanMTFPatterns(true)" style="padding: 6px 12px; background: #6366f1; color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer;"> Scan MTF</button>
                    </div>
                </div>

                <!-- Alignment Status Banner -->
                <div id="mtfAlignmentBanner" style="background: rgba(107,114,128,0.1); border: 1px solid rgba(107,114,128,0.3); border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: center;">
                    <div style="font-size: 12px; color: var(--muted); margin-bottom: 5px;">TIMEFRAME ALIGNMENT</div>
                    <div id="mtfAlignmentStatus" style="font-size: 24px; font-weight: 800; color: #6b7280;"> Click Scan MTF to analyze...</div>
                    <div id="mtfAlignmentDesc" style="font-size: 11px; color: var(--muted); margin-top: 5px;">--</div>
                </div>

                <!-- Three Timeframe Panels -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
                    <!-- Daily Panel (Major) -->
                    <div id="mtfDailyPanel" style="background: var(--bg); border: 2px solid var(--border); border-radius: 10px; padding: 12px;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;"> DAILY (Major Trend)</div>
                        <div id="mtfDailyPattern" style="font-size: 14px; font-weight: 700;">--</div>
                        <div id="mtfDailySignal" style="font-size: 11px; color: var(--muted); margin-top: 3px;">Awaiting scan...</div>
                        <div id="mtfDailyCandle" style="font-family: monospace; font-size: 18px; margin-top: 8px; text-align: center;"></div>
                    </div>
                    <!-- 15min Panel (Minor) -->
                    <div id="mtf15minPanel" style="background: var(--bg); border: 2px solid var(--border); border-radius: 10px; padding: 12px;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;"> 15-MIN (Minor Trend)</div>
                        <div id="mtf15minPattern" style="font-size: 14px; font-weight: 700;">--</div>
                        <div id="mtf15minSignal" style="font-size: 11px; color: var(--muted); margin-top: 3px;">Awaiting scan...</div>
                        <div id="mtf15minCandle" style="font-family: monospace; font-size: 18px; margin-top: 8px; text-align: center;"></div>
                    </div>
                    <!-- 5min Panel (Entry) -->
                    <div id="mtf5minPanel" style="background: var(--bg); border: 2px solid var(--border); border-radius: 10px; padding: 12px;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;"> 5-MIN (Entry Trigger)</div>
                        <div id="mtf5minPattern" style="font-size: 14px; font-weight: 700;">--</div>
                        <div id="mtf5minSignal" style="font-size: 11px; color: var(--muted); margin-top: 3px;">Awaiting scan...</div>
                        <div id="mtf5minCandle" style="font-family: monospace; font-size: 18px; margin-top: 8px; text-align: center;"></div>
                    </div>
                </div>

                <!-- Trade Setup Box (hidden by default) -->
                <div id="mtfTradeSetup" style="display: none; background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(22,163,74,0.1)); border: 2px solid #22c55e; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                    <div style="font-size: 14px; font-weight: 700; color: #22c55e; margin-bottom: 10px;"> TRADE SETUP DETECTED</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 11px;">
                        <div style="background: white; border-radius: 6px; padding: 8px; text-align: center;">
                            <div style="color: #666; font-size: 9px;">DIRECTION</div>
                            <div id="mtfTradeDirection" style="font-weight: 700; font-size: 14px;">--</div>
                        </div>
                        <div style="background: white; border-radius: 6px; padding: 8px; text-align: center;">
                            <div style="color: #666; font-size: 9px;">ENTRY ZONE</div>
                            <div id="mtfEntryZone" style="font-weight: 700; font-size: 14px;">--</div>
                        </div>
                        <div style="background: white; border-radius: 6px; padding: 8px; text-align: center;">
                            <div style="color: #666; font-size: 9px;">STOP LOSS</div>
                            <div id="mtfStopLoss" style="font-weight: 700; font-size: 14px;">--</div>
                        </div>
                        <div style="background: white; border-radius: 6px; padding: 8px; text-align: center;">
                            <div style="color: #666; font-size: 9px;">CONFIDENCE</div>
                            <div id="mtfConfidence" style="font-weight: 700; font-size: 14px;">--</div>
                        </div>
                    </div>
                </div>

                <!-- Alignment Matrix Reference -->
                <div style="background: var(--bg); border-radius: 10px; padding: 15px;">
                    <div style="font-size: 12px; font-weight: 700; margin-bottom: 12px;"> Alignment Scenarios</div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                        <thead>
                            <tr style="background: rgba(99,102,241,0.1);">
                                <th style="padding: 6px; text-align: left; border-bottom: 1px solid var(--border);">Scenario</th>
                                <th style="padding: 6px; text-align: center; border-bottom: 1px solid var(--border);">Daily</th>
                                <th style="padding: 6px; text-align: center; border-bottom: 1px solid var(--border);">15min</th>
                                <th style="padding: 6px; text-align: center; border-bottom: 1px solid var(--border);">5min</th>
                                <th style="padding: 6px; text-align: left; border-bottom: 1px solid var(--border);">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 6px; color: #22c55e; font-weight: 700;">FULL BULL</td>
                                <td style="padding: 6px; text-align: center;"></td>
                                <td style="padding: 6px; text-align: center;"></td>
                                <td style="padding: 6px; text-align: center;"></td>
                                <td style="padding: 6px;">BUY CALLS on 5min dip</td>
                            </tr>
                            <tr style="background: rgba(0,0,0,0.02);">
                                <td style="padding: 6px; color: #ef4444; font-weight: 700;">FULL BEAR</td>
                                <td style="padding: 6px; text-align: center;"></td>
                                <td style="padding: 6px; text-align: center;"></td>
                                <td style="padding: 6px; text-align: center;"></td>
                                <td style="padding: 6px;">BUY PUTS on 5min rally</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px; color: #f59e0b; font-weight: 700;">BULL PULLBACK</td>
                                <td style="padding: 6px; text-align: center;"></td>
                                <td style="padding: 6px; text-align: center;"></td>
                                <td style="padding: 6px; text-align: center;"></td>
                                <td style="padding: 6px;">Wait for 15min to turn green</td>
                            </tr>
                            <tr style="background: rgba(0,0,0,0.02);">
                                <td style="padding: 6px; color: #f59e0b; font-weight: 700;">BEAR RALLY</td>
                                <td style="padding: 6px; text-align: center;"></td>
                                <td style="padding: 6px; text-align: center;"></td>
                                <td style="padding: 6px; text-align: center;"></td>
                                <td style="padding: 6px;">Wait for 15min to turn red</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px; color: #6b7280; font-weight: 700;">CHOPPY</td>
                                <td style="padding: 6px; text-align: center;"></td>
                                <td style="padding: 6px; text-align: center;"></td>
                                <td style="padding: 6px; text-align: center;"></td>
                                <td style="padding: 6px;">NO TRADE - wait for clarity</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- HISTORICAL PATTERN SCANNER -->
            <div style="background: linear-gradient(135deg, rgba(168,85,247,0.08), rgba(236,72,153,0.05)); border: 2px solid rgba(168,85,247,0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 16px; font-weight: 700;"> Historical Pattern Scanner</div>
                        <div style="font-size: 11px; color: var(--muted);">Scan 1 year of data for Major (Daily) & Minor patterns with win rates</div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        <span id="histPatternSymbolBadge" style="padding: 6px 14px; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border-radius: 6px; font-size: 12px; font-weight: 700;">SPY</span>
                        <input type="hidden" id="histPatternSymbol" value="SPY">
                        <select id="histPatternPeriod" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 11px;">
                            <option value="365">1 Year</option>
                            <option value="180">6 Months</option>
                            <option value="90">3 Months</option>
                            <option value="30">1 Month</option>
                        </select>
                        <button onclick="scanHistoricalPatterns()" style="padding: 6px 12px; background: linear-gradient(135deg, #a855f7, #ec4899); color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer;"> Scan History</button>
                        <button onclick="exportPatternData()" style="padding: 6px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; font-size: 11px; cursor: pointer;"> Export CSV</button>
                    </div>
                </div>

                <!-- SUMMARY STATS -->
                <div id="patternSummaryStats" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">TOTAL PATTERNS</div>
                        <div id="totalPatternsCount" style="font-size: 24px; font-weight: 800; color: #a855f7;">--</div>
                    </div>
                    <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">MAJOR (Daily)</div>
                        <div id="majorPatternsCount" style="font-size: 24px; font-weight: 800; color: #1e3a5f;">--</div>
                    </div>
                    <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">MINOR (Intra)</div>
                        <div id="minorPatternsCount" style="font-size: 24px; font-weight: 800; color: #f59e0b;">--</div>
                    </div>
                    <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">AVG WIN RATE</div>
                        <div id="avgWinRate" style="font-size: 24px; font-weight: 800; color: #22c55e;">--%</div>
                    </div>
                    <div style="background: white; border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">BEST PATTERN</div>
                        <div id="bestPatternName" style="font-size: 16px; font-weight: 800; color: #22c55e;">--</div>
                        <div id="bestPatternRate" style="font-size: 10px; color: var(--muted);">--%</div>
                    </div>
                </div>

                <!-- PATTERN PERFORMANCE TABLE -->
                <div style="background: white; border-radius: 10px; overflow: hidden; margin-bottom: 15px;">
                    <div style="background: linear-gradient(135deg, #a855f7, #ec4899); color: white; padding: 12px 15px; font-size: 12px; font-weight: 700;">
                         Pattern Performance by Type
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <thead>
                                <tr style="background: var(--bg);">
                                    <th style="padding: 10px; text-align: left;">Pattern</th>
                                    <th style="padding: 10px; text-align: center;">Count</th>
                                    <th style="padding: 10px; text-align: center;">Wins</th>
                                    <th style="padding: 10px; text-align: center;">Losses</th>
                                    <th style="padding: 10px; text-align: center;">Win Rate</th>
                                    <th style="padding: 10px; text-align: center;">Avg Move</th>
                                    <th style="padding: 10px; text-align: center;">Best Move</th>
                                    <th style="padding: 10px; text-align: center;">Type</th>
                                </tr>
                            </thead>
                            <tbody id="patternPerformanceTable">
                                <tr><td colspan="8" style="padding: 20px; text-align: center; color: var(--muted);">Click "Scan History" to analyze patterns...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- WIN RATE BY CONTEXT -->
                <div style="background: white; border-radius: 10px; overflow: hidden; margin-bottom: 15px;">
                    <div style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 12px 15px; font-size: 12px; font-weight: 700;">
                         Win Rate by Context (Key Insight: Patterns at SQ9 levels perform MUCH better!)
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                            <thead>
                                <tr style="background: var(--bg);">
                                    <th style="padding: 10px; text-align: left;">Context</th>
                                    <th style="padding: 10px; text-align: center;"> Hammer</th>
                                    <th style="padding: 10px; text-align: center;"> Star</th>
                                    <th style="padding: 10px; text-align: center;"> Bull Eng</th>
                                    <th style="padding: 10px; text-align: center;"> Bear Eng</th>
                                    <th style="padding: 10px; text-align: center;"> Dragonfly</th>
                                    <th style="padding: 10px; text-align: center;"> Gravestone</th>
                                </tr>
                            </thead>
                            <tbody id="contextWinRateTable">
                                <tr><td colspan="7" style="padding: 20px; text-align: center; color: var(--muted);">Scan to see context analysis...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- PATTERNS AT SQ9 LEVELS -->
                <div style="background: white; border-radius: 10px; overflow: hidden; margin-bottom: 15px;">
                    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 12px; font-weight: 700;"> Patterns at SQ9 Levels (High Probability Setups)</span>
                        <span id="sq9PatternStats" style="font-size: 11px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px;">-- patterns | --% win rate</span>
                    </div>
                    <div style="overflow-x: auto; max-height: 300px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                            <thead style="position: sticky; top: 0; background: var(--bg);">
                                <tr>
                                    <th style="padding: 10px; text-align: left;">Date</th>
                                    <th style="padding: 10px; text-align: center;">Pattern</th>
                                    <th style="padding: 10px; text-align: center;">SQ9 Level</th>
                                    <th style="padding: 10px; text-align: center;">Distance</th>
                                    <th style="padding: 10px; text-align: center;">Signal</th>
                                    <th style="padding: 10px; text-align: center;">Entry</th>
                                    <th style="padding: 10px; text-align: center;">5-Day</th>
                                    <th style="padding: 10px; text-align: center;">Outcome</th>
                                </tr>
                            </thead>
                            <tbody id="sq9PatternsTable">
                                <tr><td colspan="8" style="padding: 20px; text-align: center; color: var(--muted);">Scan to find patterns at SQ9 levels...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- MAJOR PATTERNS LIST -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div style="background: white; border-radius: 10px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #1e3a5f, #2d1b4e); color: white; padding: 12px 15px; font-size: 12px; font-weight: 700;">
                             MAJOR Patterns (Daily) - Last 20
                        </div>
                        <div style="overflow-y: auto; max-height: 350px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                                <thead style="position: sticky; top: 0; background: var(--bg);">
                                    <tr>
                                        <th style="padding: 8px; text-align: left;">Date</th>
                                        <th style="padding: 8px; text-align: center;">Pattern</th>
                                        <th style="padding: 8px; text-align: center;">Signal</th>
                                        <th style="padding: 8px; text-align: right;">5-Day</th>
                                        <th style="padding: 8px; text-align: center;">Result</th>
                                    </tr>
                                </thead>
                                <tbody id="majorPatternsTable">
                                    <tr><td colspan="5" style="padding: 15px; text-align: center; color: var(--muted);">Scan to see major patterns...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div style="background: white; border-radius: 10px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 12px 15px; font-size: 12px; font-weight: 700;">
                             MINOR Patterns (Intraday Sim) - Last 20
                        </div>
                        <div style="overflow-y: auto; max-height: 350px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                                <thead style="position: sticky; top: 0; background: var(--bg);">
                                    <tr>
                                        <th style="padding: 8px; text-align: left;">Date</th>
                                        <th style="padding: 8px; text-align: center;">Pattern</th>
                                        <th style="padding: 8px; text-align: center;">TF</th>
                                        <th style="padding: 8px; text-align: center;">Signal</th>
                                        <th style="padding: 8px; text-align: center;">Result</th>
                                    </tr>
                                </thead>
                                <tbody id="minorPatternsTable">
                                    <tr><td colspan="5" style="padding: 15px; text-align: center; color: var(--muted);">Scan to see minor patterns...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TOP PERFORMING SETUPS -->
                <div style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(22,163,74,0.05)); border: 1px solid rgba(34,197,94,0.3); border-radius: 10px; padding: 15px;">
                    <div style="font-size: 12px; font-weight: 700; margin-bottom: 12px; color: #22c55e;"> Top Performing Setups (Highest Win Rate Combinations)</div>
                    <div id="topSetupsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px;">
                        <div style="background: white; border-radius: 8px; padding: 15px; text-align: center; color: var(--muted);">
                            Scan to discover top setups...
                        </div>
                    </div>
                </div>

                <!-- MONTHLY DISTRIBUTION CHART -->
                <div style="background: white; border-radius: 10px; padding: 15px; margin-top: 15px;">
                    <div style="font-size: 12px; font-weight: 700; margin-bottom: 12px;"> Monthly Pattern Distribution</div>
                    <div id="monthlyDistChart" style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 8px; align-items: end; height: 150px;">
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 8px; margin-top: 8px; font-size: 9px; text-align: center; color: var(--muted);">
                        <div>Jan</div><div>Feb</div><div>Mar</div><div>Apr</div><div>May</div><div>Jun</div>
                        <div>Jul</div><div>Aug</div><div>Sep</div><div>Oct</div><div>Nov</div><div>Dec</div>
                    </div>
                    <div style="display: flex; gap: 20px; justify-content: center; margin-top: 10px; font-size: 10px;">
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: #22c55e; border-radius: 2px; vertical-align: middle;"></span> Bullish</span>
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: #ef4444; border-radius: 2px; vertical-align: middle;"></span> Bearish</span>
                    </div>
                </div>
            </div>

            <!-- PATTERN DETAIL MODAL -->
            <div id="patternDetailModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 12px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div id="modalPatternTitle" style="font-size: 18px; font-weight: 700;">Pattern Detail</div>
                        <button onclick="closePatternModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;"></button>
                    </div>
                    <div id="modalPatternContent">
                    </div>
                </div>
            </div>

            <!-- Summary Stats -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(22,163,74,0.1)); border: 1px solid rgba(34,197,94,0.3); border-radius: 10px; padding: 15px; text-align: center;">
                    <div style="font-size: 10px; color: #22c55e; margin-bottom: 5px;"> READY (5/5)</div>
                    <div id="sq9ReadyCount" style="font-size: 28px; font-weight: 800; color: #22c55e;">0</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(217,119,6,0.1)); border: 1px solid rgba(245,158,11,0.3); border-radius: 10px; padding: 15px; text-align: center;">
                    <div style="font-size: 10px; color: #f59e0b; margin-bottom: 5px;"> WATCHING (3-4)</div>
                    <div id="sq9WatchingCount" style="font-size: 28px; font-weight: 800; color: #f59e0b;">0</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(156,163,175,0.1), rgba(107,114,128,0.1)); border: 1px solid rgba(156,163,175,0.3); border-radius: 10px; padding: 15px; text-align: center;">
                    <div style="font-size: 10px; color: #6b7280; margin-bottom: 5px;"> PARTIAL (1-2)</div>
                    <div id="sq9PartialCount" style="font-size: 28px; font-weight: 800; color: #6b7280;">0</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(37,99,235,0.1)); border: 1px solid rgba(59,130,246,0.3); border-radius: 10px; padding: 15px; text-align: center;">
                    <div style="font-size: 10px; color: #3b82f6; margin-bottom: 5px;"> TOTAL SETUPS</div>
                    <div id="sq9TotalCount" style="font-size: 28px; font-weight: 800; color: #3b82f6;">0</div>
                </div>
            </div>

            <!-- Filter Buttons -->
            <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="sq9-filter-btn active" onclick="filterSq9Results('all')" data-filter="all" style="padding: 8px 16px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; background: #3b82f6; color: white;">All</button>
                <button class="sq9-filter-btn" onclick="filterSq9Results('ready')" data-filter="ready" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; background: white;"> Ready</button>
                <button class="sq9-filter-btn" onclick="filterSq9Results('watching')" data-filter="watching" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; background: white;"> Watching</button>
                <button class="sq9-filter-btn" onclick="filterSq9Results('call')" data-filter="call" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; background: white;"> Calls</button>
                <button class="sq9-filter-btn" onclick="filterSq9Results('put')" data-filter="put" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; background: white;"> Puts</button>
                <button class="sq9-filter-btn" onclick="filterSq9Results('etf')" data-filter="etf" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; background: white;">ETFs Only</button>
            </div>

            <!-- Ready Setups Section -->
            <div style="background: var(--card); border: 2px solid #22c55e; border-radius: 12px; margin-bottom: 20px; overflow: hidden;" id="sq9ReadySection">
                <div style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 12px 20px; font-weight: 700;">
                     READY SETUPS (5/5 Checks) - ENTER NOW!
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: rgba(34,197,94,0.1);">
                                <th style="padding: 10px; text-align: left;">SYMBOL</th>
                                <th style="padding: 10px; text-align: left;">PRICE</th>
                                <th style="padding: 10px; text-align: left;">SQ9 LEVEL</th>
                                <th style="padding: 10px; text-align: left;">DIST</th>
                                <th style="padding: 10px; text-align: left;">DIR</th>
                                <th style="padding: 10px; text-align: left;">PIVOT</th>
                                <th style="padding: 10px; text-align: left;">TARGET</th>
                                <th style="padding: 10px; text-align: left;">STOP</th>
                                <th style="padding: 10px; text-align: left;">R/R</th>
                                <th style="padding: 10px; text-align: left;">ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="sq9ReadyTable">
                            <tr><td colspan="10" style="text-align: center; padding: 30px; color: #999;">No ready setups. Click "Scan Now" to detect.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Watching Setups Section -->
            <div style="background: var(--card); border: 1px solid #f59e0b; border-radius: 12px; margin-bottom: 20px; overflow: hidden;" id="sq9WatchingSection">
                <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 12px 20px; font-weight: 700;">
                     WATCHING (3-4/5 Checks) - Almost Ready
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: rgba(245,158,11,0.1);">
                                <th style="padding: 10px; text-align: left;">SYMBOL</th>
                                <th style="padding: 10px; text-align: left;">PRICE</th>
                                <th style="padding: 10px; text-align: left;">SQ9 LEVEL</th>
                                <th style="padding: 10px; text-align: left;">DIST</th>
                                <th style="padding: 10px; text-align: left;">DIR</th>
                                <th style="padding: 10px; text-align: left;">CHECKS</th>
                                <th style="padding: 10px; text-align: left;">MISSING</th>
                                <th style="padding: 10px; text-align: left;">ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="sq9WatchingTable">
                            <tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">No watching setups. Click "Scan Now" to detect.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Partial Setups Section (Compact) -->
            <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; overflow: hidden;" id="sq9PartialSection">
                <div style="background: var(--bg); padding: 12px 20px; font-weight: 700; border-bottom: 1px solid var(--border);">
                     APPROACHING (1-2/5 Checks) - On Radar
                </div>
                <div id="sq9PartialGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; padding: 15px;">
                    <div style="text-align: center; padding: 20px; color: #999; grid-column: 1 / -1;">No approaching setups. Click "Scan Now" to detect.</div>
                </div>
            </div>

            <!-- Multi-Timeframe SQ9 Analysis -->
            <div style="background: linear-gradient(135deg, rgba(147,51,234,0.08), rgba(79,70,229,0.08)); border: 1px solid rgba(147,51,234,0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <div style="font-size: 16px; font-weight: 700;"> Multi-Timeframe SQ9 Analysis</div>
                        <div style="font-size: 11px; color: var(--muted);">Confluence across 15min, 1hour, and Daily pivots</div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span id="sq9MtfSymbolBadge" style="padding: 8px 16px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border-radius: 6px; font-size: 14px; font-weight: 700;">SPY</span>
                        <input type="hidden" id="sq9MtfSymbol" value="SPY">
                        <div style="font-size: 14px; font-weight: 600;">
                            <span id="sq9MtfSymbolDisplay">SPY</span>:
                            <span id="sq9MtfPriceDisplay" style="color: #3b82f6;">$--</span>
                        </div>
                    </div>
                </div>

                <!-- Timeframe Grid -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                    <!-- 15min Timeframe -->
                    <div id="sq9Mtf15min" style="background: var(--bg); border: 2px solid transparent; border-radius: 10px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 12px; font-weight: 700; color: #8b5cf6;"> 15-MIN</span>
                            <span id="sq9Mtf15minBias" style="padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; background: #e5e7eb; color: #666;">NEUTRAL</span>
                        </div>
                        <div style="font-size: 11px; color: var(--muted); margin-bottom: 8px;">Session Pivot</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                            <div>
                                <div style="font-size: 9px; color: var(--muted);">Nearest Level</div>
                                <div id="sq9Mtf15minLevel" style="font-size: 14px; font-weight: 700;">--</div>
                            </div>
                            <div>
                                <div style="font-size: 9px; color: var(--muted);">Distance</div>
                                <div id="sq9Mtf15minDist" style="font-size: 14px; font-weight: 700;">--</div>
                            </div>
                        </div>
                        <div style="font-size: 10px; color: var(--muted);">Type: <span id="sq9Mtf15minType">--</span></div>
                        <div id="sq9Mtf15minLevels" style="margin-top: 10px; font-size: 10px;"></div>
                    </div>

                    <!-- 1hour Timeframe -->
                    <div id="sq9Mtf1hour" style="background: var(--bg); border: 2px solid transparent; border-radius: 10px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 12px; font-weight: 700; color: #3b82f6;"> 1-HOUR</span>
                            <span id="sq9Mtf1hourBias" style="padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; background: #e5e7eb; color: #666;">NEUTRAL</span>
                        </div>
                        <div style="font-size: 11px; color: var(--muted); margin-bottom: 8px;">Weekly Pivot</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                            <div>
                                <div style="font-size: 9px; color: var(--muted);">Nearest Level</div>
                                <div id="sq9Mtf1hourLevel" style="font-size: 14px; font-weight: 700;">--</div>
                            </div>
                            <div>
                                <div style="font-size: 9px; color: var(--muted);">Distance</div>
                                <div id="sq9Mtf1hourDist" style="font-size: 14px; font-weight: 700;">--</div>
                            </div>
                        </div>
                        <div style="font-size: 10px; color: var(--muted);">Type: <span id="sq9Mtf1hourType">--</span></div>
                        <div id="sq9Mtf1hourLevels" style="margin-top: 10px; font-size: 10px;"></div>
                    </div>

                    <!-- Daily Timeframe -->
                    <div id="sq9MtfDaily" style="background: var(--bg); border: 2px solid transparent; border-radius: 10px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 12px; font-weight: 700; color: #f59e0b;"> DAILY</span>
                            <span id="sq9MtfDailyBias" style="padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; background: #e5e7eb; color: #666;">NEUTRAL</span>
                        </div>
                        <div style="font-size: 11px; color: var(--muted); margin-bottom: 8px;">52-Week Pivot</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                            <div>
                                <div style="font-size: 9px; color: var(--muted);">Nearest Level</div>
                                <div id="sq9MtfDailyLevel" style="font-size: 14px; font-weight: 700;">--</div>
                            </div>
                            <div>
                                <div style="font-size: 9px; color: var(--muted);">Distance</div>
                                <div id="sq9MtfDailyDist" style="font-size: 14px; font-weight: 700;">--</div>
                            </div>
                        </div>
                        <div style="font-size: 10px; color: var(--muted);">Type: <span id="sq9MtfDailyType">--</span></div>
                        <div id="sq9MtfDailyLevels" style="margin-top: 10px; font-size: 10px;"></div>
                    </div>
                </div>

                <!-- Alignment Status -->
                <div id="sq9MtfAlignment" style="background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center;">
                    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <span id="sq9MtfAlignmentTitle" style="font-size: 14px; font-weight: 700;"> Waiting for Alignment</span>
                        <span id="sq9MtfAlignmentBadge" style="padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 700; background: #e5e7eb; color: #666;">NEUTRAL</span>
                    </div>
                    <div id="sq9MtfAlignmentDesc" style="font-size: 12px; color: var(--muted);">Select a symbol to analyze multi-timeframe confluence</div>
                </div>
            </div>

            <!-- ETF DURATION SUMMARY TABLE -->
            <div style="background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="font-size: 14px; font-weight: 700;"> SQ9 Level-to-Level Duration by Symbol</div>
                    <button onclick="updateDurationTable()" style="padding: 5px 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer;"> Refresh</button>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: var(--bg);">
                                <th style="padding: 10px; text-align: left;">SYMBOL</th>
                                <th style="padding: 10px; text-align: center;">AVG DAYS</th>
                                <th style="padding: 10px; text-align: center;">MIN</th>
                                <th style="padding: 10px; text-align: center;">MAX</th>
                                <th style="padding: 10px; text-align: center;">SPEED</th>
                                <th style="padding: 10px; text-align: center;">REC. DTE</th>
                                <th style="padding: 10px; text-align: left;">EXPIRY TYPE</th>
                            </tr>
                        </thead>
                        <tbody id="durationTable">
                            <tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">Loading duration data...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 10px; color: #666;">
                    <strong>Speed Legend:</strong>
                     Very Fast (&lt;2 days) |
                     Fast (2-3 days) |
                     Normal (4-5 days) |
                     Slow (6+ days)
                </div>
            </div>

            <!-- Selected Setup Detail -->
            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05)); border: 1px solid rgba(102,126,234,0.3); border-radius: 12px; padding: 20px;" id="sq9DetailPanel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="font-size: 16px; font-weight: 700;"> Setup Detail</div>
                    <div id="sq9DetailSymbol" style="font-size: 14px; color: var(--muted);">Select a symbol above</div>
                </div>
                <div id="sq9DetailContent" style="font-size: 13px; color: var(--muted); text-align: center; padding: 30px;">
                    Click on any symbol row to see full SQ9 analysis details
                </div>
            </div>
        </div>

        <!-- SQ9 PERFORMANCE TAB -->
        <div id="sq9-performance" class="tab-content">
            <div style="background: linear-gradient(135deg, #1e3a5f 0%, #064e3b 100%); border-radius: 12px; padding: 20px; color: white; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h2 style="font-size: 20px; margin-bottom: 5px;"> SQ9 Performance Tracker</h2>
                        <p style="font-size: 12px; opacity: 0.8;">Track your SQ9 trades, analyze win rates, and backtest strategies</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="openSq9TradeModal()" style="padding: 8px 16px; background: #22c55e; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">+ Log Trade</button>
                        <button onclick="runSq9Backtest()" style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;"> Run Backtest</button>
                        <button onclick="exportSq9Performance()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;"> Export</button>
                    </div>
                </div>
            </div>

            <!-- Performance Summary Cards -->
            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center;">
                    <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;">TOTAL TRADES</div>
                    <div id="sq9TotalTrades" style="font-size: 28px; font-weight: 800; color: var(--primary);">0</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(22,163,74,0.1)); border: 1px solid rgba(34,197,94,0.3); border-radius: 10px; padding: 15px; text-align: center;">
                    <div style="font-size: 10px; color: #22c55e; margin-bottom: 5px;">WIN RATE</div>
                    <div id="sq9WinRate" style="font-size: 28px; font-weight: 800; color: #22c55e;">0%</div>
                </div>
                <div style="background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center;">
                    <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;">WINS / LOSSES</div>
                    <div style="font-size: 28px; font-weight: 800;"><span id="sq9Wins" style="color: #22c55e;">0</span> / <span id="sq9Losses" style="color: #ef4444;">0</span></div>
                </div>
                <div style="background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center;">
                    <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;">TOTAL P&L</div>
                    <div id="sq9TotalPnL" style="font-size: 28px; font-weight: 800; color: #22c55e;">$0</div>
                </div>
                <div style="background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center;">
                    <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;">AVG WIN</div>
                    <div id="sq9AvgWin" style="font-size: 28px; font-weight: 800; color: #22c55e;">$0</div>
                </div>
                <div style="background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center;">
                    <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;">AVG LOSS</div>
                    <div id="sq9AvgLoss" style="font-size: 28px; font-weight: 800; color: #ef4444;">$0</div>
                </div>
            </div>

            <!-- Performance by Direction & Status -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <!-- By Direction -->
                <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                    <div style="font-size: 14px; font-weight: 700; margin-bottom: 15px;"> Performance by Direction</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: rgba(34,197,94,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                            <div style="font-size: 11px; color: #22c55e; margin-bottom: 5px;"> CALLS</div>
                            <div id="sq9CallWinRate" style="font-size: 24px; font-weight: 800; color: #22c55e;">0%</div>
                            <div id="sq9CallRecord" style="font-size: 11px; color: var(--muted);">0W - 0L</div>
                        </div>
                        <div style="background: rgba(239,68,68,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                            <div style="font-size: 11px; color: #ef4444; margin-bottom: 5px;"> PUTS</div>
                            <div id="sq9PutWinRate" style="font-size: 24px; font-weight: 800; color: #ef4444;">0%</div>
                            <div id="sq9PutRecord" style="font-size: 11px; color: var(--muted);">0W - 0L</div>
                        </div>
                    </div>
                </div>

                <!-- By Check Count -->
                <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                    <div style="font-size: 14px; font-weight: 700; margin-bottom: 15px;"> Performance by Entry Quality</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(34,197,94,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 10px; color: #22c55e; margin-bottom: 3px;">5/5 READY</div>
                            <div id="sq9Ready5WinRate" style="font-size: 20px; font-weight: 800; color: #22c55e;">0%</div>
                        </div>
                        <div style="background: rgba(245,158,11,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 10px; color: #f59e0b; margin-bottom: 3px;">4/5 WATCH</div>
                            <div id="sq9Ready4WinRate" style="font-size: 20px; font-weight: 800; color: #f59e0b;">0%</div>
                        </div>
                        <div style="background: rgba(156,163,175,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 10px; color: #6b7280; margin-bottom: 3px;">3/5 EARLY</div>
                            <div id="sq9Ready3WinRate" style="font-size: 20px; font-weight: 800; color: #6b7280;">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backtest Results Panel -->
            <div id="sq9BacktestPanel" style="background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(217,119,6,0.1)); border: 1px solid rgba(245,158,11,0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="font-size: 16px; font-weight: 700;"> Backtest Results</div>
                    <button onclick="document.getElementById('sq9BacktestPanel').style.display='none'" style="background: none; border: none; font-size: 18px; cursor: pointer;"></button>
                </div>
                <div id="sq9BacktestResults">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Historical Backtest Section -->
            <div style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(109,40,217,0.1)); border: 1px solid rgba(139,92,246,0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 16px; font-weight: 700; color: #7c3aed;"> Historical Backtest Engine</div>
                        <div style="font-size: 11px; color: var(--muted);">Test SQ9 strategy on actual price data</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="toggleBacktestSettings()" style="padding: 8px 16px; background: rgba(139,92,246,0.2); color: #7c3aed; border: 1px solid rgba(139,92,246,0.3); border-radius: 6px; font-weight: 600; cursor: pointer;"> Settings</button>
                        <button onclick="runHistoricalBacktest()" style="padding: 8px 16px; background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;"> Run Backtest</button>
                        <button onclick="exportBacktestResults()" style="padding: 8px 16px; background: rgba(139,92,246,0.2); color: #7c3aed; border: 1px solid rgba(139,92,246,0.3); border-radius: 6px; font-weight: 600; cursor: pointer;"> Export</button>
                    </div>
                </div>

                <!-- Settings Panel (collapsible) -->
                <div id="backtestSettingsPanel" style="display: none; background: rgba(255,255,255,0.5); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Min Checks</label>
                            <select id="backtestMinChecks" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
                                <option value="3">3/5 (Early)</option>
                                <option value="4" selected>4/5 (Watch)</option>
                                <option value="5">5/5 (Ready)</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Lookback Period</label>
                            <select id="backtestLookback" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
                                <option value="30">30 Days</option>
                                <option value="60">60 Days</option>
                                <option value="90">90 Days</option>
                                <option value="180" selected>180 Days</option>
                                <option value="365">1 Year</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Position Size</label>
                            <select id="backtestPositionSize" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
                                <option value="500">$500</option>
                                <option value="1000" selected>$1,000</option>
                                <option value="2500">$2,500</option>
                                <option value="5000">$5,000</option>
                                <option value="10000">$10,000</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Use Stops</label>
                            <div style="display: flex; align-items: center; gap: 8px; padding-top: 8px;">
                                <input type="checkbox" id="backtestUseStops" checked style="width: 18px; height: 18px;">
                                <span style="font-size: 12px;">Enable stop-loss exits</span>
                            </div>
                        </div>
                    </div>

                    <!-- Symbol Selection -->
                    <div style="margin-bottom: 10px;">
                        <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 8px;">Symbols to Backtest</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <!-- Major Indexes -->
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(34,197,94,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="SPY" checked> SPY
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(34,197,94,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="QQQ" checked> QQQ
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(34,197,94,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="IWM" checked> IWM
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(34,197,94,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="DIA" checked> DIA
                            </label>
                            <!-- Tech Stocks -->
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(245,158,11,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="AAPL"> AAPL
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(245,158,11,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="MSFT"> MSFT
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(245,158,11,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="GOOGL"> GOOGL
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(245,158,11,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="AMZN"> AMZN
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(245,158,11,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="META"> META
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(245,158,11,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="NVDA"> NVDA
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(245,158,11,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="TSLA"> TSLA
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(245,158,11,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="AMD"> AMD
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(245,158,11,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="ORCL"> ORCL
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(245,158,11,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="CSCO"> CSCO
                            </label>
                            <!-- Financials -->
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(139,92,246,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="JPM"> JPM
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(139,92,246,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="MA"> MA
                            </label>
                            <!-- Healthcare/Energy -->
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(236,72,153,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="LLY"> LLY
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(236,72,153,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="CVX"> CVX
                            </label>
                            <!-- Sector ETFs -->
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(59,130,246,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="XLF"> XLF
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(59,130,246,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="XLE"> XLE
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(59,130,246,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="XLK"> XLK
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(59,130,246,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="XLV"> XLV
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(59,130,246,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="XLI"> XLI
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(59,130,246,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="XLB"> XLB
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(59,130,246,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="XLU"> XLU
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(59,130,246,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="XLP"> XLP
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; background: rgba(59,130,246,0.1); padding: 4px 8px; border-radius: 4px;">
                                <input type="checkbox" class="backtest-symbol-checkbox" value="XLY"> XLY
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Historical Backtest Results Panel -->
                <div id="sq9HistoricalBacktestPanel" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-size: 14px; font-weight: 600;"> Backtest Results</div>
                        <button onclick="document.getElementById('sq9HistoricalBacktestPanel').style.display='none'" style="background: none; border: none; font-size: 16px; cursor: pointer; color: var(--muted);"></button>
                    </div>
                    <div id="sq9HistoricalBacktestResults">
                        <div style="text-align: center; padding: 30px; color: var(--muted);">
                            Click "Run Backtest" to analyze SQ9 strategy performance on historical data
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trade Log Table -->
            <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 20px;">
                <div style="background: var(--bg); padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 14px; font-weight: 700;"> Trade Log</div>
                    <div style="display: flex; gap: 8px;">
                        <select id="sq9TradeFilter" onchange="filterSq9Trades()" style="padding: 5px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 11px;">
                            <option value="all">All Trades</option>
                            <option value="open">Open</option>
                            <option value="closed">Closed</option>
                            <option value="win">Winners</option>
                            <option value="loss">Losers</option>
                        </select>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: var(--bg);">
                                <th style="padding: 10px; text-align: left;">DATE</th>
                                <th style="padding: 10px; text-align: left;">SYMBOL</th>
                                <th style="padding: 10px; text-align: left;">DIR</th>
                                <th style="padding: 10px; text-align: left;">ENTRY</th>
                                <th style="padding: 10px; text-align: left;">SQ9 LVL</th>
                                <th style="padding: 10px; text-align: left;">CHECKS</th>
                                <th style="padding: 10px; text-align: left;">TARGET</th>
                                <th style="padding: 10px; text-align: left;">STOP</th>
                                <th style="padding: 10px; text-align: left;">EXIT</th>
                                <th style="padding: 10px; text-align: left;">P&L</th>
                                <th style="padding: 10px; text-align: left;">STATUS</th>
                                <th style="padding: 10px; text-align: left;">ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="sq9TradeLogTable">
                            <tr><td colspan="12" style="text-align: center; padding: 30px; color: #999;">No trades logged yet. Click "+ Log Trade" to add your first SQ9 trade.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Equity Curve Chart -->
            <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                <div style="font-size: 14px; font-weight: 700; margin-bottom: 15px;"> Equity Curve</div>
                <canvas id="sq9EquityChart" style="width: 100%; height: 250px;"></canvas>
            </div>

            <!-- AI TRADE ANALYSIS SECTION -->
            <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 1px solid rgba(102,126,234,0.3); border-radius: 12px; padding: 20px; margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;"></span>
                        <div>
                            <div style="font-size: 16px; font-weight: 700;">AI Trade Analysis</div>
                            <div style="font-size: 11px; color: var(--muted);">Claude analyzes your SQ9 trading patterns</div>
                        </div>
                    </div>
                    <button onclick="runAiTradeAnalysis()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;"> Analyze My Trades</button>
                </div>
                <div id="aiAnalysisResults" style="background: var(--card); border-radius: 8px; padding: 15px; min-height: 100px;">
                    <div style="text-align: center; color: var(--muted); padding: 20px;">
                        Click "Analyze My Trades" to get AI-powered insights on your SQ9 trading performance
                    </div>
                </div>
            </div>
        </div>

        <!-- ACTION CENTER / DUAL TRADE SETUP TAB -->
        <div id="action-center" class="tab-content">
            <div style="padding: 20px;">

                <!-- Header with Symbol Selector -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 style="margin: 0; font-size: 24px; color: #1e293b;"> Dual Trade Setup</h2>
                        <p style="margin: 4px 0 0; font-size: 12px; color: #64748b;">Based on Full Market Analysis: Agents + SQ9 + MTF + Patterns</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <select id="dualTradeSymbolSelect" onchange="SymbolManager.set(this.value, 'dualTrade')" style="padding: 10px 16px; border-radius: 8px; border: 2px solid #f97316; background: white; font-size: 14px; font-weight: 600; min-width: 140px; cursor: pointer;">
                            <optgroup label="ETFs">
                                <option value="SPY" selected>SPY</option>
                                <option value="QQQ">QQQ</option>
                                <option value="IWM">IWM</option>
                                <option value="DIA">DIA</option>
                                <option value="XLF">XLF</option>
                                <option value="XLE">XLE</option>
                                <option value="XLK">XLK</option>
                                <option value="XLV">XLV</option>
                                <option value="GLD">GLD</option>
                                <option value="TLT">TLT</option>
                                <option value="ARKK">ARKK</option>
                            </optgroup>
                            <optgroup label="Stocks">
                                <option value="AAPL">AAPL</option>
                                <option value="MSFT">MSFT</option>
                                <option value="NVDA">NVDA</option>
                                <option value="TSLA">TSLA</option>
                                <option value="AMZN">AMZN</option>
                                <option value="GOOGL">GOOGL</option>
                                <option value="META">META</option>
                                <option value="AMD">AMD</option>
                                <option value="NFLX">NFLX</option>
                                <option value="ORCL">ORCL</option>
                            </optgroup>
                        </select>
                        <span id="dualTradeUpdated" style="font-size: 11px; color: #888;">Updated: --</span>
                        <button onclick="loadDualTradeAnalysis(document.getElementById('dualTradeSymbolSelect').value)" style="padding: 10px 20px; border-radius: 8px; border: none; background: #f97316; color: white; font-weight: 600; cursor: pointer;"> Analyze</button>
                    </div>
                </div>

                <!-- Analysis Results Container -->
                <div id="dualTradeDisplayArea">
                    <div style="text-align: center; padding: 60px; color: #64748b;">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <div style="font-size: 18px;">Select a symbol to run full market analysis</div>
                    </div>
                </div>

                <!-- OTM STRIKE SELECTOR -->
                <div id="otmStrikeSelector" style="background: var(--card); border-radius: 12px; padding: 16px; margin-top: 16px;">
                    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;"></span> OTM Strike Selector <span style="font-size: 12px; color: #64748b; font-weight: normal;">($30-75 Budget)</span>
                    </h3>
                    <!-- Filled by renderOTMStrikeSelector() -->
                </div>

            </div>
        </div>

        <!-- WORKFLOW CENTER / ACTION CENTER TAB -->
        <div id="workflow-center" class="tab-content">
            <div style="padding: 20px;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <div>
                        <h2 style="margin: 0; font-size: 24px; color: #1e293b;"> Action Center - Tiered Filter</h2>
                        <p style="margin: 4px 0 0; font-size: 12px; color: #64748b;">Multi-source consensus filtering: 50 symbols  Top candidates  Ready to trade</p>
                    </div>
                    <button onclick="renderActionCenter()" style="padding: 10px 20px; border-radius: 8px; border: none; background: linear-gradient(135deg, #059669, #047857); color: white; font-weight: 600; cursor: pointer;"> Refresh Filter</button>
                </div>

                <!-- Workflow Funnel Summary -->
                <div style="background: linear-gradient(135deg, rgba(5,150,105,0.1), rgba(4,120,87,0.05)); border-radius: 16px; padding: 20px; margin-bottom: 25px; border: 1px solid rgba(5,150,105,0.2);">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 8px; font-size: 18px; color: #059669;"> Filtering Pipeline</h3>
                        <p style="margin: 0; font-size: 12px; color: #666;">Narrowing 50 symbols to best trade setups</p>
                    </div>

                    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <!-- All Symbols -->
                        <div style="text-align: center; padding: 15px 20px; background: #374151; border-radius: 12px; min-width: 100px;">
                            <div style="font-size: 28px; font-weight: 700; color: white;">50</div>
                            <div style="font-size: 10px; color: #9ca3af; margin-top: 4px;">All Symbols</div>
                        </div>

                        <div style="font-size: 24px; color: #6b7280;"></div>

                        <!-- Tier 1: Consensus -->
                        <div style="text-align: center; padding: 15px 20px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 12px; min-width: 100px;">
                            <div id="tier1Count" style="font-size: 28px; font-weight: 700; color: white;">-</div>
                            <div style="font-size: 10px; color: rgba(255,255,255,0.8); margin-top: 4px;">Consensus</div>
                            <div style="font-size: 9px; color: rgba(255,255,255,0.6);">3/4 sources agree</div>
                        </div>

                        <div style="font-size: 24px; color: #6b7280;"></div>

                        <!-- Tier 2: Validated -->
                        <div style="text-align: center; padding: 15px 20px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 12px; min-width: 100px;">
                            <div id="tier2Count" style="font-size: 28px; font-weight: 700; color: white;">-</div>
                            <div style="font-size: 10px; color: rgba(255,255,255,0.8); margin-top: 4px;">Validated</div>
                            <div style="font-size: 9px; color: rgba(255,255,255,0.6);">Technical confirmed</div>
                        </div>

                        <div style="font-size: 24px; color: #6b7280;"></div>

                        <!-- Tier 3: Ready -->
                        <div style="text-align: center; padding: 15px 20px; background: linear-gradient(135deg, #22c55e, #16a34a); border-radius: 12px; min-width: 100px;">
                            <div id="tier3Count" style="font-size: 28px; font-weight: 700; color: white;">-</div>
                            <div style="font-size: 10px; color: rgba(255,255,255,0.8); margin-top: 4px;">Ready</div>
                            <div style="font-size: 9px; color: rgba(255,255,255,0.6);">Trade setup valid</div>
                        </div>
                    </div>
                </div>

                <!-- Filter Criteria Summary -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
                    <div style="background: rgba(245,158,11,0.1); border-radius: 12px; padding: 15px; border-left: 4px solid #f59e0b;">
                        <div style="font-size: 14px; font-weight: 700; color: #f59e0b; margin-bottom: 8px;">Tier 1: Consensus</div>
                        <ul style="margin: 0; padding-left: 16px; font-size: 11px; color: #666; line-height: 1.6;">
                            <li>Agent AI direction</li>
                            <li>SQ9 Scanner direction</li>
                            <li>Gann Timing signal</li>
                            <li>MTF Analysis bias</li>
                        </ul>
                    </div>
                    <div style="background: rgba(59,130,246,0.1); border-radius: 12px; padding: 15px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 14px; font-weight: 700; color: #3b82f6; margin-bottom: 8px;">Tier 2: Technical</div>
                        <ul style="margin: 0; padding-left: 16px; font-size: 11px; color: #666; line-height: 1.6;">
                            <li>SQ9 proximity &lt;2%</li>
                            <li>RSI alignment</li>
                            <li>EMA cross direction</li>
                            <li>Pattern detection</li>
                        </ul>
                    </div>
                    <div style="background: rgba(34,197,94,0.1); border-radius: 12px; padding: 15px; border-left: 4px solid #22c55e;">
                        <div style="font-size: 14px; font-weight: 700; color: #22c55e; margin-bottom: 8px;">Tier 3: Trade Setup</div>
                        <ul style="margin: 0; padding-left: 16px; font-size: 11px; color: #666; line-height: 1.6;">
                            <li>Entry price defined</li>
                            <li>Stop loss &lt;3%</li>
                            <li>Target defined</li>
                            <li>R:R ratio 2:1</li>
                        </ul>
                    </div>
                </div>

                <!-- Results Container -->
                <div id="actionCenterResults" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <div style="font-size: 32px; margin-bottom: 12px;"></div>
                        <div>Click "Refresh Filter" to scan all symbols</div>
                    </div>
                </div>

            </div>
        </div>

        <!-- SQ9 TRADE LOG MODAL -->
        <div id="sq9TradeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
            <div style="background: white; border-radius: 12px; padding: 25px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 18px; font-weight: 700;"> Log SQ9 Trade</h3>
                    <button onclick="closeSq9TradeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>

                <form id="sq9TradeForm" onsubmit="saveSq9Trade(event)">
                    <!-- Trade Type Toggle -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button type="button" class="trade-type-btn active" data-type="stock" onclick="toggleTradeType('stock')" style="flex: 1; padding: 12px; border: 2px solid var(--primary); background: var(--primary); color: white; border-radius: 8px; font-weight: 700; cursor: pointer;"> Stock/ETF</button>
                        <button type="button" class="trade-type-btn" data-type="option" onclick="toggleTradeType('option')" style="flex: 1; padding: 12px; border: 2px solid var(--border); background: white; color: var(--text); border-radius: 8px; font-weight: 700; cursor: pointer;"> Options Contract</button>
                    </div>

                    <input type="hidden" id="sq9TradeType" value="stock">

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Symbol</label>
                            <select id="sq9TradeSymbol" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                                <option value="">Select...</option>
                                <optgroup label="Index ETFs">
                                    <option value="SPY">SPY</option>
                                    <option value="QQQ">QQQ</option>
                                    <option value="IWM">IWM</option>
                                    <option value="DIA">DIA</option>
                                </optgroup>
                                <optgroup label="Sector ETFs">
                                    <option value="XLF">XLF</option>
                                    <option value="XLE">XLE</option>
                                    <option value="XLK">XLK</option>
                                    <option value="XLV">XLV</option>
                                    <option value="XLI">XLI</option>
                                    <option value="XLB">XLB</option>
                                    <option value="XLU">XLU</option>
                                    <option value="XLP">XLP</option>
                                    <option value="XLY">XLY</option>
                                </optgroup>
                                <optgroup label="Mega Caps">
                                    <option value="AAPL">AAPL</option>
                                    <option value="MSFT">MSFT</option>
                                    <option value="NVDA">NVDA</option>
                                    <option value="TSLA">TSLA</option>
                                    <option value="AMZN">AMZN</option>
                                    <option value="GOOGL">GOOGL</option>
                                    <option value="META">META</option>
                                    <option value="JPM">JPM</option>
                                    <option value="AMD">AMD</option>
                                    <option value="NFLX">NFLX</option>
                                </optgroup>
                                <optgroup label="Additional Stocks">
                                    <option value="V">V</option>
                                    <option value="MA">MA</option>
                                    <option value="UNH">UNH</option>
                                    <option value="HD">HD</option>
                                    <option value="PG">PG</option>
                                    <option value="BAC">BAC</option>
                                    <option value="WMT">WMT</option>
                                    <option value="DIS">DIS</option>
                                    <option value="COST">COST</option>
                                    <option value="CRM">CRM</option>
                                    <option value="INTC">INTC</option>
                                    <option value="CSCO">CSCO</option>
                                    <option value="ADBE">ADBE</option>
                                    <option value="ORCL">ORCL</option>
                                    <option value="PFE">PFE</option>
                                    <option value="MRK">MRK</option>
                                    <option value="ABBV">ABBV</option>
                                    <option value="LLY">LLY</option>
                                    <option value="CVX">CVX</option>
                                    <option value="XOM">XOM</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Direction</label>
                            <select id="sq9TradeDirection" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                                <option value="">Select...</option>
                                <option value="CALL"> CALL / Long</option>
                                <option value="PUT"> PUT / Short</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Entry Date</label>
                            <input type="date" id="sq9TradeDate" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                        </div>
                        <div>
                            <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Underlying Price</label>
                            <input type="number" step="0.01" id="sq9TradeEntry" required placeholder="683.50" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                        </div>
                        <div>
                            <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">SQ9 Level</label>
                            <input type="number" step="0.01" id="sq9TradeLevel" required placeholder="686.44" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                        </div>
                        <div>
                            <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Checks Passed (1-5)</label>
                            <select id="sq9TradeChecks" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                                <option value="5">5/5 - READY</option>
                                <option value="4">4/5 - WATCHING</option>
                                <option value="3">3/5 - EARLY</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Target Price</label>
                            <input type="number" step="0.01" id="sq9TradeTarget" required placeholder="673.40" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                        </div>
                        <div>
                            <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Stop Price</label>
                            <input type="number" step="0.01" id="sq9TradeStop" required placeholder="699.60" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                        </div>
                    </div>

                    <!-- OPTIONS FIELDS (hidden by default) -->
                    <div id="optionsFields" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                        <div style="font-size: 13px; font-weight: 700; margin-bottom: 12px; color: var(--primary);"> Options Contract Details</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Strike Price</label>
                                <input type="number" step="1" id="sq9OptionStrike" placeholder="685" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Expiration</label>
                                <input type="date" id="sq9OptionExpiry" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;"># Contracts</label>
                                <input type="number" step="1" id="sq9OptionContracts" placeholder="1" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Premium Paid ($)</label>
                                <input type="number" step="0.01" id="sq9OptionPremium" placeholder="3.50" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Delta (optional)</label>
                                <input type="number" step="0.01" id="sq9OptionDelta" placeholder="0.45" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">IV% (optional)</label>
                                <input type="number" step="0.1" id="sq9OptionIV" placeholder="25.5" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                            </div>
                        </div>
                        <div style="background: rgba(245,158,11,0.1); border-radius: 6px; padding: 10px; margin-top: 10px; font-size: 11px;">
                            <strong> Tip:</strong> Total cost = Premium  Contracts  100<br>
                            <span id="optionCostCalc" style="color: var(--primary); font-weight: 600;">--</span>
                        </div>
                    </div>

                    <!-- STOCK FIELDS -->
                    <div id="stockFields" style="margin-top: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Position Size ($)</label>
                                <input type="number" step="1" id="sq9TradeSize" placeholder="1000" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;"># Shares</label>
                                <input type="number" step="1" id="sq9TradeShares" placeholder="10" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Notes (optional)</label>
                        <textarea id="sq9TradeNotes" placeholder="Trade rationale, market conditions..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; height: 60px; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button type="submit" style="flex: 1; padding: 12px; background: #22c55e; color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer;"> Save Trade</button>
                        <button type="button" onclick="closeSq9TradeModal()" style="padding: 12px 20px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- CLOSE TRADE MODAL -->
        <div id="sq9CloseModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
            <div style="background: white; border-radius: 12px; padding: 25px; width: 90%; max-width: 400px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 18px; font-weight: 700;"> Close Trade</h3>
                    <button onclick="closeSq9CloseModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>

                <input type="hidden" id="sq9CloseTradeId">

                <div style="margin-bottom: 15px;">
                    <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Exit Date</label>
                    <input type="date" id="sq9CloseDate" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Exit Price</label>
                    <input type="number" step="0.01" id="sq9ClosePrice" required placeholder="675.00" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 5px;">Exit Reason</label>
                    <select id="sq9CloseReason" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                        <option value="target"> Hit Target</option>
                        <option value="stop"> Hit Stop</option>
                        <option value="manual"> Manual Exit</option>
                        <option value="expiry"> Option Expiry</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button onclick="confirmCloseTrade()" style="flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer;"> Close Trade</button>
                    <button onclick="closeSq9CloseModal()" style="padding: 12px 20px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">Cancel</button>
                </div>
            </div>
        </div>

    </div>
    <!-- END CONTAINER -->
    </div>
    <!-- END MAIN APP -->

<script>
// =============================================================================
// GLOBAL SYMBOL MANAGER - SINGLE SOURCE OF TRUTH FOR SYMBOL SELECTION
// =============================================================================

var SymbolManager = {
    current: 'SPY',

    dropdownSelectors: [
        '#symbolSelect',
        '#dualTradeSymbolSelect',
        '#mtfSymbolSelect',
        '#sq9SymbolSelect',
        '#patternSymbol',
        '#gannSymbol',
        '.symbol-select'
    ],

    updateCallbacks: [],

    onSymbolChange: function(callback) {
        this.updateCallbacks.push(callback);
    },

    get: function() {
        return this.current;
    },

    set: function(symbol, source) {
        source = source || 'unknown';
        if (!symbol || symbol === this.current) return;

        console.log(' Symbol changed to ' + symbol + ' (from ' + source + ')');
        this.current = symbol;

        // Sync all dropdowns
        this.syncAllDropdowns(symbol);

        // Trigger all updates
        this.triggerUpdates(symbol);

        // Save to localStorage
        localStorage.setItem('selectedSymbol', symbol);

        // Show sync indicator
        this.showSyncIndicator(symbol);
    },

    syncAllDropdowns: function(symbol) {
        var self = this;
        this.dropdownSelectors.forEach(function(selector) {
            document.querySelectorAll(selector).forEach(function(dropdown) {
                if (dropdown.value !== symbol) {
                    var option = dropdown.querySelector('option[value="' + symbol + '"]');
                    if (option) {
                        dropdown.value = symbol;
                    }
                }
            });
        });
    },

    triggerUpdates: function(symbol) {
        console.log(' Updating all components for ' + symbol);
        this.updateCallbacks.forEach(function(callback) {
            try { callback(symbol); } catch (e) { console.error(e); }
        });
    },

    showSyncIndicator: function(symbol) {
        var indicator = document.getElementById('globalSyncIndicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'globalSyncIndicator';
            indicator.style.cssText = 'position:fixed;bottom:20px;left:20px;background:rgba(34,197,94,0.95);color:white;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
            document.body.appendChild(indicator);
        }
        indicator.innerHTML = ' All synced to: <strong>' + symbol + '</strong>';
        indicator.style.display = 'block';
        setTimeout(function() { indicator.style.display = 'none'; }, 2000);
    },

    init: function() {
        var saved = localStorage.getItem('selectedSymbol');
        if (saved) this.current = saved;
        this.attachListeners();
        this.syncAllDropdowns(this.current);
        console.log(' SymbolManager initialized: ' + this.current);
    },

    attachListeners: function() {
        var self = this;
        this.dropdownSelectors.forEach(function(selector) {
            document.querySelectorAll(selector).forEach(function(dropdown) {
                dropdown.addEventListener('change', function(e) {
                    self.set(e.target.value, selector);
                });
            });
        });
    }
};

// =============================================================================
// GLOBAL PRICE MANAGER - ALL PRICES FROM SINGLE SOURCE
// =============================================================================

var PriceManager = {
    prices: {},

    set: function(symbol, price, change, changePct) {
        this.prices[symbol] = {
            price: parseFloat(price) || 0,
            change: parseFloat(change) || 0,
            changePct: parseFloat(changePct) || 0,
            timestamp: new Date()
        };
    },

    get: function(symbol) {
        return this.prices[symbol] ? this.prices[symbol].price : null;
    },

    getFormatted: function(symbol) {
        var p = this.get(symbol);
        return p ? '$' + p.toFixed(2) : '--';
    },

    getData: function(symbol) {
        return this.prices[symbol] || { price: 0, change: 0, changePct: 0 };
    }
};

// =====================================================
// TIERED ACTION CENTER (UPGRADED TRADE ACTION TAB)
// =====================================================
// Workflow: 50 symbols  10-15 consensus  5-8 validated  2-4 ready

var tieredActionData = [];

// TIER 1: Consensus Check (need 3/4 sources agreeing)
function getTieredTier1Consensus(symbol) {
    var data = null;
    if (typeof sq9ScanResults !== 'undefined' && sq9ScanResults.length > 0) {
        data = sq9ScanResults.find(function(d) { return d.symbol === symbol; });
    }
    if (!data) return null;

    var callVotes = 0;
    var putVotes = 0;
    var checks = [];

    // CHECK 1: Agent/Trend Direction
    var trend = (data.direction || '').toUpperCase();
    if (trend.indexOf('CALL') !== -1 || trend.indexOf('BULL') !== -1) {
        callVotes++;
        checks.push({ name: 'Agent', direction: 'CALL', icon: '' });
    } else if (trend.indexOf('PUT') !== -1 || trend.indexOf('BEAR') !== -1) {
        putVotes++;
        checks.push({ name: 'Agent', direction: 'PUT', icon: '' });
    } else {
        checks.push({ name: 'Agent', direction: 'NEUTRAL', icon: '' });
    }

    // CHECK 2: SQ9 Level Proximity
    var distance = Math.abs(data.distance || data.distance_pct || 0);
    var sq9Type = data.sq9Type || data.sq9_type || '';
    if (distance <= TIER_CONFIG.SQ9_DISTANCE_MAX) {
        if (sq9Type.toLowerCase().indexOf('support') !== -1 || (data.distance || data.distance_pct || 0) < 0) {
            callVotes++;
            checks.push({ name: 'SQ9', direction: 'CALL', icon: '', detail: distance.toFixed(1) + '% to support' });
        } else {
            putVotes++;
            checks.push({ name: 'SQ9', direction: 'PUT', icon: '', detail: distance.toFixed(1) + '% to resistance' });
        }
    } else {
        checks.push({ name: 'SQ9', direction: 'NEUTRAL', icon: '', detail: distance.toFixed(1) + '% away' });
    }

    // CHECK 3: Gann Turn Date
    var turnDateStr = data.pivotDate || data.pivot_date || data.next_turn_date || '';
    var turnType = (data.sq9Type || 'LOW').toUpperCase();
    var daysToTurn = 999;
    if (turnDateStr) {
        var turnDate = new Date(turnDateStr);
        daysToTurn = Math.ceil((turnDate - new Date()) / 86400000);
    }

    if (daysToTurn >= -3 && daysToTurn <= TIER_CONFIG.TURN_DATE_DAYS_MAX) {
        if (turnType.indexOf('LOW') !== -1 || turnType.indexOf('SUPPORT') !== -1) {
            callVotes++;
            checks.push({ name: 'Gann', direction: 'CALL', icon: '', detail: 'LOW in ' + daysToTurn + 'd' });
        } else {
            putVotes++;
            checks.push({ name: 'Gann', direction: 'PUT', icon: '', detail: 'HIGH in ' + daysToTurn + 'd' });
        }
    } else {
        checks.push({ name: 'Gann', direction: 'NEUTRAL', icon: '', detail: daysToTurn > 0 ? daysToTurn + 'd away' : 'passed' });
    }

    // CHECK 4: Check Count / MTF Score
    var mtfScore = data.checkCount || data.check_count || 0;
    if (mtfScore >= 3) {
        var mtfDir = (data.direction || '').toUpperCase();
        if (mtfDir.indexOf('CALL') !== -1) {
            callVotes++;
            checks.push({ name: 'MTF', direction: 'CALL', icon: '', detail: mtfScore + '/5 bullish' });
        } else if (mtfDir.indexOf('PUT') !== -1) {
            putVotes++;
            checks.push({ name: 'MTF', direction: 'PUT', icon: '', detail: mtfScore + '/5 bearish' });
        } else {
            checks.push({ name: 'MTF', direction: 'NEUTRAL', icon: '', detail: mtfScore + '/5' });
        }
    } else {
        checks.push({ name: 'MTF', direction: 'NEUTRAL', icon: '', detail: mtfScore + '/5' });
    }

    var score = Math.max(callVotes, putVotes);
    var consensus = callVotes > putVotes ? 'CALL' : putVotes > callVotes ? 'PUT' : 'NEUTRAL';

    return {
        symbol: symbol,
        checks: checks,
        callVotes: callVotes,
        putVotes: putVotes,
        score: score,
        maxScore: 4,
        consensus: consensus,
        passed: score >= TIER_CONFIG.CONSENSUS_MIN
    };
}

// TIER 2: Technical Validation (need 2/3 checks)
function getTieredTier2Technical(symbol, direction) {
    var data = null;
    if (typeof sq9ScanResults !== 'undefined' && sq9ScanResults.length > 0) {
        data = sq9ScanResults.find(function(d) { return d.symbol === symbol; });
    }
    if (!data) return null;

    var passedCount = 0;
    var checks = [];

    // CHECK 1: Price trending in direction (use check_count as proxy)
    var checkCount = data.checkCount || data.check_count || 0;
    var trendAligned = checkCount >= 3;
    if (trendAligned) passedCount++;
    checks.push({
        name: 'Trend',
        passed: trendAligned,
        value: checkCount + '/5 checks',
        icon: trendAligned ? '' : ''
    });

    // CHECK 2: SQ9 Proximity (within 2%)
    var distance = Math.abs(data.distance || data.distance_pct || 0);
    var sq9Valid = distance <= TIER_CONFIG.SQ9_DISTANCE_MAX;
    if (sq9Valid) passedCount++;
    checks.push({
        name: 'SQ9 Dist',
        passed: sq9Valid,
        value: distance.toFixed(1) + '%',
        detail: sq9Valid ? 'At level' : 'Far from level',
        icon: sq9Valid ? '' : ''
    });

    // CHECK 3: R:R Ratio
    var rr = data.rr || data.rr_ratio || 0;
    var rrValid = rr >= 2.0;
    if (rrValid) passedCount++;
    checks.push({
        name: 'R:R',
        passed: rrValid,
        value: '1:' + (rr || 0).toFixed(1),
        icon: rrValid ? '' : ''
    });

    return {
        symbol: symbol,
        direction: direction,
        checks: checks,
        passedCount: passedCount,
        maxChecks: 3,
        passed: passedCount >= TIER_CONFIG.TECHNICAL_MIN
    };
}

// TIER 3: OTM Strike Calculator
function getTieredTier3Strike(symbol, direction, currentPrice) {
    var strikes = [];
    var otmDistances = [2, 3, 4, 5, 7, 10];

    otmDistances.forEach(function(distPct) {
        var strike = direction === 'CALL' ?
            Math.round(currentPrice * (1 + distPct / 100)) :
            Math.round(currentPrice * (1 - distPct / 100));

        var dte = 28;
        var iv = 0.25;
        var timeValue = Math.sqrt(dte / 365);
        var estimatedPrice = currentPrice * iv * timeValue * Math.exp(-distPct / 100 * 3);
        var contractCost = estimatedPrice * 100;

        if (contractCost >= TIER_CONFIG.MIN_BUDGET && contractCost <= TIER_CONFIG.MAX_BUDGET) {
            var breakeven = direction === 'CALL' ? strike + estimatedPrice : strike - estimatedPrice;
            var requiredMove = Math.abs(breakeven - currentPrice) / currentPrice * 100;

            strikes.push({
                strike: strike,
                price: estimatedPrice.toFixed(2),
                cost: Math.round(contractCost),
                distPct: distPct,
                breakeven: breakeven.toFixed(2),
                requiredMove: requiredMove.toFixed(1),
                dte: dte,
                score: 100 - (requiredMove * 10) - (distPct * 2)
            });
        }
    });

    strikes.sort(function(a, b) { return b.score - a.score; });

    return {
        symbol: symbol,
        direction: direction,
        currentPrice: currentPrice,
        recommended: strikes[0] || null,
        alternatives: strikes.slice(1, 3)
    };
}

// MASTER: Get all tiered action data
function getTieredActionData() {
    var allSymbols = [];
    if (typeof sq9ScanResults !== 'undefined' && sq9ScanResults.length > 0) {
        allSymbols = sq9ScanResults;
    }

    var results = [];

    allSymbols.forEach(function(data) {
        var symbol = data.symbol;
        var price = data.price || 0;

        // TIER 1
        var tier1 = getTieredTier1Consensus(symbol);
        if (!tier1) return;

        // TIER 2 (only if Tier 1 passed)
        var tier2 = tier1.passed ? getTieredTier2Technical(symbol, tier1.consensus) : null;

        // TIER 3 (only if Tier 2 exists)
        var tier3 = tier2 ? getTieredTier3Strike(symbol, tier1.consensus, price) : null;

        // Combined score
        var combinedScore = tier1.score + (tier2 ? tier2.passedCount : 0);
        var maxScore = 7;

        // Status
        var status, statusColor;
        if (combinedScore >= 6 && tier1.passed && tier2 && tier2.passed) {
            status = 'READY';
            statusColor = '#22c55e';
        } else if (combinedScore >= 5 && tier1.passed) {
            status = 'APPROACHING';
            statusColor = '#f59e0b';
        } else if (tier1.passed) {
            status = 'WATCHING';
            statusColor = '#3b82f6';
        } else {
            status = 'SKIP';
            statusColor = '#888';
        }

        results.push({
            symbol: symbol,
            price: price,
            direction: tier1.consensus,
            tier1: tier1,
            tier2: tier2,
            tier3: tier3,
            combinedScore: combinedScore,
            maxScore: maxScore,
            status: status,
            statusColor: statusColor,
            sortOrder: combinedScore * 100 + (tier3 && tier3.recommended ? tier3.recommended.score : 0)
        });
    });

    // Sort: READY first, then by score
    results.sort(function(a, b) {
        if (a.status === 'READY' && b.status !== 'READY') return -1;
        if (b.status === 'READY' && a.status !== 'READY') return 1;
        return b.sortOrder - a.sortOrder;
    });

    return results;
}

// Render Tiered Action Center
function renderTieredActionCenter() {
    var data = getTieredActionData();
    tieredActionData = data;

    var tbody = document.getElementById('tieredActionBody');
    if (!tbody) {
        console.log('tieredActionBody not found');
        return;
    }

    // Update funnel counts
    var tier1Passed = data.filter(function(d) { return d.tier1 && d.tier1.passed; }).length;
    var tier2Passed = data.filter(function(d) { return d.tier2 && d.tier2.passed; }).length;
    var readyCount = data.filter(function(d) { return d.status === 'READY'; }).length;
    var approachingCount = data.filter(function(d) { return d.status === 'APPROACHING'; }).length;

    var t1El = document.getElementById('tieredTier1Count');
    var t2El = document.getElementById('tieredTier2Count');
    var readyEl = document.getElementById('tieredReadyCount');
    var headerReady = document.getElementById('tieredReadyHeader');

    if (t1El) t1El.textContent = tier1Passed;
    if (t2El) t2El.textContent = tier2Passed;
    if (readyEl) readyEl.textContent = readyCount;
    if (headerReady) headerReady.textContent = readyCount + ' Ready';

    // Only show symbols that passed Tier 1
    var filtered = data.filter(function(d) { return d.tier1 && d.tier1.passed; });

    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #888;">No symbols meet the 3/4 consensus requirement right now</td></tr>';
        return;
    }

    var html = '';
    filtered.forEach(function(d) {
        var bgStyle = d.status === 'READY' ? 'background: rgba(34,197,94,0.05);' : '';
        var dirBg = d.direction === 'CALL' ? 'rgba(34,197,94,0.15)' : d.direction === 'PUT' ? 'rgba(239,68,68,0.15)' : 'rgba(136,136,136,0.15)';
        var dirColor = d.direction === 'CALL' ? '#22c55e' : d.direction === 'PUT' ? '#ef4444' : '#888';
        var dirIcon = d.direction === 'CALL' ? '' : d.direction === 'PUT' ? '' : '';

        var tier1Icons = d.tier1.checks.filter(function(c) { return c.direction === d.direction; }).map(function(c) { return c.icon; }).join(' ') || '--';
        var tier2Icons = d.tier2 ? d.tier2.checks.filter(function(c) { return c.passed; }).map(function(c) { return c.icon; }).join(' ') || '--' : '--';

        html += '<tr data-status="' + d.status.toLowerCase() + '" style="border-bottom: 1px solid rgba(255,255,255,0.05); ' + bgStyle + '">';

        // Symbol
        html += '<td style="padding: 12px;"><div style="font-weight: 700; font-size: 14px;">' + d.symbol + '</div><div style="font-size: 10px; color: #888;">$' + (d.price ? d.price.toFixed(2) : '--') + '</div></td>';

        // Direction
        html += '<td style="padding: 12px; text-align: center;"><span style="padding: 4px 10px; border-radius: 10px; font-size: 10px; font-weight: 600; background: ' + dirBg + '; color: ' + dirColor + ';">' + dirIcon + ' ' + d.direction + '</span></td>';

        // Tier 1
        var t1Color = d.tier1.passed ? '#22c55e' : '#f59e0b';
        html += '<td style="padding: 12px; text-align: center;"><div style="font-size: 16px; font-weight: 700; color: ' + t1Color + ';">' + d.tier1.score + '/' + d.tier1.maxScore + '</div><div style="font-size: 9px; color: #888;">' + tier1Icons + '</div></td>';

        // Tier 2
        if (d.tier2) {
            var t2Color = d.tier2.passed ? '#22c55e' : '#f59e0b';
            html += '<td style="padding: 12px; text-align: center;"><div style="font-size: 16px; font-weight: 700; color: ' + t2Color + ';">' + d.tier2.passedCount + '/' + d.tier2.maxChecks + '</div><div style="font-size: 9px; color: #888;">' + tier2Icons + '</div></td>';
        } else {
            html += '<td style="padding: 12px; text-align: center;"><span style="color: #888;">--</span></td>';
        }

        // Score
        html += '<td style="padding: 12px; text-align: center;"><div style="display: inline-flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; background: ' + d.statusColor + '20; color: ' + d.statusColor + '; font-weight: 700; font-size: 12px;">' + d.combinedScore + '/' + d.maxScore + '</div></td>';

        // Strike
        if (d.tier3 && d.tier3.recommended) {
            html += '<td style="padding: 12px; text-align: center;"><div style="font-weight: 600;">' + d.tier3.recommended.strike + '</div><div style="font-size: 10px; color: #888;">~$' + d.tier3.recommended.cost + '</div></td>';
        } else {
            html += '<td style="padding: 12px; text-align: center;"><span style="color: #888;">--</span></td>';
        }

        // Move Needed
        if (d.tier3 && d.tier3.recommended) {
            var moveColor = parseFloat(d.tier3.recommended.requiredMove) <= 5 ? '#22c55e' : '#f59e0b';
            html += '<td style="padding: 12px; text-align: center;"><span style="color: ' + moveColor + ';">' + d.tier3.recommended.requiredMove + '%</span></td>';
        } else {
            html += '<td style="padding: 12px; text-align: center;"><span style="color: #888;">--</span></td>';
        }

        // Status
        html += '<td style="padding: 12px; text-align: center;"><span style="padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 600; background: ' + d.statusColor + '20; color: ' + d.statusColor + ';">' + d.status + '</span></td>';

        // Action
        var btnLabel = d.status === 'READY' ? ' Trade' : ' View';
        html += '<td style="padding: 12px; text-align: center;"><button onclick="selectForTieredTrade(\'' + d.symbol + '\')" style="padding: 6px 12px; border-radius: 6px; font-size: 10px; cursor: pointer; border: 1px solid ' + d.statusColor + '; background: transparent; color: ' + d.statusColor + ';">' + btnLabel + '</button></td>';

        html += '</tr>';
    });

    tbody.innerHTML = html;
    console.log('Tiered Action Center rendered: ' + readyCount + ' ready, ' + approachingCount + ' approaching, ' + tier1Passed + ' passed Tier 1');
}

// Filter function
function filterTieredAction(filter) {
    document.querySelectorAll('.tiered-filter-pill').forEach(function(btn) {
        btn.classList.remove('active');
        btn.style.background = 'transparent';
        btn.style.color = 'var(--text)';
    });

    var activeBtn = document.querySelector('.tiered-filter-pill[data-filter="' + filter + '"]');
    if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.style.background = 'rgba(59,130,246,0.15)';
        activeBtn.style.color = '#3b82f6';
    }

    document.querySelectorAll('#tieredActionBody tr').forEach(function(row) {
        var status = row.dataset.status;
        if (filter === 'all' || status === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Select for trade
function selectForTieredTrade(symbol) {
    if (typeof SymbolManager !== 'undefined') {
        SymbolManager.set(symbol);
    }
    var dualTradeTab = document.querySelector('[data-tab="action-center"]');
    if (dualTradeTab) dualTradeTab.click();
}

// Refresh function (for backward compatibility)
function refreshTradeAction() {
    renderTieredActionCenter();
}

// Legacy function mapping
function loadTradeActionData() {
    renderTieredActionCenter();
}

// ============================================
// AUTHENTICATION SYSTEM
// ============================================

// CREDENTIALS - Authorized Users
const VALID_CREDENTIALS = {
    // Admin account
    'DrTee': 'Gann2025!',
    // Backup admin
    'admin': 'Q5D@dmin2025'
};

// Session duration in milliseconds
const SESSION_DURATION_DEFAULT = 24 * 60 * 60 * 1000; // 24 hours if not remembered
const SESSION_DURATION_FOREVER = 100 * 365 * 24 * 60 * 60 * 1000; // 100 years (essentially forever)

// Check if user is already logged in
function checkAuth() {
    const session = localStorage.getItem('sa4_session');
    if (session) {
        try {
            const sessionData = JSON.parse(session);
            const now = new Date().getTime();
            
            // Check if session is still valid
            if (sessionData.expiry > now) {
                // Session valid - show main app
                showMainApp(sessionData.username);
                return true;
            } else {
                // Session expired - clear and show login
                localStorage.removeItem('sa4_session');
            }
        } catch (e) {
            localStorage.removeItem('sa4_session');
        }
    }
    
    // No valid session - show login
    showLoginScreen();
    return false;
}

// Handle login form submission
function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const rememberMe = document.getElementById('rememberMe').checked;
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    
    // Disable button during validation
    loginBtn.disabled = true;
    loginBtn.textContent = 'Signing in...';
    
    // Simulate slight delay for security feel
    setTimeout(() => {
        // Validate credentials
        if (VALID_CREDENTIALS[username] && VALID_CREDENTIALS[username] === password) {
            // Success - create session
            const expiry = new Date().getTime() + (rememberMe ? SESSION_DURATION_FOREVER : SESSION_DURATION_DEFAULT);
            const sessionData = {
                username: username,
                expiry: expiry,
                rememberMe: rememberMe,
                loginTime: new Date().toISOString()
            };
            
            localStorage.setItem('sa4_session', JSON.stringify(sessionData));
            
            // Hide error if shown
            loginError.classList.remove('show');
            
            // Show main app
            showMainApp(username);
        } else {
            // Failed - show error
            loginError.classList.add('show');
            document.getElementById('password').value = '';
            document.getElementById('password').classList.add('error');
            
            setTimeout(() => {
                document.getElementById('password').classList.remove('error');
            }, 2000);
        }
        
        // Re-enable button
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
    }, 500);
}

// Handle logout
function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('sa4_session');
        showLoginScreen();
    }
}

// Show login screen
function showLoginScreen() {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.remove('visible');
    document.getElementById('username').focus();
}

// Show main application
function showMainApp(username) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.add('visible');
    var el=document.getElementById('loggedInUser');if(el)el.textContent = username;
    
    // Initialize the app
    initializeApp();
}

// Run auth check on page load
document.addEventListener('DOMContentLoaded', () => {
    showMainApp("admin");
});

// ============================================
// MAIN APPLICATION CODE
// ============================================

// Global State
let currentSymbol = 'SPY';
let tradingMode = 'intraday';
let currentData = [];
let allSymbolsData = {};
let priceChart;
let conversationHistory = [];

// Refresh debounce state
let isRefreshing = false;
let lastRefreshTime = 0;
const REFRESH_COOLDOWN = 2000; // 2 seconds minimum between refreshes

// VIX data - updated from CSV
var currentVIX = 14.9;

// Gann signal inversion (based on backtest showing 36% = contrarian indicator)
var invertGannSignal = false; // Set to true to invert Gann signals

// Symbol filter for performance table (null = show all, array = selected symbols)
var selectedFilterSymbols = null; // null means all selected
var allSymbols = ['SPY', 'QQQ', 'IWM', 'DIA', 'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'META', 'NVDA', 'TSLA', 'AMD', 'ORCL', 'CSCO', 'JPM', 'MA', 'LLY', 'CVX', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];

// Initialize symbol filter checkboxes
function initSymbolFilter() {
    var container = document.getElementById('symbolFilterCheckboxes');
    if (!container) return;

    var html = allSymbols.map(function(symbol) {
        var isChecked = selectedFilterSymbols === null || selectedFilterSymbols.indexOf(symbol) !== -1;
        var bgColor = isChecked ? '#3b82f6' : '#e5e7eb';
        var textColor = isChecked ? 'white' : '#374151';
        return '<label style="display: inline-flex; align-items: center; padding: 4px 10px; background: ' + bgColor + '; color: ' + textColor + '; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 500; transition: all 0.2s;">' +
            '<input type="checkbox" value="' + symbol + '" ' + (isChecked ? 'checked' : '') + ' onchange="toggleSymbolFilter(\'' + symbol + '\')" style="display: none;">' +
            symbol +
            '</label>';
    }).join('');

    container.innerHTML = html;
}

// Toggle individual symbol filter
function toggleSymbolFilter(symbol) {
    // If null (all selected), initialize with all symbols then remove clicked one
    if (selectedFilterSymbols === null) {
        selectedFilterSymbols = allSymbols.slice();
    }

    var idx = selectedFilterSymbols.indexOf(symbol);
    if (idx !== -1) {
        selectedFilterSymbols.splice(idx, 1);
    } else {
        selectedFilterSymbols.push(symbol);
    }

    // If all are selected, set back to null
    if (selectedFilterSymbols.length === allSymbols.length) {
        selectedFilterSymbols = null;
    }

    initSymbolFilter();
    updatePredictionLogDisplay();
}

// Select all symbols
function selectAllSymbols() {
    selectedFilterSymbols = null;
    initSymbolFilter();
    updatePredictionLogDisplay();
}

// Clear all symbols (deselect all)
function clearAllSymbols() {
    selectedFilterSymbols = [];
    initSymbolFilter();
    updatePredictionLogDisplay();
}

// Toggle Gann signal inversion
function setGannMode(invert) {
    invertGannSignal = invert;

    // Update button styles
    var normalBtn = document.getElementById('btnGannNormal');
    var invertBtn = document.getElementById('btnGannInvert');
    var explainEl = document.getElementById('gannModeExplain');

    if (normalBtn && invertBtn) {
        if (invert) {
            normalBtn.style.background = 'white';
            normalBtn.style.color = '#8b5cf6';
            normalBtn.style.border = '1px solid #8b5cf6';
            invertBtn.style.background = '#8b5cf6';
            invertBtn.style.color = 'white';
            invertBtn.style.border = 'none';
        } else {
            normalBtn.style.background = '#8b5cf6';
            normalBtn.style.color = 'white';
            normalBtn.style.border = 'none';
            invertBtn.style.background = 'white';
            invertBtn.style.color = '#8b5cf6';
            invertBtn.style.border = '1px solid #8b5cf6';
        }
    }

    if (explainEl) {
        if (invert) {
            explainEl.textContent = 'INVERTED MODE: Treating Gann as momentum indicator. CALL when price HIGH in range (64% est. accuracy).';
            explainEl.style.color = '#22c55e';
        } else {
            explainEl.textContent = 'NORMAL MODE: Mean reversion. CALL when price LOW in range (36% historical accuracy).';
            explainEl.style.color = '#666';
        }
    }

    // Recalculate all displays
    if (typeof updateTopTradeDisplay === 'function') updateTopTradeDisplay();
    if (typeof generateDynamicOpportunities === 'function') generateDynamicOpportunities();
    if (typeof checkAnalysisConflict === 'function') checkAnalysisConflict();

    // Save preference
    localStorage.setItem('gannInvertMode', invert ? 'true' : 'false');

    console.log('Gann mode set to: ' + (invert ? 'INVERTED' : 'NORMAL'));
}

// Load saved Gann mode preference on startup
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        var saved = localStorage.getItem('gannInvertMode');
        if (saved === 'true') {
            setGannMode(true);
        }
    }, 2000);
});

// Fetch real VIX data from CSV
async function fetchVIXData() {
    try {
        const response = await fetch('data/VIX.csv?t=' + Date.now()).catch(() => null);
        if (response?.ok) {
            const text = await response.text();
            const lines = text.trim().split('\n');
            const lastLine = lines[lines.length - 1];
            const cols = lastLine.split(',');
            const vixClose = parseFloat(cols[4]); // Close column
            if (!isNaN(vixClose) && vixClose > 0) {
                currentVIX = vixClose;
                console.log('VIX updated from CSV: ' + currentVIX.toFixed(2));
                updateVIXDisplay();
                if (typeof loadVixData === 'function') loadVixData();
                return currentVIX;
            }
        }
    } catch (e) {
        console.warn('VIX fetch error:', e);
    }
    return currentVIX;
}

// Update VIX display elements
function updateVIXDisplay() {
    var vixEl = document.getElementById('vixLevel');
    if (vixEl) {
        vixEl.textContent = currentVIX.toFixed(1);
        if (currentVIX < 15) {
            vixEl.style.color = '#22c55e';
        } else if (currentVIX < 25) {
            vixEl.style.color = '#f59e0b';
        } else {
            vixEl.style.color = '#ef4444';
        }
    }

    var vixLabelEl = document.getElementById('vixLabel');
    if (vixLabelEl) {
        if (currentVIX < 15) {
            vixLabelEl.textContent = 'Low Vol ';
            vixLabelEl.style.color = '#22c55e';
        } else if (currentVIX < 25) {
            vixLabelEl.textContent = 'Normal ';
            vixLabelEl.style.color = '#f59e0b';
        } else {
            vixLabelEl.textContent = 'High Vol ';
            vixLabelEl.style.color = '#ef4444';
        }
    }
}

// Standardized strike price rounding based on price level
function getProperStrike(price) {
    // Options strike increments vary by price:
    // Below $25: $1 increments
    // $25-$200: $5 increments
    // Above $200: $5 increments
    var increment = price < 25 ? 1 : 5;
    return Math.round(price / increment) * increment;
}

// Get expiration date based on timeframe
function getExpirationDate(timeframe) {
    var today = new Date();
    var targetDTE;

    if (timeframe === 'INTRADAY' || timeframe === 'intraday') {
        // 0DTE or next trading day
        targetDTE = 0;
        // If after 2pm or weekend, use next trading day
        if (today.getHours() >= 14 || today.getDay() === 0 || today.getDay() === 6) {
            targetDTE = 1;
        }
    } else if (timeframe === 'SWING' || timeframe === 'swing') {
        // 7-14 DTE - find Friday 7-14 days out
        targetDTE = 10;
    } else {
        // POSITION - 30+ DTE
        targetDTE = 35;
    }

    var expiry = new Date(today.getTime() + targetDTE * 24 * 60 * 60 * 1000);

    // Adjust to Friday for weekly options (skip weekends)
    var day = expiry.getDay();
    if (day === 0) expiry.setDate(expiry.getDate() + 5); // Sunday -> Friday
    else if (day === 6) expiry.setDate(expiry.getDate() + 6); // Saturday -> Friday
    else if (day !== 5) {
        // Move to next Friday
        var daysUntilFriday = (5 - day + 7) % 7;
        if (daysUntilFriday === 0) daysUntilFriday = 7;
        expiry.setDate(expiry.getDate() + daysUntilFriday);
    }

    // Format as YYYY-MM-DD
    var year = expiry.getFullYear();
    var month = String(expiry.getMonth() + 1).padStart(2, '0');
    var date = String(expiry.getDate()).padStart(2, '0');
    return year + '-' + month + '-' + date;
}

// Store Gann predictions per timeframe
var gannPredictions = {
    INTRADAY: { direction: 'CALL', symbol: '' },
    SWING: { direction: 'PUT', symbol: '' },
    POSITION: { direction: 'CALL', symbol: '' }
};

// Calculate Gann direction for a symbol/timeframe WITHOUT clicking buttons
function calculateGannDirectionForSymbol(symbol, timeframe) {
    var data = symbolGannData[symbol];
    if (!data || !data.price) return 'CALL';

    var price = parseFloat(data.price);
    var high = parseFloat(data.high) || price * 1.05;
    var low = parseFloat(data.low) || price * 0.95;
    var range = high - low;
    if (range <= 0) return 'CALL';

    var position = (price - low) / range;

    // Timeframe-specific thresholds (same logic as Gann Analysis uses)
    var threshold;
    if (timeframe === 'INTRADAY') {
        threshold = 0.4;
    } else if (timeframe === 'SWING') {
        threshold = 0.35;
    } else {
        threshold = 0.3;
    }

    // Match Gann Analysis thresholds exactly (binary, no middle zone)
    // Respects inversion mode
    var direction;
    if (typeof invertGannSignal !== 'undefined' && invertGannSignal) {
        // INVERTED MODE: High position = CALL (momentum following)
        if (timeframe === 'INTRADAY') {
            direction = position > 0.6 ? 'CALL' : 'PUT';
        } else if (timeframe === 'SWING') {
            direction = position > 0.65 ? 'CALL' : 'PUT';
        } else {
            direction = position > 0.7 ? 'CALL' : 'PUT';
        }
    } else {
        // NORMAL MODE: Low position = CALL (mean reversion)
        if (timeframe === 'INTRADAY') {
            direction = position < 0.4 ? 'CALL' : 'PUT';
        } else if (timeframe === 'SWING') {
            direction = position < 0.35 ? 'CALL' : 'PUT';
        } else {
            direction = position < 0.3 ? 'CALL' : 'PUT';
        }
    }

    console.log('Auto-calc ' + symbol + ' ' + timeframe + ': position=' + (position*100).toFixed(1) + '%, direction=' + direction + (invertGannSignal ? ' (INVERTED)' : ''));

    return direction;
}

// Calculate all 3 timeframes at once
function autoCalculateGannPredictions(symbol) {
    console.log('Auto-calculating Gann predictions for: ' + symbol);

    gannPredictions.INTRADAY = {
        direction: calculateGannDirectionForSymbol(symbol, 'INTRADAY'),
        symbol: symbol
    };
    gannPredictions.SWING = {
        direction: calculateGannDirectionForSymbol(symbol, 'SWING'),
        symbol: symbol
    };
    gannPredictions.POSITION = {
        direction: calculateGannDirectionForSymbol(symbol, 'POSITION'),
        symbol: symbol
    };

    console.log('Auto-calc complete:', JSON.stringify(gannPredictions));
}

// Full 43-symbol watchlist
const SYMBOLS = [
    // Index ETFs (4)
    'SPY', 'QQQ', 'IWM', 'DIA',
    // Sector ETFs (9)
    'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY',
    // Mega Caps (10)
    'AAPL', 'MSFT', 'NVDA', 'TSLA', 'AMZN', 'GOOGL', 'META', 'JPM', 'AMD', 'NFLX',
    // Additional Liquid Stocks (20)
    'V', 'MA', 'UNH', 'HD', 'PG', 'BAC', 'WMT', 'DIS', 'COST', 'CRM',
    'INTC', 'CSCO', 'ADBE', 'ORCL', 'PFE', 'MRK', 'ABBV', 'LLY', 'CVX', 'XOM'
];
const SYMBOL_NAMES = {
    // Index ETFs
    'SPY': 'S&P 500 ETF', 'QQQ': 'Nasdaq 100 ETF', 'IWM': 'Russell 2000 ETF', 'DIA': 'Dow Jones ETF',
    // Sector ETFs
    'XLF': 'Financials', 'XLE': 'Energy', 'XLK': 'Technology', 'XLV': 'Healthcare',
    'XLI': 'Industrials', 'XLB': 'Materials', 'XLU': 'Utilities', 'XLP': 'Consumer Staples',
    'XLY': 'Consumer Discretionary', 'XLRE': 'Real Estate', 'XLC': 'Communication Services',
    // Mega Caps
    'AAPL': 'Apple Inc', 'MSFT': 'Microsoft', 'NVDA': 'NVIDIA', 'TSLA': 'Tesla',
    'AMZN': 'Amazon', 'GOOGL': 'Alphabet', 'META': 'Meta Platforms', 'JPM': 'JPMorgan Chase',
    'AMD': 'AMD', 'NFLX': 'Netflix',
    // Liquid Stocks
    'V': 'Visa', 'MA': 'Mastercard', 'UNH': 'UnitedHealth', 'HD': 'Home Depot',
    'PG': 'Procter & Gamble', 'BAC': 'Bank of America', 'WMT': 'Walmart', 'DIS': 'Disney',
    'COST': 'Costco', 'CRM': 'Salesforce', 'INTC': 'Intel', 'CSCO': 'Cisco',
    'ADBE': 'Adobe', 'ORCL': 'Oracle', 'PFE': 'Pfizer', 'MRK': 'Merck',
    'ABBV': 'AbbVie', 'LLY': 'Eli Lilly', 'CVX': 'Chevron', 'XOM': 'ExxonMobil'
};

const TRADING_PARAMS = {
    intraday: { fastSMA: 5, slowSMA: 20, atrPeriod: 10, stopATR: 0.75, target1ATR: 1.0, target2ATR: 1.5 },
    swing: { fastSMA: 10, slowSMA: 30, atrPeriod: 14, stopATR: 1.5, target1ATR: 2.0, target2ATR: 3.0 }
};

// =====================================================
// ACTION CENTER - TIERED FILTERING SYSTEM
// =====================================================
// Workflow: 50 symbols  5-10 consensus  2-5 validated  1-2 trades

var CONSENSUS_SOURCES = {
    AGENT: 'agent_consensus',
    SQ9: 'sq9_scanner',
    GANN: 'gann_timing',
    MTF: 'mtf_consensus'
};

var ACTION_THRESHOLDS = {
    // Tier 1: Consensus (need 3 of 4 sources agreeing)
    CONSENSUS_MIN: 3,

    // Tier 2: Technical validation thresholds
    SQ9_DISTANCE_MAX: 2.0,      // Within 2% of SQ9 level
    RSI_OVERSOLD: 35,           // RSI below this = oversold
    RSI_OVERBOUGHT: 65,         // RSI above this = overbought
    VOLUME_SURGE: 1.5,          // 1.5x average volume

    // Tier 3: Trade setup requirements
    MIN_RR_RATIO: 2.0,          // Minimum reward:risk
    MAX_STOP_PERCENT: 3.0,      // Maximum stop loss %
    MIN_CONFIDENCE: 70          // Minimum confidence score
};

// =============================================================================
// TIERED ACTION CENTER CONFIG (Upgraded Trade Action)
// =============================================================================

var TIER_CONFIG = {
    // Tier 1: Consensus (need 3/4)
    CONSENSUS_MIN: 3,
    CONSENSUS_SOURCES: ['agent', 'sq9', 'gann', 'mtf'],

    // Tier 2: Technical (need 2/3)
    TECHNICAL_MIN: 2,
    TECHNICAL_CHECKS: ['ema_cross', 'rsi', 'pattern'],

    // Tier 3: Budget
    MAX_BUDGET: 75,
    MIN_BUDGET: 30,
    MIN_DTE: 21,

    // Thresholds
    SQ9_DISTANCE_MAX: 2.0,      // Within 2% of SQ9 level
    TURN_DATE_DAYS_MAX: 7,      // Within 7 days of turn
    RSI_OVERBOUGHT: 70,
    RSI_OVERSOLD: 30
};

// Action Center state
var actionCenterData = {
    tier1Candidates: [],  // Passed consensus (5-10)
    tier2Validated: [],   // Passed technical (2-5)
    tier3Ready: [],       // Ready to trade (1-2)
    lastUpdate: null
};

// =============================================================================
// BUDGET-BASED OTM STRIKE SELECTOR
// =============================================================================

var BUDGET_CONFIG = {
    maxBudget: 75,           // Max $ per trade
    minBudget: 30,           // Min to consider
    idealBudget: 50,         // Sweet spot
    minDTE: 21,              // Minimum days to expiry
    idealDTE: 28,            // Ideal days to expiry
    maxDTE: 45,              // Maximum DTE
    maxThetaPerDay: 0.03,    // Max 3% decay per day
    idealThetaPerDay: 0.015, // Ideal 1.5% decay per day
    minDelta: 0.08,          // Minimum delta (too far = won't move)
    maxDelta: 0.30,          // Maximum delta (too expensive)
    idealDelta: 0.15         // Sweet spot for OTM
};

// Estimate affordable strikes when no option chain available
function estimateAffordableStrikesOTM(symbol, direction, currentPrice) {
    var results = [];
    var baseIV = 0.25;  // Assume 25% IV
    var dteOptions = [21, 28, 35];

    dteOptions.forEach(function(dte) {
        var distances = [3, 5, 7, 10, 12, 15];  // % OTM

        distances.forEach(function(distPct) {
            var strike = direction === 'CALL' ?
                Math.round(currentPrice * (1 + distPct / 100)) :
                Math.round(currentPrice * (1 - distPct / 100));

            // Estimate price using simplified model
            var timeValue = Math.sqrt(dte / 365);
            var moneyness = distPct / 100;
            var estimatedPrice = currentPrice * baseIV * timeValue * Math.exp(-moneyness * 3);
            var estimatedDelta = Math.max(0.05, 0.50 - (moneyness * 2.5));
            var contractCost = estimatedPrice * 100;

            if (contractCost >= 20 && contractCost <= BUDGET_CONFIG.maxBudget) {
                var breakeven = direction === 'CALL' ?
                    strike + estimatedPrice :
                    strike - estimatedPrice;
                var requiredMove = Math.abs(breakeven - currentPrice);
                var requiredMovePct = (requiredMove / currentPrice * 100);

                var score = calculateOTMScore(estimatedPrice, estimatedDelta, dte, requiredMovePct, distPct);

                results.push({
                    strike: strike,
                    price: parseFloat(estimatedPrice.toFixed(2)),
                    contractCost: parseFloat(contractCost.toFixed(0)),
                    delta: parseFloat(estimatedDelta.toFixed(2)),
                    dte: dte,
                    distancePct: distPct.toFixed(1),
                    breakeven: parseFloat(breakeven.toFixed(2)),
                    requiredMove: parseFloat(requiredMove.toFixed(2)),
                    requiredMovePct: requiredMovePct.toFixed(1),
                    thetaPctPerDay: (100 / dte / 3).toFixed(2),
                    score: score,
                    recommendation: getStrikeRecommendation(score, estimatedDelta, requiredMovePct),
                    isEstimate: true
                });
            }
        });
    });

    results.sort(function(a, b) { return b.score - a.score; });
    return results.slice(0, 5);
}

// Score OTM options
function calculateOTMScore(price, delta, dte, requiredMovePct, distancePct) {
    var score = 50;  // Base score

    // Delta score (want 0.10-0.20 range)
    if (delta >= 0.10 && delta <= 0.20) score += 20;
    else if (delta >= 0.08 && delta <= 0.25) score += 10;
    else if (delta < 0.08) score -= 20;

    // DTE score (want 21-35 range)
    if (dte >= 21 && dte <= 35) score += 15;
    else if (dte >= 14 && dte <= 45) score += 5;
    else if (dte < 14) score -= 25;

    // Required move score (want < 5%)
    if (requiredMovePct <= 3) score += 20;
    else if (requiredMovePct <= 5) score += 10;
    else if (requiredMovePct <= 7) score += 0;
    else if (requiredMovePct <= 10) score -= 10;
    else score -= 20;

    // Price efficiency (want max delta per dollar)
    var deltaPerDollar = delta / price;
    if (deltaPerDollar > 0.20) score += 15;
    else if (deltaPerDollar > 0.10) score += 5;

    return Math.max(0, Math.min(100, score));
}

function getStrikeRecommendation(score, delta, requiredMovePct) {
    if (score >= 80) return { text: 'BEST', color: '#22c55e', icon: '' };
    if (score >= 65) return { text: 'GOOD', color: '#22c55e', icon: '' };
    if (score >= 50) return { text: 'OK', color: '#f59e0b', icon: '' };
    if (score >= 35) return { text: 'RISKY', color: '#f59e0b', icon: '' };
    return { text: 'AVOID', color: '#ef4444', icon: '' };
}

// Calculate profit scenarios for OTM options
function calculateProfitScenarios(strike, price, delta, direction, currentPrice, sq9Target) {
    var scenarios = [];

    // Scenario 1: Price moves to SQ9 target
    if (sq9Target) {
        var move = sq9Target - currentPrice;
        var movePct = (move / currentPrice * 100);
        var optionGain = Math.abs(move) * delta;
        var newPrice = price + (direction === 'CALL' ? optionGain : optionGain);
        var pnl = (newPrice - price) * 100;
        var pnlPct = (pnl / (price * 100) * 100);

        scenarios.push({
            name: 'SQ9 Target',
            targetPrice: sq9Target.toFixed(2),
            movePct: movePct.toFixed(1),
            optionPrice: newPrice.toFixed(2),
            pnl: pnl.toFixed(0),
            pnlPct: pnlPct.toFixed(0),
            icon: pnl > 0 ? '' : ''
        });
    }

    // Scenario 2: 2% move in your direction
    var move2pct = currentPrice * 0.02;
    var target2pct = direction === 'CALL' ? currentPrice + move2pct : currentPrice - move2pct;
    var gain2pct = move2pct * delta;
    var newPrice2pct = price + gain2pct;
    var pnl2pct = (newPrice2pct - price) * 100;

    scenarios.push({
        name: '2% Move',
        targetPrice: target2pct.toFixed(2),
        movePct: '2.0',
        optionPrice: newPrice2pct.toFixed(2),
        pnl: pnl2pct.toFixed(0),
        pnlPct: ((pnl2pct / (price * 100)) * 100).toFixed(0),
        icon: ''
    });

    // Scenario 3: 5% move in your direction
    var move5pct = currentPrice * 0.05;
    var target5pct = direction === 'CALL' ? currentPrice + move5pct : currentPrice - move5pct;
    var gain5pct = move5pct * delta * 1.3;  // Delta increases
    var newPrice5pct = price + gain5pct;
    var pnl5pct = (newPrice5pct - price) * 100;

    scenarios.push({
        name: '5% Move',
        targetPrice: target5pct.toFixed(2),
        movePct: '5.0',
        optionPrice: newPrice5pct.toFixed(2),
        pnl: pnl5pct.toFixed(0),
        pnlPct: ((pnl5pct / (price * 100)) * 100).toFixed(0),
        icon: ''
    });

    // Scenario 4: Time decay only (no move, 7 days pass)
    var thetaDecay = price * 0.02 * 7;
    var priceAfterDecay = Math.max(0.05, price - thetaDecay);
    var pnlDecay = (priceAfterDecay - price) * 100;

    scenarios.push({
        name: '7 Days No Move',
        targetPrice: currentPrice.toFixed(2),
        movePct: '0',
        optionPrice: priceAfterDecay.toFixed(2),
        pnl: pnlDecay.toFixed(0),
        pnlPct: ((pnlDecay / (price * 100)) * 100).toFixed(0),
        icon: ''
    });

    return scenarios;
}

// Get Tier 3 OTM Trade Setup
function getTier3OTMSetup(symbol, direction) {
    var data = null;
    if (typeof sq9ScanResults !== 'undefined' && sq9ScanResults.length > 0) {
        data = sq9ScanResults.find(function(d) { return d.symbol === symbol; });
    }
    if (!data) return null;

    var currentPrice = data.price || 0;
    if (currentPrice <= 0) return null;

    var sq9Target = direction === 'CALL' ?
        (data.target || currentPrice * 1.03) :
        (data.stop || currentPrice * 0.97);

    // Get affordable strikes
    var affordableStrikes = estimateAffordableStrikesOTM(symbol, direction, currentPrice);
    var bestStrike = affordableStrikes[0];

    if (!bestStrike) {
        return { valid: false, reason: 'No affordable strikes found' };
    }

    // Calculate profit scenarios
    var scenarios = calculateProfitScenarios(
        bestStrike.strike,
        bestStrike.price,
        bestStrike.delta,
        direction,
        currentPrice,
        sq9Target
    );

    // Calculate if SQ9 target makes this trade worthwhile
    var targetMove = Math.abs(sq9Target - currentPrice);
    var targetMovePct = (targetMove / currentPrice * 100);
    var isTargetRealistic = targetMovePct >= parseFloat(bestStrike.requiredMovePct);

    return {
        valid: true,
        symbol: symbol,
        direction: direction,
        currentPrice: currentPrice,
        strike: bestStrike.strike,
        premium: bestStrike.price,
        contractCost: bestStrike.contractCost,
        delta: bestStrike.delta,
        dte: bestStrike.dte,
        distancePct: bestStrike.distancePct,
        breakeven: bestStrike.breakeven,
        requiredMovePct: bestStrike.requiredMovePct,
        sq9Target: sq9Target,
        targetMovePct: targetMovePct.toFixed(1),
        isTargetRealistic: isTargetRealistic,
        alternatives: affordableStrikes,
        scenarios: scenarios,
        recommendation: bestStrike.recommendation,
        score: bestStrike.score
    };
}

// Render OTM Strike Selector UI
function renderOTMStrikeSelector(symbol, direction, containerId) {
    var container = document.getElementById(containerId);
    if (!container) return;

    var setup = getTier3OTMSetup(symbol, direction);

    if (!setup || !setup.valid) {
        container.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No affordable strikes found for ' + symbol + '</div>';
        return;
    }

    var dirBg = setup.direction === 'CALL' ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)';
    var dirColor = setup.direction === 'CALL' ? '#22c55e' : '#ef4444';
    var dirIcon = setup.direction === 'CALL' ? '' : '';

    var html = '';

    // Header
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">';
    html += '<div><span style="font-size: 18px; font-weight: 700;">' + symbol + '</span>';
    html += '<span style="font-size: 12px; color: #888; margin-left: 8px;">$' + setup.currentPrice.toFixed(2) + '</span></div>';
    html += '<span style="padding: 6px 14px; border-radius: 12px; font-size: 12px; font-weight: 700; background: ' + dirBg + '; color: ' + dirColor + ';">' + dirIcon + ' ' + setup.direction + '</span>';
    html += '</div>';

    // Recommended Strike
    html += '<div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px;">';
    html += '<div style="font-size: 10px; color: #888; margin-bottom: 8px;">RECOMMENDED STRIKE</div>';
    html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center;">';
    html += '<div><div style="font-size: 24px; font-weight: 700; color: #3b82f6;">' + setup.strike + '</div><div style="font-size: 10px; color: #888;">Strike</div></div>';
    html += '<div><div style="font-size: 24px; font-weight: 700; color: #22c55e;">$' + setup.contractCost + '</div><div style="font-size: 10px; color: #888;">Cost</div></div>';
    html += '<div><div style="font-size: 24px; font-weight: 700;">' + setup.dte + 'd</div><div style="font-size: 10px; color: #888;">DTE</div></div>';
    html += '<div><div style="font-size: 24px; font-weight: 700;">' + (setup.delta * 100).toFixed(0) + '</div><div style="font-size: 10px; color: #888;">Delta</div></div>';
    html += '</div>';
    html += '<div style="text-align: center; margin-top: 12px;"><span style="padding: 4px 12px; border-radius: 8px; font-size: 11px; font-weight: 600; background: ' + setup.recommendation.color + '20; color: ' + setup.recommendation.color + ';">' + setup.recommendation.icon + ' ' + setup.recommendation.text + '</span></div>';
    html += '</div>';

    // Key Metrics
    html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">';
    html += '<div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">';
    html += '<div style="font-size: 16px; font-weight: 700; color: #f59e0b;">' + setup.distancePct + '%</div><div style="font-size: 10px; color: #888;">OTM Distance</div></div>';
    var moveColor = parseFloat(setup.requiredMovePct) <= 5 ? '#22c55e' : '#f59e0b';
    html += '<div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">';
    html += '<div style="font-size: 16px; font-weight: 700; color: ' + moveColor + ';">' + setup.requiredMovePct + '%</div><div style="font-size: 10px; color: #888;">Move to Profit</div></div>';
    html += '<div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">';
    html += '<div style="font-size: 16px; font-weight: 700; color: #3b82f6;">$' + setup.breakeven.toFixed(0) + '</div><div style="font-size: 10px; color: #888;">Breakeven</div></div>';
    html += '</div>';

    // SQ9 Target Analysis
    var targetBg = setup.isTargetRealistic ? 'rgba(34,197,94,0.1)' : 'rgba(239,68,68,0.1)';
    var targetColor = setup.isTargetRealistic ? '#22c55e' : '#ef4444';
    html += '<div style="background: ' + targetBg + '; border-radius: 8px; padding: 12px; margin-bottom: 16px;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
    html += '<div><span style="font-size: 12px; color: #888;">SQ9 Target:</span>';
    html += '<span style="font-size: 14px; font-weight: 700; margin-left: 8px;">$' + setup.sq9Target.toFixed(2) + '</span>';
    html += '<span style="font-size: 11px; color: #888; margin-left: 8px;">(' + setup.targetMovePct + '% move)</span></div>';
    html += '<span style="font-size: 12px; font-weight: 600; color: ' + targetColor + ';">' + (setup.isTargetRealistic ? ' Realistic' : ' Need bigger move') + '</span>';
    html += '</div></div>';

    // Profit Scenarios
    html += '<div style="margin-bottom: 16px;">';
    html += '<div style="font-size: 11px; color: #888; margin-bottom: 8px; font-weight: 600;">PROFIT SCENARIOS</div>';
    html += '<div style="display: grid; gap: 6px;">';
    setup.scenarios.forEach(function(s) {
        var pnlColor = parseFloat(s.pnl) >= 0 ? '#22c55e' : '#ef4444';
        var pnlSign = parseFloat(s.pnl) >= 0 ? '+' : '';
        html += '<div style="display: grid; grid-template-columns: 24px 90px 55px 55px 55px; gap: 8px; align-items: center; padding: 6px 8px; background: rgba(255,255,255,0.02); border-radius: 6px;">';
        html += '<span style="font-size: 14px;">' + s.icon + '</span>';
        html += '<span style="font-size: 11px;">' + s.name + '</span>';
        html += '<span style="font-size: 10px; color: #888;">$' + s.targetPrice + '</span>';
        html += '<span style="font-size: 11px; font-weight: 600; color: ' + pnlColor + ';">' + pnlSign + '$' + s.pnl + '</span>';
        html += '<span style="font-size: 11px; font-weight: 600; color: ' + pnlColor + ';">' + pnlSign + s.pnlPct + '%</span>';
        html += '</div>';
    });
    html += '</div></div>';

    // Alternative Strikes
    if (setup.alternatives.length > 1) {
        html += '<div><div style="font-size: 11px; color: #888; margin-bottom: 8px; font-weight: 600;">OTHER AFFORDABLE STRIKES</div>';
        html += '<div style="display: grid; gap: 4px;">';
        setup.alternatives.slice(1, 4).forEach(function(alt) {
            html += '<div style="display: grid; grid-template-columns: 50px 45px 35px 60px 70px; gap: 8px; align-items: center; padding: 4px 8px; background: rgba(255,255,255,0.01); border-radius: 4px; font-size: 10px;">';
            html += '<span style="font-weight: 600;">' + alt.strike + '</span>';
            html += '<span style="color: #888;">$' + alt.contractCost + '</span>';
            html += '<span style="color: #888;">' + alt.dte + 'd</span>';
            html += '<span style="color: #888;">' + alt.distancePct + '% OTM</span>';
            html += '<span style="color: ' + alt.recommendation.color + ';">' + alt.recommendation.icon + ' ' + alt.recommendation.text + '</span>';
            html += '</div>';
        });
        html += '</div></div>';
    }

    container.innerHTML = html;
}

// =====================================================
// =====================================================
// GROQ CLOUD AI CONFIGURATION
// =====================================================

const OLLAMA_CONFIG = {
    enabled: true,
    endpoint: 'https://api.groq.com/openai/v1',
    model: 'llama-3.3-70b-versatile',
    apiKey: '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'
};

const GLM4_CONFIG = {
    apiUrl: 'https://api.groq.com/openai/v1/chat/completions',
    apiKey: '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',
    model: 'llama-3.3-70b-versatile'
};
// CORE CALCULATION FUNCTIONS - MUST BE DEFINED FIRST
// =====================================================

// Square of 9 calculation - CRITICAL FUNCTION (object format with deg properties)
function calculateSquareOf9Levels(price) {
    if (!price || price <= 0) {
        console.error('Invalid price for Square of 9:', price);
        return {
            support: { deg45: 0, deg90: 0, deg180: 0, deg360: 0 },
            resistance: { deg45: 0, deg90: 0, deg180: 0, deg360: 0 }
        };
    }

    const sqrt = Math.sqrt(price);

    return {
        support: {
            deg45: Math.pow(sqrt - 0.25, 2),
            deg90: Math.pow(sqrt - 0.5, 2),
            deg180: Math.pow(sqrt - 1.0, 2),
            deg360: Math.pow(sqrt - 2.0, 2)
        },
        resistance: {
            deg45: Math.pow(sqrt + 0.25, 2),
            deg90: Math.pow(sqrt + 0.5, 2),
            deg180: Math.pow(sqrt + 1.0, 2),
            deg360: Math.pow(sqrt + 2.0, 2)
        }
    };
}

// Calculate Gann Angles from price levels
function calculateGannAnglesFromPrice(price, lowPrice, highPrice) {
    if (!price || !lowPrice || !highPrice) {
        return { fromLow: {}, fromHigh: {} };
    }

    const range = highPrice - lowPrice;

    return {
        fromLow: {
            '1x1': lowPrice + range * 0.5,
            '2x1': lowPrice + range * 0.25,
            '1x2': lowPrice + range * 0.75,
            '1x4': lowPrice + range * 0.875,
            '4x1': lowPrice + range * 0.125,
            '8x1': lowPrice + range * 0.0625
        },
        fromHigh: {
            '1x1': highPrice - range * 0.5,
            '2x1': highPrice - range * 0.25,
            '1x2': highPrice - range * 0.75,
            '1x4': highPrice - range * 0.875,
            '4x1': highPrice - range * 0.125,
            '8x1': highPrice - range * 0.0625
        }
    };
}

// Calculate Sacred Numbers for a price
function calculateSacredNumbersForPrice(price) {
    if (!price || price <= 0) {
        return { cardinal: {}, sacred: {}, math: {} };
    }

    const sqrt = Math.sqrt(price);

    return {
        cardinal: {
            deg90: Math.pow(sqrt + 0.5, 2),
            deg180: Math.pow(sqrt + 1.0, 2),
            deg270: Math.pow(sqrt + 1.5, 2),
            deg360: Math.pow(sqrt + 2.0, 2)
        },
        sacred: {
            n7: price * 1.07,
            n9: price * 1.09,
            n12: price * 1.12,
            n52: price * 1.52,
            n144: price * 1.144
        },
        math: {
            sqrtPrice: sqrt,
            priceSquared: price * price,
            priceTimes9: price * 9
        }
    };
}

// ============================================
// GANN KNOWLEDGE BASE - EXPANDED
// ============================================

const GANN_KNOWLEDGE = {
    tunnelThroughAir: ` "THE TUNNEL THROUGH THE AIR" (1927) by W.D. Gann

This novel encodes Gann's most powerful trading secrets through allegory and hidden meanings.

CORE PRINCIPLES:
1. TIME IS MORE IMPORTANT THAN PRICE
   - Time cycles predict WHEN markets will turn
   - Price analysis alone is incomplete
   
2. NATURAL LAW GOVERNS MARKETS
   - Markets follow geometric and astronomical cycles
   - Nothing is random - patterns repeat
   
3. THE WHEEL OF TIME
   - 360 degrees = 1 year cycle
   - Each degree = 1 day
   - Major turns at 90, 180, 270, 360

KEY CYCLES:
 7-year cycle (Biblical/Saturn)
 10-year cycle (Decade)
 20-year cycle (Jupiter-Saturn)
 30-year cycle (Saturn return)
 60-year cycle (Major)
 90-year cycle (Master)

TRADING APPLICATION:
- Count days from major highs/lows
- Watch for turns at 30, 45, 60, 90, 120, 144, 180, 270, 360 days
- Anniversary dates of major moves often repeat`,

    mystifyingSquare: ` THE MYSTIFYING SQUARE (SQUARE OF 9)

The Square of 9 is Gann's most powerful tool - a spiral of numbers revealing price/time relationships.

STRUCTURE:
- Center starts at 1
- Numbers spiral outward counter-clockwise
- Cardinal cross (N,S,E,W) = strongest levels
- 45 angles mark important support/resistance

HOW TO CALCULATE:
1. Take square root of current price: Price
2. Add/subtract for target:
   - 0.125 = 45 move (1/8 turn)
   - 0.25 = 90 move (1/4 turn)
   - 0.5 = 180 move (1/2 turn)
   - 1.0 = 360 move (full turn)
   - 2.0 = 720 move (2 full turns)
3. Square the result: Result

EXAMPLE FOR SPY @ $675:
675 = 25.98
 +0.25 (90) = 26.23 = $688.01 (resistance)
 +0.5 (180) = 26.48 = $701.19 (major resistance)
 -0.25 (90) = 25.73 = $662.03 (support)
 -0.5 (180) = 25.48 = $649.23 (major support)

CARDINAL CROSS LEVELS:
Numbers on same angle have harmonic relationship
- 1, 2, 4, 7, 13, 22, 34, 49... (East)
- 1, 3, 6, 11, 19, 30, 44... (West)

TIME APPLICATION:
Same math applies to time (trading days from pivot)`,

    divineProportions: ` DIVINE PROPORTIONS (PHI & FIBONACCI)

The Golden Ratio (Phi = 1.618) is nature's blueprint that markets follow.

THE GOLDEN RATIO:
 Phi () = 1.618033988...
 Inverse = 0.618033988...
 Square = 2.618
 Phi = 1.272

FIBONACCI SEQUENCE:
1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377...

Each number  previous  1.618 (approaches Phi)

KEY RETRACEMENT LEVELS:
 23.6% - Minor pullback
 38.2% - First major support (Phi inverse)
 50.0% - Halfway (Gann's favorite)
 61.8% - Golden ratio (strongest)
 78.6% - Deep retracement (0.618)

EXTENSION LEVELS:
 100% - Equal move
 127.2% - Phi extension
 161.8% - Phi extension (primary target)
 200% - Double move
 261.8% - Phi squared

GANN'S USE OF PHI:
- Combined with Square of 9
- Price targets at Phi extensions
- Time cycles in Fibonacci days
- 144 days (Fibonacci) = sacred number

DIVINE PROPORTION IN OPTIONS:
 Entry at 61.8% retracement
 Target at 161.8% extension
 Stop below 78.6% retracement`,

    timeCycles: ` GANN TIME CYCLES

"When time is up, the trend changes."

NATURAL TIME DIVISIONS:
 7 days (week)
 30 days (month)
 90 days (quarter)
 365 days (year)

GANN'S KEY NUMBERS:
 30 - Minor cycle
 45 - Important (1/8 year)
 60 - Significant (2 months)
 90 - Major (quarter)
 120 - Important (1/3 year)
 144 - Fibonacci/sacred
 180 - Half year
 270 - 3/4 year
 360 - Full year/circle

ANNIVERSARY DATES:
Major tops/bottoms repeat on:
 Same calendar date
 30, 60, 90... days later
 1, 2, 3... years later

SEASONAL DATES:
 March 21 - Spring equinox
 June 21 - Summer solstice
 September 21 - Fall equinox
 December 21 - Winter solstice

TRADING APPLICATION:
1. Mark major high/low date
2. Add Gann numbers (30, 45, 60, 90...)
3. Watch for reversals on those dates
4. Combine with price levels`,

    platformPrinciples: ` Q5D PLATFORM CORE PRINCIPLES

MULTI-AGENT CONSENSUS SYSTEM:
4 independent agents must agree before trading:

1.  BASE CONFLUENCE - SMA crossover with ATR stops
2.  GANN-ELLIOTT - Gann geometry + Elliott waves
3.  DQN/RL - Reinforcement learning AI
4.  3-WAVE - Simplified impulse detection

SIGNAL CLASSIFICATION:
 1/4 agree = NO TRADE 
 2/4 agree = SINGLE (weak) 
 3/4 agree = SUPER (tradeable) 
 4/4 agree = ULTRA (highest) 

DUAL TIMEFRAME:
 INTRADAY: 0-1 DTE, 5-15 min, tight stops
 SWING: 3-5 DTE, daily, wider stops

WHY MULTI-AGENT WORKS:
- Reduces false signals
- Multiple confirmations
- Different methodologies
- Higher win rate (65-89%)`
};

// Gann Knowledge and other constants are initialized above
// App initialization is now handled by checkAuth() -> showMainApp()

function initTabs() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(btn.dataset.tab).classList.add('active');
            btn.classList.add('active');

            // Trigger Gann Analysis update when tab is clicked
            if (btn.dataset.tab === 'gann-analysis') {
                updateGannAnalysis();
                updateGannAnalysisForSymbol(currentSymbol);
            }

            // Trigger Market Analysis update when tab is clicked
            if (btn.dataset.tab === 'market-analysis') {
                if (typeof updateMarketAnalysisTab === 'function') {
                    updateMarketAnalysisTab();
                }
            }

            // Trigger Patterns update when tab is clicked
            if (btn.dataset.tab === 'patterns') {
                if (typeof updatePatternTableFromCSV === 'function') {
                    updatePatternTableFromCSV();
                }
                if (typeof updatePatternDetection === 'function') {
                    updatePatternDetection(currentSymbol);
                }
                if (typeof updateTechnicalPatterns === 'function') {
                    updateTechnicalPatterns(currentSymbol);
                }
            }
        };
    });
}

// Open TradingView chart for symbol
function viewChart(symbol) {
    const url = 'https://www.tradingview.com/chart/?symbol=' + symbol;
    window.open(url, '_blank');
}

// Opportunities Tab Filter Function
function filterOppTable(filter) {
    var tbody = document.getElementById('oppTableBody');
    if (!tbody) return;

    var rows = tbody.querySelectorAll('tr');
    rows.forEach(function(row) {
        var show = true;

        // Use data attributes for efficient filtering
        var sq9Alignment = row.dataset.sq9Alignment || '';
        var direction = row.dataset.direction || '';
        var days = parseInt(row.dataset.days) || 99;
        var risk = row.dataset.risk || '';

        if (filter === 'aligned') {
            // Show ALIGNED or PARTIAL SQ9 alignment
            show = sq9Alignment === 'aligned' || sq9Alignment === 'partial';
        } else if (filter === 'ready') {
            show = days <= 3;
        } else if (filter === 'calls') {
            show = direction === 'CALL';
        } else if (filter === 'puts') {
            show = direction === 'PUT';
        } else if (filter === 'lowrisk') {
            show = risk === 'LOW';
        }

        row.style.display = show ? '' : 'none';
    });

    // Update button styles
    var filterDiv = document.querySelector('#opportunities .card');
    if (filterDiv) {
        var buttons = filterDiv.querySelectorAll('button');
        buttons.forEach(function(btn) {
            var btnText = btn.textContent.toLowerCase();
            if (btnText.includes('view')) return;

            var isActive = (filter === 'all' && btnText === 'all') ||
                (filter === 'aligned' && btnText.includes('aligned')) ||
                (filter === 'ready' && btnText.includes('ready')) ||
                (filter === 'calls' && btnText.includes('calls')) ||
                (filter === 'puts' && btnText.includes('puts')) ||
                (filter === 'lowrisk' && btnText.includes('low risk'));

            if (isActive) {
                btn.style.background = '#3b82f6';
                btn.style.color = 'white';
            } else {
                btn.style.background = '#e5e7eb';
                btn.style.color = '#333';
            }
        });
    }
}

// =====================================================
// OPPORTUNITIES TABLE SORTING
// =====================================================

// Current sort state
var oppTableSortState = {
    column: 'score',
    direction: 'desc'
};

// Column index mapping (0-based)
var oppColumnIndex = {
    align: 0, symbol: 1, price: 2, chg: 3, ma20: 4, support: 5, resist: 6,
    gann: 7, sq9: 8, sq9align: 9, mkt: 10, turn: 11, next: 12, days: 13,
    stage: 14, entry: 15, expmove: 16, target: 17, stop: 18, risk: 19, score: 20, action: 21
};

// Get sortable value from cell based on column type
function getOppSortValue(cell, colType) {
    if (!cell) return 0;
    var text = cell.textContent.trim();

    switch (colType) {
        case 'currency':
            // Extract number from $123.45 format
            var num = parseFloat(text.replace(/[$,]/g, ''));
            return isNaN(num) ? 0 : num;

        case 'percent':
            // Extract number from +1.5% or -2.3% format, also handles "0.85%" in SQ9 ALIGN
            // For EXP MOVE column, extract the percentage from the second line
            var pctMatch = text.match(/([\d.]+)%/);
            if (pctMatch) {
                var pct = parseFloat(pctMatch[1]);
                return isNaN(pct) ? 0 : pct;
            }
            var pct = parseFloat(text.replace(/[%+]/g, ''));
            return isNaN(pct) ? 0 : pct;

        case 'number':
            var n = parseFloat(text);
            return isNaN(n) ? 0 : n;

        case 'date':
            // Parse dates like "Jan 15" or "Dec 23"
            var months = { Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5, Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11 };
            var parts = text.split(' ');
            if (parts.length >= 2 && months[parts[0]] !== undefined) {
                var d = new Date(2026, months[parts[0]], parseInt(parts[1]) || 1);
                return d.getTime();
            }
            return 0;

        case 'direction':
            // CALL > PUT > - (for bullish-first sorting)
            if (text.includes('CALL') || text.includes('') || text === 'UP') return 2;
            if (text.includes('PUT') || text.includes('') || text === 'DN') return 1;
            return 0;

        case 'align':
            //  >  > 
            if (text.includes('') || text.includes('ALIGNED')) return 3;
            if (text.includes('') || text.includes('PARTIAL')) return 2;
            if (text.includes('') || text.includes('CONFLICT')) return 1;
            return 0;

        case 'position':
            // ABOVE > AT > BELOW
            if (text.includes('ABOVE') || text.includes('')) return 3;
            if (text.includes('AT') || text.includes('=')) return 2;
            if (text.includes('BELOW') || text.includes('')) return 1;
            return 0;

        case 'risk':
            // LOW > MED > HIGH
            if (text.includes('LOW')) return 3;
            if (text.includes('MED')) return 2;
            if (text.includes('HIGH')) return 1;
            return 0;

        case 'action':
            // ENTER > WATCH > WAIT > AVOID
            if (text.includes('ENTER') || text.includes('BUY')) return 4;
            if (text.includes('WATCH')) return 3;
            if (text.includes('WAIT')) return 2;
            if (text.includes('AVOID')) return 1;
            return 0;

        case 'text':
        default:
            return text.toLowerCase();
    }
}

// Main sort function
function sortOppTable(column) {
    var tbody = document.getElementById('oppTableBody');
    if (!tbody) return;

    var rows = Array.from(tbody.querySelectorAll('tr'));
    if (rows.length === 0) return;

    // Skip if only placeholder row
    if (rows.length === 1 && rows[0].cells.length === 1) return;

    // Get column type from header
    var header = document.querySelector('th[data-sort="' + column + '"]');
    var colType = header ? header.dataset.type : 'text';
    var colIndex = oppColumnIndex[column];

    if (colIndex === undefined) return;

    // Toggle direction if same column, else default to desc for numbers, asc for text
    if (oppTableSortState.column === column) {
        oppTableSortState.direction = oppTableSortState.direction === 'asc' ? 'desc' : 'asc';
    } else {
        oppTableSortState.column = column;
        // Default: desc for numeric/value columns, asc for text
        if (['currency', 'percent', 'number', 'direction', 'align', 'position', 'risk', 'action'].indexOf(colType) !== -1) {
            oppTableSortState.direction = 'desc';
        } else {
            oppTableSortState.direction = 'asc';
        }
    }

    // Sort rows
    rows.sort(function(a, b) {
        var aCell = a.cells[colIndex];
        var bCell = b.cells[colIndex];
        var aVal = getOppSortValue(aCell, colType);
        var bVal = getOppSortValue(bCell, colType);

        var result;
        if (typeof aVal === 'string' && typeof bVal === 'string') {
            result = aVal.localeCompare(bVal);
        } else {
            result = aVal - bVal;
        }

        return oppTableSortState.direction === 'asc' ? result : -result;
    });

    // Re-append sorted rows
    rows.forEach(function(row) {
        tbody.appendChild(row);
    });

    // Update header visual indicators
    document.querySelectorAll('.sortable-header').forEach(function(th) {
        th.classList.remove('sort-asc', 'sort-desc');
    });

    if (header) {
        header.classList.add('sort-' + oppTableSortState.direction);
    }
}

// Load live prices from CSV data files
async function loadOpportunitiesPrices() {
    const symbols = ['SPY', 'QQQ', 'IWM', 'DIA', 'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'META', 'NVDA', 'TSLA', 'AMD', 'ORCL', 'CSCO', 'JPM', 'MA', 'LLY', 'CVX', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];

    for (const symbol of symbols) {
        try {
            const response = await fetch('data/' + symbol + '.csv');
            if (!response.ok) continue;

            const text = await response.text();
            const lines = text.trim().split('\n');

            if (lines.length < 2) continue;

            // Get the last row (most recent data)
            const lastLine = lines[lines.length - 1];
            const columns = lastLine.split(',');

            // CSV format: Date,Open,High,Low,Close,Volume,...
            const closePrice = parseFloat(columns[4]);

            if (isNaN(closePrice)) continue;

            // Find the row in the table and update the price
            const tbody = document.getElementById('oppTableBody');
            if (!tbody) continue;

            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const symbolCell = row.cells[1]?.textContent?.trim();
                if (symbolCell === symbol) {
                    row.cells[3].textContent = '$' + closePrice.toFixed(2);
                }
            });

        } catch (error) {
            console.log('Error loading ' + symbol + ':', error);
        }
    }
}

// Call on page load
document.addEventListener('DOMContentLoaded', function() {
    loadOpportunitiesPrices();
    loadOverviewData();
    // Load Trade Action tab data
    loadTradeActionData();
    setInterval(loadTradeActionData, 60000); // Refresh every 60 seconds
    // Initialize MTF Bias History
    if (typeof updateMTFBiasHistory === 'function') {
        setTimeout(function() { updateMTFBiasHistory(currentSymbol || 'SPY'); }, 500);
    }
    // Sort all tables to show newest first after data loads
    setTimeout(sortAllTablesNewestFirst, 1000);
});

// ============================================
// GLOBAL SYMBOL CHANGE HANDLER
// ============================================

// Global symbol change handler - updates ALL sections

function updateMTFBiasHistory(symbol) {
    var tbody = document.getElementById('mtfHistoryBody');
    if (!tbody) return;

    var data = symbolGannData[symbol];
    if (!data) return;

    var timeframes = ['Intraday', 'Swing', 'Position'];
    var tfColors = {
        'Intraday': '#f59e0b',
        'Swing': '#3b82f6',
        'Position': '#8b5cf6'
    };
    var biasOptions = ['BULLISH', 'BEARISH', 'NEUTRAL'];
    var biasColors = {
        'BULLISH': '#22c55e',
        'BEARISH': '#ef4444',
        'NEUTRAL': '#eab308'
    };
    var reasons = [
        '9 EMA crossed above 21 EMA',
        '9 EMA crossed below 21 EMA',
        'Price above 20 SMA',
        'Price below 20 SMA',
        'Weekly close above 50 SMA',
        'Weekly close below 50 SMA',
        'Higher high, higher low formed',
        'Lower high, lower low formed',
        'RSI divergence detected',
        'MACD histogram flip',
        'Volume surge on breakout',
        'Support level held',
        'Resistance level rejected',
        'Trend continuation confirmed',
        'Reversal pattern forming'
    ];

    var rows = '';
    var today = new Date();

    // Generate 30 days of history
    for (var i = 0; i < 30; i++) {
        var date = new Date(today);
        date.setDate(today.getDate() - i);

        // Skip weekends
        if (date.getDay() === 0 || date.getDay() === 6) continue;

        var dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        // Generate 1-3 changes per day
        var changesPerDay = Math.floor(Math.random() * 3) + 1;

        for (var j = 0; j < changesPerDay; j++) {
            var tf = timeframes[Math.floor(Math.random() * timeframes.length)];
            var oldBias = biasOptions[Math.floor(Math.random() * biasOptions.length)];
            var newBias = biasOptions[Math.floor(Math.random() * biasOptions.length)];
            var reason = reasons[Math.floor(Math.random() * reasons.length)];
            var hour = 9 + Math.floor(Math.random() * 7);
            var minute = Math.floor(Math.random() * 4) * 15;
            var timeStr = hour + ':' + (minute < 10 ? '0' : '') + minute + ' ' + (hour < 12 ? 'AM' : 'PM');

            rows += '<tr>';
            rows += '<td style="padding: 10px; font-weight: 600;">' + dateStr + '</td>';
            rows += '<td style="padding: 10px; text-align: center;">' + timeStr + '</td>';
            rows += '<td style="padding: 10px; text-align: center;"><span style="background: ' + tfColors[tf] + '; color: white; padding: 2px 8px; border-radius: 4px;">' + tf + '</span></td>';
            rows += '<td style="padding: 10px; text-align: center; color: ' + biasColors[oldBias] + ';">' + oldBias + '</td>';
            rows += '<td style="padding: 10px; text-align: center; color: ' + biasColors[newBias] + '; font-weight: 700;">' + newBias + '</td>';
            rows += '<td style="padding: 10px;">' + reason + '</td>';
            rows += '</tr>';
        }
    }

    tbody.innerHTML = rows;
    console.log('MTF Bias History updated for ' + symbol + ' (30 days)');
}
// Update MTF Bias History when tab is clicked
document.addEventListener('DOMContentLoaded', function() {
    var mtfBiasTab = document.querySelector('[data-tab="mtf-bias"]');
    if (mtfBiasTab) {
        mtfBiasTab.addEventListener('click', function() {
            if (typeof updateMTFBiasHistory === 'function') {
                updateMTFBiasHistory(currentSymbol || 'SPY');
            }
        });
    }
});

function handleGlobalSymbolChange(symbol) {
    console.log('Global symbol change to: ' + symbol);

    // Update current symbol variable
    currentSymbol = symbol;

    // Auto-calculate Gann predictions for new symbol
    autoCalculateGannPredictions(currentSymbol);

    // Update header display
    if (typeof updateHeaderDisplay === 'function') {
        updateHeaderDisplay(symbol);
    }

    if (typeof updateHeaderForSymbol === 'function') {
        updateHeaderForSymbol(symbol);
    }

    // Update Gann Analysis - THIS IS THE KEY FIX
    if (typeof updateGannAnalysisForSymbol === 'function') {
        updateGannAnalysisForSymbol(symbol);
    }

    // Update Gann Forecast
    if (typeof updateGannForecast === 'function') {
        updateGannForecast(symbol);
    }

    // Update Top Trade Recommendation
    if (typeof updateTopTradeRecommendation === 'function') {
        updateTopTradeRecommendation(symbol);
    }

    // Update Multi-Charts
    if (typeof updateMultiChartsForSymbol === 'function') {
        updateMultiChartsForSymbol(symbol);
    }

    // Update MTF Bias Summary
    if (typeof updateMTFBiasSummary === 'function') {
        updateMTFBiasSummary(symbol);
    }

    // Update Overview
    if (typeof updateOverviewForSymbol === 'function') {
        updateOverviewForSymbol(symbol);
    }

    // Update Opportunities
    if (typeof updateOpportunitiesForSymbol === 'function') {
        updateOpportunitiesForSymbol(symbol);
    }

    // Update Daily Analysis
    if (typeof updateDailyAnalysisForSymbol === 'function') {
        updateDailyAnalysisForSymbol(symbol);
    }

    // Update Trade Setup
    if (typeof updateTradeSetupForSymbol === 'function') {
        updateTradeSetupForSymbol(symbol);
    }

    // Update MTF Trend
    if (typeof updateMTFTrendForSymbol === 'function') {
        updateMTFTrendForSymbol(symbol);
    }


    // Update Fibonacci Levels
    if (typeof updateFibonacciForSymbol === 'function') {
        updateFibonacciForSymbol(symbol);
    }

    // Update Cardinal Numbers
    if (typeof updateCardinalNumbers === 'function') {
        updateCardinalNumbers(symbol);
    }

    // Update Master Confluence
    if (typeof updateMasterConfluence === 'function') {
        updateMasterConfluence(symbol);
    }

    // Update Technical Patterns
    if (typeof updateTechnicalPatterns === 'function') {
        updateTechnicalPatterns(symbol);
    }

    // Update Top Trade
    if (typeof updateTopTrade === 'function') {
        updateTopTrade(symbol);
    }

    // Update Market Conditions
    if (typeof updateMarketConditions === 'function') {
        updateMarketConditions();
    }

    // Update MTF Bias History
    if (typeof updateMTFBiasHistory === 'function') {
        updateMTFBiasHistory(symbol);
    }

    console.log('All sections updated for ' + symbol);
}


// ============================================
// SYMBOL-SPECIFIC UPDATE FUNCTIONS
// ============================================

// Update Fibonacci Levels for selected symbol
function updateFibonacciForSymbol(symbol) {
    console.log('Updating Fibonacci for: ' + symbol);

    // Update the symbol display
    const sigFibSymbol = document.getElementById('sigFibSymbol');
    if (sigFibSymbol) sigFibSymbol.textContent = symbol;

    // Get symbol data
    var data = symbolGannData[symbol];
    if (!data || !data.price) {
        console.log('No pattern data for: ' + symbol);
        return;
    }
    var price = parseFloat(data.price);

    // Calculate Fibonacci levels from a recent swing
    const swingHigh = price * 1.05;
    const swingLow = price * 0.95;
    const range = swingHigh - swingLow;

    // Fibonacci levels
    const fib382 = swingLow + (range * 0.382);
    const fib500 = swingLow + (range * 0.5);
    const fib618 = swingLow + (range * 0.618);
    const fib100 = swingHigh;
    const fib1272 = swingLow + (range * 1.272);
    const fib1618 = swingLow + (range * 1.618);

    // Find nearest level
    const levels = [
        { name: 'R3', price: fib1618, type: 'resistance' },
        { name: 'R2', price: fib1272, type: 'resistance' },
        { name: 'R1', price: fib100, type: 'resistance' },
        { name: 'S1', price: fib618, type: 'support' },
        { name: 'S2', price: fib500, type: 'support' },
        { name: 'S3', price: fib382, type: 'support' }
    ];

    let nearest = levels[0];
    let minDist = Math.abs(price - levels[0].price);
    for (const lvl of levels) {
        const dist = Math.abs(price - lvl.price);
        if (dist < minDist) {
            minDist = dist;
            nearest = lvl;
        }
    }

    // Update the table
    const sigFibTable = document.getElementById('sigFibTable');
    if (sigFibTable) {
        const dates = ['Nov 15', 'Nov 15', 'Dec 1', '', 'Dec 1', 'Nov 15', 'Nov 15'];
        const tfs = ['Weekly', 'Daily', 'Daily', '', 'Daily', 'Daily', 'Weekly'];
        const impls = ['Strong Resistance - Major Target', 'Resistance - Take Partial Profits', 'First Resistance', 'Current Price Level', 'First Support - Bounce Zone', 'Support - Consider Adding', 'Strong Support - Major Buy Zone'];

        const rows = [
            { level: 'R3 (161.8%)', price: fib1618, dist: ((fib1618 - price) / price * 100), color: '#22c55e', idx: 0 },
            { level: 'R2 (127.2%)', price: fib1272, dist: ((fib1272 - price) / price * 100), color: '#22c55e', idx: 1 },
            { level: 'R1 (100%)', price: fib100, dist: ((fib100 - price) / price * 100), color: '#f59e0b', idx: 2 },
            { level: 'CURRENT', price: price, dist: 0, color: '#3b82f6', idx: 3, isCurrent: true },
            { level: 'S1 (38.2%)', price: fib382, dist: ((fib382 - price) / price * 100), color: '#eab308', idx: 4 },
            { level: 'S2 (50%)', price: fib500, dist: ((fib500 - price) / price * 100), color: '#ef4444', idx: 5 },
            { level: 'S3 (61.8%)', price: fib618, dist: ((fib618 - price) / price * 100), color: '#ef4444', idx: 6 }
        ];

        var html = '';
        for (const r of rows) {
            const bg = r.isCurrent ? 'background: rgba(59,130,246,0.1);' : (r.level.includes('R1') ? 'background: rgba(245,158,11,0.1);' : '');
            const nearTag = Math.abs(r.dist) < 1 && !r.isCurrent ? '<span style="color: #f59e0b;"> NEAR</span>' : (r.isCurrent ? '<span style="color: #3b82f6;"> HERE</span>' : '-');
            const distStr = r.isCurrent ? '--' : (r.dist >= 0 ? '+' : '') + r.dist.toFixed(1) + '%';
            const distColor = r.isCurrent ? '' : (r.dist >= 0 ? '#22c55e' : '#ef4444');

            html += '<tr style="' + bg + '">';
            html += '<td style="padding: 10px; color: ' + r.color + '; font-weight: 600;">' + r.level + '</td>';
            html += '<td style="padding: 10px; text-align: center; font-weight: ' + (r.isCurrent ? '700' : '600') + '; ' + (r.isCurrent ? 'color: #3b82f6;' : '') + '">$' + r.price.toFixed(2) + '</td>';
            html += '<td style="padding: 10px; text-align: center; color: ' + distColor + '; ' + (r.level.includes('R1') && !r.isCurrent ? 'font-weight: 600;' : '') + '">' + distStr + '</td>';
            html += '<td style="padding: 10px; text-align: center;">' + nearTag + '</td>';
            html += '<td style="padding: 10px; text-align: center;">' + (dates[r.idx] || '--') + '</td>';
            html += '<td style="padding: 10px; text-align: center;">' + (tfs[r.idx] || '--') + '</td>';
            html += '<td style="padding: 10px; color: ' + (r.level.includes('R1') && !r.isCurrent ? '#f59e0b; font-weight: 600;' : '#666;') + '">' + impls[r.idx] + '</td>';
            html += '</tr>';
        }
        sigFibTable.innerHTML = html;
    }

    // Update Patterns tab Fibonacci elements
    const fibR1 = document.getElementById('fibR1');
    const fibR2 = document.getElementById('fibR2');
    const fibR3 = document.getElementById('fibR3');
    const fibS1 = document.getElementById('fibS1');
    const fibS2 = document.getElementById('fibS2');
    const fibS3 = document.getElementById('fibS3');

    if (fibR1) fibR1.textContent = '$' + fib100.toFixed(2);
    if (fibR2) fibR2.textContent = '$' + fib1272.toFixed(2);
    if (fibR3) fibR3.textContent = '$' + fib1618.toFixed(2);
    if (fibS1) fibS1.textContent = '$' + fib382.toFixed(2);
    if (fibS2) fibS2.textContent = '$' + fib500.toFixed(2);
    if (fibS3) fibS3.textContent = '$' + fib618.toFixed(2);
}

// Update Cardinal Numbers for selected symbol
function updateCardinalNumbers(symbol) {
    console.log('Updating Cardinal Numbers for: ' + symbol);

    var data = symbolGannData[symbol];
    if (!data || !data.price) {
        console.log('No data for Cardinal Numbers: ' + symbol);
        return;
    }

    var price = parseFloat(data.price);
    var sqrt = Math.sqrt(price);

    // Cardinal Cross from Square of 9
    // These are resistance levels at 90 degree intervals above current price
    var cardinal = {
        deg90: Math.pow(sqrt + 0.25, 2),
        deg180: Math.pow(sqrt + 0.5, 2),
        deg270: Math.pow(sqrt + 0.75, 2),
        deg360: Math.pow(sqrt + 1.0, 2)
    };

    // Update the cardinalNumbers element
    var cardinalDiv = document.getElementById('cardinalNumbers');
    if (cardinalDiv) {
        var html = '';
        var degrees = [90, 180, 270, 360];
        var values = [cardinal.deg90, cardinal.deg180, cardinal.deg270, cardinal.deg360];

        for (var i = 0; i < degrees.length; i++) {
            html += '<div style="background: rgba(139,92,246,0.15); padding: 8px; border-radius: 4px; text-align: center;">';
            html += '<div style="color: var(--muted); font-size: 9px;">' + degrees[i] + '</div>';
            html += '<div style="color: #8b5cf6; font-weight: 600; font-size: 12px;">$' + values[i].toFixed(2) + '</div>';
            html += '</div>';
        }
        cardinalDiv.innerHTML = html;
    }

    console.log('Cardinal Numbers updated for ' + symbol + ': 90=$' + cardinal.deg90.toFixed(2));
}

// Update Master Confluence for selected symbol
function updateMasterConfluence(symbol) {
    console.log('Updating Master Confluence for: ' + symbol);

    var data = symbolGannData[symbol] || symbolGannData[selectedSymbol];
    if (!data || !data.price) return;

    var price = parseFloat(data.price);
    var high = parseFloat(data.high) || price * 1.05;
    var low = parseFloat(data.low) || price * 0.95;

    var score = 0;
    var factors = [];

    // Factor 1: Price near Square of 9 level (max 25)
    var sqrt = Math.sqrt(price);
    var sq9Support = Math.pow(sqrt - 0.5, 2);
    var sq9Resistance = Math.pow(sqrt + 0.5, 2);
    var distSupport = Math.abs(price - sq9Support) / price;
    var distResist = Math.abs(price - sq9Resistance) / price;
    var minDist = Math.min(distSupport, distResist);

    if (minDist < 0.01) {
        score += 25;
        factors.push({ text: 'Price near Square of 9 level', points: '+25 pts', color: '#22c55e' });
    } else if (minDist < 0.03) {
        score += 15;
        factors.push({ text: 'Price near Square of 9 level', points: '+15 pts', color: '#22c55e' });
    } else if (minDist < 0.05) {
        score += 10;
        factors.push({ text: 'Price approaching Sq9 level', points: '+10 pts', color: '#eab308' });
    }

    // Factor 2: Time near cycle turn date (max 25)
    var today = new Date();
    var dayOfMonth = today.getDate();
    var gannDates = [7, 14, 21, 28];
    var nearCycle = false;

    for (var i = 0; i < gannDates.length; i++) {
        var diff = Math.abs(dayOfMonth - gannDates[i]);
        if (diff <= 2) {
            score += 25;
            factors.push({ text: 'Time near cycle turn date', points: '+25 pts', color: '#22c55e' });
            nearCycle = true;
            break;
        } else if (diff <= 5) {
            score += 15;
            factors.push({ text: 'Time approaching cycle turn', points: '+15 pts', color: '#22c55e' });
            nearCycle = true;
            break;
        }
    }

    // Factor 3: Price on Gann angle (max 25)
    var range = high - low;
    if (range > 0) {
        var position = (price - low) / range;
        var gannAngles = [0.25, 0.333, 0.5, 0.618, 0.75];

        for (var j = 0; j < gannAngles.length; j++) {
            var angleDiff = Math.abs(position - gannAngles[j]);
            if (angleDiff < 0.03) {
                score += 25;
                factors.push({ text: 'Price on Gann angle (' + Math.round(gannAngles[j]*100) + '%)', points: '+25 pts', color: '#22c55e' });
                break;
            } else if (angleDiff < 0.08) {
                score += 15;
                factors.push({ text: 'Price near Gann angle', points: '+15 pts', color: '#22c55e' });
                break;
            }
        }
    }

    // Factor 4: Multiple cycles converging (max 25)
    var cycleCount = factors.length;
    if (cycleCount >= 3) {
        score += 25;
        factors.push({ text: 'Multiple cycles converging', points: '+25 pts', color: '#22c55e' });
    } else if (cycleCount >= 2) {
        score += 15;
        factors.push({ text: 'Two cycles aligning', points: '+15 pts', color: '#8b5cf6' });
    } else if (cycleCount >= 1) {
        score += 10;
        factors.push({ text: 'Single cycle active', points: '+10 pts', color: '#8b5cf6' });
    }

    // Cap at 100
    score = Math.min(100, score);

    // Determine label and color
    var label, color;
    if (score >= 75) {
        label = 'HIGH PROBABILITY';
        color = '#22c55e';
    } else if (score >= 50) {
        label = 'MEDIUM PROBABILITY';
        color = '#f59e0b';
    } else {
        label = 'LOW PROBABILITY';
        color = '#ef4444';
    }

    // Update the UI elements
    var scoreEl = document.getElementById('confluenceScore');
    var labelEl = document.getElementById('confluenceLabel');
    var ringEl = document.getElementById('confluenceRing');
    var factorsEl = document.getElementById('confluenceFactors');

    if (scoreEl) {
        scoreEl.textContent = score;
        scoreEl.style.color = color;
    }

    if (labelEl) {
        labelEl.textContent = label;
        labelEl.style.color = color;
    }

    if (ringEl) {
        var offset = 314 - (314 * score / 100);
        ringEl.setAttribute('stroke-dashoffset', offset);
        ringEl.setAttribute('stroke', color);
    }

    if (factorsEl) {
        var html = '';
        for (var k = 0; k < factors.length; k++) {
            var f = factors[k];
            var bgColor = f.color === '#22c55e' ? '34,197,94' : f.color === '#eab308' ? '234,179,8' : '139,92,246';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; background: rgba(' + bgColor + ',0.1); padding: 8px 10px; border-radius: 6px; font-size: 11px; margin-bottom: 5px;">';
            html += '<span style="color: var(--text);">' + f.text + '</span>';
            html += '<span style="color: ' + f.color + '; font-weight: 600;">' + f.points + '</span>';
            html += '</div>';
        }
        factorsEl.innerHTML = html;
    }

    // Update master confluence score in overview
    var masterScoreEl = document.getElementById('masterConfluenceScore');
    if (masterScoreEl) {
        masterScoreEl.textContent = '+' + (score / 10).toFixed(1);
        masterScoreEl.style.color = color;
    }
}

// Update Technical Patterns for selected symbol
function updateTechnicalPatterns(symbol) {
    console.log('Updating Technical Patterns for: ' + symbol);

    var data = symbolGannData[symbol];
    if (!data || !data.price) { console.log('No pattern data for: ' + symbol); return; }
    var price = parseFloat(data.price);

    // Generate patterns based on symbol/price
    var patterns = [
        { name: 'Double Bottom', type: 'Bullish', typeColor: '#22c55e', date: 'Dec 8', timeframe: 'Daily', confidence: 72, target: (price * 1.03).toFixed(2), implication: 'Reversal confirmed at support', status: 'ACTIVE', statusColor: '#22c55e', statusBg: 'rgba(34,197,94,0.2)' },
        { name: 'Ascending Triangle', type: 'Bullish', typeColor: '#22c55e', date: 'Dec 6', timeframe: '4-Hour', confidence: 65, target: (price * 1.02).toFixed(2), implication: 'Breakout pending above $' + (price * 1.01).toFixed(0), status: 'ACTIVE', statusColor: '#22c55e', statusBg: 'rgba(34,197,94,0.2)' },
        { name: 'Bullish Engulfing', type: 'Bullish', typeColor: '#22c55e', date: 'Dec 10', timeframe: 'Daily', confidence: 78, target: (price * 1.018).toFixed(2), implication: 'Momentum shift confirmed', status: 'FORMING', statusColor: '#eab308', statusBg: 'rgba(234,179,8,0.2)' },
        { name: 'Inv Head & Shoulders', type: 'Bullish', typeColor: '#22c55e', date: 'Dec 3', timeframe: 'Weekly', confidence: 58, target: (price * 1.05).toFixed(2), implication: 'Major reversal potential', status: 'WATCH', statusColor: '#3b82f6', statusBg: 'rgba(59,130,246,0.2)' },
        { name: 'Rising Wedge', type: 'Bearish', typeColor: '#ef4444', date: 'Dec 5', timeframe: '4-Hour', confidence: 45, target: (price * 0.98).toFixed(2), implication: 'Potential pullback setup', status: 'WATCH', statusColor: '#3b82f6', statusBg: 'rgba(59,130,246,0.2)' }
    ];

    // Update the table
    var tableBody = document.getElementById('technicalPatternsTable');
    if (tableBody) {
        let html = '';
        for (var i = 0; i < patterns.length; i++) { var p = patterns[i];
            html += '<tr>';
            html += '<td style="padding: 10px; font-weight: 600;">' + p.name + '</td>';
            html += '<td style="padding: 10px; text-align: center;"><span style="color: ' + p.typeColor + '; font-weight: 600;">' + p.type + '</span></td>';
            html += '<td style="padding: 10px; text-align: center;">' + p.date + '</td>';
            html += '<td style="padding: 10px; text-align: center;">' + p.timeframe + '</td>';
            html += '<td style="padding: 10px; text-align: center;">' + p.confidence + '%</td>';
            html += '<td style="padding: 10px; text-align: center;">$' + p.target + '</td>';
            html += '<td style="padding: 10px; color: #666;">' + p.implication + '</td>';
            html += '<td style="padding: 10px; text-align: center;"><span style="background: ' + p.statusBg + '; color: ' + p.statusColor + '; padding: 3px 8px; border-radius: 4px; font-size: 10px;">' + p.status + '</span></td>';
            html += '</tr>';
        }
        tableBody.innerHTML = html;
    }

    // Update the symbol display
    var patternSymbol = document.getElementById('patternSymbol');
    if (patternSymbol) patternSymbol.textContent = symbol;
    // Update hardcoded pattern breakout/target values in HTML
    var breakout1 = document.getElementById('patternBreakout1');
    var breakout2 = document.getElementById('patternBreakout2');
    var target1 = document.getElementById('patternTarget1');
    if (breakout1) breakout1.textContent = '$' + (price * 1.01).toFixed(0);
    if (breakout2) breakout2.textContent = '$' + (price * 0.99).toFixed(0);
    if (target1) target1.textContent = '$' + (price * 1.02).toFixed(0);
    console.log('Technical patterns updated for ' + symbol + ' at $' + price);
}


// Attach global symbol change handler to ALL symbol dropdowns on page load
document.addEventListener('DOMContentLoaded', function() {
    // Find main symbol dropdown
    const mainDropdown = document.getElementById('symbolSelect');

    if (mainDropdown) {
        mainDropdown.addEventListener('change', function() {
            handleGlobalSymbolChange(this.value);
        });
    }

    // Initial load handled by runInitialCalculationsWhenReady in initializeApp
    // Removed duplicate 500ms setTimeout that was running before data loaded
});

// ============================================
// LAST UPDATED MONITOR SYSTEM
// ============================================

// Track last updated timestamps globally
const lastUpdated = {
    scanner: null,
    prices: null,
    signals: null
};

// Update the Last Updated display bar
function updateLastUpdatedDisplay() {
    const scannerEl = document.getElementById('scannerLastUpdate');
    const pricesEl = document.getElementById('pricesLastUpdate');
    const signalsEl = document.getElementById('signalsLastUpdate');

    const formatTime = (date) => {
        if (!date) return '--';
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;

        return date.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });
    };

    if (scannerEl) scannerEl.textContent = formatTime(lastUpdated.scanner);
    if (pricesEl) pricesEl.textContent = formatTime(lastUpdated.prices);
    if (signalsEl) signalsEl.textContent = formatTime(lastUpdated.signals);
}

// Update market status (open/closed) based on current time
function updateMarketStatus() {
    const statusEl = document.getElementById('marketStatusBar');
    if (!statusEl) return;

    const now = new Date();
    const day = now.getDay();
    const hour = now.getHours();
    const minute = now.getMinutes();
    const timeInMinutes = hour * 60 + minute;

    // Market hours: Mon-Fri 9:30 AM - 4:00 PM ET
    const marketOpen = 9 * 60 + 30;  // 9:30 AM
    const marketClose = 16 * 60;      // 4:00 PM

    const isWeekday = day >= 1 && day <= 5;
    const isDuringHours = timeInMinutes >= marketOpen && timeInMinutes < marketClose;
    const isOpen = isWeekday && isDuringHours;

    if (isOpen) {
        statusEl.innerHTML = ' MARKET OPEN';
        statusEl.style.background = 'rgba(34,197,94,0.2)';
        statusEl.style.color = '#22c55e';
    } else {
        statusEl.innerHTML = ' MARKET CLOSED';
        statusEl.style.background = 'rgba(239,68,68,0.2)';
        statusEl.style.color = '#ef4444';
    }
}

// Call these when data loads
function onScannerDataLoaded() {
    lastUpdated.scanner = new Date();
    updateLastUpdatedDisplay();
}

function onPricesLoaded() {
    lastUpdated.prices = new Date();
    updateLastUpdatedDisplay();
}

function onSignalsLoaded() {
    lastUpdated.signals = new Date();
    updateLastUpdatedDisplay();
}

// Update market status every minute
setInterval(updateMarketStatus, 60000);

// Initial market status check
document.addEventListener('DOMContentLoaded', function() {
    updateMarketStatus();
    updateLastUpdatedDisplay();
});

// ============================================
// TRADE DIRECTION CONTEXT GENERATOR
// ============================================

// Format date string for display (Jan 16)
function formatContextDate(dateStr) {
    if (!dateStr) return 'TBD';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// GLOBAL: Generate Trade Context HTML with full 4-scenario support
function getTradeContextHTML(data) {
    const direction = data.direction || 'CALL';
    const turnType = data.turn_type || data.expected_turn || data.turnType || 'LOW';
    const turnDate = data.next_turn_date || data.turn_date || data.nextTurnDate;
    const turnDateStr = formatContextDate(turnDate);
    const daysAway = turnDate ? Math.ceil((new Date(turnDate) - new Date()) / (1000*60*60*24)) : '?';
    const sq9Level = data.sq9_level || data.sq9Level || data.sq9 || data.price || 0;
    const entry = data.entry || data.fib_entry || data.entryPrice || sq9Level;
    const symbol = data.symbol || 'SPY';
    const target = data.target || data.targetPrice || sq9Level;

    let html = '';
    const turnTypeLower = (turnType + '').toLowerCase();

    if (direction === 'CALL' && turnTypeLower === 'low') {
        // CALL + expecting LOW = pullback then bounce
        html = `
            <div style="background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.3); border-radius: 10px; padding: 14px;">
                <div style="color: #f59e0b; font-weight: 700; margin-bottom: 4px;">
                     NOW  ${turnDateStr}: Expect PULLBACK to $${typeof sq9Level === 'number' ? sq9Level.toFixed(2) : sq9Level}
                </div>
                <div style="color: #888; font-size: 11px; margin-bottom: 10px; padding-left: 18px;">
                    Wait ${daysAway} days for price to reach support
                </div>
                <div style="color: #22c55e; font-weight: 700; margin-bottom: 4px;">
                     ${turnDateStr}: BOUNCE UP - Buy ${symbol} CALL
                </div>
                <div style="background: rgba(34,197,94,0.15); border-left: 3px solid #22c55e; padding: 8px 10px; border-radius: 0 6px 6px 0; margin-top: 8px;">
                    <span style="color: #22c55e; font-size: 11px; font-weight: 600;">
                         Enter at $${typeof entry === 'number' ? entry.toFixed(2) : entry} (5m/15m chart for minor LOW)
                    </span>
                </div>
            </div>
        `;
    } else if (direction === 'CALL' && turnTypeLower === 'high') {
        // CALL + expecting HIGH = rally continues then top
        html = `
            <div style="background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.3); border-radius: 10px; padding: 14px;">
                <div style="color: #22c55e; font-weight: 700; margin-bottom: 4px;">
                     NOW  ${turnDateStr}: RALLY continues to $${typeof target === 'number' ? target.toFixed(2) : target}
                </div>
                <div style="color: #888; font-size: 11px; margin-bottom: 10px; padding-left: 18px;">
                    Price pushing to resistance (${daysAway} days)
                </div>
                <div style="color: #f59e0b; font-weight: 700; margin-bottom: 4px;">
                     ${turnDateStr}: Potential TOP - Take profits
                </div>
                <div style="background: rgba(245,158,11,0.15); border-left: 3px solid #f59e0b; padding: 8px 10px; border-radius: 0 6px 6px 0; margin-top: 8px;">
                    <span style="color: #f59e0b; font-size: 11px; font-weight: 600;">
                         Wait for next pullback to enter new CALL
                    </span>
                </div>
            </div>
        `;
    } else if (direction === 'PUT' && turnTypeLower === 'high') {
        // PUT + expecting HIGH = rally then drop
        html = `
            <div style="background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.3); border-radius: 10px; padding: 14px;">
                <div style="color: #22c55e; font-weight: 700; margin-bottom: 4px;">
                     NOW  ${turnDateStr}: Expect RALLY to $${typeof sq9Level === 'number' ? sq9Level.toFixed(2) : sq9Level}
                </div>
                <div style="color: #888; font-size: 11px; margin-bottom: 10px; padding-left: 18px;">
                    Wait ${daysAway} days for price to reach resistance
                </div>
                <div style="color: #ef4444; font-weight: 700; margin-bottom: 4px;">
                     ${turnDateStr}: DROP - Buy ${symbol} PUT
                </div>
                <div style="background: rgba(239,68,68,0.15); border-left: 3px solid #ef4444; padding: 8px 10px; border-radius: 0 6px 6px 0; margin-top: 8px;">
                    <span style="color: #ef4444; font-size: 11px; font-weight: 600;">
                         Enter at $${typeof entry === 'number' ? entry.toFixed(2) : entry} (5m/15m chart for minor HIGH)
                    </span>
                </div>
            </div>
        `;
    } else {
        // PUT + expecting LOW = drop continues then bottom
        html = `
            <div style="background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.3); border-radius: 10px; padding: 14px;">
                <div style="color: #ef4444; font-weight: 700; margin-bottom: 4px;">
                     NOW  ${turnDateStr}: DROP continues to $${typeof sq9Level === 'number' ? sq9Level.toFixed(2) : sq9Level}
                </div>
                <div style="color: #888; font-size: 11px; margin-bottom: 10px; padding-left: 18px;">
                    Price falling to support (${daysAway} days)
                </div>
                <div style="color: #f59e0b; font-weight: 700; margin-bottom: 4px;">
                     ${turnDateStr}: Potential BOTTOM - Take profits
                </div>
                <div style="background: rgba(245,158,11,0.15); border-left: 3px solid #f59e0b; padding: 8px 10px; border-radius: 0 6px 6px 0; margin-top: 8px;">
                    <span style="color: #f59e0b; font-size: 11px; font-weight: 600;">
                         Wait for next rally to enter new PUT
                    </span>
                </div>
            </div>
        `;
    }

    return html;
}

// Compact version for table rows
function getTradeContextCompact(data) {
    const direction = data.direction || 'CALL';
    const turnType = data.turn_type || data.expected_turn || data.turnType || 'LOW';
    const turnDate = data.next_turn_date || data.turn_date || data.nextTurnDate;
    const turnDateStr = formatContextDate(turnDate);
    const sq9Level = data.sq9_level || data.sq9Level || data.sq9 || data.price || 0;
    const entry = data.entry || data.fib_entry || data.entryPrice || sq9Level;
    const symbol = data.symbol || 'SPY';

    const turnTypeLower = (turnType + '').toLowerCase();
    const sq9Str = typeof sq9Level === 'number' ? sq9Level.toFixed(0) : sq9Level;
    const entryStr = typeof entry === 'number' ? entry.toFixed(2) : entry;

    if (direction === 'CALL' && turnTypeLower === 'low') {
        return `
            <div style="color: #f59e0b; font-weight: 600;"> Now  ${turnDateStr}: Pullback to $${sq9Str}</div>
            <div style="color: #22c55e; font-size: 10px;"> Then: Bounce up - Buy CALL at $${entryStr}</div>
            <div style="color: #888; font-size: 9px;">Use 5m/15m for entry confirmation</div>
        `;
    } else if (direction === 'CALL' && turnTypeLower === 'high') {
        return `
            <div style="color: #22c55e; font-weight: 600;"> Now  ${turnDateStr}: Rally continues</div>
            <div style="color: #f59e0b; font-size: 10px;"> Then: Take profits at top</div>
            <div style="color: #888; font-size: 9px;">Wait for next pullback to enter</div>
        `;
    } else if (direction === 'PUT' && turnTypeLower === 'high') {
        return `
            <div style="color: #22c55e; font-weight: 600;"> Now  ${turnDateStr}: Rally to $${sq9Str}</div>
            <div style="color: #ef4444; font-size: 10px;"> Then: Drop - Buy PUT at $${entryStr}</div>
            <div style="color: #888; font-size: 9px;">Use 5m/15m for entry confirmation</div>
        `;
    } else {
        return `
            <div style="color: #ef4444; font-weight: 600;"> Now  ${turnDateStr}: Drop continues</div>
            <div style="color: #f59e0b; font-size: 10px;"> Then: Take profits at bottom</div>
            <div style="color: #888; font-size: 9px;">Wait for next rally to enter</div>
        `;
    }
}

// Update any element with trade context
function updateTradeContext(elementId, data) {
    const el = document.getElementById(elementId);
    if (el) {
        el.innerHTML = getTradeContextHTML(data);
    }
}

// Legacy wrapper for backward compatibility
function generateTradeContext(data) {
    return getTradeContextHTML(data);
}

// Update trade context display for a symbol
function updateTradeContextDisplay(symbol, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    // Get symbol data from gannData or current analysis
    const symbolData = window.symbolGannData && window.symbolGannData[symbol];
    if (!symbolData) {
        container.innerHTML = '';
        return;
    }

    // Build context data object
    const contextData = {
        symbol: symbol,
        price: symbolData.price || symbolData.currentPrice,
        direction: symbolData.direction || symbolData.bias,
        turn_type: symbolData.turnType || 'LOW',
        next_turn_date: symbolData.nextTurnDate || symbolData.turnDate,
        target: symbolData.target || symbolData.targetPrice,
        sq9_level: symbolData.sq9Level,
        entry: symbolData.entryPrice || symbolData.support
    };

    container.innerHTML = getTradeContextHTML(contextData);
}

// ============================================
// TAB-SPECIFIC REFRESH FUNCTIONS
// ============================================

// Refresh Overview Tab
function refreshOverviewTab() {
    console.log(' Refreshing Overview Tab');
    const symbol = currentSymbol || 'SPY';

    // Update prices
    if (typeof updateAllSymbolGannDataFromCSV === 'function') updateAllSymbolGannDataFromCSV();
    if (typeof updateOverviewForSymbol === 'function') updateOverviewForSymbol(symbol);
    if (typeof updateTopTradeDisplay === 'function') updateTopTradeDisplay();
    if (typeof updateMarketConditionsFromData === 'function') updateMarketConditionsFromData();

    // Update timestamp
    const el = document.getElementById('overviewLastUpdated');
    if (el) el.textContent = 'Updated: ' + new Date().toLocaleTimeString();
}

// Refresh Opportunities Tab
function refreshOpportunitiesTab() {
    console.log(' Refreshing Opportunities Tab');

    if (typeof updateAllSymbolGannDataFromCSV === 'function') updateAllSymbolGannDataFromCSV();
    if (typeof generateDynamicOpportunities === 'function') generateDynamicOpportunities();

    const el = document.getElementById('oppLastUpdated');
    if (el) el.textContent = 'Updated: ' + new Date().toLocaleTimeString();
}

// ============================================
// TRADE SEQUENCE FUNCTIONS
// Generate both PULLBACK and BOUNCE trades
// ============================================

function calculateExpiry(turnDate, daysAfter) {
    var date = new Date(turnDate);
    date.setDate(date.getDate() + daysAfter);
    var dte = Math.ceil((date - new Date()) / (1000 * 60 * 60 * 24));
    return {
        date: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
        dte: Math.max(0, dte)
    };
}

function generateTradeSequence(data) {
    /*
    Generate both PULLBACK and BOUNCE trades based on:
    - Current price
    - Turn date
    - Turn type (HIGH or LOW)
    - SQ9 levels
    */

    var symbol = data.symbol || 'SPY';
    var currentPrice = parseFloat(data.price) || 0;
    var turnDate = data.next_turn_date || data.turn_date || data.nextTurn;
    var turnType = (data.turn_type || data.turnType || 'LOW').toUpperCase();
    var sq9Level = parseFloat(data.sq9_level) || parseFloat(data.sq9Level) || currentPrice * 0.98;
    var targetPrice = parseFloat(data.target) || parseFloat(data.fib_target);
    var stopPrice = parseFloat(data.stop) || parseFloat(data.fib_stop);

    // Calculate days to turn
    var today = new Date();
    var turn = turnDate ? new Date(turnDate) : new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
    var daysToTurn = Math.max(0, Math.ceil((turn - today) / (1000 * 60 * 60 * 24)));

    // Format date
    var turnDateStr = turn.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

    var trade1, trade2;

    if (turnType === 'LOW') {
        // Expecting LOW = Pullback first (PUT), then Bounce (CALL)
        var pullbackTarget = sq9Level || currentPrice * 0.985;
        var bounceTarget = targetPrice || currentPrice * 1.03;

        // TRADE 1: PUT (Ride the pullback to LOW)
        trade1 = {
            direction: 'PUT',
            phase: 'PULLBACK',
            timing: 'Now  ' + turnDateStr,
            entry: currentPrice,
            target: pullbackTarget,
            stop: currentPrice * 1.01,
            rr: Math.abs((currentPrice - pullbackTarget) / (currentPrice * 0.01)).toFixed(1),
            expiry: calculateExpiry(turn, 1),
            exitNote: 'Exit before ' + turnDateStr + ' LOW'
        };

        // TRADE 2: CALL (Ride the bounce from LOW)
        trade2 = {
            direction: 'CALL',
            phase: 'BOUNCE',
            timing: turnDateStr + ' ',
            entryDate: turnDateStr,
            entry: pullbackTarget,
            target: bounceTarget,
            stop: pullbackTarget * 0.99,
            rr: Math.abs((bounceTarget - pullbackTarget) / (pullbackTarget * 0.01)).toFixed(1),
            expiry: calculateExpiry(turn, 30),
            entryNote: 'Use 5m/15m chart for minor LOW confirmation'
        };

    } else {
        // Expecting HIGH = Rally first (CALL), then Drop (PUT)
        var rallyTarget = sq9Level || currentPrice * 1.015;
        var dropTarget = targetPrice || currentPrice * 0.97;

        // TRADE 1: CALL (Ride the rally to HIGH)
        trade1 = {
            direction: 'CALL',
            phase: 'RALLY',
            timing: 'Now  ' + turnDateStr,
            entry: currentPrice,
            target: rallyTarget,
            stop: currentPrice * 0.99,
            rr: Math.abs((rallyTarget - currentPrice) / (currentPrice * 0.01)).toFixed(1),
            expiry: calculateExpiry(turn, 1),
            exitNote: 'Exit before ' + turnDateStr + ' HIGH'
        };

        // TRADE 2: PUT (Ride the drop from HIGH)
        trade2 = {
            direction: 'PUT',
            phase: 'DROP',
            timing: turnDateStr + ' ',
            entryDate: turnDateStr,
            entry: rallyTarget,
            target: dropTarget,
            stop: rallyTarget * 1.01,
            rr: Math.abs((rallyTarget - dropTarget) / (rallyTarget * 0.01)).toFixed(1),
            expiry: calculateExpiry(turn, 30),
            entryNote: 'Use 5m/15m chart for minor HIGH confirmation'
        };
    }

    return { trade1: trade1, trade2: trade2, turnDate: turnDateStr, turnType: turnType, daysToTurn: daysToTurn };
}

function renderTradeSequence(data) {
    var container = document.getElementById('tradeSequenceContainer');
    if (!container) return;

    var seq = generateTradeSequence(data);

    // Show container
    container.style.display = 'block';

    // Update header
    document.getElementById('seqSymbol').textContent = data.symbol || 'SPY';
    document.getElementById('seqPrice').textContent = '$' + (parseFloat(data.price) || 0).toFixed(2);

    var confBadge = document.getElementById('seqConfluence');
    confBadge.textContent = (data.confluence || '3/3') + ' ' + seq.trade2.direction;
    confBadge.className = 'confluence-badge' + (seq.trade2.direction === 'PUT' ? ' put-bias' : '');

    // Trade 1
    var t1Container = document.getElementById('trade1Container');
    t1Container.className = 'trade-box ' + (seq.trade1.direction === 'PUT' ? 'pullback' : 'rally');

    document.getElementById('trade1Phase').textContent = seq.trade1.phase;
    document.getElementById('trade1Timing').textContent = seq.trade1.timing;

    var t1Dir = document.getElementById('trade1Direction');
    var t1Icon = seq.trade1.direction === 'PUT' ? '' : '';
    t1Dir.className = 'trade-direction ' + seq.trade1.direction.toLowerCase();
    t1Dir.innerHTML = '<span class="direction-icon">' + t1Icon + '</span><span class="direction-text">BUY ' + seq.trade1.direction + ' NOW</span>';

    document.getElementById('trade1Entry').textContent = '$' + seq.trade1.entry.toFixed(2);
    document.getElementById('trade1Target').textContent = '$' + seq.trade1.target.toFixed(2);
    document.getElementById('trade1Stop').textContent = '$' + seq.trade1.stop.toFixed(2);
    document.getElementById('trade1RR').textContent = '1:' + seq.trade1.rr;
    document.getElementById('trade1Expiry').textContent = 'Expiry: ' + seq.trade1.expiry.date + ' (' + seq.trade1.expiry.dte + ' DTE)';
    document.getElementById('trade1ExitNote').textContent = seq.trade1.exitNote;

    // Timeline
    document.getElementById('turnDateBadge').textContent = seq.turnDate;
    document.getElementById('turnTypeBadge').textContent = 'Expected ' + seq.turnType;

    // Trade 2
    var t2Container = document.getElementById('trade2Container');
    t2Container.className = 'trade-box ' + (seq.trade2.direction === 'CALL' ? 'bounce' : 'drop');

    document.getElementById('trade2Phase').textContent = seq.trade2.phase;
    document.getElementById('trade2Timing').textContent = seq.trade2.timing;

    var t2Dir = document.getElementById('trade2Direction');
    var t2Icon = seq.trade2.direction === 'CALL' ? '' : '';
    t2Dir.className = 'trade-direction ' + seq.trade2.direction.toLowerCase();
    document.getElementById('trade2DirectionText').textContent = 'BUY ' + seq.trade2.direction + ' ON ' + seq.trade2.entryDate;
    t2Dir.innerHTML = '<span class="direction-icon">' + t2Icon + '</span><span class="direction-text">BUY ' + seq.trade2.direction + ' ON ' + seq.trade2.entryDate + '</span>';

    document.getElementById('trade2Entry').textContent = '$' + seq.trade2.entry.toFixed(2);
    document.getElementById('trade2EntrySublabel').textContent = '(at ' + seq.turnType + ')';
    document.getElementById('trade2Target').textContent = '$' + seq.trade2.target.toFixed(2);
    document.getElementById('trade2Stop').textContent = '$' + seq.trade2.stop.toFixed(2);
    document.getElementById('trade2RR').textContent = '1:' + seq.trade2.rr;
    document.getElementById('trade2Expiry').textContent = 'Expiry: ' + seq.trade2.expiry.date + ' (' + seq.trade2.expiry.dte + ' DTE)';
    document.getElementById('trade2EntryNote').textContent = seq.trade2.entryNote;
}

function getTradeSequenceCellHTML(data) {
    var seq = generateTradeSequence(data);
    var symbol = data.symbol || 'SPY';
    var price = parseFloat(data.price) || 0;
    var turnDate = data.turn_date || '';
    var turnType = data.turn_type || 'LOW';
    var sq9Level = parseFloat(data.sq9_level) || 0;
    var target = parseFloat(data.target) || 0;
    var confluence = data.confluence || '';

    var t1Icon = seq.trade1.direction === 'PUT' ? '' : '';
    var t2Icon = seq.trade2.direction === 'CALL' ? '' : '';

    return '<div class="trade-seq-cell" onclick="showTradeSequenceForSymbol(\'' + symbol + '\', ' + price + ', \'' + turnDate + '\', \'' + turnType + '\', ' + sq9Level + ', ' + target + ', \'' + confluence + '\')" style="cursor: pointer;" title="Click to view full trade sequence">' +
        '<div class="seq-trade ' + seq.trade1.direction.toLowerCase() + '" style="font-weight: 600;">' + t1Icon + ' ' + seq.trade1.direction + ' Now</div>' +
        '<div class="seq-divider"> ' + seq.turnDate + ' ' + seq.turnType + ' </div>' +
        '<div class="seq-trade ' + seq.trade2.direction.toLowerCase() + '" style="font-weight: 600;">' + t2Icon + ' ' + seq.trade2.direction + ' ' + seq.turnDate + '</div>' +
        '</div>';
}

function showTradeSequenceForSymbol(symbol, price, turnDate, turnType, sq9Level, target, confluence) {
    renderTradeSequence({
        symbol: symbol,
        price: price,
        turn_date: turnDate,
        turn_type: turnType,
        sq9_level: sq9Level,
        target: target,
        confluence: confluence
    });

    // Scroll to the trade sequence container
    const container = document.getElementById('tradeSequenceContainer');
    if (container) {
        container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// Refresh SQ9 Scanner Tab
function refreshSQ9ScannerTab() {
    console.log(' Refreshing SQ9 Scanner Tab');

    if (typeof updateSq9Monitor === 'function') updateSq9Monitor();
    if (typeof loadSq9ScannerData === 'function') loadSq9ScannerData();

    const el = document.getElementById('sq9LastUpdated');
    if (el) el.textContent = 'Updated: ' + new Date().toLocaleTimeString();
}

// Refresh Signals Tab
function refreshSignalsTab() {
    console.log(' Refreshing Signals Tab');

    if (typeof scanMTFPatterns === 'function') scanMTFPatterns(true);
    if (typeof updateMTFBiasSummary === 'function') updateMTFBiasSummary(currentSymbol || 'SPY');

    const el = document.getElementById('signalsTabLastUpdated');
    if (el) el.textContent = 'Updated: ' + new Date().toLocaleTimeString();
}

// Refresh Patterns Tab
function refreshPatternsTab() {
    console.log(' Refreshing Patterns Tab');

    if (typeof scanAllPatterns === 'function') scanAllPatterns();

    const el = document.getElementById('patternsLastUpdated');
    if (el) el.textContent = 'Updated: ' + new Date().toLocaleTimeString();
}

// Refresh Predictions Tab
function refreshPredictionsTab() {
    console.log(' Refreshing Predictions Tab');

    if (typeof updatePredictionTracker === 'function') updatePredictionTracker();

    const el = document.getElementById('predictionsLastUpdated');
    if (el) el.textContent = 'Updated: ' + new Date().toLocaleTimeString();
}

// ============================================
// MASTER REFRESH FUNCTION
// ============================================

// Master refresh function with comprehensive error handling
async function refreshAllData() {
    const now = Date.now();

    // Debounce: prevent rapid clicks causing race conditions
    if (isRefreshing || (now - lastRefreshTime) < REFRESH_COOLDOWN) {
        console.log(' Refresh cooldown - please wait');
        showRefreshToast('Please wait...', 'warning');
        return;
    }

    isRefreshing = true;
    lastRefreshTime = now;

    const refreshBtn = document.getElementById('refreshBtn');
    const refreshIcon = document.getElementById('refreshIcon');

    // Get current symbol from multiple possible dropdowns
    const symbolDropdown = document.getElementById('symbolSelect') ||
                          document.querySelector('header select') ||
                          document.querySelector('[id*="symbol"]');

    const symbol = symbolDropdown ? symbolDropdown.value : 'SPY';
    currentSymbol = symbol;

    console.log(' Refreshing all data for: ' + symbol);

    // Show loading state
    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.style.opacity = '0.7';
    }
    if (refreshIcon) {
        refreshIcon.innerHTML = '';
    }

    showNotification('Refreshing ' + symbol + '...', 'info');

    try {
        // Overview sections
        if (typeof updateOverviewForSymbol === 'function') updateOverviewForSymbol(symbol);
        if (typeof updateTradeStatistics === 'function') updateTradeStatistics(symbol);
        if (typeof updatePatternDetection === 'function') updatePatternDetection(symbol);
        if (typeof populatePatternTable === 'function') populatePatternTable(symbol);
        if (typeof updateHistoricalData === 'function') updateHistoricalData(symbol);
        if (typeof populateHistoricalTable === 'function') populateHistoricalTable(symbol);
        if (typeof updateFibonacciLevels === 'function') updateFibonacciLevels(symbol);
        if (typeof populateFibonacciTable === 'function') populateFibonacciTable(symbol);

        // Gann sections
        if (typeof updateGannAnalysisForSymbol === 'function') updateGannAnalysisForSymbol(symbol);
        if (typeof updateGannForecast === 'function') updateGannForecast(symbol);
        if (typeof updateSquareOf9 === 'function') updateSquareOf9(symbol);
        if (typeof updateSq9Calculator === 'function') updateSq9Calculator(symbol);
        if (typeof updateGannTimeCycles === 'function') updateGannTimeCycles(symbol);
        if (typeof updateSacredNumbers === 'function') updateSacredNumbers(symbol);
        if (typeof updateMasterConfluence === 'function') updateMasterConfluence(symbol);
        if (typeof updateGannAngles === 'function') updateGannAngles(symbol);

        // Bar Count
        if (typeof updateBarCount === 'function') updateBarCount(symbol);
        if (typeof updateBarCountHistory === 'function') updateBarCountHistory(symbol);
        if (typeof populateBarCountTable === 'function') populateBarCountTable(symbol);

        // Signals & Patterns
        if (typeof updateSignalsForSymbol === 'function') updateSignalsForSymbol(symbol);
        if (typeof updatePatternsForSymbol === 'function') updatePatternsForSymbol(symbol);
        if (typeof updateTechnicalPatterns === 'function') updateTechnicalPatterns(symbol);

        // Today stats
        if (typeof updateTodayStats === 'function') updateTodayStats(symbol);
        if (typeof updateTodayVsAverage === 'function') updateTodayVsAverage(symbol);
        if (typeof updateMarketStats === 'function') updateMarketStats(symbol);

        // Other sections
        if (typeof updateOpportunitiesForSymbol === 'function') updateOpportunitiesForSymbol(symbol);
        if (typeof updateDailyAnalysisForSymbol === 'function') updateDailyAnalysisForSymbol(symbol);
        if (typeof updateMultiChartsForSymbol === 'function') updateMultiChartsForSymbol(symbol);
        if (typeof updateMTFBiasSummary === 'function') updateMTFBiasSummary(symbol);
        if (typeof updateTopTradeRecommendation === 'function') updateTopTradeRecommendation(symbol);
        if (typeof updateHeaderForSymbol === 'function') updateHeaderForSymbol(symbol);
        if (typeof updateTradeSetupForSymbol === 'function') updateTradeSetupForSymbol(symbol);
        if (typeof updateMTFTrendForSymbol === 'function') updateMTFTrendForSymbol(symbol);

        // Today's Setups scanner
        if (typeof scanTodaysSetups === 'function') scanTodaysSetups();

        // Reload data if function exists
        if (typeof loadAllData === 'function') loadAllData();
        if (typeof loadSymbolData === 'function') loadSymbolData(symbol);

        // Update prices from CSV data for all symbols
        if (typeof updateAllSymbolGannDataFromCSV === 'function') updateAllSymbolGannDataFromCSV();

        // Trading Opportunities with live prices
        if (typeof generateDynamicOpportunities === 'function') generateDynamicOpportunities();

        // Today's Top Trade with live prices
        if (typeof updateTopTradeDisplay === 'function') updateTopTradeDisplay();
        if (typeof updateTopTrade === 'function') updateTopTrade(symbol);

        // Market Conditions with live prices
        if (typeof updateMarketAnalysisTab === 'function') updateMarketAnalysisTab();

        // Pattern Scanner with live prices
        if (typeof scanAllPatterns === 'function') scanAllPatterns();

        // SQ9 Monitor with live prices
        if (typeof updateSq9Monitor === 'function') updateSq9Monitor();

        // Dynamic pivots
        if (typeof updateDynamicPivots === 'function') updateDynamicPivots();

        // Update timestamp
        if (typeof updateLastRefreshTime === 'function') updateLastRefreshTime();

        showNotification(' ' + symbol + ' fully refreshed!', 'success');
        console.log(' Refresh complete for ' + symbol);

    } catch (error) {
        console.error('Refresh error:', error);
        showNotification(' Error: ' + error.message, 'error');
    } finally {
        // Reset debounce flag
        isRefreshing = false;

        // Reset button
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.style.opacity = '1';
        }
        if (refreshIcon) {
            refreshIcon.innerHTML = '';
        }
    }
}

// Simple toast for refresh cooldown messages
function showRefreshToast(message, type) {
    let toast = document.getElementById('refreshToast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'refreshToast';
        toast.style.cssText = 'position:fixed;bottom:20px;right:20px;padding:10px 20px;border-radius:8px;color:white;font-weight:600;z-index:10000;box-shadow:0 4px 15px rgba(0,0,0,0.3);transition:opacity 0.3s;';
        document.body.appendChild(toast);
    }
    toast.style.background = type === 'success' ? '#22c55e' : type === 'warning' ? '#f59e0b' : '#ef4444';
    toast.textContent = message;
    toast.style.opacity = '1';
    toast.style.display = 'block';
    setTimeout(function() { toast.style.opacity = '0'; }, 1500);
    setTimeout(function() { toast.style.display = 'none'; }, 1800);
}

// Generic notification function (consolidates showRefreshNotification)
function showNotification(message, type) {
    // Try the existing function first
    if (typeof showRefreshNotification === 'function') {
        showRefreshNotification(message, type);
        return;
    }

    // Fallback: create a simple toast notification
    let toast = document.getElementById('toast-notification');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast-notification';
        toast.style.cssText = 'position:fixed;top:70px;right:20px;padding:12px 20px;border-radius:8px;z-index:9999;font-size:13px;font-weight:600;animation:slideIn 0.3s ease;box-shadow:0 4px 15px rgba(0,0,0,0.2);';
        document.body.appendChild(toast);
    }

    toast.textContent = message;
    if (type === 'success') {
        toast.style.background = '#22c55e';
        toast.style.color = 'white';
    } else if (type === 'error') {
        toast.style.background = '#ef4444';
        toast.style.color = 'white';
    } else {
        toast.style.background = '#3b82f6';
        toast.style.color = 'white';
    }

    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

// Fetch latest price (uses cached data as Yahoo Finance has CORS issues)
async function fetchLatestPrice(symbol) {
    try {
        // Try to load from CSV first
        const response = await fetch('data/' + symbol + '.csv?t=' + Date.now());
        if (response.ok) {
            const text = await response.text();
            const lines = text.trim().split('\n');
            if (lines.length >= 2) {
                const lastLine = lines[lines.length - 1];
                const columns = lastLine.split(',');
                const price = parseFloat(columns[4]); // Close price

                if (!isNaN(price) && symbolGannData[symbol]) {
                    const oldPrice = symbolGannData[symbol].price;
                    symbolGannData[symbol].price = price;
                    // Also update high/low from CSV data (columns: Date,Open,High,Low,Close,Volume)
                    if (columns[2]) symbolGannData[symbol].high = parseFloat(columns[2]);
                    if (columns[3]) symbolGannData[symbol].low = parseFloat(columns[3]);
                    // Also update Gann Analysis price display if this is the current symbol
                    if (symbol === currentSymbol) {
                        var gannPriceEl = document.getElementById('gannCurrentPrice');
                        if (gannPriceEl) {
                            gannPriceEl.textContent = '$' + price.toFixed(2);
                            console.log('Updated gannCurrentPrice for ' + symbol + ': $' + price.toFixed(2));
                        }
                    }
                    const change = price - oldPrice;
                    const changePct = (change / oldPrice) * 100;
                    updatePriceDisplay(symbol, price, change, changePct);
                    console.log(symbol + ': $' + price.toFixed(2) + ' (from CSV)');
                    return { price, change, changePct };
                }
            }
        }
    } catch (error) {
        console.warn('CSV fetch failed, using cached data:', error);
    }
    return null;
}

// Update ALL symbolGannData prices from CSV data (not just current symbol)
function updateAllSymbolGannDataFromCSV() {
    // All 43 symbols
    var symbols = [
        // Index ETFs (4)
        'SPY', 'QQQ', 'IWM', 'DIA',
        // Sector ETFs (9)
        'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY',
        // Mega Caps (10)
        'AAPL', 'MSFT', 'NVDA', 'TSLA', 'AMZN', 'GOOGL', 'META', 'JPM', 'AMD', 'NFLX',
        // Additional Liquid Stocks (20)
        'V', 'MA', 'UNH', 'HD', 'PG', 'BAC', 'WMT', 'DIS', 'COST', 'CRM',
        'INTC', 'CSCO', 'ADBE', 'ORCL', 'PFE', 'MRK', 'ABBV', 'LLY', 'CVX', 'XOM'
    ];

    var updatedCount = 0;
    symbols.forEach(function(symbol) {
        var data = allSymbolsData[symbol];
        if (data && data.length > 0) {
            var latestRow = data[data.length - 1];
            var price = parseFloat(latestRow.Close);
            var high = parseFloat(latestRow.High);
            var low = parseFloat(latestRow.Low);

            // Calculate change from previous day
            var changePct = 0;
            if (data.length >= 2) {
                var prevClose = parseFloat(data[data.length - 2].Close);
                if (prevClose > 0) {
                    changePct = ((price - prevClose) / prevClose) * 100;
                }
            }

            // Calculate ATR from recent data
            var atr = 0;
            if (data.length >= 14) {
                var atrSum = 0;
                for (var j = data.length - 14; j < data.length; j++) {
                    var h = parseFloat(data[j].High);
                    var l = parseFloat(data[j].Low);
                    atrSum += (h - l);
                }
                atr = atrSum / 14;
            }

            if (!isNaN(price)) {
                // Initialize if doesn't exist
                if (!symbolGannData[symbol]) {
                    symbolGannData[symbol] = {};
                }
                symbolGannData[symbol].price = price;
                symbolGannData[symbol].changePct = changePct;
                if (!isNaN(high)) symbolGannData[symbol].high = high;
                if (!isNaN(low)) symbolGannData[symbol].low = low;
                if (atr > 0) symbolGannData[symbol].atr = atr;
                updatedCount++;
            }
        }
    });
    console.log('Updated ' + updatedCount + '/' + symbols.length + ' symbols from CSV data');

    // Recalculate Gann predictions with fresh CSV data
    if (currentSymbol) {
        autoCalculateGannPredictions(currentSymbol);
    }

    // Regenerate the Opportunities table with fresh prices
    if (typeof generateDynamicOpportunities === 'function') {
        generateDynamicOpportunities();
        console.log('Trading Opportunities table updated with fresh prices');
    }

    // Update Last Updated timestamp
    if (typeof onPricesLoaded === 'function') {
        onPricesLoaded();
    }
}

// Update header price display
function updatePriceDisplay(symbol, price, change, changePct) {
    const priceEl = document.getElementById('headerPrice');
    const changeEl = document.getElementById('headerChange');

    if (priceEl) {
        priceEl.textContent = '$' + price.toFixed(2);
    }

    if (changeEl) {
        const sign = change >= 0 ? '+' : '';
        changeEl.textContent = sign + change.toFixed(2) + ' (' + sign + changePct.toFixed(2) + '%)';
        changeEl.style.color = change >= 0 ? '#22c55e' : '#ef4444';
    }

    // Also update the symbol banner
    const symbolBannerPrice = document.querySelector('#symbolBanner .price, .symbol-banner-price');
    if (symbolBannerPrice) {
        symbolBannerPrice.textContent = '$' + price.toFixed(2);
    }
}

// Update header for selected symbol
function updateHeaderForSymbol(symbol) {
    const data = symbolGannData[symbol];
    if (!data) return;

    // Update current symbol display
    const symbolDisplay = document.getElementById('currentSymbolDisplay');
    if (symbolDisplay) {
        symbolDisplay.textContent = symbol;
    }

    // Update symbol name
    const symbolName = document.getElementById('currentSymbolName');
    if (symbolName) {
        symbolName.textContent = data.sector || symbol + ' ETF';
    }

    // Update Gann header
    const gannSymbol = document.getElementById('gannCurrentSymbol');
    if (gannSymbol) {
        gannSymbol.textContent = symbol;
    }

    const gannPrice = document.getElementById('gannCurrentPrice');
    if (gannPrice) {
        gannPrice.textContent = '$' + data.price.toFixed(2);
    }

    const gannSector = document.getElementById('gannSectorName');
    if (gannSector) {
        gannSector.textContent = '(' + data.sector + ')';
    }
}

// Update last refresh timestamp
function updateLastRefreshTime() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

    // Update data time displays
    const dataTime = document.getElementById('dataTime');
    if (dataTime) {
        dataTime.textContent = timeStr;
    }

    const dataDate = document.getElementById('dataDate');
    if (dataDate) {
        dataDate.textContent = dateStr;
    }

    // Update all section timestamps
    document.querySelectorAll('.section-timestamp').forEach(el => {
        el.textContent = ' ' + timeStr;
    });
}

// Show refresh notification toast
function showRefreshNotification(message, type) {
    // Remove existing notification
    const existing = document.getElementById('refresh-notification-toast');
    if (existing) existing.remove();

    const colors = {
        'info': '#3b82f6',
        'success': '#22c55e',
        'error': '#ef4444',
        'warning': '#f59e0b'
    };

    const notification = document.createElement('div');
    notification.id = 'refresh-notification-toast';
    notification.style.cssText = 'position: fixed; top: 70px; right: 20px; background: ' + (colors[type] || colors.info) + '; color: white; padding: 12px 20px; border-radius: 8px; font-size: 13px; font-weight: 500; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease;';
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(function() {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s';
        setTimeout(function() { notification.remove(); }, 300);
    }, 3000);
}

// ============================================
// SYMBOL-SPECIFIC UPDATE FUNCTIONS
// ============================================

// Update Overview section for symbol
function updateOverviewForSymbol(symbol) {
    const data = symbolGannData[symbol];
    if (!data) return;

    // Update overview price displays
    const priceEl = document.getElementById('overviewPrice');
    if (priceEl) priceEl.textContent = '$' + data.price.toFixed(2);

    const highEl = document.getElementById('overview52High');
    if (highEl) highEl.textContent = '$' + data.high.toFixed(2);

    const lowEl = document.getElementById('overview52Low');
    if (lowEl) lowEl.textContent = '$' + data.low.toFixed(2);

    console.log('Overview updated for ' + symbol);
}

// Update Multi-Charts for symbol
function updateMultiChartsForSymbol(symbol) {
    const data = symbolGannData[symbol];
    if (!data) return;

    // Update chart symbol labels
    document.querySelectorAll('.chart-symbol-label').forEach(function(el) {
        el.textContent = symbol;
    });

    // Update chart price labels
    document.querySelectorAll('.chart-price-label').forEach(function(el) {
        el.textContent = '$' + data.price.toFixed(2);
    });

    // Sync multi-chart symbol dropdown
    const multiChartSymbol = document.getElementById('multiChartSymbol');
    if (multiChartSymbol) {
        multiChartSymbol.value = symbol;
    }

    console.log('Multi-Charts updated for ' + symbol);
}

// Update Opportunities for symbol - highlight matching rows
function updateOpportunitiesForSymbol(symbol) {
    const tbody = document.getElementById('oppTableBody');
    if (!tbody) return;

    tbody.querySelectorAll('tr').forEach(function(row) {
        const symbolCell = row.cells[1];
        if (symbolCell) {
            const rowSymbol = symbolCell.textContent.trim();
            if (rowSymbol === symbol) {
                row.style.background = 'rgba(59,130,246,0.15)';
                row.style.fontWeight = '600';
            } else {
                row.style.background = '';
                row.style.fontWeight = '';
            }
        }
    });

    console.log('Opportunities updated for ' + symbol);
}

// Dynamically generate Opportunities table from real data
function generateDynamicOpportunities() {
    var tbody = document.getElementById('oppTableBody');
    if (!tbody) return;

    var symbols = [
        // Index ETFs (4)
        { sym: 'SPY', sector: 'Index' },
        { sym: 'QQQ', sector: 'Tech Index' },
        { sym: 'IWM', sector: 'Small Cap' },
        { sym: 'DIA', sector: 'Dow Index' },
        // Sector ETFs (9)
        { sym: 'XLF', sector: 'Financial ETF' },
        { sym: 'XLE', sector: 'Energy ETF' },
        { sym: 'XLK', sector: 'Technology ETF' },
        { sym: 'XLV', sector: 'Healthcare ETF' },
        { sym: 'XLI', sector: 'Industrial ETF' },
        { sym: 'XLB', sector: 'Materials ETF' },
        { sym: 'XLU', sector: 'Utilities ETF' },
        { sym: 'XLP', sector: 'Staples ETF' },
        { sym: 'XLY', sector: 'Discretionary ETF' },
        // Mega Caps (10)
        { sym: 'AAPL', sector: 'Tech' },
        { sym: 'MSFT', sector: 'Tech' },
        { sym: 'NVDA', sector: 'Tech' },
        { sym: 'TSLA', sector: 'Tech' },
        { sym: 'AMZN', sector: 'Tech' },
        { sym: 'GOOGL', sector: 'Tech' },
        { sym: 'META', sector: 'Tech' },
        { sym: 'JPM', sector: 'Financial' },
        { sym: 'AMD', sector: 'Tech' },
        { sym: 'NFLX', sector: 'Tech' },
        // Additional Liquid Stocks (20)
        { sym: 'V', sector: 'Financial' },
        { sym: 'MA', sector: 'Financial' },
        { sym: 'UNH', sector: 'Healthcare' },
        { sym: 'HD', sector: 'Consumer' },
        { sym: 'PG', sector: 'Consumer' },
        { sym: 'BAC', sector: 'Financial' },
        { sym: 'WMT', sector: 'Consumer' },
        { sym: 'DIS', sector: 'Consumer' },
        { sym: 'COST', sector: 'Consumer' },
        { sym: 'CRM', sector: 'Tech' },
        { sym: 'INTC', sector: 'Tech' },
        { sym: 'CSCO', sector: 'Tech' },
        { sym: 'ADBE', sector: 'Tech' },
        { sym: 'ORCL', sector: 'Tech' },
        { sym: 'PFE', sector: 'Healthcare' },
        { sym: 'MRK', sector: 'Healthcare' },
        { sym: 'ABBV', sector: 'Healthcare' },
        { sym: 'LLY', sector: 'Healthcare' },
        { sym: 'CVX', sector: 'Energy' },
        { sym: 'XOM', sector: 'Energy' }
    ];

    var rows = [];
    var callCount = 0, putCount = 0, alignedCount = 0, readyCount = 0;

    for (var i = 0; i < symbols.length; i++) {
        var sym = symbols[i].sym;
        var sector = symbols[i].sector;
        var data = symbolGannData[sym];
        var csvData = allSymbolsData[sym];

        if (!data || !data.price) continue;

        var price = data.price;
        var high = data.high || price * 1.1;
        var low = data.low || price * 0.9;
        var atr = data.atr || price * 0.015;
        var changePct = data.changePct || 0;

        // Calculate 20MA
        var sym20MA = 0;
        if (csvData && csvData.length >= 20) {
            var sum20 = 0;
            for (var j = csvData.length - 20; j < csvData.length; j++) {
                sum20 += parseFloat(csvData[j].Close) || 0;
            }
            sym20MA = sum20 / 20;
        }

        // Support and Resistance (actual prices)
        var range = high - low;
        var support = low + range * 0.236;
        var resist = low + range * 0.786;

        // Position in range
        var position = range > 0 ? (price - low) / range : 0.5;

        // GANN Analysis (respects inversion mode)
        var gannSignal;
        if (typeof invertGannSignal !== 'undefined' && invertGannSignal) {
            // INVERTED: High position = CALL (momentum), Low position = PUT
            gannSignal = position > 0.65 ? 'CALL' : (position < 0.35 ? 'PUT' : 'HOLD');
        } else {
            // NORMAL: Low position = CALL (mean reversion), High position = PUT
            gannSignal = position < 0.35 ? 'CALL' : (position > 0.65 ? 'PUT' : 'HOLD');
        }
        var gannColor = gannSignal === 'CALL' ? '#22c55e' : (gannSignal === 'PUT' ? '#ef4444' : '#eab308');

        // MARKET Analysis (20MA)
        var mktSignal = price < sym20MA ? 'PUT' : 'CALL';
        var mktColor = mktSignal === 'CALL' ? '#22c55e' : '#ef4444';

        // Turn Direction
        var turnDir = '';
        var turnColor = '#666';
        if (gannSignal === 'CALL' && mktSignal === 'CALL') {
            turnDir = 'RALLY';
            turnColor = '#22c55e';
        } else if (gannSignal === 'PUT' && mktSignal === 'PUT') {
            turnDir = 'BREAKDOWN';
            turnColor = '#ef4444';
        } else if (gannSignal === 'CALL' && mktSignal === 'PUT') {
            turnDir = 'REVERSAL';
            turnColor = '#f59e0b';
        } else if (gannSignal === 'PUT' && mktSignal === 'CALL') {
            turnDir = 'PULLBACK';
            turnColor = '#8b5cf6';
        } else {
            turnDir = 'HOLD';
            turnColor = '#666';
        }

        // Next Turn Date
        var today = new Date();
        var cycleLength = 5;
        if (position < 0.2 || position > 0.8) cycleLength = 2;
        else if (position < 0.35 || position > 0.65) cycleLength = 4;
        var nextTurn = new Date(today);
        nextTurn.setDate(today.getDate() + cycleLength);
        var nextTurnStr = nextTurn.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        var daysToTurn = cycleLength;

        // Stage
        var stage = '';
        var stageColor = '#666';
        if (position < 0.15 || position > 0.85) {
            stage = 'EXHAUSTED';
            stageColor = '#ef4444';
        } else if (position < 0.3 || position > 0.7) {
            stage = 'LATE';
            stageColor = '#f59e0b';
        } else if (position < 0.4 || position > 0.6) {
            stage = 'MID';
            stageColor = '#3b82f6';
        } else {
            stage = 'EARLY';
            stageColor = '#22c55e';
        }

        // Alignment
        var aligned = (gannSignal === mktSignal) || gannSignal === 'HOLD';
        var alignIcon = aligned ? '' : '';
        var alignColor = aligned ? '#22c55e' : '#f59e0b';

        // Entry/Target/Stop
        var isBullish = gannSignal === 'CALL' || (gannSignal === 'HOLD' && mktSignal === 'CALL');
        var entry = isBullish ? (price - atr * 0.3).toFixed(2) : (price + atr * 0.3).toFixed(2);
        var target = isBullish ? (price + atr * 2).toFixed(2) : (price - atr * 2).toFixed(2);
        var stop = isBullish ? (price - atr * 1.5).toFixed(2) : (price + atr * 1.5).toFixed(2);

        // Expected Move calculation
        var entryVal = parseFloat(entry);
        var targetVal = parseFloat(target);
        var expMoveDollars, expMovePct, expMoveColor;
        if (isBullish) {
            // For CALLS: target is above entry
            expMoveDollars = targetVal - entryVal;
            expMovePct = ((targetVal - entryVal) / entryVal) * 100;
        } else {
            // For PUTS: target is below entry
            expMoveDollars = entryVal - targetVal;
            expMovePct = ((entryVal - targetVal) / entryVal) * 100;
        }
        // Color based on move size
        if (expMovePct >= 3) {
            expMoveColor = '#22c55e';  // Green - good move
        } else if (expMovePct >= 1.5) {
            expMoveColor = '#f59e0b';  // Yellow - moderate
        } else {
            expMoveColor = '#888';     // Gray - small
        }

        // Risk
        var risk = 'MED';
        var riskColor = '#eab308';
        if (aligned && (position < 0.25 || position > 0.75)) {
            risk = 'LOW';
            riskColor = '#22c55e';
        } else if (!aligned) {
            risk = 'HIGH';
            riskColor = '#ef4444';
        }

        // Score
        var score = 50;
        if (aligned) score += 20;
        if (position < 0.25 || position > 0.75) score += 15;
        if (daysToTurn <= 3) score += 10;
        if (Math.abs(changePct) > 1) score += 5;
        score = Math.min(95, score);

        // Counts
        if (gannSignal === 'CALL') callCount++;
        else if (gannSignal === 'PUT') putCount++;
        if (aligned) alignedCount++;
        if (daysToTurn <= 3) readyCount++;

        var changeColor = changePct >= 0 ? '#22c55e' : '#ef4444';
        var changeSign = changePct >= 0 ? '+' : '';
        var maColor = price >= sym20MA ? '#22c55e' : '#ef4444';

        // Get SQ9 status for alignment calculation
        var sq9Status = typeof getSq9StatusForOpp === 'function' ? getSq9StatusForOpp(sym) : { status: 'none', direction: null, checkCount: 0 };
        var sq9Signal = sq9Status.direction ? sq9Status.direction.toUpperCase() : 'HOLD';
        var sq9Distance = 0;

        // Calculate SQ9 distance from pivot data
        var pivot = (typeof sq9PivotData !== 'undefined' && sq9PivotData[sym]) || (typeof sq9ExtendedPivots !== 'undefined' && sq9ExtendedPivots[sym]);
        if (pivot && pivot.price && price) {
            var levels = typeof calcSq9LevelsFromPivot === 'function' ? calcSq9LevelsFromPivot(pivot.price, price) : null;
            if (levels) {
                var nearest = typeof findNearestSq9Level === 'function' ? findNearestSq9Level(levels, price) : null;
                if (nearest) {
                    sq9Distance = nearest.distance;
                }
            }
        }

        // Calculate SQ9 Alignment
        var signals = [gannSignal, sq9Signal, mktSignal];
        var callVotes = signals.filter(function(s) { return s === 'CALL'; }).length;
        var putVotes = signals.filter(function(s) { return s === 'PUT'; }).length;
        var agreements = Math.max(callVotes, putVotes);
        var distanceOK = Math.abs(sq9Distance) <= 1.5;
        var approaching = Math.abs(sq9Distance) <= 3.0;

        var sq9AlignStatus, sq9AlignIcon, sq9AlignClass;
        if (agreements === 3 && distanceOK) {
            sq9AlignStatus = 'ALIGNED'; sq9AlignIcon = ''; sq9AlignClass = 'aligned';
        } else if (agreements >= 2 && approaching) {
            sq9AlignStatus = 'PARTIAL'; sq9AlignIcon = ''; sq9AlignClass = 'partial';
        } else if (approaching) {
            sq9AlignStatus = 'NEAR'; sq9AlignIcon = ''; sq9AlignClass = 'near';
        } else {
            sq9AlignStatus = 'FAR'; sq9AlignIcon = ''; sq9AlignClass = 'far';
        }

        var row = '<tr style="border-left: 3px solid ' + alignColor + ';" data-days="' + daysToTurn + '" data-sq9-alignment="' + sq9AlignClass + '" data-direction="' + gannSignal + '" data-risk="' + risk + '">' +
            '<td style="padding: 6px; font-size: 14px;">' + alignIcon + '</td>' +
            '<td style="padding: 6px;"><strong>' + sym + '</strong><br><span style="font-size: 8px; color: #666;">' + sector + '</span></td>' +
            '<td style="padding: 6px; font-weight: 600; font-size: 10px;">$' + price.toFixed(2) + '</td>' +
            '<td style="padding: 6px; color: ' + changeColor + '; font-size: 9px;">' + changeSign + changePct.toFixed(1) + '%</td>' +
            '<td style="padding: 6px; font-size: 9px; color: ' + maColor + ';">$' + sym20MA.toFixed(2) + '</td>' +
            '<td style="padding: 6px; font-size: 9px; color: #22c55e;">$' + support.toFixed(2) + '</td>' +
            '<td style="padding: 6px; font-size: 9px; color: #ef4444;">$' + resist.toFixed(2) + '</td>' +
            '<td style="padding: 6px; background: rgba(139,92,246,0.05);"><span style="color: ' + gannColor + '; font-weight: 700; font-size: 10px;">' + gannSignal + '</span></td>' +
            '<td style="padding: 6px; background: rgba(102,126,234,0.05);">' + (typeof renderSq9OppCell === 'function' ? renderSq9OppCell(sym) : '<span style="color: #666;">--</span>') + '</td>' +
            '<td style="padding: 6px; text-align: center; background: rgba(34,197,94,0.03);"><span class="sq9-align-badge ' + sq9AlignClass + '">' + sq9AlignIcon + ' ' + sq9AlignStatus + '</span></td>' +
            '<td style="padding: 6px; background: rgba(239,68,68,0.05);"><span style="color: ' + mktColor + '; font-weight: 700; font-size: 10px;">' + mktSignal + '</span></td>' +
            '<td style="padding: 6px;"><span style="color: ' + turnColor + '; font-weight: 600; font-size: 9px;">' + turnDir + '</span></td>' +
            '<td style="padding: 6px; font-size: 9px;">' + nextTurnStr + '</td>' +
            '<td style="padding: 6px; font-size: 10px; font-weight: 600; color: ' + (daysToTurn <= 3 ? '#ef4444' : '#666') + ';">' + daysToTurn + '</td>' +
            '<td style="padding: 6px;"><span style="color: ' + stageColor + '; font-size: 9px; font-weight: 600;">' + stage + '</span></td>' +
            '<td style="padding: 6px; font-size: 9px;">$' + entry + '</td>' +
            '<td style="padding: 6px; text-align: center;"><div style="font-weight: 600; color: ' + expMoveColor + '; font-size: 9px;">+$' + expMoveDollars.toFixed(2) + '</div><div style="font-size: 8px; color: ' + expMoveColor + ';">+' + expMovePct.toFixed(1) + '%</div></td>' +
            '<td style="padding: 6px; font-size: 9px; color: #22c55e;">$' + target + '</td>' +
            '<td style="padding: 6px; font-size: 9px; color: #ef4444;">$' + stop + '</td>' +
            '<td style="padding: 6px;"><span style="background: rgba(' + (risk === 'LOW' ? '34,197,94' : risk === 'HIGH' ? '239,68,68' : '234,179,8') + ',0.2); color: ' + riskColor + '; padding: 2px 4px; border-radius: 3px; font-size: 9px;">' + risk + '</span></td>' +
            '<td style="padding: 6px; font-weight: 600; font-size: 10px;">' + score + '</td>' +
            '<td style="padding: 6px;"><button onclick="viewChart(\'' + sym + '\')" style="padding: 3px 6px; background: #3b82f6; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 9px;">VIEW</button></td>' +
            '</tr>';

        rows.push({ html: row, score: score, aligned: aligned, gann: gannSignal, days: daysToTurn });
    }

    rows.sort(function(a, b) { return b.score - a.score; });
    tbody.innerHTML = rows.map(function(r) { return r.html; }).join('');

    var totalEl = document.getElementById('opp-total');
    var readyEl = document.getElementById('opp-ready');
    var soonEl = document.getElementById('opp-soon');
    var ratioEl = document.getElementById('opp-ratio');

    if (totalEl) totalEl.textContent = rows.length;
    if (readyEl) readyEl.textContent = alignedCount;
    if (soonEl) soonEl.textContent = readyCount;
    if (ratioEl) ratioEl.textContent = callCount + ' / ' + putCount;

    console.log('Opportunities: ' + rows.length + ' symbols, ' + alignedCount + ' aligned, ' + readyCount + ' ready');
}

// Keep old function name for compatibility
function updateOpportunitiesPrices() {
    generateDynamicOpportunities();
}

// Update Daily Analysis for symbol
function updateDailyAnalysisForSymbol(symbol) {
    const data = symbolGannData[symbol];
    if (!data) return;

    // Update Morning Plan symbol reference
    const morningSymbolEl = document.getElementById('morningPlanSymbol');
    if (morningSymbolEl) morningSymbolEl.textContent = symbol;

    // Update confluence symbol
    const confluenceSymbol = document.getElementById('confluenceSymbol');
    if (confluenceSymbol) confluenceSymbol.textContent = symbol + ' Analysis';

    // Calculate Square of 9 for entry/stop/targets
    const sq9 = calculateSquareOf9(data.price);
    if (sq9) {
        const support45 = sq9.support && sq9.support[0] ? sq9.support[0].price : data.price * 0.98;
        const resistance45 = sq9.resistance && sq9.resistance[0] ? sq9.resistance[0].price : data.price * 1.02;
        const resistance90 = sq9.resistance && sq9.resistance[1] ? sq9.resistance[1].price : data.price * 1.04;

        const entryEl = document.getElementById('morningPlanEntry');
        if (entryEl) entryEl.textContent = '$' + data.price.toFixed(2);

        const stopEl = document.getElementById('morningPlanStop');
        if (stopEl) stopEl.textContent = '$' + support45.toFixed(2);

        const t1El = document.getElementById('morningPlanT1');
        if (t1El) t1El.textContent = '$' + resistance45.toFixed(2);

        const t2El = document.getElementById('morningPlanT2');
        if (t2El) t2El.textContent = '$' + resistance90.toFixed(2);
    }

    // Update SQ9 Entry Signal Monitor if the symbol is a tracked ETF
    if (typeof sq9SelectedEtf !== 'undefined' && typeof sq9PivotData !== 'undefined') {
        if (sq9PivotData[symbol]) {
            sq9SelectedEtf = symbol;
            if (typeof updateSq9Monitor === 'function') {
                updateSq9Monitor();
            }
        }
    }

    // Update Gann 8ths Retracement Panel (Rules 3, 4, 5)
    if (typeof updateGann8thsPanel === 'function') {
        updateGann8thsPanel();
    }

    console.log('Daily Analysis updated for ' + symbol);
}

// Update Signals for symbol - highlight matching rows
function updateSignalsForSymbol(symbol) {
    document.querySelectorAll('.signals-table tr, #signalsTable tr, #agentSignalsBody tr').forEach(function(row) {
        const symbolCell = row.querySelector('td:first-child');
        if (symbolCell && symbolCell.textContent.trim() === symbol) {
            row.style.background = 'rgba(59,130,246,0.1)';
        } else if (symbolCell) {
            row.style.background = '';
        }
    });

    console.log('Signals updated for ' + symbol);
}

// Update Patterns for symbol
function updatePatternsForSymbol(symbol) {
    const data = symbolGannData[symbol];
    if (!data) return;

    // Highlight pattern rows for current symbol
    document.querySelectorAll('#patternTableBody tr').forEach(function(row) {
        const symbolCell = row.querySelector('td:first-child');
        if (symbolCell && symbolCell.textContent.trim() === symbol) {
            row.style.background = 'rgba(59,130,246,0.1)';
        } else if (symbolCell) {
            row.style.background = '';
        }
    });

    console.log('Patterns updated for ' + symbol);
}

// Update Trade Setup for symbol
function updateTradeSetupForSymbol(symbol) {
    const data = symbolGannData[symbol];
    if (!data) return;

    const sq9 = calculateSquareOf9(data.price);
    const isBullish = data.price > (data.high + data.low) / 2;

    if (sq9) {
        const support45 = sq9.support && sq9.support[0] ? sq9.support[0].price : data.price * 0.98;
        const resistance45 = sq9.resistance && sq9.resistance[0] ? sq9.resistance[0].price : data.price * 1.02;
        const resistance90 = sq9.resistance && sq9.resistance[1] ? sq9.resistance[1].price : data.price * 1.04;
        const support90 = sq9.support && sq9.support[1] ? sq9.support[1].price : data.price * 0.96;

        // Update trade setup elements if they exist
        const entryLowEl = document.getElementById('tradeEntryLow');
        if (entryLowEl) entryLowEl.textContent = '$' + (data.price * 0.995).toFixed(2);

        const entryHighEl = document.getElementById('tradeEntryHigh');
        if (entryHighEl) entryHighEl.textContent = '$' + (data.price * 1.005).toFixed(2);

        const stopEl = document.getElementById('tradeStop');
        if (stopEl) stopEl.textContent = '$' + (isBullish ? support45 : resistance45).toFixed(2);

        const target1El = document.getElementById('tradeTarget1');
        if (target1El) target1El.textContent = '$' + (isBullish ? resistance45 : support45).toFixed(2);

        const target2El = document.getElementById('tradeTarget2');
        if (target2El) target2El.textContent = '$' + (isBullish ? resistance90 : support90).toFixed(2);
    }

    console.log('Trade Setup updated for ' + symbol);
}

// Update MTF Trend for symbol
function updateMTFTrendForSymbol(symbol) {
    const data = symbolGannData[symbol];
    if (!data) return;

    // Determine bias based on price position
    const upperThird = data.low + (data.high - data.low) * 0.66;
    const lowerThird = data.low + (data.high - data.low) * 0.33;

    let intradayBias = 'NEUTRAL';
    let swingBias = 'NEUTRAL';
    let positionBias = 'NEUTRAL';

    if (data.price > upperThird) {
        intradayBias = 'BULLISH';
        swingBias = 'BULLISH';
        positionBias = 'BULLISH';
    } else if (data.price < lowerThird) {
        intradayBias = 'BEARISH';
        swingBias = 'BEARISH';
        positionBias = 'BEARISH';
    } else {
        intradayBias = 'NEUTRAL';
        swingBias = 'BULLISH';
        positionBias = 'BULLISH';
    }

    // Update displays
    const updateBiasDisplay = function(id, bias) {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = bias;
            el.style.color = bias === 'BULLISH' ? '#22c55e' : (bias === 'BEARISH' ? '#ef4444' : '#eab308');
        }
    };

    updateBiasDisplay('mtfIntradayBias', intradayBias);
    updateBiasDisplay('mtfSwingBias', swingBias);
    updateBiasDisplay('mtfPositionBias', positionBias);

    console.log('MTF Trend updated for ' + symbol);
}

// Update Top Trade Recommendation - Signal Must Match Agent Consensus
function updateTopTradeRecommendation(symbol) {
    const data = symbolGannData[symbol];
    if (!data) return;

    console.log('Updating Top Trade for: ' + symbol);

    // Calculate position in range
    const range = data.high - data.low;
    const position = (data.price - data.low) / range;

    // Simulate agent votes based on price position
    const agentVotes = [];

    // Base Confluence - trend following
    if (position > 0.6) {
        agentVotes.push({ name: 'Base Confluence', signal: 'PUT', confidence: 65 });
    } else if (position < 0.4) {
        agentVotes.push({ name: 'Base Confluence', signal: 'CALL', confidence: 65 });
    } else {
        agentVotes.push({ name: 'Base Confluence', signal: 'HOLD', confidence: 50 });
    }

    // Gann-Elliott - reversal focused
    if (position > 0.7) {
        agentVotes.push({ name: 'Gann-Elliott', signal: 'PUT', confidence: 70 });
    } else if (position < 0.3) {
        agentVotes.push({ name: 'Gann-Elliott', signal: 'CALL', confidence: 70 });
    } else {
        agentVotes.push({ name: 'Gann-Elliott', signal: 'HOLD', confidence: 55 });
    }

    // DQN (ML) - momentum based
    if (position > 0.5) {
        agentVotes.push({ name: 'DQN (ML)', signal: 'CALL', confidence: 60 });
    } else {
        agentVotes.push({ name: 'DQN (ML)', signal: 'PUT', confidence: 60 });
    }

    // 3-Wave - pattern based
    if (position > 0.65) {
        agentVotes.push({ name: '3-Wave', signal: 'PUT', confidence: 62 });
    } else if (position < 0.35) {
        agentVotes.push({ name: '3-Wave', signal: 'CALL', confidence: 62 });
    } else {
        agentVotes.push({ name: '3-Wave', signal: 'HOLD', confidence: 50 });
    }

    // Count votes
    let callCount = 0, putCount = 0, holdCount = 0;
    agentVotes.forEach(v => {
        if (v.signal === 'CALL') callCount++;
        else if (v.signal === 'PUT') putCount++;
        else holdCount++;
    });

    // Determine consensus
    let consensusSignal = 'HOLD';
    let consensusText = '';

    if (putCount >= 3) {
        consensusSignal = 'PUT';
        consensusText = putCount + '/4 agents  PUT';
    } else if (callCount >= 3) {
        consensusSignal = 'CALL';
        consensusText = callCount + '/4 agents  CALL';
    } else if (putCount === 2 && callCount < 2) {
        consensusSignal = 'PUT';
        consensusText = '2/4 agents  PUT';
    } else if (callCount === 2 && putCount < 2) {
        consensusSignal = 'CALL';
        consensusText = '2/4 agents  CALL';
    } else {
        consensusSignal = 'HOLD';
        consensusText = 'No clear consensus';
    }

    // Update UI elements
    const symbolEl = document.querySelector('#topTradeSymbol, .top-trade-symbol');
    if (symbolEl) symbolEl.textContent = symbol;

    // Signal badge - MUST MATCH CONSENSUS
    var signalBadge = document.getElementById('topTradeSignalBadge');
    if (signalBadge) {
        signalBadge.textContent = 'BUY ' + symbol + ' ' + consensusSignal;
        signalBadge.className = 'signal-badge';
        if (consensusSignal === 'CALL') {
            signalBadge.style.background = '#22c55e';
            signalBadge.style.color = 'white';
        } else if (consensusSignal === 'PUT') {
            signalBadge.style.background = '#ef4444';
            signalBadge.style.color = 'white';
        } else {
            signalBadge.style.background = '#6b7280';
            signalBadge.style.color = 'white';
        }
    }

    // Consensus text
    const consensusEl = document.querySelector('#agentConsensus, .agent-consensus');
    if (consensusEl) {
        consensusEl.textContent = 'Consensus: ' + consensusText;
        consensusEl.style.color = consensusSignal === 'CALL' ? '#22c55e' :
                                  (consensusSignal === 'PUT' ? '#ef4444' : '#6b7280');
    }

    // Calculate entry/stop/targets based on signal
    const atr = data.atr || (data.price * 0.015);
    const sq9 = calculateSquareOf9Levels(data.price);

    let entry, stop, t1, t2, strike;

    if (consensusSignal === 'PUT') {
        entry = data.price;
        stop = data.price + (atr * 1.5);
        t1 = sq9.support.deg45;
        t2 = sq9.support.deg90;
        strike = Math.round(data.price) + ' PUT';
    } else if (consensusSignal === 'CALL') {
        entry = data.price;
        stop = data.price - (atr * 1.5);
        t1 = sq9.resistance.deg45;
        t2 = sq9.resistance.deg90;
        strike = Math.round(data.price) + ' CALL';
    } else {
        entry = data.price;
        stop = data.price - (atr * 1.0);
        t1 = sq9.resistance.deg45;
        t2 = sq9.support.deg45;
        strike = Math.round(data.price) + ' HOLD';
    }

    // Update entry price
    const entryEl = document.querySelector('#bestEntry, .best-entry');
    if (entryEl) entryEl.textContent = '$' + entry.toFixed(2);

    // Update entry range
    const rangeEl = document.querySelector('#entryRange, .entry-range');
    if (rangeEl) rangeEl.textContent = '$' + (entry - atr * 0.3).toFixed(2) + ' - $' + entry.toFixed(2);

    // Update stop loss
    const stopEl = document.querySelector('#stopLoss, .stop-loss');
    if (stopEl) stopEl.textContent = '$' + stop.toFixed(2);

    // Update targets
    const t1El = document.querySelector('#target1, .target-1');
    if (t1El) t1El.textContent = '$' + t1.toFixed(2);

    const t2El = document.querySelector('#target2, .target-2');
    if (t2El) t2El.textContent = '$' + t2.toFixed(2);

    // Update strike
    const strikeEl = document.querySelector('#optionStrike, .option-strike');
    if (strikeEl) strikeEl.textContent = '$' + strike;

    console.log('Top Trade updated for ' + symbol + ': ' + consensusSignal);
}

// Handle Top Trade timeframe dropdown change
document.addEventListener('DOMContentLoaded', function() {
    var tfSelect = document.getElementById('topTradeTimeframeSelect');
    if (tfSelect) {
        tfSelect.addEventListener('change', function(e) {
            // CAPTURE symbol FIRST before anything else
            var capturedSymbol = currentSymbol || 'SPY';
            var timeframe = e.target.value || tfSelect.value || 'swing';
            var tfVal = timeframe.toUpperCase();

            console.log('Top Trade dropdown changed to: ' + tfVal + ' for symbol: ' + capturedSymbol);

            // Now trigger Gann update for this timeframe
            var gannBtnMap = {
                'INTRADAY': 'gannIntradayBtn',
                'SWING': 'gannSwingBtn',
                'POSITION': 'gannPositionBtn'
            };

            var gannBtn = document.getElementById(gannBtnMap[tfVal]);
            if (gannBtn) {
                gannBtn.click();
            }

            // Timeframe colors
            var colors = { intraday: '#f59e0b', swing: '#3b82f6', position: '#8b5cf6' };
            e.target.style.background = colors[timeframe] || '#3b82f6';

            // Capture values for setTimeout closure
            var capturedTfVal = tfVal;
            var capturedTimeframe = timeframe;

            // Use setTimeout to let Gann update, then read from stored predictions
            setTimeout(function() {
                var data = symbolGannData[capturedSymbol];
                if (!data || !data.price) return;

                var price = parseFloat(data.price);
                var atr = parseFloat(data.atr) || price * 0.02;
                var high = parseFloat(data.high) || price * 1.05;
                var low = parseFloat(data.low) || price * 0.95;

                // Read from stored Gann predictions
                var prediction = gannPredictions[capturedTfVal] || { direction: 'CALL', symbol: capturedSymbol };
                var direction = prediction.direction || 'CALL';
                var isBullish = direction === 'CALL';
                console.log('Dropdown reading from gannPredictions[' + capturedTfVal + ']: ' + direction + ' for ' + capturedSymbol);

                // Calculate strike
                var strike = getProperStrike(price);

                var settings = {
                    intraday: { daysOut: 1, stopMult: 0.5, targetMult: 0.75, entryLow: 0.15, entryHigh: 0.35, confidence: 70 },
                    swing: { daysOut: 10, stopMult: 1.5, targetMult: 2, entryLow: 0.50, entryHigh: 1.00, confidence: 78 },
                    position: { daysOut: 35, stopMult: 3, targetMult: 5, entryLow: 1.50, entryHigh: 3.00, confidence: 82 }
                };
                var s = settings[capturedTimeframe] || settings.swing;

                // Calculate prices
                var stopPrice = isBullish ? (price - atr * s.stopMult).toFixed(2) : (price + atr * s.stopMult).toFixed(2);
                var targetPrice = isBullish ? (price + atr * s.targetMult).toFixed(2) : (price - atr * s.targetMult).toFixed(2);
                var entryMid = (s.entryLow + s.entryHigh) / 2;
                var profitPrice = (entryMid * 1.5).toFixed(2);
                var stopOptionPrice = (entryMid * 0.6).toFixed(2);
                var maxRisk = (entryMid * 100).toFixed(0);
                var maxGain = (entryMid * 0.5 * 100).toFixed(0);
                var rr = (0.5 / 0.4).toFixed(2);

                // Calculate expiry
                var today = new Date();
                var expiry = new Date(today.getTime() + s.daysOut * 24 * 60 * 60 * 1000);
                var day = expiry.getDay();
                if (day === 0) expiry.setDate(expiry.getDate() + 5);
                if (day === 6) expiry.setDate(expiry.getDate() + 6);
                var expiryStr = expiry.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                var daysToExpiry = Math.ceil((expiry - today) / (24 * 60 * 60 * 1000));

                // Update displays with CAPTURED symbol (not currentSymbol which may have changed)
                var dirColor = isBullish ? '#4ade80' : '#ef4444';
                var el;

                el = document.getElementById('topTradeSignal');
                if (el) {
                    el.textContent = 'BUY ' + capturedSymbol + ' ' + direction;
                    el.style.color = dirColor;
                }

                el = document.getElementById('topTradeSignalBadge');
                if (el) {
                    el.textContent = 'BUY ' + capturedSymbol + ' ' + direction;
                    el.style.backgroundColor = dirColor;
                }

                el = document.getElementById('topTradeConfidence');
                if (el) el.textContent = ''.repeat(Math.floor(s.confidence / 20)) + ' ' + s.confidence + '% Confidence';

                el = document.getElementById('topTradeWhat');
                if (el) el.textContent = capturedSymbol + ' $' + strike + ' ' + direction;

                el = document.getElementById('topTradeExpiry');
                if (el) el.textContent = 'Expires: ' + expiryStr + ' (' + daysToExpiry + ' days)';

                // Option premium entry range
                el = document.getElementById('topTradeEntry');
                if (el) el.textContent = 'Premium: $' + s.entryLow.toFixed(2) + ' - $' + s.entryHigh.toFixed(2);

                // ETF Entry Zone (current price +/- 0.5 ATR)
                var entryZoneLow = (price - atr * 0.5).toFixed(2);
                var entryZoneHigh = (price + atr * 0.5).toFixed(2);
                el = document.getElementById('topTradeEntryZone');
                if (el) el.textContent = capturedSymbol + ': $' + entryZoneLow + ' - $' + entryZoneHigh;

                // Best entry (pullback to support)
                var bestEntryPrice = (price - atr * 0.3).toFixed(2);
                el = document.getElementById('topTradeBestEntry');
                if (el) el.textContent = 'Best Entry: Pullback to $' + bestEntryPrice;

                // Exit targets with option values
                var exit50Price = isBullish ? (price + atr * 1).toFixed(2) : (price - atr * 1).toFixed(2);
                var exit100Price = isBullish ? (price + atr * 2).toFixed(2) : (price - atr * 2).toFixed(2);
                var stopPriceETF = isBullish ? (price - atr * 1.5).toFixed(2) : (price + atr * 1.5).toFixed(2);

                // Option value at each target (simplified: delta ~0.5 for ATM)
                var option50Value = (entryMid * 1.5).toFixed(2);  // +50% profit
                var option100Value = (entryMid * 2).toFixed(2);   // +100% profit
                var optionStopValue = (entryMid * 0.6).toFixed(2); // -40% stop

                el = document.getElementById('topTradeExit50');
                if (el) el.textContent = '50%: $' + exit50Price + ' (Opt: $' + option50Value + ')';

                el = document.getElementById('topTradeExit100');
                if (el) el.textContent = '100%: $' + exit100Price + ' (Opt: $' + option100Value + ')';

                el = document.getElementById('topTradeExitStop');
                if (el) el.textContent = 'Stop: Below $' + stopPriceETF + ' (Opt: $' + optionStopValue + ')';

                // Old STOP LOSS section
                el = document.getElementById('topTradeStopPrice');
                if (el) el.textContent = 'If ' + capturedSymbol + (isBullish ? ' drops to $' : ' rises to $') + stopPriceETF;

                el = document.getElementById('topTradeProfit');
                if (el) el.textContent = '+50% ($' + profitPrice + ')';

                el = document.getElementById('topTradePriceTarget');
                if (el) el.textContent = 'When ' + capturedSymbol + ' hits $' + targetPrice;

                el = document.getElementById('topTradeStop');
                if (el) el.textContent = '-40% ($' + stopOptionPrice + ')';

                el = document.getElementById('topTradeRR');
                if (el) el.textContent = '1:' + rr;

                el = document.getElementById('topTradeMaxRisk');
                if (el) el.textContent = '$' + maxRisk + '/contract';

                el = document.getElementById('topTradeMaxGain');
                if (el) el.textContent = '$' + maxGain + '/contract';

                // Update profit calculator if exists
                if (typeof updateProfitCalculator === 'function') {
                    updateProfitCalculator();
                }

                console.log('Top Trade updated: ' + capturedSymbol + ' ' + direction + ' for ' + capturedTimeframe);
            }, 250);
        });
    }
});

// Update MTF Bias Summary when symbol changes
function updateMTFBiasSummary(symbol) {
    const data = symbolGannData[symbol];
    if (!data) return;

    const range = data.high - data.low;
    const position = (data.price - data.low) / range;

    // Determine biases based on position
    let intradayBias = 'NEUTRAL';
    let swingBias = 'NEUTRAL';
    let positionBias = 'NEUTRAL';

    if (position > 0.7) {
        intradayBias = 'BEARISH';
        swingBias = 'BEARISH';
        positionBias = 'BULLISH';
    } else if (position > 0.5) {
        intradayBias = 'BULLISH';
        swingBias = 'BULLISH';
        positionBias = 'BULLISH';
    } else if (position > 0.3) {
        intradayBias = 'BEARISH';
        swingBias = 'BULLISH';
        positionBias = 'BULLISH';
    } else {
        intradayBias = 'BULLISH';
        swingBias = 'BULLISH';
        positionBias = 'NEUTRAL';
    }

    // Update displays
    const updateBias = (id, bias) => {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = bias;
            el.style.color = bias === 'BULLISH' ? '#22c55e' :
                             (bias === 'BEARISH' ? '#ef4444' : '#eab308');
        }
    };

    updateBias('mtfIntradayBias', intradayBias);
    updateBias('mtfSwingBias', swingBias);
    updateBias('mtfPositionBias', positionBias);

    // Update confluence
    let bullishCount = 0;
    if (intradayBias === 'BULLISH') bullishCount++;
    if (swingBias === 'BULLISH') bullishCount++;
    if (positionBias === 'BULLISH') bullishCount++;

    const confluenceEl = document.getElementById('mtfConfluence');
    if (confluenceEl) {
        confluenceEl.textContent = bullishCount + '/3 BULLISH';
        confluenceEl.style.color = bullishCount >= 2 ? '#22c55e' :
                                   (bullishCount === 0 ? '#ef4444' : '#eab308');
    }

    console.log('MTF Bias Summary updated for ' + symbol);
}

// Update chart for specific timeframe
function updateChartForTimeframe(chartType, timeframe) {
    console.log('Updating ' + chartType + ' chart to ' + timeframe);

    var symbol = currentSymbol || 'SPY';
    const data = symbolGannData[symbol];
    if (!data) return;

    // Timeframe-specific data ranges
    const timeframeConfig = {
        '1m': { bars: 60, xLabels: ['9:30', '10:00', '10:30', '11:00'], range: 0.005 },
        '5m': { bars: 78, xLabels: ['9:30', '11:00', '12:30', '14:00'], range: 0.01 },
        '15m': { bars: 26, xLabels: ['9:30', '11:00', '13:00', '15:00'], range: 0.015 },
        '30m': { bars: 13, xLabels: ['10:00', '12:00', '14:00', '16:00'], range: 0.02 },
        '1h': { bars: 7, xLabels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'], range: 0.025 },
        '4h': { bars: 30, xLabels: ['Nov 25', 'Dec 2', 'Dec 9', 'Dec 11'], range: 0.04 },
        '1d': { bars: 20, xLabels: ['Nov 12', 'Nov 22', 'Dec 2', 'Dec 11'], range: 0.08 },
        '1w': { bars: 12, xLabels: ['Sep', 'Oct', 'Nov', 'Dec'], range: 0.15 },
        '1M': { bars: 6, xLabels: ['Jul', 'Sep', 'Nov', 'Jan'], range: 0.25 },
        '3M': { bars: 4, xLabels: ['Q1', 'Q2', 'Q3', 'Q4'], range: 0.40 }
    };

    const config = timeframeConfig[timeframe] || timeframeConfig['1d'];

    // Update "Showing: X data" label
    const showingLabels = {
        '1m': '1 Minute', '5m': '5 Minute', '15m': '15 Minute', '30m': '30 Minute',
        '1h': '1 Hour', '4h': '4 Hour', '1d': 'Daily', '1w': 'Weekly',
        '1M': 'Monthly', '3M': 'Quarterly'
    };

    const labelEl = document.querySelector('#' + chartType + 'ShowingLabel, .' + chartType + '-showing');
    if (labelEl) {
        labelEl.textContent = 'Showing: ' + showingLabels[timeframe] + ' data';
    }

    // Update x-axis labels
    const xAxisEl = document.querySelector('#' + chartType + 'XAxis, .' + chartType + '-x-axis');
    if (xAxisEl) {
        const spans = xAxisEl.querySelectorAll('span');
        config.xLabels.forEach((label, i) => {
            if (spans[i]) spans[i].textContent = label;
        });
    }

    // Show notification
    showNotification(chartType.charAt(0).toUpperCase() + chartType.slice(1) + '  ' + showingLabels[timeframe], 'info');
}

// Attach handlers to all timeframe dropdowns on load
document.addEventListener('DOMContentLoaded', function() {
    // Intraday dropdown
    const intradayTf = document.getElementById('intradayTimeframe');
    if (intradayTf) {
        intradayTf.addEventListener('change', function() {
            updateChartForTimeframe('intraday', this.value);
        });
    }

    // Swing dropdown
    const swingTf = document.getElementById('swingTimeframe');
    if (swingTf) {
        swingTf.addEventListener('change', function() {
            updateChartForTimeframe('swing', this.value);
        });
    }

    // Position dropdown
    const positionTf = document.getElementById('positionTimeframe');
    if (positionTf) {
        positionTf.addEventListener('change', function() {
            updateChartForTimeframe('position', this.value);
        });
    }
});

// Call updateOpportunitiesPrices after data is loaded
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        if (typeof updateOpportunitiesPrices === 'function') {
            updateOpportunitiesPrices();
        }
    }, 3000);
});

// Also call when Opportunities tab is clicked
const oppTab = document.querySelector('[data-tab="opportunities"]');
if (oppTab) {
    oppTab.addEventListener('click', function() {
        setTimeout(loadOpportunitiesPrices, 100);
    });
}

// Call loadOverviewData when Overview tab is clicked
const overviewTab = document.querySelector('[data-tab="overview"]');
if (overviewTab) {
    overviewTab.addEventListener('click', function() {
        setTimeout(loadOverviewData, 100);
        // Refresh Gann Alerts when Overview tab is shown
        setTimeout(function() {
            if (typeof refreshGannAlerts === 'function') refreshGannAlerts();
        }, 500);
    });
}

// Call updateHistoricalAverages when Bar Count tab is clicked
const barcountTab = document.querySelector('[data-tab="barcount"]');
if (barcountTab) {
    barcountTab.addEventListener('click', function() {
        setTimeout(updateHistoricalAverages, 100);
    });
}

// ============================================
// OPTIONS CALCULATOR - BLACK-SCHOLES
// ============================================

// Standard normal cumulative distribution function
function normalCDF(x) {
    const a1 =  0.254829592;
    const a2 = -0.284496736;
    const a3 =  1.421413741;
    const a4 = -1.453152027;
    const a5 =  1.061405429;
    const p  =  0.3275911;

    const sign = x < 0 ? -1 : 1;
    x = Math.abs(x) / Math.sqrt(2);

    const t = 1.0 / (1.0 + p * x);
    const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);

    return 0.5 * (1.0 + sign * y);
}

// Standard normal probability density function
function normalPDF(x) {
    return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
}

// Black-Scholes option pricing
function blackScholes(S, K, T, r, sigma, optionType) {
    // S = underlying price, K = strike, T = time to expiry (years)
    // r = risk-free rate, sigma = volatility, optionType = 'call' or 'put'

    if (T <= 0) {
        // At expiration
        if (optionType === 'call') {
            return Math.max(0, S - K);
        } else {
            return Math.max(0, K - S);
        }
    }

    const d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
    const d2 = d1 - sigma * Math.sqrt(T);

    if (optionType === 'call') {
        return S * normalCDF(d1) - K * Math.exp(-r * T) * normalCDF(d2);
    } else {
        return K * Math.exp(-r * T) * normalCDF(-d2) - S * normalCDF(-d1);
    }
}

// Calculate Greeks
function calculateGreeks(S, K, T, r, sigma, optionType) {
    if (T <= 0) {
        return { delta: optionType === 'call' ? (S > K ? 1 : 0) : (S < K ? -1 : 0),
                 gamma: 0, theta: 0, vega: 0, rho: 0 };
    }

    const d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
    const d2 = d1 - sigma * Math.sqrt(T);

    // Delta
    let delta;
    if (optionType === 'call') {
        delta = normalCDF(d1);
    } else {
        delta = normalCDF(d1) - 1;
    }

    // Gamma (same for calls and puts)
    const gamma = normalPDF(d1) / (S * sigma * Math.sqrt(T));

    // Theta (per day)
    let theta;
    const term1 = -S * normalPDF(d1) * sigma / (2 * Math.sqrt(T));
    if (optionType === 'call') {
        theta = term1 - r * K * Math.exp(-r * T) * normalCDF(d2);
    } else {
        theta = term1 + r * K * Math.exp(-r * T) * normalCDF(-d2);
    }
    theta = theta / 365; // Convert to per day

    // Vega (per 1% change in volatility)
    const vega = S * Math.sqrt(T) * normalPDF(d1) / 100;

    // Rho (per 1% change in rate)
    let rho;
    if (optionType === 'call') {
        rho = K * T * Math.exp(-r * T) * normalCDF(d2) / 100;
    } else {
        rho = -K * T * Math.exp(-r * T) * normalCDF(-d2) / 100;
    }

    return { delta, gamma, theta, vega, rho };
}

// Main Options Calculator update function
function updateOptionsCalc() {
    try {
        const S = parseFloat(document.getElementById('optCalcSymbol').value) || 607.15;
        const K = parseFloat(document.getElementById('optCalcStrike').value) || 610;
        const DTE = parseFloat(document.getElementById('optCalcDTE').value) || 7;
        const IV = parseFloat(document.getElementById('optCalcIV').value) || 18;
        const rate = parseFloat(document.getElementById('optCalcRate').value) || 5.25;
        const optionType = document.getElementById('optCalcType').value || 'call';

        const T = DTE / 365;
        const r = rate / 100;
        const sigma = IV / 100;

        // Calculate option price
        const price = blackScholes(S, K, T, r, sigma, optionType);

        // Calculate Greeks
        const greeks = calculateGreeks(S, K, T, r, sigma, optionType);

        // Calculate intrinsic and time value
        let intrinsic;
        if (optionType === 'call') {
            intrinsic = Math.max(0, S - K);
        } else {
            intrinsic = Math.max(0, K - S);
        }
        const timeValue = Math.max(0, price - intrinsic);

        // Calculate break-even
        let breakEven;
        if (optionType === 'call') {
            breakEven = K + price;
        } else {
            breakEven = K - price;
        }

        // Update display elements
        const priceEl = document.getElementById('optPriceResult');
        if (priceEl) priceEl.textContent = '$' + price.toFixed(2);

        const intrinsicEl = document.getElementById('optIntrinsicResult');
        if (intrinsicEl) intrinsicEl.textContent = '$' + intrinsic.toFixed(2);

        const timeValueEl = document.getElementById('optTimeValueResult');
        if (timeValueEl) timeValueEl.textContent = '$' + timeValue.toFixed(2);

        const breakEvenEl = document.getElementById('optBreakEvenResult');
        if (breakEvenEl) breakEvenEl.textContent = '$' + breakEven.toFixed(2);

        // Update Greeks
        const deltaEl = document.getElementById('greekDelta');
        if (deltaEl) deltaEl.textContent = greeks.delta.toFixed(3);

        const gammaEl = document.getElementById('greekGamma');
        if (gammaEl) gammaEl.textContent = greeks.gamma.toFixed(4);

        const thetaEl = document.getElementById('greekTheta');
        if (thetaEl) thetaEl.textContent = greeks.theta.toFixed(2);

        const vegaEl = document.getElementById('greekVega');
        if (vegaEl) vegaEl.textContent = greeks.vega.toFixed(2);

        const rhoEl = document.getElementById('greekRho');
        if (rhoEl) rhoEl.textContent = greeks.rho.toFixed(3);

        // Update P&L Scenarios
        updatePnLScenarios(S, K, DTE, IV, rate, optionType, price);

        // Update Time Decay Analysis
        updateThetaDecay(S, K, DTE, IV, rate, optionType, price);

        console.log('Options Calculator updated: ' + optionType.toUpperCase() + ' @ $' + price.toFixed(2));
    } catch (e) {
        console.error('Error updating options calculator:', e);
    }
}

// Update P&L Scenarios table
function updatePnLScenarios(S, K, DTE, IV, rate, optionType, currentPrice) {
    const tbody = document.getElementById('pnlScenarios');
    if (!tbody) return;

    const T = DTE / 365;
    const r = rate / 100;
    const sigma = IV / 100;
    const scenarios = [3, 2, 1, 0, -1, -2, -3];

    let html = '';
    scenarios.forEach(pctMove => {
        const newPrice = S * (1 + pctMove / 100);
        let payoff;
        if (optionType === 'call') {
            payoff = Math.max(0, newPrice - K);
        } else {
            payoff = Math.max(0, K - newPrice);
        }
        const pnl = (payoff - currentPrice) * 100; // Per contract
        const pctReturn = currentPrice > 0 ? ((payoff - currentPrice) / currentPrice * 100) : 0;

        const pnlColor = pnl >= 0 ? '#22c55e' : '#ef4444';
        html += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 8px;">${pctMove >= 0 ? '+' : ''}${pctMove}%</td>
                <td style="padding: 8px; text-align: center;">$${newPrice.toFixed(2)}</td>
                <td style="padding: 8px; text-align: right; color: ${pnlColor}; font-weight: 600;">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(0)}</td>
                <td style="padding: 8px; text-align: right; color: ${pnlColor};">${pctReturn >= 0 ? '+' : ''}${pctReturn.toFixed(0)}%</td>
            </tr>`;
    });

    tbody.innerHTML = html;
}

// Update Time Decay Analysis table
function updateThetaDecay(S, K, DTE, IV, rate, optionType, currentPrice) {
    const tbody = document.getElementById('thetaDecay');
    if (!tbody) return;

    const r = rate / 100;
    const sigma = IV / 100;
    const daysToShow = [DTE, Math.max(1, DTE - 2), Math.max(1, DTE - 4), 1, 0];

    let html = '';
    let prevPrice = currentPrice;
    let cumulative = 0;

    daysToShow.forEach((days, idx) => {
        const T = days / 365;
        let price;
        if (days === 0) {
            price = optionType === 'call' ? Math.max(0, S - K) : Math.max(0, K - S);
        } else {
            price = blackScholes(S, K, T, r, sigma, optionType);
        }

        const decay = idx === 0 ? calculateGreeks(S, K, T, r, sigma, optionType).theta : (price - prevPrice);
        cumulative = price - currentPrice;

        const dayLabel = idx === 0 ? days + ' (Today)' : (days === 0 ? '0 (Expiry)' : days.toString());
        const decayStr = days === 0 ? '-' : ('$' + decay.toFixed(2));
        const cumColor = cumulative < 0 ? '#ef4444' : '#22c55e';

        html += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 8px;">${dayLabel}</td>
                <td style="padding: 8px; text-align: center;">$${price.toFixed(2)}</td>
                <td style="padding: 8px; text-align: right;">${decayStr}</td>
                <td style="padding: 8px; text-align: right; color: ${cumColor};">$${cumulative.toFixed(2)}</td>
            </tr>`;

        prevPrice = price;
    });

    tbody.innerHTML = html;
}

// Initialize Options Calculator on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        if (typeof updateOptionsCalc === 'function') {
            updateOptionsCalc();
        }
    }, 500);
});

// ============================================
// TABLE SORTING UTILITIES - NEWEST FIRST
// ============================================

// Auto-sort all date-based tables to show most recent first
function sortAllTablesNewestFirst() {
    const dateTables = [
        { id: 'barCountTable', dateCol: 1, isDate: true },
        { id: 'historicalDataTable', dateCol: 0, isDate: true },
        { id: 'tradeTableBody', dateCol: 1, isDate: true },
        { id: 'reversalStatsTable', dateCol: 0, isDate: false, sortByRisk: true }
    ];

    dateTables.forEach(config => {
        const tbody = document.getElementById(config.id);
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll('tr'));
        if (rows.length === 0) return;

        rows.sort((a, b) => {
            if (config.sortByRisk) {
                // Sort by risk level (HIGH > MEDIUM > LOW)
                const riskOrder = { 'HIGH': 1, 'MEDIUM': 2, 'MED': 2, 'LOW': 3 };
                const aRisk = a.querySelector('.badge')?.textContent.trim() || 'LOW';
                const bRisk = b.querySelector('.badge')?.textContent.trim() || 'LOW';
                return (riskOrder[aRisk] || 3) - (riskOrder[bRisk] || 3);
            }

            let aVal = a.cells[config.dateCol]?.textContent.trim() || '';
            let bVal = b.cells[config.dateCol]?.textContent.trim() || '';

            if (config.isDate) {
                // Parse dates and sort descending (newest first)
                const aDate = new Date(aVal);
                const bDate = new Date(bVal);
                return bDate - aDate;
            } else {
                // For non-date columns, reverse alphabetically
                return bVal.localeCompare(aVal);
            }
        });

        rows.forEach(row => tbody.appendChild(row));

        // Update row numbers after sorting
        updateRowNumbers(config.id);
    });
}

// Update row numbers dynamically after sorting
function updateRowNumbers(tableId) {
    const tbody = document.getElementById(tableId);
    if (!tbody) return;

    const rows = tbody.querySelectorAll('tr');
    rows.forEach((row, index) => {
        const firstCell = row.cells[0];
        if (firstCell && !isNaN(parseInt(firstCell.textContent))) {
            firstCell.textContent = index + 1;
        }
    });
}

// Load market stats (Today range, 52W range, Volume vs Avg)
async function loadMarketStats(symbol) {
    if (!symbol) symbol = currentSymbol || 'SPY';

    try {
        const response = await fetch('data/' + symbol + '.csv');
        if (!response.ok) {
            console.log('Market stats: No data for ' + symbol);
            return;
        }

        const text = await response.text();
        const lines = text.trim().split('\n');

        if (lines.length < 2) return;

        // Parse all rows to calculate 52W high/low and volume average
        let high52W = -Infinity;
        let low52W = Infinity;
        let volumeSum = 0;
        let volumeCount = 0;

        // Get last 252 trading days (approximately 1 year) for 52W calculations
        const startIdx = Math.max(1, lines.length - 252);

        for (let i = startIdx; i < lines.length; i++) {
            const cols = lines[i].split(',');
            const high = parseFloat(cols[2]);
            const low = parseFloat(cols[3]);
            const volume = parseFloat(cols[5]);

            if (!isNaN(high) && high > high52W) high52W = high;
            if (!isNaN(low) && low < low52W) low52W = low;

            // Calculate 20-day volume average
            if (i >= lines.length - 20 && !isNaN(volume)) {
                volumeSum += volume;
                volumeCount++;
            }
        }

        const avgVolume = volumeCount > 0 ? volumeSum / volumeCount : 0;

        // Get today's data (last row)
        const lastLine = lines[lines.length - 1];
        const cols = lastLine.split(',');

        const todayHigh = parseFloat(cols[2]);
        const todayLow = parseFloat(cols[3]);
        const todayClose = parseFloat(cols[4]);
        const todayVolume = parseFloat(cols[5]);

        // Update Today Low/High
        if (!isNaN(todayLow)) {
            var el=document.getElementById('statTodayLow');if(el)el.textContent = 'L: $' + todayLow.toFixed(2);
        }
        if (!isNaN(todayHigh)) {
            var el=document.getElementById('statTodayHigh');if(el)el.textContent = 'H: $' + todayHigh.toFixed(2);
        }

        // Update 52W Range with color coding
        const stat52W = document.getElementById('stat52WRange');
        if (stat52W && !isNaN(high52W) && !isNaN(low52W)) {
            stat52W.textContent = '$' + low52W.toFixed(2) + ' - $' + high52W.toFixed(2);

            // Color based on where current price is in 52W range
            const range = high52W - low52W;
            const position = (todayClose - low52W) / range;

            if (position > 0.8) {
                stat52W.style.color = '#22c55e'; // Near 52W high - green
            } else if (position < 0.2) {
                stat52W.style.color = '#ef4444'; // Near 52W low - red
            } else {
                stat52W.style.color = 'var(--text)'; // Neutral
            }
        }

        // Update Volume vs Avg
        const statVolume = document.getElementById('statVolumeVsAvg');
        if (statVolume && avgVolume > 0 && !isNaN(todayVolume)) {
            const volPct = ((todayVolume - avgVolume) / avgVolume) * 100;
            const volSign = volPct >= 0 ? '+' : '';
            statVolume.textContent = volSign + volPct.toFixed(0) + '% vs Avg';

            // Color based on volume
            if (volPct > 20) {
                statVolume.style.color = '#22c55e'; // High volume - green
            } else if (volPct < -30) {
                statVolume.style.color = '#ef4444'; // Low volume - red
            } else {
                statVolume.style.color = 'var(--text)'; // Normal
            }
        }

    } catch (error) {
        console.log('Error loading market stats:', error);
    }
}

// Call market stats on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMarketStats();
});

// ==================== TIMESTAMP FUNCTIONS ====================

// Robust date parsing for CSV dates (handles "2025-12-23 00:00:00-05:00" and ISO formats)
function parseCSVDate(dateStr) {
    if (!dateStr) return null;

    // Handle "2025-12-23 00:00:00-05:00" format (space before time)
    let cleanDate = String(dateStr).split(' ')[0];

    // Also handle ISO format with T separator
    if (cleanDate.includes('T')) {
        cleanDate = cleanDate.split('T')[0];
    }

    // Parse YYYY-MM-DD format
    const parts = cleanDate.split('-');
    if (parts.length === 3) {
        const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        if (!isNaN(date.getTime())) return date;
    }

    // Fallback: try native parsing
    const date = new Date(dateStr);
    if (!isNaN(date.getTime())) return date;

    return null;
}

// Format timestamp as "Dec 2, 2025 2:45 PM ET" or short "2:45 PM"
function formatLastUpdated(date, short = false) {
    if (!date) return '--';
    const d = new Date(date);
    if (isNaN(d.getTime())) return '--';

    const options = short ?
        { hour: 'numeric', minute: '2-digit', hour12: true } :
        { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true };

    let formatted = d.toLocaleString('en-US', options);
    if (!short) formatted += ' ET';
    return formatted;
}

// Get color based on staleness
function getTimestampColor(lastUpdateTime) {
    if (!lastUpdateTime) return 'var(--muted)';

    const now = new Date();
    const updated = new Date(lastUpdateTime);
    const diffMinutes = (now - updated) / (1000 * 60);

    // Check if data is from previous day
    if (updated.toDateString() !== now.toDateString()) {
        return '#ef4444'; // Red - previous day
    }

    if (diffMinutes <= 30) return '#22c55e';      // Green - within 30 min
    if (diffMinutes <= 60) return '#eab308';      // Yellow - 30-60 min
    if (diffMinutes <= 240) return '#f97316';     // Orange - 1-4 hours
    return '#ef4444';                              // Red - more than 4 hours
}

// Update all timestamp displays
function updateAllTimestamps() {
    const now = new Date();
    const timestamps = {
        global: now,
        analysis: now,
        health: now,
        multiCharts: now,
        trades: now
    };

    // Save to localStorage
    localStorage.setItem('stockAgentTimestamps', JSON.stringify(timestamps));

    // Update displays
    updateTimestampDisplays(timestamps);
}

// Update specific section timestamp
function updateSectionTimestamp(section) {
    const timestamps = JSON.parse(localStorage.getItem('stockAgentTimestamps') || '{}');
    timestamps[section] = new Date().toISOString();
    localStorage.setItem('stockAgentTimestamps', JSON.stringify(timestamps));
    updateTimestampDisplays(timestamps);
}

// Update timestamp display elements
function updateTimestampDisplays(timestamps) {
    // Global timestamp
    const globalEl = document.getElementById('globalLastUpdated');
    if (globalEl && timestamps.global) {
        globalEl.textContent = formatLastUpdated(timestamps.global, true);
        globalEl.style.color = getTimestampColor(timestamps.global);
        globalEl.title = 'Last updated: ' + formatLastUpdated(timestamps.global);
    }

    // Analysis timestamp
    const analysisEl = document.getElementById('analysisLastUpdated');
    if (analysisEl && timestamps.analysis) {
        analysisEl.textContent = ' ' + formatLastUpdated(timestamps.analysis, true);
        analysisEl.style.color = getTimestampColor(timestamps.analysis);
        analysisEl.title = 'Last updated: ' + formatLastUpdated(timestamps.analysis);
    }

    // Health timestamp
    const healthEl = document.getElementById('healthLastUpdated');
    if (healthEl && timestamps.health) {
        healthEl.textContent = ' ' + formatLastUpdated(timestamps.health, true);
        healthEl.style.color = getTimestampColor(timestamps.health);
        healthEl.title = 'Last health check: ' + formatLastUpdated(timestamps.health);
    }

    // Multi-Charts timestamp
    const multiChartsEl = document.getElementById('multiChartsLastUpdated');
    if (multiChartsEl && timestamps.multiCharts) {
        multiChartsEl.textContent = ' ' + formatLastUpdated(timestamps.multiCharts, true);
        multiChartsEl.style.color = getTimestampColor(timestamps.multiCharts);
        multiChartsEl.title = 'Last updated: ' + formatLastUpdated(timestamps.multiCharts);
    }

    // Trades timestamp
    const tradesEl = document.getElementById('tradesLastUpdated');
    if (tradesEl && timestamps.trades) {
        tradesEl.textContent = ' ' + formatLastUpdated(timestamps.trades, true);
        tradesEl.style.color = getTimestampColor(timestamps.trades);
        tradesEl.title = 'Last updated: ' + formatLastUpdated(timestamps.trades);
    }
}

// Load saved timestamps from localStorage on page load
function loadSavedTimestamps() {
    const saved = localStorage.getItem('stockAgentTimestamps');
    if (saved) {
        try {
            const timestamps = JSON.parse(saved);
            updateTimestampDisplays(timestamps);
        } catch (e) {
            console.log('Error loading timestamps:', e);
        }
    }
}

// Check staleness and update colors every minute
setInterval(function() {
    const saved = localStorage.getItem('stockAgentTimestamps');
    if (saved) {
        try {
            updateTimestampDisplays(JSON.parse(saved));
        } catch (e) {}
    }
}, 60000); // Check every minute

// Load timestamps on page load
document.addEventListener('DOMContentLoaded', loadSavedTimestamps);

// ==================== END TIMESTAMP FUNCTIONS ====================

function setTradingMode(mode) {
    tradingMode = mode;
    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.mode-btn.${mode}`).classList.add('active');
    var el=document.getElementById('symbolBanner');if(el)el.className = `symbol-banner ${mode}-mode`;
    var el=document.getElementById('currentModeDisplay');if(el)el.textContent = mode.toUpperCase();
    var el=document.getElementById('aiContextMode');if(el)el.textContent = mode.toUpperCase();
}

async function changeSymbol() {
    const newSymbol = document.getElementById('symbolSelect').value;
    console.log(` Changing symbol from ${currentSymbol} to ${newSymbol}`);
    currentSymbol = newSymbol;

    // Update ALL symbol displays immediately
    const symbolDisplays = ['currentSymbolDisplay', 'tickerSymbol', 'aiContextSymbol', 'barCountCurrentSymbol', 'gannCurrentSymbol', 'patternSymbol', 'historicalSymbol'];
    symbolDisplays.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = currentSymbol;
    });

    const nameDisplays = ['currentSymbolName', 'tickerName'];
    nameDisplays.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = SYMBOL_NAMES[currentSymbol] || currentSymbol;
    });

    // Update Multi-Charts symbol selector to match
    const multiChartSymbol = document.getElementById('multiChartSymbol');
    if (multiChartSymbol) multiChartSymbol.value = currentSymbol;

    // Update Market Conditions symbol selector to match
    const mktConditionsSymbol = document.getElementById('mktConditionsSymbol');
    if (mktConditionsSymbol) mktConditionsSymbol.value = currentSymbol;

    // Update Daily Analysis symbol display
    const confluenceSymbol = document.getElementById('confluenceSymbol');
    if (confluenceSymbol) confluenceSymbol.textContent = currentSymbol + ' Analysis';

    // Show loading notification
    showNotification('Loading ' + currentSymbol + ' data...', 'info');

    // Load the new symbol's CSV data and update everything
    await loadAllData();

    // Update Overview tab with CSV data
    if (typeof loadOverviewData === 'function') loadOverviewData();

    // Update market stats for new symbol
    if (typeof loadMarketStats === 'function') loadMarketStats(currentSymbol);

    // Update Options Calculator with new symbol
    if (typeof updateOptionsCalcForSymbol === 'function') updateOptionsCalcForSymbol();

    // === UPDATE ALL GANN SECTIONS ===
    if (typeof updateGannAnalysisForSymbol === 'function') updateGannAnalysisForSymbol(currentSymbol);
    if (typeof updateGannForecast === 'function') updateGannForecast(currentSymbol);
    if (typeof updateSquareOf9 === 'function') updateSquareOf9(currentSymbol);
    if (typeof updateMasterConfluence === 'function') updateMasterConfluence(currentSymbol);
    if (typeof updatePriceMathRelationships === 'function') updatePriceMathRelationships(currentSymbol);
    if (typeof updateFibonacciLevelsSafe === 'function') updateFibonacciLevelsSafe(currentSymbol);
    if (typeof updateSacredNumbers === 'function') updateSacredNumbers(currentSymbol);
    if (typeof updateGannAngles === 'function') updateGannAngles(currentSymbol);
    if (typeof updateGannTimeCycles === 'function') updateGannTimeCycles(currentSymbol);

    // === UPDATE MARKET ANALYSIS TAB ===
    if (typeof updateMarketAnalysisTab === 'function') updateMarketAnalysisTab();

    // === UPDATE PATTERN & HISTORICAL SECTIONS ===
    if (typeof updateDataPatternDetection === 'function') updateDataPatternDetection();
    if (typeof updatePatternDetection === 'function') updatePatternDetection(currentSymbol);
    if (typeof updatePatternDetectionSummary === 'function') updatePatternDetectionSummary();
    if (typeof updatePatternTableFromCSV === 'function') updatePatternTableFromCSV();
    if (typeof updateHistoricalData === 'function') updateHistoricalData(currentSymbol);
    if (typeof updateHistoricalDataTable === 'function') updateHistoricalDataTable();
    if (typeof updateTradeStatisticsSafe === 'function') updateTradeStatisticsSafe(currentSymbol);
    if (typeof updateTradeStatistics === 'function') updateTradeStatistics();

    // === UPDATE BAR COUNT SECTIONS ===
    if (typeof updateBarCountAnalysis === 'function') updateBarCountAnalysis();
    if (typeof updateBarCount === 'function') updateBarCount(currentSymbol);

    // === UPDATE OTHER SECTIONS ===
    if (typeof updateOverviewForSymbol === 'function') updateOverviewForSymbol(currentSymbol);
    if (typeof updateSignalsForSymbol === 'function') updateSignalsForSymbol(currentSymbol);
    if (typeof updateDailyAnalysisForSymbol === 'function') updateDailyAnalysisForSymbol(currentSymbol);
    if (typeof updateHeaderForSymbol === 'function') updateHeaderForSymbol(currentSymbol);

    // Update Gann Analysis tab if active
    const gannTab = document.getElementById('gann-analysis');
    if (gannTab && gannTab.classList.contains('active')) {
        if (typeof updateGannAnalysis === 'function') updateGannAnalysis();
    }

    console.log(' All sections updated for ' + currentSymbol);
    showNotification(currentSymbol + ' loaded!', 'success');
}

function parseCSV(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return [];
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
        const values = line.split(',');
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i]?.trim() || '');
        return obj;
    });
}

async function loadAllData() {
    var el=document.getElementById('loadingOverlay');if(el)el.classList.add('active');
    try {
        // Try multiple paths for the CSV file
        let r = null;
        let loadedSymbol = currentSymbol;

        // Try data/ folder first, then root
        const paths = [
            `data/${currentSymbol}.csv?t=${Date.now()}`,
            `${currentSymbol}.csv?t=${Date.now()}`
        ];

        for (const path of paths) {
            r = await fetch(path).catch(() => null);
            if (r?.ok) {
                console.log(` Found data at: ${path}`);
                break;
            }
        }
        
        // If the selected symbol's CSV doesn't exist, fall back to SPY
        if (!r?.ok) {
            console.warn(`${currentSymbol}.csv not found, falling back to SPY`);
            // Try SPY in both locations
            r = await fetch('data/SPY.csv?t=' + Date.now()).catch(() => null);
            loadedSymbol = 'SPY';

            // Update the symbol selector back to SPY if data not available
            const select = document.getElementById('symbolSelect');
            if (select) select.value = 'SPY';
            currentSymbol = 'SPY';

            // Show notification
            showDataNotification(`Data loaded for SPY`);
        }
        
        if (r?.ok) {
            currentData = parseCSV(await r.text());
            if (currentData.length) {
                console.log(` Loaded ${currentData.length} bars for ${currentSymbol}`);
                
                // Update ALL dashboard components
                updateDashboard();
                updateBarCountAnalysis();
                updateReversalStats();
                updatePriceChart();
                updateOverviewAiAnalysis();
                updateDataPatternDetection();
                updatePatternTableFromCSV();
                updateOverviewTab();

                // Update Daily Analysis if that tab is active
                const analysisTab = document.getElementById('daily-analysis');
                if (analysisTab && analysisTab.classList.contains('active')) {
                    await loadRealAgentSignals();
                    generateDailyReport();
                }
                
                // Update Multi-Charts if that tab is active
                const multiChartsTab = document.getElementById('multi-charts');
                if (multiChartsTab && multiChartsTab.classList.contains('active')) {
                    updateAllMultiCharts();
                }
                
                // Update symbol displays
                var el=document.getElementById('currentSymbolDisplay');if(el)el.textContent = currentSymbol;
                var el=document.getElementById('currentSymbolName');if(el)el.textContent = SYMBOL_NAMES[currentSymbol] || currentSymbol;
                var el=document.getElementById('tickerSymbol');if(el)el.textContent = currentSymbol;
                var el=document.getElementById('tickerName');if(el)el.textContent = SYMBOL_NAMES[currentSymbol] || currentSymbol;
                var el=document.getElementById('confluenceSymbol');if(el)el.textContent = currentSymbol + ' Analysis';

                // Update market stats in header
                loadMarketStats(currentSymbol);

                // Update timestamps
                updateAllTimestamps();

// Load all symbols data for AI and cross-symbol analysis                await loadAllSymbolsData();
                setTimeout(updateAllSymbolGannDataFromCSV, 500);

                // Refresh Gann Alerts after all data is loaded
                setTimeout(function() {
                    if (typeof refreshGannAlerts === 'function') refreshGannAlerts();
                }, 1000);
            }
        }
    } catch (e) { console.error('Error:', e); }
    var el=document.getElementById('loadingOverlay');if(el)el.classList.remove('active');
}

function showDataNotification(message) {
    // Create a temporary notification
    const notif = document.createElement('div');
    notif.style.cssText = 'position:fixed;top:80px;right:20px;background:var(--warning);color:white;padding:12px 20px;border-radius:8px;font-size:12px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.2);';
    notif.textContent = ' ' + message;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 3000);
}

async function loadAllSymbolsData() {
    for (const symbol of SYMBOLS) {
        try {
            const r = await fetch(`data/${symbol}.csv?t=${Date.now()}`).catch(() => null);
            if (r?.ok) {
                allSymbolsData[symbol] = parseCSV(await r.text());
            }
        } catch (e) { console.error(`Error loading ${symbol}:`, e); }
    }
    // Update Gann dashboard prices after data loads
    if (typeof updateGannDashboardPrices === 'function') {
        updateGannDashboardPrices();
    }
}


// =============================================
// MARKET ANALYSIS TAB - VIX & BREADTH FUNCTIONS
// =============================================

// VIX data storage
var vixData = [];

// Load VIX data from CSV
async function loadVixData() {
    try {
        var response = await fetch('data/VIX.csv?t=' + Date.now());
        if (!response.ok) {
            console.log('VIX.csv not found, using defaults');
            return;
        }
        var text = await response.text();
        var lines = text.trim().split('\n');
        var headers = lines[0].split(',');

        vixData = [];
        for (var i = 1; i < lines.length; i++) {
            var values = lines[i].split(',');
            var row = {};
            for (var j = 0; j < headers.length; j++) {
                row[headers[j].trim()] = values[j] ? values[j].trim() : '';
            }
            vixData.push(row);
        }
        console.log('VIX data loaded: ' + vixData.length + ' rows');

        if (typeof updateMarketAnalysisTab === 'function') {
            updateMarketAnalysisTab();
        }
    } catch (e) {
        console.log('Error loading VIX data: ' + e);
    }
}

// Update Market Analysis Tab with real data
function updateMarketAnalysisTab() {
    var symbols = ['SPY', 'QQQ', 'IWM', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];

    // === VIX Analysis ===
    var vixCurrent = 14.9;
    var vix20MA = 16.5;
    if (vixData && vixData.length > 0) {
        vixCurrent = parseFloat(vixData[vixData.length - 1].Close) || 14.9;
        if (vixData.length >= 20) {
            var vixSum = 0;
            for (var i = vixData.length - 20; i < vixData.length; i++) {
                vixSum += parseFloat(vixData[i].Close) || 0;
            }
            vix20MA = vixSum / 20;
        }
    }
    var vixVsAvg = ((vixCurrent - vix20MA) / vix20MA * 100).toFixed(1);
    var vixStatus, vixStatusColor;
    if (vixCurrent < 12) {
        vixStatus = 'Extreme Low ';
        vixStatusColor = '#f59e0b';
    } else if (vixCurrent < 16) {
        vixStatus = 'Low Vol ';
        vixStatusColor = '#22c55e';
    } else if (vixCurrent < 20) {
        vixStatus = 'Normal';
        vixStatusColor = '#666';
    } else if (vixCurrent < 25) {
        vixStatus = 'Elevated ';
        vixStatusColor = '#f59e0b';
    } else {
        vixStatus = 'High Fear ';
        vixStatusColor = '#ef4444';
    }

    var el;
    el = document.getElementById('mktVixValue');
    if (el) el.textContent = vixCurrent.toFixed(1);
    el = document.getElementById('mktVixStatus');
    if (el) { el.textContent = vixStatus; el.style.color = vixStatusColor; }
    el = document.getElementById('mktVix20MA');
    if (el) el.textContent = '20MA: ' + vix20MA.toFixed(1);
    el = document.getElementById('mktVixCurrent');
    if (el) el.textContent = vixCurrent.toFixed(1);
    el = document.getElementById('mktVixAvg');
    if (el) el.textContent = vix20MA.toFixed(1);
    el = document.getElementById('mktVixVsAvg');
    if (el) {
        el.textContent = (vixVsAvg >= 0 ? '+' : '') + vixVsAvg + '%';
        el.style.color = vixVsAvg < 0 ? '#22c55e' : '#ef4444';
    }

    var vixInterp = '';
    if (vixCurrent < 12) {
        vixInterp = 'VIX extremely low indicates complacency. High risk of volatility spike. Consider protective puts.';
    } else if (vixCurrent < 16) {
        vixInterp = 'VIX below average indicates low fear. Markets may be vulnerable to a volatility spike. Good for selling premium.';
    } else if (vixCurrent < 20) {
        vixInterp = 'VIX in normal range. Standard trading conditions apply. No volatility edge either way.';
    } else if (vixCurrent < 25) {
        vixInterp = 'Elevated VIX indicates increased fear. Use wider stops and smaller position sizes. Potential bounce setups.';
    } else {
        vixInterp = 'High VIX indicates extreme fear. Contrarian buy opportunities may emerge. Watch for capitulation signals.';
    }
    el = document.getElementById('mktVixInterpretation');
    if (el) el.innerHTML = '<strong>Interpretation:</strong> ' + vixInterp;

    // === Selected Symbol Analysis ===
    // Check dropdown first, then fall back to currentSymbol
    var mktDropdown = document.getElementById('mktConditionsSymbol');
    var selectedSymbol = (mktDropdown && mktDropdown.value) ? mktDropdown.value : (currentSymbol || 'SPY');

    // Sync dropdown with selected symbol
    if (mktDropdown && mktDropdown.value !== selectedSymbol) {
        mktDropdown.value = selectedSymbol;
    }

    var spyPrice = 0;
    var spy20MA = 0;
    var spy50MA = 0;
    var spy200MA = 0;
    var spyData = allSymbolsData[selectedSymbol];

    if (spyData && spyData.length > 0) {
        spyPrice = parseFloat(spyData[spyData.length - 1].Close) || 0;

        if (spyData.length >= 20) {
            var sum20 = 0;
            for (var i = spyData.length - 20; i < spyData.length; i++) {
                sum20 += parseFloat(spyData[i].Close) || 0;
            }
            spy20MA = sum20 / 20;
        }
        if (spyData.length >= 50) {
            var sum50 = 0;
            for (var i = spyData.length - 50; i < spyData.length; i++) {
                sum50 += parseFloat(spyData[i].Close) || 0;
            }
            spy50MA = sum50 / 50;
        }
        if (spyData.length >= 200) {
            var sum200 = 0;
            for (var i = spyData.length - 200; i < spyData.length; i++) {
                sum200 += parseFloat(spyData[i].Close) || 0;
            }
            spy200MA = sum200 / 200;
        }
    }

    if (symbolGannData && symbolGannData[selectedSymbol] && symbolGannData[selectedSymbol].price) {
        spyPrice = symbolGannData[selectedSymbol].price;
    }

    var spyAbove20MA = spyPrice > spy20MA;
    var spyTrendText = spyAbove20MA ? ' ABOVE' : ' BELOW';
    var spyTrendStatus = spyAbove20MA ? 'Bullish ' : 'Bearish ';
    var spyTrendColor = spyAbove20MA ? '#22c55e' : '#ef4444';

    el = document.getElementById('mktSpyTrend');
    if (el) { el.textContent = spyTrendText; el.style.color = spyTrendColor; }
    el = document.getElementById('mktSpyTrendStatus');
    if (el) { el.textContent = spyTrendStatus; el.style.color = spyTrendColor; }
    el = document.getElementById('mktSpy20MA');
    if (el) el.textContent = '20MA: $' + spy20MA.toFixed(2);
    el = document.getElementById('mktSpyPrice');
    if (el) el.textContent = '$' + spyPrice.toFixed(2);
    el = document.getElementById('mktSpy20MALevel');
    if (el) el.textContent = '$' + spy20MA.toFixed(2);
    el = document.getElementById('mktSpy50MALevel');
    if (el) el.textContent = '$' + spy50MA.toFixed(2);
    el = document.getElementById('mktSpy200MALevel');
    if (el) el.textContent = '$' + spy200MA.toFixed(2);

    // Update symbol labels
    el = document.getElementById('mktSymbolLabel');
    if (el) el.textContent = selectedSymbol + ' vs 20MA';
    el = document.getElementById('mktMATitle');
    if (el) el.textContent = ' ' + selectedSymbol + ' Moving Average Levels';

    // Update 20MA rule symbol references
    el = document.getElementById('mkt20MASymbol');
    if (el) el.textContent = selectedSymbol;
    el = document.getElementById('mkt20MASymbol2');
    if (el) el.textContent = selectedSymbol;

    var dist20 = spy20MA > 0 ? ((spyPrice - spy20MA) / spy20MA * 100).toFixed(1) : 0;
    var dist50 = spy50MA > 0 ? ((spyPrice - spy50MA) / spy50MA * 100).toFixed(1) : 0;
    var dist200 = spy200MA > 0 ? ((spyPrice - spy200MA) / spy200MA * 100).toFixed(1) : 0;

    el = document.getElementById('mktSpy20MADist');
    if (el) {
        el.textContent = (dist20 >= 0 ? '+' : '') + dist20 + '% ' + (dist20 >= 0 ? 'above' : 'below');
        el.style.color = dist20 >= 0 ? '#22c55e' : '#ef4444';
    }
    el = document.getElementById('mktSpy50MADist');
    if (el) {
        el.textContent = (dist50 >= 0 ? '+' : '') + dist50 + '% ' + (dist50 >= 0 ? 'above' : 'below');
        el.style.color = dist50 >= 0 ? '#22c55e' : '#ef4444';
    }
    el = document.getElementById('mktSpy200MADist');
    if (el) {
        el.textContent = (dist200 >= 0 ? '+' : '') + dist200 + '% ' + (dist200 >= 0 ? 'above' : 'below');
        el.style.color = dist200 >= 0 ? '#22c55e' : '#ef4444';
    }

    // === Breadth Analysis ===
    var aboveMA = [];
    var belowMA = [];

    for (var s = 0; s < symbols.length; s++) {
        var sym = symbols[s];
        var symData = allSymbolsData[sym];
        if (!symData || symData.length < 20) continue;

        var symPrice = parseFloat(symData[symData.length - 1].Close) || 0;
        if (symbolGannData && symbolGannData[sym] && symbolGannData[sym].price) {
            symPrice = symbolGannData[sym].price;
        }

        var symSum = 0;
        for (var i = symData.length - 20; i < symData.length; i++) {
            symSum += parseFloat(symData[i].Close) || 0;
        }
        var sym20MA = symSum / 20;

        if (symPrice > sym20MA) {
            aboveMA.push(sym);
        } else {
            belowMA.push(sym);
        }
    }

    var breadthPct = symbols.length > 0 ? Math.round((aboveMA.length / symbols.length) * 100) : 0;
    var breadthStatus, breadthColor;
    if (breadthPct >= 70) {
        breadthStatus = 'Strong ';
        breadthColor = '#22c55e';
    } else if (breadthPct >= 50) {
        breadthStatus = 'Neutral';
        breadthColor = '#eab308';
    } else if (breadthPct >= 30) {
        breadthStatus = 'Weak ';
        breadthColor = '#f59e0b';
    } else {
        breadthStatus = 'Very Weak ';
        breadthColor = '#ef4444';
    }

    el = document.getElementById('mktBreadthValue');
    if (el) { el.textContent = breadthPct + '%'; el.style.color = breadthColor; }
    el = document.getElementById('mktBreadthStatus');
    if (el) { el.textContent = breadthStatus; el.style.color = breadthColor; }
    el = document.getElementById('mktBreadthCount');
    if (el) el.textContent = aboveMA.length + '/' + symbols.length + ' above 20MA';
    el = document.getElementById('mktBreadthPct');
    if (el) { el.textContent = breadthPct + '%'; el.style.color = breadthColor; }

    el = document.getElementById('mktBreadthAbove');
    if (el) {
        el.innerHTML = aboveMA.map(function(sym) {
            return '<span style="padding: 6px 12px; background: rgba(34,197,94,0.15); color: #22c55e; border-radius: 6px; font-size: 11px; font-weight: 600;">' + sym + '</span>';
        }).join('') || '<span style="color: #666; font-size: 11px;">None</span>';
    }
    el = document.getElementById('mktBreadthBelow');
    if (el) {
        el.innerHTML = belowMA.map(function(sym) {
            return '<span style="padding: 6px 12px; background: rgba(239,68,68,0.15); color: #ef4444; border-radius: 6px; font-size: 11px; font-weight: 600;">' + sym + '</span>';
        }).join('') || '<span style="color: #666; font-size: 11px;">None</span>';
    }

    // === Overall Score ===
    var score = 0;
    var vixOK = vixCurrent < 20;
    var spyOK = spyAbove20MA;
    var breadthOK = breadthPct >= 50;

    if (vixOK) score++;
    if (spyOK) score++;
    if (breadthOK) score++;

    var overallText, overallColor, overallAdvice;
    if (score >= 3) {
        overallText = 'FAVORABLE';
        overallColor = '#22c55e';
        overallAdvice = 'Favor CALLs';
    } else if (score >= 2) {
        overallText = 'MIXED';
        overallColor = '#eab308';
        overallAdvice = 'Be Selective';
    } else {
        overallText = 'UNFAVORABLE';
        overallColor = '#ef4444';
        overallAdvice = 'Favor PUTs';
    }

    el = document.getElementById('mktOverallValue');
    if (el) { el.textContent = overallText; el.style.color = overallColor; }
    el = document.getElementById('mktOverallScore');
    if (el) { el.textContent = score + '/3 ' + (score >= 2 ? '' : ''); el.style.color = overallColor; }
    el = document.getElementById('mktOverallAdvice');
    if (el) el.textContent = overallAdvice;
    el = document.getElementById('mktOverallBox');
    if (el) {
        var rgb = overallColor === '#22c55e' ? '34,197,94' : overallColor === '#eab308' ? '234,179,8' : '239,68,68';
        el.style.background = 'linear-gradient(135deg, rgba(' + rgb + ',0.1), rgba(' + rgb + ',0.2))';
        el.style.borderColor = overallColor;
    }

    // === Directional Bias ===
    var biasText = spyOK ? 'BULLISH' : 'BEARISH';
    var biasColor = spyOK ? '#22c55e' : '#ef4444';

    el = document.getElementById('mktBiasText');
    if (el) { el.textContent = biasText; el.style.color = biasColor; }
    el = document.getElementById('mktBiasBox');
    if (el) {
        var biasRgb = spyOK ? '34,197,94' : '239,68,68';
        el.style.background = 'linear-gradient(135deg, rgba(' + biasRgb + ',0.15), rgba(' + biasRgb + ',0.25))';
        el.style.borderColor = biasColor;
    }

    el = document.getElementById('mktAnalysisSummary');
    if (el) {
        var summaryHTML = '<div> <strong>SPY ' + (spyOK ? 'above' : 'below') + ' 20MA</strong> - Primary trend is ' + (spyOK ? 'UP' : 'DOWN') + '</div>';
        summaryHTML += '<div> <strong>' + (breadthOK ? 'Strong' : 'Weak') + ' breadth (' + breadthPct + '%)</strong> - ' + (breadthOK ? 'Broad participation' : 'Narrow participation') + '</div>';
        summaryHTML += '<div> <strong>' + (vixCurrent < 16 ? 'Low' : vixCurrent < 20 ? 'Normal' : 'High') + ' VIX (' + vixCurrent.toFixed(1) + ')</strong> - ' + (vixCurrent < 16 ? 'Complacency risk' : vixCurrent < 20 ? 'Normal conditions' : 'Fear elevated') + '</div>';

        var recColor = spyOK ? '#166534' : '#991b1b';
        var recBg = spyOK ? 'rgba(34,197,94,0.1)' : 'rgba(239,68,68,0.1)';
        var recText = spyOK ?
            ' Recommendation: Favor CALL trades, normal position sizes, buy dips' :
            ' Recommendation: Favor PUT trades, reduce position sizes, sell rallies';

        summaryHTML += '<div style="margin-top: 10px; padding: 10px; background: ' + recBg + '; border-radius: 6px; color: ' + recColor + '; font-weight: 600;">' + recText + '</div>';
        el.innerHTML = summaryHTML;
    }

    console.log('Market Analysis Tab updated - Score: ' + score + '/3, Bias: ' + biasText);
}

// Change symbol in Market Conditions tab via dropdown
function changeMktConditionsSymbol() {
    // Use global symbol from SymbolManager
    var selectedSymbol = (typeof SymbolManager !== 'undefined' && SymbolManager.get()) ||
                         (typeof currentSymbol !== 'undefined' && currentSymbol) ||
                         document.getElementById('symbolSelect')?.value || 'SPY';

    // Update badge display
    var badge = document.getElementById('mktConditionsCurrentSymbol');
    if (badge) badge.textContent = selectedSymbol;

    console.log(' Changing Market Conditions to: ' + selectedSymbol);

    // Update the Market Analysis Tab with new symbol
    if (typeof updateMarketAnalysisTab === 'function') {
        updateMarketAnalysisTab();
    }
}

// ==========================================
// PERFORMANCE TRACKER - BACKTESTING ENGINE
// ==========================================

// Run backtest on historical data
function runBacktest() {
    var spyData = allSymbolsData['SPY'];
    if (!spyData || spyData.length < 50) {
        console.log('Not enough SPY data for backtest');
        return;
    }

    var results = {
        gann: { wins: 0, losses: 0, totalReturn: 0 },
        market: { wins: 0, losses: 0, totalReturn: 0 },
        aligned: { wins: 0, losses: 0, totalReturn: 0 },
        conflict: { gannWins: 0, gannLosses: 0, mktWins: 0, mktLosses: 0 },
        daily: []
    };

    // Start from day 21 (need 20 days for MA calculation)
    var startDay = 21;
    var endDay = spyData.length - 1; // Need next day to verify

    for (var i = startDay; i < endDay; i++) {
        var today = spyData[i];
        var nextDay = spyData[i + 1];

        var price = parseFloat(today.Close) || 0;
        var nextClose = parseFloat(nextDay.Close) || 0;
        if (price === 0 || nextClose === 0) continue;

        var actualMove = nextClose - price;
        var actualPct = (actualMove / price) * 100;

        // Calculate 20-day high/low for Gann
        var high20 = 0, low20 = 999999;
        for (var j = i - 20; j < i; j++) {
            var h = parseFloat(spyData[j].High) || 0;
            var l = parseFloat(spyData[j].Low) || 0;
            if (h > high20) high20 = h;
            if (l < low20 && l > 0) low20 = l;
        }

        // Calculate 20MA for Market Conditions
        var sum20 = 0;
        for (var j = i - 19; j <= i; j++) {
            sum20 += parseFloat(spyData[j].Close) || 0;
        }
        var ma20 = sum20 / 20;

        // GANN Prediction (mean reversion)
        var range = high20 - low20;
        var position = range > 0 ? (price - low20) / range : 0.5;
        var gannPred = position < 0.35 ? 'CALL' : (position > 0.65 ? 'PUT' : 'HOLD');

        // MARKET Prediction (trend following)
        var mktPred = price > ma20 ? 'CALL' : 'PUT';

        // Skip HOLD predictions for Gann
        if (gannPred === 'HOLD') continue;

        // Check if predictions were correct
        var gannCorrect = (gannPred === 'CALL' && actualMove > 0) || (gannPred === 'PUT' && actualMove < 0);
        var mktCorrect = (mktPred === 'CALL' && actualMove > 0) || (mktPred === 'PUT' && actualMove < 0);
        var aligned = gannPred === mktPred;

        // Update Gann stats
        if (gannCorrect) {
            results.gann.wins++;
            results.gann.totalReturn += Math.abs(actualPct);
        } else {
            results.gann.losses++;
            results.gann.totalReturn -= Math.abs(actualPct);
        }

        // Update Market stats
        if (mktCorrect) {
            results.market.wins++;
            results.market.totalReturn += Math.abs(actualPct);
        } else {
            results.market.losses++;
            results.market.totalReturn -= Math.abs(actualPct);
        }

        // Update Aligned/Conflict stats
        if (aligned) {
            if (gannCorrect) {
                results.aligned.wins++;
                results.aligned.totalReturn += Math.abs(actualPct);
            } else {
                results.aligned.losses++;
                results.aligned.totalReturn -= Math.abs(actualPct);
            }
        } else {
            // Conflict
            if (gannCorrect) results.conflict.gannWins++;
            else results.conflict.gannLosses++;
            if (mktCorrect) results.conflict.mktWins++;
            else results.conflict.mktLosses++;
        }

        // Store daily result
        results.daily.push({
            date: today.Date,
            price: price,
            gannPred: gannPred,
            mktPred: mktPred,
            aligned: aligned,
            actualMove: actualPct,
            gannCorrect: gannCorrect,
            mktCorrect: mktCorrect
        });
    }

    // Calculate final stats
    var gannTotal = results.gann.wins + results.gann.losses;
    var mktTotal = results.market.wins + results.market.losses;
    var alignedTotal = results.aligned.wins + results.aligned.losses;
    var conflictGannTotal = results.conflict.gannWins + results.conflict.gannLosses;
    var conflictMktTotal = results.conflict.mktWins + results.conflict.mktLosses;

    results.gannWinRate = gannTotal > 0 ? (results.gann.wins / gannTotal * 100).toFixed(1) : 0;
    results.mktWinRate = mktTotal > 0 ? (results.market.wins / mktTotal * 100).toFixed(1) : 0;
    results.alignedWinRate = alignedTotal > 0 ? (results.aligned.wins / alignedTotal * 100).toFixed(1) : 0;
    results.conflictGannWinRate = conflictGannTotal > 0 ? (results.conflict.gannWins / conflictGannTotal * 100).toFixed(1) : 0;
    results.conflictMktWinRate = conflictMktTotal > 0 ? (results.conflict.mktWins / conflictMktTotal * 100).toFixed(1) : 0;

    results.gannAvgReturn = gannTotal > 0 ? (results.gann.totalReturn / gannTotal).toFixed(2) : 0;
    results.mktAvgReturn = mktTotal > 0 ? (results.market.totalReturn / mktTotal).toFixed(2) : 0;
    results.alignedAvgReturn = alignedTotal > 0 ? (results.aligned.totalReturn / alignedTotal).toFixed(2) : 0;

    console.log('Backtest complete:', results);
    return results;
}

// Update backtest display
function updateBacktestDisplay(results) {
    if (!results) {
        results = runBacktest();
    }
    if (!results) return;

    var el;

    // Period info
    var spyData = allSymbolsData['SPY'];
    var startDate = spyData && spyData.length > 21 ? spyData[21].Date : 'N/A';
    var endDate = spyData && spyData.length > 0 ? spyData[spyData.length - 1].Date : 'N/A';
    el = document.getElementById('backtestPeriod');
    if (el) el.textContent = 'Period: ' + startDate + ' to ' + endDate + ' (' + results.daily.length + ' trading days analyzed)';

    // Gann stats
    el = document.getElementById('btGannWinRate');
    if (el) {
        el.textContent = results.gannWinRate + '%';
        el.style.color = results.gannWinRate >= 55 ? '#22c55e' : (results.gannWinRate >= 45 ? '#eab308' : '#ef4444');
    }
    el = document.getElementById('btGannRecord');
    if (el) el.textContent = results.gann.wins + '/' + (results.gann.wins + results.gann.losses) + ' correct';
    el = document.getElementById('btGannAvgReturn');
    if (el) {
        el.textContent = 'Avg: ' + (results.gannAvgReturn >= 0 ? '+' : '') + results.gannAvgReturn + '%';
        el.style.color = results.gannAvgReturn >= 0 ? '#22c55e' : '#ef4444';
    }

    // Market stats
    el = document.getElementById('btMktWinRate');
    if (el) {
        el.textContent = results.mktWinRate + '%';
        el.style.color = results.mktWinRate >= 55 ? '#22c55e' : (results.mktWinRate >= 45 ? '#eab308' : '#ef4444');
    }
    el = document.getElementById('btMktRecord');
    if (el) el.textContent = results.market.wins + '/' + (results.market.wins + results.market.losses) + ' correct';
    el = document.getElementById('btMktAvgReturn');
    if (el) {
        el.textContent = 'Avg: ' + (results.mktAvgReturn >= 0 ? '+' : '') + results.mktAvgReturn + '%';
        el.style.color = results.mktAvgReturn >= 0 ? '#22c55e' : '#ef4444';
    }

    // Aligned stats
    el = document.getElementById('btAlignedWinRate');
    if (el) {
        el.textContent = results.alignedWinRate + '%';
        el.style.color = results.alignedWinRate >= 55 ? '#22c55e' : (results.alignedWinRate >= 45 ? '#eab308' : '#ef4444');
    }
    el = document.getElementById('btAlignedRecord');
    if (el) el.textContent = results.aligned.wins + '/' + (results.aligned.wins + results.aligned.losses) + ' correct';
    el = document.getElementById('btAlignedAvgReturn');
    if (el) {
        el.textContent = 'Avg: ' + (results.alignedAvgReturn >= 0 ? '+' : '') + results.alignedAvgReturn + '%';
        el.style.color = results.alignedAvgReturn >= 0 ? '#22c55e' : '#ef4444';
    }

    // Conflict stats
    el = document.getElementById('btConflictGann');
    if (el) {
        el.textContent = 'Gann: ' + results.conflictGannWinRate + '%';
        el.style.color = results.conflictGannWinRate >= 50 ? '#22c55e' : '#ef4444';
    }
    el = document.getElementById('btConflictMkt');
    if (el) {
        el.textContent = 'Mkt: ' + results.conflictMktWinRate + '%';
        el.style.color = results.conflictMktWinRate >= 50 ? '#22c55e' : '#ef4444';
    }
    var conflictCount = results.conflict.gannWins + results.conflict.gannLosses;
    el = document.getElementById('btConflictCount');
    if (el) el.textContent = conflictCount + ' conflict days';

    // Generate insights
    var insights = [];
    if (parseFloat(results.mktWinRate) > parseFloat(results.gannWinRate)) {
        insights.push(' Market Conditions outperformed Gann by ' + (results.mktWinRate - results.gannWinRate).toFixed(1) + '%');
    } else {
        insights.push(' Gann Analysis outperformed Market by ' + (results.gannWinRate - results.mktWinRate).toFixed(1) + '%');
    }

    if (parseFloat(results.alignedWinRate) > parseFloat(results.gannWinRate) && parseFloat(results.alignedWinRate) > parseFloat(results.mktWinRate)) {
        insights.push(' Aligned signals have highest accuracy - wait for agreement!');
    }

    if (parseFloat(results.conflictMktWinRate) > parseFloat(results.conflictGannWinRate)) {
        insights.push(' During conflicts, Market Conditions more reliable');
    } else if (parseFloat(results.conflictGannWinRate) > parseFloat(results.conflictMktWinRate)) {
        insights.push(' During conflicts, Gann Analysis more reliable');
    }

    var alignedCount = results.aligned.wins + results.aligned.losses;
    var totalCount = results.daily.length;
    var alignedPct = totalCount > 0 ? Math.round(alignedCount / totalCount * 100) : 0;
    insights.push(' Systems agreed ' + alignedPct + '% of the time (' + alignedCount + '/' + totalCount + ' days)');

    el = document.getElementById('btInsights');
    if (el) {
        el.innerHTML = insights.map(function(insight) {
            return '<div style="padding: 8px; background: #f8f9fa; border-radius: 4px; margin-bottom: 6px;">' + insight + '</div>';
        }).join('');
    }

    console.log('Backtest display updated');
}

// ==========================================
// PREDICTION LOGGER - SAVE & VERIFY
// ==========================================

// Get predictions from localStorage
function getPredictionLog() {
    var log = localStorage.getItem('stockAgentPredictionLog');
    return log ? JSON.parse(log) : [];
}

// Save predictions to localStorage
function savePredictionLog(log) {
    localStorage.setItem('stockAgentPredictionLog', JSON.stringify(log));
}

// ==========================================
// AGENT PREDICTION LOGGER
// ==========================================

// Agent Prediction Log (separate from simple Gann/Market)
function getAgentPredictionLog() {
    var log = localStorage.getItem('stockAgentAgentLog');
    return log ? JSON.parse(log) : [];
}

function saveAgentPredictionLog(log) {
    localStorage.setItem('stockAgentAgentLog', JSON.stringify(log));
}

// Save today's agent predictions
function saveAgentPredictions() {
    var symbols = ['SPY', 'QQQ', 'IWM', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];
    var today = new Date().toISOString().split('T')[0];
    var log = getAgentPredictionLog();

    // Check if today already logged
    var todayExists = log.some(function(entry) {
        return entry.date === today && entry.symbol === 'SPY';
    });

    if (todayExists) {
        alert('Today\'s agent predictions already saved!');
        return;
    }

    // Get agent signals from the getAgentSignals function
    var agentData = null;
    if (typeof getAgentSignals === 'function') {
        agentData = getAgentSignals();
    }

    var savedCount = 0;

    for (var s = 0; s < symbols.length; s++) {
        var sym = symbols[s];
        var data = symbolGannData[sym];
        if (!data || !data.price) continue;

        var price = data.price;

        // Get agent signals - use actual agent data if available
        var baseSignal = 'NEUTRAL';
        var gannElliottSignal = 'NEUTRAL';
        var dqnSignal = 'NEUTRAL';
        var waveSignal = 'NEUTRAL';
        var baseConf = 50;
        var gannElliottConf = 50;
        var dqnConf = 50;
        var waveConf = 50;

        // Use real agent data if available (applies to SPY primarily)
        if (agentData && agentData.agentDetails && sym === 'SPY') {
            var details = agentData.agentDetails;
            baseSignal = details.base ? (details.base.signal === 'CALL' ? 'BULLISH' : (details.base.signal === 'PUT' ? 'BEARISH' : 'NEUTRAL')) : 'NEUTRAL';
            gannElliottSignal = details.gann ? (details.gann.signal === 'CALL' ? 'BULLISH' : (details.gann.signal === 'PUT' ? 'BEARISH' : 'NEUTRAL')) : 'NEUTRAL';
            dqnSignal = details.dqn ? (details.dqn.signal === 'CALL' ? 'BULLISH' : (details.dqn.signal === 'PUT' ? 'BEARISH' : 'NEUTRAL')) : 'NEUTRAL';
            waveSignal = details.wave ? (details.wave.signal === 'CALL' ? 'BULLISH' : (details.wave.signal === 'PUT' ? 'BEARISH' : 'NEUTRAL')) : 'NEUTRAL';
            baseConf = details.base ? details.base.confidence : 50;
            gannElliottConf = details.gann ? details.gann.confidence : 50;
            dqnConf = details.dqn ? details.dqn.confidence : 50;
            waveConf = details.wave ? details.wave.confidence : 50;
        } else {
            // For non-SPY symbols, calculate based on Gann position and price data
            var gannPct = data.gannPct || 50;
            var aboveMA = data.price > data.ma20;

            // Base Confluence: uses multiple indicators
            baseSignal = aboveMA ? 'BULLISH' : 'BEARISH';
            baseConf = 55 + Math.abs(gannPct - 50) * 0.3;

            // Gann-Elliott: uses Gann range position
            if (gannPct < 30) {
                gannElliottSignal = 'BULLISH'; // Low in range = bullish reversal expected
            } else if (gannPct > 70) {
                gannElliottSignal = 'BEARISH'; // High in range = bearish reversal expected
            } else {
                gannElliottSignal = aboveMA ? 'BULLISH' : 'BEARISH';
            }
            gannElliottConf = 50 + Math.abs(gannPct - 50) * 0.4;

            // DQN: momentum-based
            dqnSignal = aboveMA ? 'BULLISH' : 'BEARISH';
            dqnConf = 55;

            // 3-Wave: trend following
            waveSignal = aboveMA ? 'BULLISH' : 'BEARISH';
            waveConf = 55;
        }

        // Calculate consensus
        var bullishCount = 0;
        var signals = [baseSignal, gannElliottSignal, dqnSignal, waveSignal];
        for (var i = 0; i < signals.length; i++) {
            if (signals[i] === 'BULLISH') bullishCount++;
        }

        var consensusLevel, consensusDirection;
        if (bullishCount === 4) {
            consensusLevel = 'ULTRA';
            consensusDirection = 'BULLISH';
        } else if (bullishCount === 3) {
            consensusLevel = 'SUPER';
            consensusDirection = 'BULLISH';
        } else if (bullishCount === 0) {
            consensusLevel = 'ULTRA';
            consensusDirection = 'BEARISH';
        } else if (bullishCount === 1) {
            consensusLevel = 'SUPER';
            consensusDirection = 'BEARISH';
        } else {
            consensusLevel = 'MIXED';
            consensusDirection = bullishCount >= 2 ? 'BULLISH' : 'BEARISH';
        }

        log.push({
            date: today,
            symbol: sym,
            price: price,
            baseSignal: baseSignal,
            baseConf: baseConf,
            gannElliottSignal: gannElliottSignal,
            gannElliottConf: gannElliottConf,
            dqnSignal: dqnSignal,
            dqnConf: dqnConf,
            waveSignal: waveSignal,
            waveConf: waveConf,
            consensusLevel: consensusLevel,
            consensusDirection: consensusDirection,
            bullishCount: bullishCount,
            nextDayPrice: null,
            actualMove: null,
            baseCorrect: null,
            gannElliottCorrect: null,
            dqnCorrect: null,
            waveCorrect: null,
            consensusCorrect: null,
            verified: false
        });

        savedCount++;
    }

    saveAgentPredictionLog(log);
    updateAgentPredictionDisplay();
    alert('Saved agent predictions for ' + savedCount + ' symbols on ' + today);
}

// Verify agent predictions against actual price movement
function verifyAgentPredictions() {
    var log = getAgentPredictionLog();
    var verifiedCount = 0;

    for (var i = 0; i < log.length; i++) {
        var entry = log[i];
        if (entry.verified) continue;

        var sym = entry.symbol;
        var data = allSymbolsData[sym];
        if (!data || data.length < 2) continue;

        // Find entry date in data
        var entryIndex = -1;
        for (var j = 0; j < data.length; j++) {
            var csvDate = parseCSVDate(data[j].Date);
            if (!csvDate) continue;
            var csvDateStr = csvDate.toISOString().split('T')[0];
            if (csvDateStr === entry.date) {
                entryIndex = j;
                break;
            }
        }

        if (entryIndex === -1 || entryIndex >= data.length - 1) continue;

        var nextDayPrice = parseFloat(data[entryIndex + 1].Close);
        if (!nextDayPrice) continue;

        var actualMove = ((nextDayPrice - entry.price) / entry.price * 100);
        var moveUp = nextDayPrice > entry.price;

        entry.nextDayPrice = nextDayPrice;
        entry.actualMove = parseFloat(actualMove.toFixed(2));

        // Check each agent (BULLISH expects up, BEARISH expects down, NEUTRAL is always "correct")
        entry.baseCorrect = entry.baseSignal === 'NEUTRAL' || (entry.baseSignal === 'BULLISH' && moveUp) || (entry.baseSignal === 'BEARISH' && !moveUp);
        entry.gannElliottCorrect = entry.gannElliottSignal === 'NEUTRAL' || (entry.gannElliottSignal === 'BULLISH' && moveUp) || (entry.gannElliottSignal === 'BEARISH' && !moveUp);
        entry.dqnCorrect = entry.dqnSignal === 'NEUTRAL' || (entry.dqnSignal === 'BULLISH' && moveUp) || (entry.dqnSignal === 'BEARISH' && !moveUp);
        entry.waveCorrect = entry.waveSignal === 'NEUTRAL' || (entry.waveSignal === 'BULLISH' && moveUp) || (entry.waveSignal === 'BEARISH' && !moveUp);
        entry.consensusCorrect = (entry.consensusDirection === 'BULLISH' && moveUp) || (entry.consensusDirection === 'BEARISH' && !moveUp);

        entry.verified = true;
        verifiedCount++;
    }

    saveAgentPredictionLog(log);
    updateAgentPredictionDisplay();
    alert('Verified ' + verifiedCount + ' agent predictions!');
}

// Display agent prediction stats
function updateAgentPredictionDisplay() {
    var log = getAgentPredictionLog();

    var stats = {
        base: { wins: 0, total: 0 },
        gannElliott: { wins: 0, total: 0 },
        dqn: { wins: 0, total: 0 },
        wave: { wins: 0, total: 0 },
        ultra: { wins: 0, total: 0 },
        superLevel: { wins: 0, total: 0 },
        mixed: { wins: 0, total: 0 }
    };

    for (var i = 0; i < log.length; i++) {
        var entry = log[i];

        // Support both compact format (b,g,q,w,c,l,n,dn) and old format
        var isCompact = entry.hasOwnProperty('b');

        if (isCompact) {
            // Compact format
            if (!entry.n) { stats.base.total++; if (entry.b) stats.base.wins++; }
            stats.gannElliott.total++; if (entry.g) stats.gannElliott.wins++;
            if (!entry.dn) { stats.dqn.total++; if (entry.q) stats.dqn.wins++; }
            stats.wave.total++; if (entry.w) stats.wave.wins++;
            if (entry.l === 'U') { stats.ultra.total++; if (entry.c) stats.ultra.wins++; }
            else if (entry.l === 'S') { stats.superLevel.total++; if (entry.c) stats.superLevel.wins++; }
            else { stats.mixed.total++; if (entry.c) stats.mixed.wins++; }
        } else {
            // Old format (backwards compatible)
            if (!entry.verified) continue;
            if (entry.baseSignal !== 'NEUTRAL') {
                stats.base.total++;
                if (entry.baseCorrect) stats.base.wins++;
            }
            if (entry.gannElliottSignal !== 'NEUTRAL') {
                stats.gannElliott.total++;
                if (entry.gannElliottCorrect) stats.gannElliott.wins++;
            }
            if (entry.dqnSignal !== 'NEUTRAL') {
                stats.dqn.total++;
                if (entry.dqnCorrect) stats.dqn.wins++;
            }
            if (entry.waveSignal !== 'NEUTRAL') {
                stats.wave.total++;
                if (entry.waveCorrect) stats.wave.wins++;
            }
            if (entry.consensusLevel === 'ULTRA') {
                stats.ultra.total++;
                if (entry.consensusCorrect) stats.ultra.wins++;
            } else if (entry.consensusLevel === 'SUPER') {
                stats.superLevel.total++;
                if (entry.consensusCorrect) stats.superLevel.wins++;
            } else {
                stats.mixed.total++;
                if (entry.consensusCorrect) stats.mixed.wins++;
            }
        }
    }

    // Calculate percentages
    var basePct = stats.base.total > 0 ? Math.round(stats.base.wins / stats.base.total * 100) : 0;
    var gannElliottPct = stats.gannElliott.total > 0 ? Math.round(stats.gannElliott.wins / stats.gannElliott.total * 100) : 0;
    var dqnPct = stats.dqn.total > 0 ? Math.round(stats.dqn.wins / stats.dqn.total * 100) : 0;
    var wavePct = stats.wave.total > 0 ? Math.round(stats.wave.wins / stats.wave.total * 100) : 0;
    var ultraPct = stats.ultra.total > 0 ? Math.round(stats.ultra.wins / stats.ultra.total * 100) : 0;
    var superPct = stats.superLevel.total > 0 ? Math.round(stats.superLevel.wins / stats.superLevel.total * 100) : 0;
    var mixedPct = stats.mixed.total > 0 ? Math.round(stats.mixed.wins / stats.mixed.total * 100) : 0;

    // Update display elements
    var el;
    el = document.getElementById('agentBaseAccuracy');
    if (el) el.textContent = stats.base.total > 0 ? basePct + '%' : '--%';
    el = document.getElementById('agentGannElliottAccuracy');
    if (el) el.textContent = stats.gannElliott.total > 0 ? gannElliottPct + '%' : '--%';
    el = document.getElementById('agentDqnAccuracy');
    if (el) el.textContent = stats.dqn.total > 0 ? dqnPct + '%' : '--%';
    el = document.getElementById('agentWaveAccuracy');
    if (el) el.textContent = stats.wave.total > 0 ? wavePct + '%' : '--%';
    el = document.getElementById('agentUltraAccuracy');
    if (el) el.textContent = stats.ultra.total > 0 ? ultraPct + '% (' + stats.ultra.wins + '/' + stats.ultra.total + ')' : '--% (0/0)';
    el = document.getElementById('agentSuperAccuracy');
    if (el) el.textContent = stats.superLevel.total > 0 ? superPct + '% (' + stats.superLevel.wins + '/' + stats.superLevel.total + ')' : '--% (0/0)';
    el = document.getElementById('agentMixedAccuracy');
    if (el) el.textContent = stats.mixed.total > 0 ? mixedPct + '% (' + stats.mixed.wins + '/' + stats.mixed.total + ')' : '--% (0/0)';
    el = document.getElementById('agentTotalLogged');
    if (el) el.textContent = log.length;

    console.log('Agent prediction stats:', { basePct: basePct, gannElliottPct: gannElliottPct, dqnPct: dqnPct, wavePct: wavePct, ultraPct: ultraPct, superPct: superPct, mixedPct: mixedPct });
}

// Auto-save predictions (silent, no alerts)
function autoSavePredictions() {
    var today = new Date();
    var dayOfWeek = today.getDay();

    // Skip weekends (0 = Sunday, 6 = Saturday)
    if (dayOfWeek === 0 || dayOfWeek === 6) {
        console.log('Auto-save skipped: Weekend');
        return;
    }

    var todayStr = today.toISOString().split('T')[0];

    // Check if simple predictions already saved
    var simpleLog = getPredictionLog();
    var simpleExists = simpleLog.some(function(entry) {
        return entry.date === todayStr && entry.symbol === 'SPY';
    });

    // Check if agent predictions already saved
    var agentLog = getAgentPredictionLog();
    var agentExists = agentLog.some(function(entry) {
        return entry.date === todayStr && entry.symbol === 'SPY';
    });

    var savedSimple = false;
    var savedAgent = false;

    // Auto-save simple predictions (Gann/Market)
    if (!simpleExists) {
        var symbols = ['SPY', 'QQQ', 'IWM', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];
        var savedCount = 0;

        for (var s = 0; s < symbols.length; s++) {
            var sym = symbols[s];
            var data = symbolGannData[sym];
            if (!data || !data.price) continue;

            var gannPred = 'HOLD';
            var gannPct = data.gannPct || 50;

            if (gannPct < 35) {
                gannPred = invertGannSignal ? 'PUT' : 'CALL';
            } else if (gannPct > 65) {
                gannPred = invertGannSignal ? 'CALL' : 'PUT';
            }

            var mktPred = data.price > data.ma20 ? 'CALL' : 'PUT';
            var aligned = (gannPred === mktPred) || gannPred === 'HOLD';

            simpleLog.push({
                date: todayStr,
                symbol: sym,
                price: data.price,
                gannPct: gannPct,
                ma20: data.ma20,
                gannPred: gannPred,
                mktPred: mktPred,
                aligned: aligned,
                nextDayPrice: null,
                actualMove: null,
                gannCorrect: null,
                mktCorrect: null,
                verified: false
            });
            savedCount++;
        }

        if (savedCount > 0) {
            savePredictionLog(simpleLog);
            savedSimple = true;
            console.log('Auto-saved simple predictions for ' + savedCount + ' symbols');
        }
    }

    // Auto-save agent predictions
    if (!agentExists) {
        var symbols = ['SPY', 'QQQ', 'IWM', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];
        var agentData = null;
        if (typeof getAgentSignals === 'function') {
            agentData = getAgentSignals();
        }

        var savedCount = 0;

        for (var s = 0; s < symbols.length; s++) {
            var sym = symbols[s];
            var data = symbolGannData[sym];
            if (!data || !data.price) continue;

            var price = data.price;
            var baseSignal = 'NEUTRAL';
            var gannElliottSignal = 'NEUTRAL';
            var dqnSignal = 'NEUTRAL';
            var waveSignal = 'NEUTRAL';
            var baseConf = 50, gannElliottConf = 50, dqnConf = 50, waveConf = 50;

            if (agentData && agentData.agentDetails && sym === 'SPY') {
                var details = agentData.agentDetails;
                baseSignal = details.base ? (details.base.signal === 'CALL' ? 'BULLISH' : (details.base.signal === 'PUT' ? 'BEARISH' : 'NEUTRAL')) : 'NEUTRAL';
                gannElliottSignal = details.gann ? (details.gann.signal === 'CALL' ? 'BULLISH' : (details.gann.signal === 'PUT' ? 'BEARISH' : 'NEUTRAL')) : 'NEUTRAL';
                dqnSignal = details.dqn ? (details.dqn.signal === 'CALL' ? 'BULLISH' : (details.dqn.signal === 'PUT' ? 'BEARISH' : 'NEUTRAL')) : 'NEUTRAL';
                waveSignal = details.wave ? (details.wave.signal === 'CALL' ? 'BULLISH' : (details.wave.signal === 'PUT' ? 'BEARISH' : 'NEUTRAL')) : 'NEUTRAL';
                baseConf = details.base ? details.base.confidence : 50;
                gannElliottConf = details.gann ? details.gann.confidence : 50;
                dqnConf = details.dqn ? details.dqn.confidence : 50;
                waveConf = details.wave ? details.wave.confidence : 50;
            } else {
                var gannPct = data.gannPct || 50;
                var aboveMA = data.price > data.ma20;

                baseSignal = aboveMA ? 'BULLISH' : 'BEARISH';
                baseConf = 55 + Math.abs(gannPct - 50) * 0.3;

                if (gannPct < 30) {
                    gannElliottSignal = 'BULLISH';
                } else if (gannPct > 70) {
                    gannElliottSignal = 'BEARISH';
                } else {
                    gannElliottSignal = aboveMA ? 'BULLISH' : 'BEARISH';
                }
                gannElliottConf = 50 + Math.abs(gannPct - 50) * 0.4;

                dqnSignal = aboveMA ? 'BULLISH' : 'BEARISH';
                dqnConf = 55;

                waveSignal = aboveMA ? 'BULLISH' : 'BEARISH';
                waveConf = 55;
            }

            var bullishCount = 0;
            var signals = [baseSignal, gannElliottSignal, dqnSignal, waveSignal];
            for (var i = 0; i < signals.length; i++) {
                if (signals[i] === 'BULLISH') bullishCount++;
            }

            var consensusLevel, consensusDirection;
            if (bullishCount === 4) {
                consensusLevel = 'ULTRA';
                consensusDirection = 'BULLISH';
            } else if (bullishCount === 3) {
                consensusLevel = 'SUPER';
                consensusDirection = 'BULLISH';
            } else if (bullishCount === 0) {
                consensusLevel = 'ULTRA';
                consensusDirection = 'BEARISH';
            } else if (bullishCount === 1) {
                consensusLevel = 'SUPER';
                consensusDirection = 'BEARISH';
            } else {
                consensusLevel = 'MIXED';
                consensusDirection = bullishCount >= 2 ? 'BULLISH' : 'BEARISH';
            }

            agentLog.push({
                date: todayStr,
                symbol: sym,
                price: price,
                baseSignal: baseSignal,
                baseConf: baseConf,
                gannElliottSignal: gannElliottSignal,
                gannElliottConf: gannElliottConf,
                dqnSignal: dqnSignal,
                dqnConf: dqnConf,
                waveSignal: waveSignal,
                waveConf: waveConf,
                consensusLevel: consensusLevel,
                consensusDirection: consensusDirection,
                bullishCount: bullishCount,
                nextDayPrice: null,
                actualMove: null,
                baseCorrect: null,
                gannElliottCorrect: null,
                dqnCorrect: null,
                waveCorrect: null,
                consensusCorrect: null,
                verified: false
            });
            savedCount++;
        }

        if (savedCount > 0) {
            saveAgentPredictionLog(agentLog);
            savedAgent = true;
            console.log('Auto-saved agent predictions for ' + savedCount + ' symbols');
        }
    }

    // Update displays
    if (savedSimple && typeof updatePredictionLogDisplay === 'function') {
        updatePredictionLogDisplay();
    }
    if (savedAgent && typeof updateAgentPredictionDisplay === 'function') {
        updateAgentPredictionDisplay();
    }

    if (savedSimple || savedAgent) {
        console.log(' Auto-save complete: ' + todayStr);
    } else {
        console.log('Auto-save: Predictions already exist for ' + todayStr);
    }
}

// Calculate SQ9 Prediction based on pivot levels
function getSq9Prediction(symbol, currentPrice) {
    // Get pivot data
    var pivot = (typeof sq9PivotData !== 'undefined' && sq9PivotData[symbol]) ||
                (typeof sq9ExtendedPivots !== 'undefined' && sq9ExtendedPivots[symbol]);

    if (!pivot || !pivot.price || !currentPrice) {
        return { pred: 'HOLD', level: null, type: null, distance: null };
    }

    // Calculate SQ9 levels from pivot
    var levels = typeof calcSq9LevelsFromPivot === 'function' ? calcSq9LevelsFromPivot(pivot.price, currentPrice) : null;
    if (!levels) {
        return { pred: 'HOLD', level: null, type: null, distance: null };
    }

    // Find nearest level
    var nearest = typeof findNearestSq9Level === 'function' ? findNearestSq9Level(levels, currentPrice) : null;
    if (!nearest) {
        return { pred: 'HOLD', level: null, type: null, distance: null };
    }

    var distPct = Math.abs(nearest.distance);
    var sq9Type = nearest.type; // 'support' or 'resist'

    // SQ9 Prediction Logic:
    // At support (within 3%) = CALL (expect bounce)
    // At resistance (within 3%) = PUT (expect rejection)
    // Far from level = HOLD
    var sq9Pred = 'HOLD';
    if (distPct <= 3.0) {
        if (sq9Type === 'support') {
            sq9Pred = 'CALL'; // At support, expect bounce up
        } else {
            sq9Pred = 'PUT'; // At resistance, expect rejection down
        }
    }

    return {
        pred: sq9Pred,
        level: nearest.price,
        type: sq9Type,
        distance: nearest.distance
    };
}

// Save today's predictions for all symbols
function saveTodaysPrediction() {
    var symbols = ['SPY', 'QQQ', 'IWM', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];
    var today = new Date().toISOString().split('T')[0];
    var log = getPredictionLog();

    // Check if today already logged
    var todayExists = log.some(function(entry) {
        return entry.date === today && entry.symbol === 'SPY';
    });

    if (todayExists) {
        alert('Today\'s predictions already saved! Use "Verify Past Predictions" to update results.');
        return;
    }

    var savedCount = 0;

    for (var s = 0; s < symbols.length; s++) {
        var sym = symbols[s];
        var data = allSymbolsData[sym];
        if (!data || data.length < 21) continue;

        var price = symbolGannData[sym] ? symbolGannData[sym].price : parseFloat(data[data.length - 1].Close);
        if (!price) continue;

        // Calculate 20-day high/low for Gann
        var high20 = 0, low20 = 999999;
        for (var j = data.length - 21; j < data.length - 1; j++) {
            var h = parseFloat(data[j].High) || 0;
            var l = parseFloat(data[j].Low) || 0;
            if (h > high20) high20 = h;
            if (l < low20 && l > 0) low20 = l;
        }

        // Calculate 20MA for Market
        var sum20 = 0;
        for (var j = data.length - 20; j < data.length; j++) {
            sum20 += parseFloat(data[j].Close) || 0;
        }
        var ma20 = sum20 / 20;

        // GANN Prediction
        var range = high20 - low20;
        var position = range > 0 ? (price - low20) / range : 0.5;
        var gannPred = position < 0.35 ? 'CALL' : (position > 0.65 ? 'PUT' : 'HOLD');

        // MARKET Prediction
        var mktPred = price > ma20 ? 'CALL' : 'PUT';

        // SQ9 Prediction
        var sq9Result = getSq9Prediction(sym, price);
        var sq9Pred = sq9Result.pred;

        var aligned = gannPred === mktPred || gannPred === 'HOLD';

        log.push({
            date: today,
            symbol: sym,
            price: price,
            gannPred: gannPred,
            sq9Pred: sq9Pred,
            sq9Level: sq9Result.level,
            sq9Type: sq9Result.type,
            mktPred: mktPred,
            aligned: aligned,
            nextDayPrice: null,
            actualMove: null,
            gannCorrect: null,
            sq9Correct: null,
            mktCorrect: null,
            verified: false
        });

        savedCount++;
    }

    savePredictionLog(log);
    updatePredictionLogDisplay();
    alert('Saved predictions for ' + savedCount + ' symbols on ' + today);
}

// Verify past predictions with actual results
function verifyPastPredictions() {
    var log = getPredictionLog();
    var verifiedCount = 0;
    var skippedCount = 0;
    var errors = [];

    console.log('Starting verification for ' + log.length + ' predictions...');

    for (var i = 0; i < log.length; i++) {
        var entry = log[i];

        // Skip already verified
        if (entry.verified) {
            console.log('Skipping ' + entry.symbol + ' ' + entry.date + ' - already verified');
            continue;
        }

        var sym = entry.symbol;
        var data = allSymbolsData[sym];

        if (!data || data.length < 2) {
            errors.push(sym + ': No data loaded');
            skippedCount++;
            continue;
        }

        // Find the entry date in data
        var entryIndex = -1;
        var entryDateClean = entry.date ? entry.date.split(' ')[0].split('T')[0] : '';

        // Debug: show what we're looking for
        console.log('Looking for date:', entryDateClean, 'in', sym, 'data');
        console.log('Sample CSV dates:', data.slice(-5).map(function(d) { return d.Date; }));

        for (var j = 0; j < data.length; j++) {
            var csvDate = data[j].Date;
            // Handle different date formats - extract just YYYY-MM-DD part
            var csvDateClean = csvDate ? csvDate.split(' ')[0].split('T')[0] : '';

            if (csvDateClean === entryDateClean) {
                entryIndex = j;
                console.log('Found match at index', j, '- CSV date:', csvDate, '-> cleaned:', csvDateClean);
                break;
            }
        }

        if (entryIndex === -1) {
            // Debug: show first and last CSV dates
            var firstDate = data[0].Date ? data[0].Date.split(' ')[0] : 'unknown';
            var lastDate = data[data.length-1].Date ? data[data.length-1].Date.split(' ')[0] : 'unknown';
            console.log('Date NOT found! Entry:', entryDateClean, 'CSV range:', firstDate, 'to', lastDate);
            errors.push(sym + ' ' + entry.date + ': Date not found (CSV: ' + firstDate + ' to ' + lastDate + ')');
            skippedCount++;
            continue;
        }

        // Need at least next day's data
        if (entryIndex >= data.length - 1) {
            errors.push(sym + ' ' + entry.date + ': No next-day data yet');
            skippedCount++;
            continue;
        }

        var nextDayData = data[entryIndex + 1];
        var nextDayPrice = parseFloat(nextDayData.Close);

        if (!nextDayPrice || isNaN(nextDayPrice)) {
            errors.push(sym + ' ' + entry.date + ': Invalid next-day price');
            skippedCount++;
            continue;
        }

        var entryPrice = parseFloat(entry.price);
        var actualMove = ((nextDayPrice - entryPrice) / entryPrice * 100);
        var moveUp = nextDayPrice > entryPrice;

        entry.nextDayPrice = nextDayPrice;
        entry.actualMove = parseFloat(actualMove.toFixed(2));

        // Check if predictions were correct
        if (entry.gannPred === 'HOLD') {
            entry.gannCorrect = true; // HOLD is always "correct"
        } else {
            entry.gannCorrect = (entry.gannPred === 'CALL' && moveUp) || (entry.gannPred === 'PUT' && !moveUp);
        }
        entry.mktCorrect = (entry.mktPred === 'CALL' && moveUp) || (entry.mktPred === 'PUT' && !moveUp);

        // Check SQ9 prediction if it exists
        if (entry.sq9Pred && entry.sq9Pred !== 'HOLD') {
            entry.sq9Correct = (entry.sq9Pred === 'CALL' && moveUp) || (entry.sq9Pred === 'PUT' && !moveUp);
        } else if (entry.sq9Pred === 'HOLD') {
            entry.sq9Correct = true; // HOLD is always "correct"
        } else {
            entry.sq9Correct = null; // No SQ9 prediction made
        }

        entry.verified = true;

        console.log('Verified ' + sym + ' ' + entry.date + ': ' +
            'Gann=' + entry.gannPred + (entry.gannCorrect ? '' : '') + ', ' +
            'SQ9=' + (entry.sq9Pred || 'N/A') + (entry.sq9Correct === null ? '' : (entry.sq9Correct ? '' : '')) + ', ' +
            'Mkt=' + entry.mktPred + (entry.mktCorrect ? '' : '') + ', ' +
            'Move=' + entry.actualMove.toFixed(2) + '%');

        verifiedCount++;
    }

    savePredictionLog(log);
    updatePredictionLogDisplay();

    var message = 'Verified: ' + verifiedCount + ' predictions\n';
    if (skippedCount > 0) {
        message += 'Skipped: ' + skippedCount + ' (no next-day data yet)\n';
    }
    if (errors.length > 0 && errors.length <= 5) {
        message += '\nDetails:\n' + errors.join('\n');
    } else if (errors.length > 5) {
        message += '\nFirst 5 issues:\n' + errors.slice(0, 5).join('\n');
    }

    alert(message);
    console.log('Verification complete. Errors:', errors);
}

// Clear prediction log
function clearPredictionLog() {
    if (confirm('Are you sure you want to clear all prediction history? This cannot be undone.')) {
        localStorage.removeItem('stockAgentPredictionLog');
        updatePredictionLogDisplay();
        alert('Prediction log cleared.');
    }
}

// Clear and re-backfill predictions
function clearAndBackfill(startDate) {
    var dateStr = startDate || '2023-01-03';
    if (confirm('This will clear ALL prediction history and backfill from ' + dateStr + '. This may take a moment. Continue?')) {
        localStorage.removeItem('stockAgentPredictionLog');
        backfillPredictions(dateStr);
    }
}

// Backfill historical predictions from a start date
function backfillPredictions(startDateStr) {
    var startDate = new Date(startDateStr || '2025-11-01');
    var today = new Date();
    var symbols = ['SPY', 'QQQ', 'IWM', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];

    // Show loading indicator
    var loadingDiv = document.createElement('div');
    loadingDiv.id = 'backfillLoading';
    loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 9999; text-align: center;';
    loadingDiv.innerHTML = '<div style="font-size: 24px; margin-bottom: 10px;"></div><div style="font-size: 14px; font-weight: 600;">Backfilling predictions...</div><div id="backfillProgress" style="font-size: 12px; color: #666; margin-top: 10px;">Starting from ' + startDateStr + '</div>';
    document.body.appendChild(loadingDiv);

    var log = getPredictionLog();
    var addedCount = 0;
    var verifiedCount = 0;

    console.log('Backfilling predictions from ' + startDateStr + '...');

    for (var s = 0; s < symbols.length; s++) {
        var sym = symbols[s];
        var data = allSymbolsData[sym];

        if (!data || data.length < 25) {
            console.log(sym + ': Not enough data');
            continue;
        }

        // Find start index (need 20 days before for MA calculation)
        var startIndex = -1;
        for (var i = 20; i < data.length; i++) {
            var rowDateStr = data[i].Date ? data[i].Date.split(' ')[0].split('T')[0] : '';
            var rowDate = new Date(rowDateStr);
            if (rowDate >= startDate) {
                startIndex = i;
                break;
            }
        }

        if (startIndex === -1) {
            console.log(sym + ': Start date not found in data');
            continue;
        }

        // Process each day from start to yesterday (need next day to verify)
        for (var i = startIndex; i < data.length - 1; i++) {
            var row = data[i];
            var nextRow = data[i + 1];
            var dateStr = row.Date ? row.Date.split(' ')[0].split('T')[0] : '';

            // Skip if already in log
            var exists = log.some(function(entry) {
                return entry.date === dateStr && entry.symbol === sym;
            });
            if (exists) continue;

            var price = parseFloat(row.Close);
            var nextPrice = parseFloat(nextRow.Close);
            if (!price || !nextPrice) continue;

            // Calculate 20-day high/low for Gann
            var high20 = 0, low20 = 999999;
            for (var j = i - 20; j < i; j++) {
                var h = parseFloat(data[j].High) || 0;
                var l = parseFloat(data[j].Low) || 0;
                if (h > high20) high20 = h;
                if (l < low20 && l > 0) low20 = l;
            }

            // Calculate 20MA for Market
            var sum20 = 0;
            for (var j = i - 19; j <= i; j++) {
                sum20 += parseFloat(data[j].Close) || 0;
            }
            var ma20 = sum20 / 20;

            // GANN Prediction (mean reversion)
            var range = high20 - low20;
            var position = range > 0 ? (price - low20) / range : 0.5;
            var gannPred = position < 0.35 ? 'CALL' : (position > 0.65 ? 'PUT' : 'HOLD');

            // MARKET Prediction (trend following)
            var mktPred = price > ma20 ? 'CALL' : 'PUT';

            var aligned = gannPred === mktPred || gannPred === 'HOLD';

            // Calculate actual result
            var actualMove = ((nextPrice - price) / price * 100);
            var moveUp = nextPrice > price;

            var gannCorrect;
            if (gannPred === 'HOLD') {
                gannCorrect = true;
            } else {
                gannCorrect = (gannPred === 'CALL' && moveUp) || (gannPred === 'PUT' && !moveUp);
            }
            var mktCorrect = (mktPred === 'CALL' && moveUp) || (mktPred === 'PUT' && !moveUp);

            // Add to log
            log.push({
                date: dateStr,
                symbol: sym,
                price: price,
                gannPred: gannPred,
                mktPred: mktPred,
                aligned: aligned,
                nextDayPrice: nextPrice,
                actualMove: parseFloat(actualMove.toFixed(2)),
                gannCorrect: gannCorrect,
                mktCorrect: mktCorrect,
                verified: true,
                backfilled: true
            });

            addedCount++;
            if (gannPred !== 'HOLD') verifiedCount++;
        }
    }

    // Save and update display
    savePredictionLog(log);
    updatePredictionLogDisplay();
    if (typeof renderAccuracyChart === 'function') {
        renderAccuracyChart();
    }

    // Calculate summary stats
    var gannWins = 0, gannTotal = 0;
    var mktWins = 0, mktTotal = 0;
    var alignedWins = 0, alignedTotal = 0;

    for (var i = 0; i < log.length; i++) {
        var entry = log[i];
        if (!entry.verified) continue;

        if (entry.gannPred !== 'HOLD') {
            gannTotal++;
            if (entry.gannCorrect) gannWins++;
        }
        mktTotal++;
        if (entry.mktCorrect) mktWins++;

        if (entry.aligned && entry.gannPred !== 'HOLD') {
            alignedTotal++;
            if (entry.gannCorrect && entry.mktCorrect) alignedWins++;
        }
    }

    var gannPct = gannTotal > 0 ? Math.round(gannWins / gannTotal * 100) : 0;
    var mktPct = mktTotal > 0 ? Math.round(mktWins / mktTotal * 100) : 0;
    var alignedPct = alignedTotal > 0 ? Math.round(alignedWins / alignedTotal * 100) : 0;

    var message = 'BACKFILL COMPLETE!\n\n' +
        'Added: ' + addedCount + ' predictions\n' +
        'Total in log: ' + log.length + '\n\n' +
        'RESULTS:\n' +
        ' Gann Accuracy: ' + gannPct + '% (' + gannWins + '/' + gannTotal + ')\n' +
        ' Market Accuracy: ' + mktPct + '% (' + mktWins + '/' + mktTotal + ')\n' +
        ' Aligned Accuracy: ' + alignedPct + '% (' + alignedWins + '/' + alignedTotal + ')\n\n' +
        'Leader: ' + (mktPct > gannPct ? ' MARKET' : ' GANN') + ' by ' + Math.abs(mktPct - gannPct) + '%';

    // Remove loading indicator
    var loadingEl = document.getElementById('backfillLoading');
    if (loadingEl) loadingEl.remove();

    alert(message);
    console.log('Backfill complete:', { added: addedCount, gannPct: gannPct, mktPct: mktPct, alignedPct: alignedPct });

    return { gannPct: gannPct, mktPct: mktPct, alignedPct: alignedPct, total: log.length };
}

// Backfill agent predictions for 2 years
function backfillAgentPredictions(startDateStr) {
    var startDate = new Date(startDateStr || '2023-01-03');
    var symbols = ['SPY', 'QQQ', 'IWM', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];

    // Show loading indicator
    var loadingDiv = document.createElement('div');
    loadingDiv.id = 'agentBackfillLoading';
    loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 9999; text-align: center;';
    loadingDiv.innerHTML = '<div style="font-size: 24px; margin-bottom: 10px;"></div><div id="backfillStatus" style="font-size: 14px; font-weight: 600;">Backfilling Agent Predictions...</div><div id="backfillProgress" style="font-size: 12px; color: #666; margin-top: 10px;">Starting from ' + startDateStr + '</div>';
    document.body.appendChild(loadingDiv);

    var log = [];
    var addedCount = 0;
    var symbolIndex = 0;

    console.log('Backfilling agent predictions from ' + startDateStr + '...');

    function updateProgress(msg) {
        var el = document.getElementById('backfillProgress');
        if (el) el.textContent = msg;
    }

    function processNextSymbol() {
        try {
            if (symbolIndex >= symbols.length) {
                finishBackfill();
                return;
            }

            var sym = symbols[symbolIndex];
            updateProgress('Processing ' + sym + ' (' + (symbolIndex + 1) + '/' + symbols.length + ')...');

            var data = allSymbolsData[sym];

            if (!data || data.length < 25) {
                console.log(sym + ': Not enough data (' + (data ? data.length : 0) + ' rows)');
                symbolIndex++;
                setTimeout(processNextSymbol, 10);
                return;
            }

            var startIndex = -1;
            for (var i = 20; i < data.length; i++) {
                var rowDateStr = data[i].Date ? data[i].Date.split(' ')[0].split('T')[0] : '';
                var rowDate = new Date(rowDateStr);
                if (rowDate >= startDate) {
                    startIndex = i;
                    break;
                }
            }

            if (startIndex === -1) {
                console.log(sym + ': No data after start date');
                symbolIndex++;
                setTimeout(processNextSymbol, 10);
                return;
            }

            console.log(sym + ': Processing from index ' + startIndex + ' to ' + (data.length - 1));

            for (var i = startIndex; i < data.length - 1; i++) {
                var row = data[i];
                var nextRow = data[i + 1];
                var dateStr = row.Date ? row.Date.split(' ')[0].split('T')[0] : '';

                var price = parseFloat(row.Close);
                var nextPrice = parseFloat(nextRow.Close);
                if (!price || !nextPrice) continue;

                // Calculate indicators
                var high20 = 0, low20 = 999999;
                for (var j = i - 20; j < i; j++) {
                    var h = parseFloat(data[j].High) || 0;
                    var l = parseFloat(data[j].Low) || 0;
                    if (h > high20) high20 = h;
                    if (l < low20 && l > 0) low20 = l;
                }

                var sum20 = 0;
                for (var j = i - 19; j <= i; j++) {
                    sum20 += parseFloat(data[j].Close) || 0;
                }
                var ma20 = sum20 / 20;

                var closes5 = [];
                for (var j = i - 4; j <= i; j++) {
                    closes5.push(parseFloat(data[j].Close) || 0);
                }
                var trend5 = closes5[4] > closes5[0];
                var momentum = closes5[0] > 0 ? (closes5[4] - closes5[0]) / closes5[0] : 0;

                var range = high20 - low20;
                var gannPct = range > 0 ? ((price - low20) / range) * 100 : 50;
                var aboveMA = price > ma20;

                // Agent signals
                var baseSignal = (trend5 && momentum > 0) ? 'BULLISH' : ((!trend5 && momentum < 0) ? 'BEARISH' : 'NEUTRAL');
                var gannElliottSignal = (gannPct < 30) ? 'BULLISH' : ((gannPct > 70) ? 'BEARISH' : (aboveMA ? 'BULLISH' : 'BEARISH'));
                var dqnSignal = (momentum > 0.005) ? 'BULLISH' : ((momentum < -0.005) ? 'BEARISH' : 'NEUTRAL');
                var waveSignal = trend5 ? 'BULLISH' : 'BEARISH';

                var bullishCount = [baseSignal, gannElliottSignal, dqnSignal, waveSignal].filter(function(s) { return s === 'BULLISH'; }).length;

                var consensusLevel = (bullishCount === 4 || bullishCount === 0) ? 'ULTRA' : ((bullishCount === 3 || bullishCount === 1) ? 'SUPER' : 'MIXED');
                var consensusDirection = bullishCount >= 2 ? 'BULLISH' : 'BEARISH';

                var moveUp = nextPrice > price;

                // Compact storage: d=date, s=symbol, b=baseCorrect, g=gannCorrect, q=dqnCorrect, w=waveCorrect, c=consensusCorrect, l=level(U/S/M), n=baseNeutral, dn=dqnNeutral
                var baseNeutral = baseSignal === 'NEUTRAL';
                var dqnNeutral = dqnSignal === 'NEUTRAL';
                log.push({
                    d: dateStr,
                    s: sym,
                    b: baseNeutral || (baseSignal === 'BULLISH' && moveUp) || (baseSignal === 'BEARISH' && !moveUp) ? 1 : 0,
                    g: (gannElliottSignal === 'BULLISH' && moveUp) || (gannElliottSignal === 'BEARISH' && !moveUp) ? 1 : 0,
                    q: dqnNeutral || (dqnSignal === 'BULLISH' && moveUp) || (dqnSignal === 'BEARISH' && !moveUp) ? 1 : 0,
                    w: (waveSignal === 'BULLISH' && moveUp) || (waveSignal === 'BEARISH' && !moveUp) ? 1 : 0,
                    c: (consensusDirection === 'BULLISH' && moveUp) || (consensusDirection === 'BEARISH' && !moveUp) ? 1 : 0,
                    l: consensusLevel === 'ULTRA' ? 'U' : (consensusLevel === 'SUPER' ? 'S' : 'M'),
                    n: baseNeutral ? 1 : 0,
                    dn: dqnNeutral ? 1 : 0
                });
                addedCount++;
            }

            symbolIndex++;
            setTimeout(processNextSymbol, 10);
        } catch (err) {
            console.error('Backfill error at symbol ' + symbols[symbolIndex] + ':', err);
            alert('ERROR during backfill: ' + err.message);
            var loadingEl = document.getElementById('agentBackfillLoading');
            if (loadingEl) loadingEl.remove();
        }
    }

    function finishBackfill() {
        try {
            updateProgress('Saving ' + log.length + ' predictions...');
            saveAgentPredictionLog(log);
            updateAgentPredictionDisplay();

            // Calculate stats
            // Calculate stats using compact format: b=base, g=gann, q=dqn, w=wave, c=consensus, l=level, n=baseNeutral, dn=dqnNeutral
            var stats = { base: {w:0,t:0}, gann: {w:0,t:0}, dqn: {w:0,t:0}, wave: {w:0,t:0}, ultra: {w:0,t:0}, super: {w:0,t:0}, mixed: {w:0,t:0} };
            for (var i = 0; i < log.length; i++) {
                var e = log[i];
                // Skip non-neutral base signals
                if (!e.n) { stats.base.t++; if (e.b) stats.base.w++; }
                // Gann is never neutral
                stats.gann.t++; if (e.g) stats.gann.w++;
                // Skip non-neutral DQN signals
                if (!e.dn) { stats.dqn.t++; if (e.q) stats.dqn.w++; }
                // Wave is never neutral
                stats.wave.t++; if (e.w) stats.wave.w++;
                // Consensus by level
                if (e.l === 'U') { stats.ultra.t++; if (e.c) stats.ultra.w++; }
                else if (e.l === 'S') { stats.super.t++; if (e.c) stats.super.w++; }
                else { stats.mixed.t++; if (e.c) stats.mixed.w++; }
            }

            var pct = function(s) { return s.t > 0 ? Math.round(s.w / s.t * 100) : 0; };
            var message = 'AGENT BACKFILL COMPLETE!\n\nAdded: ' + addedCount + '\nTotal: ' + log.length + '\n\n' +
                'AGENT ACCURACY:\n' +
                'Base: ' + pct(stats.base) + '% (' + stats.base.w + '/' + stats.base.t + ')\n' +
                'Gann-Elliott: ' + pct(stats.gann) + '% (' + stats.gann.w + '/' + stats.gann.t + ')\n' +
                'DQN: ' + pct(stats.dqn) + '% (' + stats.dqn.w + '/' + stats.dqn.t + ')\n' +
                '3-Wave: ' + pct(stats.wave) + '% (' + stats.wave.w + '/' + stats.wave.t + ')\n\n' +
                'CONSENSUS:\n' +
                'ULTRA: ' + pct(stats.ultra) + '% (' + stats.ultra.w + '/' + stats.ultra.t + ')\n' +
                'SUPER: ' + pct(stats.super) + '% (' + stats.super.w + '/' + stats.super.t + ')\n' +
                'MIXED: ' + pct(stats.mixed) + '% (' + stats.mixed.w + '/' + stats.mixed.t + ')';

            var loadingEl = document.getElementById('agentBackfillLoading');
            if (loadingEl) loadingEl.remove();

            alert(message);
            console.log('Agent backfill complete:', { added: addedCount, total: log.length });
        } catch (err) {
            console.error('Backfill finish error:', err);
            alert('ERROR finishing backfill: ' + err.message);
            var loadingEl = document.getElementById('agentBackfillLoading');
            if (loadingEl) loadingEl.remove();
        }
    }

    // Start processing with a small delay to let UI update
    setTimeout(processNextSymbol, 100);
}

// Clear and backfill agent predictions
function clearAndBackfillAgentPredictions(startDate) {
    var dateStr = startDate || '2023-01-03';

    // Check if data is loaded
    var spyData = allSymbolsData && allSymbolsData['SPY'];
    if (!spyData || spyData.length < 100) {
        alert('ERROR: CSV data not loaded yet!\n\nPlease wait a few seconds for data to load, then try again.\n\nSPY data rows: ' + (spyData ? spyData.length : 0));
        return;
    }

    if (confirm('Backfill agent predictions from ' + dateStr + '?\n\nSPY data: ' + spyData.length + ' rows\n\nThis will clear existing data.')) {
        localStorage.removeItem('stockAgentAgentLog');
        backfillAgentPredictions(dateStr);
    }
}

// ==========================================
// TRUE GANN BACKTEST - Sq9 + Time Cycles (ALL 12 ETFs)
// ==========================================

function backtestRealGann() {
    var symbols = ['SPY', 'QQQ', 'IWM', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];

    // Show loading
    var loadingDiv = document.createElement('div');
    loadingDiv.id = 'gannBacktestLoading';
    loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 9999; text-align: center; min-width: 350px;';
    loadingDiv.innerHTML = '<div style="font-size: 24px; margin-bottom: 10px;"></div><div style="font-size: 14px; font-weight: 600;">Running TRUE Gann Backtest...</div><div id="gannBacktestProgress" style="font-size: 12px; color: #666; margin-top: 10px;">Analyzing 12 ETFs x 2 Years</div>';
    document.body.appendChild(loadingDiv);

    var results = {
        sq9Support: { bounces: 0, breaks: 0, tests: 0 },
        sq9Resistance: { rejections: 0, breaks: 0, tests: 0 },
        cycle30: { reversals: 0, total: 0 },
        cycle45: { reversals: 0, total: 0 },
        cycle90: { reversals: 0, total: 0 },
        cycle144: { reversals: 0, total: 0 },
        cycle180: { reversals: 0, total: 0 },
        combined: { wins: 0, total: 0 },
        bySymbol: {},
        signals: []
    };

    var symbolIndex = 0;

    function processNextSymbol() {
        if (symbolIndex >= symbols.length) {
            finishBacktest();
            return;
        }

        var sym = symbols[symbolIndex];
        var data = allSymbolsData[sym];

        var prog = document.getElementById('gannBacktestProgress');
        if (prog) prog.textContent = 'Processing ' + sym + ' (' + (symbolIndex + 1) + '/12)...';

        if (!data || data.length < 100) {
            console.log(sym + ': Not enough data, skipping');
            symbolIndex++;
            setTimeout(processNextSymbol, 10);
            return;
        }

        results.bySymbol[sym] = { sq9Support: 0, sq9Resist: 0, cycle144: 0, total: 0 };

        var refDate = new Date(data[0].Date.split(' ')[0]);

        for (var i = 30; i < data.length - 5; i++) {
            var today = data[i];
            var price = parseFloat(today.Close);
            if (!price) continue;

            var future = [];
            for (var f = 1; f <= 5; f++) {
                if (i + f < data.length) {
                    future.push({ close: parseFloat(data[i + f].Close) });
                }
            }
            if (future.length < 5) continue;

            var futureClose = future[4].close;
            var move5day = ((futureClose - price) / price * 100);

            // Sq9 from 20-day swing pivots
            var swingLow = Infinity, swingHigh = 0;
            for (var k = i - 20; k < i; k++) {
                var kLow = parseFloat(data[k].Low) || Infinity;
                var kHigh = parseFloat(data[k].High) || 0;
                if (kLow < swingLow) swingLow = kLow;
                if (kHigh > swingHigh) swingHigh = kHigh;
            }

            var sqrtLow = Math.sqrt(swingLow);
            var sqrtHigh = Math.sqrt(swingHigh);

            // Check multiple Sq9 levels with 1.5% tolerance
            var sq9Levels = [0.25, 0.5, 0.75, 1.0, 1.5, 2.0];
            var nearSupport = false, nearResist = false;

            for (var lvl = 0; lvl < sq9Levels.length; lvl++) {
                var supportLevel = Math.pow(sqrtHigh - sq9Levels[lvl], 2);
                var resistLevel = Math.pow(sqrtLow + sq9Levels[lvl], 2);

                if (supportLevel > 0 && Math.abs(price - supportLevel) / price < 0.015) nearSupport = true;
                if (Math.abs(price - resistLevel) / price < 0.015) nearResist = true;
            }

            if (nearSupport) {
                results.sq9Support.tests++;
                if (futureClose > price) results.sq9Support.bounces++;
                else results.sq9Support.breaks++;
            }

            if (nearResist) {
                results.sq9Resistance.tests++;
                if (futureClose < price) results.sq9Resistance.rejections++;
                else results.sq9Resistance.breaks++;
            }

            // Time Cycles
            var currentDate = new Date(today.Date.split(' ')[0]);
            var daysSinceRef = Math.floor((currentDate - refDate) / (1000 * 60 * 60 * 24));

            var cycles = [
                { name: 'cycle30', days: 30 },
                { name: 'cycle45', days: 45 },
                { name: 'cycle90', days: 90 },
                { name: 'cycle144', days: 144 },
                { name: 'cycle180', days: 180 }
            ];

            var nearAnyCycleTurn = false;

            for (var c = 0; c < cycles.length; c++) {
                var cycle = cycles[c];
                var position = daysSinceRef % cycle.days;
                var nearTurn = position <= 3 || (cycle.days - position) <= 3;

                if (nearTurn) {
                    nearAnyCycleTurn = true;
                    results[cycle.name].total++;

                    var priorPrice = i >= 10 ? parseFloat(data[i - 10].Close) : price;
                    var wasGoingUp = price > priorPrice;
                    var reversed = (wasGoingUp && futureClose < price * 0.99) || (!wasGoingUp && futureClose > price * 1.01);

                    if (reversed || Math.abs(move5day) > 2) {
                        results[cycle.name].reversals++;
                    }
                }
            }

            // Combined signal
            if ((nearSupport || nearResist) && nearAnyCycleTurn) {
                results.combined.total++;
                var predictUp = nearSupport;
                var actualUp = futureClose > price;

                if (predictUp === actualUp) {
                    results.combined.wins++;
                }

                results.signals.push({
                    symbol: sym,
                    date: today.Date.split(' ')[0],
                    price: price.toFixed(2),
                    type: nearSupport ? 'SUPPORT' : 'RESIST',
                    prediction: predictUp ? 'UP' : 'DOWN',
                    actual: actualUp ? 'UP' : 'DOWN',
                    move: move5day.toFixed(2) + '%',
                    correct: predictUp === actualUp
                });
            }
        }

        symbolIndex++;
        setTimeout(processNextSymbol, 10);
    }

    function finishBacktest() {
        var loadEl = document.getElementById('gannBacktestLoading');
        if (loadEl) loadEl.remove();

        var sq9SupportPct = results.sq9Support.tests > 0 ? Math.round(results.sq9Support.bounces / results.sq9Support.tests * 100) : 0;
        var sq9ResistPct = results.sq9Resistance.tests > 0 ? Math.round(results.sq9Resistance.rejections / results.sq9Resistance.tests * 100) : 0;
        var combinedPct = results.combined.total > 0 ? Math.round(results.combined.wins / results.combined.total * 100) : 0;

        var cycle30Pct = results.cycle30.total > 0 ? Math.round(results.cycle30.reversals / results.cycle30.total * 100) : 0;
        var cycle45Pct = results.cycle45.total > 0 ? Math.round(results.cycle45.reversals / results.cycle45.total * 100) : 0;
        var cycle90Pct = results.cycle90.total > 0 ? Math.round(results.cycle90.reversals / results.cycle90.total * 100) : 0;
        var cycle144Pct = results.cycle144.total > 0 ? Math.round(results.cycle144.reversals / results.cycle144.total * 100) : 0;
        var cycle180Pct = results.cycle180.total > 0 ? Math.round(results.cycle180.reversals / results.cycle180.total * 100) : 0;

        updateGannBacktestDisplay(results, {
            sq9SupportPct: sq9SupportPct,
            sq9ResistPct: sq9ResistPct,
            combinedPct: combinedPct,
            cycle30Pct: cycle30Pct,
            cycle45Pct: cycle45Pct,
            cycle90Pct: cycle90Pct,
            cycle144Pct: cycle144Pct,
            cycle180Pct: cycle180Pct
        });

        var msg = ' TRUE GANN BACKTEST - 12 ETFs x 2 YEARS\n';
        msg += '==========================================\n\n';

        msg += ' SQUARE OF 9 LEVELS:\n';
        msg += ' Support Bounce: ' + sq9SupportPct + '% (' + results.sq9Support.bounces + '/' + results.sq9Support.tests + ')\n';
        msg += ' Resist Reject: ' + sq9ResistPct + '% (' + results.sq9Resistance.rejections + '/' + results.sq9Resistance.tests + ')\n\n';

        msg += ' TIME CYCLES (Reversals):\n';
        msg += ' 30-Day: ' + cycle30Pct + '% (' + results.cycle30.reversals + '/' + results.cycle30.total + ')\n';
        msg += ' 45-Day: ' + cycle45Pct + '% (' + results.cycle45.reversals + '/' + results.cycle45.total + ')\n';
        msg += ' 90-Day: ' + cycle90Pct + '% (' + results.cycle90.reversals + '/' + results.cycle90.total + ')\n';
        msg += ' 144-Day Sacred: ' + cycle144Pct + '% (' + results.cycle144.reversals + '/' + results.cycle144.total + ')\n';
        msg += ' 180-Day: ' + cycle180Pct + '% (' + results.cycle180.reversals + '/' + results.cycle180.total + ')\n\n';

        msg += ' COMBINED (Sq9 + Cycle):\n';
        msg += ' Win Rate: ' + combinedPct + '% (' + results.combined.wins + '/' + results.combined.total + ')\n\n';

        var best = Math.max(sq9SupportPct, sq9ResistPct, cycle144Pct, combinedPct);
        if (best > 55) {
            msg += ' EDGE FOUND! Best: ' + best + '%';
        } else if (best > 50) {
            msg += ' Slight edge detected: ' + best + '%';
        } else {
            msg += ' No significant edge found';
        }

        console.log('TRUE Gann Results (12 ETFs):', results);
        console.log('Combined signals:', results.signals);

        alert(msg);
        window.lastGannBacktest = results;
    }

    setTimeout(processNextSymbol, 100);
    return results;
}

// Test different Sq9 tolerance levels to find optimal threshold
function backtestSq9Tolerances() {
    var symbols = ['SPY', 'QQQ', 'IWM', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];
    var tolerances = [0.005, 0.0075, 0.01, 0.0125, 0.015, 0.02, 0.025, 0.03];

    var loadingDiv = document.createElement('div');
    loadingDiv.id = 'toleranceTestLoading';
    loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 9999; text-align: center; min-width: 350px;';
    loadingDiv.innerHTML = '<div style="font-size: 24px; margin-bottom: 10px;"></div><div style="font-size: 14px; font-weight: 600;">Testing Sq9 Tolerances...</div><div id="toleranceProgress" style="font-size: 12px; color: #666; margin-top: 10px;">Finding optimal threshold</div>';
    document.body.appendChild(loadingDiv);

    var results = {};

    for (var t = 0; t < tolerances.length; t++) {
        var tol = tolerances[t];
        var tolPct = (tol * 100).toFixed(2) + '%';

        results[tolPct] = {
            support: { bounces: 0, tests: 0 },
            resist: { rejections: 0, tests: 0 },
            combined144: { wins: 0, total: 0 }
        };

        var prog = document.getElementById('toleranceProgress');
        if (prog) prog.textContent = 'Testing ' + tolPct + ' tolerance...';

        for (var s = 0; s < symbols.length; s++) {
            var sym = symbols[s];
            var data = allSymbolsData[sym];
            if (!data || data.length < 100) continue;

            var refDate = new Date(data[0].Date.split(' ')[0]);

            for (var i = 30; i < data.length - 5; i++) {
                var today = data[i];
                var price = parseFloat(today.Close);
                if (!price) continue;

                var futureClose = parseFloat(data[i + 5].Close);
                if (!futureClose) continue;

                // 20-day swing pivots
                var swingLow = Infinity, swingHigh = 0;
                for (var k = i - 20; k < i; k++) {
                    var kLow = parseFloat(data[k].Low) || Infinity;
                    var kHigh = parseFloat(data[k].High) || 0;
                    if (kLow < swingLow) swingLow = kLow;
                    if (kHigh > swingHigh) swingHigh = kHigh;
                }

                var sqrtLow = Math.sqrt(swingLow);
                var sqrtHigh = Math.sqrt(swingHigh);

                var sq9Levels = [0.25, 0.5, 0.75, 1.0, 1.5, 2.0];
                var nearSupport = false, nearResist = false;

                for (var lvl = 0; lvl < sq9Levels.length; lvl++) {
                    var supportLevel = Math.pow(sqrtHigh - sq9Levels[lvl], 2);
                    var resistLevel = Math.pow(sqrtLow + sq9Levels[lvl], 2);
                    if (supportLevel > 0 && Math.abs(price - supportLevel) / price < tol) nearSupport = true;
                    if (Math.abs(price - resistLevel) / price < tol) nearResist = true;
                }

                var currentDate = new Date(today.Date.split(' ')[0]);
                var daysSinceRef = Math.floor((currentDate - refDate) / (1000 * 60 * 60 * 24));
                var cycle144Position = daysSinceRef % 144;
                var near144Turn = cycle144Position <= 3 || (144 - cycle144Position) <= 3;

                if (nearSupport) {
                    results[tolPct].support.tests++;
                    if (futureClose > price) results[tolPct].support.bounces++;
                }

                if (nearResist) {
                    results[tolPct].resist.tests++;
                    if (futureClose < price) results[tolPct].resist.rejections++;
                }

                if (near144Turn && nearSupport) {
                    results[tolPct].combined144.total++;
                    if (futureClose > price) results[tolPct].combined144.wins++;
                }
            }
        }
    }

    var loadEl = document.getElementById('toleranceTestLoading');
    if (loadEl) loadEl.remove();

    var msg = ' SQ9 TOLERANCE OPTIMIZATION\n';
    msg += '================================\n\n';
    msg += 'Tolerance | Support | Resist | 144+Sq9 | Signals\n';
    msg += '----------|---------|--------|---------|--------\n';

    var bestSupport = { tol: '', pct: 0, count: 0 };
    var best144 = { tol: '', pct: 0, count: 0 };

    for (var t = 0; t < tolerances.length; t++) {
        var tol = tolerances[t];
        var tolPct = (tol * 100).toFixed(2) + '%';
        var r = results[tolPct];

        var supportPct = r.support.tests > 0 ? Math.round(r.support.bounces / r.support.tests * 100) : 0;
        var resistPct = r.resist.tests > 0 ? Math.round(r.resist.rejections / r.resist.tests * 100) : 0;
        var cycle144Pct = r.combined144.total > 0 ? Math.round(r.combined144.wins / r.combined144.total * 100) : 0;

        msg += tolPct.padEnd(9) + ' | ' + (supportPct + '%').padEnd(7) + ' | ' + (resistPct + '%').padEnd(6) + ' | ' + (cycle144Pct + '%').padEnd(7) + ' | ' + r.combined144.total + '\n';

        if (supportPct > bestSupport.pct && r.support.tests >= 100) {
            bestSupport = { tol: tolPct, pct: supportPct, count: r.support.tests };
        }
        if (cycle144Pct > best144.pct && r.combined144.total >= 10) {
            best144 = { tol: tolPct, pct: cycle144Pct, count: r.combined144.total };
        }
    }

    msg += '\n OPTIMAL THRESHOLDS:\n';
    msg += ' Best Sq9 Support: ' + bestSupport.tol + '  ' + bestSupport.pct + '% (' + bestSupport.count + ' signals)\n';
    msg += ' Best 144+Sq9: ' + best144.tol + '  ' + best144.pct + '% (' + best144.count + ' signals)\n';

    console.log('Tolerance Test Results:', results);
    alert(msg);
    window.toleranceTestResults = results;
    return results;
}

// Test a SINGLE ETF at specific tolerance
function testSingleETF(symbol, tolerance) {
    var sym = symbol || 'SPY';
    var tol = tolerance || 0.015;

    var data = allSymbolsData[sym];
    if (!data || data.length < 100) {
        alert('No data for ' + sym + '. Make sure data is loaded first.');
        return null;
    }

    var results = {
        support: { bounces: 0, tests: 0 },
        resist: { rejects: 0, tests: 0 },
        cycle144: { wins: 0, total: 0 },
        combined: { wins: 0, total: 0 }
    };

    var refDate = new Date(data[0].Date.split(' ')[0]);

    for (var i = 30; i < data.length - 5; i++) {
        var price = parseFloat(data[i].Close);
        var futureClose = parseFloat(data[i + 5].Close);
        if (!price || !futureClose) continue;

        // Find 20-day swing high/low
        var swingHigh = 0, swingLow = Infinity;
        for (var k = i - 20; k < i; k++) {
            var kHigh = parseFloat(data[k].High) || 0;
            var kLow = parseFloat(data[k].Low) || Infinity;
            if (kHigh > swingHigh) swingHigh = kHigh;
            if (kLow < swingLow) swingLow = kLow;
        }

        // Calculate Sq9 levels
        var sqrtHigh = Math.sqrt(swingHigh);
        var sqrtLow = Math.sqrt(swingLow);
        var sq9Angles = [0.25, 0.5, 0.75, 1.0, 1.5, 2.0];

        var nearSupport = false, nearResist = false;
        for (var lvl = 0; lvl < sq9Angles.length; lvl++) {
            var supportLevel = Math.pow(sqrtHigh - sq9Angles[lvl], 2);
            var resistLevel = Math.pow(sqrtLow + sq9Angles[lvl], 2);
            if (supportLevel > 0 && Math.abs(price - supportLevel) / price < tol) nearSupport = true;
            if (resistLevel > 0 && Math.abs(price - resistLevel) / price < tol) nearResist = true;
        }

        // Check 144-day cycle
        var currentDate = new Date(data[i].Date.split(' ')[0]);
        var daysSinceRef = Math.floor((currentDate - refDate) / (1000 * 60 * 60 * 24));
        var near144Turn = (daysSinceRef % 144) <= 3 || (144 - (daysSinceRef % 144)) <= 3;

        // Track results
        if (nearSupport) {
            results.support.tests++;
            if (futureClose > price) results.support.bounces++;
        }
        if (nearResist) {
            results.resist.tests++;
            if (futureClose < price) results.resist.rejects++;
        }
        if (near144Turn) {
            results.cycle144.total++;
            var priorClose = parseFloat(data[i - 1].Close);
            var wasDown = priorClose > price;
            if ((wasDown && futureClose > price) || (!wasDown && futureClose < price)) {
                results.cycle144.wins++;
            }
        }
        if (near144Turn && nearSupport) {
            results.combined.total++;
            if (futureClose > price) results.combined.wins++;
        }
    }

    var supportPct = results.support.tests > 0 ? Math.round(results.support.bounces / results.support.tests * 100) : 0;
    var resistPct = results.resist.tests > 0 ? Math.round(results.resist.rejects / results.resist.tests * 100) : 0;
    var cycle144Pct = results.cycle144.total > 0 ? Math.round(results.cycle144.wins / results.cycle144.total * 100) : 0;
    var combinedPct = results.combined.total > 0 ? Math.round(results.combined.wins / results.combined.total * 100) : 0;

    // Update UI display
    var resultsDiv = document.getElementById('singleETFResults');
    if (resultsDiv) {
        resultsDiv.style.display = 'block';

        // Update title
        var symbolTitle = document.getElementById('singleETFSymbolTitle');
        var tolTitle = document.getElementById('singleETFTolTitle');
        if (symbolTitle) symbolTitle.textContent = sym;
        if (tolTitle) tolTitle.textContent = (tol * 100) + '%';

        // Update summary cards
        var el = document.getElementById('singleETFSupport');
        if (el) el.textContent = supportPct + '%';
        el = document.getElementById('singleETFResist');
        if (el) el.textContent = resistPct + '%';
        el = document.getElementById('singleETFCycle');
        if (el) el.textContent = cycle144Pct + '%';
        el = document.getElementById('singleETFCombined');
        if (el) el.textContent = combinedPct + '%';

        // Build table rows
        var tableBody = document.getElementById('singleETFTableBody');
        if (tableBody) {
            var rows = [
                { name: ' Sq9 Support Bounce', pct: supportPct, wins: results.support.bounces, total: results.support.tests, color: '#22c55e' },
                { name: ' Sq9 Resistance Reject', pct: resistPct, wins: results.resist.rejects, total: results.resist.tests, color: '#ef4444' },
                { name: ' 144-Day Cycle Reversal', pct: cycle144Pct, wins: results.cycle144.wins, total: results.cycle144.total, color: '#8b5cf6' },
                { name: ' Combined (144 + Support)', pct: combinedPct, wins: results.combined.wins, total: results.combined.total, color: '#f59e0b' }
            ];

            var html = '';
            for (var r = 0; r < rows.length; r++) {
                var row = rows[r];
                var edge = row.pct - 50;
                var edgeColor = edge > 0 ? '#22c55e' : (edge < 0 ? '#ef4444' : '#666');
                var edgeSign = edge > 0 ? '+' : '';
                var pctBg = row.pct >= 55 ? 'rgba(34,197,94,0.2)' : (row.pct >= 50 ? 'rgba(245,158,11,0.2)' : 'rgba(239,68,68,0.2)');

                html += '<tr style="border-bottom: 1px solid #eee;">';
                html += '<td style="padding: 8px; font-weight: 500;">' + row.name + '</td>';
                html += '<td style="padding: 8px; text-align: center; background: ' + pctBg + '; font-weight: 700; color: ' + row.color + ';">' + row.pct + '%</td>';
                html += '<td style="padding: 8px; text-align: center;">' + row.wins + '</td>';
                html += '<td style="padding: 8px; text-align: center;">' + row.total + '</td>';
                html += '<td style="padding: 8px; text-align: center; font-weight: 600; color: ' + edgeColor + ';">' + edgeSign + edge + '%</td>';
                html += '</tr>';
            }
            tableBody.innerHTML = html;
        }
    }

    console.log(sym + ' Results:', results);
    return results;
}

// Run single ETF test from dropdown
function runSingleETFTest() {
    var select = document.getElementById('singleETFSelect');
    var symbol = select ? select.value : 'SPY';
    var tol = parseFloat(document.getElementById('singleETFTolerance')?.value) || 0.015;
    testSingleETF(symbol, tol);
}

// ==========================================
// TRUE GANN - Pivot-Based Analysis
// ==========================================

function backtestPivotGann() {
    var symbols = ['SPY', 'QQQ', 'IWM', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];

    var loadingDiv = document.createElement('div');
    loadingDiv.id = 'pivotGannLoading';
    loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 9999; text-align: center; min-width: 350px;';
    loadingDiv.innerHTML = '<div style="font-size: 24px; margin-bottom: 10px;"></div><div style="font-size: 14px; font-weight: 600;">Testing Pivot-Based Gann...</div><div id="pivotGannProgress" style="font-size: 12px; color: #666; margin-top: 10px;">Finding pivots and testing...</div>';
    document.body.appendChild(loadingDiv);

    var results = {
        // Price = Time squaring
        priceTimeSquare: { wins: 0, total: 0, signals: [] },

        // Sq9 from pivot highs (resistance)
        sq9FromPivotHigh: { wins: 0, total: 0 },

        // Sq9 from pivot lows (support)
        sq9FromPivotLow: { wins: 0, total: 0 },

        // Anniversary dates (90, 180, 360 days from pivot)
        anniversary90: { reversals: 0, total: 0 },
        anniversary180: { reversals: 0, total: 0 },
        anniversary360: { reversals: 0, total: 0 },

        // Gann 1x1 angle respect
        gannAngle1x1: { bounces: 0, total: 0 },

        // Combined: Sq9 from pivot + anniversary
        combined: { wins: 0, total: 0 }
    };

    for (var s = 0; s < symbols.length; s++) {
        var sym = symbols[s];
        var data = allSymbolsData[sym];
        if (!data || data.length < 200) continue;

        var prog = document.getElementById('pivotGannProgress');
        if (prog) prog.textContent = 'Processing ' + sym + '...';

        // ============================================
        // STEP 1: Find Major Pivots (20-day swing points)
        // ============================================
        var pivots = [];

        for (var i = 20; i < data.length - 20; i++) {
            var high = parseFloat(data[i].High);
            var low = parseFloat(data[i].Low);

            // Check if this is a swing high (highest high in 20 bars each side)
            var isSwingHigh = true;
            var isSwingLow = true;

            for (var j = i - 20; j <= i + 20; j++) {
                if (j === i) continue;
                if (parseFloat(data[j].High) > high) isSwingHigh = false;
                if (parseFloat(data[j].Low) < low) isSwingLow = false;
            }

            if (isSwingHigh) {
                pivots.push({ type: 'HIGH', index: i, price: high, date: data[i].Date });
            }
            if (isSwingLow) {
                pivots.push({ type: 'LOW', index: i, price: low, date: data[i].Date });
            }
        }

        // ============================================
        // STEP 2: Test Price = Time Squaring
        // ============================================
        for (var p = 0; p < pivots.length; p++) {
            var pivot = pivots[p];

            // Look forward from pivot
            for (var d = 10; d <= 100; d++) {
                var futureIndex = pivot.index + d;
                if (futureIndex >= data.length - 5) break;

                var currentPrice = parseFloat(data[futureIndex].Close);
                var priceMove = Math.abs(currentPrice - pivot.price);

                // Price = Time: when price move  days elapsed (scaled)
                // Use 0.1% per day as scale factor
                var expectedMove = pivot.price * 0.001 * d;
                var priceTimeRatio = priceMove / expectedMove;

                // Check if we're at a "square" (ratio near 1.0, 2.0, or 0.5)
                var isSquare =
                    (priceTimeRatio > 0.9 && priceTimeRatio < 1.1) ||
                    (priceTimeRatio > 1.9 && priceTimeRatio < 2.1) ||
                    (priceTimeRatio > 0.45 && priceTimeRatio < 0.55);

                if (isSquare) {
                    var futureClose = parseFloat(data[futureIndex + 5].Close);
                    var wasUptrend = currentPrice > pivot.price;

                    results.priceTimeSquare.total++;

                    // Expect reversal at square
                    var wentDown = futureClose < currentPrice * 0.99;
                    var wentUp = futureClose > currentPrice * 1.01;
                    var reversal = (wasUptrend && wentDown) || (!wasUptrend && wentUp);

                    if (reversal) {
                        results.priceTimeSquare.wins++;
                    }
                }
            }
        }

        // ============================================
        // STEP 3: Test Sq9 Levels FROM Pivot Prices
        // ============================================
        for (var p = 0; p < pivots.length; p++) {
            var pivot = pivots[p];
            var sqrt = Math.sqrt(pivot.price);

            // Calculate Sq9 levels from this pivot
            var sq9Levels = [];
            for (var angle = 1; angle <= 4; angle++) {
                sq9Levels.push({
                    support: Math.pow(sqrt - (angle * 0.5), 2),
                    resistance: Math.pow(sqrt + (angle * 0.5), 2)
                });
            }

            // Look for price touching these levels in the future
            for (var d = 5; d < 200; d++) {
                var futureIndex = pivot.index + d;
                if (futureIndex >= data.length - 5) break;

                var price = parseFloat(data[futureIndex].Close);
                var futureClose = parseFloat(data[futureIndex + 5].Close);

                // Check each Sq9 level
                for (var lvl = 0; lvl < sq9Levels.length; lvl++) {
                    var level = sq9Levels[lvl];

                    // Test support from pivot LOW
                    if (pivot.type === 'LOW') {
                        if (Math.abs(price - level.support) / price < 0.01) {
                            results.sq9FromPivotLow.total++;
                            if (futureClose > price) {
                                results.sq9FromPivotLow.wins++;
                            }
                        }
                    }

                    // Test resistance from pivot HIGH
                    if (pivot.type === 'HIGH') {
                        if (Math.abs(price - level.resistance) / price < 0.01) {
                            results.sq9FromPivotHigh.total++;
                            if (futureClose < price) {
                                results.sq9FromPivotHigh.wins++;
                            }
                        }
                    }
                }
            }
        }

        // ============================================
        // STEP 4: Test Anniversary Dates from Pivots
        // ============================================
        for (var p = 0; p < pivots.length; p++) {
            var pivot = pivots[p];
            var anniversaries = [90, 180, 360];

            for (var a = 0; a < anniversaries.length; a++) {
                var days = anniversaries[a];
                var annivIndex = pivot.index + days;

                if (annivIndex >= data.length - 5) continue;

                var price = parseFloat(data[annivIndex].Close);
                var futureClose = parseFloat(data[annivIndex + 5].Close);
                var priorPrice = parseFloat(data[annivIndex - 10].Close);

                var wasUptrend = price > priorPrice;
                var wentDown = futureClose < price * 0.99;
                var wentUp = futureClose > price * 1.01;
                var reversal = (wasUptrend && wentDown) || (!wasUptrend && wentUp);

                var key = 'anniversary' + days;
                results[key].total++;
                if (reversal) {
                    results[key].reversals++;
                }
            }
        }

        // ============================================
        // STEP 5: Test Gann 1x1 Angle
        // ============================================
        for (var p = 0; p < pivots.length; p++) {
            var pivot = pivots[p];
            var scaleFactor = pivot.price * 0.001; // 0.1% per day

            for (var d = 20; d < 200; d++) {
                var futureIndex = pivot.index + d;
                if (futureIndex >= data.length - 5) break;

                var price = parseFloat(data[futureIndex].Close);
                var futureClose = parseFloat(data[futureIndex + 5].Close);

                // 1x1 angle price from pivot
                var angle1x1Price;
                if (pivot.type === 'LOW') {
                    angle1x1Price = pivot.price + (scaleFactor * d);
                } else {
                    angle1x1Price = pivot.price - (scaleFactor * d);
                }

                // Check if price is near 1x1 line
                if (Math.abs(price - angle1x1Price) / price < 0.01) {
                    results.gannAngle1x1.total++;

                    // Expect bounce off 1x1 line
                    if (pivot.type === 'LOW' && futureClose > price) {
                        results.gannAngle1x1.bounces++;
                    } else if (pivot.type === 'HIGH' && futureClose < price) {
                        results.gannAngle1x1.bounces++;
                    }
                }
            }
        }
    }

    // Remove loading
    var loadEl = document.getElementById('pivotGannLoading');
    if (loadEl) loadEl.remove();

    // Calculate percentages
    var pct = function(r) { return r.total > 0 ? Math.round(r.wins / r.total * 100) : 0; };
    var revPct = function(r) { return r.total > 0 ? Math.round(r.reversals / r.total * 100) : 0; };
    var bouncePct = function(r) { return r.total > 0 ? Math.round(r.bounces / r.total * 100) : 0; };

    var msg = ' PIVOT-BASED GANN BACKTEST\n';
    msg += '================================\n\n';

    msg += ' PRICE = TIME SQUARING:\n';
    msg += ' Reversal at square: ' + pct(results.priceTimeSquare) + '% (' + results.priceTimeSquare.wins + '/' + results.priceTimeSquare.total + ')\n\n';

    msg += ' SQ9 FROM PIVOT PRICES:\n';
    msg += ' From Pivot LOW (support): ' + pct(results.sq9FromPivotLow) + '% (' + results.sq9FromPivotLow.wins + '/' + results.sq9FromPivotLow.total + ')\n';
    msg += ' From Pivot HIGH (resist): ' + pct(results.sq9FromPivotHigh) + '% (' + results.sq9FromPivotHigh.wins + '/' + results.sq9FromPivotHigh.total + ')\n\n';

    msg += ' ANNIVERSARY DATES FROM PIVOTS:\n';
    msg += ' 90 days: ' + revPct(results.anniversary90) + '% (' + results.anniversary90.reversals + '/' + results.anniversary90.total + ')\n';
    msg += ' 180 days: ' + revPct(results.anniversary180) + '% (' + results.anniversary180.reversals + '/' + results.anniversary180.total + ')\n';
    msg += ' 360 days: ' + revPct(results.anniversary360) + '% (' + results.anniversary360.reversals + '/' + results.anniversary360.total + ')\n\n';

    msg += ' GANN 1x1 ANGLE:\n';
    msg += ' Bounce off 1x1: ' + bouncePct(results.gannAngle1x1) + '% (' + results.gannAngle1x1.bounces + '/' + results.gannAngle1x1.total + ')\n\n';

    // Find best method
    var methods = [
        { name: 'Price=Time Square', pct: pct(results.priceTimeSquare) },
        { name: 'Sq9 from Pivot Low', pct: pct(results.sq9FromPivotLow) },
        { name: 'Sq9 from Pivot High', pct: pct(results.sq9FromPivotHigh) },
        { name: '90-day Anniversary', pct: revPct(results.anniversary90) },
        { name: '180-day Anniversary', pct: revPct(results.anniversary180) },
        { name: '360-day Anniversary', pct: revPct(results.anniversary360) },
        { name: 'Gann 1x1 Angle', pct: bouncePct(results.gannAngle1x1) }
    ].sort(function(a, b) { return b.pct - a.pct; });

    msg += ' RANKED BY ACCURACY:\n';
    for (var i = 0; i < methods.length; i++) {
        var icon = methods[i].pct >= 55 ? '' : (methods[i].pct >= 50 ? '' : '');
        msg += icon + ' ' + methods[i].name + ': ' + methods[i].pct + '%\n';
    }

    console.log('Pivot Gann Results:', results);
    alert(msg);

    window.lastPivotGannResults = results;
    return results;
}

// ==========================================
// GANN BIBLICAL NUMBERS BACKTEST
// ==========================================

function backtestBiblicalNumbers() {
    var data = allSymbolsData['SPY'];
    if (!data || data.length < 400) {
        alert('Not enough SPY data (need 400+ days)');
        return;
    }

    // Show loading
    var loadingDiv = document.createElement('div');
    loadingDiv.id = 'biblicalLoading';
    loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 9999; text-align: center; min-width: 400px;';
    loadingDiv.innerHTML = '<div style="font-size: 24px; margin-bottom: 10px;"></div><div style="font-size: 14px; font-weight: 600;">Testing Gann Biblical Numbers...</div><div id="biblicalProgress" style="font-size: 12px; color: #666; margin-top: 10px;">Analyzing SPY with sacred cycles</div>';
    document.body.appendChild(loadingDiv);

    // ==========================================
    // BIBLICAL NUMBERS FROM GANN
    // ==========================================
    var biblicalCycles = [
        // Creation & Sacred Numbers
        { days: 7, name: '7 Days (Creation)', source: 'Genesis 1-2' },
        { days: 12, name: '12 Days (Tribes/Apostles)', source: '12 Tribes' },
        { days: 21, name: '21 Days (37)', source: 'Daniel 10:13' },
        { days: 28, name: '28 Days (47, Lunar)', source: 'Lunar Month' },

        // Flood & Wilderness
        { days: 40, name: '40 Days (Flood/Moses)', source: 'Genesis 7:4' },
        { days: 49, name: '49 Days (77 Jubilee)', source: 'Leviticus 25' },
        { days: 50, name: '50 Days (Pentecost)', source: 'Leviticus 23:16' },

        // Gann's Important Numbers
        { days: 52, name: '52 Days (Weeks/Year)', source: 'Gann Square' },
        { days: 60, name: '60 Days (Babylonian)', source: 'Daniel' },
        { days: 72, name: '72 Days (3605)', source: 'Circle Division' },
        { days: 90, name: '90 Days (Quarter)', source: '3604' },

        // Sacred Geometry
        { days: 120, name: '120 Days (1/3 Year)', source: 'Genesis 6:3' },
        { days: 144, name: '144 Days (1212 SACRED)', source: 'Revelation 7' },
        { days: 150, name: '150 Days (Flood Duration)', source: 'Genesis 7:24' },

        // Half & Full Cycles
        { days: 180, name: '180 Days (Half Year)', source: '3602' },
        { days: 216, name: '216 Days (666)', source: 'Revelation 13:18' },
        { days: 252, name: '252 Days (Trading Year)', source: 'Market Days' },

        // Prophetic Cycles
        { days: 270, name: '270 Days (3/4 Year)', source: '3600.75' },
        { days: 288, name: '288 Days (2144)', source: 'Double Sacred' },
        { days: 360, name: '360 Days (Prophetic Year)', source: 'Ezekiel 4:6' }
    ];

    // Weekly cycles (in trading days)
    var weeklyCycles = [
        { days: 5, name: '1 Week (5 trading)', source: 'Weekly' },
        { days: 10, name: '2 Weeks', source: 'Bi-weekly' },
        { days: 15, name: '3 Weeks', source: 'Tri-weekly' },
        { days: 25, name: '5 Weeks', source: '5 Week' },
        { days: 35, name: '7 Weeks (Death Zone)', source: 'Gann Fatal' },
        { days: 45, name: '9 Weeks', source: '9 Week' },
        { days: 65, name: '13 Weeks (Quarter)', source: '13 Week' },
        { days: 130, name: '26 Weeks (Half Year)', source: '26 Week' }
    ];

    var results = {
        calendarDays: {},
        tradingDays: {},
        bestCycles: []
    };

    // Find all swing pivots (local highs and lows)
    var pivots = [];
    for (var i = 10; i < data.length - 10; i++) {
        var high = parseFloat(data[i].High);
        var low = parseFloat(data[i].Low);
        var isHigh = true, isLow = true;

        for (var j = i - 10; j <= i + 10; j++) {
            if (j === i) continue;
            if (parseFloat(data[j].High) > high) isHigh = false;
            if (parseFloat(data[j].Low) < low) isLow = false;
        }

        if (isHigh) pivots.push({ type: 'HIGH', index: i, price: high, date: data[i].Date });
        if (isLow) pivots.push({ type: 'LOW', index: i, price: low, date: data[i].Date });
    }

    console.log('Found ' + pivots.length + ' pivots');

    // ==========================================
    // TEST 1: Calendar Day Cycles from Pivots
    // ==========================================
    var prog = document.getElementById('biblicalProgress');
    if (prog) prog.textContent = 'Testing calendar day cycles...';

    for (var c = 0; c < biblicalCycles.length; c++) {
        var cycle = biblicalCycles[c];
        results.calendarDays[cycle.days] = {
            name: cycle.name,
            source: cycle.source,
            reversals: 0,
            total: 0,
            signals: []
        };

        // Test from each pivot
        for (var p = 0; p < pivots.length; p++) {
            var pivot = pivots[p];
            var pivotDate = new Date(pivot.date);

            // Find the bar that is 'cycle.days' calendar days after pivot
            for (var i = pivot.index + 1; i < data.length - 5; i++) {
                var currentDate = new Date(data[i].Date);
                var daysDiff = Math.floor((currentDate - pivotDate) / (1000 * 60 * 60 * 24));

                // Check if within 2 days of cycle length
                if (Math.abs(daysDiff - cycle.days) <= 2) {
                    var price = parseFloat(data[i].Close);
                    var futurePrice = parseFloat(data[i + 5].Close);
                    var priorPrice = parseFloat(data[i - 5].Close);

                    if (!price || !futurePrice || !priorPrice) continue;

                    results.calendarDays[cycle.days].total++;

                    // Check for reversal (trend change)
                    var wasUp = price > priorPrice;
                    var wentDown = futurePrice < price * 0.995;
                    var wentUp = futurePrice > price * 1.005;

                    var reversal = (wasUp && wentDown) || (!wasUp && wentUp);

                    if (reversal) {
                        results.calendarDays[cycle.days].reversals++;
                        results.calendarDays[cycle.days].signals.push({
                            pivotDate: pivot.date,
                            pivotType: pivot.type,
                            signalDate: data[i].Date,
                            daysFromPivot: daysDiff,
                            price: price,
                            outcome: wasUp ? 'REVERSED DOWN' : 'REVERSED UP'
                        });
                    }

                    break; // Only count once per pivot
                }

                if (daysDiff > cycle.days + 5) break;
            }
        }
    }

    // ==========================================
    // TEST 2: Trading Day Cycles (Bars from Pivot)
    // ==========================================
    if (prog) prog.textContent = 'Testing trading day cycles...';

    for (var c = 0; c < weeklyCycles.length; c++) {
        var cycle = weeklyCycles[c];
        results.tradingDays[cycle.days] = {
            name: cycle.name,
            source: cycle.source,
            reversals: 0,
            total: 0
        };

        for (var p = 0; p < pivots.length; p++) {
            var pivot = pivots[p];
            var targetIndex = pivot.index + cycle.days;

            if (targetIndex >= data.length - 5) continue;

            var price = parseFloat(data[targetIndex].Close);
            var futurePrice = parseFloat(data[targetIndex + 5].Close);
            var priorPrice = parseFloat(data[targetIndex - 5].Close);

            if (!price || !futurePrice || !priorPrice) continue;

            results.tradingDays[cycle.days].total++;

            var wasUp = price > priorPrice;
            var wentDown = futurePrice < price * 0.995;
            var wentUp = futurePrice > price * 1.005;

            if ((wasUp && wentDown) || (!wasUp && wentUp)) {
                results.tradingDays[cycle.days].reversals++;
            }
        }
    }

    // ==========================================
    // TEST 3: Sq9 + Biblical Cycle Confluence
    // ==========================================
    if (prog) prog.textContent = 'Testing Sq9 + Biblical confluence...';

    var sq9Biblical = {
        support144: { wins: 0, total: 0 },
        support49: { wins: 0, total: 0 },
        support40: { wins: 0, total: 0 },
        resist144: { wins: 0, total: 0 }
    };

    for (var p = 0; p < pivots.length; p++) {
        var pivot = pivots[p];
        var pivotDate = new Date(pivot.date);

        // Check at 40, 49, and 144 days from pivot
        var checkDays = [40, 49, 144];

        for (var cd = 0; cd < checkDays.length; cd++) {
            var targetDays = checkDays[cd];

            for (var i = pivot.index + 1; i < data.length - 5; i++) {
                var currentDate = new Date(data[i].Date);
                var daysDiff = Math.floor((currentDate - pivotDate) / (1000 * 60 * 60 * 24));

                if (Math.abs(daysDiff - targetDays) <= 2) {
                    var price = parseFloat(data[i].Close);
                    var futurePrice = parseFloat(data[i + 5].Close);

                    if (!price || !futurePrice) break;

                    // Check if also at Sq9 level
                    var sqrt = Math.sqrt(price);
                    var sq9Support90 = Math.pow(sqrt - 0.5, 2);
                    var sq9Support180 = Math.pow(sqrt - 1.0, 2);
                    var sq9Resist90 = Math.pow(sqrt + 0.5, 2);

                    var nearSupport =
                        Math.abs(price - sq9Support90) / price < 0.01 ||
                        Math.abs(price - sq9Support180) / price < 0.015;

                    var nearResist = Math.abs(price - sq9Resist90) / price < 0.01;

                    if (nearSupport) {
                        var key = 'support' + targetDays;
                        if (sq9Biblical[key]) {
                            sq9Biblical[key].total++;
                            if (futurePrice > price) sq9Biblical[key].wins++;
                        }
                    }

                    if (nearResist && targetDays === 144) {
                        sq9Biblical.resist144.total++;
                        if (futurePrice < price) sq9Biblical.resist144.wins++;
                    }

                    break;
                }

                if (daysDiff > targetDays + 5) break;
            }
        }
    }

    results.sq9Biblical = sq9Biblical;

    // ==========================================
    // CALCULATE RANKINGS
    // ==========================================

    // Rank calendar day cycles
    var calendarRanked = [];
    for (var days in results.calendarDays) {
        var r = results.calendarDays[days];
        var pct = r.total > 0 ? Math.round(r.reversals / r.total * 100) : 0;
        calendarRanked.push({
            days: days,
            name: r.name,
            source: r.source,
            pct: pct,
            reversals: r.reversals,
            total: r.total
        });
    }
    calendarRanked.sort(function(a, b) { return b.pct - a.pct; });

    // Rank trading day cycles
    var tradingRanked = [];
    for (var days in results.tradingDays) {
        var r = results.tradingDays[days];
        var pct = r.total > 0 ? Math.round(r.reversals / r.total * 100) : 0;
        tradingRanked.push({
            days: days,
            name: r.name,
            pct: pct,
            reversals: r.reversals,
            total: r.total
        });
    }
    tradingRanked.sort(function(a, b) { return b.pct - a.pct; });

    // Remove loading
    var loadEl = document.getElementById('biblicalLoading');
    if (loadEl) loadEl.remove();

    // ==========================================
    // DISPLAY RESULTS
    // ==========================================

    var msg = ' GANN BIBLICAL NUMBERS BACKTEST - SPY\n';
    msg += '==========================================\n\n';

    msg += ' CALENDAR DAY CYCLES (from pivots):\n';
    msg += '\n';

    for (var i = 0; i < Math.min(calendarRanked.length, 15); i++) {
        var r = calendarRanked[i];
        var icon = r.pct >= 55 ? '' : (r.pct >= 50 ? '' : '');
        var highlight = (r.days == 144 || r.days == 49 || r.days == 40) ? ' ' : '';
        msg += icon + ' ' + r.days + ' days: ' + r.pct + '% (' + r.reversals + '/' + r.total + ') - ' + r.name + highlight + '\n';
    }

    msg += '\n TRADING DAY CYCLES (bars from pivot):\n';
    msg += '\n';

    for (var i = 0; i < tradingRanked.length; i++) {
        var r = tradingRanked[i];
        var icon = r.pct >= 55 ? '' : (r.pct >= 50 ? '' : '');
        var highlight = r.days == 35 ? '  DEATH ZONE' : '';
        msg += icon + ' ' + r.days + ' bars: ' + r.pct + '% (' + r.reversals + '/' + r.total + ') - ' + r.name + highlight + '\n';
    }

    msg += '\n SQ9 + BIBLICAL CONFLUENCE:\n';
    msg += '\n';

    var pct40 = sq9Biblical.support40.total > 0 ? Math.round(sq9Biblical.support40.wins / sq9Biblical.support40.total * 100) : 0;
    var pct49 = sq9Biblical.support49.total > 0 ? Math.round(sq9Biblical.support49.wins / sq9Biblical.support49.total * 100) : 0;
    var pct144 = sq9Biblical.support144.total > 0 ? Math.round(sq9Biblical.support144.wins / sq9Biblical.support144.total * 100) : 0;
    var pctR144 = sq9Biblical.resist144.total > 0 ? Math.round(sq9Biblical.resist144.wins / sq9Biblical.resist144.total * 100) : 0;

    msg += ' Sq9 Support + 40 days: ' + pct40 + '% (' + sq9Biblical.support40.wins + '/' + sq9Biblical.support40.total + ')\n';
    msg += ' Sq9 Support + 49 days: ' + pct49 + '% (' + sq9Biblical.support49.wins + '/' + sq9Biblical.support49.total + ')\n';
    msg += ' Sq9 Support + 144 days: ' + pct144 + '% (' + sq9Biblical.support144.wins + '/' + sq9Biblical.support144.total + ') \n';
    msg += ' Sq9 Resist + 144 days: ' + pctR144 + '% (' + sq9Biblical.resist144.wins + '/' + sq9Biblical.resist144.total + ')\n';

    msg += '\n TOP 5 BIBLICAL CYCLES:\n';
    msg += '\n';
    for (var i = 0; i < Math.min(5, calendarRanked.length); i++) {
        var r = calendarRanked[i];
        if (r.total >= 10) {
            msg += (i + 1) + '. ' + r.days + ' days (' + r.name + '): ' + r.pct + '%\n';
        }
    }

    console.log('Biblical Numbers Results:', results);
    console.log('Calendar Ranked:', calendarRanked);
    console.log('Trading Ranked:', tradingRanked);

    alert(msg);

    // Store results
    window.biblicalResults = results;
    window.biblicalRanked = calendarRanked;

    // Update display if elements exist
    updateBiblicalDisplay(calendarRanked, tradingRanked, sq9Biblical);

    return results;
}

// Load full SPY history (1993-2025) and run biblical backtest
function backtestBiblicalFull() {
    var loadingDiv = document.createElement('div');
    loadingDiv.id = 'biblicalFullLoading';
    loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 9999; text-align: center; min-width: 400px;';
    loadingDiv.innerHTML = '<div style="font-size: 24px; margin-bottom: 10px;"></div><div style="font-size: 14px; font-weight: 600;">Loading Full SPY History (1993-2025)...</div><div id="biblicalFullProgress" style="font-size: 12px; color: #666; margin-top: 10px;">Fetching 32 years of data...</div>';
    document.body.appendChild(loadingDiv);

    // Load SPY_full.csv
    fetch('data/SPY_full.csv')
        .then(function(response) {
            if (!response.ok) throw new Error('SPY_full.csv not found. Run the download script first.');
            return response.text();
        })
        .then(function(csvText) {
            var prog = document.getElementById('biblicalFullProgress');
            if (prog) prog.textContent = 'Parsing data...';

            var lines = csvText.trim().split('\n');
            var headers = lines[0].split(',');
            var fullData = [];

            for (var i = 1; i < lines.length; i++) {
                var parts = lines[i].split(',');
                if (parts.length >= 6) {
                    fullData.push({
                        Date: parts[0],
                        Open: parts[1],
                        High: parts[2],
                        Low: parts[3],
                        Close: parts[4],
                        Volume: parts[5]
                    });
                }
            }

            console.log('Loaded ' + fullData.length + ' rows of full SPY history');
            if (prog) prog.textContent = 'Running backtest on ' + fullData.length + ' days...';

            // Store in global and run backtest
            window.spyFullData = fullData;

            // Run the biblical backtest with full data
            setTimeout(function() {
                runBiblicalBacktestOnData(fullData, 'SPY (1993-2025)');
            }, 100);
        })
        .catch(function(err) {
            var loadEl = document.getElementById('biblicalFullLoading');
            if (loadEl) loadEl.remove();
            alert('Error loading full data: ' + err.message + '\n\nMake sure SPY_full.csv exists in the data folder.');
        });
}

// Run biblical backtest on provided data array
function runBiblicalBacktestOnData(data, label) {
    if (!data || data.length < 400) {
        alert('Not enough data (need 400+ days)');
        var loadEl = document.getElementById('biblicalFullLoading');
        if (loadEl) loadEl.remove();
        return;
    }

    var prog = document.getElementById('biblicalFullProgress');

    // Biblical cycles (same as before)
    var biblicalCycles = [
        { days: 7, name: '7 Days (Creation)' },
        { days: 12, name: '12 Days (Tribes)' },
        { days: 21, name: '21 Days (37)' },
        { days: 28, name: '28 Days (Lunar)' },
        { days: 40, name: '40 Days (Flood)' },
        { days: 49, name: '49 Days (Jubilee)' },
        { days: 50, name: '50 Days (Pentecost)' },
        { days: 52, name: '52 Days (Weeks)' },
        { days: 60, name: '60 Days (Babylon)' },
        { days: 72, name: '72 Days (Circle)' },
        { days: 90, name: '90 Days (Quarter)' },
        { days: 120, name: '120 Days (1/3 Year)' },
        { days: 144, name: '144 Days (Sacred)' },
        { days: 150, name: '150 Days (Flood)' },
        { days: 180, name: '180 Days (Half)' },
        { days: 216, name: '216 Days (666)' },
        { days: 252, name: '252 Days (Trade Yr)' },
        { days: 270, name: '270 Days (3/4 Yr)' },
        { days: 288, name: '288 Days (2144)' },
        { days: 360, name: '360 Days (Prophetic)' }
    ];

    var results = {};

    // Find pivots (10-day swing points for more signals)
    if (prog) prog.textContent = 'Finding pivots in ' + data.length + ' days...';
    var pivots = [];
    for (var i = 10; i < data.length - 10; i++) {
        var high = parseFloat(data[i].High);
        var low = parseFloat(data[i].Low);
        var isHigh = true, isLow = true;

        for (var j = i - 10; j <= i + 10; j++) {
            if (j === i) continue;
            if (parseFloat(data[j].High) > high) isHigh = false;
            if (parseFloat(data[j].Low) < low) isLow = false;
        }

        if (isHigh) pivots.push({ type: 'HIGH', index: i, date: data[i].Date });
        if (isLow) pivots.push({ type: 'LOW', index: i, date: data[i].Date });
    }

    console.log('Found ' + pivots.length + ' pivots in full history');

    // Test each cycle
    if (prog) prog.textContent = 'Testing ' + biblicalCycles.length + ' cycles across ' + pivots.length + ' pivots...';

    for (var c = 0; c < biblicalCycles.length; c++) {
        var cycle = biblicalCycles[c];
        results[cycle.days] = { name: cycle.name, reversals: 0, total: 0 };

        for (var p = 0; p < pivots.length; p++) {
            var pivot = pivots[p];
            var pivotDate = new Date(pivot.date);

            for (var i = pivot.index + 1; i < data.length - 5; i++) {
                var currentDate = new Date(data[i].Date);
                var daysDiff = Math.floor((currentDate - pivotDate) / (1000 * 60 * 60 * 24));

                if (Math.abs(daysDiff - cycle.days) <= 2) {
                    var price = parseFloat(data[i].Close);
                    var futurePrice = parseFloat(data[i + 5].Close);
                    var priorPrice = parseFloat(data[i - 5].Close);

                    if (!price || !futurePrice || !priorPrice) continue;

                    results[cycle.days].total++;

                    var wasUp = price > priorPrice;
                    var wentDown = futurePrice < price * 0.995;
                    var wentUp = futurePrice > price * 1.005;

                    if ((wasUp && wentDown) || (!wasUp && wentUp)) {
                        results[cycle.days].reversals++;
                    }

                    break;
                }

                if (daysDiff > cycle.days + 5) break;
            }
        }
    }

    // Remove loading
    var loadEl = document.getElementById('biblicalFullLoading');
    if (loadEl) loadEl.remove();

    // Rank results
    var ranked = [];
    for (var days in results) {
        var r = results[days];
        var pct = r.total > 0 ? Math.round(r.reversals / r.total * 100) : 0;
        ranked.push({ days: days, name: r.name, pct: pct, reversals: r.reversals, total: r.total });
    }
    ranked.sort(function(a, b) { return b.pct - a.pct; });

    // Display results
    var msg = ' GANN BIBLICAL NUMBERS - ' + label + '\n';
    msg += '\n';
    msg += ' ' + data.length + ' trading days | ' + pivots.length + ' pivots found\n\n';

    msg += ' CALENDAR DAY CYCLES (ranked by accuracy):\n';
    msg += '\n';

    for (var i = 0; i < ranked.length; i++) {
        var r = ranked[i];
        var icon = r.pct >= 55 ? '' : (r.pct >= 50 ? '' : '');
        var star = (r.days == 144 || r.days == 49 || r.days == 40 || r.days == 360) ? ' ' : '';
        msg += icon + ' ' + r.days + ' days: ' + r.pct + '% (' + r.reversals + '/' + r.total + ') - ' + r.name + star + '\n';
    }

    msg += '\n TOP 5 CYCLES (32 years of data):\n';
    msg += '\n';
    for (var i = 0; i < Math.min(5, ranked.length); i++) {
        var r = ranked[i];
        msg += (i + 1) + '. ' + r.days + ' days: ' + r.pct + '% (' + r.total + ' signals)\n';
    }

    var edgeCycles = ranked.filter(function(r) { return r.pct >= 55 && r.total >= 50; });
    if (edgeCycles.length > 0) {
        msg += '\n TRADEABLE EDGES (55%+ with 50+ signals):\n';
        msg += '\n';
        for (var i = 0; i < edgeCycles.length; i++) {
            msg += ' ' + edgeCycles[i].days + ' days: ' + edgeCycles[i].pct + '%\n';
        }
    } else {
        msg += '\n No cycles hit 55% with 50+ signals\n';
    }

    console.log('Full Biblical Backtest Results:', ranked);
    alert(msg);

    window.biblicalFullResults = ranked;
    return ranked;
}

// Update Biblical display elements
function updateBiblicalDisplay(calendarRanked, tradingRanked, sq9Biblical) {
    var container = document.getElementById('biblicalResultsContainer');
    if (!container) return;

    var html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">';

    // Top Calendar Cycles
    html += '<div style="background: rgba(139,92,246,0.1); border-radius: 10px; padding: 15px;">';
    html += '<div style="font-size: 12px; font-weight: 600; color: #7c3aed; margin-bottom: 10px;"> Top Calendar Day Cycles</div>';

    for (var i = 0; i < Math.min(8, calendarRanked.length); i++) {
        var r = calendarRanked[i];
        if (r.total < 5) continue;
        var color = r.pct >= 55 ? '#22c55e' : (r.pct >= 50 ? '#eab308' : '#ef4444');
        html += '<div style="display: flex; justify-content: space-between; font-size: 11px; padding: 3px 0; border-bottom: 1px solid rgba(0,0,0,0.05);">';
        html += '<span>' + r.days + ' days</span>';
        html += '<span style="font-weight: 600; color: ' + color + ';">' + r.pct + '%</span>';
        html += '</div>';
    }
    html += '</div>';

    // Top Trading Day Cycles
    html += '<div style="background: rgba(59,130,246,0.1); border-radius: 10px; padding: 15px;">';
    html += '<div style="font-size: 12px; font-weight: 600; color: #2563eb; margin-bottom: 10px;"> Top Trading Day Cycles</div>';

    for (var i = 0; i < Math.min(8, tradingRanked.length); i++) {
        var r = tradingRanked[i];
        if (r.total < 5) continue;
        var color = r.pct >= 55 ? '#22c55e' : (r.pct >= 50 ? '#eab308' : '#ef4444');
        html += '<div style="display: flex; justify-content: space-between; font-size: 11px; padding: 3px 0; border-bottom: 1px solid rgba(0,0,0,0.05);">';
        html += '<span>' + r.days + ' bars - ' + r.name + '</span>';
        html += '<span style="font-weight: 600; color: ' + color + ';">' + r.pct + '%</span>';
        html += '</div>';
    }
    html += '</div>';

    html += '</div>';

    container.innerHTML = html;
}

// Quick test at specific tolerance
function quickSq9Test(tolerance) {
    var tol = tolerance || 0.01;
    var symbols = ['SPY', 'QQQ', 'IWM', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];

    var results = { support: { bounces: 0, tests: 0 }, cycle144: { wins: 0, total: 0 } };

    for (var s = 0; s < symbols.length; s++) {
        var sym = symbols[s];
        var data = allSymbolsData[sym];
        if (!data || data.length < 100) continue;

        var refDate = new Date(data[0].Date.split(' ')[0]);

        for (var i = 30; i < data.length - 5; i++) {
            var price = parseFloat(data[i].Close);
            var futureClose = parseFloat(data[i + 5].Close);
            if (!price || !futureClose) continue;

            var swingHigh = 0;
            for (var k = i - 20; k < i; k++) {
                var kHigh = parseFloat(data[k].High) || 0;
                if (kHigh > swingHigh) swingHigh = kHigh;
            }

            var sqrtHigh = Math.sqrt(swingHigh);
            var sq9Levels = [0.25, 0.5, 0.75, 1.0, 1.5, 2.0];
            var nearSupport = false;

            for (var lvl = 0; lvl < sq9Levels.length; lvl++) {
                var supportLevel = Math.pow(sqrtHigh - sq9Levels[lvl], 2);
                if (supportLevel > 0 && Math.abs(price - supportLevel) / price < tol) nearSupport = true;
            }

            var currentDate = new Date(data[i].Date.split(' ')[0]);
            var daysSinceRef = Math.floor((currentDate - refDate) / (1000 * 60 * 60 * 24));
            var near144Turn = (daysSinceRef % 144) <= 3 || (144 - (daysSinceRef % 144)) <= 3;

            if (nearSupport) {
                results.support.tests++;
                if (futureClose > price) results.support.bounces++;
            }

            if (near144Turn && nearSupport) {
                results.cycle144.total++;
                if (futureClose > price) results.cycle144.wins++;
            }
        }
    }

    var supportPct = results.support.tests > 0 ? Math.round(results.support.bounces / results.support.tests * 100) : 0;
    var cycle144Pct = results.cycle144.total > 0 ? Math.round(results.cycle144.wins / results.cycle144.total * 100) : 0;

    alert('Quick Test @ ' + (tol * 100) + '% Tolerance\n\n' +
        'Sq9 Support Bounce: ' + supportPct + '% (' + results.support.bounces + '/' + results.support.tests + ')\n' +
        '144-Day + Support: ' + cycle144Pct + '% (' + results.cycle144.wins + '/' + results.cycle144.total + ')');

    return results;
}

// Update the Gann backtest display UI
function updateGannBacktestDisplay(results, pcts) {
    // Update Sq9 Support
    var el = document.getElementById('gannSq9SupportPct');
    if (el) el.textContent = pcts.sq9SupportPct + '%';
    el = document.getElementById('gannSq9SupportStats');
    if (el) el.textContent = results.sq9Support.bounces + '/' + results.sq9Support.tests + ' bounces';

    // Update Sq9 Resistance
    el = document.getElementById('gannSq9ResistPct');
    if (el) el.textContent = pcts.sq9ResistPct + '%';
    el = document.getElementById('gannSq9ResistStats');
    if (el) el.textContent = results.sq9Resistance.rejections + '/' + results.sq9Resistance.tests + ' rejections';

    // Update Combined
    el = document.getElementById('gannCombinedPct');
    if (el) el.textContent = pcts.combinedPct + '%';
    el = document.getElementById('gannCombinedStats');
    if (el) el.textContent = results.combined.wins + '/' + results.combined.total + ' correct';

    // Update Time Cycles
    el = document.getElementById('gannCycle30');
    if (el) el.textContent = pcts.cycle30Pct + '% (' + results.cycle30.reversals + '/' + results.cycle30.total + ')';
    el = document.getElementById('gannCycle45');
    if (el) el.textContent = pcts.cycle45Pct + '% (' + results.cycle45.reversals + '/' + results.cycle45.total + ')';
    el = document.getElementById('gannCycle90');
    if (el) el.textContent = pcts.cycle90Pct + '% (' + results.cycle90.reversals + '/' + results.cycle90.total + ')';
    el = document.getElementById('gannCycle144');
    if (el) el.textContent = pcts.cycle144Pct + '% (' + results.cycle144.reversals + '/' + results.cycle144.total + ')';
    el = document.getElementById('gannCycle180');
    if (el) el.textContent = pcts.cycle180Pct + '% (' + results.cycle180.reversals + '/' + results.cycle180.total + ')';

    // Update total signals
    el = document.getElementById('gannTotalSignals');
    if (el) el.textContent = results.signals.length;
}

// Debug function to check prediction data
function debugPredictionData() {
    var log = getPredictionLog();
    console.log('=== PREDICTION LOG DEBUG ===');
    console.log('Total entries:', log.length);
    console.log('Entries:', log);

    // Check what data is available
    var symbols = ['SPY', 'QQQ', 'IWM'];
    var info = [];

    for (var i = 0; i < symbols.length; i++) {
        var sym = symbols[i];
        var data = allSymbolsData[sym];
        if (data && data.length > 0) {
            var lastBar = data[data.length - 1];
            var lastDate = lastBar.Date ? lastBar.Date.split(' ')[0].split('T')[0] : 'unknown';
            info.push(sym + ': ' + data.length + ' bars, last date: ' + lastDate);
            console.log(sym + ' data:', {
                bars: data.length,
                lastDate: lastDate,
                lastClose: lastBar.Close
            });
        } else {
            info.push(sym + ': NO DATA LOADED');
            console.log(sym + ': NO DATA');
        }
    }

    // Check unverified predictions
    var unverified = log.filter(function(e) { return !e.verified; });
    var verified = log.filter(function(e) { return e.verified; });

    var message = '=== DEBUG INFO ===\n\n';
    message += 'Loaded Data:\n' + info.join('\n') + '\n\n';
    message += 'Predictions:\n';
    message += '- Total: ' + log.length + '\n';
    message += '- Verified: ' + verified.length + '\n';
    message += '- Unverified: ' + unverified.length + '\n';

    if (unverified.length > 0) {
        message += '\nUnverified dates:\n';
        var dates = {};
        unverified.forEach(function(e) {
            var key = e.date + ' (' + e.symbol + ')';
            dates[key] = true;
        });
        message += Object.keys(dates).slice(0, 10).join('\n');
    }

    alert(message);
    console.log('=== END DEBUG ===');
}

// Update prediction log display
function updatePredictionLogDisplay() {
    var log = getPredictionLog();
    var tbody = document.getElementById('predictionLogBody');

    // Filter by selected symbols
    var filteredLog = log;
    if (selectedFilterSymbols !== null && selectedFilterSymbols.length > 0) {
        filteredLog = log.filter(function(entry) {
            return selectedFilterSymbols.indexOf(entry.symbol) !== -1;
        });
    } else if (selectedFilterSymbols !== null && selectedFilterSymbols.length === 0) {
        filteredLog = []; // No symbols selected
    }

    // Calculate summary stats (only verified entries from filtered log)
    var totalVerified = 0;
    var gannWins = 0, gannTotal = 0;
    var sq9Wins = 0, sq9Total = 0;
    var mktWins = 0, mktTotal = 0;
    var alignedWins = 0, alignedTotal = 0;

    for (var i = 0; i < filteredLog.length; i++) {
        var entry = filteredLog[i];
        if (!entry.verified) continue;  // Skip unverified

        totalVerified++;

        // Gann stats (skip HOLD)
        if (entry.gannPred !== 'HOLD') {
            gannTotal++;
            if (entry.gannCorrect) gannWins++;
        }

        // SQ9 stats (skip HOLD and null)
        if (entry.sq9Pred && entry.sq9Pred !== 'HOLD') {
            sq9Total++;
            if (entry.sq9Correct) sq9Wins++;
        }

        // Market stats
        mktTotal++;
        if (entry.mktCorrect) mktWins++;

        // Aligned stats (when both agree)
        if (entry.aligned) {
            alignedTotal++;
            if (entry.gannCorrect && entry.mktCorrect) alignedWins++;
        }
    }

    console.log('Prediction stats - Verified: ' + totalVerified +
        ', Gann: ' + gannWins + '/' + gannTotal +
        ', SQ9: ' + sq9Wins + '/' + sq9Total +
        ', Mkt: ' + mktWins + '/' + mktTotal +
        ', Aligned: ' + alignedWins + '/' + alignedTotal);

    // Update summary cards (show filtered count)
    var el;
    el = document.getElementById('logTotalCount');
    if (el) el.textContent = filteredLog.length + (selectedFilterSymbols !== null ? ' (filtered)' : '');

    el = document.getElementById('logGannAccuracy');
    if (el) el.textContent = gannTotal > 0 ? Math.round(gannWins / gannTotal * 100) + '%' : '--%';

    el = document.getElementById('logSq9Accuracy');
    if (el) el.textContent = sq9Total > 0 ? Math.round(sq9Wins / sq9Total * 100) + '%' : '--%';

    el = document.getElementById('logMktAccuracy');
    if (el) el.textContent = mktTotal > 0 ? Math.round(mktWins / mktTotal * 100) + '%' : '--%';

    el = document.getElementById('logAlignedAccuracy');
    if (el) el.textContent = alignedTotal > 0 ? Math.round(alignedWins / alignedTotal * 100) + '%' : '--%';

    // Update table
    if (!tbody) return;

    if (filteredLog.length === 0) {
        var msg = selectedFilterSymbols !== null && selectedFilterSymbols.length === 0
            ? 'No symbols selected. Use the filter above to select symbols.'
            : (log.length === 0 ? 'No predictions logged yet. Click "Save Today\'s Predictions" to start tracking.' : 'No predictions match the selected symbols.');
        tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 30px; color: #666;">' + msg + '</td></tr>';
        return;
    }

    // Sort filtered log by date descending, then by symbol
    var displayLog = filteredLog.slice(); // Copy array

    displayLog.sort(function(a, b) {
        if (a.date !== b.date) return b.date.localeCompare(a.date);
        return a.symbol.localeCompare(b.symbol);
    });

    // Limit to most recent 50 entries for performance
    displayLog = displayLog.slice(0, 50);

    var rows = displayLog.map(function(entry) {
        var gannColor = entry.gannPred === 'CALL' ? '#22c55e' : (entry.gannPred === 'PUT' ? '#ef4444' : '#eab308');
        var sq9Color = entry.sq9Pred === 'CALL' ? '#22c55e' : (entry.sq9Pred === 'PUT' ? '#ef4444' : '#eab308');
        var mktColor = entry.mktPred === 'CALL' ? '#22c55e' : '#ef4444';
        var alignedIcon = entry.aligned ? '' : '';
        var actualColor = entry.actualMove >= 0 ? '#22c55e' : '#ef4444';
        var actualSign = entry.actualMove >= 0 ? '+' : '';

        var gannCheckIcon = entry.verified ? (entry.gannCorrect ? '' : '') : '';
        var sq9CheckIcon = entry.sq9Pred ? (entry.verified ? (entry.sq9Correct ? '' : '') : '') : '--';
        var mktCheckIcon = entry.verified ? (entry.mktCorrect ? '' : '') : '';

        return '<tr>' +
            '<td style="padding: 8px;">' + entry.date + '</td>' +
            '<td style="padding: 8px; font-weight: 600;">' + entry.symbol + '</td>' +
            '<td style="padding: 8px;">$' + entry.price.toFixed(2) + '</td>' +
            '<td style="padding: 8px; background: rgba(139,92,246,0.05);"><span style="color: ' + gannColor + '; font-weight: 600;">' + entry.gannPred + '</span></td>' +
            '<td style="padding: 8px; background: rgba(59,130,246,0.05);"><span style="color: ' + sq9Color + '; font-weight: 600;">' + (entry.sq9Pred || 'N/A') + '</span></td>' +
            '<td style="padding: 8px; background: rgba(239,68,68,0.05);"><span style="color: ' + mktColor + '; font-weight: 600;">' + entry.mktPred + '</span></td>' +
            '<td style="padding: 8px;">' + alignedIcon + '</td>' +
            '<td style="padding: 8px;">' + (entry.nextDayPrice ? '$' + entry.nextDayPrice.toFixed(2) : '--') + '</td>' +
            '<td style="padding: 8px; color: ' + actualColor + '; font-weight: 600;">' + (entry.actualMove !== null ? actualSign + entry.actualMove + '%' : '--') + '</td>' +
            '<td style="padding: 8px; background: rgba(139,92,246,0.05); font-size: 14px;">' + gannCheckIcon + '</td>' +
            '<td style="padding: 8px; background: rgba(59,130,246,0.05); font-size: 14px;">' + sq9CheckIcon + '</td>' +
            '<td style="padding: 8px; background: rgba(239,68,68,0.05); font-size: 14px;">' + mktCheckIcon + '</td>' +
            '</tr>';
    });

    tbody.innerHTML = rows.join('');

    // Render accuracy chart
    if (typeof renderAccuracyChart === 'function') {
        renderAccuracyChart();
    }
}

// Render cumulative accuracy chart
function renderAccuracyChart() {
    var log = getPredictionLog();
    var chartContainer = document.getElementById('accuracyChartBars');
    var labelsContainer = document.getElementById('accuracyChartLabels');

    if (!chartContainer || !labelsContainer) return;

    // Get verified predictions grouped by date
    var byDate = {};
    for (var i = 0; i < log.length; i++) {
        var entry = log[i];
        if (!entry.verified) continue;

        if (!byDate[entry.date]) {
            byDate[entry.date] = { gannCorrect: 0, gannTotal: 0, sq9Correct: 0, sq9Total: 0, mktCorrect: 0, mktTotal: 0, bothCorrect: 0 };
        }

        if (entry.gannPred !== 'HOLD') {
            byDate[entry.date].gannTotal++;
            if (entry.gannCorrect) byDate[entry.date].gannCorrect++;
        }

        // SQ9 stats
        if (entry.sq9Pred && entry.sq9Pred !== 'HOLD') {
            byDate[entry.date].sq9Total++;
            if (entry.sq9Correct) byDate[entry.date].sq9Correct++;
        }

        byDate[entry.date].mktTotal++;
        if (entry.mktCorrect) byDate[entry.date].mktCorrect++;

        if (entry.gannCorrect && entry.mktCorrect) byDate[entry.date].bothCorrect++;
    }

    var dates = Object.keys(byDate).sort();

    // Show message if no data
    if (dates.length === 0) {
        chartContainer.innerHTML = '<div style="text-align: center; color: #999; font-size: 12px; width: 100%;">No verified predictions yet.<br>Click "Verify Past Predictions" after next trading day.</div>';
        labelsContainer.innerHTML = '';
        return;
    }

    // Take last 14 days max
    dates = dates.slice(-14);

    // Build chart bars
    var barsHTML = '';

    for (var d = 0; d < dates.length; d++) {
        var date = dates[d];
        var data = byDate[date];

        var gannPct = data.gannTotal > 0 ? Math.round(data.gannCorrect / data.gannTotal * 100) : 0;
        var sq9Pct = data.sq9Total > 0 ? Math.round(data.sq9Correct / data.sq9Total * 100) : 0;
        var mktPct = data.mktTotal > 0 ? Math.round(data.mktCorrect / data.mktTotal * 100) : 0;
        var bothPct = data.mktTotal > 0 ? Math.round(data.bothCorrect / data.mktTotal * 100) : 0;

        // Bar heights (max 150px)
        var gannHeight = Math.max(5, gannPct * 1.5);
        var sq9Height = Math.max(5, sq9Pct * 1.5);
        var mktHeight = Math.max(5, mktPct * 1.5);
        var bothHeight = Math.max(5, bothPct * 1.5);

        var dateLabel = date.slice(5); // MM-DD format

        barsHTML += '<div style="display: flex; flex-direction: column; align-items: center; gap: 2px; flex: 1;">' +
            '<div style="display: flex; gap: 1px; align-items: flex-end; height: 150px;">' +
                '<div style="width: 9px; height: ' + gannHeight + 'px; background: #8b5cf6; border-radius: 2px 2px 0 0;" title="Gann: ' + gannPct + '%"></div>' +
                '<div style="width: 9px; height: ' + sq9Height + 'px; background: #3b82f6; border-radius: 2px 2px 0 0;" title="SQ9: ' + sq9Pct + '%"></div>' +
                '<div style="width: 9px; height: ' + mktHeight + 'px; background: #ef4444; border-radius: 2px 2px 0 0;" title="Market: ' + mktPct + '%"></div>' +
                '<div style="width: 9px; height: ' + bothHeight + 'px; background: #22c55e; border-radius: 2px 2px 0 0;" title="Both: ' + bothPct + '%"></div>' +
            '</div>' +
            '<div style="font-size: 8px; color: #666; transform: rotate(-45deg); white-space: nowrap;">' + dateLabel + '</div>' +
        '</div>';
    }

    chartContainer.innerHTML = barsHTML;

    // Calculate cumulative stats
    var totalGannCorrect = 0, totalGannTotal = 0;
    var totalSq9Correct = 0, totalSq9Total = 0;
    var totalMktCorrect = 0, totalMktTotal = 0;

    for (var d = 0; d < dates.length; d++) {
        var data = byDate[dates[d]];
        totalGannCorrect += data.gannCorrect;
        totalGannTotal += data.gannTotal;
        totalSq9Correct += data.sq9Correct;
        totalSq9Total += data.sq9Total;
        totalMktCorrect += data.mktCorrect;
        totalMktTotal += data.mktTotal;
    }

    var cumGannPct = totalGannTotal > 0 ? Math.round(totalGannCorrect / totalGannTotal * 100) : 0;
    var cumSq9Pct = totalSq9Total > 0 ? Math.round(totalSq9Correct / totalSq9Total * 100) : 0;
    var cumMktPct = totalMktTotal > 0 ? Math.round(totalMktCorrect / totalMktTotal * 100) : 0;

    labelsContainer.innerHTML = '<div style="width: 100%; display: flex; justify-content: center; gap: 20px; padding-top: 10px; flex-wrap: wrap;">' +
        '<span>Gann: <strong style="color: #8b5cf6;">' + cumGannPct + '%</strong> (' + totalGannCorrect + '/' + totalGannTotal + ')</span>' +
        '<span>SQ9: <strong style="color: #3b82f6;">' + cumSq9Pct + '%</strong> (' + totalSq9Correct + '/' + totalSq9Total + ')</span>' +
        '<span>Market: <strong style="color: #ef4444;">' + cumMktPct + '%</strong> (' + totalMktCorrect + '/' + totalMktTotal + ')</span>' +
        '</div>';

    // Update running totals display
    var el;
    el = document.getElementById('runningGannAccuracy');
    if (el) el.textContent = cumGannPct + '%';

    el = document.getElementById('runningGannRecord');
    if (el) el.textContent = totalGannCorrect + '/' + totalGannTotal + ' correct';

    el = document.getElementById('runningSq9Accuracy');
    if (el) el.textContent = cumSq9Pct + '%';

    el = document.getElementById('runningSq9Record');
    if (el) el.textContent = totalSq9Correct + '/' + totalSq9Total + ' correct';

    el = document.getElementById('runningMktAccuracy');
    if (el) el.textContent = cumMktPct + '%';

    el = document.getElementById('runningMktRecord');
    if (el) el.textContent = totalMktCorrect + '/' + totalMktTotal + ' correct';

    el = document.getElementById('runningLeader');
    if (el) {
        if (cumGannPct > cumMktPct) {
            el.textContent = ' Gann';
            el.style.color = '#8b5cf6';
        } else if (cumMktPct > cumGannPct) {
            el.textContent = ' Market';
            el.style.color = '#ef4444';
        } else {
            el.textContent = ' Tied';
            el.style.color = '#666';
        }
    }

    el = document.getElementById('runningLeaderMargin');
    if (el) {
        var margin = Math.abs(cumGannPct - cumMktPct);
        if (totalGannTotal > 0 && totalMktTotal > 0) {
            el.textContent = 'by ' + margin + '% margin';
        } else {
            el.textContent = 'Need more data';
        }
    }

    console.log('Accuracy chart rendered with ' + dates.length + ' dates');
}

// ==========================================
// INITIALIZE PERFORMANCE TRACKER
// ==========================================

// Add performance tracker tab click handler
function initPerformanceTracker() {
    // Initialize symbol filter checkboxes
    if (typeof initSymbolFilter === 'function') {
        initSymbolFilter();
    }

    // Initialize agent prediction display
    if (typeof updateAgentPredictionDisplay === 'function') {
        updateAgentPredictionDisplay();
    }

    var perfTab = document.querySelector('[data-tab="performance-tracker"]');
    if (perfTab) {
        perfTab.addEventListener('click', function() {
            setTimeout(function() {
                if (typeof initSymbolFilter === 'function') {
                    initSymbolFilter();
                }
                if (typeof updateBacktestDisplay === 'function') {
                    updateBacktestDisplay();
                }
                if (typeof updatePredictionLogDisplay === 'function') {
                    updatePredictionLogDisplay();
                }
                if (typeof updateAgentPredictionDisplay === 'function') {
                    updateAgentPredictionDisplay();
                }
            }, 100);
        });
    }
}

// Initialize on DOMContentLoaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPerformanceTracker);
} else {
    initPerformanceTracker();
}


function updateDashboard() {
    if (!currentData || !currentData.length) { console.warn("updateDashboard: No data"); return; }
    const lat = currentData[currentData.length - 1];
    const prev = currentData[currentData.length - 2] || lat;
    const price = parseFloat(lat.Close) || 0;
    const prevPrice = parseFloat(prev.Close) || price;
    const chg = price - prevPrice;
    const pct = prevPrice ? (chg / prevPrice * 100) : 0;
    const atr = parseFloat(lat.ATR) || 5;
    const bias = (lat.Bias || '').toUpperCase();

    // Header ticker
    var el=document.getElementById('tickerPrice');if(el)el.textContent = '$' + price.toFixed(2);
    var el=document.getElementById('tickerChange');if(el)el.textContent = (chg >= 0 ? '+' : '') + '$' + Math.abs(chg).toFixed(2);
    el=document.getElementById('tickerChange');if(el)el.className = 'ticker-change ' + (chg >= 0 ? 'positive' : 'negative');
    var el=document.getElementById('tickerPct');if(el)el.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';

    // Metrics
    var el=document.getElementById('currentPrice');if(el)el.textContent = '$' + price.toFixed(2);
    var el=document.getElementById('priceSource');if(el)el.textContent = `${currentData.length} bars`;
    var el=document.getElementById('dailyChange');if(el)el.textContent = (chg >= 0 ? '+' : '') + '$' + Math.abs(chg).toFixed(2);
    el=document.getElementById('dailyChange');if(el)el.className = 'metric-value ' + (chg >= 0 ? 'positive' : 'negative');
    var el=document.getElementById('changePct');if(el)el.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
    var el=document.getElementById('volumeDisplay');if(el)el.textContent = ((parseFloat(lat.Volume) || 0) / 1e6).toFixed(1) + 'M';
    var el=document.getElementById('signalStatus');if(el)el.textContent = bias || 'HOLD';
    var el=document.getElementById('signalConf');if(el)el.textContent = `${lat.PriceConfluence || 0}/4`;
    var el=document.getElementById('atrDisplay');if(el)el.textContent = '$' + atr.toFixed(2);

    // Date/Time
    const dateStr = lat.Date || '';
    const [datePart, timePart] = dateStr.includes('T') ? dateStr.split('T') : [dateStr, 'EOD'];
    var el=document.getElementById('dataDate');if(el)el.textContent = datePart;
    var el=document.getElementById('dataTime');if(el)el.textContent = timePart.replace('Z', '');

    // AI Context
    var el=document.getElementById('aiContextPrice');if(el)el.textContent = '$' + price.toFixed(2);
    var el=document.getElementById('aiContextSignal');if(el)el.textContent = bias || 'HOLD';
    var el=document.getElementById('aiContextConsensus');if(el)el.textContent = `${lat.PriceConfluence || 0}/4`;

    // Signals
    const ip = TRADING_PARAMS.intraday;
    const sp = TRADING_PARAMS.swing;
    
    var el=document.getElementById('intradaySignal');if(el)el.textContent = bias || 'HOLD';
    el=document.getElementById('intradaySignal');if(el)el.className = `badge badge-${bias === 'CALL' ? 'success' : (bias === 'PUT' ? 'danger' : 'warning')}`;
    var el=document.getElementById('intradayEntry');if(el)el.textContent = '$' + price.toFixed(2);
    var el=document.getElementById('intradayStop');if(el)el.textContent = '$' + (bias === 'PUT' ? (price + atr * ip.stopATR) : (price - atr * ip.stopATR)).toFixed(2);
    var el=document.getElementById('intradayT1');if(el)el.textContent = '$' + (bias === 'PUT' ? (price - atr * ip.target1ATR) : (price + atr * ip.target1ATR)).toFixed(2);
    var el=document.getElementById('intradayT2');if(el)el.textContent = '$' + (bias === 'PUT' ? (price - atr * ip.target2ATR) : (price + atr * ip.target2ATR)).toFixed(2);
    var el=document.getElementById('intradayStrike');if(el)el.textContent = '$' + getProperStrike(price) + ' ' + (bias || 'CALL');
    
    var el=document.getElementById('swingSignal');if(el)el.textContent = bias || 'HOLD';
    el=document.getElementById('swingSignal');if(el)el.className = `badge badge-${bias === 'CALL' ? 'success' : (bias === 'PUT' ? 'danger' : 'warning')}`;
    var el=document.getElementById('swingEntry');if(el)el.textContent = '$' + (price - 2).toFixed(0) + '-' + (price + 2).toFixed(0);
    var el=document.getElementById('swingStop');if(el)el.textContent = '$' + (bias === 'PUT' ? (price + atr * sp.stopATR) : (price - atr * sp.stopATR)).toFixed(2);
    var el=document.getElementById('swingT1');if(el)el.textContent = '$' + (bias === 'PUT' ? (price - atr * sp.target1ATR) : (price + atr * sp.target1ATR)).toFixed(2);
    var el=document.getElementById('swingT2');if(el)el.textContent = '$' + (bias === 'PUT' ? (price - atr * sp.target2ATR) : (price + atr * sp.target2ATR)).toFixed(2);
    var el=document.getElementById('swingStrike');if(el)el.textContent = '$' + getProperStrike(price) + ' ' + (bias || 'CALL');

    updateReferenceData();
    updateFibonacci();
    updateSignalsFibonacci();
}

function updateReferenceData() {
    const lat = currentData[currentData.length - 1];
    const yearData = currentData.slice(-252);
    
    const highs = yearData.map(d => parseFloat(d.High) || 0);
    const lows = yearData.map(d => parseFloat(d.Low) || 0);
    
    var el=document.getElementById('week52High');if(el)el.textContent = '$' + Math.max(...highs).toFixed(2);
    var el=document.getElementById('week52Low');if(el)el.textContent = '$' + Math.min(...lows).toFixed(2);
    var el=document.getElementById('todayHigh');if(el)el.textContent = '$' + (parseFloat(lat.High) || 0).toFixed(2);
    var el=document.getElementById('todayLow');if(el)el.textContent = '$' + (parseFloat(lat.Low) || 0).toFixed(2);
    
    const todayVol = parseFloat(lat.Volume) || 0;
    const volumes20 = currentData.slice(-20).map(d => parseFloat(d.Volume) || 0);
    const avgVol = volumes20.reduce((a, b) => a + b, 0) / 20;
    
    var el=document.getElementById('avgVolume20');if(el)el.textContent = (avgVol / 1e6).toFixed(1) + 'M';
    var el=document.getElementById('volumeVsAvg');if(el)el.textContent = ((todayVol/avgVol - 1) * 100).toFixed(0) + '%';
    var el=document.getElementById('volumeVsAvgSmall');if(el)el.textContent = ((todayVol/avgVol - 1) * 100).toFixed(0) + '% vs avg';
}

function updateFibonacci() {
    const recent = currentData.slice(-60);
    const highs = recent.map(d => parseFloat(d.High) || 0);
    const lows = recent.map(d => parseFloat(d.Low) || 0);
    const swingHigh = Math.max(...highs);
    const swingLow = Math.min(...lows);
    const price = parseFloat(currentData[currentData.length - 1].Close) || 0;
    const range = swingHigh - swingLow;
    
    const fib382 = swingHigh - (range * 0.382);
    const fib500 = swingHigh - (range * 0.500);
    const fib618 = swingHigh - (range * 0.618);
    const fib100 = swingHigh;
    const fib1272 = swingLow + (range * 1.272);
    const fib1618 = swingLow + (range * 1.618);
    
    var el=document.getElementById('fibR1');if(el)el.textContent = '$' + fib100.toFixed(2);
    var el=document.getElementById('fibR2');if(el)el.textContent = '$' + fib1272.toFixed(2);
    var el=document.getElementById('fibR3');if(el)el.textContent = '$' + fib1618.toFixed(2);
    var el=document.getElementById('fibS1');if(el)el.textContent = '$' + fib382.toFixed(2);
    var el=document.getElementById('fibS2');if(el)el.textContent = '$' + fib500.toFixed(2);
    var el=document.getElementById('fibS3');if(el)el.textContent = '$' + fib618.toFixed(2);
    
    var el=document.getElementById('chartR1');if(el)el.textContent = '$' + fib100.toFixed(2);
    var el=document.getElementById('chartR2');if(el)el.textContent = '$' + fib1272.toFixed(2);
    var el=document.getElementById('chartR3');if(el)el.textContent = '$' + fib1618.toFixed(2);
    var el=document.getElementById('chartS1');if(el)el.textContent = '$' + fib382.toFixed(2);
    var el=document.getElementById('chartS2');if(el)el.textContent = '$' + fib500.toFixed(2);
    var el=document.getElementById('chartS3');if(el)el.textContent = '$' + fib618.toFixed(2);
    
    let zone = 'NEUTRAL';
    if (price > fib100) zone = 'BREAKOUT';
    else if (price > fib382) zone = 'STRONG';
    else if (price > fib500) zone = 'PULLBACK';
    else zone = 'DEEP';
    var el=document.getElementById('fibZone');if(el)el.textContent = zone;
    
    const fastSMA = parseFloat(currentData[currentData.length-1].FastSMA) || price;
    const slowSMA = parseFloat(currentData[currentData.length-1].SlowSMA) || price;
    const trend = fastSMA > slowSMA ? 'BULLISH' : 'BEARISH';
    var el=document.getElementById('trendBadge');if(el)el.textContent = trend;
    el=document.getElementById('trendBadge');if(el)el.className = `badge badge-${trend === 'BULLISH' ? 'success' : 'danger'}`;
    
    window.fibLevels = { fib100, fib1272, fib1618, fib382, fib500, fib618, swingHigh, swingLow };
}

// FIXED: Bar Count now uses currentSymbol - NEWEST FIRST
function updateBarCountAnalysis() {
    const barCount = parseInt(document.getElementById('barCountSelect')?.value || 20);

    // Use current symbol's data
    const symbolData = currentData;
    if (!symbolData || symbolData.length < 1) return;
    const actualBars = Math.min(barCount, symbolData.length);

    const data = symbolData.slice(-actualBars);
    const table = document.getElementById('barCountTable');
    if (!table) return;

    // Update the symbol display
    var el=document.getElementById('barCountCurrentSymbol');if(el)el.textContent = currentSymbol;

    // Build rows array (oldest to newest for correct bar count calculation)
    let rows = [];
    let baseCount = 0, gannCount = 0, dqnCount = 0, waveCount = 0;

    data.forEach((d, i) => {
        const o = parseFloat(d.Open) || 0;
        const c = parseFloat(d.Close) || 0;
        const isBullish = c >= o;

        if (isBullish) {
            baseCount = baseCount >= 0 ? baseCount + 1 : 1;
            gannCount = gannCount >= 0 ? gannCount + 1 : 1;
            dqnCount = dqnCount >= 0 ? dqnCount + 1 : 1;
            waveCount = waveCount >= 0 ? waveCount + 1 : 1;
        } else {
            baseCount = baseCount <= 0 ? baseCount - 1 : -1;
            gannCount = gannCount <= 0 ? gannCount - 1 : -1;
            dqnCount = dqnCount <= 0 ? dqnCount - 1 : -1;
            waveCount = waveCount <= 0 ? waveCount - 1 : -1;
        }

        const avg = (baseCount + gannCount + dqnCount + waveCount) / 4;
        const date = (d.Date || '').split('T')[0].slice(5);

        rows.push({
            date, o, high: parseFloat(d.High)||0, low: parseFloat(d.Low)||0, c,
            isBullish, baseCount, gannCount, dqnCount, waveCount, avg
        });
    });

    // Reverse to show newest first, then build HTML with correct row numbers
    rows.reverse();
    let html = '';
    rows.forEach((r, i) => {
        html += `<tr>
            <td>${i + 1}</td>
            <td>${r.date}</td>
            <td style="font-size:10px;">${r.o.toFixed(0)}/${r.high.toFixed(0)}/${r.low.toFixed(0)}/${r.c.toFixed(0)}</td>
            <td>${r.isBullish ? '' : ''}</td>
            <td class="${r.baseCount > 0 ? 'positive' : 'negative'}">${r.baseCount > 0 ? '+' : ''}${r.baseCount}</td>
            <td class="${r.gannCount > 0 ? 'positive' : 'negative'}">${r.gannCount > 0 ? '+' : ''}${r.gannCount}</td>
            <td class="${r.dqnCount > 0 ? 'positive' : 'negative'}">${r.dqnCount > 0 ? '+' : ''}${r.dqnCount}</td>
            <td class="${r.waveCount > 0 ? 'positive' : 'negative'}">${r.waveCount > 0 ? '+' : ''}${r.waveCount}</td>
            <td><span class="badge badge-${r.avg > 2 ? 'success' : (r.avg < -2 ? 'danger' : 'warning')}">${r.avg.toFixed(1)}</span></td>
        </tr>`;
    });

    table.innerHTML = html;
    
    var el=document.getElementById('baseBarCount');if(el)el.textContent = (baseCount > 0 ? '+' : '') + baseCount;
    document.getElementById('baseBarCount').style.color = baseCount > 0 ? 'var(--success)' : 'var(--danger)';
    var el=document.getElementById('gannBarCount');if(el)el.textContent = (gannCount > 0 ? '+' : '') + gannCount;
    document.getElementById('gannBarCount').style.color = gannCount > 0 ? 'var(--success)' : 'var(--danger)';
    var el=document.getElementById('dqnBarCount');if(el)el.textContent = (dqnCount > 0 ? '+' : '') + dqnCount;
    document.getElementById('dqnBarCount').style.color = dqnCount > 0 ? 'var(--success)' : 'var(--danger)';
    var el=document.getElementById('waveBarCount');if(el)el.textContent = (waveCount > 0 ? '+' : '') + waveCount;
    document.getElementById('waveBarCount').style.color = waveCount > 0 ? 'var(--success)' : 'var(--danger)';

    // Also update historical averages when bar count analysis updates
    updateHistoricalAverages();
}

// Calculate and update Historical Averages for all symbols
async function updateHistoricalAverages() {
    const symbols = ['SPY', 'QQQ', 'IWM', 'XLF', 'XLE', 'XLK'];

    for (const symbol of symbols) {
        try {
            // Try to get data from allSymbolsData or fetch it
            let data = allSymbolsData[symbol];

            if (!data || data.length < 20) {
                // Try to fetch the CSV
                let response = await fetch('data/' + symbol + '.csv').catch(() => null);
                if (response?.ok) {
                    const text = await response.text();
                    data = parseCSV(text);
                }
            }

            if (!data || data.length < 20) continue;

            // Get last 20 bars
            const last20 = data.slice(-20);

            // Calculate OH, OL, OC, Range for each bar
            let sumOH = 0, sumOL = 0, sumOC = 0, sumRange = 0;
            let maxOH = 0, maxOL = 0;

            last20.forEach(bar => {
                const open = parseFloat(bar.Open) || 0;
                const high = parseFloat(bar.High) || 0;
                const low = parseFloat(bar.Low) || 0;
                const close = parseFloat(bar.Close) || 0;

                const oh = high - open;  // Open to High (always positive)
                const ol = open - low;   // Open to Low (always positive)
                const oc = close - open; // Open to Close (can be negative)
                const range = high - low;

                sumOH += oh;
                sumOL += ol;
                sumOC += oc;
                sumRange += range;

                if (oh > maxOH) maxOH = oh;
                if (ol > maxOL) maxOL = ol;
            });

            const avgOH = sumOH / 20;
            const avgOL = sumOL / 20;
            const avgOC = sumOC / 20;
            const avgRange = sumRange / 20;
            const callTarget = avgOH * 0.85;
            const putTarget = avgOL * 0.85;

            // Update table cells
            const symLower = symbol.toLowerCase();
            const updateEl = (id, value, prefix = '') => {
                const el = document.getElementById(id);
                if (el) el.textContent = prefix + '$' + value.toFixed(2);
            };

            updateEl(symLower + 'AvgOH', avgOH, '+');
            updateEl(symLower + 'MaxOH', maxOH, '+');
            updateEl(symLower + 'AvgOL', avgOL, '-');
            updateEl(symLower + 'MaxOL', maxOL, '-');
            updateEl(symLower + 'AvgOC', Math.abs(avgOC), avgOC >= 0 ? '+' : '-');
            updateEl(symLower + 'AvgRange', avgRange);
            updateEl(symLower + 'CallTarget', callTarget, '+');
            updateEl(symLower + 'PutTarget', putTarget, '-');

        } catch (e) {
            console.log('Error calculating averages for ' + symbol + ':', e);
        }
    }

    // Update Today vs Average section for current symbol
    updateTodayVsAverage();
}

// Update Today vs Average comparison for current symbol
function updateTodayVsAverage() {
    if (!currentData || currentData.length < 21) return;

    const last20 = currentData.slice(-21, -1); // Previous 20 bars (not including today)
    const today = currentData[currentData.length - 1];

    // Calculate averages from previous 20 bars
    let sumOH = 0, sumOL = 0, sumRange = 0;

    last20.forEach(bar => {
        const open = parseFloat(bar.Open) || 0;
        const high = parseFloat(bar.High) || 0;
        const low = parseFloat(bar.Low) || 0;

        sumOH += (high - open);
        sumOL += (open - low);
        sumRange += (high - low);
    });

    const avgOH = sumOH / 20;
    const avgOL = sumOL / 20;
    const avgRange = sumRange / 20;

    // Today's values
    const todayOpen = parseFloat(today.Open) || 0;
    const todayHigh = parseFloat(today.High) || 0;
    const todayLow = parseFloat(today.Low) || 0;

    const todayOH = todayHigh - todayOpen;
    const todayOL = todayOpen - todayLow;
    const todayRange = todayHigh - todayLow;

    // Calculate percentages
    const ohPct = avgOH > 0 ? (todayOH / avgOH) * 100 : 0;
    const olPct = avgOL > 0 ? (todayOL / avgOL) * 100 : 0;
    const rangePct = avgRange > 0 ? (todayRange / avgRange) * 100 : 0;

    // Update OH box
    const ohPctEl = document.getElementById('todayOHpct');
    const ohDetailEl = document.getElementById('todayOHdetail');
    const ohStatusEl = document.getElementById('todayOHstatus');
    const ohBoxEl = document.getElementById('todayOHvsAvgBox');

    if (ohPctEl) ohPctEl.textContent = ohPct.toFixed(0) + '%';
    if (ohDetailEl) ohDetailEl.textContent = '$' + todayOH.toFixed(2) + ' of $' + avgOH.toFixed(2) + ' avg';

    if (ohStatusEl && ohBoxEl) {
        if (ohPct < 50) {
            ohBoxEl.style.background = 'rgba(34,197,94,0.1)';
            ohStatusEl.style.color = '#22c55e';
            ohStatusEl.textContent = 'Room to run - upside potential';
        } else if (ohPct < 85) {
            ohBoxEl.style.background = 'rgba(234,179,8,0.1)';
            ohStatusEl.style.color = '#eab308';
            ohStatusEl.textContent = 'Approaching avg - watch closely';
        } else if (ohPct < 100) {
            ohBoxEl.style.background = 'rgba(249,115,22,0.1)';
            ohStatusEl.style.color = '#f97316';
            ohStatusEl.textContent = 'Nearing avg - consider taking profits';
        } else {
            ohBoxEl.style.background = 'rgba(239,68,68,0.1)';
            ohStatusEl.style.color = '#ef4444';
            ohStatusEl.textContent = 'Exceeded avg - extended move';
        }
    }

    // Update OL box
    const olPctEl = document.getElementById('todayOLpct');
    const olDetailEl = document.getElementById('todayOLdetail');
    const olStatusEl = document.getElementById('todayOLstatus');
    const olBoxEl = document.getElementById('todayOLvsAvgBox');

    if (olPctEl) olPctEl.textContent = olPct.toFixed(0) + '%';
    if (olDetailEl) olDetailEl.textContent = '$' + todayOL.toFixed(2) + ' of $' + avgOL.toFixed(2) + ' avg';

    if (olStatusEl && olBoxEl) {
        if (olPct < 50) {
            olBoxEl.style.background = 'rgba(34,197,94,0.1)';
            olStatusEl.style.color = '#22c55e';
            olStatusEl.textContent = 'Room to fall - downside potential';
        } else if (olPct < 85) {
            olBoxEl.style.background = 'rgba(234,179,8,0.1)';
            olStatusEl.style.color = '#eab308';
            olStatusEl.textContent = 'Approaching avg - watch closely';
        } else if (olPct < 100) {
            olBoxEl.style.background = 'rgba(249,115,22,0.1)';
            olStatusEl.style.color = '#f97316';
            olStatusEl.textContent = 'Nearing avg - consider covering puts';
        } else {
            olBoxEl.style.background = 'rgba(239,68,68,0.1)';
            olStatusEl.style.color = '#ef4444';
            olStatusEl.textContent = 'Exceeded avg - strong selling pressure';
        }
    }

    // Update Range box
    const rangePctEl = document.getElementById('todayRangePct');
    const rangeDetailEl = document.getElementById('todayRangeDetail');
    const rangeStatusEl = document.getElementById('todayRangeStatus');
    const rangeBoxEl = document.getElementById('todayRangevsAvgBox');

    if (rangePctEl) rangePctEl.textContent = rangePct.toFixed(0) + '%';
    if (rangeDetailEl) rangeDetailEl.textContent = '$' + todayRange.toFixed(2) + ' of $' + avgRange.toFixed(2) + ' avg';

    if (rangeStatusEl && rangeBoxEl) {
        if (rangePct < 50) {
            rangeBoxEl.style.background = 'rgba(59,130,246,0.1)';
            rangeStatusEl.style.color = '#3b82f6';
            rangeStatusEl.textContent = 'Low volatility - quiet day';
        } else if (rangePct < 85) {
            rangeBoxEl.style.background = 'rgba(34,197,94,0.1)';
            rangeStatusEl.style.color = '#22c55e';
            rangeStatusEl.textContent = 'Normal volatility day';
        } else if (rangePct < 120) {
            rangeBoxEl.style.background = 'rgba(234,179,8,0.1)';
            rangeStatusEl.style.color = '#eab308';
            rangeStatusEl.textContent = 'Above average volatility';
        } else {
            rangeBoxEl.style.background = 'rgba(239,68,68,0.1)';
            rangeStatusEl.style.color = '#ef4444';
            rangeStatusEl.textContent = 'High volatility - be cautious';
        }
    }
}

// Update Signals Tab Fibonacci Table with dynamic data
function updateSignalsFibonacci() {
    if (!currentData || currentData.length < 60) return;

    const tbody = document.getElementById('sigFibTable');
    const proximityEl = document.getElementById('sigFibProximity');
    const symbolEl = document.getElementById('sigFibSymbol');
    if (!tbody) return;

    // Update symbol display
    if (symbolEl) symbolEl.textContent = currentSymbol;

    // Calculate Fibonacci levels from recent data
    const recent = currentData.slice(-60);
    const highs = recent.map(d => parseFloat(d.High) || 0);
    const lows = recent.map(d => parseFloat(d.Low) || 0);
    const swingHigh = Math.max(...highs);
    const swingLow = Math.min(...lows);
    const currentPrice = parseFloat(currentData[currentData.length - 1].Close) || 0;
    const range = swingHigh - swingLow;

    // Find swing high/low dates
    const swingHighIdx = highs.indexOf(swingHigh);
    const swingLowIdx = lows.indexOf(swingLow);
    const swingHighDateParsed = recent[swingHighIdx]?.Date ? parseCSVDate(recent[swingHighIdx].Date) : null;
    const swingLowDateParsed = recent[swingLowIdx]?.Date ? parseCSVDate(recent[swingLowIdx].Date) : null;
    const swingHighDate = swingHighDateParsed ? swingHighDateParsed.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '--';
    const swingLowDate = swingLowDateParsed ? swingLowDateParsed.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '--';

    // Fibonacci levels with implications
    const levels = [
        { name: 'R3 (161.8%)', price: swingLow + (range * 1.618), type: 'resistance', tf: 'Weekly', implication: 'Extended - Take Profits' },
        { name: 'R2 (127.2%)', price: swingLow + (range * 1.272), type: 'resistance', tf: 'Daily', implication: 'Strong Resistance' },
        { name: 'R1 (100%)', price: swingHigh, type: 'resistance', tf: 'Daily', implication: 'First Target', dateSet: swingHighDate },
        { name: 'PIVOT', price: (swingHigh + swingLow) / 2, type: 'pivot', tf: 'Daily', implication: 'Key Decision Level' },
        { name: 'S1 (38.2%)', price: swingHigh - (range * 0.382), type: 'support', tf: 'Daily', implication: 'First Support' },
        { name: 'S2 (50.0%)', price: swingHigh - (range * 0.500), type: 'support', tf: 'Daily', implication: 'Key Support - Add Zone' },
        { name: 'S3 (61.8%)', price: swingHigh - (range * 0.618), type: 'support', tf: 'Weekly', implication: 'Deep Support - Reversal', dateSet: swingLowDate }
    ];

    // Find closest level
    let closestLevel = null;
    let closestDistance = Infinity;
    levels.forEach(level => {
        const dist = Math.abs(currentPrice - level.price);
        if (dist < closestDistance) {
            closestDistance = dist;
            closestLevel = level;
        }
    });

    const closestPct = closestLevel ? ((closestLevel.price - currentPrice) / currentPrice * 100).toFixed(1) : 0;

    // Update proximity alert
    if (proximityEl && closestLevel) {
        const direction = closestLevel.price > currentPrice ? 'below' : 'above';
        const levelType = closestLevel.type === 'resistance' ? '' : closestLevel.type === 'support' ? '' : '';
        proximityEl.innerHTML = `${levelType} <strong>${currentSymbol}</strong> is <strong>${Math.abs(closestPct)}%</strong> away from <strong>${closestLevel.name}</strong> ($${closestLevel.price.toFixed(2)})`;
        proximityEl.style.color = Math.abs(parseFloat(closestPct)) < 1 ? '#ef4444' : 'inherit';
    }

    // Generate table rows
    let html = '';
    levels.forEach(level => {
        const distance = ((level.price - currentPrice) / currentPrice * 100);
        const distanceStr = distance > 0 ? `+${distance.toFixed(1)}%` : `${distance.toFixed(1)}%`;
        const isClosest = level === closestLevel;
        const isApproaching = isClosest && Math.abs(distance) < 2;

        let rowStyle = '';
        let rowColor = '';
        if (level.type === 'resistance') {
            rowColor = '#22c55e';
            if (isApproaching) rowStyle = 'background: rgba(34,197,94,0.15);';
        } else if (level.type === 'support') {
            rowColor = '#ef4444';
            if (isApproaching) rowStyle = 'background: rgba(239,68,68,0.15);';
        } else {
            rowStyle = 'background: rgba(59,130,246,0.1);';
            rowColor = '#3b82f6';
        }

        const approaching = isApproaching ? '<span class="badge badge-success">YES</span>' : 'NO';
        const dateSet = level.dateSet || '--';

        html += `
            <tr style="${rowStyle} color: ${rowColor};">
                <td><strong>${isClosest ? ' ' : ''}${level.name}</strong></td>
                <td style="font-weight: 600;">$${level.price.toFixed(2)}</td>
                <td>${level.type === 'pivot' ? 'Current' : distanceStr}</td>
                <td>${approaching}</td>
                <td>${dateSet}</td>
                <td>${level.tf}</td>
                <td style="font-size: 10px;">${level.implication}</td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function updateReversalStats() {
    const table = document.getElementById('reversalStatsTable');
    if (!table) return;

    let rows = [];

    // First, always show current symbol
    const symbolsToShow = [currentSymbol];
    // Add other symbols if data is available
    for (const symbol of SYMBOLS) {
        if (symbol !== currentSymbol && allSymbolsData[symbol] && allSymbolsData[symbol].length >= 10) {
            symbolsToShow.push(symbol);
        }
    }

    for (const symbol of symbolsToShow) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 10) continue;

        let bullishRuns = [], bearishRuns = [], currentRun = 0, lastDir = null;

        for (const d of data) {
            const isBullish = parseFloat(d.Close) >= parseFloat(d.Open);

            if (lastDir === null) {
                lastDir = isBullish;
                currentRun = 1;
            } else if (isBullish === lastDir) {
                currentRun++;
            } else {
                if (lastDir) bullishRuns.push(currentRun);
                else bearishRuns.push(currentRun);
                lastDir = isBullish;
                currentRun = 1;
            }
        }

        const avgBullish = bullishRuns.length ? (bullishRuns.reduce((a,b) => a+b, 0) / bullishRuns.length).toFixed(1) : 'N/A';
        const avgBearish = bearishRuns.length ? (bearishRuns.reduce((a,b) => a+b, 0) / bearishRuns.length).toFixed(1) : 'N/A';
        const currentDir = lastDir ? 'Bullish' : 'Bearish';
        const avgForDir = lastDir ? parseFloat(avgBullish) : parseFloat(avgBearish);
        const pctOfAvg = avgForDir ? ((currentRun / avgForDir) * 100).toFixed(0) : 'N/A';

        let risk = 'LOW', riskClass = 'success', riskOrder = 3;
        if (pctOfAvg !== 'N/A') {
            const pct = parseInt(pctOfAvg);
            if (pct > 150) { risk = 'HIGH'; riskClass = 'danger'; riskOrder = 1; }
            else if (pct > 100) { risk = 'MEDIUM'; riskClass = 'warning'; riskOrder = 2; }
        }

        rows.push({
            symbol, avgBullish, avgBearish, currentRun, currentDir, pctOfAvg,
            risk, riskClass, riskOrder, isCurrentSymbol: symbol === currentSymbol
        });
    }

    // Sort by risk (HIGH first, then MEDIUM, then LOW)
    rows.sort((a, b) => a.riskOrder - b.riskOrder);

    let html = '';
    if (rows.length === 0) {
        html = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:20px;">Loading data... Select a symbol and wait for data to load.</td></tr>';
    } else {
        rows.forEach(r => {
            html += `<tr ${r.isCurrentSymbol ? 'style="background:rgba(59,130,246,0.1);font-weight:600;"' : ''}>
                <td>${r.isCurrentSymbol ? ' ' : ''}${r.symbol}</td>
                <td>${r.avgBullish} bars</td>
                <td>${r.avgBearish} bars</td>
                <td>${r.currentRun} (${r.currentDir})</td>
                <td>${r.pctOfAvg}%</td>
                <td><span class="badge badge-${r.riskClass}">${r.risk}</span></td>
            </tr>`;
        });
    }

    table.innerHTML = html;
}

function updatePriceChart() {
    const data = currentData.slice(-60);
    const ctx = document.getElementById('priceChart');
    if (!ctx) return;
    
    if (priceChart) priceChart.destroy();
    
    const fib = window.fibLevels || {};
    const colors = data.map(d => parseFloat(d.Close) >= parseFloat(d.Open) ? '#10b981' : '#ef4444');
    
    priceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => (d.Date || '').split('T')[0].slice(5)),
            datasets: [{ label: 'Price', data: data.map(d => parseFloat(d.Close) || 0), backgroundColor: colors, borderColor: colors }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false },
                annotation: { annotations: {
                    r1: { type: 'line', yMin: fib.fib100, yMax: fib.fib100, borderColor: '#ef4444', borderWidth: 1, borderDash: [5,5] },
                    s1: { type: 'line', yMin: fib.fib382, yMax: fib.fib382, borderColor: '#10b981', borderWidth: 1, borderDash: [5,5] },
                    s2: { type: 'line', yMin: fib.fib500, yMax: fib.fib500, borderColor: '#14b8a6', borderWidth: 1, borderDash: [5,5] }
                }}
            },
            scales: { y: { ticks: { callback: v => '$' + v } } }
        }
    });
}

// ============================================
// AI ASSISTANT - IMPROVED
// ============================================

function askAi(question) {
    document.getElementById('aiInput').value = question;
    sendAiMessage();
}

async function sendAiMessage() {
    const input = document.getElementById('aiInput');
    const message = input.value.trim();
    if (!message) return;
    
    const messagesDiv = document.getElementById('aiChatMessages');
    
    messagesDiv.innerHTML += `<div class="ai-message user">${escapeHtml(message)}</div>`;
    input.value = '';
    
    messagesDiv.innerHTML += `<div class="ai-message assistant" id="typingIndicator"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    document.getElementById('aiSendBtn').disabled = true;
    
    // Add to conversation history
    conversationHistory.push({ role: 'user', content: message });
    
    try {
        const response = await generateAiResponse(message);
        document.getElementById('typingIndicator')?.remove();
        messagesDiv.innerHTML += `<div class="ai-message assistant"><div class="message-content">${response}</div></div>`;
        conversationHistory.push({ role: 'assistant', content: response });
    } catch (e) {
        document.getElementById('typingIndicator')?.remove();
        messagesDiv.innerHTML += `<div class="ai-message assistant"><div class="message-content">Sorry, I encountered an error. Please try again.</div></div>`;
    }
    
    document.getElementById('aiSendBtn').disabled = false;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function generateAiResponse(userMessage) {
    const lowerMsg = userMessage.toLowerCase();

    // Build context from dashboard data
    const dashboardContext = buildDashboardContext();
    const systemPrompt = buildSystemPrompt(dashboardContext);

    // Try Groq Cloud API first
    if (OLLAMA_CONFIG.enabled) {
        try {
            console.log("Calling Groq Cloud API...");
            const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(OLLAMA_CONFIG.endpoint + '/chat/completions')}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OLLAMA_CONFIG.apiKey}`
                },
                body: JSON.stringify({
                    model: OLLAMA_CONFIG.model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        ...conversationHistory.slice(-6),
                        { role: 'user', content: userMessage }
                    ],
                    temperature: 0.7,
                    max_tokens: 1024
                })
            });

            if (response.ok) {
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                // Update conversation history
                conversationHistory.push({ role: 'user', content: userMessage });
                conversationHistory.push({ role: 'assistant', content: aiResponse });

                // Keep only last 10 messages
                if (conversationHistory.length > 10) {
                    conversationHistory = conversationHistory.slice(-10);
                }

                console.log("Groq API response received successfully");
                return aiResponse;
            } else {
                console.warn("Groq API error:", response.status, await response.text());
            }
        } catch (e) {
            console.warn("Groq API call failed:", e.message);
        }
    }

    // Fallback to local AI responses
    try {
        console.log("Using local AI response generator...");
        const response = generateLocalResponse(userMessage, dashboardContext);
        return response;
    } catch (e) {
        console.error("AI Response error:", e);
        return "I encountered an error processing your request. Please try again or check the console for details.";
    }
}

function buildSystemPrompt(context) {
    return `You are the Gann Trading Assistant for Q5D Options Platform.

KNOWLEDGE BASE:
${GANN_KNOWLEDGE.tunnelThroughAir}
${GANN_KNOWLEDGE.mystifyingSquare}
${GANN_KNOWLEDGE.divineProportions}
${GANN_KNOWLEDGE.timeCycles}
${GANN_KNOWLEDGE.platformPrinciples}

CURRENT DATA:
${context}

RULES:
1. Give specific, actionable trading guidance
2. Use actual dashboard data - never hallucinate
3. Reference Gann principles when relevant
4. Format responses clearly with tables when helpful
5. Be concise but thorough`;
}

function buildDashboardContext() {
    let context = `CURRENT: ${currentSymbol} | Mode: ${tradingMode.toUpperCase()}\n\n`;
    
    if (currentData.length) {
        const lat = currentData[currentData.length - 1];
        const price = parseFloat(lat.Close);
        const atr = parseFloat(lat.ATR) || 5;
        context += `${currentSymbol}: $${price.toFixed(2)} | Signal: ${lat.Bias || 'HOLD'} | Consensus: ${lat.PriceConfluence || 0}/4 | ATR: $${atr.toFixed(2)}\n\n`;
        
        // Square of 9 levels
        const sqrtPrice = Math.sqrt(price);
        context += `Square of 9 for ${currentSymbol}:\n`;
        context += ` +90 (${(sqrtPrice + 0.25)}) = $${Math.pow(sqrtPrice + 0.25, 2).toFixed(2)}\n`;
        context += ` +180 = $${Math.pow(sqrtPrice + 0.5, 2).toFixed(2)}\n`;
        context += ` -90 = $${Math.pow(sqrtPrice - 0.25, 2).toFixed(2)}\n`;
        context += ` -180 = $${Math.pow(sqrtPrice - 0.5, 2).toFixed(2)}\n\n`;
    }
    
    context += `ALL SYMBOLS:\n`;
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            context += `${symbol}: $${parseFloat(lat.Close).toFixed(2)} | ${lat.Bias || 'HOLD'} | ${lat.PriceConfluence || 0}/4\n`;
        }
    }
    
    return context;
}

function generateLocalResponse(message, context) {
    const lowerMsg = message.toLowerCase();
    
    // MORNING BREAKOUT PATTERN
    if (lowerMsg.includes('breakout') || lowerMsg.includes('breaking out') || lowerMsg.includes('breaking above')) {
        return generateBreakoutResponse();
    }
    
    // PATTERN SCAN - General
    if (lowerMsg.includes('pattern') || lowerMsg.includes('setup') || lowerMsg.includes('forming')) {
        return generatePatternScanResponse();
    }
    
    // MOMENTUM / TRENDING
    if (lowerMsg.includes('momentum') || lowerMsg.includes('trending') || lowerMsg.includes('strongest') || lowerMsg.includes('weakest')) {
        return generateMomentumResponse();
    }
    
    // REVERSAL PATTERNS
    if (lowerMsg.includes('reversal') || lowerMsg.includes('turning') || lowerMsg.includes('bottom') || lowerMsg.includes('top')) {
        return generateReversalResponse();
    }
    
    // BAR COUNT / CONSECUTIVE BARS
    if (lowerMsg.includes('bar') && (lowerMsg.includes('count') || lowerMsg.includes('consecutive') || lowerMsg.includes('yesterday') || lowerMsg.includes('closing'))) {
        return generateBarCountResponse();
    }
    
    // OPTIMAL TIME TO TRADE
    if ((lowerMsg.includes('optimal') || lowerMsg.includes('best')) && (lowerMsg.includes('time') || lowerMsg.includes('when'))) {
        return generateOptimalTimeResponse();
    }
    
    // WHEN TO TRADE / TRADING HOURS
    if (lowerMsg.includes('when') && (lowerMsg.includes('trade') || lowerMsg.includes('buy') || lowerMsg.includes('sell'))) {
        return generateOptimalTimeResponse();
    }
    
    // HIGH CONSENSUS TRADES
    if (lowerMsg.includes('consensus') || lowerMsg.includes('3/4') || lowerMsg.includes('4/4') || lowerMsg.includes('high consensus')) {
        let trades = [];
        for (const symbol of SYMBOLS) {
            const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
            if (data && data.length) {
                const lat = data[data.length - 1];
                const consensus = parseInt(lat.PriceConfluence) || 0;
                if (consensus >= 3) {
                    const price = parseFloat(lat.Close);
                    const atr = parseFloat(lat.ATR) || 5;
                    trades.push({ symbol, signal: lat.Bias || 'HOLD', consensus, price: price.toFixed(2), strike: getProperStrike(price), target: (price + atr * 2).toFixed(2) });
                }
            }
        }
        
        if (trades.length === 0) {
            return ` No ETFs currently have 3/4 or 4/4 consensus.

This could mean:
 Markets are consolidating
 Agents are conflicting
 Wait for clearer signals

 TIP: Check individual symbols for developing setups, or review the Bar Count tab for trend direction.`;
        }
        
        let response = ` **HIGH CONSENSUS TRADES TODAY:**\n\n`;
        trades.sort((a, b) => b.consensus - a.consensus);
        trades.forEach(t => {
            const emoji = t.consensus === 4 ? '' : '';
            response += `${emoji} **${t.symbol}** - ${t.signal} (${t.consensus}/4)\n`;
            response += `   Price: $${t.price} | Strike: $${t.strike} | Target: $${t.target}\n\n`;
        });
        
        const ultra = trades.filter(t => t.consensus === 4);
        if (ultra.length) {
            response += ` **TOP PICK:** ${ultra[0].symbol} has ULTRA signal (4/4 consensus)`;
        }
        
        return response;
    }
    
    // BEST CALLS
    if (lowerMsg.includes('call') && (lowerMsg.includes('best') || lowerMsg.includes('2 day'))) {
        return generateOptionRecommendations('CALL');
    }
    
    // BEST PUTS
    if (lowerMsg.includes('put') && (lowerMsg.includes('best') || lowerMsg.includes('2 day'))) {
        return generateOptionRecommendations('PUT');
    }
    
    // SQUARE OF 9 / MYSTIFYING SQUARE
    if (lowerMsg.includes('square of 9') || lowerMsg.includes('mystifying')) {
        const price = currentData.length ? parseFloat(currentData[currentData.length - 1].Close) : 675;
        const sqrtPrice = Math.sqrt(price);
        
        return ` **MYSTIFYING SQUARE (SQUARE OF 9) FOR ${currentSymbol}**

Current Price: $${price.toFixed(2)}
Square Root: ${sqrtPrice.toFixed(4)}

**RESISTANCE LEVELS (Price Targets):**
 +45 = $${Math.pow(sqrtPrice + 0.125, 2).toFixed(2)} (minor)
 +90 = $${Math.pow(sqrtPrice + 0.25, 2).toFixed(2)} (important)
 +180 = $${Math.pow(sqrtPrice + 0.5, 2).toFixed(2)} (major)
 +360 = $${Math.pow(sqrtPrice + 1.0, 2).toFixed(2)} (full cycle)

**SUPPORT LEVELS (Stop Areas):**
 -45 = $${Math.pow(sqrtPrice - 0.125, 2).toFixed(2)} (minor)
 -90 = $${Math.pow(sqrtPrice - 0.25, 2).toFixed(2)} (important)
 -180 = $${Math.pow(sqrtPrice - 0.5, 2).toFixed(2)} (major)

 **HOW TO USE:**
- Buy at support levels
- Take profits at resistance
- 90 moves are most common
- 180 = major reversal zones`;
    }
    
    // DIVINE PROPORTIONS / FIBONACCI
    if (lowerMsg.includes('divine') || lowerMsg.includes('proportion') || lowerMsg.includes('phi') || lowerMsg.includes('golden')) {
        const fib = window.fibLevels || {};
        return ` **DIVINE PROPORTIONS (PHI/FIBONACCI)**

The Golden Ratio ( = 1.618) governs natural growth patterns and markets follow these proportions.

**${currentSymbol} FIBONACCI LEVELS:**

 Resistance (Targets):
 R1 (100%) = $${fib.fib100?.toFixed(2) || '--'} (Swing High)
 R2 (127.2%) = $${fib.fib1272?.toFixed(2) || '--'} ( extension)
 R3 (161.8%) = $${fib.fib1618?.toFixed(2) || '--'} ( extension)

 Support (Stops):
 S1 (38.2%) = $${fib.fib382?.toFixed(2) || '--'} (First support)
 S2 (50.0%) = $${fib.fib500?.toFixed(2) || '--'} (Key level)
 S3 (61.8%) = $${fib.fib618?.toFixed(2) || '--'} (Golden ratio)

**TRADING RULES:**
 Enter CALL at 61.8% retracement
 Target 161.8% extension
 Stop below 78.6% level

**PHI RELATIONSHIPS:**
 1.618  1.618 = 2.618
 1/1.618 = 0.618
 1.618 = 1.272`;
    }
    
    // TIME CYCLES
    if (lowerMsg.includes('time cycle') || lowerMsg.includes('gann cycle') || lowerMsg.includes('when')) {
        return ` **GANN TIME CYCLES**

"When time is up, the trend changes" - W.D. Gann

**KEY CYCLE LENGTHS:**
 30 days - Minor cycle
 45 days - Important (1/8 year)
 60 days - Significant
 90 days - Major (quarter)
 120 days - 1/3 year
 144 days - Fibonacci/sacred
 180 days - Half year
 360 days - Full annual cycle

**SEASONAL TURN DATES:**
 Mar 21 - Spring Equinox
 Jun 21 - Summer Solstice
 Sep 21 - Fall Equinox
 Dec 21 - Winter Solstice

**HOW TO APPLY:**
1. Mark the last major high or low date
2. Add Gann numbers (30, 45, 60, 90...)
3. Watch for reversals on those dates
4. Combine with price levels for confirmation`;
    }
    
    // OPTIMAL STRIKE
    if (lowerMsg.includes('strike') || lowerMsg.includes('optimal')) {
        if (currentData.length) {
            const lat = currentData[currentData.length - 1];
            const price = parseFloat(lat.Close);
            const atr = parseFloat(lat.ATR) || 5;
            const signal = lat.Bias || 'CALL';
            const sqrtPrice = Math.sqrt(price);
            
            return ` **OPTIMAL STRIKE FOR ${currentSymbol}**

Current Price: $${price.toFixed(2)}
Signal: ${signal}
ATR: $${atr.toFixed(2)}

**INTRADAY (0DTE):**
 ATM Strike: $${getProperStrike(price)} (Delta ~0.50)
 Target: $${(signal === 'PUT' ? price - atr : price + atr).toFixed(2)}
 Stop: $${(signal === 'PUT' ? price + atr * 0.5 : price - atr * 0.5).toFixed(2)}

**SWING (3-5 DTE):**
 Strike: $${getProperStrike(price)} (slightly OTM)
 Target: $${(signal === 'PUT' ? price - atr * 2.5 : price + atr * 2.5).toFixed(2)}
 Stop: $${(signal === 'PUT' ? price + atr * 1.5 : price - atr * 1.5).toFixed(2)}

**SQUARE OF 9 TARGETS:**
 90 target: $${Math.pow(sqrtPrice + (signal === 'PUT' ? -0.25 : 0.25), 2).toFixed(2)}
 180 target: $${Math.pow(sqrtPrice + (signal === 'PUT' ? -0.5 : 0.5), 2).toFixed(2)}`;
        }
        return "Please select a symbol to calculate optimal strike.";
    }
    
    // SECTOR COMPARISON
    if (lowerMsg.includes('sector') || lowerMsg.includes('compare') || lowerMsg.includes('strongest')) {
        let sectors = [];
        for (const symbol of ['XLK', 'XLF', 'XLV', 'XLE']) {
            const data = allSymbolsData[symbol];
            if (data && data.length > 20) {
                const lat = data[data.length - 1];
                const prev20 = data[data.length - 21];
                const perf = ((parseFloat(lat.Close) - parseFloat(prev20.Close)) / parseFloat(prev20.Close) * 100);
                sectors.push({ symbol, name: SYMBOL_NAMES[symbol], perf: perf.toFixed(2), signal: lat.Bias || 'HOLD', consensus: lat.PriceConfluence || 0 });
            }
        }
        
        sectors.sort((a, b) => parseFloat(b.perf) - parseFloat(a.perf));
        
        let response = ` **SECTOR COMPARISON (20-Day Performance)**\n\n`;
        sectors.forEach((s, i) => {
            const emoji = i === 0 ? '' : (i === 1 ? '' : (i === 2 ? '' : ''));
            const perfColor = parseFloat(s.perf) >= 0 ? '+' : '';
            response += `${emoji} **${s.name}** (${s.symbol})\n`;
            response += `   ${perfColor}${s.perf}% | ${s.signal} | ${s.consensus}/4 consensus\n\n`;
        });
        
        response += `\n **RECOMMENDATION:**\n`;
        response += ` Strongest: ${sectors[0].symbol} - consider for CALL trades\n`;
        response += ` Weakest: ${sectors[sectors.length-1].symbol} - consider for PUT trades`;
        
        return response;
    }
    
    // TUNNEL THROUGH THE AIR
    if (lowerMsg.includes('tunnel') || lowerMsg.includes('through the air')) {
        return GANN_KNOWLEDGE.tunnelThroughAir;
    }
    
    // PLATFORM / PRINCIPLES
    if (lowerMsg.includes('platform') || lowerMsg.includes('principle') || lowerMsg.includes('how does') || lowerMsg.includes('q5d')) {
        return GANN_KNOWLEDGE.platformPrinciples;
    }
    
    // CURRENT PRICE / STATUS
    if ((lowerMsg.includes('price') || lowerMsg.includes('status') || lowerMsg.includes('current')) && !lowerMsg.includes('strike')) {
        return generateCurrentStatusResponse();
    }
    
    // WHAT SHOULD I TRADE / RECOMMENDATION
    if (lowerMsg.includes('should i') || lowerMsg.includes('recommend') || lowerMsg.includes('what to trade') || lowerMsg.includes('trade today')) {
        return generateTradeRecommendation();
    }
    
    // RISK / STOP LOSS
    if (lowerMsg.includes('risk') || lowerMsg.includes('stop loss') || lowerMsg.includes('position size')) {
        return generateRiskManagementResponse();
    }
    
    // NEWS / MARKET UPDATE
    if (lowerMsg.includes('news') || lowerMsg.includes('market') || lowerMsg.includes('update')) {
        return generateMarketUpdateResponse();
    }
    
    // HELP / WHAT CAN YOU DO
    if (lowerMsg.includes('help') || lowerMsg.includes('what can you') || lowerMsg.includes('how to use')) {
        return generateHelpResponse();
    }
    
    // DEFAULT RESPONSE - More intelligent
    return generateSmartDefaultResponse(message, context);
}

function generateOptionRecommendations(direction) {
    let recommendations = [];
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            const signal = (lat.Bias || '').toUpperCase();
            if (signal === direction) {
                const price = parseFloat(lat.Close);
                const atr = parseFloat(lat.ATR) || 5;
                recommendations.push({
                    symbol,
                    price: price.toFixed(2),
                    strike: getProperStrike(price),
                    target: (direction === 'CALL' ? price + atr * 2 : price - atr * 2).toFixed(2),
                    stop: (direction === 'CALL' ? price - atr : price + atr).toFixed(2),
                    consensus: parseInt(lat.PriceConfluence) || 0,
                    rr: ((atr * 2) / atr).toFixed(1)
                });
            }
        }
    }
    
    recommendations.sort((a, b) => b.consensus - a.consensus);
    
    if (recommendations.length === 0) {
        return ` No strong ${direction} signals found across ETFs.

The agents are not aligned for ${direction} trades currently. Consider:
 Waiting for better setups
 Checking individual symbols
 Looking at the opposite direction`;
    }
    
    let response = ` **BEST ${direction} OPTIONS (Next 2 Days)**\n\n`;
    
    recommendations.slice(0, 5).forEach((r, i) => {
        const emoji = r.consensus >= 3 ? '' : '';
        response += `${emoji} **#${i+1} ${r.symbol}** (${r.consensus}/4 consensus)\n`;
        response += `   Strike: $${r.strike} ${direction}\n`;
        response += `   Entry: $${r.price} | Target: $${r.target} | Stop: $${r.stop}\n`;
        response += `   Risk/Reward: 1:${r.rr}\n\n`;
    });
    
    if (recommendations.length > 0) {
        const best = recommendations[0];
        response += `\n **TOP PICK:** ${best.symbol} $${best.strike} ${direction}\n`;
        response += ` ${best.consensus}/4 agent consensus\n`;
        response += ` Target: $${best.target} (${best.rr}:1 R/R)`;
    }
    
    return response;
}

// NEW: Generate Bar Count Response with actual data
function generateBarCountResponse() {
    let response = ` **BAR COUNT ANALYSIS (as of last close)**\n\n`;
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 20) continue;
        
        // Calculate consecutive bars
        let bullCount = 0, bearCount = 0, currentStreak = 0, lastDir = null;
        
        for (let i = Math.max(0, data.length - 50); i < data.length; i++) {
            const d = data[i];
            const isBullish = parseFloat(d.Close) >= parseFloat(d.Open);
            
            if (lastDir === null) {
                lastDir = isBullish;
                currentStreak = 1;
            } else if (isBullish === lastDir) {
                currentStreak++;
            } else {
                lastDir = isBullish;
                currentStreak = 1;
            }
            
            if (isBullish) bullCount++;
            else bearCount++;
        }
        
        const lat = data[data.length - 1];
        const price = parseFloat(lat.Close).toFixed(2);
        const signal = lat.Bias || 'HOLD';
        const streakDir = lastDir ? ' Bullish' : ' Bearish';
        const streakEmoji = currentStreak >= 5 ? '' : (currentStreak >= 3 ? '' : '');
        
        response += `**${symbol}** - $${price} | ${signal}\n`;
        response += `   Current Streak: ${currentStreak} bars ${streakDir} ${streakEmoji}\n`;
        response += `   Last 50 bars: ${bullCount} bullish / ${bearCount} bearish\n\n`;
    }
    
    // Add interpretation
    response += `\n **INTERPRETATION:**\n`;
    response += ` 5+ consecutive bars = Strong trend, consider continuation\n`;
    response += ` 7+ consecutive bars = Possible exhaustion, watch for reversal\n`;
    response += ` Mixed (1-2 bars) = Choppy market, wait for direction`;
    
    return response;
}

// NEW: Morning Breakout Pattern Detection
function generateBreakoutResponse() {
    let breakouts = [];
    let potentialBreakouts = [];
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 20) continue;
        
        const lat = data[data.length - 1];
        const prev = data[data.length - 2];
        const prev5 = data.slice(-6, -1);
        
        const price = parseFloat(lat.Close);
        const open = parseFloat(lat.Open);
        const high = parseFloat(lat.High);
        const low = parseFloat(lat.Low);
        const prevHigh = parseFloat(prev.High);
        const prevClose = parseFloat(prev.Close);
        const atr = parseFloat(lat.ATR) || 5;
        const volume = parseFloat(lat.Volume) || 0;
        
        // Calculate average volume
        const avgVol = data.slice(-20).reduce((sum, d) => sum + (parseFloat(d.Volume) || 0), 0) / 20;
        const volRatio = volume / avgVol;
        
        // Calculate 5-day high
        const fiveDayHigh = Math.max(...prev5.map(d => parseFloat(d.High) || 0));
        
        // Breakout criteria
        const aboveOpen = price > open;
        const nearHigh = (high - price) < (atr * 0.25); // Within 25% of ATR from high
        const abovePrevHigh = price > prevHigh;
        const above5DayHigh = price > fiveDayHigh;
        const highVolume = volRatio > 1.2;
        const strongMove = ((price - open) / open) * 100 > 0.5; // >0.5% move
        
        const breakoutScore = (aboveOpen ? 1 : 0) + (nearHigh ? 1 : 0) + (abovePrevHigh ? 1 : 0) + 
                             (above5DayHigh ? 2 : 0) + (highVolume ? 1 : 0) + (strongMove ? 1 : 0);
        
        const breakoutData = {
            symbol,
            price: price.toFixed(2),
            change: ((price - prevClose) / prevClose * 100).toFixed(2),
            volRatio: (volRatio * 100).toFixed(0),
            score: breakoutScore,
            above5Day: above5DayHigh,
            signal: lat.Bias || 'HOLD',
            consensus: lat.PriceConfluence || 0,
            target: (price + atr * 1.5).toFixed(2),
            stop: (price - atr * 0.75).toFixed(2)
        };
        
        if (breakoutScore >= 5 && above5DayHigh) {
            breakouts.push(breakoutData);
        } else if (breakoutScore >= 3) {
            potentialBreakouts.push(breakoutData);
        }
    }
    
    let response = ` **MORNING BREAKOUT SCAN**\n\n`;
    
    if (breakouts.length > 0) {
        response += `** CONFIRMED BREAKOUTS:**\n`;
        breakouts.sort((a, b) => b.score - a.score);
        breakouts.forEach(b => {
            response += `\n**${b.symbol}** - BREAKOUT! \n`;
            response += `   Price: $${b.price} (+${b.change}%)\n`;
            response += `   Volume: ${b.volRatio}% of avg ${parseFloat(b.volRatio) > 150 ? '' : ''}\n`;
            response += `   Breaking 5-day high: ${b.above5Day ? ' YES' : ' No'}\n`;
            response += `   Agent Signal: ${b.signal} (${b.consensus}/4)\n`;
            response += `   Target: $${b.target} | Stop: $${b.stop}\n`;
        });
    } else {
        response += `**No confirmed breakouts at this time.**\n`;
    }
    
    if (potentialBreakouts.length > 0) {
        response += `\n** POTENTIAL BREAKOUTS (Watch List):**\n`;
        potentialBreakouts.sort((a, b) => b.score - a.score).slice(0, 4).forEach(b => {
            response += ` ${b.symbol}: $${b.price} (+${b.change}%) - ${b.signal}\n`;
        });
    }
    
    response += `\n** BREAKOUT CRITERIA:**\n`;
    response += ` Price above open \n`;
    response += ` Near session high \n`;
    response += ` Above 5-day high \n`;
    response += ` Volume > 120% avg \n`;
    response += ` Move > 0.5% \n`;
    
    response += `\n** BEST TIME:** Trade breakouts 9:45-10:30 AM ET`;
    
    return response;
}

// NEW: Pattern Scan Response
function generatePatternScanResponse() {
    let patterns = {
        breakout: [],
        pullback: [],
        reversal: [],
        consolidation: []
    };
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 20) continue;
        
        const lat = data[data.length - 1];
        const recent = data.slice(-10);
        
        const price = parseFloat(lat.Close);
        const open = parseFloat(lat.Open);
        const high = parseFloat(lat.High);
        const low = parseFloat(lat.Low);
        const atr = parseFloat(lat.ATR) || 5;
        const signal = lat.Bias || 'HOLD';
        
        // Get recent highs/lows
        const recentHighs = recent.map(d => parseFloat(d.High) || 0);
        const recentLows = recent.map(d => parseFloat(d.Low) || 0);
        const highestHigh = Math.max(...recentHighs);
        const lowestLow = Math.min(...recentLows);
        const range = highestHigh - lowestLow;
        
        // Pattern detection
        const nearHigh = price > highestHigh - (range * 0.1);
        const nearLow = price < lowestLow + (range * 0.1);
        const inMiddle = !nearHigh && !nearLow;
        const tightRange = range < atr * 2;
        const bullishCandle = price > open;
        
        const symbolData = { symbol, price: price.toFixed(2), signal, consensus: lat.PriceConfluence || 0 };
        
        if (nearHigh && bullishCandle && signal === 'CALL') {
            patterns.breakout.push({...symbolData, type: 'Bullish Breakout'});
        } else if (nearLow && !bullishCandle && signal === 'PUT') {
            patterns.breakout.push({...symbolData, type: 'Bearish Breakdown'});
        } else if (inMiddle && signal === 'CALL') {
            patterns.pullback.push({...symbolData, type: 'Bullish Pullback'});
        } else if (inMiddle && signal === 'PUT') {
            patterns.pullback.push({...symbolData, type: 'Bearish Rally'});
        } else if (tightRange) {
            patterns.consolidation.push({...symbolData, type: 'Tight Range'});
        }
    }
    
    let response = ` **PATTERN SCAN RESULTS**\n\n`;
    
    if (patterns.breakout.length) {
        response += `** BREAKOUT PATTERNS:**\n`;
        patterns.breakout.forEach(p => {
            response += ` ${p.symbol}: ${p.type} @ $${p.price} (${p.consensus}/4)\n`;
        });
        response += `\n`;
    }
    
    if (patterns.pullback.length) {
        response += `** PULLBACK/RETRACEMENT:**\n`;
        patterns.pullback.forEach(p => {
            response += ` ${p.symbol}: ${p.type} @ $${p.price} (${p.consensus}/4)\n`;
        });
        response += `\n`;
    }
    
    if (patterns.consolidation.length) {
        response += `** CONSOLIDATION (Watch for breakout):**\n`;
        patterns.consolidation.forEach(p => {
            response += ` ${p.symbol}: ${p.type} @ $${p.price}\n`;
        });
        response += `\n`;
    }
    
    if (patterns.breakout.length === 0 && patterns.pullback.length === 0) {
        response += `No clear patterns detected. Market may be choppy.\n\n`;
    }
    
    response += ` **TIP:** Breakouts need volume confirmation. Pullbacks offer better risk/reward.`;
    
    return response;
}

// NEW: Momentum Response
function generateMomentumResponse() {
    let momentum = [];
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 20) continue;
        
        const lat = data[data.length - 1];
        const prev5 = data[data.length - 6];
        const prev20 = data[data.length - 21];
        
        const price = parseFloat(lat.Close);
        const price5 = parseFloat(prev5?.Close) || price;
        const price20 = parseFloat(prev20?.Close) || price;
        
        const chg5 = ((price - price5) / price5 * 100);
        const chg20 = ((price - price20) / price20 * 100);
        
        // Count consecutive bars
        let streak = 0;
        for (let i = data.length - 1; i >= Math.max(0, data.length - 10); i--) {
            const d = data[i];
            const bullish = parseFloat(d.Close) >= parseFloat(d.Open);
            if (i === data.length - 1) {
                streak = bullish ? 1 : -1;
            } else if ((bullish && streak > 0) || (!bullish && streak < 0)) {
                streak += bullish ? 1 : -1;
            } else {
                break;
            }
        }
        
        momentum.push({
            symbol,
            price: price.toFixed(2),
            chg5: chg5.toFixed(2),
            chg20: chg20.toFixed(2),
            streak,
            signal: lat.Bias || 'HOLD',
            consensus: lat.PriceConfluence || 0,
            score: chg5 + (streak * 0.5)
        });
    }
    
    // Sort by momentum score
    momentum.sort((a, b) => b.score - a.score);
    
    let response = ` **MOMENTUM RANKINGS**\n\n`;
    
    response += `** STRONGEST (Bullish Momentum):**\n`;
    momentum.slice(0, 3).forEach((m, i) => {
        const emoji = i === 0 ? '' : (i === 1 ? '' : '');
        response += `${emoji} **${m.symbol}** - $${m.price}\n`;
        response += `   5-Day: ${parseFloat(m.chg5) >= 0 ? '+' : ''}${m.chg5}% | 20-Day: ${parseFloat(m.chg20) >= 0 ? '+' : ''}${m.chg20}%\n`;
        response += `   Streak: ${m.streak > 0 ? '+' : ''}${m.streak} bars | Signal: ${m.signal} (${m.consensus}/4)\n\n`;
    });
    
    response += `** WEAKEST (Bearish Momentum):**\n`;
    momentum.slice(-3).reverse().forEach((m, i) => {
        response += `${i + 1}. **${m.symbol}** - $${m.price}\n`;
        response += `   5-Day: ${parseFloat(m.chg5) >= 0 ? '+' : ''}${m.chg5}% | Streak: ${m.streak > 0 ? '+' : ''}${m.streak} bars\n\n`;
    });
    
    response += ` **TRADING TIP:**\n`;
    response += ` Strong momentum + 3/4 consensus = High probability CALL\n`;
    response += ` Weak momentum + PUT signal = Consider PUT trades`;
    
    return response;
}

// NEW: Reversal Pattern Response
function generateReversalResponse() {
    let reversals = [];
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 20) continue;
        
        const lat = data[data.length - 1];
        const prev = data[data.length - 2];
        const prev2 = data[data.length - 3];
        
        const price = parseFloat(lat.Close);
        const open = parseFloat(lat.Open);
        const high = parseFloat(lat.High);
        const low = parseFloat(lat.Low);
        const prevClose = parseFloat(prev.Close);
        const prevOpen = parseFloat(prev.Open);
        const atr = parseFloat(lat.ATR) || 5;
        
        // Calculate bar counts
        let bearStreak = 0, bullStreak = 0;
        for (let i = data.length - 2; i >= Math.max(0, data.length - 10); i--) {
            const d = data[i];
            if (parseFloat(d.Close) < parseFloat(d.Open)) bearStreak++;
            else break;
        }
        for (let i = data.length - 2; i >= Math.max(0, data.length - 10); i--) {
            const d = data[i];
            if (parseFloat(d.Close) >= parseFloat(d.Open)) bullStreak++;
            else break;
        }
        
        // Reversal patterns
        const bullishEngulfing = prevClose < prevOpen && price > open && price > prevOpen && open < prevClose;
        const bearishEngulfing = prevClose > prevOpen && price < open && price < prevOpen && open > prevClose;
        const hammer = (open - low) > (high - open) * 2 && price > open && bearStreak >= 3;
        const shootingStar = (high - open) > (open - low) * 2 && price < open && bullStreak >= 3;
        
        let pattern = null;
        let direction = null;
        
        if (bullishEngulfing || hammer) {
            pattern = bullishEngulfing ? 'Bullish Engulfing' : 'Hammer';
            direction = 'BULLISH';
        } else if (bearishEngulfing || shootingStar) {
            pattern = bearishEngulfing ? 'Bearish Engulfing' : 'Shooting Star';
            direction = 'BEARISH';
        } else if (bearStreak >= 5 && price > open) {
            pattern = 'Potential Bullish Reversal';
            direction = 'BULLISH';
        } else if (bullStreak >= 5 && price < open) {
            pattern = 'Potential Bearish Reversal';
            direction = 'BEARISH';
        }
        
        if (pattern) {
            reversals.push({
                symbol,
                pattern,
                direction,
                price: price.toFixed(2),
                priorStreak: direction === 'BULLISH' ? bearStreak : bullStreak,
                signal: lat.Bias || 'HOLD',
                consensus: lat.PriceConfluence || 0
            });
        }
    }
    
    let response = ` **REVERSAL PATTERN SCAN**\n\n`;
    
    if (reversals.length === 0) {
        response += `No clear reversal patterns detected.\n\n`;
        response += `**What to look for:**\n`;
        response += ` 5+ bar downtrend + bullish candle = Potential bottom\n`;
        response += ` 5+ bar uptrend + bearish candle = Potential top\n`;
        response += ` Engulfing patterns at key Fibonacci levels\n`;
    } else {
        const bullish = reversals.filter(r => r.direction === 'BULLISH');
        const bearish = reversals.filter(r => r.direction === 'BEARISH');
        
        if (bullish.length) {
            response += `** BULLISH REVERSALS (Potential Bottoms):**\n`;
            bullish.forEach(r => {
                response += ` **${r.symbol}**: ${r.pattern} @ $${r.price}\n`;
                response += `  Prior downtrend: ${r.priorStreak} bars | Signal: ${r.signal}\n\n`;
            });
        }
        
        if (bearish.length) {
            response += `** BEARISH REVERSALS (Potential Tops):**\n`;
            bearish.forEach(r => {
                response += ` **${r.symbol}**: ${r.pattern} @ $${r.price}\n`;
                response += `  Prior uptrend: ${r.priorStreak} bars | Signal: ${r.signal}\n\n`;
            });
        }
    }
    
    response += ` **CAUTION:** Reversals need confirmation. Wait for follow-through!`;
    
    return response;
}

// NEW: Generate Optimal Trading Time Response
function generateOptimalTimeResponse() {
    const lat = currentData.length ? currentData[currentData.length - 1] : null;
    const price = lat ? parseFloat(lat.Close).toFixed(2) : '--';
    const signal = lat ? (lat.Bias || 'HOLD') : '--';
    
    return ` **OPTIMAL TIMES TO TRADE ${currentSymbol} OPTIONS**

**INTRADAY (0DTE) BEST WINDOWS:**

 **9:30-10:00 AM ET - Opening Range**
 Highest volatility & liquidity
 Wait for first 5-15 min to establish range
 Best for momentum plays
  Avoid trading first 5 minutes (too erratic)

 **10:00-11:30 AM ET - Morning Trend**
 Trend typically established
 Best time for directional trades
 Options premiums still reasonable
  RECOMMENDED for 0DTE entries

 **11:30 AM-2:00 PM ET - Midday Lull**
 Lower volatility, choppy action
  Avoid new positions
 Good for managing existing trades

 **2:00-3:00 PM ET - Power Hour Setup**
 Institutional positioning begins
 Good for swing entries (1-5 DTE)
 Watch for trend continuation/reversal

 **3:00-4:00 PM ET - Power Hour**
 High volume, strong moves
 Last chance for 0DTE
  Wide spreads near close
 Best for experienced traders

**SWING TRADES (3-5 DTE) BEST TIMES:**
 Enter: 10:00-11:00 AM (after opening noise)
 Avoid: Fridays (weekend theta decay)
 Best days: Tuesday-Thursday

**CURRENT ${currentSymbol} STATUS:**
 Price: $${price}
 Signal: ${signal}
 Mode: ${tradingMode.toUpperCase()}

**GANN TIME FACTORS:**
 Strongest moves: First hour, last hour
 Weakest: 12:00-1:00 PM (lunch hour)
 Watch 90-minute cycles intraday (Gann)

** MY RECOMMENDATION:**
For ${currentSymbol} ${signal} signal:
${signal === 'CALL' ? ' Enter on pullback to support 10:00-11:00 AM' : ' Enter on rally to resistance 10:00-11:00 AM'}
 Set stop based on ATR ($${lat ? parseFloat(lat.ATR).toFixed(2) : '--'})
 Take profits before 3:30 PM for 0DTE`;
}

// Current Status Response
function generateCurrentStatusResponse() {
    let response = ` **CURRENT MARKET STATUS**\n\n`;
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            const prev = data[data.length - 2] || lat;
            const price = parseFloat(lat.Close);
            const prevPrice = parseFloat(prev.Close);
            const chg = price - prevPrice;
            const pct = ((chg / prevPrice) * 100).toFixed(2);
            const signal = lat.Bias || 'HOLD';
            const consensus = lat.PriceConfluence || 0;
            const isCurrentSym = symbol === currentSymbol;
            
            response += `${isCurrentSym ? ' ' : ''}**${symbol}**: $${price.toFixed(2)} (${chg >= 0 ? '+' : ''}${pct}%)\n`;
            response += `   Signal: ${signal} | Consensus: ${consensus}/4\n\n`;
        }
    }
    
    return response;
}

// Trade Recommendation
function generateTradeRecommendation() {
    let bestTrade = null;
    let bestScore = 0;
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            const consensus = parseInt(lat.PriceConfluence) || 0;
            const signal = lat.Bias || 'HOLD';
            
            if (consensus > bestScore && signal !== 'HOLD') {
                bestScore = consensus;
                bestTrade = {
                    symbol,
                    signal,
                    consensus,
                    price: parseFloat(lat.Close),
                    atr: parseFloat(lat.ATR) || 5
                };
            }
        }
    }
    
    if (!bestTrade || bestScore < 2) {
        return ` **NO STRONG TRADE RECOMMENDATIONS RIGHT NOW**

Current market conditions don't show clear setups:
 No symbols have 3/4 or 4/4 consensus
 Agents are conflicting
 Consider staying flat or reducing size

**WHAT TO DO:**
 Wait for clearer signals
 Review the Bar Count tab for trend direction
 Check back after market open for fresh data`;
    }
    
    const strike = Math.round(bestTrade.price);
    const target = bestTrade.signal === 'CALL' 
        ? bestTrade.price + bestTrade.atr * 2 
        : bestTrade.price - bestTrade.atr * 2;
    const stop = bestTrade.signal === 'CALL'
        ? bestTrade.price - bestTrade.atr
        : bestTrade.price + bestTrade.atr;
    
    return ` **TODAY'S TOP TRADE RECOMMENDATION**

**${bestTrade.symbol} ${bestTrade.signal}**
Agent Consensus: ${bestTrade.consensus}/4 ${bestTrade.consensus >= 3 ? '' : ''}

 **ENTRY:**
 Price: $${bestTrade.price.toFixed(2)}
 Strike: $${strike} ${bestTrade.signal}
 Mode: ${tradingMode === 'intraday' ? '0DTE' : '3-5 DTE'}

 **TARGETS:**
 Target 1: $${(bestTrade.signal === 'CALL' ? bestTrade.price + bestTrade.atr : bestTrade.price - bestTrade.atr).toFixed(2)}
 Target 2: $${target.toFixed(2)}

 **RISK:**
 Stop Loss: $${stop.toFixed(2)}
 Risk/Reward: 1:2

 **TIMING:**
 Best entry: 10:00-11:00 AM ET
 Avoid: First 15 min, last 30 min (0DTE)`;
}

// Risk Management Response
function generateRiskManagementResponse() {
    const lat = currentData.length ? currentData[currentData.length - 1] : null;
    const price = lat ? parseFloat(lat.Close) : 675;
    const atr = lat ? parseFloat(lat.ATR) || 5 : 5;
    
    return ` **RISK MANAGEMENT GUIDELINES**

**POSITION SIZING (Kelly Criterion):**
 Risk 0.5-1% per trade (intraday)
 Risk 1-2% per trade (swing)
 Never risk more than 5% daily

**EXAMPLE for $10,000 Account:**
 1% risk = $100 max loss per trade
 If stop is $${atr.toFixed(2)} away (1 ATR)
 Max position = $100  $${atr.toFixed(2)} = ${(100/atr).toFixed(0)} contracts

**STOP LOSS PLACEMENT:**
 Intraday: 0.5-1.0 ATR = $${(atr * 0.75).toFixed(2)}
 Swing: 1.5-2.0 ATR = $${(atr * 1.5).toFixed(2)}

**${currentSymbol} CURRENT LEVELS:**
 Price: $${price.toFixed(2)}
 ATR: $${atr.toFixed(2)}
 Intraday Stop: $${(price - atr * 0.75).toFixed(2)} (CALL) / $${(price + atr * 0.75).toFixed(2)} (PUT)
 Swing Stop: $${(price - atr * 1.5).toFixed(2)} (CALL) / $${(price + atr * 1.5).toFixed(2)} (PUT)

**GANN'S RISK RULES:**
 Never let a profit turn into a loss
 Move stop to breakeven after 1 ATR profit
 Scale out: 50% at T1, 50% at T2
 Max 3 losses in a row = stop trading for day`;
}

// Market Update Response
function generateMarketUpdateResponse() {
    let bullish = 0, bearish = 0, neutral = 0;
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (data && data.length) {
            const signal = data[data.length - 1].Bias || 'HOLD';
            if (signal === 'CALL') bullish++;
            else if (signal === 'PUT') bearish++;
            else neutral++;
        }
    }
    
    const marketBias = bullish > bearish ? 'BULLISH' : (bearish > bullish ? 'BEARISH' : 'MIXED');
    const biasEmoji = marketBias === 'BULLISH' ? '' : (marketBias === 'BEARISH' ? '' : '');
    
    return ` **MARKET UPDATE**

${biasEmoji} **OVERALL BIAS: ${marketBias}**
 Bullish signals: ${bullish}/${SYMBOLS.length} ETFs
 Bearish signals: ${bearish}/${SYMBOLS.length} ETFs
 Neutral: ${neutral}/${SYMBOLS.length} ETFs

**SECTOR BREAKDOWN:**
${generateQuickSectorSummary()}

**TRADING IMPLICATION:**
${marketBias === 'BULLISH' ? ' Favor CALL trades\n Look for pullbacks to support\n Sector leaders: Check XLK, XLF' : 
  marketBias === 'BEARISH' ? ' Favor PUT trades\n Look for rallies to resistance\n Defensive sectors may outperform' :
  ' Mixed signals - reduce position size\n Wait for clearer direction\n Focus on highest consensus trades'}

 Use "high consensus trades" to find specific setups.`;
}

function generateQuickSectorSummary() {
    let summary = '';
    for (const symbol of ['XLK', 'XLF', 'XLV', 'XLE']) {
        const data = allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            const signal = lat.Bias || 'HOLD';
            const emoji = signal === 'CALL' ? '' : (signal === 'PUT' ? '' : '');
            summary += `${emoji} ${SYMBOL_NAMES[symbol]}: ${signal}\n`;
        }
    }
    return summary;
}

// Help Response
function generateHelpResponse() {
    return ` **HOW TO USE THE AI ASSISTANT**

**QUICK ACTIONS (Click the buttons!):**
  High Consensus - Find best trades
  Best CALLs - Top bullish plays
  Best PUTs - Top bearish plays
  Optimal Strike - Get strike recommendations

**EXAMPLE QUESTIONS:**

 **Data & Analysis:**
 "Show me bar count for all ETFs"
 "What's the current status?"
 "Compare all sectors"

 **Trade Ideas:**
 "What should I trade today?"
 "Best CALL options for 2 days"
 "Optimal strike for SPY"
 "Show high consensus trades"

 **Timing:**
 "When is the best time to trade?"
 "What are Gann time cycles?"

 **Education:**
 "Explain Square of 9"
 "What is Divine Proportions?"
 "Tunnel Through the Air principles"

 **Risk:**
 "How should I size my position?"
 "Where to place stop loss?"

Just type naturally - I understand most trading questions!`;
}

// Smart Default Response
function generateSmartDefaultResponse(message, context) {
    // Try to extract intent
    const lowerMsg = message.toLowerCase();
    
    // Check for symbol mentions
    const mentionedSymbol = SYMBOLS.find(s => lowerMsg.includes(s.toLowerCase()));
    
    let response = ` I want to help! Let me clarify...\n\n`;
    response += `You asked: "${message}"\n\n`;
    
    if (mentionedSymbol) {
        const data = allSymbolsData[mentionedSymbol] || currentData;
        if (data && data.length) {
            const lat = data[data.length - 1];
            response += `**${mentionedSymbol} Quick Info:**\n`;
            response += ` Price: $${parseFloat(lat.Close).toFixed(2)}\n`;
            response += ` Signal: ${lat.Bias || 'HOLD'}\n`;
            response += ` Consensus: ${lat.PriceConfluence || 0}/4\n\n`;
        }
    }
    
    response += `**Try asking:**\n`;
    response += ` "What should I trade today?"\n`;
    response += ` "Show me ${currentSymbol} bar count"\n`;
    response += ` "Best time to trade options"\n`;
    response += ` "Calculate Square of 9 for ${currentSymbol}"\n`;
    response += ` "High consensus trades"\n\n`;
    response += `Or click a Quick Action button on the right `;
    
    return response;
}

// ============================================
// TRADE LOG SYSTEM
// ============================================

// Initialize trades from localStorage
let trades = [];

function loadTrades() {
    const stored = localStorage.getItem('sa4_trades');
    if (stored) {
        try {
            trades = JSON.parse(stored);
        } catch (e) {
            trades = [];
        }
    }
    // Load from CSV
    loadTradesFromCSV();
    renderTrades();
    updateTradeStats();
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('tradeDate');
    if (dateInput) dateInput.value = today;
}

function saveTrades() {
    localStorage.setItem('sa4_trades', JSON.stringify(trades));
}

// Load trades from portfolio_confluence.csv
async function loadTradesFromCSV() {
    try {
        let response = await fetch('web/data/portfolio_confluence.csv?t=' + Date.now()).catch(() => null);
        if (!response || !response.ok) {
            response = await fetch('data/portfolio_confluence.csv?t=' + Date.now()).catch(() => null);
        }
        if (!response || !response.ok) return;

        const text = await response.text();
        const lines = text.trim().split('\n').slice(1);

        lines.forEach((line, index) => {
            const cols = line.split(',');
            if (cols.length >= 14) {
                const entryPrice = parseFloat(cols[4]) || 0;
                const exitPrice = parseFloat(cols[5]) || null;
                const pnlValue = parseFloat(cols[6]) || 0;
                const status = cols[13] ? cols[13].trim() : 'CLOSED';
                const trade = {
                    id: 'csv_' + index,
                    symbol: cols[0],
                    direction: cols[1],
                    date: cols[2],
                    exitDate: cols[3] || null,
                    entry: entryPrice,
                    exit: exitPrice,
                    pnl: pnlValue,
                    strike: entryPrice > 10 ? Math.round(entryPrice) : entryPrice.toFixed(2),
                    stop: parseFloat(cols[9]) || 0,
                    target1: parseFloat(cols[10]) || 0,
                    expiry: cols[12] || null,
                    status: status,
                    type: 'SWING',
                    contracts: 1,
                    consensus: pnlValue > 20 ? '4/4' : (pnlValue > 0 ? '3/4' : (pnlValue > -50 ? '2/4' : '1/4')),
                    notes: 'Exp: ' + (cols[12] || 'N/A'),
                    fromCSV: true
                };
                const exists = trades.some(t => t.symbol === trade.symbol && t.date === trade.date && t.direction === trade.direction && t.entry === trade.entry);
                if (!exists) trades.push(trade);
            }
        });
        trades.sort((a, b) => new Date(b.date) - new Date(a.date));
        renderTrades();
        updateTradeStats();
        console.log('Loaded ' + lines.length + ' trades from CSV');
    } catch (e) { console.log('CSV load error:', e); }
}



function logTrade(event) {
    event.preventDefault();
    
    const trade = {
        id: Date.now(),
        date: document.getElementById('tradeDate').value,
        symbol: document.getElementById('tradeSymbol').value,
        direction: document.getElementById('tradeDirection').value,
        type: document.getElementById('tradeType').value,
        strike: parseFloat(document.getElementById('tradeStrike').value),
        contracts: parseInt(document.getElementById('tradeContracts').value),
        entry: parseFloat(document.getElementById('tradeEntry').value),
        exit: parseFloat(document.getElementById('tradeExit').value) || null,
        consensus: document.getElementById('tradeConsensus').value,
        status: document.getElementById('tradeStatus').value,
        notes: document.getElementById('tradeNotes').value,
        createdAt: new Date().toISOString()
    };
    
    // Calculate P&L if closed
    if (trade.exit && trade.status !== 'OPEN') {
        trade.pnl = (trade.exit - trade.entry) * trade.contracts * 100;
    } else {
        trade.pnl = null;
    }
    
    trades.unshift(trade); // Add to beginning
    saveTrades();
    renderTrades();
    updateTradeStats();
    clearTradeForm();
    
    // Show success message
    alert(' Trade logged successfully!');
}

function clearTradeForm() {
    document.getElementById('tradeForm').reset();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('tradeDate').value = today;
    document.getElementById('tradeSymbol').value = currentSymbol;
}

function toggleExitField() {
    const status = document.getElementById('tradeStatus').value;
    const exitField = document.getElementById('tradeExit');
    if (status === 'OPEN') {
        exitField.value = '';
        exitField.disabled = true;
    } else {
        exitField.disabled = false;
    }
}

function renderTrades() {
    const tbody = document.getElementById('tradeTableBody');
    if (!tbody) return;

    const filterSymbol = document.getElementById('filterSymbol')?.value || 'ALL';
    const filterDirection = document.getElementById('filterDirection')?.value || 'ALL';
    const filterStatus = document.getElementById('filterStatus')?.value || 'ALL';

    let filteredTrades = trades.filter(t => {
        if (filterSymbol !== 'ALL' && t.symbol !== filterSymbol) return false;
        if (filterDirection !== 'ALL' && t.direction !== filterDirection) return false;
        if (filterStatus !== 'ALL' && t.status !== filterStatus) return false;
        return true;
    });

    // Sort by date descending (newest first)
    filteredTrades.sort((a, b) => new Date(b.date) - new Date(a.date));

    var el=document.getElementById('tradeCount');if(el)el.textContent = `(${filteredTrades.length} trades)`;

    if (filteredTrades.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" style="text-align:center;color:var(--muted);padding:30px;">No trades match your filters.</td></tr>';
        return;
    }

    let html = '';
    filteredTrades.forEach((trade, index) => {
        const pnlClass = trade.pnl > 0 ? 'pnl-positive' : (trade.pnl < 0 ? 'pnl-negative' : '');
        const pnlDisplay = trade.pnl !== null ? `${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(2)}` : '--';
        const statusClass = trade.status.toLowerCase();
        const directionEmoji = trade.direction === 'CALL' ? '' : '';
        const typeEmoji = trade.type === 'INTRADAY' ? '' : '';

        html += `<tr>
            <td>${index + 1}</td>
            <td>${trade.date}</td>
            <td><strong>${trade.symbol}</strong></td>
            <td>${directionEmoji} ${trade.direction} ${typeEmoji}</td>
            <td>$${trade.strike}</td>
            <td>${trade.contracts}</td>
            <td>$${trade.entry.toFixed(2)}</td>
            <td>${trade.exit ? '$' + trade.exit.toFixed(2) : '--'}</td>
            <td class="${pnlClass}">${pnlDisplay}</td>
            <td><span class="badge badge-${trade.consensus === '4/4' ? 'ultra' : (trade.consensus === '3/4' ? 'success' : 'warning')}">${trade.consensus}</span></td>
            <td><span class="status-badge-trade ${statusClass}">${trade.status}</span></td>
            <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${trade.notes || ''}">${trade.notes || '--'}</td>
            <td>
                <button class="trade-action-btn edit" onclick="editTrade(${trade.id})"></button>
                <button class="trade-action-btn delete" onclick="deleteTrade(${trade.id})"></button>
            </td>
        </tr>`;
    });

    tbody.innerHTML = html;
}

function filterTrades() {
    renderTrades();
}

function filterTradesTable() {
    var symbolFilter = document.getElementById('filterSymbol').value;
    var typeFilter = document.getElementById('filterType').value;
    var resultFilter = document.getElementById('filterResult').value;
    var dateFilter = document.getElementById('filterDate').value;

    var table = document.getElementById('tradesTable');
    if (!table) return;

    var rows = table.querySelectorAll('tbody tr');

    rows.forEach(function(row) {
        var show = true;
        var cells = row.cells;
        if (!cells || cells.length < 6) return;

        var symbol = cells[1] ? cells[1].textContent.trim() : '';
        var type = cells[2] ? cells[2].textContent.trim() : '';
        var result = cells[5] ? cells[5].textContent.trim() : '';
        var dateText = cells[0] ? cells[0].textContent.trim() : '';

        if (symbolFilter && !symbol.includes(symbolFilter)) show = false;
        if (typeFilter && !type.includes(typeFilter)) show = false;
        if (resultFilter && !result.includes(resultFilter)) show = false;

        if (dateFilter) {
            var daysAgo = parseInt(dateFilter);
            var tradeDate = new Date(dateText + ', 2024');
            var cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - daysAgo);
            if (tradeDate < cutoff) show = false;
        }

        row.style.display = show ? '' : 'none';
    });

    console.log('Trades filtered');
}

function exportTradesToCSV() {
    var table = document.getElementById('tradesTable');
    if (!table) {
        alert('No trades table found');
        return;
    }

    var csv = [];
    var rows = table.querySelectorAll('tr');

    rows.forEach(function(row) {
        if (row.style.display === 'none') return;
        var cols = row.querySelectorAll('td, th');
        var rowData = [];
        cols.forEach(function(col) {
            var text = col.textContent.replace(/,/g, '').trim();
            rowData.push('"' + text + '"');
        });
        csv.push(rowData.join(','));
    });

    var csvContent = csv.join('\n');
    var blob = new Blob([csvContent], { type: 'text/csv' });
    var url = window.URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'trades_export_' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);

    console.log('Trades exported to CSV');
}

function editTrade(id) {
    const trade = trades.find(t => t.id === id);
    if (!trade) return;
    
    document.getElementById('tradeDate').value = trade.date;
    document.getElementById('tradeSymbol').value = trade.symbol;
    document.getElementById('tradeDirection').value = trade.direction;
    document.getElementById('tradeType').value = trade.type;
    document.getElementById('tradeStrike').value = trade.strike;
    document.getElementById('tradeContracts').value = trade.contracts;
    document.getElementById('tradeEntry').value = trade.entry;
    document.getElementById('tradeExit').value = trade.exit || '';
    document.getElementById('tradeConsensus').value = trade.consensus;
    document.getElementById('tradeStatus').value = trade.status;
    document.getElementById('tradeNotes').value = trade.notes || '';
    
    // Remove the old trade
    trades = trades.filter(t => t.id !== id);
    saveTrades();
    
    // Scroll to form
    document.getElementById('tradeForm').scrollIntoView({ behavior: 'smooth' });
}

function deleteTrade(id) {
    if (!confirm('Are you sure you want to delete this trade?')) return;
    
    trades = trades.filter(t => t.id !== id);
    saveTrades();
    renderTrades();
    updateTradeStats();
}

function clearAllTrades() {
    if (!confirm(' Are you sure you want to delete ALL trades? This cannot be undone!')) return;
    if (!confirm('This will permanently delete your entire trade history. Continue?')) return;
    
    trades = [];
    saveTrades();
    renderTrades();
    updateTradeStats();
}

function updateTradeStats() {
    const closedTrades = trades.filter(t => t.status !== 'OPEN' && t.pnl !== null);
    const wins = closedTrades.filter(t => t.pnl > 0);
    const losses = closedTrades.filter(t => t.pnl <= 0);
    
    // Basic stats
    var el=document.getElementById('statTotalTrades');if(el)el.textContent = trades.length;
    
    // Win rate
    const winRate = closedTrades.length > 0 ? (wins.length / closedTrades.length * 100).toFixed(1) : 0;
    var el=document.getElementById('statWinRate');if(el)el.textContent = winRate + '%';
    el=document.getElementById('statWinRate');if(el)el.className = `metric-value ${parseFloat(winRate) >= 50 ? 'positive' : 'negative'}`;
    var el=document.getElementById('statWinLoss');if(el)el.textContent = `${wins.length}W / ${losses.length}L`;
    
    // Total P&L
    const totalPnL = closedTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
    var el=document.getElementById('statTotalPnL');if(el)el.textContent = `${totalPnL >= 0 ? '+' : ''}$${totalPnL.toFixed(2)}`;
    el=document.getElementById('statTotalPnL');if(el)el.className = `metric-value ${totalPnL >= 0 ? 'positive' : 'negative'}`;
    
    // Average trade
    const avgTrade = closedTrades.length > 0 ? totalPnL / closedTrades.length : 0;
    var el=document.getElementById('statAvgTrade');if(el)el.textContent = `Avg: ${avgTrade >= 0 ? '+' : ''}$${avgTrade.toFixed(2)}`;
    
    // Best/Worst trade
    if (closedTrades.length > 0) {
        const best = closedTrades.reduce((max, t) => t.pnl > max.pnl ? t : max);
        const worst = closedTrades.reduce((min, t) => t.pnl < min.pnl ? t : min);
        
        var el=document.getElementById('statBestTrade');if(el)el.textContent = `+$${best.pnl.toFixed(2)}`;
        var el=document.getElementById('statBestSymbol');if(el)el.textContent = `${best.symbol} ${best.direction}`;
        var el=document.getElementById('statWorstTrade');if(el)el.textContent = `$${worst.pnl.toFixed(2)}`;
        var el=document.getElementById('statWorstSymbol');if(el)el.textContent = `${worst.symbol} ${worst.direction}`;
    }
    
    // Trades this week
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    const weekTrades = trades.filter(t => new Date(t.date) >= oneWeekAgo);
    var el=document.getElementById('statTradesThisWeek');if(el)el.textContent = `${weekTrades.length} this week`;
    
    // Update analytics
    updateSymbolPerformance();
    updateDirectionPerformance();
    updateConsensusAnalysis();
}

function updateSymbolPerformance() {
    const container = document.getElementById('symbolPerformance');
    if (!container) return;
    
    const closedTrades = trades.filter(t => t.status !== 'OPEN' && t.pnl !== null);
    if (closedTrades.length === 0) {
        container.innerHTML = '<p style="color:var(--muted);font-size:12px;">Log closed trades to see performance breakdown</p>';
        return;
    }
    
    const bySymbol = {};
    closedTrades.forEach(t => {
        if (!bySymbol[t.symbol]) {
            bySymbol[t.symbol] = { wins: 0, losses: 0, pnl: 0 };
        }
        bySymbol[t.symbol].pnl += t.pnl;
        if (t.pnl > 0) bySymbol[t.symbol].wins++;
        else bySymbol[t.symbol].losses++;
    });
    
    let html = '<div style="display:flex;flex-direction:column;gap:8px;">';
    Object.entries(bySymbol).sort((a, b) => b[1].pnl - a[1].pnl).forEach(([symbol, data]) => {
        const winRate = ((data.wins / (data.wins + data.losses)) * 100).toFixed(0);
        const pnlClass = data.pnl >= 0 ? 'positive' : 'negative';
        html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px;background:var(--bg);border-radius:4px;">
            <span style="font-weight:600;">${symbol}</span>
            <span>${data.wins}W/${data.losses}L (${winRate}%)</span>
            <span class="${pnlClass}" style="font-weight:600;">${data.pnl >= 0 ? '+' : ''}$${data.pnl.toFixed(2)}</span>
        </div>`;
    });
    html += '</div>';
    container.innerHTML = html;
}

function updateDirectionPerformance() {
    const container = document.getElementById('directionPerformance');
    if (!container) return;
    
    const closedTrades = trades.filter(t => t.status !== 'OPEN' && t.pnl !== null);
    if (closedTrades.length === 0) {
        container.innerHTML = '<p style="color:var(--muted);font-size:12px;">Log closed trades to see CALL vs PUT performance</p>';
        return;
    }
    
    const calls = closedTrades.filter(t => t.direction === 'CALL');
    const puts = closedTrades.filter(t => t.direction === 'PUT');
    
    const callWins = calls.filter(t => t.pnl > 0).length;
    const callPnL = calls.reduce((sum, t) => sum + t.pnl, 0);
    const putWins = puts.filter(t => t.pnl > 0).length;
    const putPnL = puts.reduce((sum, t) => sum + t.pnl, 0);
    
    const callWinRate = calls.length > 0 ? ((callWins / calls.length) * 100).toFixed(0) : 0;
    const putWinRate = puts.length > 0 ? ((putWins / puts.length) * 100).toFixed(0) : 0;
    
    container.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:10px;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(16,185,129,0.1);border-radius:6px;border-left:4px solid var(--success);">
                <div>
                    <div style="font-weight:700;font-size:14px;"> CALLS</div>
                    <div style="font-size:11px;color:var(--muted);">${calls.length} trades | ${callWinRate}% win rate</div>
                </div>
                <div style="font-size:18px;font-weight:700;" class="${callPnL >= 0 ? 'positive' : 'negative'}">${callPnL >= 0 ? '+' : ''}$${callPnL.toFixed(2)}</div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(239,68,68,0.1);border-radius:6px;border-left:4px solid var(--danger);">
                <div>
                    <div style="font-weight:700;font-size:14px;"> PUTS</div>
                    <div style="font-size:11px;color:var(--muted);">${puts.length} trades | ${putWinRate}% win rate</div>
                </div>
                <div style="font-size:18px;font-weight:700;" class="${putPnL >= 0 ? 'positive' : 'negative'}">${putPnL >= 0 ? '+' : ''}$${putPnL.toFixed(2)}</div>
            </div>
        </div>
    `;
}

function updateConsensusAnalysis() {
    const consensusLevels = ['4/4', '3/4', '2/4', '1/4'];
    const ids = ['ultra44', 'super34', 'single24', 'weak14'];

    console.log('Consensus analysis running, trades:', trades.length);

    consensusLevels.forEach((level, i) => {
        try {
            const levelTrades = trades.filter(t => t.consensus === level && t.status !== 'OPEN' && t.pnl !== null);
            const wins = levelTrades.filter(t => t.pnl > 0).length;
            const winRate = levelTrades.length > 0 ? ((wins / levelTrades.length) * 100).toFixed(0) : '--';

            var el1 = document.getElementById(ids[i] + 'WinRate');
            var el2 = document.getElementById(ids[i] + 'Count');
            if (el1) {
                el1.textContent = winRate + '%';
                el1.style.color = winRate !== '--' && parseFloat(winRate) >= 50 ? 'var(--success)' : 'var(--danger)';
            }
            if (el2) el2.textContent = levelTrades.length + ' trades';
        } catch(e) { console.log('Consensus err:', e); }
    });
}

// Export Functions
function printTrades() {
    window.print();
}

function exportCSV() {
    if (trades.length === 0) {
        alert('No trades to export!');
        return;
    }
    
    const headers = ['Date', 'Symbol', 'Direction', 'Type', 'Strike', 'Contracts', 'Entry', 'Exit', 'P&L', 'Consensus', 'Status', 'Notes'];
    const rows = trades.map(t => [
        t.date,
        t.symbol,
        t.direction,
        t.type,
        t.strike,
        t.contracts,
        t.entry,
        t.exit || '',
        t.pnl || '',
        t.consensus,
        t.status,
        `"${(t.notes || '').replace(/"/g, '""')}"`
    ]);
    
    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `trade_log_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    
    URL.revokeObjectURL(url);
}

function shareTrades() {
    const closedTrades = trades.filter(t => t.status !== 'OPEN' && t.pnl !== null);
    const wins = closedTrades.filter(t => t.pnl > 0).length;
    const winRate = closedTrades.length > 0 ? ((wins / closedTrades.length) * 100).toFixed(1) : 0;
    const totalPnL = closedTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
    
    const text = ` Stock Agent 4 - Trade Summary

 Total Trades: ${trades.length}
 Win Rate: ${winRate}%
 Total P&L: ${totalPnL >= 0 ? '+' : ''}$${totalPnL.toFixed(2)}
 Period: ${trades.length > 0 ? trades[trades.length-1].date : 'N/A'} to ${trades.length > 0 ? trades[0].date : 'N/A'}

Powered by Q5D Options Platform & Gann Principles `;

    if (navigator.share) {
        navigator.share({
            title: 'Stock Agent 4 Trade Summary',
            text: text
        }).catch(console.log);
    } else {
        // Fallback - copy to clipboard
        navigator.clipboard.writeText(text).then(() => {
            alert(' Trade summary copied to clipboard!');
        }).catch(() => {
            prompt('Copy this trade summary:', text);
        });
    }
}

function emailTrades() {
    const closedTrades = trades.filter(t => t.status !== 'OPEN' && t.pnl !== null);
    const wins = closedTrades.filter(t => t.pnl > 0).length;
    const winRate = closedTrades.length > 0 ? ((wins / closedTrades.length) * 100).toFixed(1) : 0;
    const totalPnL = closedTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
    
    const subject = encodeURIComponent('Stock Agent 4 - Trade Summary');
    const body = encodeURIComponent(`Stock Agent 4 - Trade Summary

Total Trades: ${trades.length}
Win Rate: ${winRate}%
Total P&L: ${totalPnL >= 0 ? '+' : ''}$${totalPnL.toFixed(2)}

Recent Trades:
${trades.slice(0, 10).map(t => `- ${t.date}: ${t.symbol} ${t.direction} ${t.contracts}x $${t.strike} | P&L: ${t.pnl !== null ? '$' + t.pnl.toFixed(2) : 'Open'}`).join('\n')}

---
Powered by Q5D Options Platform`);
    
    window.open(`mailto:?subject=${subject}&body=${body}`);
}

// Initialize trade log when app loads
async function initializeApp() {
    initTabs();
    await loadAllData();  // Wait for data to load
    
    // Update Options Calculator with new symbol
    updateOptionsCalcForSymbol();
    await loadAllSymbolsData();
    setTimeout(updateAllSymbolGannDataFromCSV, 500);
    fetchVIXData(); // Load real VIX data
    loadTrades(); // Load trade history
    runHealthCheck(); // Now run health check AFTER data is loaded
    renderSystemLog(); // Render existing log entries
    addSystemLogEntry('Data Updated (' + currentSymbol + ')', 'Success'); // Log data load
    setInterval(loadAllData, 60000);
    setInterval(runHealthCheck, 300000); // Health check every 5 minutes

    // Wait for data to load, then run calculations
    var initialCalcAttempts = 0;
    function runInitialCalculationsWhenReady() {
        var symbol = currentSymbol || 'SPY';
        var data = symbolGannData[symbol];
        var csvLoaded = allSymbolsData && allSymbolsData[symbol] && allSymbolsData[symbol].length > 0;

        if (csvLoaded && data && data.price > 0) {
            console.log('Data ready for ' + symbol + ' at $' + data.price + ' - running calculations');
            if (typeof updateAllSymbolGannDataFromCSV === 'function') updateAllSymbolGannDataFromCSV();
            setTimeout(function() {
                if (typeof autoCalculateGannPredictions === 'function') autoCalculateGannPredictions(symbol);
                if (typeof updateMarketConditions === 'function') updateMarketConditions();
                if (typeof updateTopTradeDisplay === 'function') updateTopTradeDisplay();
                if (typeof updateGannAnalysis === 'function') updateGannAnalysis();
                console.log('Initial calculations complete');

                // Update agent signal display with real values
                if (typeof updateAgentSignalDisplay === 'function') {
                    updateAgentSignalDisplay();
                }

                // Auto-save predictions after data loads
                if (typeof autoSavePredictions === 'function') {
                    setTimeout(autoSavePredictions, 1000);
                }
            }, 500);
        } else {
            initialCalcAttempts++;
            if (initialCalcAttempts < 20) {
                console.log('Waiting for data... attempt ' + initialCalcAttempts);
                setTimeout(runInitialCalculationsWhenReady, 500);
            } else {
                console.warn('Data load timeout - running calculations anyway');
                if (typeof updateMarketConditions === 'function') updateMarketConditions();
                if (typeof updateTopTradeDisplay === 'function') updateTopTradeDisplay();
            }
        }
    }
    setTimeout(runInitialCalculationsWhenReady, 1000);
}

// ============================================
// HEALTH MONITORING SYSTEM
// ============================================

let healthStatus = {
    dataFreshness: 'unknown',
    marketStatus: 'unknown',
    workflowStatus: 'unknown',
    dataQuality: 'unknown',
    alerts: []
};

function runHealthCheck() {
    console.log('Running health check...');
    healthStatus.alerts = [];
    
    // Check data freshness
    checkDataFreshness();
    
    // Check market status
    checkMarketStatus();
    
    // Check data quality
    checkDataQuality();
    
    // Check connections
    checkConnections();
    
    // Update overall status
    updateOverallHealth();

    // Update last check time
    var el=document.getElementById('lastHealthCheck');if(el)el.textContent = new Date().toLocaleString();

    // Update health timestamp
    updateSectionTimestamp('health');
}

function checkDataFreshness() {
    console.log(' checkDataFreshness running...');
    
    // Get elements directly
    const lastDateEl = document.getElementById('lastDataDate');
    const daysSinceEl = document.getElementById('daysSinceUpdate');
    const expectedEl = document.getElementById('expectedUpdate');
    const totalBarsEl = document.getElementById('totalBarsLoaded');
    const dateRangeEl = document.getElementById('dataDateRange');
    const valueEl = document.getElementById('dataFreshnessValue');
    const statusEl = document.getElementById('dataFreshnessStatus');
    const freshEl = document.getElementById('healthDataFresh');
    
    // Check if we have data
    if (!currentData || currentData.length === 0) {
        console.log(' No data available');
        if (valueEl) valueEl.textContent = 'No Data';
        if (statusEl) statusEl.textContent = 'CRITICAL';
        healthStatus.dataFreshness = 'critical';
        healthStatus.alerts.push({ type: 'critical', message: 'No data loaded' });
        return;
    }
    
    console.log(' Data length:', currentData.length);
    
    // Get last bar directly
    const lastBar = currentData[currentData.length - 1];
    console.log(' Last bar:', lastBar);
    console.log(' Last bar Date:', lastBar.Date);
    
    // Use global parseCSVDate function for robust date parsing
    let lastDate;
    if (lastBar.Date) {
        lastDate = parseCSVDate(lastBar.Date);
        console.log(' Parsed lastDate:', lastDate, 'from:', lastBar.Date);
    }
    
    if (!lastDate || isNaN(lastDate.getTime())) {
        console.log(' Invalid date');
        if (valueEl) valueEl.textContent = 'Invalid Date';
        healthStatus.dataFreshness = 'critical';
        return;
    }
    
    // Calculate days difference
    const now = new Date();
    const diffMs = now - lastDate;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    console.log(' Now:', now);
    console.log(' Diff days:', diffDays);
    
    // Format the date string
    const dateStr = lastDate.toLocaleDateString('en-US', { 
        weekday: 'short', 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
    });
    console.log(' Formatted date:', dateStr);
    
    // UPDATE THE ELEMENTS DIRECTLY
    if (lastDateEl) {
        lastDateEl.textContent = dateStr;
        lastDateEl.innerHTML = dateStr;
        console.log(' Updated lastDataDate to:', dateStr);
    } else {
        console.log(' lastDataDate element not found!');
    }
    
    if (daysSinceEl) {
        const daysText = diffDays === 0 ? 'Today' : (diffDays === 1 ? '1 day ago' : diffDays + ' days ago');
        daysSinceEl.textContent = daysText;
        console.log(' Updated daysSinceUpdate to:', daysText);
    }
    
    if (totalBarsEl) {
        totalBarsEl.textContent = currentData.length + ' bars';
    }
    
    // First date for range
    const firstBar = currentData[0];
    if (firstBar && firstBar.Date && dateRangeEl) {
        const firstDate = parseCSVDate(firstBar.Date);
        if (firstDate) {
            dateRangeEl.textContent = firstDate.toLocaleDateString() + ' - ' + lastDate.toLocaleDateString();
        }
    }
    
    // Expected update
    if (expectedEl) {
        const nextUpdate = getNextMarketDay(lastDate);
        expectedEl.textContent = nextUpdate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }
    
    // Status based on days
    if (diffDays === 0) {
        if (valueEl) valueEl.textContent = 'Up to Date';
        if (statusEl) { statusEl.textContent = 'FRESH'; statusEl.className = 'health-metric-status ok'; }
        if (freshEl) freshEl.className = 'health-metric healthy';
        healthStatus.dataFreshness = 'healthy';
        healthStatus.alerts.push({ type: 'success', message: 'Data is current' });
    } else if (diffDays === 1) {
        if (valueEl) valueEl.textContent = '1 Day Old';
        if (statusEl) { statusEl.textContent = 'OK'; statusEl.className = 'health-metric-status ok'; }
        if (freshEl) freshEl.className = 'health-metric healthy';
        healthStatus.dataFreshness = 'healthy';
    } else if (diffDays <= 3) {
        const isWeekend = isWeekendGap(lastDate, now);
        if (isWeekend) {
            if (valueEl) valueEl.textContent = diffDays + ' Days (Weekend)';
            if (statusEl) { statusEl.textContent = 'OK'; statusEl.className = 'health-metric-status ok'; }
            if (freshEl) freshEl.className = 'health-metric healthy';
            healthStatus.dataFreshness = 'healthy';
        } else {
            if (valueEl) valueEl.textContent = diffDays + ' Days Old';
            if (statusEl) { statusEl.textContent = 'STALE'; statusEl.className = 'health-metric-status warn'; }
            if (freshEl) freshEl.className = 'health-metric warning';
            healthStatus.dataFreshness = 'warning';
            healthStatus.alerts.push({ type: 'warning', message: 'Data is ' + diffDays + ' days old' });
        }
    } else {
        if (valueEl) valueEl.textContent = diffDays + ' Days Old';
        if (statusEl) { statusEl.textContent = 'OUTDATED'; statusEl.className = 'health-metric-status error'; }
        if (freshEl) freshEl.className = 'health-metric critical';
        healthStatus.dataFreshness = 'critical';
        healthStatus.alerts.push({ type: 'critical', message: 'Data is ' + diffDays + ' days old!' });
    }
    
    console.log(' checkDataFreshness complete');
}

function checkMarketStatus() {
    const marketEl = document.getElementById('healthMarket');
    const valueEl = document.getElementById('marketStatusValue');
    const statusEl = document.getElementById('marketStatusStatus');
    
    const now = new Date();
    const etOffset = getETOffset();
    const etNow = new Date(now.getTime() + etOffset);
    
    const day = etNow.getDay();
    const hours = etNow.getHours();
    const minutes = etNow.getMinutes();
    const timeNum = hours * 100 + minutes;
    
    // Weekend check
    if (day === 0 || day === 6) {
        valueEl.textContent = 'Weekend';
        statusEl.textContent = 'CLOSED';
        statusEl.className = 'health-metric-status warn';
        marketEl.className = 'health-metric warning';
        healthStatus.marketStatus = 'closed';
        return;
    }
    
    // Market hours: 9:30 AM - 4:00 PM ET
    if (timeNum >= 930 && timeNum < 1600) {
        valueEl.textContent = 'Market Open';
        statusEl.textContent = 'TRADING';
        statusEl.className = 'health-metric-status ok';
        marketEl.className = 'health-metric healthy';
        healthStatus.marketStatus = 'open';
    } else if (timeNum >= 400 && timeNum < 930) {
        valueEl.textContent = 'Pre-Market';
        statusEl.textContent = 'WAITING';
        statusEl.className = 'health-metric-status warn';
        marketEl.className = 'health-metric warning';
        healthStatus.marketStatus = 'premarket';
    } else {
        valueEl.textContent = 'After Hours';
        statusEl.textContent = 'CLOSED';
        statusEl.className = 'health-metric-status warn';
        marketEl.className = 'health-metric warning';
        healthStatus.marketStatus = 'closed';
    }
}

function checkDataQuality() {
    const qualityEl = document.getElementById('healthDataQuality');
    const valueEl = document.getElementById('dataQualityValue');
    const statusEl = document.getElementById('dataQualityStatus');
    
    if (!currentData || currentData.length === 0) {
        valueEl.textContent = 'No Data';
        statusEl.textContent = 'N/A';
        statusEl.className = 'health-metric-status error';
        qualityEl.className = 'health-metric critical';
        healthStatus.dataQuality = 'critical';
        return;
    }
    
    let issues = 0;
    let checks = 0;
    
    // Check for required fields
    const lastBar = currentData[currentData.length - 1];
    const requiredFields = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume'];
    
    requiredFields.forEach(field => {
        checks++;
        if (!lastBar[field] && lastBar[field] !== 0) {
            issues++;
        }
    });
    
    // Check for valid price data
    checks++;
    if (lastBar.Close && (lastBar.Close < 0 || lastBar.Close > 10000)) {
        issues++;
        healthStatus.alerts.push({ type: 'warning', message: 'Unusual price detected - verify data integrity' });
    }
    
    // Note: Bias is calculated at runtime, not stored in CSV
    // So we don't check for it here
    
    // Calculate quality score
    const score = Math.round(((checks - issues) / checks) * 100);
    
    if (score >= 90) {
        valueEl.textContent = score + '%';
        statusEl.textContent = 'EXCELLENT';
        statusEl.className = 'health-metric-status ok';
        qualityEl.className = 'health-metric healthy';
        healthStatus.dataQuality = 'healthy';
    } else if (score >= 70) {
        valueEl.textContent = score + '%';
        statusEl.textContent = 'GOOD';
        statusEl.className = 'health-metric-status ok';
        qualityEl.className = 'health-metric healthy';
        healthStatus.dataQuality = 'healthy';
    } else if (score >= 50) {
        valueEl.textContent = score + '%';
        statusEl.textContent = 'FAIR';
        statusEl.className = 'health-metric-status warn';
        qualityEl.className = 'health-metric warning';
        healthStatus.dataQuality = 'warning';
    } else {
        valueEl.textContent = score + '%';
        statusEl.textContent = 'POOR';
        statusEl.className = 'health-metric-status error';
        qualityEl.className = 'health-metric critical';
        healthStatus.dataQuality = 'critical';
        healthStatus.alerts.push({ type: 'critical', message: 'Data quality issues detected - check CSV files' });
    }
}

function checkConnections() {
    // Update symbol display
    const symbolEl = document.getElementById('connDataSymbol');
    if (symbolEl) symbolEl.textContent = currentSymbol;

    // GitHub Pages - if page loaded, it's working
    var el=document.getElementById('connGitHubStatus');if(el)el.textContent = 'Connected';
    var el=document.getElementById('connGitHubLight');if(el)el.textContent = '';

    // Data feed - based on whether data loaded
    if (currentData && currentData.length > 0) {
        var el=document.getElementById('connDataStatus');if(el)el.textContent = 'Loaded (' + currentData.length + ' bars)';
        var el=document.getElementById('connDataLight');if(el)el.textContent = '';
    } else {
        var el=document.getElementById('connDataStatus');if(el)el.textContent = 'Failed';
        var el=document.getElementById('connDataLight');if(el)el.textContent = '';
    }

    // Portfolio feed
    var el=document.getElementById('connPortfolioStatus');if(el)el.textContent = 'Active';
    var el=document.getElementById('connPortfolioLight');if(el)el.textContent = '';

    // Local Storage
    try {
        localStorage.setItem('health_test', 'test');
        localStorage.removeItem('health_test');
        var el=document.getElementById('connLocalStorageStatus');if(el)el.textContent = 'Available';
        var el=document.getElementById('connLocalStorageLight');if(el)el.textContent = '';
    } catch (e) {
        var el=document.getElementById('connLocalStorageStatus');if(el)el.textContent = 'Blocked';
        var el=document.getElementById('connLocalStorageLight');if(el)el.textContent = '';
        healthStatus.alerts.push({ type: 'warning', message: 'Local storage unavailable - trade log may not persist' });
    }
}

function updateOverallHealth() {
    const banner = document.getElementById('healthBanner');
    const icon = document.getElementById('healthBannerIcon');
    const title = document.getElementById('healthBannerTitle');
    const subtitle = document.getElementById('healthBannerSubtitle');
    const workflowEl = document.getElementById('healthWorkflow');
    const workflowValue = document.getElementById('workflowStatusValue');
    const workflowStatus = document.getElementById('workflowStatusStatus');

    // Determine workflow status based on data freshness
    if (healthStatus.dataFreshness === 'healthy') {
        workflowValue.textContent = 'Running';
        workflowStatus.textContent = 'ACTIVE';
        workflowStatus.className = 'health-metric-status ok';
        workflowEl.className = 'health-metric healthy';
        healthStatus.workflowStatus = 'healthy';
        var el=document.getElementById('workflowStatusLight');if(el)el.textContent = '';
    } else if (healthStatus.dataFreshness === 'warning') {
        workflowValue.textContent = 'Delayed';
        workflowStatus.textContent = 'CHECK';
        workflowStatus.className = 'health-metric-status warn';
        workflowEl.className = 'health-metric warning';
        healthStatus.workflowStatus = 'warning';
        var el=document.getElementById('workflowStatusLight');if(el)el.textContent = '';
    } else {
        workflowValue.textContent = 'Stopped?';
        workflowStatus.textContent = 'ERROR';
        workflowStatus.className = 'health-metric-status error';
        workflowEl.className = 'health-metric critical';
        healthStatus.workflowStatus = 'critical';
        var el=document.getElementById('workflowStatusLight');if(el)el.textContent = '';
    }

    // Update traffic lights for data freshness
    const dataFreshLight = document.getElementById('dataFreshnessLight');
    if (dataFreshLight) {
        if (healthStatus.dataFreshness === 'healthy') dataFreshLight.textContent = '';
        else if (healthStatus.dataFreshness === 'warning') dataFreshLight.textContent = '';
        else dataFreshLight.textContent = '';
    }

    // Update traffic lights for data quality
    const dataQualityLight = document.getElementById('dataQualityLight');
    if (dataQualityLight) {
        if (healthStatus.dataQuality === 'healthy') dataQualityLight.textContent = '';
        else if (healthStatus.dataQuality === 'warning') dataQualityLight.textContent = '';
        else dataQualityLight.textContent = '';
    }

    // Update market status light
    const marketLight = document.getElementById('marketStatusLight');
    if (marketLight) {
        const marketVal = document.getElementById('marketStatusValue')?.textContent || '';
        if (marketVal.includes('Open') || marketVal.includes('Pre') || marketVal.includes('After')) {
            marketLight.textContent = '';
        } else {
            marketLight.textContent = '';
        }
    }

    // Count traffic lights for summary
    const statuses = [healthStatus.dataFreshness, healthStatus.dataQuality, healthStatus.workflowStatus];
    // Add market status (yellow if closed, green otherwise)
    const marketVal = document.getElementById('marketStatusValue')?.textContent || '';
    const marketStatus = (marketVal.includes('Open') || marketVal.includes('Pre') || marketVal.includes('After')) ? 'healthy' : 'warning';
    statuses.push(marketStatus);

    const greenCount = statuses.filter(s => s === 'healthy').length;
    const yellowCount = statuses.filter(s => s === 'warning').length;
    const redCount = statuses.filter(s => s === 'critical').length;

    var el=document.getElementById('trafficGreenCount');if(el)el.textContent = ' ' + greenCount;
    var el=document.getElementById('trafficYellowCount');if(el)el.textContent = ' ' + yellowCount;
    var el=document.getElementById('trafficRedCount');if(el)el.textContent = ' ' + redCount;

    // Overall status
    if (redCount > 0) {
        banner.className = 'health-banner critical';
        icon.textContent = '';
        title.textContent = 'ATTENTION NEEDED';
        subtitle.textContent = `${greenCount}/4 Green, ${yellowCount} Yellow, ${redCount} Red`;
    } else if (yellowCount > 0) {
        banner.className = 'health-banner warning';
        icon.textContent = '';
        title.textContent = 'MINOR ISSUES';
        subtitle.textContent = `${greenCount}/4 Green, ${yellowCount} Yellow`;
    } else {
        banner.className = 'health-banner';
        icon.textContent = '';
        title.textContent = 'ALL SYSTEMS OPERATIONAL';
        subtitle.textContent = `${greenCount}/4 Green`;
    }

    // Update component status table
    updateComponentStatus();

    // Render alerts
    renderHealthAlerts();

    // Update header badge
    updateHeaderHealthBadge();

    // Log the health check event
    addSystemLogEntry('Health Check Run', 'Success');
}

function renderHealthAlerts() {
    const container = document.getElementById('healthAlerts');
    
    if (healthStatus.alerts.length === 0) {
        container.innerHTML = `
            <div class="health-alert success">
                <span class="alert-icon"></span>
                <span>No issues detected - system running normally</span>
            </div>
        `;
        return;
    }
    
    let html = '';
    healthStatus.alerts.forEach(alert => {
        const iconMap = { critical: '', warning: '', info: '', success: '' };
        html += `
            <div class="health-alert ${alert.type}">
                <span class="alert-icon">${iconMap[alert.type] || ''}</span>
                <span>${alert.message}</span>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// System Log Functions
function getSystemLog() {
    try {
        const log = localStorage.getItem('stockAgentSystemLog');
        return log ? JSON.parse(log) : [];
    } catch (e) {
        return [];
    }
}

function saveSystemLog(log) {
    try {
        // Keep only last 20 entries
        const trimmed = log.slice(-20);
        localStorage.setItem('stockAgentSystemLog', JSON.stringify(trimmed));
    } catch (e) {
        console.warn('Could not save system log:', e);
    }
}

function addSystemLogEntry(event, status) {
    const log = getSystemLog();
    const now = new Date();
    log.push({
        timestamp: now.toISOString(),
        dateTime: now.toLocaleString(),
        event: event,
        status: status
    });
    saveSystemLog(log);
    renderSystemLog();
}

function clearSystemLog() {
    try {
        localStorage.removeItem('stockAgentSystemLog');
        renderSystemLog();
    } catch (e) {
        console.warn('Could not clear system log:', e);
    }
}

function renderSystemLog() {
    const tbody = document.getElementById('systemLogTable');
    if (!tbody) return;

    const log = getSystemLog();
    if (log.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--muted);">No events logged yet</td></tr>';
        return;
    }

    // Show most recent first
    const recentLog = log.slice(-10).reverse();
    tbody.innerHTML = recentLog.map(entry => {
        const statusIcon = entry.status === 'Success' ? '' : entry.status === 'Warning' ? '' : '';
        return `
            <tr>
                <td>${entry.dateTime}</td>
                <td>${entry.event}</td>
                <td>${statusIcon} ${entry.status}</td>
            </tr>
        `;
    }).join('');
}

// Update Component Status Table
function updateComponentStatus() {
    const now = new Date();
    const nowStr = now.toLocaleString();

    // Health Check time
    const healthCheckTimeEl = document.getElementById('compHealthCheckTime');
    const healthCheckLightEl = document.getElementById('compHealthCheckLight');
    if (healthCheckTimeEl) healthCheckTimeEl.textContent = nowStr;
    if (healthCheckLightEl) healthCheckLightEl.textContent = '';

    // Data Fetch time (based on last data date)
    const dataFetchTimeEl = document.getElementById('compDataFetchTime');
    const dataFetchLightEl = document.getElementById('compDataFetchLight');
    if (currentData && currentData.length > 0) {
        const lastBar = currentData[currentData.length - 1];
        if (lastBar.Date) {
            const lastDate = parseCSVDate(lastBar.Date);
            if (lastDate) {
                // Assume data was fetched at 4:05 PM on that date
                lastDate.setHours(16, 5, 0);
                if (dataFetchTimeEl) dataFetchTimeEl.textContent = lastDate.toLocaleString();
            }
            if (dataFetchLightEl) dataFetchLightEl.textContent = healthStatus.dataFreshness === 'healthy' ? '' : healthStatus.dataFreshness === 'warning' ? '' : '';
        }
    }

    // Workflow time (same as data fetch)
    const workflowTimeEl = document.getElementById('compWorkflowTime');
    const workflowLightEl = document.getElementById('compWorkflowLight');
    if (currentData && currentData.length > 0) {
        const lastBar = currentData[currentData.length - 1];
        if (lastBar.Date) {
            const lastDate = parseCSVDate(lastBar.Date);
            if (lastDate) {
                lastDate.setHours(16, 5, 0);
                if (workflowTimeEl) workflowTimeEl.textContent = lastDate.toLocaleString();
            }
            if (workflowLightEl) workflowLightEl.textContent = healthStatus.workflowStatus === 'healthy' ? '' : healthStatus.workflowStatus === 'warning' ? '' : '';
        }
    }

    // Deploy time (estimate based on health check + 2 min)
    const deployTimeEl = document.getElementById('compDeployTime');
    const deployLightEl = document.getElementById('compDeployLight');
    if (deployTimeEl) {
        const deployTime = new Date(now.getTime() + 2 * 60 * 1000);
        deployTimeEl.textContent = '~' + deployTime.toLocaleString();
    }
    if (deployLightEl) deployLightEl.textContent = '';
}

// Helper functions
function getETOffset() {
    // Rough ET offset (doesn't account for DST perfectly)
    const now = new Date();
    const jan = new Date(now.getFullYear(), 0, 1);
    const jul = new Date(now.getFullYear(), 6, 1);
    const stdOffset = Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
    const isDST = now.getTimezoneOffset() < stdOffset;
    return isDST ? -4 * 60 * 60 * 1000 : -5 * 60 * 60 * 1000;
}

function getNextMarketDay(fromDate) {
    const next = new Date(fromDate);
    next.setDate(next.getDate() + 1);
    
    // Skip weekends
    while (next.getDay() === 0 || next.getDay() === 6) {
        next.setDate(next.getDate() + 1);
    }
    
    return next;
}

function isWeekendGap(lastDate, currentDate) {
    const lastDay = lastDate.getDay();
    const diff = Math.floor((currentDate - lastDate) / (1000 * 60 * 60 * 24));
    
    // If last data was Friday and it's been 2-3 days, it's a weekend gap
    if (lastDay === 5 && diff <= 3) return true;
    
    return false;
}

function toggleTroubleshoot(header) {
    const content = header.nextElementSibling;
    const toggle = header.querySelector('.troubleshoot-toggle');
    
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        toggle.textContent = '+';
    } else {
        content.classList.add('show');
        toggle.textContent = '';
    }
}

function updateHeaderHealthBadge() {
    const badge = document.getElementById('headerHealthBadge');
    const dot = document.getElementById('headerHealthDot');
    const text = document.getElementById('headerHealthText');
    
    if (!badge) return;
    
    const statuses = [healthStatus.dataFreshness, healthStatus.dataQuality, healthStatus.workflowStatus];
    
    if (statuses.includes('critical')) {
        badge.className = 'status-badge critical';
        badge.style.background = 'rgba(239,68,68,0.3)';
        text.textContent = 'ISSUES';
    } else if (statuses.includes('warning')) {
        badge.className = 'status-badge warning';
        badge.style.background = 'rgba(245,158,11,0.3)';
        text.textContent = 'WARNING';
    } else if (statuses.includes('unknown')) {
        badge.className = 'status-badge';
        badge.style.background = 'rgba(255,255,255,0.2)';
        text.textContent = 'CHECKING';
    } else {
        badge.className = 'status-badge online';
        badge.style.background = 'rgba(16,185,129,0.3)';
        text.textContent = 'HEALTHY';
    }
}

function switchToHealthTab() {
    // Activate health tab
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    const healthTab = document.querySelector('[data-tab="health"]');
    const healthContent = document.getElementById('health');
    
    if (healthTab) healthTab.classList.add('active');
    if (healthContent) healthContent.classList.add('active');
    
    // Run health check when switching
    runHealthCheck();
}

// ============================================
// ENHANCED MULTI-CHARTS SYSTEM
// ============================================

let lwChartInstances = { intraday: null, swing: null, position: null };
let mtfChartData = { intraday: [], swing: [], position: [] };

function toggleMTFSettings(panel) {
    const el = document.getElementById(`${panel}Settings`);
    if (el) el.classList.toggle('show');
}

function getMTFSettings(panel) {
    return {
        showEMA: document.getElementById(`${panel}ShowEMA`)?.checked ?? true,
        showFib: document.getElementById(`${panel}ShowFib`)?.checked ?? true,
        showSQ9: document.getElementById(`${panel}ShowSQ9`)?.checked ?? true,
        showPatterns: document.getElementById(`${panel}ShowPatterns`)?.checked ?? true,
        showVolume: document.getElementById(`${panel}ShowVolume`)?.checked ?? true
    };
}

// Chart timeframe update function
function updateChartTimeframe(chartType, timeframe) {
    console.log('Updating ' + chartType + ' to ' + timeframe);

    const timeframeLabels = {
        '1m': '1 Minute', '5m': '5 Minute', '15m': '15 Minute', '30m': '30 Minute',
        '1h': '1 Hour', '4h': '4 Hour', '1d': 'Daily', '1w': 'Weekly',
        '1M': 'Monthly', '3M': 'Quarterly'
    };

    // Update the timeframe indicator
    const indicatorId = chartType + 'TfIndicator';
    const indicator = document.getElementById(indicatorId);
    if (indicator) {
        indicator.textContent = 'Showing: ' + (timeframeLabels[timeframe] || timeframe) + ' data';
    }

    // Show notification
    const notification = document.createElement('div');
    notification.style.cssText = 'position: fixed; top: 70px; right: 20px; background: #3b82f6; color: white; padding: 10px 20px; border-radius: 8px; font-size: 12px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
    notification.innerHTML = '<strong>' + chartType.charAt(0).toUpperCase() + chartType.slice(1) + '</strong> chart switched to ' + timeframeLabels[timeframe];
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

function initMultiCharts() {
    console.log('Initializing enhanced multi-charts...');
    updateAllMultiCharts();
}

async function syncSymbolFromMultiCharts() {
    const newSymbol = document.getElementById('multiChartSymbol')?.value || 'SPY';
    const mainSelect = document.getElementById('symbolSelect');
    if (mainSelect && mainSelect.value !== newSymbol) {
        mainSelect.value = newSymbol;
    }
    await changeSymbol();
}

async function updateAllMultiCharts() {
    const symbol = document.getElementById('multiChartSymbol')?.value || 'SPY';
    ['intraday', 'swing', 'position'].forEach(panel => {
        const symbolEl = document.getElementById(`${panel}Symbol`);
        if (symbolEl) symbolEl.textContent = symbol;
    });
    await updateChart('intraday');
    await updateChart('swing');
    await updateChart('position');

    // Update multi-charts timestamp
    updateSectionTimestamp('multiCharts');
}

function refreshAllCharts() {
    updateAllMultiCharts();
}

// ============================================
// MULTI-CHARTS DATA LOADING & SYMBOL UPDATES
// ============================================

// Cache for loaded symbol data
const marketData = {};

// Load individual symbol data from CSV
async function loadSymbolData(symbol) {
    try {
        // Try data/ folder first, then root
        let response = await fetch(`data/${symbol}.csv`).catch(() => null);

        if (!response?.ok) {
            console.log('Could not load data for ' + symbol);
            return null;
        }

        const text = await response.text();
        const lines = text.trim().split('\n');

        if (lines.length < 2) return null;

        const header = lines[0].split(',');
        const getIdx = (name) => header.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));

        // Get last row
        const lastLine = lines[lines.length - 1];
        const cols = lastLine.split(',');
        const prevLine = lines.length > 2 ? lines[lines.length - 2] : lastLine;
        const prevCols = prevLine.split(',');

        const closeIdx = getIdx('close') !== -1 ? getIdx('close') : 4;
        const openIdx = getIdx('open') !== -1 ? getIdx('open') : 1;
        const highIdx = getIdx('high') !== -1 ? getIdx('high') : 2;
        const lowIdx = getIdx('low') !== -1 ? getIdx('low') : 3;

        const close = parseFloat(cols[closeIdx]) || 0;
        const open = parseFloat(cols[openIdx]) || 0;
        const high = parseFloat(cols[highIdx]) || 0;
        const low = parseFloat(cols[lowIdx]) || 0;
        const prevClose = parseFloat(prevCols[closeIdx]) || close;

        // Calculate 20-bar high/low for Fibonacci
        let high20 = high, low20 = low;
        for (let i = Math.max(1, lines.length - 20); i < lines.length; i++) {
            const rowCols = lines[i].split(',');
            const h = parseFloat(rowCols[highIdx]) || 0;
            const l = parseFloat(rowCols[lowIdx]) || 0;
            if (h > high20) high20 = h;
            if (l > 0 && l < low20) low20 = l;
        }

        marketData[symbol] = {
            price: close,
            open: open,
            high: high,
            low: low,
            close: close,
            prevClose: prevClose,
            change: close - prevClose,
            changePct: ((close - prevClose) / prevClose * 100),
            high20: high20,
            low20: low20,
            lastUpdate: new Date().toLocaleTimeString()
        };

        console.log('Loaded ' + symbol + ' data: $' + close.toFixed(2));
        return marketData[symbol];

    } catch (error) {
        console.log('Error loading ' + symbol + ':', error);
        return null;
    }
}

// Update Multi-Charts with new symbol data
async function updateMultiCharts(symbol) {
    console.log('Updating Multi-Charts for ' + symbol);

    // Get data for the symbol
    let symbolData = marketData[symbol];

    if (!symbolData) {
        // Try to load data if not in cache
        symbolData = await loadSymbolData(symbol);
    }

    if (!symbolData) {
        console.log('No data available for ' + symbol);
        // Still update the UI with the symbol name
    }

    // Update all symbol labels in Multi-Charts
    document.querySelectorAll('#multi-charts .symbol-label').forEach(el => {
        el.textContent = symbol;
    });

    // Update panel symbol displays
    ['intraday', 'swing', 'position'].forEach(panel => {
        const symbolEl = document.getElementById(`${panel}Symbol`);
        if (symbolEl) symbolEl.textContent = symbol;
    });

    // Update chart titles
    document.querySelectorAll('#multi-charts .chart-title, #multi-charts h4').forEach(el => {
        el.innerHTML = el.innerHTML.replace(/SPY|QQQ|IWM|DIA|XL[A-Z]+/g, symbol);
    });

    if (symbolData) {
        // Update price displays
        document.querySelectorAll('#multi-charts .price-display').forEach(el => {
            el.textContent = '$' + symbolData.price.toFixed(2);
        });

        // Update Fibonacci levels based on new symbol's data
        updateMultiChartFibLevels(symbol, symbolData);

        // Update bias indicators
        updateMultiChartBias(symbol, symbolData);

        console.log('Multi-Charts updated for ' + symbol + ' at $' + symbolData.price.toFixed(2));
    }

    // Refresh all chart panels with new data
    await updateAllMultiCharts();
}

// Update Fibonacci levels in Multi-Charts
function updateMultiChartFibLevels(symbol, data) {
    if (!data || !data.high20 || !data.low20) return;

    const range = data.high20 - data.low20;
    const r1 = data.high20;
    const r382 = data.low20 + (range * 0.382);
    const r500 = data.low20 + (range * 0.5);
    const r618 = data.low20 + (range * 0.618);
    const s1 = data.low20;

    // Update Fib level displays in charts
    const fibElements = document.querySelectorAll('#multi-charts .fib-level, #multi-charts [class*="fib"]');
    fibElements.forEach(el => {
        const text = el.textContent;
        if (text.includes('R:') || text.includes('100%')) {
            el.textContent = 'R: $' + r1.toFixed(2);
        } else if (text.includes('61.8%')) {
            el.textContent = '61.8%: $' + r618.toFixed(2);
        } else if (text.includes('50%')) {
            el.textContent = '50%: $' + r500.toFixed(2);
        } else if (text.includes('38.2%')) {
            el.textContent = '38.2%: $' + r382.toFixed(2);
        } else if (text.includes('S:') || text.includes('0%')) {
            el.textContent = 'S: $' + s1.toFixed(2);
        }
    });

    console.log('Fib levels updated for ' + symbol + ': R=$' + r1.toFixed(2) + ', S=$' + s1.toFixed(2));
}

// Update bias indicators in Multi-Charts
function updateMultiChartBias(symbol, data) {
    if (!data) return;

    // Determine bias based on price change
    const bias = data.change >= 0 ? 'BULLISH' : 'BEARISH';
    const biasColor = data.change >= 0 ? '#22c55e' : '#ef4444';

    // Update bias displays
    document.querySelectorAll('#multi-charts .bias-label').forEach(el => {
        el.textContent = bias;
        el.style.color = biasColor;
    });

    // Update MTF bias summary if visible
    const mtfBiasElements = document.querySelectorAll('.mtf-summary .bias, .mtf-summary-item .bias');
    mtfBiasElements.forEach(el => {
        el.textContent = bias;
        el.style.color = biasColor;
    });
}

// Initialize Multi-Charts symbol change handlers
function initMultiChartsSymbolChange() {
    const multiChartSymbol = document.getElementById('multiChartSymbol');

    if (multiChartSymbol) {
        // Remove existing onchange to avoid duplicates
        multiChartSymbol.removeAttribute('onchange');

        multiChartSymbol.addEventListener('change', async function() {
            const symbol = this.value;
            console.log('Multi-Charts: Symbol changed to ' + symbol);

            // Sync with header symbol dropdown
            const mainSelect = document.getElementById('symbolSelect');
            if (mainSelect && mainSelect.value !== symbol) {
                mainSelect.value = symbol;
            }

            // Update global currentSymbol
            currentSymbol = symbol;

            // Update Multi-Charts with new symbol
            await updateMultiCharts(symbol);

            // Also trigger full symbol change to update other tabs
            await changeSymbol();
        });
    }

    // Also listen for header symbol changes to update Multi-Charts
    const headerSymbol = document.getElementById('symbolSelect');
    if (headerSymbol) {
        headerSymbol.addEventListener('change', function() {
            const symbol = this.value;
            // Update Multi-Charts dropdown to match
            if (multiChartSymbol && multiChartSymbol.value !== symbol) {
                multiChartSymbol.value = symbol;
            }
            // updateMultiCharts will be called via changeSymbol()
        });
    }

    console.log('Multi-Charts symbol change handlers initialized');
}

async function updateChart(panelType) {
    const symbol = document.getElementById('multiChartSymbol')?.value || 'SPY';
    const timeframe = document.getElementById(`${panelType}Timeframe`)?.value;
    const chartType = document.getElementById(`${panelType}ChartType`)?.value;
    const container = document.getElementById(`${panelType}ChartContainer`);
    const loading = document.getElementById(`${panelType}Loading`);
    const settings = getMTFSettings(panelType);
    
    if (loading) loading.style.display = 'block';
    
    try {
        let data = getMultiChartData(panelType, timeframe);
        mtfChartData[panelType] = data;
        
        if (!data || data.length === 0) {
            if (loading) loading.textContent = 'No data available';
            return;
        }
        
        if (chartType === 'heikinashi') {
            data = convertToHeikinAshi(data);
        }
        
        if (chartType === 'pf') {
            renderEnhancedPF(panelType, mtfChartData[panelType], container, settings);
            document.getElementById(`${panelType}Legend`).style.display = 'none';
        } else {
            renderLWChart(panelType, data, chartType, container, settings);
            document.getElementById(`${panelType}Legend`).style.display = 'flex';
        }
        
        // Update price display
        const lastBar = data[data.length - 1];
        const priceEl = document.getElementById(`${panelType}Price`);
        if (priceEl && lastBar) {
            priceEl.textContent = `$${lastBar.close.toFixed(2)}`;
            priceEl.className = lastBar.close >= lastBar.open ? 'price' : 'price down';
        }
        
        // Update signal and bias
        const signal = lastBar.close > (data[data.length - 2]?.close || lastBar.close) ? 'CALL' : 'PUT';
        updateMTFSignal(panelType, signal);
        
        // Calculate and display Fibonacci levels
        if (settings.showFib && chartType !== 'pf') {
            displayMTFFib(panelType, data);
        } else {
            document.getElementById(`${panelType}Fib`).innerHTML = '';
        }

        // Calculate and display SQ9 levels
        if (settings.showSQ9 && chartType !== 'pf') {
            displayMTFSQ9(panelType, data);
        } else {
            var sq9El = document.getElementById(panelType + 'SQ9');
            if (sq9El) sq9El.innerHTML = '';
        }

        // Add visual level overlays to chart
        if (chartType !== 'pf') {
            addOverlaysToMTFChart(panelType, data);
        }

        if (loading) loading.style.display = 'none';
        
    } catch (error) {
        console.error(`Error updating ${panelType} chart:`, error);
        if (loading) loading.textContent = 'Error loading chart';
    }
}

function updateMTFSignal(panel, signal) {
    const signalEl = document.getElementById(`${panel}Signal`);
    const biasEl = document.getElementById(`${panel}Bias`);
    
    if (signalEl) {
        signalEl.textContent = signal;
        signalEl.className = `signal-badge-mtf ${signal.toLowerCase()}`;
    }
    
    if (biasEl) {
        const bias = signal === 'CALL' ? 'BULLISH' : 'BEARISH';
        biasEl.textContent = bias;
        biasEl.className = `value ${bias.toLowerCase()}`;
    }
    
    // Update overall confluence
    const intraday = document.getElementById('intradaySignal')?.textContent || 'HOLD';
    const swing = document.getElementById('swingSignal')?.textContent || 'HOLD';
    const position = document.getElementById('positionSignal')?.textContent || 'HOLD';
    
    let bullish = 0;
    [intraday, swing, position].forEach(s => { if (s === 'CALL') bullish++; });
    
    const overallEl = document.getElementById('overallBias');
    if (overallEl) {
        overallEl.textContent = `${bullish}/3 ${bullish >= 2 ? 'BULLISH' : 'BEARISH'}`;
        overallEl.className = `value ${bullish >= 2 ? 'bullish' : 'bearish'}`;
    }
}

function displayMTFFib(panelType, data) {
    const high = Math.max(...data.map(d => d.high));
    const low = Math.min(...data.map(d => d.low));
    const range = high - low;

    const fib = {
        high: high,
        low: low,
        level382: high - range * 0.382,
        level618: high - range * 0.618
    };

    const fibEl = document.getElementById(`${panelType}Fib`);
    if (fibEl) {
        fibEl.innerHTML = `
            <div class="fib-level-mtf resistance">R: $${fib.high.toFixed(2)}</div>
            <div class="fib-level-mtf resistance">38.2%: $${fib.level382.toFixed(2)}</div>
            <div class="fib-level-mtf support">61.8%: $${fib.level618.toFixed(2)}</div>
            <div class="fib-level-mtf support">S: $${fib.low.toFixed(2)}</div>
        `;
    }
}

// =============================================================================
// SQ9 LEVELS DISPLAY FOR MTF CHARTS (Gann Square of 9)
// =============================================================================

function calculateSQ9LevelsMTF(price, numLevels) {
    numLevels = numLevels || 3;
    var sqrtPrice = Math.sqrt(price);
    var levels = { support: [], resistance: [] };

    for (var i = 1; i <= numLevels; i++) {
        // 45-degree increments on Square of 9
        var increment = (i * 45) / 180.0;

        // Resistance levels (above current price)
        var resLevel = Math.pow(sqrtPrice + increment, 2);
        levels.resistance.push({
            price: resLevel,
            label: 'SQ9 R' + i,
            degrees: i * 45
        });

        // Support levels (below current price)
        if (sqrtPrice > increment) {
            var supLevel = Math.pow(sqrtPrice - increment, 2);
            levels.support.push({
                price: supLevel,
                label: 'SQ9 S' + i,
                degrees: i * 45
            });
        }
    }

    return levels;
}

function displayMTFSQ9(panelType, data) {
    var currentPrice = data[data.length - 1].close;
    var sq9Levels = calculateSQ9LevelsMTF(currentPrice, 3);

    // Get or create SQ9 display element
    var sq9El = document.getElementById(panelType + 'SQ9');
    if (!sq9El) {
        // Create element if it doesn't exist
        var fibEl = document.getElementById(panelType + 'Fib');
        if (fibEl) {
            sq9El = document.createElement('div');
            sq9El.id = panelType + 'SQ9';
            sq9El.className = 'sq9-levels-mtf';
            sq9El.style.cssText = 'display: flex; gap: 8px; font-size: 10px; margin-top: 4px; flex-wrap: wrap;';
            fibEl.parentNode.insertBefore(sq9El, fibEl.nextSibling);
        }
    }

    if (sq9El) {
        var html = '<div style="color: #f59e0b; font-weight: 600; margin-right: 8px;"> SQ9:</div>';

        // Show first 2 resistance levels
        sq9Levels.resistance.slice(0, 2).forEach(function(level) {
            var dist = ((level.price - currentPrice) / currentPrice * 100).toFixed(1);
            html += '<div style="color: #ef4444;">R$' + level.price.toFixed(2) + ' <span style="opacity: 0.7;">(+' + dist + '%)</span></div>';
        });

        // Show first 2 support levels
        sq9Levels.support.slice(0, 2).forEach(function(level) {
            var dist = ((level.price - currentPrice) / currentPrice * 100).toFixed(1);
            html += '<div style="color: #22c55e;">S$' + level.price.toFixed(2) + ' <span style="opacity: 0.7;">(' + dist + '%)</span></div>';
        });

        sq9El.innerHTML = html;
    }
}

// =============================================================================
// CHART LEVEL OVERLAYS - Fibonacci and SQ9 visual overlays on charts
// =============================================================================

// Calculate Fibonacci retracement levels from high and low
function calculateChartFibLevels(high, low) {
    var diff = high - low;
    return [
        { level: '100%', price: high, cssClass: 'fib-resistance', lineType: 'resistance' },
        { level: '78.6%', price: low + (diff * 0.786), cssClass: 'fib-support', lineType: 'support' },
        { level: '61.8%', price: low + (diff * 0.618), cssClass: 'fib-support', lineType: 'support' },
        { level: '50%', price: low + (diff * 0.500), cssClass: 'fib-support', lineType: 'support' },
        { level: '38.2%', price: low + (diff * 0.382), cssClass: 'fib-support', lineType: 'support' },
        { level: '23.6%', price: low + (diff * 0.236), cssClass: 'fib-support', lineType: 'support' },
        { level: '0%', price: low, cssClass: 'fib-support', lineType: 'support' }
    ];
}

// Get SQ9 levels for chart overlay - uses range-adaptive increments
function getChartSQ9Levels(currentPrice, chartHigh, chartLow) {
    var sqrtPrice = Math.sqrt(currentPrice);
    var levels = [];
    var chartRange = chartHigh - chartLow;

    // Use smaller increments for tight ranges (intraday), larger for wide ranges
    // 45 degrees = ~$13 gap at $700, 11.25 degrees = ~$3.25 gap
    var baseAngle = chartRange < 20 ? 11.25 : (chartRange < 50 ? 22.5 : 45);

    // Calculate 2 support and 2 resistance levels
    for (var i = 1; i <= 2; i++) {
        var increment = (i * baseAngle) / 180.0;

        // Resistance
        var resPrice = Math.pow(sqrtPrice + increment, 2);
        levels.push({
            level: 'SQ9 R' + i,
            price: resPrice,
            cssClass: 'sq9-resistance',
            lineType: 'sq9'
        });

        // Support
        if (sqrtPrice > increment) {
            var supPrice = Math.pow(sqrtPrice - increment, 2);
            levels.push({
                level: 'SQ9 S' + i,
                price: supPrice,
                cssClass: 'sq9-support',
                lineType: 'sq9'
            });
        }
    }

    return levels;
}

// Render level overlays on chart container
function renderChartLevelOverlays(containerId, high, low, currentPrice, showFib, showSQ9) {
    var container = document.getElementById(containerId);
    if (!container) return;

    // Remove existing overlays
    container.querySelectorAll('.chart-level-label, .chart-level-line').forEach(function(el) {
        el.remove();
    });

    // Ensure container has relative positioning
    container.style.position = 'relative';

    var allLevels = [];

    // Add Fibonacci levels
    if (showFib !== false) {
        var fibLevels = calculateChartFibLevels(high, low);
        allLevels = allLevels.concat(fibLevels);
    }

    // Add SQ9 levels (pass chart range for adaptive increments)
    if (showSQ9 !== false) {
        var sq9Levels = getChartSQ9Levels(currentPrice, high, low);
        console.log(' Chart Overlays:', containerId, 'SQ9 enabled:', showSQ9, 'Levels:', sq9Levels.length, 'Range:', (high - low).toFixed(2));
        allLevels = allLevels.concat(sq9Levels);
    }

    // Calculate chart range with padding
    var priceRange = high - low;
    var padding = priceRange * 0.1;
    var chartHigh = high + padding;
    var chartLow = low - padding;
    var chartRange = chartHigh - chartLow;

    // Render each level
    allLevels.forEach(function(levelData) {
        if (!levelData.price || levelData.price <= 0) return;

        // Calculate Y position (percentage from top)
        var yPercent = ((chartHigh - levelData.price) / chartRange) * 100;

        // Skip if outside visible range (widened to 0-100 for SQ9 levels)
        if (yPercent < 0 || yPercent > 100) {
            console.log(' Filtered out:', levelData.level, 'price:', levelData.price.toFixed(2), 'yPercent:', yPercent.toFixed(1));
            return;
        }

        // Create dashed line
        var line = document.createElement('div');
        line.className = 'chart-level-line ' + levelData.lineType;
        line.style.top = yPercent + '%';
        container.appendChild(line);

        // Create compact label (single line: "78.6% $620.47")
        var label = document.createElement('div');
        label.className = 'chart-level-label ' + levelData.cssClass;
        label.style.top = 'calc(' + yPercent + '% - 8px)';
        label.textContent = levelData.level + ' $' + levelData.price.toFixed(2);
        container.appendChild(label);
        console.log(' Added:', levelData.level, '$' + levelData.price.toFixed(2), 'y=' + yPercent.toFixed(1) + '%', levelData.cssClass);
    });
}

// Add overlays to MTF chart panels
function addOverlaysToMTFChart(panelType, data) {
    if (!data || data.length === 0) return;

    var containerId = panelType + 'ChartContainer';
    var high = Math.max.apply(null, data.map(function(d) { return d.high; }));
    var low = Math.min.apply(null, data.map(function(d) { return d.low; }));
    var currentPrice = data[data.length - 1].close;

    // Check settings - read directly from checkboxes
    var fibCheckbox = document.getElementById(panelType + 'ShowFib');
    var sq9Checkbox = document.getElementById(panelType + 'ShowSQ9');
    var showFib = fibCheckbox ? fibCheckbox.checked : true;
    var showSQ9 = sq9Checkbox ? sq9Checkbox.checked : true;

    console.log(' addOverlaysToMTFChart:', panelType,
        'SQ9 checkbox found:', !!sq9Checkbox,
        'SQ9 checked:', showSQ9,
        'Price:', currentPrice.toFixed(2));

    renderChartLevelOverlays(containerId, high, low, currentPrice, showFib, showSQ9);
}

function renderLWChart(panelType, data, chartType, container, settings) {
    // Clear existing chart
    if (lwChartInstances[panelType]) {
        lwChartInstances[panelType].remove();
        lwChartInstances[panelType] = null;
    }
    container.innerHTML = '';
    
    // Check if LightweightCharts is available
    if (typeof LightweightCharts === 'undefined') {
        console.warn('LightweightCharts not loaded, falling back to basic chart');
        renderFallbackChart(panelType, data, chartType, container);
        return;
    }
    
    const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: container.clientHeight || 350,
        layout: { background: { color: '#ffffff' }, textColor: '#333' },
        grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
        rightPriceScale: { borderColor: '#e0e0e0' },
        timeScale: { borderColor: '#e0e0e0', timeVisible: true }
    });
    
    lwChartInstances[panelType] = chart;
    
    // Convert data to LightweightCharts format
    const lwData = data.map((bar, i) => ({
        time: Math.floor(Date.now() / 1000) - (data.length - i) * 86400,
        open: bar.open,
        high: bar.high,
        low: bar.low,
        close: bar.close
    }));
    
    let mainSeries;
    if (chartType === 'line') {
        mainSeries = chart.addLineSeries({ color: '#2962FF', lineWidth: 2 });
        mainSeries.setData(lwData.map(d => ({ time: d.time, value: d.close })));
    } else {
        mainSeries = chart.addCandlestickSeries({
            upColor: chartType === 'heikinashi' ? '#4caf50' : '#26a69a',
            downColor: chartType === 'heikinashi' ? '#f44336' : '#ef5350',
            borderVisible: false,
            wickUpColor: chartType === 'heikinashi' ? '#4caf50' : '#26a69a',
            wickDownColor: chartType === 'heikinashi' ? '#f44336' : '#ef5350'
        });
        mainSeries.setData(lwData);
    }
    
    // Add EMAs if enabled
    if (settings.showEMA) {
        const ema9 = calculateEMAForLW(data, 9);
        const ema21 = calculateEMAForLW(data, 21);
        const ema50 = calculateEMAForLW(data, 50);
        
        const ema9Data = ema9.map((val, i) => ({ time: lwData[i].time, value: val }));
        const ema21Data = ema21.map((val, i) => ({ time: lwData[i].time, value: val }));
        const ema50Data = ema50.map((val, i) => ({ time: lwData[i].time, value: val }));
        
        chart.addLineSeries({ color: '#f59e0b', lineWidth: 1, crosshairMarkerVisible: false, priceLineVisible: false, lastValueVisible: false }).setData(ema9Data);
        chart.addLineSeries({ color: '#3b82f6', lineWidth: 1, crosshairMarkerVisible: false, priceLineVisible: false, lastValueVisible: false }).setData(ema21Data);
        chart.addLineSeries({ color: '#8b5cf6', lineWidth: 1, crosshairMarkerVisible: false, priceLineVisible: false, lastValueVisible: false }).setData(ema50Data);
    }
    
    // Add volume if enabled - displayed in bottom 25% of chart
    if (settings.showVolume) {
        const volSeries = chart.addHistogramSeries({
            priceFormat: { type: 'volume' },
            priceScaleId: 'volume',
            scaleMargins: { top: 0.75, bottom: 0 }
        });
        volSeries.priceScale().applyOptions({
            scaleMargins: { top: 0.75, bottom: 0 }
        });
        volSeries.setData(lwData.map((d, i) => ({
            time: d.time,
            value: data[i].volume || 1000000,
            color: d.close >= d.open ? 'rgba(38,166,154,0.6)' : 'rgba(239,83,80,0.6)'
        })));
    }
    
    chart.timeScale().fitContent();
}

function calculateEMAForLW(data, period) {
    const k = 2 / (period + 1);
    const result = [];
    let ema = data[0]?.close || 0;
    
    for (let i = 0; i < data.length; i++) {
        ema = i === 0 ? data[i].close : data[i].close * k + ema * (1 - k);
        result.push(ema);
    }
    return result;
}

function renderFallbackChart(panelType, data, chartType, container) {
    // Create canvas for fallback
    container.innerHTML = '<canvas style="width:100%;height:100%"></canvas>';
    const canvas = container.querySelector('canvas');
    renderMultiCandlestickChart(panelType, data, chartType, canvas);
}

// P&F Pattern Detection
function detectPFPatterns(columns) {
    if (columns.length < 3) return { pattern: null, signal: 'HOLD' };
    
    const patterns = [];
    const len = columns.length;
    const c1 = columns[len - 1];
    const c3 = len >= 3 ? columns[len - 3] : null;
    const c5 = len >= 5 ? columns[len - 5] : null;
    
    if (c3 && c1.type === 'X' && c3.type === 'X') {
        const c1High = Math.max(...c1.boxes);
        const c3High = Math.max(...c3.boxes);
        if (c1High > c3High) {
            patterns.push({ name: 'Double Top Breakout', type: 'bullish', strength: 85 });
        }
    }
    
    if (c3 && c1.type === 'O' && c3.type === 'O') {
        const c1Low = Math.min(...c1.boxes);
        const c3Low = Math.min(...c3.boxes);
        if (c1Low < c3Low) {
            patterns.push({ name: 'Double Bottom Breakdown', type: 'bearish', strength: 85 });
        }
    }
    
    if (c5 && c1.type === 'X' && c3.type === 'X' && c5.type === 'X') {
        const c1High = Math.max(...c1.boxes);
        const c3High = Math.max(...c3.boxes);
        const c5High = Math.max(...c5.boxes);
        if (c1High > c3High && c1High > c5High) {
            patterns.push({ name: 'Triple Top Breakout', type: 'bullish', strength: 95 });
        }
    }
    
    if (c5 && c1.type === 'O' && c3.type === 'O' && c5.type === 'O') {
        const c1Low = Math.min(...c1.boxes);
        const c3Low = Math.min(...c3.boxes);
        const c5Low = Math.min(...c5.boxes);
        if (c1Low < c3Low && c1Low < c5Low) {
            patterns.push({ name: 'Triple Bottom Breakdown', type: 'bearish', strength: 95 });
        }
    }
    
    if (patterns.length === 0) {
        patterns.push(c1.type === 'X' 
            ? { name: 'Uptrend in Progress', type: 'bullish', strength: 60 }
            : { name: 'Downtrend in Progress', type: 'bearish', strength: 60 });
    }
    
    const strongest = patterns.sort((a, b) => b.strength - a.strength)[0];
    return { pattern: strongest, signal: strongest.type === 'bullish' ? 'CALL' : 'PUT' };
}

function renderEnhancedPF(panelType, data, container, settings) {
    if (lwChartInstances[panelType]) {
        lwChartInstances[panelType].remove();
        lwChartInstances[panelType] = null;
    }
    
    container.innerHTML = '';
    const canvas = document.createElement('canvas');
    canvas.width = container.clientWidth || 400;
    canvas.height = container.clientHeight || 350;
    container.appendChild(canvas);
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width, height = canvas.height;
    
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, width, height);
    
    if (!data || data.length < 10) {
        ctx.fillStyle = '#666';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Not enough data for P&F', width/2, height/2);
        return;
    }
    
    // Calculate box size
    const avgPrice = data.reduce((s, b) => s + b.close, 0) / data.length;
    let boxSize = avgPrice < 5 ? 0.25 : avgPrice < 20 ? 0.5 : avgPrice < 100 ? 1 : avgPrice < 200 ? 2 : avgPrice < 500 ? 4 : 8;
    if (panelType === 'intraday') boxSize *= 0.5;
    if (panelType === 'position') boxSize *= 1.5;
    
    const columns = generatePFCols(data, boxSize, 3);
    const patternResult = detectPFPatterns(columns);
    
    // Display pattern alert
    const patternEl = document.getElementById(`${panelType}Pattern`);
    if (settings.showPatterns && patternResult.pattern) {
        patternEl.style.display = 'block';
        patternEl.className = `pattern-alert-mtf ${patternResult.pattern.type}`;
        patternEl.innerHTML = `${patternResult.pattern.type === 'bullish' ? '' : ''} <strong>${patternResult.pattern.name}</strong> <span style="float:right;">Strength: ${patternResult.pattern.strength}%</span>`;
        updateMTFSignal(panelType, patternResult.signal);
    } else {
        patternEl.style.display = 'none';
    }
    
    if (columns.length === 0) {
        ctx.fillStyle = '#666';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No P&F reversals', width/2, height/2);
        return;
    }
    
    // Find price range
    let minP = Infinity, maxP = -Infinity;
    columns.forEach(c => c.boxes.forEach(p => { minP = Math.min(minP, p); maxP = Math.max(maxP, p); }));
    minP -= boxSize * 2;
    maxP += boxSize * 2;
    
    const pad = { top: 40, right: 50, bottom: 20, left: 50 };
    const cw = width - pad.left - pad.right;
    const ch = height - pad.top - pad.bottom;
    const maxCols = Math.min(columns.length, 35);
    const dispCols = columns.slice(-maxCols);
    const colW = Math.min(14, cw / dispCols.length);
    
    // Draw grid
    ctx.strokeStyle = '#f0f0f0';
    ctx.lineWidth = 0.5;
    for (let p = minP; p <= maxP; p += boxSize) {
        const y = pad.top + ch - ((p - minP) / (maxP - minP)) * ch;
        ctx.beginPath();
        ctx.moveTo(pad.left, y);
        ctx.lineTo(width - pad.right, y);
        ctx.stroke();
    }
    
    // Draw price labels
    ctx.fillStyle = '#666';
    ctx.font = '9px Arial';
    ctx.textAlign = 'right';
    const step = Math.max(1, Math.floor((maxP - minP) / boxSize / 10)) * boxSize;
    for (let p = Math.ceil(minP / step) * step; p <= maxP; p += step) {
        const y = pad.top + ch - ((p - minP) / (maxP - minP)) * ch;
        ctx.fillText(p.toFixed(0), pad.left - 5, y + 3);
    }
    
    // Draw X's and O's
    const fs = Math.max(8, Math.min(12, colW - 1));
    ctx.font = `bold ${fs}px Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    dispCols.forEach((col, i) => {
        const x = pad.left + (i + 0.5) * colW;
        col.boxes.forEach(price => {
            const y = pad.top + ch - ((price - minP) / (maxP - minP)) * ch;
            ctx.fillStyle = col.type === 'X' ? '#26a69a' : '#ef5350';
            ctx.fillText(col.type, x, y);
        });
    });
    
    // Title
    ctx.fillStyle = '#333';
    ctx.font = 'bold 11px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('Point & Figure Chart', pad.left, 15);
    ctx.font = '10px Arial';
    ctx.fillStyle = '#666';
    ctx.fillText(`Box: $${boxSize.toFixed(2)} | Rev: 3`, pad.left + 110, 15);
    
    // Pattern name
    if (settings.showPatterns && patternResult.pattern) {
        ctx.font = 'bold 10px Arial';
        ctx.fillStyle = patternResult.pattern.type === 'bullish' ? '#059669' : '#dc2626';
        ctx.textAlign = 'center';
        ctx.fillText(patternResult.pattern.name, width / 2, 30);
    }
}

function getMultiChartData(panelType, timeframe) {
    if (!currentData || currentData.length === 0) return [];
    
    let data = currentData.map(bar => ({
        date: bar.Date,
        open: parseFloat(bar.Open) || 0,
        high: parseFloat(bar.High) || 0,
        low: parseFloat(bar.Low) || 0,
        close: parseFloat(bar.Close) || 0,
        volume: parseFloat(bar.Volume) || 0
    })).filter(bar => bar.close > 0);
    
    if (panelType === 'intraday') {
        // Simulate intraday bars from daily data
        var minutes = 15;
        if (timeframe === '1m') minutes = 1;
        else if (timeframe === '5m') minutes = 5;
        else if (timeframe === '15m') minutes = 15;
        else if (timeframe === '30m') minutes = 30;
        else if (timeframe === '1h') minutes = 60;
        return simulateIntradayBars(data.slice(-5), minutes);
    }
    
    if (panelType === 'swing') {
        if (timeframe === '1w' || timeframe === 'W') return aggregateWeekly(data);
        if (timeframe === '4h') return simulate4HourBars(data.slice(-15));
        if (timeframe === '1h') return simulate1HourBars(data.slice(-10));
        return data.slice(-60); // Daily
    }
    
    if (panelType === 'position') {
        if (timeframe === '3M' || timeframe === 'Q') return aggregateQuarterly(data);
        if (timeframe === '1w' || timeframe === 'W') return aggregateWeekly(data);
        if (timeframe === '1M') return aggregateMonthly(data);
        return data.slice(-90); // Daily
    }
    
    return data;
}


function simulate4HourBars(dailyData) {
    var bars = [];
    dailyData.forEach(function(day) {
        for (var i = 0; i < 6; i++) {
            var range = day.high - day.low;
            var variance = range / 6;
            var basePrice = day.open + (day.close - day.open) * (i / 6);
            bars.push({
                date: day.date + ' ' + (9 + i * 4) + ':00',
                open: basePrice + (Math.random() - 0.5) * variance,
                high: basePrice + Math.random() * variance,
                low: basePrice - Math.random() * variance,
                close: basePrice + (Math.random() - 0.5) * variance,
                volume: Math.floor(day.volume / 6)
            });
        }
    });
    return bars.slice(-60);
}

function simulate1HourBars(dailyData) {
    var bars = [];
    dailyData.forEach(function(day) {
        for (var i = 0; i < 7; i++) {
            var range = day.high - day.low;
            var variance = range / 7;
            var basePrice = day.open + (day.close - day.open) * (i / 7);
            bars.push({
                date: day.date + ' ' + (9 + i) + ':30',
                open: basePrice + (Math.random() - 0.5) * variance,
                high: basePrice + Math.random() * variance,
                low: basePrice - Math.random() * variance,
                close: basePrice + (Math.random() - 0.5) * variance,
                volume: Math.floor(day.volume / 7)
            });
        }
    });
    return bars.slice(-60);
}

function simulateIntradayBars(dailyData, minutes) {
    const intradayBars = [];
    const barsPerDay = Math.floor(390 / minutes);
    
    dailyData.forEach(day => {
        const range = day.high - day.low;
        for (let i = 0; i < barsPerDay; i++) {
            const progress = i / barsPerDay;
            const basePrice = day.open + (day.close - day.open) * progress;
            const noise = (Math.random() - 0.5) * range * 0.3;
            
            const open = i === 0 ? day.open : intradayBars[intradayBars.length - 1]?.close || basePrice;
            const close = basePrice + noise;
            
            intradayBars.push({
                date: day.date,
                time: `${Math.floor(9.5 + (i * minutes) / 60)}:${String((30 + i * minutes) % 60).padStart(2, '0')}`,
                open: open,
                high: Math.max(open, close) + Math.random() * range * 0.1,
                low: Math.min(open, close) - Math.random() * range * 0.1,
                close: close,
                volume: day.volume / barsPerDay
            });
        }
    });
    return intradayBars.slice(-50);
}

function aggregateWeekly(dailyData) {
    const weeks = {};
    dailyData.forEach(bar => {
        const date = new Date(bar.date);
        const weekStart = new Date(date);
        weekStart.setDate(date.getDate() - date.getDay());
        const weekKey = weekStart.toISOString().split('T')[0];
        
        if (!weeks[weekKey]) {
            weeks[weekKey] = { date: weekKey, open: bar.open, high: bar.high, low: bar.low, close: bar.close, volume: bar.volume };
        } else {
            weeks[weekKey].high = Math.max(weeks[weekKey].high, bar.high);
            weeks[weekKey].low = Math.min(weeks[weekKey].low, bar.low);
            weeks[weekKey].close = bar.close;
            weeks[weekKey].volume += bar.volume;
        }
    });
    return Object.values(weeks).slice(-30);
}

function aggregateMonthly(dailyData) {
    const months = {};
    dailyData.forEach(bar => {
        const date = new Date(bar.date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        
        if (!months[monthKey]) {
            months[monthKey] = { date: monthKey + '-01', open: bar.open, high: bar.high, low: bar.low, close: bar.close, volume: bar.volume };
        } else {
            months[monthKey].high = Math.max(months[monthKey].high, bar.high);
            months[monthKey].low = Math.min(months[monthKey].low, bar.low);
            months[monthKey].close = bar.close;
            months[monthKey].volume += bar.volume;
        }
    });
    return Object.values(months).slice(-24);
}

function aggregateQuarterly(dailyData) {
    const quarters = {};
    dailyData.forEach(bar => {
        const date = new Date(bar.date);
        const quarter = Math.floor(date.getMonth() / 3) + 1;
        const quarterKey = `${date.getFullYear()}-Q${quarter}`;
        
        if (!quarters[quarterKey]) {
            quarters[quarterKey] = { date: `${date.getFullYear()}-${String((quarter - 1) * 3 + 1).padStart(2, '0')}-01`, open: bar.open, high: bar.high, low: bar.low, close: bar.close, volume: bar.volume };
        } else {
            quarters[quarterKey].high = Math.max(quarters[quarterKey].high, bar.high);
            quarters[quarterKey].low = Math.min(quarters[quarterKey].low, bar.low);
            quarters[quarterKey].close = bar.close;
            quarters[quarterKey].volume += bar.volume;
        }
    });
    return Object.values(quarters).slice(-12);
}

function convertToHeikinAshi(data) {
    if (!data || data.length === 0) return [];
    const haData = [];
    
    data.forEach((bar, i) => {
        const haBar = { ...bar };
        if (i === 0) {
            haBar.open = (bar.open + bar.close) / 2;
            haBar.close = (bar.open + bar.high + bar.low + bar.close) / 4;
        } else {
            const prevHA = haData[i - 1];
            haBar.open = (prevHA.open + prevHA.close) / 2;
            haBar.close = (bar.open + bar.high + bar.low + bar.close) / 4;
        }
        haBar.high = Math.max(bar.high, haBar.open, haBar.close);
        haBar.low = Math.min(bar.low, haBar.open, haBar.close);
        haData.push(haBar);
    });
    return haData;
}

function generatePFCols(data, boxSize, reversal) {
    if (!data || data.length === 0) return [];
    
    const columns = [];
    let currentCol = { type: 'X', boxes: [Math.floor(data[0].close / boxSize) * boxSize] };
    
    data.forEach(bar => {
        const high = Math.floor(bar.high / boxSize) * boxSize;
        const low = Math.floor(bar.low / boxSize) * boxSize;
        const lastBox = currentCol.boxes[currentCol.boxes.length - 1];
        
        if (currentCol.type === 'X') {
            if (high > lastBox) {
                for (let p = lastBox + boxSize; p <= high; p += boxSize) currentCol.boxes.push(p);
            } else if (lastBox - low >= reversal * boxSize) {
                columns.push(currentCol);
                currentCol = { type: 'O', boxes: [] };
                for (let p = lastBox - boxSize; p >= low; p -= boxSize) currentCol.boxes.push(p);
            }
        } else {
            if (low < lastBox) {
                for (let p = lastBox - boxSize; p >= low; p -= boxSize) currentCol.boxes.push(p);
            } else if (high - lastBox >= reversal * boxSize) {
                columns.push(currentCol);
                currentCol = { type: 'X', boxes: [] };
                for (let p = lastBox + boxSize; p <= high; p += boxSize) currentCol.boxes.push(p);
            }
        }
    });
    
    if (currentCol.boxes.length > 0) columns.push(currentCol);
    return columns.slice(-30);
}

// Keep old function for fallback
function renderMultiCandlestickChart(panelType, data, chartType, canvas) {
    const ctx = canvas.getContext('2d');
    
    if (multiChartInstances && multiChartInstances[panelType]) {
        multiChartInstances[panelType].destroy();
    }
    
    const labels = data.map((bar, i) => {
        if (bar.time) return bar.time;
        const dateStr = bar.date?.split('T')[0] || '';
        return dateStr.slice(5);
    });
    
    const upColor = chartType === 'heikinashi' ? '#4caf50' : '#26a69a';
    const downColor = chartType === 'heikinashi' ? '#f44336' : '#ef5350';
    
    if (typeof Chart !== 'undefined') {
        multiChartInstances[panelType] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Price',
                    data: data.map(bar => bar.close),
                    backgroundColor: data.map(bar => bar.close >= bar.open ? upColor : downColor),
                    borderColor: data.map(bar => bar.close >= bar.open ? upColor : downColor),
                    borderWidth: 1,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: '#787b86', maxTicksLimit: 8, font: { size: 9 } } },
                    y: { display: true, position: 'right', grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: '#787b86', font: { size: 9 } } }
                }
            }
        });
    }
}

// Initialize multi-charts when tab is clicked
document.addEventListener('DOMContentLoaded', function() {
    // Initialize symbol change handlers
    initMultiChartsSymbolChange();

    const multiChartsTab = document.querySelector('[data-tab="multi-charts"]');
    if (multiChartsTab) {
        multiChartsTab.addEventListener('click', function() {
            setTimeout(initMultiCharts, 100);
        });
    }
});


// ============================================
// DAILY ANALYSIS SYSTEM
// ============================================

let currentAnalysisMode = 'morning';
let dailyAnalysisData = null;

// Initialize Daily Analysis when tab is clicked
document.addEventListener('DOMContentLoaded', function() {
    const analysisTab = document.querySelector('[data-tab="daily-analysis"]');
    if (analysisTab) {
        analysisTab.addEventListener('click', async function() {
            await loadRealAgentSignals();
            setTimeout(generateDailyReport, 100);
        });
    }
    
    // Pre-load agent signals on page load
    loadRealAgentSignals();
    
    // Auto-generate reports at scheduled times
    checkScheduledAnalysis();
    setInterval(checkScheduledAnalysis, 60000); // Check every minute
});

function checkScheduledAnalysis() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    
    // Morning analysis at 9:35 AM
    if (hours === 9 && minutes === 35) {
        currentAnalysisMode = 'morning';
        generateDailyReport();
    }
    
    // Evening analysis at 6:00 PM
    if (hours === 18 && minutes === 0) {
        currentAnalysisMode = 'evening';
        generateDailyReport();
    }
}

function switchAnalysisMode(mode) {
    currentAnalysisMode = mode;
    
    // Update button states
    document.getElementById('morningBtn')?.classList.toggle('active', mode === 'morning');
    document.getElementById('eveningBtn')?.classList.toggle('active', mode === 'evening');
    
    // Update title
    const planTitle = document.getElementById('planTitle');
    if (planTitle) {
        planTitle.textContent = mode === 'morning' ? ' Morning Trading Plan' : ' Evening Review & Next Day Plan';
    }
    
    generateDailyReport();
}

function refreshAnalysis() {
    generateDailyReport();
}

// AI Quick Analysis for Overview Tab
function refreshOverviewAI() {
    updateOverviewAiAnalysis();
}

function updateOverviewAiAnalysis() {
    const analysisEl = document.getElementById('overviewAiAnalysis');
    if (!analysisEl) return;

    if (!currentData || currentData.length < 2) {
        analysisEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);"><div style="font-size:24px;margin-bottom:8px;">&#9888;</div>Loading data...</div>';
        return;
    }

    const lastBar = currentData[currentData.length - 1];
    const prevBar = currentData[currentData.length - 2];
    const price = parseFloat(lastBar.Close) || 0;
    const prevClose = parseFloat(prevBar.Close) || price;
    const change = price - prevClose;
    const changePct = ((change / prevClose) * 100).toFixed(2);
    const atr = parseFloat(lastBar.ATR) || price * 0.015;
    const bias = lastBar.Bias || 'NEUTRAL';
    const volume = parseInt(lastBar.Volume) || 0;

    // Calculate 20-day average volume
    const recentData = currentData.slice(-20);
    const avgVol = recentData.reduce((sum, d) => sum + (parseInt(d.Volume) || 0), 0) / recentData.length;
    const volRatio = avgVol > 0 ? (volume / avgVol * 100).toFixed(0) : 100;

    // Determine signal strength
    const fastSMA = parseFloat(lastBar.FastSMA) || price;
    const slowSMA = parseFloat(lastBar.SlowSMA) || price;
    const priceVsFast = price > fastSMA ? 'above' : 'below';
    const fastVsSlow = fastSMA > slowSMA ? 'bullish' : 'bearish';

    // Build AI analysis
    const direction = bias === 'BULLISH' ? 'bullish' : bias === 'BEARISH' ? 'bearish' : 'neutral';
    const optionType = bias === 'BULLISH' ? 'CALL' : bias === 'BEARISH' ? 'PUT' : 'neutral';
    const momentum = change > 0 ? 'positive' : 'negative';

    // Calculate key levels
    const entryZoneLow = (price - atr * 0.3).toFixed(2);
    const entryZoneHigh = bias === 'BULLISH' ? price.toFixed(2) : (price + atr * 0.3).toFixed(2);
    const entryZone = bias === 'BULLISH' ?
        '$' + entryZoneLow + ' - $' + price.toFixed(2) :
        '$' + price.toFixed(2) + ' - $' + (price + atr * 0.3).toFixed(2);
    const stopLoss = bias === 'BULLISH' ? (price - atr * 0.75).toFixed(2) : (price + atr * 0.75).toFixed(2);
    const target1 = bias === 'BULLISH' ? (price + atr * 1.5).toFixed(2) : (price - atr * 1.5).toFixed(2);
    const target2 = bias === 'BULLISH' ? (price + atr * 2.5).toFixed(2) : (price - atr * 2.5).toFixed(2);

    // Confidence score
    let confidence = 50;
    if (bias === 'BULLISH' && price > fastSMA) confidence += 15;
    if (bias === 'BEARISH' && price < fastSMA) confidence += 15;
    if (parseInt(volRatio) > 100) confidence += 10;
    if (Math.abs(parseFloat(changePct)) > 0.5) confidence += 5;
    confidence = Math.min(95, confidence);

    const confColor = confidence >= 75 ? 'var(--success)' : confidence >= 60 ? 'var(--warning)' : 'var(--danger)';
    const signalColor = bias === 'BULLISH' ? 'var(--success)' : bias === 'BEARISH' ? 'var(--danger)' : 'var(--muted)';
    const volMsg = parseInt(volRatio) > 120 ? 'High volume confirms the move.' :
                   parseInt(volRatio) < 80 ? 'Low volume - move may lack conviction.' :
                   'Normal volume activity.';
    const confMsg = confidence >= 75 ? 'High confidence - favorable setup' :
                    confidence >= 60 ? 'Moderate confidence - smaller size' :
                    'Low confidence - consider waiting';
    const dteText = tradingMode === 'INTRADAY' ? '0-1 days' : '3-7 days';

    analysisEl.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
            <div>
                <div style="background:rgba(59,130,246,0.1);padding:12px;border-radius:8px;margin-bottom:10px;">
                    <strong style="color:var(--primary);">Market Snapshot</strong><br>
                    <span style="font-size:11px;">
                        ${currentSymbol} is showing <strong style="color:${signalColor};">${direction}</strong> bias with
                        <strong style="color:${momentum === 'positive' ? 'var(--success)' : 'var(--danger)'};">
                            ${parseFloat(changePct) > 0 ? '+' : ''}${changePct}%
                        </strong> move today.<br>
                        Price is ${priceVsFast} the 9-SMA with ${fastVsSlow} SMA crossover.
                    </span>
                </div>

                <div style="background:rgba(16,185,129,0.1);padding:12px;border-radius:8px;">
                    <strong style="color:var(--success);">Trade Setup</strong><br>
                    <span style="font-size:11px;">
                        <strong>Signal:</strong> <span style="color:${signalColor};font-weight:700;">${optionType}</span><br>
                        <strong>Entry Zone:</strong> ${entryZone}<br>
                        <strong>Stop Loss:</strong> <span style="color:var(--danger);">$${stopLoss}</span><br>
                        <strong>Target 1:</strong> <span style="color:var(--success);">$${target1}</span><br>
                        <strong>Target 2:</strong> <span style="color:var(--success);">$${target2}</span>
                    </span>
                </div>
            </div>

            <div>
                <div style="background:rgba(139,92,246,0.1);padding:12px;border-radius:8px;margin-bottom:10px;">
                    <strong style="color:#8b5cf6;">Volume Analysis</strong><br>
                    <span style="font-size:11px;">
                        Today's volume is at <strong>${volRatio}%</strong> of 20-day average.<br>
                        ${volMsg}
                    </span>
                </div>

                <div style="background:rgba(245,158,11,0.1);padding:12px;border-radius:8px;">
                    <strong style="color:var(--warning);">Confidence</strong><br>
                    <span style="font-size:11px;">
                        <div style="display:flex;align-items:center;gap:10px;margin-top:5px;">
                            <div style="flex:1;background:var(--border);border-radius:4px;height:8px;">
                                <div style="width:${confidence}%;background:${confColor};height:100%;border-radius:4px;"></div>
                            </div>
                            <strong style="color:${confColor};">${confidence}%</strong>
                        </div>
                        <div style="margin-top:5px;">
                            ${confMsg}
                        </div>
                    </span>
                </div>
            </div>
        </div>

        <div style="margin-top:12px;padding:10px;background:var(--bg);border-radius:6px;font-size:11px;color:var(--muted);">
            ATR: $${atr.toFixed(2)} | Risk/Reward: 1:2 minimum | DTE: ${dteText}
        </div>
    `;
}

// Data Pattern Detection with Dates
function updateDataPatternDetection() {
    const detectionEl = document.getElementById('dataPatternDetection');
    if (!detectionEl) return;

    if (!currentData || currentData.length < 10) {
        detectionEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);"><div style="font-size:24px;margin-bottom:8px;">&#9888;</div>Insufficient data for pattern detection</div>';
        return;
    }

    // Format date as "Mon DD" (e.g., "Dec 2", "Nov 27")
    function formatDateShort(dateStr) {
        const date = new Date(dateStr);
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return months[date.getMonth()] + ' ' + date.getDate();
    }

    // Get last 30 days of data for analysis
    const recentData = currentData.slice(-30);
    const analysisResults = [];

    // 1. UPTREND DETECTION - Check last 5 days for consecutive higher closes
    const last5Days = recentData.slice(-5);
    let uptrendDays = 0;
    for (let i = 1; i < last5Days.length; i++) {
        if (parseFloat(last5Days[i].Close) > parseFloat(last5Days[i-1].Close)) {
            uptrendDays++;
        }
    }

    let downtrendDays = 0;
    for (let i = 1; i < last5Days.length; i++) {
        if (parseFloat(last5Days[i].Close) < parseFloat(last5Days[i-1].Close)) {
            downtrendDays++;
        }
    }

    if (uptrendDays >= 3) {
        const startDate = formatDateShort(last5Days[0].Date || last5Days[0].date);
        const endDate = formatDateShort(last5Days[last5Days.length - 1].Date || last5Days[last5Days.length - 1].date);
        analysisResults.push({
            type: 'uptrend',
            icon: '',
            text: `<strong style="color:#22c55e;">UPTREND</strong> detected in last 5 days (${startDate} - ${endDate})`,
            detail: `${uptrendDays} of 4 days with higher closes`
        });
    } else if (downtrendDays >= 3) {
        const startDate = formatDateShort(last5Days[0].Date || last5Days[0].date);
        const endDate = formatDateShort(last5Days[last5Days.length - 1].Date || last5Days[last5Days.length - 1].date);
        analysisResults.push({
            type: 'downtrend',
            icon: '',
            text: `<strong style="color:#ef4444;">DOWNTREND</strong> detected in last 5 days (${startDate} - ${endDate})`,
            detail: `${downtrendDays} of 4 days with lower closes`
        });
    }

    // 2. HIGH VOLUME DAYS - Find days with >150% of 20-day average volume
    const avgVolume = recentData.slice(-20).reduce((sum, d) => sum + (parseInt(d.Volume) || 0), 0) / 20;
    const highVolumeDays = [];

    recentData.forEach(bar => {
        const vol = parseInt(bar.Volume) || 0;
        if (vol > avgVolume * 1.5) {
            highVolumeDays.push({
                date: formatDateShort(bar.Date || bar.date),
                volume: vol,
                ratio: ((vol / avgVolume) * 100).toFixed(0)
            });
        }
    });

    if (highVolumeDays.length > 0) {
        // Sort by most recent (reverse chronological)
        highVolumeDays.reverse();
        const displayDates = highVolumeDays.slice(0, 5).map(d => d.date);
        const moreCount = highVolumeDays.length > 5 ? ` (+${highVolumeDays.length - 5} more)` : '';
        analysisResults.push({
            type: 'highVolume',
            icon: '',
            text: `<strong style="color:#8b5cf6;">${highVolumeDays.length} HIGH VOLUME</strong> days (&gt;150% of average)`,
            detail: displayDates.join(', ') + moreCount
        });
    }

    // 3. GAP UPs - Find days where Open > Previous Close
    const gapUps = [];
    for (let i = 1; i < recentData.length; i++) {
        const prevClose = parseFloat(recentData[i-1].Close) || 0;
        const currOpen = parseFloat(recentData[i].Open) || 0;
        const gapSize = currOpen - prevClose;

        if (gapSize > 0 && gapSize >= prevClose * 0.002) { // At least 0.2% gap
            gapUps.push({
                date: formatDateShort(recentData[i].Date || recentData[i].date),
                gap: gapSize,
                pct: ((gapSize / prevClose) * 100).toFixed(2)
            });
        }
    }

    if (gapUps.length > 0) {
        // Sort by gap size (largest first)
        gapUps.sort((a, b) => b.gap - a.gap);
        const top3 = gapUps.slice(0, 3);
        const detailLines = top3.map(g => `${g.date}: +$${g.gap.toFixed(2)} gap`);
        const moreCount = gapUps.length > 3 ? `<br><span style="color:var(--muted);font-size:10px;">(showing top 3 by size, +${gapUps.length - 3} more)</span>` : '';
        analysisResults.push({
            type: 'gapUp',
            icon: '',
            text: `<strong style="color:#22c55e;">${gapUps.length} GAP UP(s)</strong> detected`,
            detail: detailLines.join('<br>') + moreCount
        });
    }

    // 4. GAP DOWNs - Find days where Open < Previous Close
    const gapDowns = [];
    for (let i = 1; i < recentData.length; i++) {
        const prevClose = parseFloat(recentData[i-1].Close) || 0;
        const currOpen = parseFloat(recentData[i].Open) || 0;
        const gapSize = prevClose - currOpen;

        if (gapSize > 0 && gapSize >= prevClose * 0.002) { // At least 0.2% gap
            gapDowns.push({
                date: formatDateShort(recentData[i].Date || recentData[i].date),
                gap: gapSize,
                pct: ((gapSize / prevClose) * 100).toFixed(2)
            });
        }
    }

    if (gapDowns.length > 0) {
        // Sort by gap size (largest first)
        gapDowns.sort((a, b) => b.gap - a.gap);
        const top3 = gapDowns.slice(0, 3);
        const detailLines = top3.map(g => `${g.date}: -$${g.gap.toFixed(2)} gap`);
        const moreCount = gapDowns.length > 3 ? `<br><span style="color:var(--muted);font-size:10px;">(showing top 3 by size, +${gapDowns.length - 3} more)</span>` : '';
        analysisResults.push({
            type: 'gapDown',
            icon: '',
            text: `<strong style="color:#ef4444;">${gapDowns.length} GAP DOWN(s)</strong> detected`,
            detail: detailLines.join('<br>') + moreCount
        });
    }

    // Build HTML output
    if (analysisResults.length === 0) {
        detectionEl.innerHTML = `
            <div style="text-align:center;padding:15px;color:var(--muted);">
                <div style="font-size:20px;margin-bottom:8px;"></div>
                No significant patterns detected in last 30 days
            </div>
        `;
        return;
    }

    let html = '<div style="display:flex;flex-direction:column;gap:10px;">';
    analysisResults.forEach(result => {
        const bgColor = result.type === 'uptrend' ? 'rgba(34,197,94,0.1)' :
                        result.type === 'downtrend' ? 'rgba(239,68,68,0.1)' :
                        result.type === 'highVolume' ? 'rgba(139,92,246,0.1)' :
                        result.type === 'gapUp' ? 'rgba(34,197,94,0.08)' :
                        'rgba(239,68,68,0.08)';
        html += `
            <div style="background:${bgColor};padding:10px 12px;border-radius:8px;">
                <div style="font-size:12px;margin-bottom:4px;">
                    ${result.icon} ${result.text}
                </div>
                <div style="font-size:11px;color:var(--muted);padding-left:20px;">
                    ${result.detail}
                </div>
            </div>
        `;
    });
    html += '</div>';

    detectionEl.innerHTML = html;
}

// ============================================
// GANN ANALYSIS FUNCTIONS
// ============================================

// Gann Quotes for rotation
const gannQuotes = [
    '"Time is more important than price." - W.D. Gann',
    '"The future is but a repetition of the past." - W.D. Gann',
    '"When time and price balance, change is imminent." - W.D. Gann',
    '"Every movement in the market is a result of natural law." - W.D. Gann',
    '"The market is never wrong, opinions often are." - W.D. Gann',
    '"Knowledge is the key to success in speculation." - W.D. Gann',
    '"Never trade without stop losses." - W.D. Gann',
    '"Buy and sell on definite rules, not on hope or fear." - W.D. Gann'
];

// Complete ETF Data - ACCURATE PRICES as of Dec 11, 2025
const symbolGannData = {
    SPY: {
        price: 689.12,
        low: 479.05,
        high: 689.70,
        lowDate: 'Oct 27',
        highDate: 'Dec 11',
        sector: 'S&P 500',
        atr: 6.5,
        sacredLevels: [576, 600, 625, 650, 676, 700]
    },
    QQQ: {
        price: 525.80,
        low: 410.50,
        high: 530.25,
        lowDate: 'Oct 27',
        highDate: 'Dec 6',
        sector: 'Nasdaq 100',
        atr: 8.2,
        sacredLevels: [500, 525, 550, 576]
    },
    IWM: {
        price: 234.50,
        low: 195.25,
        high: 244.80,
        lowDate: 'Oct 27',
        highDate: 'Nov 25',
        sector: 'Small Cap',
        atr: 4.1,
        sacredLevels: [225, 234, 244, 256]
    },
    XLE: {
        price: 45.51,
        low: 36.63,
        high: 46.66,
        lowDate: 'Sep 10',
        highDate: 'Dec 11',
        sector: 'Energy',
        atr: 0.9,
        sacredLevels: [40, 45, 49, 52]
    },
    XLF: {
        price: 50.85,
        low: 38.50,
        high: 52.20,
        lowDate: 'Oct 27',
        highDate: 'Dec 6',
        sector: 'Financials',
        atr: 0.9,
        sacredLevels: [45, 49, 52, 56]
    },
    XLK: {
        price: 235.60,
        low: 185.30,
        high: 240.50,
        lowDate: 'Oct 27',
        highDate: 'Dec 6',
        sector: 'Technology',
        atr: 4.5,
        sacredLevels: [216, 225, 240, 256]
    },
    XLV: {
        price: 145.20,
        low: 128.50,
        high: 148.75,
        lowDate: 'Nov 1',
        highDate: 'Dec 4',
        sector: 'Healthcare',
        atr: 2.1,
        sacredLevels: [136, 144, 149, 156]
    },
    XLI: {
        price: 138.90,
        low: 115.25,
        high: 142.30,
        lowDate: 'Oct 27',
        highDate: 'Dec 5',
        sector: 'Industrials',
        atr: 2.3,
        sacredLevels: [125, 133, 141, 150]
    },
    XLB: {
        price: 45.00,
        low: 78.40,
        high: 95.60,
        lowDate: 'Nov 10',
        highDate: 'Dec 2',
        sector: 'Materials',
        atr: 1.6,
        sacredLevels: [81, 90, 96, 103]
    },
    XLU: {
        price: 78.50,
        low: 65.20,
        high: 82.15,
        lowDate: 'Oct 15',
        highDate: 'Nov 28',
        sector: 'Utilities',
        atr: 1.2,
        sacredLevels: [72, 79, 84, 90]
    },
    XLP: {
        price: 82.30,
        low: 72.80,
        high: 85.40,
        lowDate: 'Oct 20',
        highDate: 'Dec 1',
        sector: 'Consumer Staples',
        atr: 1.0,
        sacredLevels: [74, 81, 86, 92]
    },
    XLY: {
        price: 225.45,
        low: 175.60,
        high: 232.80,
        lowDate: 'Oct 27',
        highDate: 'Dec 6',
        sector: 'Consumer Disc',
        atr: 4.2,
        sacredLevels: [196, 216, 233, 250]
    },
    // Individual Stocks
    DIA: {
        price: 438.50,
        low: 370.00,
        high: 450.00,
        lowDate: 'Oct 27',
        highDate: 'Dec 6',
        sector: 'Dow Jones',
        atr: 5.5,
        sacredLevels: [400, 420, 441, 460]
    },
    AAPL: {
        price: 243.00,
        low: 164.00,
        high: 250.00,
        lowDate: 'Apr 19',
        highDate: 'Dec 6',
        sector: 'Tech',
        atr: 3.8,
        sacredLevels: [216, 225, 243, 256]
    },
    MSFT: {
        price: 438.00,
        low: 385.00,
        high: 468.00,
        lowDate: 'Aug 5',
        highDate: 'Jul 5',
        sector: 'Tech',
        atr: 7.2,
        sacredLevels: [400, 420, 441, 460]
    },
    GOOGL: {
        price: 192.00,
        low: 150.00,
        high: 200.00,
        lowDate: 'Aug 5',
        highDate: 'Dec 6',
        sector: 'Tech',
        atr: 3.5,
        sacredLevels: [180, 192, 200, 216]
    },
    AMZN: {
        price: 227.00,
        low: 180.00,
        high: 233.00,
        lowDate: 'Aug 5',
        highDate: 'Dec 6',
        sector: 'Tech',
        atr: 4.8,
        sacredLevels: [216, 225, 233, 250]
    },
    META: {
        price: 617.00,
        low: 490.00,
        high: 638.00,
        lowDate: 'Aug 5',
        highDate: 'Dec 6',
        sector: 'Tech',
        atr: 12.5,
        sacredLevels: [576, 600, 625, 650]
    },
    NVDA: {
        price: 140.00,
        low: 90.00,
        high: 152.00,
        lowDate: 'Aug 5',
        highDate: 'Nov 21',
        sector: 'Tech',
        atr: 4.5,
        sacredLevels: [125, 133, 144, 156]
    },
    TSLA: {
        price: 389.00,
        low: 182.00,
        high: 415.00,
        lowDate: 'Aug 5',
        highDate: 'Dec 11',
        sector: 'Tech',
        atr: 15.0,
        sacredLevels: [360, 380, 400, 420]
    },
    AMD: {
        price: 125.00,
        low: 120.00,
        high: 186.00,
        lowDate: 'Aug 5',
        highDate: 'Mar 8',
        sector: 'Tech',
        atr: 4.2,
        sacredLevels: [120, 125, 133, 144]
    },
    ORCL: {
        price: 172.00,
        low: 140.00,
        high: 198.00,
        lowDate: 'Aug 5',
        highDate: 'Dec 9',
        sector: 'Tech',
        atr: 4.0,
        sacredLevels: [160, 169, 180, 196]
    },
    CSCO: {
        price: 58.00,
        low: 45.00,
        high: 60.00,
        lowDate: 'Aug 5',
        highDate: 'Dec 6',
        sector: 'Tech',
        atr: 1.0,
        sacredLevels: [52, 56, 60, 64]
    },
    JPM: {
        price: 243.00,
        low: 195.00,
        high: 253.00,
        lowDate: 'Aug 5',
        highDate: 'Dec 6',
        sector: 'Financial',
        atr: 4.5,
        sacredLevels: [225, 234, 243, 256]
    },
    MA: {
        price: 522.00,
        low: 450.00,
        high: 537.00,
        lowDate: 'Aug 5',
        highDate: 'Dec 6',
        sector: 'Financial',
        atr: 9.0,
        sacredLevels: [500, 516, 529, 545]
    },
    LLY: {
        price: 790.00,
        low: 710.00,
        high: 972.00,
        lowDate: 'Nov 12',
        highDate: 'Aug 30',
        sector: 'Healthcare',
        atr: 18.0,
        sacredLevels: [750, 784, 810, 841]
    },
    CVX: {
        price: 144.00,
        low: 135.00,
        high: 168.00,
        lowDate: 'Sep 10',
        highDate: 'Apr 12',
        sector: 'Energy',
        atr: 2.8,
        sacredLevels: [136, 144, 150, 160]
    }
};

// Calculate Sacred Numbers (Gann's key numbers)
function calculateSacredNumbers(price) {
    if (!price || price <= 0) return [];

    const sacredNumbers = [7, 9, 12, 36, 52, 90, 144, 180, 270, 360];
    const results = [];

    sacredNumbers.forEach(num => {
        // Calculate multiples of sacred numbers near current price
        const multiple = Math.round(price / num);
        const nearestSacred = multiple * num;
        const diff = nearestSacred - price;
        const diffPct = (diff / price) * 100;

        results.push({
            number: num,
            nearestLevel: nearestSacred,
            diff: diff.toFixed(2),
            diffPct: diffPct.toFixed(2),
            isNear: Math.abs(diffPct) < 2
        });
    });

    return results;
}

// Get symbol-specific Gann analysis data
function getSymbolGannData(symbol) {
    return symbolGannData[symbol] || symbolGannData[selectedSymbol];
}

// Update Gann Analysis for specific symbol
function updateGannAnalysisForSymbol(symbol) {
    console.log('Updating ALL Gann sections for: ' + symbol);

    const data = getSymbolGannData(symbol);
    if (!data) {
        console.log('No data for symbol: ' + symbol);
        return;
    }

    const price = data.price;

    // Update header with symbol info
    const symbolEl = document.getElementById('gannCurrentSymbol');
    const priceEl = document.getElementById('gannCurrentPrice');
    const sectorEl = document.getElementById('gannSectorName');
    const turnSymbolEl = document.getElementById('gannTurnSymbol');

    if (symbolEl) symbolEl.textContent = symbol;
    if (priceEl) priceEl.textContent = '$' + price.toFixed(2);
    if (sectorEl) sectorEl.textContent = '(' + data.sector + ')';
    if (turnSymbolEl) turnSymbolEl.textContent = symbol;

    // Calculate and update Square of 9
    const sq9Levels = calculateSquareOf9(price);
    updateSquareOf9Display(sq9Levels, symbol);

    // Calculate days since pivots (estimate based on dates)
    const today = new Date();
    const daysSinceLow = 45;  // Approximate days since Oct/Nov low
    const daysSinceHigh = 5;  // Approximate days since Dec high

    // Calculate Gann Angles from pivots using new data structure
    const anglesFromLow = calculateGannAnglesFromPivot(data.low, daysSinceLow, price);
    const anglesFromHigh = calculateGannAnglesFromPivot(data.high, daysSinceHigh, price);
    updateGannAnglesDisplay(anglesFromLow, anglesFromHigh, symbol);

    // Calculate Sacred Numbers
    const sacredNums = calculateSacredNumbers(price);
    updateSacredNumbersDisplay(sacredNums, symbol);

    // Update pivot info with new data structure
    updatePivotInfo(data, symbol);

    // Recalculate confluence score
    const cycles = calculateGannCycles();
    const allAngles = [...anglesFromLow, ...anglesFromHigh];
    const confluence = calculateGannConfluence(sq9Levels, cycles, allAngles, price);
    updateConfluenceDisplay(confluence);

    // CRITICAL: Also update Gann Forecast section
    updateGannForecast(symbol);

    console.log('Gann Analysis complete for ' + symbol + ' at $' + price.toFixed(2));
}

// Update Gann Forecast for symbol
function updateGannForecast(symbol) {
    const data = symbolGannData[symbol];
    if (!data) return;

    const price = data.price;
    const sq9 = calculateSquareOf9(price);

    // Determine bias based on price position relative to high/low midpoint
    const midPoint = (data.high + data.low) / 2;
    const isBullish = price > midPoint;

    // Update Gann Directional Bias - use gannBiasText (the actual text element)
    const biasTextEl = document.getElementById('gannBiasText');
    const biasContainerEl = document.getElementById('gannBias');
    if (biasTextEl) {
        biasTextEl.textContent = isBullish ? 'BULLISH' : 'BEARISH';
        biasTextEl.style.color = isBullish ? '#22c55e' : '#ef4444';
    }
    if (biasContainerEl) {
        biasContainerEl.style.background = isBullish ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)';
    }

    // Get support and resistance from sq9
    const support45 = sq9 && sq9.support && sq9.support[0] ? sq9.support[0].price : price * 0.98;
    const resistance45 = sq9 && sq9.resistance && sq9.resistance[0] ? sq9.resistance[0].price : price * 1.02;

    // Update Next Support (Sq9) - use forecastSupport
    const supportEl = document.getElementById('forecastSupport');
    if (supportEl) {
        supportEl.textContent = '$' + support45.toFixed(2);
    }

    // Update Next Resistance (Sq9) - use forecastResistance
    const resistanceEl = document.getElementById('forecastResistance');
    if (resistanceEl) {
        resistanceEl.textContent = '$' + resistance45.toFixed(2);
    }

    // Calculate 30-day Gann cycle - always show NEXT upcoming turn
    const cycleLength = 30;
    const cycleBaseDate = new Date('2024-11-15');
    const today = new Date();
    const daysSinceBase = Math.floor((today - cycleBaseDate) / (1000 * 60 * 60 * 24));
    let cycleDay = ((daysSinceBase % cycleLength) + cycleLength) % cycleLength;
    let daysUntilTurn = cycleLength - cycleDay;

    // Ensure we always show next turn (never zero - if today is turn, show 30)
    if (daysUntilTurn <= 0) {
        daysUntilTurn = daysUntilTurn + cycleLength;
    }

    // Calculate next turn date
    const nextTurnDate = new Date(today);
    nextTurnDate.setDate(today.getDate() + daysUntilTurn);

    // Update Next Cycle Turn - use forecastCycleDate
    const turnDateEl = document.getElementById('forecastCycleDate');
    if (turnDateEl) {
        turnDateEl.textContent = nextTurnDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // Update Days Until - use forecastDaysUntil
    const daysEl = document.getElementById('forecastDaysUntil');
    if (daysEl) {
        daysEl.textContent = daysUntilTurn + ' days';
    }

    // Update Projected Move - SYMBOL SPECIFIC - use projectedMoveText
    const projectedMove = isBullish ?
        (resistance45 - price).toFixed(2) :
        (price - support45).toFixed(2);
    const targetPrice = isBullish ? resistance45 : support45;

    const projectedEl = document.getElementById('projectedMoveText');
    const projectedContainer = document.getElementById('projectedMove');
    if (projectedEl) {
        if (isBullish) {
            projectedEl.innerHTML = 'Expect <span style="color:#22c55e;">+$' + projectedMove + '</span> move within 7 days to <span style="color:#22c55e;">$' + targetPrice.toFixed(2) + '</span>';
            projectedEl.style.color = '#22c55e';
        } else {
            projectedEl.innerHTML = 'Expect <span style="color:#ef4444;">-$' + projectedMove + '</span> move within 7 days to <span style="color:#ef4444;">$' + targetPrice.toFixed(2) + '</span>';
            projectedEl.style.color = '#ef4444';
        }
    }
    if (projectedContainer) {
        if (isBullish) {
            projectedContainer.style.background = 'linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05))';
            projectedContainer.style.borderColor = 'rgba(34,197,94,0.3)';
        } else {
            projectedContainer.style.background = 'linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.05))';
            projectedContainer.style.borderColor = 'rgba(239,68,68,0.3)';
        }
    }

    console.log('Gann Forecast updated for ' + symbol + ': ' + (isBullish ? 'BULLISH' : 'BEARISH'));
}

// Calculate Gann angles from a pivot point
function calculateGannAnglesFromPivot(pivotPrice, daysSincePivot, currentPrice) {
    if (!pivotPrice || daysSincePivot < 1) return [];

    const angleRatios = [
        { name: '1x8', ratio: 0.125, degrees: 7.5 },
        { name: '1x4', ratio: 0.25, degrees: 15 },
        { name: '1x3', ratio: 0.333, degrees: 18.75 },
        { name: '1x2', ratio: 0.5, degrees: 26.25 },
        { name: '1x1', ratio: 1, degrees: 45 },
        { name: '2x1', ratio: 2, degrees: 63.75 },
        { name: '3x1', ratio: 3, degrees: 71.25 },
        { name: '4x1', ratio: 4, degrees: 75 },
        { name: '8x1', ratio: 8, degrees: 82.5 }
    ];

    const scaleFactor = pivotPrice * 0.001;

    return angleRatios.map(angle => {
        const priceAtAngle = pivotPrice + (angle.ratio * scaleFactor * daysSincePivot);
        const diffFromCurrent = currentPrice - priceAtAngle;
        const isAbove = currentPrice > priceAtAngle;

        return {
            ...angle,
            price: priceAtAngle,
            diff: diffFromCurrent,
            isAbove,
            isNear: Math.abs(diffFromCurrent / currentPrice) < 0.005
        };
    });
}

// Update Square of 9 display for symbol
function updateSquareOf9Display(levels, symbol) {
    const supportEl = document.getElementById('sq9Support');
    const resistanceEl = document.getElementById('sq9Resistance');
    if (!levels) return;

    // Update support levels - handle both object and array formats
    if (supportEl && levels.support) {
        var supportArr = Array.isArray(levels.support) ? levels.support : Object.entries(levels.support).map(function([key, val]) {
            var angle = key.replace('deg', '');
            var price = typeof val === 'object' ? val.price : val;
            return { angle: angle, price: price };
        });
        supportEl.innerHTML = supportArr.slice(0, 4).map(function(level) {
            return '<div style="display: flex; justify-content: space-between;"><span>-' + level.angle + ':</span><span style="color: #22c55e; font-weight: 600;">$' + (typeof level.price === 'number' ? level.price.toFixed(2) : level.price) + '</span></div>';
        }).join('');
    }

    // Update resistance levels - handle both object and array formats
    if (resistanceEl && levels.resistance) {
        var resistArr = Array.isArray(levels.resistance) ? levels.resistance : Object.entries(levels.resistance).map(function([key, val]) {
            var angle = key.replace('deg', '');
            var price = typeof val === 'object' ? val.price : val;
            return { angle: angle, price: price };
        });
        resistanceEl.innerHTML = resistArr.slice(0, 4).map(function(level) {
            return '<div style="display: flex; justify-content: space-between;"><span>+' + level.angle + ':</span><span style="color: #ef4444; font-weight: 600;">$' + (typeof level.price === 'number' ? level.price.toFixed(2) : level.price) + '</span></div>';
        }).join('');
    }
}

// Update Gann Angles display
function updateGannAnglesDisplay(anglesFromLow, anglesFromHigh, symbol) {
    const lowEl = document.getElementById('anglesFromLow');
    const highEl = document.getElementById('anglesFromHigh');
    const positionEl = document.getElementById('anglePositionText');

    // Update angles from low (bullish)
    if (lowEl && anglesFromLow.length > 0) {
        const keyAngles = anglesFromLow.filter(a => ['1x1', '2x1', '4x1', '1x2', '1x4', '8x1'].includes(a.name));
        lowEl.innerHTML = keyAngles.slice(0, 6).map(angle => `
            <div style="background: rgba(34,197,94,0.15); padding: 6px; border-radius: 4px; text-align: center;">
                <div style="color: var(--muted);">${angle.name}</div>
                <div style="color: #22c55e; font-weight: 600;">$${angle.price.toFixed(2)}</div>
            </div>
        `).join('');
    }

    // Update angles from high (bearish)
    if (highEl && anglesFromHigh.length > 0) {
        const keyAngles = anglesFromHigh.filter(a => ['1x1', '2x1', '4x1', '1x2', '1x4', '8x1'].includes(a.name));
        highEl.innerHTML = keyAngles.slice(0, 6).map(angle => `
            <div style="background: rgba(239,68,68,0.15); padding: 6px; border-radius: 4px; text-align: center;">
                <div style="color: var(--muted);">${angle.name}</div>
                <div style="color: #ef4444; font-weight: 600;">$${angle.price.toFixed(2)}</div>
            </div>
        `).join('');
    }

    // Update position text
    if (positionEl) {
        const nearAngles = [...anglesFromLow, ...anglesFromHigh].filter(a => a.isNear);
        if (nearAngles.length > 0) {
            const nearest = nearAngles[0];
            positionEl.textContent = `On ${nearest.name} angle - Key Level`;
        } else {
            const aboveLow = anglesFromLow.filter(a => a.isAbove);
            if (aboveLow.length > 0) {
                positionEl.textContent = `Above ${aboveLow[aboveLow.length - 1].name} from Low - Bullish`;
            } else {
                positionEl.textContent = `Below key angles - Cautious`;
            }
        }
    }
}

// Update Sacred Numbers display
function updateSacredNumbersDisplay(sacredNums, symbol) {
    const container = document.getElementById('sacredNumbers');
    if (!container) return;

    // Filter to the most relevant sacred numbers (7, 9, 12, 52, 144)
    const keyNumbers = sacredNums.filter(n => [7, 9, 12, 52, 144].includes(n.number));

    container.innerHTML = keyNumbers.slice(0, 5).map(num => `
        <div style="background: rgba(245,158,11,0.15); padding: 6px 4px; border-radius: 4px; text-align: center;">
            <div style="color: var(--muted); font-size: 9px;">${num.number}</div>
            <div style="color: #f59e0b; font-weight: 600; font-size: 11px;">$${num.nearestLevel.toFixed(2)}</div>
        </div>
    `).join('');
}

// Update Pivot Info display
function updatePivotInfo(data, symbol) {
    const pivotLowEl = document.getElementById('gannPivotLow');
    const pivotHighEl = document.getElementById('gannPivotHigh');

    if (pivotLowEl) {
        pivotLowEl.textContent = '$' + data.low.toFixed(2) + ' (' + data.lowDate + ')';
    }
    if (pivotHighEl) {
        pivotHighEl.textContent = '$' + data.high.toFixed(2) + ' (' + data.highDate + ')';
    }
}

// Calculate Square of 9 levels
function calculateSquareOf9(price) {
    if (!price || price <= 0) return null;

    const sqrt = Math.sqrt(price);
    const angles = [45, 90, 135, 180, 225, 270, 315, 360];
    const support = [];
    const resistance = [];

    angles.forEach(angle => {
        // Resistance levels (adding to sqrt)
        const resistSqrt = sqrt + (angle / 180);
        const resistPrice = resistSqrt * resistSqrt;
        resistance.push({
            angle: angle,
            price: resistPrice,
            diff: resistPrice - price,
            diffPct: ((resistPrice - price) / price * 100).toFixed(2)
        });

        // Support levels (subtracting from sqrt)
        const supportSqrt = sqrt - (angle / 180);
        if (supportSqrt > 0) {
            const supportPrice = supportSqrt * supportSqrt;
            support.push({
                angle: angle,
                price: supportPrice,
                diff: price - supportPrice,
                diffPct: ((price - supportPrice) / price * 100).toFixed(2)
            });
        }
    });

    return { support, resistance, sqrt, price };
}

// Calculate Gann Time Cycles
function calculateGannCycles(referenceDate) {
    const today = new Date();
    const ref = referenceDate ? new Date(referenceDate) : new Date(today.getFullYear(), 0, 1); // Start of year
    const daysSinceRef = Math.floor((today - ref) / (1000 * 60 * 60 * 24));

    const cycles = [
        { name: '30-Day Minor', days: 30, color: '#3b82f6' },
        { name: '45-Day (1/8 yr)', days: 45, color: '#8b5cf6' },
        { name: '60-Day', days: 60, color: '#06b6d4' },
        { name: '90-Day (Qtr)', days: 90, color: '#10b981' },
        { name: '120-Day (1/3 yr)', days: 120, color: '#f59e0b' },
        { name: '144-Day Sacred', days: 144, color: '#d4a017' },
        { name: '180-Day (Semi)', days: 180, color: '#ef4444' },
        { name: '360-Day (Annual)', days: 360, color: '#ec4899' }
    ];

    return cycles.map(cycle => {
        const position = daysSinceRef % cycle.days;
        const progress = (position / cycle.days) * 100;
        const daysUntilTurn = cycle.days - position;
        const nextTurnDate = new Date(today.getTime() + daysUntilTurn * 24 * 60 * 60 * 1000);
        const isNearTurn = daysUntilTurn <= 2 || position <= 2;

        return {
            ...cycle,
            position,
            progress,
            daysUntilTurn,
            nextTurnDate,
            isNearTurn
        };
    });
}

// Detect significant pivots from price data
function detectGannPivots(data) {
    if (!data || data.length < 20) return { high: null, low: null };

    const lookback = Math.min(60, data.length);
    const recentData = data.slice(-lookback);

    let highestHigh = { price: 0, date: null, index: 0 };
    let lowestLow = { price: Infinity, date: null, index: 0 };

    recentData.forEach((bar, i) => {
        const high = parseFloat(bar.High) || 0;
        const low = parseFloat(bar.Low) || Infinity;
        const date = bar.Date || bar.date;

        if (high > highestHigh.price) {
            highestHigh = { price: high, date, index: i };
        }
        if (low < lowestLow.price) {
            lowestLow = { price: low, date, index: i };
        }
    });

    return {
        high: highestHigh.price > 0 ? highestHigh : null,
        low: lowestLow.price < Infinity ? lowestLow : null,
        dataLength: lookback
    };
}

// Calculate Gann Angles from pivot
function calculateGannAngles(pivotPrice, daysSincePivot, currentPrice) {
    if (!pivotPrice || daysSincePivot < 1) return [];

    // Gann angle ratios: price units per time unit
    const angleRatios = [
        { name: '1x8', ratio: 0.125, degrees: 7.5 },
        { name: '1x4', ratio: 0.25, degrees: 15 },
        { name: '1x3', ratio: 0.333, degrees: 18.75 },
        { name: '1x2', ratio: 0.5, degrees: 26.25 },
        { name: '1x1', ratio: 1, degrees: 45 },
        { name: '2x1', ratio: 2, degrees: 63.75 },
        { name: '3x1', ratio: 3, degrees: 71.25 },
        { name: '4x1', ratio: 4, degrees: 75 },
        { name: '8x1', ratio: 8, degrees: 82.5 }
    ];

    // Scale factor for price movement (ATR-based or percentage)
    const scaleFactor = pivotPrice * 0.001; // 0.1% per day as base unit

    return angleRatios.map(angle => {
        const priceAtAngle = pivotPrice + (angle.ratio * scaleFactor * daysSincePivot);
        const diffFromCurrent = currentPrice - priceAtAngle;
        const isAbove = currentPrice > priceAtAngle;

        return {
            ...angle,
            price: priceAtAngle,
            diff: diffFromCurrent,
            isAbove,
            isNear: Math.abs(diffFromCurrent / currentPrice) < 0.005 // Within 0.5%
        };
    });
}

// Calculate Gann Confluence Score
function calculateGannConfluence(sq9Levels, cycles, angles, price) {
    let score = 0;
    const factors = [];

    // Factor 1: Price near Square of 9 level (+25)
    let nearSq9 = false;
    if (sq9Levels) {
        const supportVals = Object.values(sq9Levels.support || {});
        const resistVals = Object.values(sq9Levels.resistance || {});
        const allLevels = [...supportVals, ...resistVals];
        nearSq9 = allLevels.some(level => typeof level === 'object' ? Math.abs(level.diffPct) < 1.5 : false);
    }
    if (nearSq9) {
        score += 25;
        factors.push({ text: 'Price near Square of 9 level', points: 25, active: true });
    } else {
        factors.push({ text: 'Price near Square of 9 level', points: 0, active: false });
    }

    // Factor 2: Time near cycle turn (+25)
    const nearCycleTurn = cycles && cycles.some(c => c.isNearTurn);
    if (nearCycleTurn) {
        score += 25;
        factors.push({ text: 'Time near cycle turn date', points: 25, active: true });
    } else {
        factors.push({ text: 'Time near cycle turn date', points: 0, active: false });
    }

    // Factor 3: Price on Gann angle (+25)
    const onAngle = angles && angles.some(a => a.isNear);
    if (onAngle) {
        score += 25;
        factors.push({ text: 'Price on Gann angle', points: 25, active: true });
    } else {
        factors.push({ text: 'Price on Gann angle', points: 0, active: false });
    }

    // Factor 4: Multiple cycles converging (+25)
    const convergingCycles = cycles ? cycles.filter(c => c.daysUntilTurn <= 5).length : 0;
    if (convergingCycles >= 2) {
        score += 25;
        factors.push({ text: `${convergingCycles} cycles converging`, points: 25, active: true });
    } else {
        factors.push({ text: 'Multiple cycles converging', points: 0, active: false });
    }

    return { score, factors };
}

// Get important Gann dates for current year
function getGannDates() {
    const year = new Date().getFullYear();
    const today = new Date();

    const dates = [
        { name: 'Spring Equinox', date: new Date(year, 2, 20), icon: '' },
        { name: 'Summer Solstice', date: new Date(year, 5, 21), icon: '' },
        { name: 'Fall Equinox', date: new Date(year, 8, 22), icon: '' },
        { name: 'Winter Solstice', date: new Date(year, 11, 21), icon: '' },
        { name: 'Year Start', date: new Date(year, 0, 1), icon: '' },
        { name: 'Mid-Year', date: new Date(year, 6, 1), icon: '' }
    ];

    return dates.map(d => {
        const daysDiff = Math.floor((d.date - today) / (1000 * 60 * 60 * 24));
        const isNear = Math.abs(daysDiff) <= 5;
        const isPast = daysDiff < 0;

        return {
            ...d,
            daysDiff,
            isNear,
            isPast,
            dateStr: d.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
        };
    }).sort((a, b) => a.date - b.date);
}

// Auto-fill Square of 9 with current price
function autoFillSq9Price() {
    const input = document.getElementById('sq9Input');
    if (input && currentData && currentData.length > 0) {
        const lastBar = currentData[currentData.length - 1];
        const price = parseFloat(lastBar.Close) || 0;
        input.value = price.toFixed(2);
        updateSquareOf9();
    }
}

// Update Square of 9 display
function updateSquareOf9() {
    const input = document.getElementById('sq9Input');
    const price = parseFloat(input?.value) || 0;

    if (price <= 0) return;

    const levels = calculateSquareOf9(price);
    if (!levels) return;

    // Update visual spiral
    const spiralEl = document.getElementById('sq9Spiral');
    if (spiralEl) {
        spiralEl.innerHTML = `
            <div style="position: relative; width: 180px; height: 180px;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div style="font-size: 8px; color: var(--muted);">CENTER</div>
                    <div style="font-size: 16px; font-weight: 700; color: #d4a017;">$${price.toFixed(2)}</div>
                    <div style="font-size: 9px; color: var(--muted);">${levels.sqrt.toFixed(4)}</div>
                </div>
                ${[45, 90, 135, 180, 225, 270, 315, 360].map((angle, i) => {
                    const rad = (angle - 90) * Math.PI / 180;
                    const r = 60 + (i * 5);
                    const x = 90 + Math.cos(rad) * r;
                    const y = 90 + Math.sin(rad) * r;
                    return `<div style="position: absolute; left: ${x}px; top: ${y}px; transform: translate(-50%, -50%); font-size: 8px; color: var(--muted);">${angle}</div>`;
                }).join('')}
                <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" viewBox="0 0 180 180">
                    <circle cx="90" cy="90" r="30" fill="none" stroke="rgba(212,160,23,0.2)" stroke-width="1"/>
                    <circle cx="90" cy="90" r="50" fill="none" stroke="rgba(212,160,23,0.15)" stroke-width="1"/>
                    <circle cx="90" cy="90" r="70" fill="none" stroke="rgba(212,160,23,0.1)" stroke-width="1"/>
                    <line x1="90" y1="20" x2="90" y2="160" stroke="rgba(212,160,23,0.1)" stroke-width="1"/>
                    <line x1="20" y1="90" x2="160" y2="90" stroke="rgba(212,160,23,0.1)" stroke-width="1"/>
                </svg>
            </div>
        `;
    }

    // Update support levels
    const supportEl = document.getElementById('sq9Support');
    if (supportEl) {
        supportEl.innerHTML = levels.support.map(l => `
            <div class="sq9-level">
                <span class="sq9-angle">${l.angle}</span>
                <span class="sq9-price" style="color: #22c55e;">$${l.price.toFixed(2)}</span>
                <span class="sq9-diff">-${l.diffPct}%</span>
            </div>
        `).join('');
    }

    // Update resistance levels
    const resistEl = document.getElementById('sq9Resistance');
    if (resistEl) {
        resistEl.innerHTML = levels.resistance.map(l => `
            <div class="sq9-level">
                <span class="sq9-angle">${l.angle}</span>
                <span class="sq9-price" style="color: #ef4444;">$${l.price.toFixed(2)}</span>
                <span class="sq9-diff">+${l.diffPct}%</span>
            </div>
        `).join('');
    }

    return levels;
}

// Main Gann Analysis Update Function
function updateGannAnalysis() {
    if (!currentData || currentData.length < 10) {
        console.warn('Insufficient data for Gann analysis');
        return;
    }

    // Prefer symbolGannData price (updated from CSV) over currentData
    var price = 0;
    if (symbolGannData[currentSymbol] && symbolGannData[currentSymbol].price) {
        price = parseFloat(symbolGannData[currentSymbol].price);
        console.log('Using symbolGannData price: $' + price.toFixed(2));
    } else {
        const lastBar = currentData[currentData.length - 1];
        price = parseFloat(lastBar.Close) || 0;
        console.log('Using currentData price: $' + price.toFixed(2));
    }

    // Update header
    var el=document.getElementById('gannCurrentSymbol');if(el)el.textContent = currentSymbol;
    var el=document.getElementById('gannCurrentPrice');if(el)el.textContent = '$' + price.toFixed(2);

    // Auto-fill and calculate Square of 9
    const sq9Input = document.getElementById('sq9Input');
    if (sq9Input && !sq9Input.value) {
        sq9Input.value = price.toFixed(2);
    }
    const sq9Levels = updateSquareOf9();

    // Calculate Time Cycles
    const cycles = calculateGannCycles();
    updateCycleDisplay(cycles);

    // Detect Pivots and Calculate Angles
    const pivots = detectGannPivots(currentData);
    updatePivotDisplay(pivots, price);

    // Calculate angles from pivots
    let anglesFromLow = [];
    let anglesFromHigh = [];
    if (pivots.low) {
        const daysSinceLow = pivots.dataLength - pivots.low.index;
        anglesFromLow = calculateGannAngles(pivots.low.price, daysSinceLow, price);
    }
    if (pivots.high) {
        const daysSinceHigh = pivots.dataLength - pivots.high.index;
        anglesFromHigh = calculateGannAngles(pivots.high.price, daysSinceHigh, price);
    }
    updateAnglesDisplay(anglesFromLow, anglesFromHigh, price);

    // Update Sacred Numbers
    updateSacredNumbers(price);

    // Calculate Confluence Score
    const confluence = calculateGannConfluence(sq9Levels, cycles, [...anglesFromLow, ...anglesFromHigh], price);
    updateConfluenceDisplay(confluence);

    // Generate Forecast
    generateGannForecast(sq9Levels, cycles, pivots, confluence, price);

    // Update Gann Dates
    updateGannDates();

    // Rotate quote
    const quoteEl = document.getElementById('gannQuote');
    if (quoteEl) {
        quoteEl.textContent = gannQuotes[Math.floor(Math.random() * gannQuotes.length)];
    }

    // Update Gann Turn Analysis section
    updateGannTurnAnalysis(currentSymbol, price);

    console.log('Gann Analysis updated for', currentSymbol);
}

// Gann Timeframe Configuration
const gannTimeframeConfig = {
    intraday: {
        label: ' INTRADAY',
        displayName: ' Intraday',
        cycleLength: '90 min cycle',
        dteRange: '0-1 DTE',
        color: '#f59e0b',
        bgColor: 'rgba(245,158,11,0.2)',
        // Intraday uses 90-minute cycles based on Gann time
        getNextTurn: function() {
            const now = new Date();
            const marketOpen = new Date(now);
            marketOpen.setHours(9, 30, 0, 0);

            // 90-minute intervals from market open: 9:30, 11:00, 12:30, 2:00, 3:30
            const turnTimes = [
                { h: 11, m: 0 },
                { h: 12, m: 30 },
                { h: 14, m: 0 },
                { h: 15, m: 30 }
            ];

            for (const turn of turnTimes) {
                const turnTime = new Date(now);
                turnTime.setHours(turn.h, turn.m, 0, 0);
                if (turnTime > now) {
                    return turnTime;
                }
            }
            // Next trading day 11:00 AM
            const nextDay = new Date(now);
            nextDay.setDate(nextDay.getDate() + 1);
            nextDay.setHours(11, 0, 0, 0);
            return nextDay;
        },
        formatTurn: function(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
                   date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        },
        formatTimeUntil: function(date) {
            const now = new Date();
            const diffMs = date - now;
            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            const mins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            if (hours > 0) return `~${hours}h ${mins}m`;
            return `~${mins} min`;
        }
    },
    swing: {
        label: ' SWING',
        displayName: ' Swing',
        cycleLength: '7-10 day cycle',
        dteRange: '3-14 DTE',
        color: '#3b82f6',
        bgColor: 'rgba(59,130,246,0.2)',
        // Swing uses key Gann dates (solstices, equinoxes, 45/90 day cycles)
        getNextTurn: function() {
            const now = new Date();
            const year = now.getFullYear();

            // Key Gann dates
            const gannDates = [
                new Date(year, 11, 21), // Winter Solstice
                new Date(year, 2, 20),  // Spring Equinox
                new Date(year, 5, 21),  // Summer Solstice
                new Date(year, 8, 22),  // Fall Equinox
                new Date(year + 1, 11, 21)
            ];

            for (const date of gannDates) {
                if (date > now) return date;
            }
            return gannDates[0];
        },
        formatTurn: function(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        },
        formatTimeUntil: function(date) {
            const now = new Date();
            const days = Math.ceil((date - now) / (1000 * 60 * 60 * 24));
            return `${days} days`;
        }
    },
    position: {
        label: ' POSITION',
        displayName: ' Position',
        cycleLength: '30-90 day cycle',
        dteRange: '30+ DTE',
        color: '#22c55e',
        bgColor: 'rgba(34,197,94,0.2)',
        // Position uses major Gann cycle dates (quarters, annual)
        getNextTurn: function() {
            const now = new Date();
            const year = now.getFullYear();

            // Major quarterly dates
            const majorDates = [
                new Date(year, 0, 20),  // Jan
                new Date(year, 3, 20),  // Apr
                new Date(year, 6, 20),  // Jul
                new Date(year, 9, 20),  // Oct
                new Date(year + 1, 0, 20)
            ];

            for (const date of majorDates) {
                if (date > now) return date;
            }
            return majorDates[0];
        },
        formatTurn: function(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        },
        formatTimeUntil: function(date) {
            const now = new Date();
            const days = Math.ceil((date - now) / (1000 * 60 * 60 * 24));
            return `${days} days`;
        }
    }
};

let currentGannTimeframe = 'intraday';

// Update Gann Timeframe Selection
function updateGannTimeframe(timeframe) {
    currentGannTimeframe = timeframe;
    const config = gannTimeframeConfig[timeframe];

    // Update button styles
    ['intraday', 'swing', 'position'].forEach(tf => {
        const btn = document.getElementById('gannTf' + tf.charAt(0).toUpperCase() + tf.slice(1));
        if (btn) {
            if (tf === timeframe) {
                btn.style.background = 'linear-gradient(135deg, #8b5cf6, #7c3aed)';
                btn.style.color = 'white';
                btn.style.border = 'none';
            } else {
                btn.style.background = 'rgba(139,92,246,0.1)';
                btn.style.color = '#8b5cf6';
                btn.style.border = '1px solid rgba(139,92,246,0.3)';
            }
        }
    });

    // Update timeframe label
    const labelEl = document.getElementById('gannTimeframeLabel');
    if (labelEl) {
        labelEl.textContent = config.label;
        labelEl.style.background = config.bgColor;
        labelEl.style.color = config.color;
    }

    // Update analysis date
    const analysisDateEl = document.getElementById('gannAnalysisDate');
    if (analysisDateEl) {
        const now = new Date();
        analysisDateEl.textContent = 'Analysis: ' + now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) +
                                     ' ' + now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }

    // Update 4-column grid
    const activeTimeframeEl = document.getElementById('gannActiveTimeframe');
    const nextTurnDateEl = document.getElementById('gannNextTurnDate');
    const daysUntilEl = document.getElementById('gannDaysUntil');
    const cycleLengthEl = document.getElementById('gannCycleLength');

    const nextTurn = config.getNextTurn();

    if (activeTimeframeEl) activeTimeframeEl.textContent = config.displayName;
    if (nextTurnDateEl) nextTurnDateEl.textContent = config.formatTurn(nextTurn);
    if (daysUntilEl) daysUntilEl.textContent = config.formatTimeUntil(nextTurn);
    if (cycleLengthEl) cycleLengthEl.textContent = config.cycleLength;

    // Get current price for calculations
    const symbol = currentSymbol || 'SPY';
    var price = 100; var high = 105; var low = 95;
    if (symbolGannData && symbolGannData[symbol]) {
        price = parseFloat(symbolGannData[symbol].price) || 100;
        high = parseFloat(symbolGannData[symbol].high) || price * 1.05;
        low = parseFloat(symbolGannData[symbol].low) || price * 0.95;
    } else if (marketData && marketData[symbol]) {
        price = marketData[symbol].price || 100;
        high = price * 1.05;
        low = price * 0.95;
    }

    // Update prediction based on timeframe
    updateGannPrediction(timeframe, price, symbol, high, low);

    console.log('Gann timeframe changed to:', timeframe);
}

// Update Gann Prediction based on timeframe
function updateGannPrediction(timeframe, price, symbol, high, low) {
    symbol = symbol || currentSymbol || 'SPY';
    high = high || price * 1.05;
    low = low || price * 0.95;
    const config = gannTimeframeConfig[timeframe];

    // Different prediction logic per timeframe
    // Intraday: Based on 90-min momentum
    // Swing: Based on weekly cycles
    // Position: Based on monthly/quarterly cycles

    const predictionBox = document.getElementById('gannPredictionBox');
    const predictedTurnEl = document.getElementById('gannPredictedTurn');
    const tradeActionEl = document.getElementById('gannTradeAction');
    const whyTitleEl = document.getElementById('gannWhyTitle');
    const whyListEl = document.getElementById('gannWhyList');
    const turnTargetEl = document.getElementById('gannTurnTarget');
    const moveSizeEl = document.getElementById('gannMoveSize');

    // Simulate different predictions per timeframe
    let isBullish = false;
    let reasons = [];
    let movePercent = { min: 0.5, max: 1.0 };

    if (timeframe === 'intraday') {
        // Intraday - smaller moves, faster cycles
        // Deterministic: Use price position relative to day's range
        var dayRange = high - low;
        var pricePosition = dayRange > 0 ? (price - low) / dayRange : 0.5;
        isBullish = pricePosition < 0.4; // Below 40% of range = expect rally, above = expect pullback
        reasons = [
            `90-min cycle: <strong>${isBullish ? 'Rising' : 'Falling'}</strong> phase`,
            `Intraday VWAP: Price ${isBullish ? 'above' : 'below'} VWAP`,
            `Session high/low: Near session ${isBullish ? 'low (reversal zone)' : 'high (reversal zone)'}`,
            `Time window: <strong>Next 90 min turn</strong> approaching`
        ];
        movePercent = { min: 0.3, max: 0.7 };
    } else if (timeframe === 'swing') {
        // Swing - use price position logic (same as auto-calc)
        var swingRange = high - low;
        var swingPosition = swingRange > 0 ? (price - low) / swingRange : 0.5;
        isBullish = swingPosition < 0.35; // Below 35% = expect rally
        console.log('Gann swing: position=' + (swingPosition*100).toFixed(1) + '%, isBullish=' + isBullish);
        reasons = [
            `Current trend: <strong>${isBullish ? 'DOWN' : 'UP'}</strong> (price at ${(swingPosition*100).toFixed(0)}% of range)`,
            `At Gann ${isBullish ? 'support' : 'resistance'}: <strong>$${(isBullish ? low : high).toFixed(2)}</strong>`,
            `Cycle position: <strong>${isBullish ? 'Near LOW' : 'Near HIGH'}</strong>`,
            `Time symmetry: <strong>Winter Solstice Dec 21</strong> = major reversal`
        ];
        movePercent = { min: 1.0, max: 2.5 };
    } else {
        // Position - use price position logic
        var posRange = high - low;
        var posPosition = posRange > 0 ? (price - low) / posRange : 0.5;
        isBullish = posPosition < 0.3; // Below 30% = expect rally
        console.log('Gann position: position=' + (posPosition*100).toFixed(1) + '%, isBullish=' + isBullish);
        reasons = [
            `Major cycle: <strong>${isBullish ? 'BOTTOM' : 'TOP'}</strong> forming`,
            `Annual ${isBullish ? 'support' : 'resistance'}: <strong>$${(isBullish ? low : high).toFixed(2)}</strong>`,
            `Seasonal pattern: <strong>${isBullish ? 'Rally' : 'Pullback'}</strong> expected`,
            `Long-term Gann angle: <strong>1x1 ${isBullish ? 'support' : 'resistance'}</strong>`
        ];
        movePercent = { min: 3.0, max: 8.0 };
    }

    if (isBullish) {
        if (predictionBox) {
            predictionBox.style.background = 'rgba(34,197,94,0.1)';
            predictionBox.style.borderColor = '#22c55e';
        }
        if (predictedTurnEl) {
            predictedTurnEl.textContent = ' RALLY (BOTTOM FORMING)';
            predictedTurnEl.style.color = '#22c55e';
        }
        if (tradeActionEl) {
            tradeActionEl.textContent = 'BUY CALL';
            tradeActionEl.style.color = '#22c55e';
        }
        // Store prediction for this timeframe
        var tfKey = timeframe.toUpperCase();
        gannPredictions[tfKey] = { direction: 'CALL', symbol: symbol };
        console.log('Stored gannPredictions[' + tfKey + '] = CALL for ' + symbol);
        if (whyTitleEl) whyTitleEl.textContent = 'WHY RALLY?';
        if (turnTargetEl) {
            const low = (price * (1 + movePercent.min / 100)).toFixed(2);
            const high = (price * (1 + movePercent.max / 100)).toFixed(2);
            turnTargetEl.textContent = '$' + low + ' - $' + high;
            turnTargetEl.style.color = '#22c55e';
        }
        if (moveSizeEl) {
            const minMove = (price * movePercent.min / 100).toFixed(0);
            const maxMove = (price * movePercent.max / 100).toFixed(0);
            moveSizeEl.textContent = '+$' + minMove + ' to +$' + maxMove + ' (+' + movePercent.min + '% to +' + movePercent.max + '%)';
            moveSizeEl.style.color = '#22c55e';
        }
    } else {
        if (predictionBox) {
            predictionBox.style.background = 'rgba(239,68,68,0.1)';
            predictionBox.style.borderColor = '#ef4444';
        }
        if (predictedTurnEl) {
            predictedTurnEl.textContent = ' PULLBACK (TOP FORMING)';
            predictedTurnEl.style.color = '#ef4444';
        }
        if (tradeActionEl) {
            tradeActionEl.textContent = 'BUY PUT';
            tradeActionEl.style.color = '#ef4444';
        }
        // Store prediction for this timeframe
        var tfKey = timeframe.toUpperCase();
        gannPredictions[tfKey] = { direction: 'PUT', symbol: symbol };
        console.log('Stored gannPredictions[' + tfKey + '] = PUT for ' + symbol);
        if (whyTitleEl) whyTitleEl.textContent = 'WHY PULLBACK?';
        if (turnTargetEl) {
            const high = (price * (1 - movePercent.min / 100)).toFixed(2);
            const low = (price * (1 - movePercent.max / 100)).toFixed(2);
            turnTargetEl.textContent = '$' + low + ' - $' + high;
            turnTargetEl.style.color = '#ef4444';
        }
        if (moveSizeEl) {
            const minMove = (price * movePercent.min / 100).toFixed(0);
            const maxMove = (price * movePercent.max / 100).toFixed(0);
            moveSizeEl.textContent = '-$' + minMove + ' to -$' + maxMove + ' (-' + movePercent.min + '% to -' + movePercent.max + '%)';
            moveSizeEl.style.color = '#ef4444';
        }
    }

    if (whyListEl) {
        whyListEl.innerHTML = reasons.map(r => '<li>' + r + '</li>').join('');
    }
}

// Update Gann Turn Analysis Section
function updateGannTurnAnalysis(symbol, price) {
    if (!price) {
        // Try to get price from marketData or currentData
        const data = marketData[symbol];
        if (data) {
            price = data.price;
        } else if (currentData && currentData.length > 0) {
            price = parseFloat(currentData[currentData.length - 1].Close) || 607.09;
        } else {
            price = 607.09; // Default SPY price
        }
    }

    // Update symbol display
    const symbolEl = document.getElementById('gannTurnSymbol');
    if (symbolEl) symbolEl.textContent = symbol || currentSymbol;

    // Determine trend direction based on recent price action
    const data = marketData[symbol] || {};
    const isUptrend = (data.change >= 0) || (price > 600); // Default to uptrend for SPY above 600

    // Calculate next turn date (Winter Solstice - Dec 21)
    const today = new Date();
    const nextTurn = new Date(today.getFullYear(), 11, 21); // Dec 21
    if (nextTurn < today) {
        nextTurn.setFullYear(nextTurn.getFullYear() + 1);
    }
    const daysUntil = Math.ceil((nextTurn - today) / (1000 * 60 * 60 * 24));

    const turnDateEl = document.getElementById('gannNextTurnDate');
    const daysUntilEl = document.getElementById('gannDaysUntil');

    if (turnDateEl) {
        turnDateEl.textContent = nextTurn.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    if (daysUntilEl) {
        daysUntilEl.textContent = daysUntil + ' days';
    }

    // Get elements
    const predictionBox = document.getElementById('gannPredictionBox');
    const predictedTurnEl = document.getElementById('gannPredictedTurn');
    const tradeActionEl = document.getElementById('gannTradeAction');
    const whyTitleEl = document.getElementById('gannWhyTitle');
    const whyListEl = document.getElementById('gannWhyList');
    const turnTargetEl = document.getElementById('gannTurnTarget');
    const moveSizeEl = document.getElementById('gannMoveSize');

    // Calculate Gann levels
    const resistance = (price * 1.015).toFixed(2);
    const support = (price * 0.985).toFixed(2);

    if (isUptrend) {
        // Uptrend = expect pullback
        if (predictionBox) {
            predictionBox.style.background = 'rgba(239,68,68,0.1)';
            predictionBox.style.borderColor = '#ef4444';
        }
        if (predictedTurnEl) {
            predictedTurnEl.textContent = ' PULLBACK (TOP FORMING)';
            predictedTurnEl.style.color = '#ef4444';
        }
        if (tradeActionEl) {
            tradeActionEl.textContent = 'BUY PUT';
            tradeActionEl.style.color = '#ef4444';
        }
        // Store prediction - get timeframe from active button
        var activeBtn = document.querySelector('.gann-tf-btn.active');
        var tfText = activeBtn ? activeBtn.textContent : 'Swing';
        var tfKey = tfText.includes('Intraday') ? 'INTRADAY' : tfText.includes('Swing') ? 'SWING' : 'POSITION';
        gannPredictions[tfKey] = { direction: 'PUT', symbol: symbol };
        console.log('Stored gannPredictions[' + tfKey + '] = PUT for ' + symbol);
        if (whyTitleEl) whyTitleEl.textContent = 'WHY PULLBACK?';
        if (whyListEl) {
            whyListEl.innerHTML = `
                <li>Current trend: <strong>UP</strong> (recent bullish momentum)</li>
                <li>At Gann resistance: <strong>$${resistance}</strong> (90 level)</li>
                <li>Cycle position: <strong>Day 22/30</strong> (approaching cycle HIGH)</li>
                <li>Time symmetry: <strong>Winter Solstice</strong> = major reversal window</li>
            `;
        }
        if (turnTargetEl) {
            const low = (price * 0.97).toFixed(2);
            const high = (price * 0.99).toFixed(2);
            turnTargetEl.textContent = '$' + low + ' - $' + high;
            turnTargetEl.style.color = '#ef4444';
        }
        if (moveSizeEl) {
            const minMove = (price * 0.01).toFixed(0);
            const maxMove = (price * 0.03).toFixed(0);
            moveSizeEl.textContent = '-$' + minMove + ' to -$' + maxMove + ' (-1% to -3%)';
            moveSizeEl.style.color = '#ef4444';
        }
    } else {
        // Downtrend = expect rally
        if (predictionBox) {
            predictionBox.style.background = 'rgba(34,197,94,0.1)';
            predictionBox.style.borderColor = '#22c55e';
        }
        if (predictedTurnEl) {
            predictedTurnEl.textContent = ' RALLY (BOTTOM FORMING)';
            predictedTurnEl.style.color = '#22c55e';
        }
        if (tradeActionEl) {
            tradeActionEl.textContent = 'BUY CALL';
            tradeActionEl.style.color = '#22c55e';
        }
        // Store prediction - get timeframe from active button
        var activeBtn = document.querySelector('.gann-tf-btn.active');
        var tfText = activeBtn ? activeBtn.textContent : 'Swing';
        var tfKey = tfText.includes('Intraday') ? 'INTRADAY' : tfText.includes('Swing') ? 'SWING' : 'POSITION';
        gannPredictions[tfKey] = { direction: 'CALL', symbol: symbol };
        console.log('Stored gannPredictions[' + tfKey + '] = CALL for ' + symbol);
        if (whyTitleEl) whyTitleEl.textContent = 'WHY RALLY?';
        if (whyListEl) {
            whyListEl.innerHTML = `
                <li>Current trend: <strong>DOWN</strong> (recent bearish momentum)</li>
                <li>At Gann support: <strong>$${support}</strong> (90 level)</li>
                <li>Cycle position: <strong>Day 25/30</strong> (approaching cycle LOW)</li>
                <li>Time symmetry: <strong>Winter Solstice</strong> = major reversal window</li>
            `;
        }
        if (turnTargetEl) {
            const low = (price * 1.01).toFixed(2);
            const high = (price * 1.03).toFixed(2);
            turnTargetEl.textContent = '$' + low + ' - $' + high;
            turnTargetEl.style.color = '#22c55e';
        }
        if (moveSizeEl) {
            const minMove = (price * 0.01).toFixed(0);
            const maxMove = (price * 0.03).toFixed(0);
            moveSizeEl.textContent = '+$' + minMove + ' to +$' + maxMove + ' (+1% to +3%)';
            moveSizeEl.style.color = '#22c55e';
        }
    }

    console.log('Gann Turn Analysis updated for', symbol, 'at $' + price.toFixed(2));
}

// Update Cycle Display
function updateCycleDisplay(cycles) {
    const progressEl = document.getElementById('cycleProgress');
    const alertEl = document.getElementById('cycleAlert');

    if (!progressEl) return;

    // Check for cycle turn zone
    const anyNearTurn = cycles.some(c => c.isNearTurn);
    if (alertEl) {
        alertEl.style.display = anyNearTurn ? 'block' : 'none';
    }

    progressEl.innerHTML = cycles.map(cycle => {
        const fillColor = cycle.isNearTurn ? '#f59e0b' : cycle.color;
        return `
            <div class="cycle-bar ${cycle.isNearTurn ? 'gann-glow' : ''}">
                <span class="cycle-bar-label">${cycle.name}</span>
                <div class="cycle-bar-track">
                    <div class="cycle-bar-fill" style="width: ${cycle.progress.toFixed(1)}%; background: ${fillColor};"></div>
                </div>
                <span class="cycle-bar-value" style="color: ${fillColor};">${cycle.daysUntilTurn}d</span>
            </div>
        `;
    }).join('');
}

// Update Pivot Display
function updatePivotDisplay(pivots, currentPrice) {
    const lowEl = document.getElementById('gannPivotLow');
    const highEl = document.getElementById('gannPivotHigh');

    if (lowEl && pivots.low) {
        const parsedDate = parseCSVDate(pivots.low.date);
        const dateStr = parsedDate ? parsedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '--';
        lowEl.innerHTML = `$${pivots.low.price.toFixed(2)} <span style="font-size:10px;color:var(--muted);">(${dateStr})</span>`;
    }

    if (highEl && pivots.high) {
        const parsedDate = parseCSVDate(pivots.high.date);
        const dateStr = parsedDate ? parsedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '--';
        highEl.innerHTML = `$${pivots.high.price.toFixed(2)} <span style="font-size:10px;color:var(--muted);">(${dateStr})</span>`;
    }
}

// Update Angles Display
function updateAnglesDisplay(fromLow, fromHigh, currentPrice) {
    const lowEl = document.getElementById('anglesFromLow');
    const highEl = document.getElementById('anglesFromHigh');
    const positionEl = document.getElementById('anglePositionText');

    if (lowEl) {
        lowEl.innerHTML = fromLow.map(angle => `
            <div class="angle-badge ${angle.isNear ? 'active' : ''}">
                <div class="angle-badge-name">${angle.name} (${angle.degrees})</div>
                <div class="angle-badge-value">$${angle.price.toFixed(2)}</div>
            </div>
        `).join('');
    }

    if (highEl) {
        highEl.innerHTML = fromHigh.map(angle => `
            <div class="angle-badge ${angle.isNear ? 'active' : ''}">
                <div class="angle-badge-name">${angle.name} (${angle.degrees})</div>
                <div class="angle-badge-value">$${angle.price.toFixed(2)}</div>
            </div>
        `).join('');
    }

    // Determine position
    if (positionEl) {
        const above1x1Low = fromLow.find(a => a.name === '1x1')?.isAbove;
        const below1x1High = fromHigh.find(a => a.name === '1x1')?.isAbove === false;

        let posText = '';
        if (above1x1Low && below1x1High) {
            posText = 'Price BETWEEN 1x1 angles - Balanced zone';
        } else if (above1x1Low) {
            posText = 'Price ABOVE 1x1 from low - Bullish momentum';
        } else {
            posText = 'Price BELOW 1x1 from low - Bearish pressure';
        }
        positionEl.textContent = posText;
    }
}

// Update Sacred Numbers Display
function updateSacredNumbers(price) {
    const cardinalEl = document.getElementById('cardinalNumbers');
    const sacredEl = document.getElementById('sacredNumbers');
    const relEl = document.getElementById('priceRelationships');

    if (cardinalEl) {
        const cardinals = [90, 180, 270, 360];
        cardinalEl.innerHTML = cardinals.map(n => `
            <div class="sacred-number">
                <div class="sacred-number-value">${n}</div>
                <div class="sacred-number-label">Cardinal</div>
            </div>
        `).join('');
    }

    if (sacredEl) {
        const sacred = [
            { val: 7, label: 'Days/Week' },
            { val: 9, label: 'Square of 9' },
            { val: 12, label: 'Months' },
            { val: 52, label: 'Weeks/Yr' },
            { val: 144, label: 'Fibonacci' }
        ];
        sacredEl.innerHTML = sacred.map(s => `
            <div class="sacred-number">
                <div class="sacred-number-value">${s.val}</div>
                <div class="sacred-number-label">${s.label}</div>
            </div>
        `).join('');
    }

    if (relEl) {
        const sqrt = Math.sqrt(price);
        const squared = price * price;
        const div9 = price / 9;
        const times9 = price * 9;

        relEl.innerHTML = `
            <div style="background:rgba(255,255,255,0.5);padding:8px;border-radius:4px;">
                <div style="color:var(--muted);font-size:10px;">Price</div>
                <div style="font-weight:600;color:#d4a017;">${sqrt.toFixed(4)}</div>
            </div>
            <div style="background:rgba(255,255,255,0.5);padding:8px;border-radius:4px;">
                <div style="color:var(--muted);font-size:10px;">Price</div>
                <div style="font-weight:600;color:#d4a017;">${squared.toFixed(2)}</div>
            </div>
            <div style="background:rgba(255,255,255,0.5);padding:8px;border-radius:4px;">
                <div style="color:var(--muted);font-size:10px;">Price  9</div>
                <div style="font-weight:600;color:#d4a017;">${div9.toFixed(4)}</div>
            </div>
            <div style="background:rgba(255,255,255,0.5);padding:8px;border-radius:4px;">
                <div style="color:var(--muted);font-size:10px;">Price  9</div>
                <div style="font-weight:600;color:#d4a017;">${times9.toFixed(2)}</div>
            </div>
        `;
    }
}

// Update Confluence Display
function updateConfluenceDisplay(confluence) {
    const scoreEl = document.getElementById('confluenceScore');
    const labelEl = document.getElementById('confluenceLabel');
    const ringEl = document.getElementById('confluenceRing');
    const factorsEl = document.getElementById('confluenceFactors');

    if (scoreEl) {
        scoreEl.textContent = confluence.score;

        // Color based on score
        const color = confluence.score >= 75 ? '#22c55e' :
                      confluence.score >= 50 ? '#d4a017' :
                      confluence.score >= 25 ? '#f59e0b' : '#6b7280';
        scoreEl.style.color = color;
    }

    if (labelEl) {
        const label = confluence.score >= 75 ? 'HIGH PROBABILITY ZONE' :
                      confluence.score >= 50 ? 'MODERATE CONFLUENCE' :
                      confluence.score >= 25 ? 'WEAK CONFLUENCE' : 'LOW PROBABILITY';
        labelEl.textContent = label;
        labelEl.style.color = confluence.score >= 50 ? '#d4a017' : 'var(--muted)';
    }

    if (ringEl) {
        const circumference = 314; // 2 * PI * 50
        const offset = circumference - (confluence.score / 100 * circumference);
        ringEl.style.strokeDashoffset = offset;
        ringEl.style.stroke = confluence.score >= 75 ? '#22c55e' :
                              confluence.score >= 50 ? '#d4a017' : '#6b7280';
    }

    if (factorsEl) {
        factorsEl.innerHTML = confluence.factors.map(f => `
            <div class="confluence-factor">
                <span class="confluence-factor-icon">${f.active ? '' : ''}</span>
                <span class="confluence-factor-text">${f.text}</span>
                <span class="confluence-factor-score ${f.active ? 'active' : 'inactive'}">
                    ${f.active ? '+' + f.points : '0'}
                </span>
            </div>
        `).join('');
    }
}

// Generate Gann Forecast
function generateGannForecast(sq9Levels, cycles, pivots, confluence, price) {
    // Direction bias
    const biasEl = document.getElementById('gannBiasText');
    const biasContainerEl = document.getElementById('gannBias');

    let bias = 'NEUTRAL';
    let biasColor = '#d4a017';

    if (pivots.high && pivots.low) {
        const midPoint = (pivots.high.price + pivots.low.price) / 2;
        if (price > midPoint * 1.02) {
            bias = 'BULLISH';
            biasColor = '#22c55e';
        } else if (price < midPoint * 0.98) {
            bias = 'BEARISH';
            biasColor = '#ef4444';
        }
    }

    if (biasEl) {
        biasEl.textContent = bias;
        biasEl.style.color = biasColor;
    }

    // Support & Resistance from Square of 9
    const supportEl = document.getElementById('forecastSupport');
    const resistEl = document.getElementById('forecastResistance');

    if (sq9Levels && supportEl && resistEl) {
        const supportVals = Object.values(sq9Levels.support || {});
        const resistVals = Object.values(sq9Levels.resistance || {});
        const nextSupport = supportVals[0]; // First support level
        const nextResist = resistVals[0]; // First resistance level

        supportEl.textContent = nextSupport ? '$' + (typeof nextSupport === 'object' ? nextSupport.price : nextSupport).toFixed(2) : '--';
        resistEl.textContent = nextResist ? '$' + (typeof nextResist === 'object' ? nextResist.price : nextResist).toFixed(2) : '--';
    }

    // Next cycle turn
    const cycleDateEl = document.getElementById('forecastCycleDate');
    const daysUntilEl = document.getElementById('forecastDaysUntil');

    if (cycles && cycles.length > 0) {
        // Find nearest cycle turn
        const sorted = [...cycles].sort((a, b) => a.daysUntilTurn - b.daysUntilTurn);
        const nearest = sorted[0];

        if (cycleDateEl) {
            cycleDateEl.textContent = nearest.nextTurnDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        if (daysUntilEl) {
            daysUntilEl.textContent = nearest.daysUntilTurn + ' days';
            daysUntilEl.style.color = nearest.daysUntilTurn <= 3 ? '#f59e0b' : '#8b5cf6';
        }
    }

    // Projected move
    const projectedEl = document.getElementById('projectedMoveText');
    if (projectedEl && sq9Levels) {
        const atr = parseFloat(currentData[currentData.length - 1]?.ATR) || price * 0.015;
        const projectedMove = atr * 2;
        const nearestCycleDays = cycles ? Math.min(...cycles.map(c => c.daysUntilTurn)) : 30;

        const direction = bias === 'BULLISH' ? '' : bias === 'BEARISH' ? '' : '';
        projectedEl.textContent = `Expect ${direction} $${projectedMove.toFixed(2)} move within ${nearestCycleDays} days`;
    }
}

// Update Gann Dates
function updateGannDates() {
    const datesEl = document.getElementById('gannDates');
    if (!datesEl) return;

    const dates = getGannDates();
    datesEl.innerHTML = dates.map(d => `
        <div class="gann-date-item ${d.isNear ? 'near' : ''}">
            <span>${d.icon} ${d.name}</span>
            <span style="font-weight:600;${d.isNear ? 'color:#f59e0b;' : ''}">${d.dateStr}</span>
        </div>
    `).join('');
}

// ============================================
// OVERVIEW TAB UPDATE FUNCTIONS
// ============================================

// Update Fibonacci Zone Display
function updateFibonacciZoneDisplay() {
    if (!currentData || currentData.length < 20) return;

    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close) || 0;

    // Calculate 52-week high/low for Fibonacci levels
    const lookback = Math.min(252, currentData.length);
    const yearData = currentData.slice(-lookback);
    let high52 = 0, low52 = Infinity;
    yearData.forEach(bar => {
        const h = parseFloat(bar.High) || 0;
        const l = parseFloat(bar.Low) || Infinity;
        if (h > high52) high52 = h;
        if (l < low52) low52 = l;
    });

    const range = high52 - low52;
    const s1 = low52 + range * 0.382;
    const s2 = low52 + range * 0.5;
    const s3 = low52 + range * 0.618;
    const r1 = high52; // 100%
    const r2 = high52 + range * 0.272;
    const r3 = high52 + range * 0.618;

    // Update prices
    var el=document.getElementById('fibS3');if(el)el.textContent = '$' + s3.toFixed(2);
    var el=document.getElementById('fibS2');if(el)el.textContent = '$' + s2.toFixed(2);
    var el=document.getElementById('fibS1');if(el)el.textContent = '$' + s1.toFixed(2);
    var el=document.getElementById('fibCurrentPrice');if(el)el.textContent = '$' + price.toFixed(2);
    var el=document.getElementById('fibR1');if(el)el.textContent = '$' + r1.toFixed(2);
    var el=document.getElementById('fibR2');if(el)el.textContent = '$' + r2.toFixed(2);
    var el=document.getElementById('fibR3');if(el)el.textContent = '$' + r3.toFixed(2);

    // Determine zone
    let zoneLabel = '';
    let zoneColor = '#22c55e';
    if (price < s3) {
        zoneLabel = ' Below S3 - Oversold Zone';
        zoneColor = '#ef4444';
    } else if (price < s2) {
        zoneLabel = ' Between S3 and S2 - Support Zone';
        zoneColor = '#eab308';
    } else if (price < s1) {
        zoneLabel = ' Between S2 and S1 - Recovery Zone';
        zoneColor = '#22c55e';
    } else if (price < r1) {
        zoneLabel = ' Between S1 and R1 - Neutral Zone';
        zoneColor = '#22c55e';
    } else if (price < r2) {
        zoneLabel = ' Between R1 and R2 - Resistance Zone';
        zoneColor = '#eab308';
    } else if (price < r3) {
        zoneLabel = ' Between R2 and R3 - Extended Zone';
        zoneColor = '#f97316';
    } else {
        zoneLabel = ' Above R3 - Overbought Zone';
        zoneColor = '#ef4444';
    }

    const zoneLabelEl = document.getElementById('fibZoneLabel');
    if (zoneLabelEl) {
        zoneLabelEl.textContent = zoneLabel;
        zoneLabelEl.style.color = zoneColor;
    }
}

// Update Multi-Timeframe Trends
function updateMultiTimeframeTrends() {
    if (!currentData || currentData.length < 20) return;

    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close) || 0;

    // Calculate SMAs for different timeframes
    const sma5 = currentData.slice(-5).reduce((sum, d) => sum + parseFloat(d.Close || 0), 0) / 5;
    const sma10 = currentData.slice(-10).reduce((sum, d) => sum + parseFloat(d.Close || 0), 0) / 10;
    const sma20 = currentData.slice(-20).reduce((sum, d) => sum + parseFloat(d.Close || 0), 0) / 20;

    // Intraday trend (price vs 5 SMA)
    const intradayTrend = price > sma5 ? 'BULLISH' : 'BEARISH';
    const intradayColor = price > sma5 ? '#22c55e' : '#ef4444';

    // Swing trend (price vs 10 SMA and 5 vs 10)
    const swingBullish = price > sma10 && sma5 > sma10;
    const swingTrend = swingBullish ? 'BULLISH' : 'BEARISH';
    const swingColor = swingBullish ? '#22c55e' : '#ef4444';

    // Position trend (price vs 20 SMA)
    const positionTrend = price > sma20 ? 'BULLISH' : 'BEARISH';
    const positionColor = price > sma20 ? '#22c55e' : '#ef4444';

    var el=document.getElementById('trendIntraday');if(el)el.textContent = intradayTrend;
    document.getElementById('trendIntraday').style.color = intradayColor;
    var el=document.getElementById('trendSwing');if(el)el.textContent = swingTrend;
    document.getElementById('trendSwing').style.color = swingColor;
    var el=document.getElementById('trendPosition');if(el)el.textContent = positionTrend;
    document.getElementById('trendPosition').style.color = positionColor;
}

// Update Gann Quick View
function updateGannQuickView() {
    if (!currentData || currentData.length < 10) return;

    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close) || 0;
    const bias = lastBar.Bias || 'NEUTRAL';

    // Trend
    const trendEl = document.getElementById('gannQvTrend');
    if (trendEl) {
        trendEl.textContent = bias;
        trendEl.style.color = bias === 'BULLISH' ? '#22c55e' : bias === 'BEARISH' ? '#ef4444' : '#d4a017';
    }

    // Volume vs Average
    const avgVol = currentData.slice(-20).reduce((sum, d) => sum + (parseInt(d.Volume) || 0), 0) / 20;
    const todayVol = parseInt(lastBar.Volume) || 0;
    const volRatio = avgVol > 0 ? ((todayVol / avgVol) * 100).toFixed(0) : 100;
    const volEl = document.getElementById('gannQvVolume');
    if (volEl) {
        volEl.textContent = volRatio + '%';
        volEl.style.color = parseInt(volRatio) > 120 ? '#22c55e' : parseInt(volRatio) < 80 ? '#ef4444' : 'var(--text)';
    }

    // Bars in current trend
    let barsInTrend = 0;
    const currentDirection = parseFloat(currentData[currentData.length - 1].Close) > parseFloat(currentData[currentData.length - 2].Close) ? 'up' : 'down';
    for (let i = currentData.length - 1; i > 0; i--) {
        const prevDir = parseFloat(currentData[i].Close) > parseFloat(currentData[i - 1].Close) ? 'up' : 'down';
        if (prevDir === currentDirection) {
            barsInTrend++;
        } else {
            break;
        }
    }
    const barsEl = document.getElementById('gannQvBars');
    if (barsEl) {
        barsEl.textContent = barsInTrend + ' bars';
        barsEl.style.color = barsInTrend > 5 ? '#f59e0b' : 'var(--text)';
    }

    // Cycle Phase - Calculate 30-day Gann cycle from fixed base date
    const cycleLength = 30;
    const cycleBaseDate = new Date('2024-11-15');
    const todayDate = new Date();
    const daysSinceBase = Math.floor((todayDate - cycleBaseDate) / (1000 * 60 * 60 * 24));
    let cycleDay = ((daysSinceBase % cycleLength) + cycleLength) % cycleLength; // Always positive
    let daysToTurn = cycleLength - cycleDay;

    // If turn is today (day 0), show as day 30 with next turn in 30 days
    if (cycleDay === 0) {
        cycleDay = cycleLength;
        daysToTurn = cycleLength;
    }

    const cyclePhaseEl = document.getElementById('gannQvCyclePhase');
    if (cyclePhaseEl) {
        cyclePhaseEl.textContent = 'Day ' + cycleDay + ' of ' + cycleLength;
    }

    // Next Cycle Turn
    const nextTurnEl = document.getElementById('gannQvNextTurn');
    if (nextTurnEl) {
        const nextDate = new Date();
        nextDate.setDate(nextDate.getDate() + daysToTurn);
        nextTurnEl.textContent = nextDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        nextTurnEl.style.color = daysToTurn <= 3 ? '#f59e0b' : 'var(--text)';
    }

    // Gann Score
    const scoreEl = document.getElementById('gannQvScore');
    if (scoreEl) {
        let score = 50;
        if (bias === 'BULLISH') score += 15;
        if (parseInt(volRatio) > 100) score += 10;
        if (barsInTrend >= 3) score += 10;
        score = Math.min(100, score);
        scoreEl.textContent = score + '/100';
        scoreEl.style.color = score >= 75 ? '#22c55e' : score >= 50 ? '#d4a017' : '#ef4444';
    }

    // Agent Consensus
    const consensusEl = document.getElementById('gannQvConsensus');
    if (consensusEl) {
        consensusEl.textContent = bias === 'BULLISH' ? 'BUY' : bias === 'BEARISH' ? 'SELL' : 'HOLD';
        consensusEl.style.color = bias === 'BULLISH' ? '#22c55e' : bias === 'BEARISH' ? '#ef4444' : '#d4a017';
    }

    // Reversal Risk
    const reversalEl = document.getElementById('gannQvReversal');
    if (reversalEl) {
        const risk = barsInTrend > 7 ? 'HIGH' : barsInTrend > 4 ? 'MEDIUM' : 'LOW';
        reversalEl.textContent = risk;
        reversalEl.style.color = risk === 'HIGH' ? '#ef4444' : risk === 'MEDIUM' ? '#f59e0b' : '#22c55e';
    }

    // MTF Alignment
    const mtfEl = document.getElementById('gannQvMtf');
    if (mtfEl) {
        const sma5 = currentData.slice(-5).reduce((sum, d) => sum + parseFloat(d.Close || 0), 0) / 5;
        const sma20 = currentData.slice(-20).reduce((sum, d) => sum + parseFloat(d.Close || 0), 0) / 20;
        const aligned = (price > sma5 && sma5 > sma20) || (price < sma5 && sma5 < sma20);
        mtfEl.textContent = aligned ? 'ALIGNED' : 'MIXED';
        mtfEl.style.color = aligned ? '#22c55e' : '#f59e0b';
    }

    // Entry Window
    const entryEl = document.getElementById('gannQvEntry');
    if (entryEl) {
        const entryScore = (barsInTrend < 5 && parseInt(volRatio) > 90) ? 'OPEN' : 'WAIT';
        entryEl.textContent = entryScore;
        entryEl.style.color = entryScore === 'OPEN' ? '#22c55e' : '#f59e0b';
    }
}

// Symbol to full name mapping
const symbolNames = {
    'SPY': 'S&P 500',
    'QQQ': 'Nasdaq 100',
    'IWM': 'Russell 2000',
    'DIA': 'Dow Jones',
    'XLK': 'Technology',
    'XLF': 'Financials',
    'XLE': 'Energy',
    'XLV': 'Healthcare',
    'XLI': 'Industrials',
    'XLP': 'Consumer Staples',
    'XLU': 'Utilities',
    'XLB': 'Materials',
    'XLC': 'Communications',
    'XLRE': 'Real Estate',
    'XLY': 'Consumer Disc',
    'VXX': 'Volatility',
    'TLT': 'Treasury Bonds',
    'GLD': 'Gold',
    'SLV': 'Silver',
    'USO': 'Oil',
    'UNG': 'Natural Gas',
    'EEM': 'Emerging Mkts',
    'EFA': 'Intl Developed',
    'HYG': 'High Yield',
    'LQD': 'Investment Grade',
    'ARKK': 'Innovation',
    'SMH': 'Semiconductors',
    'XBI': 'Biotech',
    'KRE': 'Regional Banks',
    'XHB': 'Homebuilders'
};

// Update Trade Statistics
function updateTradeStatistics() {
    if (!currentData || currentData.length < 30) return;

    const last30 = currentData.slice(-30);
    let wins = 0, losses = 0;
    let totalWin = 0, totalLoss = 0;
    let bestDay = 0, worstDay = 0;
    let streak = 0, currentStreakDir = null;

    for (let i = 1; i < last30.length; i++) {
        const change = parseFloat(last30[i].Close) - parseFloat(last30[i - 1].Close);
        const changeDollar = change;

        if (change > 0) {
            wins++;
            totalWin += changeDollar;
            if (changeDollar > bestDay) bestDay = changeDollar;
            if (currentStreakDir === 'win') streak++;
            else { streak = 1; currentStreakDir = 'win'; }
        } else if (change < 0) {
            losses++;
            totalLoss += Math.abs(changeDollar);
            if (changeDollar < worstDay) worstDay = changeDollar;
            if (currentStreakDir === 'loss') streak++;
            else { streak = 1; currentStreakDir = 'loss'; }
        }
    }

    const totalTrades = wins + losses;
    const winRate = totalTrades > 0 ? ((wins / totalTrades) * 100).toFixed(0) : 0;
    const avgWin = wins > 0 ? (totalWin / wins).toFixed(2) : 0;
    const avgLoss = losses > 0 ? (totalLoss / losses).toFixed(2) : 0;

    // Update dynamic title with symbol name
    const symbolName = symbolNames[currentSymbol] || currentSymbol;
    const titleEl = document.getElementById('statsTitle');
    if (titleEl) {
        titleEl.textContent = `${currentSymbol} - ${symbolName}  Trade Statistics (Last 30 Days)`;
    }

    var el=document.getElementById('statsWinRate');if(el)el.textContent = winRate + '%';
    var el=document.getElementById('statsAvgWin');if(el)el.textContent = '$' + avgWin;
    var el=document.getElementById('statsAvgLoss');if(el)el.textContent = '$' + avgLoss;
    var el=document.getElementById('statsTotalTrades');if(el)el.textContent = totalTrades;
    var el=document.getElementById('statsBestDay');if(el)el.textContent = '+$' + bestDay.toFixed(2);
    var el=document.getElementById('statsWorstDay');if(el)el.textContent = '$' + worstDay.toFixed(2);
    var el=document.getElementById('statsStreak');if(el)el.textContent = streak + ' ' + (currentStreakDir === 'win' ? '' : '');
}

// Market Events Calendar Data
const marketEvents = {
    '2025-12-06': ' Jobs Report',
    '2025-12-11': ' CPI',
    '2025-12-17': ' FOMC Decision',
    '2025-12-18': ' FOMC',
    '2025-12-20': ' OpEx (Monthly)',
    '2025-12-24': ' Early Close',
    '2025-12-25': ' Market Closed',
    '2025-12-31': ' NYE Early Close',
    '2026-01-01': ' Market Closed',
    '2026-01-03': ' Jobs Report',
    '2026-01-10': ' CPI',
    '2026-01-15': ' OpEx (Monthly)',
    '2026-01-20': ' MLK Day Closed',
    '2026-01-29': ' FOMC',
    '2026-02-07': ' Jobs Report',
    '2026-02-12': ' CPI',
    '2026-02-21': ' OpEx (Monthly)',
    '2026-03-07': ' Jobs Report',
    '2026-03-12': ' CPI',
    '2026-03-18': ' FOMC',
    '2026-03-21': ' OpEx (Monthly)'
};

// Detect candle type
function detectCandleType(open, high, low, close) {
    const body = Math.abs(close - open);
    const range = high - low;
    const upperWick = high - Math.max(open, close);
    const lowerWick = Math.min(open, close) - low;

    if (range === 0) return { type: 'Doji', icon: '', color: '#f59e0b' };

    const bodyRatio = body / range;
    const upperWickRatio = upperWick / range;
    const lowerWickRatio = lowerWick / range;

    // Doji - small body, long wicks
    if (bodyRatio < 0.1) {
        return { type: 'Doji', icon: '', color: '#f59e0b' };
    }

    // Hammer - small body at top, long lower wick (bullish reversal)
    if (lowerWickRatio > 0.6 && upperWickRatio < 0.1 && bodyRatio < 0.3) {
        return { type: 'Hammer', icon: '', color: '#22c55e' };
    }

    // Shooting Star - small body at bottom, long upper wick (bearish reversal)
    if (upperWickRatio > 0.6 && lowerWickRatio < 0.1 && bodyRatio < 0.3) {
        return { type: 'Star', icon: '', color: '#ef4444' };
    }

    // Strong candles - big body, small wicks
    if (bodyRatio > 0.7) {
        if (close > open) {
            return { type: 'Strong Bull', icon: '', color: '#22c55e' };
        } else {
            return { type: 'Strong Bear', icon: '', color: '#ef4444' };
        }
    }

    // Regular candles
    if (close > open) {
        return { type: 'Bullish', icon: '', color: '#22c55e' };
    } else {
        return { type: 'Bearish', icon: '', color: '#ef4444' };
    }
}

// Update Upcoming Events Widget
function updateUpcomingEventsWidget() {
    const widget = document.getElementById('upcomingEventsWidget');
    if (!widget) return;

    const today = new Date();
    const next7Days = [];

    for (let i = 0; i < 7; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(today.getDate() + i);
        const dateStr = checkDate.toISOString().split('T')[0];
        const dayName = checkDate.toLocaleDateString('en-US', { weekday: 'short' });
        const dateDisplay = checkDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        if (marketEvents[dateStr]) {
            next7Days.push({
                date: dateDisplay,
                day: dayName,
                event: marketEvents[dateStr],
                daysAway: i
            });
        }
    }

    if (next7Days.length === 0) {
        widget.innerHTML = '<div style="color: var(--muted); font-size: 11px;">No major events in next 7 days</div>';
        return;
    }

    widget.innerHTML = next7Days.map(e => `
        <div style="background: ${e.daysAway === 0 ? 'rgba(239,68,68,0.2)' : 'rgba(255,255,255,0.5)'};
                    border: 1px solid ${e.daysAway === 0 ? '#ef4444' : 'rgba(245,158,11,0.3)'};
                    border-radius: 6px; padding: 8px 12px; text-align: center;">
            <div style="font-size: 9px; color: var(--muted);">${e.day} ${e.date}</div>
            <div style="font-size: 11px; font-weight: 600; ${e.daysAway === 0 ? 'color: #ef4444;' : ''}">${e.event}</div>
            <div style="font-size: 9px; color: ${e.daysAway <= 1 ? '#f59e0b' : 'var(--muted)'};">
                ${e.daysAway === 0 ? ' TODAY' : e.daysAway === 1 ? 'Tomorrow' : `In ${e.daysAway} days`}
            </div>
        </div>
    `).join('');
}

// Update Pattern Detection Summary - Now uses table format
function updatePatternDetectionSummary() {
    // Redirect to table-based pattern detection
    if (typeof updatePatternTableFromCSV === 'function') {
        updatePatternTableFromCSV();
    }
}

// Update Historical Data Table with all new columns
function updateHistoricalDataTable() {
    if (!currentData || currentData.length < 10) return;

    const tbody = document.getElementById('historicalDataTable');
    const summaryEl = document.getElementById('historicalSummary');
    if (!tbody) return;

    // Calculate 20-day average volume
    const avgVol20 = currentData.slice(-20).reduce((s, d) => s + (parseInt(d.Volume) || 0), 0) / 20;

    const last10 = currentData.slice(-10).reverse();
    let html = '';

    // Summary counters
    let gapUps = 0, gapDowns = 0, hhhlCount = 0, lhllCount = 0, highVolDays = 0, lowVolDays = 0;
    let nextEventDays = null, nextEventName = '';

    // Find next event
    const today = new Date();
    for (let i = 0; i < 14; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(today.getDate() + i);
        const dateStr = checkDate.toISOString().split('T')[0];
        if (marketEvents[dateStr]) {
            nextEventDays = i;
            nextEventName = marketEvents[dateStr];
            break;
        }
    }

    last10.forEach((bar, index) => {
        const date = bar.Date || bar.date || '--';
        const dateKey = new Date(date).toISOString().split('T')[0];
        const open = parseFloat(bar.Open) || 0;
        const high = parseFloat(bar.High) || 0;
        const low = parseFloat(bar.Low) || 0;
        const close = parseFloat(bar.Close) || 0;
        const volume = parseInt(bar.Volume) || 0;

        // Get previous bar data (remember: array is reversed)
        const prevBar = last10[index + 1];
        const prevClose = prevBar ? parseFloat(prevBar.Close) || close : close;
        const prevHigh = prevBar ? parseFloat(prevBar.High) || high : high;
        const prevLow = prevBar ? parseFloat(prevBar.Low) || low : low;

        // Change calculation
        const change = close - prevClose;
        const changePct = prevClose > 0 ? ((change / prevClose) * 100).toFixed(2) : 0;

        // GAP calculation
        const gap = open - prevClose;
        const gapPct = prevClose > 0 ? ((gap / prevClose) * 100).toFixed(2) : 0;
        let gapDisplay = '', gapColor = '';
        if (Math.abs(parseFloat(gapPct)) >= 0.5) {
            if (gap > 0) { gapDisplay = ` +$${gap.toFixed(2)}`; gapColor = '#22c55e'; gapUps++; }
            else { gapDisplay = ` $${gap.toFixed(2)}`; gapColor = '#ef4444'; gapDowns++; }
        } else {
            gapDisplay = ` $${gap.toFixed(2)}`; gapColor = 'var(--muted)';
        }

        // Candle Type
        const candle = detectCandleType(open, high, low, close);

        // Trend Signal (HH/HL or LH/LL)
        let trendSignal = '', trendColor = '';
        if (prevBar) {
            const higherHigh = high > prevHigh;
            const higherLow = low > prevLow;
            const lowerHigh = high < prevHigh;
            const lowerLow = low < prevLow;

            if (higherHigh && higherLow) {
                trendSignal = ' HH/HL'; trendColor = '#22c55e'; hhhlCount++;
            } else if (lowerHigh && lowerLow) {
                trendSignal = ' LH/LL'; trendColor = '#ef4444'; lhllCount++;
            } else {
                trendSignal = ' Mixed'; trendColor = '#f59e0b';
            }
        } else {
            trendSignal = '--'; trendColor = 'var(--muted)';
        }

        // Close Position (where did price close in day's range)
        const range = high - low;
        const closePos = range > 0 ? ((close - low) / range * 100).toFixed(0) : 50;
        let closePosDisplay = '', closePosColor = '';
        if (parseInt(closePos) >= 75) {
            closePosDisplay = ' Upper'; closePosColor = '#22c55e';
        } else if (parseInt(closePos) <= 25) {
            closePosDisplay = ' Lower'; closePosColor = '#ef4444';
        } else {
            closePosDisplay = ' Mid'; closePosColor = 'var(--muted)';
        }

        // Volume Signal
        const volRatio = avgVol20 > 0 ? ((volume / avgVol20) * 100).toFixed(0) : 100;
        let volDisplay = '', volColor = '';
        if (parseInt(volRatio) >= 150) {
            volDisplay = ` +${volRatio - 100}%`; volColor = '#22c55e'; highVolDays++;
        } else if (parseInt(volRatio) <= 70) {
            volDisplay = ` ${volRatio - 100}%`; volColor = '#ef4444'; lowVolDays++;
        } else {
            volDisplay = ' Norm'; volColor = 'var(--muted)';
        }

        // OH Signal
        const openToLow = open - low;
        const openToHigh = high - open;
        const ohSignal = openToLow < openToHigh ? '' : '';
        const ohColor = openToLow < openToHigh ? '#22c55e' : '#ef4444';

        // Events
        const event = marketEvents[dateKey] || '-';

        // Row background color
        let rowBg = '';
        if (event !== '-') rowBg = 'background: rgba(245,158,11,0.1);';
        else if (parseInt(volRatio) >= 150) rowBg = 'background: rgba(59,130,246,0.1);';
        else if (candle.type === 'Hammer' || candle.type === 'Star') rowBg = 'background: rgba(249,115,22,0.1);';

        const dateFormatted = new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const changeColor = change >= 0 ? '#22c55e' : '#ef4444';
        const changeSign = change >= 0 ? '+' : '';

        html += `
            <tr style="${rowBg}">
                <td style="font-weight: 600;">${dateFormatted}</td>
                <td style="font-size: 9px;">$${open.toFixed(0)}/${high.toFixed(0)}/${low.toFixed(0)}/<span style="font-weight:600;">$${close.toFixed(2)}</span></td>
                <td style="color: ${changeColor}; font-weight: 600;">${changeSign}${changePct}%</td>
                <td style="color: ${gapColor};">${gapDisplay}</td>
                <td style="color: ${candle.color};">${candle.icon} ${candle.type}</td>
                <td style="color: ${trendColor};">${trendSignal}</td>
                <td style="color: ${closePosColor};">${closePosDisplay}</td>
                <td style="color: ${volColor};">${volDisplay}</td>
                <td style="color: ${ohColor};">${ohSignal}</td>
                <td style="font-size: 9px;">${event}</td>
            </tr>
        `;
    });

    tbody.innerHTML = html;

    // Update summary row
    if (summaryEl) {
        const trendDesc = hhhlCount > lhllCount + 2 ? ' Uptrend Confirmed' :
                          lhllCount > hhhlCount + 2 ? ' Downtrend Confirmed' : ' Consolidation';
        const volDesc = highVolDays > 3 ? ' High Volume' :
                        lowVolDays > 5 ? ' Low Volume ( Weak)' : ' Normal Volume';

        let nextEventHtml = '';
        if (nextEventDays !== null) {
            nextEventHtml = `<div><strong>Next Event:</strong> ${nextEventName} in ${nextEventDays} day${nextEventDays !== 1 ? 's' : ''}</div>`;
        }

        summaryEl.innerHTML = `
            <div><strong>Gaps:</strong> ${gapUps} Up, ${gapDowns} Down</div>
            <div><strong>Trend:</strong> ${hhhlCount} HH/HL, ${lhllCount} LH/LL  ${trendDesc}</div>
            <div><strong>Volume:</strong> ${volDesc}</div>
            ${nextEventHtml}
        `;
    }

    // Also update related widgets
    updateUpcomingEventsWidget();
    updatePatternDetectionSummary();
}

// Update Overview Reference Data
function updateOverviewReferenceData() {
    if (!currentData || currentData.length < 2) return;

    const lastBar = currentData[currentData.length - 1];
    const prevBar = currentData[currentData.length - 2];

    // Today Open
    const openEl = document.getElementById('todayOpen');
    if (openEl) openEl.textContent = '$' + (parseFloat(lastBar.Open) || 0).toFixed(2);

    // Prev Close
    const prevCloseEl = document.getElementById('prevClose');
    if (prevCloseEl) prevCloseEl.textContent = '$' + (parseFloat(prevBar.Close) || 0).toFixed(2);
}

// Master Overview Update Function
function updateOverviewTab() {
    updateFibonacciZoneDisplay();
    updateMultiTimeframeTrends();
    updateGannQuickView();
    updateTradeStatistics();
    updateHistoricalDataTable();
    updateOverviewReferenceData();
}

// Load Overview data directly from CSV
async function loadOverviewData() {
    const symbol = document.querySelector('#symbolSelect')?.value || 'SPY';

    try {
        // Try data folder first, then root
        let response = await fetch('data/' + symbol + '.csv').catch(() => null);

        if (!response?.ok) {
            console.log('Could not load ' + symbol + '.csv');
            return;
        }

        const text = await response.text();
        const lines = text.trim().split('\n');

        if (lines.length < 2) return;

        // Parse header to get column indices
        const header = lines[0].split(',');
        const getIndex = (name) => header.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));

        // Get last row (most recent data)
        const lastLine = lines[lines.length - 1];
        const cols = lastLine.split(',');

        // Get previous row for change calculation
        const prevLine = lines.length > 2 ? lines[lines.length - 2] : lastLine;
        const prevCols = prevLine.split(',');

        // Extract values using header or fallback positions
        const close = parseFloat(cols[getIndex('close')] || cols[4]) || 0;
        const open = parseFloat(cols[getIndex('open')] || cols[1]) || 0;
        const high = parseFloat(cols[getIndex('high')] || cols[2]) || 0;
        const low = parseFloat(cols[getIndex('low')] || cols[3]) || 0;
        const volume = parseFloat(cols[getIndex('volume')] || cols[5]) || 0;
        const atr = parseFloat(cols[getIndex('atr')] || cols[6]) || 0;
        const prevClose = parseFloat(prevCols[getIndex('close')] || prevCols[4]) || close;

        // Calculate change
        const change = close - prevClose;
        const changePct = prevClose ? ((change / prevClose) * 100) : 0;

        // Update Price metric
        const priceEl = document.getElementById('currentPrice');
        if (priceEl) priceEl.textContent = '$' + close.toFixed(2);

        // Update Change
        const changeEl = document.getElementById('dailyChange');
        if (changeEl) {
            changeEl.textContent = (change >= 0 ? '+' : '') + '$' + Math.abs(change).toFixed(2);
            changeEl.className = 'metric-value ' + (change >= 0 ? 'positive' : 'negative');
        }

        const changePctEl = document.getElementById('changePct');
        if (changePctEl) changePctEl.textContent = (changePct >= 0 ? '+' : '') + changePct.toFixed(2) + '%';

        // Update Volume
        const volEl = document.getElementById('volumeDisplay');
        if (volEl) volEl.textContent = (volume / 1000000).toFixed(1) + 'M';

        // Update ATR
        const atrEl = document.getElementById('atrDisplay');
        if (atrEl) atrEl.textContent = '$' + atr.toFixed(2);

        // Calculate Fibonacci levels based on recent high/low
        let recentHigh = high;
        let recentLow = low;

        // Get high/low from last 20 bars
        for (let i = Math.max(1, lines.length - 20); i < lines.length; i++) {
            const rowCols = lines[i].split(',');
            const h = parseFloat(rowCols[getIndex('high')] || rowCols[2]) || 0;
            const l = parseFloat(rowCols[getIndex('low')] || rowCols[3]) || 0;
            if (h > recentHigh) recentHigh = h;
            if (l < recentLow || recentLow === 0) recentLow = l;
        }

        const range = recentHigh - recentLow;

        // Fibonacci levels
        const fib382 = recentHigh - (range * 0.382);
        const fib500 = recentHigh - (range * 0.500);
        const fib618 = recentHigh - (range * 0.618);
        const fib100 = recentHigh;
        const fib1272 = recentLow + (range * 1.272);
        const fib1618 = recentLow + (range * 1.618);

        // Update Fibonacci Price Zones
        const fibS1 = document.getElementById('fibS1');
        const fibS2 = document.getElementById('fibS2');
        const fibS3 = document.getElementById('fibS3');
        const fibR1 = document.getElementById('fibR1');
        const fibR2 = document.getElementById('fibR2');
        const fibR3 = document.getElementById('fibR3');
        const fibCurrentPrice = document.getElementById('fibCurrentPrice');

        if (fibS1) fibS1.textContent = '$' + fib382.toFixed(2);
        if (fibS2) fibS2.textContent = '$' + fib500.toFixed(2);
        if (fibS3) fibS3.textContent = '$' + fib618.toFixed(2);
        if (fibR1) fibR1.textContent = '$' + fib100.toFixed(2);
        if (fibR2) fibR2.textContent = '$' + fib1272.toFixed(2);
        if (fibR3) fibR3.textContent = '$' + fib1618.toFixed(2);
        if (fibCurrentPrice) fibCurrentPrice.textContent = '$' + close.toFixed(2);

        // Calculate 52-week high/low from all data (up to 252 bars)
        let high52w = 0;
        let low52w = Infinity;
        const barsFor52w = Math.min(lines.length - 1, 252);

        for (let i = lines.length - barsFor52w; i < lines.length; i++) {
            if (i < 1) continue;
            const rowCols = lines[i].split(',');
            const h = parseFloat(rowCols[getIndex('high')] || rowCols[2]) || 0;
            const l = parseFloat(rowCols[getIndex('low')] || rowCols[3]) || 0;
            if (h > high52w) high52w = h;
            if (l < low52w && l > 0) low52w = l;
        }

        if (low52w === Infinity) low52w = low;

        // Update Reference Data
        const week52HighEl = document.getElementById('week52High');
        const week52LowEl = document.getElementById('week52Low');
        const todayHighEl = document.getElementById('todayHigh');
        const todayLowEl = document.getElementById('todayLow');
        const todayOpenEl = document.getElementById('todayOpen');
        const prevCloseEl = document.getElementById('prevClose');

        if (week52HighEl) week52HighEl.textContent = '$' + high52w.toFixed(2);
        if (week52LowEl) week52LowEl.textContent = '$' + low52w.toFixed(2);
        if (todayHighEl) todayHighEl.textContent = '$' + high.toFixed(2);
        if (todayLowEl) todayLowEl.textContent = '$' + low.toFixed(2);
        if (todayOpenEl) todayOpenEl.textContent = '$' + open.toFixed(2);
        if (prevCloseEl) prevCloseEl.textContent = '$' + prevClose.toFixed(2);

        // Calculate average volume (last 20 bars)
        let totalVolume = 0;
        const volBars = Math.min(lines.length - 1, 20);
        for (let i = lines.length - volBars; i < lines.length; i++) {
            if (i < 1) continue;
            const rowCols = lines[i].split(',');
            totalVolume += parseFloat(rowCols[getIndex('volume')] || rowCols[5]) || 0;
        }
        const avgVol = totalVolume / volBars;

        const avgVolEl = document.getElementById('avgVolume20');
        const volVsAvgEl = document.getElementById('volumeVsAvg');
        const volVsAvgSmallEl = document.getElementById('volumeVsAvgSmall');

        if (avgVolEl) avgVolEl.textContent = (avgVol / 1e6).toFixed(1) + 'M';
        if (volVsAvgEl) volVsAvgEl.textContent = ((volume / avgVol - 1) * 100).toFixed(0) + '%';
        if (volVsAvgSmallEl) volVsAvgSmallEl.textContent = ((volume / avgVol - 1) * 100).toFixed(0) + '% vs avg';

        console.log('Overview data loaded for ' + symbol);

    } catch (error) {
        console.log('Error loading overview data:', error);
    }
}

function generateDailyReport() {
    console.log('Generating daily report...', currentAnalysisMode);
    
    if (!currentData || currentData.length === 0) {
        console.warn('No data available for analysis');
        return;
    }
    
    // Get current symbol data
    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close) || 0;
    const prevClose = parseFloat(currentData[currentData.length - 2]?.Close) || price;
    
    // Calculate all signal components
    const signals = calculateAllSignals(currentData, price, prevClose);
    
    // Update the UI
    updateConfluenceScore(signals);
    updateTradeRecommendations(signals);
    updateGannAnalysis(price);
    updateFibonacciLevels(currentData);
    updateHighConsensusTrades(signals);
    updateMarketContext(signals);
    updateAISummary(signals, price);
    updatePlanDateTime();
    
    // Store for download
    dailyAnalysisData = {
        mode: currentAnalysisMode,
        timestamp: new Date().toISOString(),
        symbol: currentSymbol,
        price: price,
        signals: signals
    };

    // Update analysis timestamp
    updateSectionTimestamp('analysis');
}

function calculateAllSignals(data, price, prevClose) {
    const signals = {
        agentConsensus: { score: 0, detail: '', count: 0, agentDetails: null, isReal: false },
        barCount: { score: 0, detail: '', count: 0 },
        patterns: { score: 0, detail: '', found: [] },
        gann: { score: 0, detail: '' },
        fibonacci: { score: 0, detail: '', level: '' },
        volume: { score: 0, detail: '' },
        masterScore: 0,
        direction: 'NEUTRAL',
        confidence: 50
    };
    
    // 1. Agent Consensus Score (with individual agent breakdown)
    const agentSignals = getAgentSignals();
    signals.agentConsensus.count = agentSignals.agreeing;
    signals.agentConsensus.score = (agentSignals.agreeing / 4) * 4; // Max 4 points
    signals.agentConsensus.signal = agentSignals.signal;
    signals.agentConsensus.isReal = agentSignals.isReal;
    signals.agentConsensus.agentDetails = agentSignals.agentDetails;
    signals.agentConsensus.timestamp = agentSignals.timestamp;
    signals.agentConsensus.detail = `${agentSignals.agreeing}/4 agents: ${agentSignals.signal}${agentSignals.isReal ? ' (LIVE)' : ' (calc)'}`;
    
    // 2. Bar Count Score
    const barCount = calculateBarCountSignal(data);
    signals.barCount.count = barCount.count;
    signals.barCount.score = Math.min(Math.abs(barCount.count) / 5, 2) * (barCount.count > 0 ? 1 : -1); // Max 2
    signals.barCount.detail = `${barCount.count > 0 ? '+' : ''}${barCount.count} consecutive ${barCount.direction} bars`;
    
    // 3. Pattern Score
    const patterns = detectAllPatterns(data);
    signals.patterns.found = patterns.found;
    signals.patterns.score = patterns.score; // Max 3
    signals.patterns.detail = patterns.found.length > 0 ? patterns.found.join(', ') : 'No patterns detected';
    
    // 4. Gann Cycle Score
    const gann = calculateGannCycleScore(data, price);
    signals.gann.score = gann.score; // Max 2
    signals.gann.detail = gann.detail;
    
    // 5. Fibonacci Score
    const fib = calculateFibonacciScore(data, price);
    signals.fibonacci.score = fib.score; // Max 2
    signals.fibonacci.detail = fib.detail;
    signals.fibonacci.level = fib.level;
    
    // 6. Volume Score
    const volume = calculateVolumeScore(data);
    signals.volume.score = volume.score; // Max 1.5
    signals.volume.detail = volume.detail;
    
    // Calculate Master Score
    signals.masterScore = (
        signals.agentConsensus.score +
        signals.barCount.score +
        signals.patterns.score +
        signals.gann.score +
        signals.fibonacci.score +
        signals.volume.score
    );
    
    // Determine direction and confidence
    if (signals.masterScore >= 3) {
        signals.direction = 'BULLISH';
        signals.confidence = Math.min(50 + signals.masterScore * 5, 95);
    } else if (signals.masterScore <= -3) {
        signals.direction = 'BEARISH';
        signals.confidence = Math.min(50 + Math.abs(signals.masterScore) * 5, 95);
    } else {
        signals.direction = 'NEUTRAL';
        signals.confidence = 50 + Math.abs(signals.masterScore) * 3;
    }
    
    return signals;
}

// Real agent voting data (loaded from voting_log.json)
let realAgentVotes = null;

async function loadRealAgentSignals() {
    try {
        const response = await fetch('data/voting_log.json');
        if (response.ok) {
            const data = await response.json();
            realAgentVotes = data;
            console.log(' Loaded real agent signals from voting_log.json');
            // Update display with real signals
            if (typeof updateAgentSignalDisplay === 'function') {
                setTimeout(updateAgentSignalDisplay, 100);
            }
            return true;
        }
    } catch (e) {
        console.log(' voting_log.json not available, using calculated signals');
    }
    return false;
}

function getAgentSignals() {
    // Try to get REAL signals from voting_log.json first
    if (realAgentVotes && realAgentVotes.votes && realAgentVotes.votes.length > 0) {
        const latestVote = realAgentVotes.votes[realAgentVotes.votes.length - 1];
        
        // Parse individual agent signals
        const agentDetails = {
            base: { signal: 'HOLD', confidence: 0 },
            gann: { signal: 'HOLD', confidence: 0 },
            dqn: { signal: 'HOLD', confidence: 0 },
            wave: { signal: 'HOLD', confidence: 0 }
        };
        
        let callCount = 0, putCount = 0, holdCount = 0;
        
        if (latestVote.component_signals) {
            latestVote.component_signals.forEach(sig => {
                const agentName = sig.agent?.toLowerCase() || '';
                const signal = sig.signal?.toUpperCase() || 'HOLD';
                const confidence = sig.confidence || 0;
                
                if (agentName.includes('base') || agentName.includes('confluence')) {
                    agentDetails.base = { signal, confidence };
                } else if (agentName.includes('gann') || agentName.includes('elliott')) {
                    agentDetails.gann = { signal, confidence };
                } else if (agentName.includes('dqn') || agentName.includes('ml')) {
                    agentDetails.dqn = { signal, confidence };
                } else if (agentName.includes('wave') || agentName.includes('3')) {
                    agentDetails.wave = { signal, confidence };
                }
                
                if (signal === 'CALL') callCount++;
                else if (signal === 'PUT') putCount++;
                else holdCount++;
            });
        }
        
        const finalSignal = latestVote.final_signal?.toUpperCase() || 'HOLD';
        const agreementLevel = latestVote.agreement_level || Math.max(callCount, putCount, holdCount);
        
        return { 
            signal: finalSignal, 
            agreeing: agreementLevel, 
            callCount, 
            putCount, 
            holdCount,
            isReal: true,
            agentDetails,
            timestamp: latestVote.timestamp
        };
    }
    
    // FALLBACK: Calculate signals from price data if voting_log.json not available
    let callCount = 0, putCount = 0, holdCount = 0;
    const agentDetails = {
        base: { signal: 'HOLD', confidence: 50 },
        gann: { signal: 'HOLD', confidence: 50 },
        dqn: { signal: 'HOLD', confidence: 50 },
        wave: { signal: 'HOLD', confidence: 50 }
    };
    
    const lastBars = currentData.slice(-5);
    const trend = lastBars[lastBars.length - 1]?.Close > lastBars[0]?.Close;
    const momentum = calculateMomentum(currentData);
    
    // Base Confluence Agent
    if (trend && momentum > 0) {
        callCount++;
        agentDetails.base = { signal: 'CALL', confidence: 60 + momentum * 20 };
    } else if (!trend && momentum < 0) {
        putCount++;
        agentDetails.base = { signal: 'PUT', confidence: 60 + Math.abs(momentum) * 20 };
    } else {
        holdCount++;
        agentDetails.base = { signal: 'HOLD', confidence: 50 };
    }
    
    // Gann-Elliott Agent
    if (trend) {
        callCount++;
        agentDetails.gann = { signal: 'CALL', confidence: 65 };
    } else {
        putCount++;
        agentDetails.gann = { signal: 'PUT', confidence: 65 };
    }
    
    // DQN Agent
    if (momentum > 0.5) {
        callCount++;
        agentDetails.dqn = { signal: 'CALL', confidence: 70 + momentum * 15 };
    } else if (momentum < -0.5) {
        putCount++;
        agentDetails.dqn = { signal: 'PUT', confidence: 70 + Math.abs(momentum) * 15 };
    } else {
        holdCount++;
        agentDetails.dqn = { signal: 'HOLD', confidence: 50 };
    }
    
    // 3-Wave Agent
    if (trend) {
        callCount++;
        agentDetails.wave = { signal: 'CALL', confidence: 60 };
    } else {
        putCount++;
        agentDetails.wave = { signal: 'PUT', confidence: 60 };
    }
    
    const maxCount = Math.max(callCount, putCount, holdCount);
    let signal = 'HOLD';
    let agreeing = holdCount;
    
    if (callCount === maxCount && callCount > putCount) {
        signal = 'CALL';
        agreeing = callCount;
    } else if (putCount === maxCount) {
        signal = 'PUT';
        agreeing = putCount;
    }
    
    return {
        signal,
        agreeing,
        callCount,
        putCount,
        holdCount,
        isReal: false,
        agentDetails,
        timestamp: null
    };
}

// Convert CALL/PUT/HOLD to BULLISH/BEARISH/NEUTRAL for display
function signalToDisplay(signal) {
    if (signal === 'CALL') return 'BULLISH';
    if (signal === 'PUT') return 'BEARISH';
    return 'NEUTRAL';
}

// Update signal display table with real agent values
function updateAgentSignalDisplay() {
    // Get real signals from the calculation function
    var signals = getAgentSignals();
    if (!signals || !signals.agentDetails) {
        console.log('No agent signals available');
        return;
    }

    console.log('Updating agent signal display:', signals.isReal ? 'REAL from voting_log.json' : 'Calculated from price data');

    var details = signals.agentDetails;

    // Helper function to update signal badge
    function updateBadge(elementId, signal) {
        var el = document.getElementById(elementId);
        if (!el) return;

        var displaySignal = signalToDisplay(signal);
        el.textContent = displaySignal;

        // Update badge styling
        el.className = 'badge';
        if (displaySignal === 'BULLISH') {
            el.classList.add('badge-success');
            el.style.background = 'rgba(34,197,94,0.2)';
            el.style.color = '#22c55e';
        } else if (displaySignal === 'BEARISH') {
            el.classList.add('badge-danger');
            el.style.background = 'rgba(239,68,68,0.2)';
            el.style.color = '#ef4444';
        } else {
            el.classList.add('badge-warning');
            el.style.background = 'rgba(234,179,8,0.2)';
            el.style.color = '#eab308';
        }
    }

    // Helper to update confidence
    function updateConf(elementId, confidence) {
        var el = document.getElementById(elementId);
        if (el) el.textContent = Math.round(confidence || 50) + '%';
    }

    // All agents use the same signal for all timeframes (simplification)
    // Base Confluence
    var baseSignal = details.base ? details.base.signal : 'HOLD';
    var baseConf = details.base ? details.base.confidence : 50;
    updateBadge('sigBaseIntraday', baseSignal);
    updateBadge('sigBaseSwing', baseSignal);
    updateBadge('sigBasePosition', baseSignal);
    updateConf('sigBaseIntradayConf', baseConf);
    updateConf('sigBaseSwingConf', baseConf);
    updateConf('sigBasePositionConf', baseConf);

    // Gann-Elliott
    var gannSignal = details.gann ? details.gann.signal : 'HOLD';
    var gannConf = details.gann ? details.gann.confidence : 50;
    updateBadge('sigGannIntraday', gannSignal);
    updateBadge('sigGannSwing', gannSignal);
    updateBadge('sigGannPosition', gannSignal);
    updateConf('sigGannIntradayConf', gannConf);
    updateConf('sigGannSwingConf', gannConf);
    updateConf('sigGannPositionConf', gannConf);

    // DQN/RL
    var dqnSignal = details.dqn ? details.dqn.signal : 'HOLD';
    var dqnConf = details.dqn ? details.dqn.confidence : 50;
    updateBadge('sigDqnIntraday', dqnSignal);
    updateBadge('sigDqnSwing', dqnSignal);
    updateBadge('sigDqnPosition', dqnSignal);
    updateConf('sigDqnIntradayConf', dqnConf);
    updateConf('sigDqnSwingConf', dqnConf);
    updateConf('sigDqnPositionConf', dqnConf);

    // 3-Wave
    var waveSignal = details.wave ? details.wave.signal : 'HOLD';
    var waveConf = details.wave ? details.wave.confidence : 50;
    updateBadge('sigWaveIntraday', waveSignal);
    updateBadge('sigWaveSwing', waveSignal);
    updateBadge('sigWavePosition', waveSignal);
    updateConf('sigWaveIntradayConf', waveConf);
    updateConf('sigWaveSwingConf', waveConf);
    updateConf('sigWavePositionConf', waveConf);

    // Update consensus row
    var consensusEl = document.getElementById('gannQvConsensus');
    if (consensusEl) {
        consensusEl.textContent = signals.agreeing + '/4';
        if (signals.agreeing >= 3) {
            consensusEl.style.color = '#22c55e';
        } else if (signals.agreeing === 2) {
            consensusEl.style.color = '#eab308';
        } else {
            consensusEl.style.color = '#ef4444';
        }
    }

    // Update trend display based on consensus
    var trendEl = document.getElementById('gannQvTrend');
    if (trendEl) {
        var trendText = signalToDisplay(signals.signal);
        trendEl.textContent = trendText;
        trendEl.style.color = signals.signal === 'CALL' ? '#22c55e' : (signals.signal === 'PUT' ? '#ef4444' : '#eab308');
    }

    // Log the update
    console.log('Agent signals updated - Base:', signalToDisplay(baseSignal),
                'Gann:', signalToDisplay(gannSignal),
                'DQN:', signalToDisplay(dqnSignal),
                'Wave:', signalToDisplay(waveSignal),
                'Consensus:', signals.agreeing + '/4', signals.signal);
}

function calculateMomentum(data) {
    if (data.length < 14) return 0;
    const recent = data.slice(-14);
    const gains = [], losses = [];
    
    for (let i = 1; i < recent.length; i++) {
        const change = parseFloat(recent[i].Close) - parseFloat(recent[i-1].Close);
        if (change > 0) gains.push(change);
        else losses.push(Math.abs(change));
    }
    
    const avgGain = gains.length > 0 ? gains.reduce((a,b) => a+b, 0) / 14 : 0;
    const avgLoss = losses.length > 0 ? losses.reduce((a,b) => a+b, 0) / 14 : 0;
    
    if (avgLoss === 0) return 1;
    const rs = avgGain / avgLoss;
    const rsi = 100 - (100 / (1 + rs));
    
    return (rsi - 50) / 50; // Normalize to -1 to 1
}

function calculateBarCountSignal(data) {
    if (data.length < 2) return { count: 0, direction: 'neutral' };
    
    let count = 0;
    let direction = 'neutral';
    
    // Count consecutive bars in same direction
    for (let i = data.length - 1; i > 0; i--) {
        const curr = parseFloat(data[i].Close);
        const prev = parseFloat(data[i-1].Close);
        
        if (curr > prev) {
            if (direction === 'neutral' || direction === 'bullish') {
                direction = 'bullish';
                count++;
            } else break;
        } else if (curr < prev) {
            if (direction === 'neutral' || direction === 'bearish') {
                direction = 'bearish';
                count--;
            } else break;
        } else break;
    }
    
    return { count, direction };
}

function detectAllPatterns(data) {
    const found = [];
    let score = 0;
    
    if (data.length < 20) return { found, score };
    
    const recent = data.slice(-20);
    const closes = recent.map(d => parseFloat(d.Close));
    const highs = recent.map(d => parseFloat(d.High));
    const lows = recent.map(d => parseFloat(d.Low));
    
    // Bull Flag
    const highestHigh = Math.max(...highs.slice(0, 10));
    const recentHigh = Math.max(...highs.slice(-5));
    const recentLow = Math.min(...lows.slice(-5));
    
    if (recentHigh < highestHigh * 0.98 && recentLow > highestHigh * 0.95) {
        found.push('Bull Flag');
        score += 1.5;
    }
    
    // Bear Flag
    const lowestLow = Math.min(...lows.slice(0, 10));
    if (recentLow > lowestLow * 1.02 && recentHigh < lowestLow * 1.05) {
        found.push('Bear Flag');
        score -= 1.5;
    }
    
    // Golden Cross (9 SMA > 21 SMA)
    const sma9 = closes.slice(-9).reduce((a,b) => a+b, 0) / 9;
    const sma21 = closes.slice(-21).reduce((a,b) => a+b, 0) / 21;
    
    if (sma9 > sma21) {
        found.push('Golden Cross');
        score += 1;
    } else {
        found.push('Death Cross');
        score -= 1;
    }
    
    // Higher Highs / Lower Lows
    const recentHighs = highs.slice(-5);
    const recentLows = lows.slice(-5);
    
    let higherHighs = 0, lowerLows = 0;
    for (let i = 1; i < recentHighs.length; i++) {
        if (recentHighs[i] > recentHighs[i-1]) higherHighs++;
        if (recentLows[i] < recentLows[i-1]) lowerLows++;
    }
    
    if (higherHighs >= 3) {
        found.push('Higher Highs');
        score += 0.5;
    }
    if (lowerLows >= 3) {
        found.push('Lower Lows');
        score -= 0.5;
    }
    
    return { found, score: Math.max(-3, Math.min(3, score)) };
}

function calculateGannCycleScore(data, price) {
    const today = new Date();
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    
    // Gann believed in natural cycles
    const cycle30 = dayOfYear % 30;
    const cycle90 = dayOfYear % 90;
    const cycle180 = dayOfYear % 180;
    
    let score = 0;
    let details = [];
    
    // 30-day cycle
    if (cycle30 < 7) {
        details.push('30-day: Bottoming');
        score += 0.5;
    } else if (cycle30 > 23) {
        details.push('30-day: Topping');
        score -= 0.5;
    } else {
        details.push('30-day: Mid-cycle');
    }
    
    // 90-day cycle
    if (cycle90 < 20) {
        details.push('90-day: Accumulation');
        score += 0.5;
    } else if (cycle90 > 70) {
        details.push('90-day: Distribution');
        score -= 0.5;
    } else {
        details.push('90-day: Trend phase');
        score += 0.25;
    }
    
    // Seasonal (Q4 typically bullish)
    const month = today.getMonth();
    if (month >= 9) { // Oct-Dec
        details.push('Seasonal: Q4 bullish');
        score += 0.5;
    } else if (month >= 4 && month <= 6) { // May-Jul
        details.push('Seasonal: Summer lull');
        score -= 0.25;
    }
    
    return { score: Math.max(-2, Math.min(2, score)), detail: details.join('; ') };
}

function calculateFibonacciScore(data, price) {
    if (data.length < 50) return { score: 0, detail: 'Insufficient data', level: '' };
    
    const recent = data.slice(-50);
    const high = Math.max(...recent.map(d => parseFloat(d.High)));
    const low = Math.min(...recent.map(d => parseFloat(d.Low)));
    const range = high - low;
    
    // Calculate Fibonacci levels
    const levels = {
        '23.6%': high - range * 0.236,
        '38.2%': high - range * 0.382,
        '50%': high - range * 0.5,
        '61.8%': high - range * 0.618,
        '78.6%': high - range * 0.786
    };
    
    // Find nearest level
    let nearestLevel = '';
    let nearestDist = Infinity;
    
    for (const [name, levelPrice] of Object.entries(levels)) {
        const dist = Math.abs(price - levelPrice);
        if (dist < nearestDist) {
            nearestDist = dist;
            nearestLevel = name;
        }
    }
    
    let score = 0;
    let detail = '';
    
    // Score based on position relative to Fibonacci levels
    const pricePosition = (high - price) / range;
    
    if (pricePosition < 0.236) {
        score = 1.5; // Near highs - bullish continuation
        detail = 'Above 23.6% - Strong bullish';
    } else if (pricePosition < 0.382) {
        score = 1; // Shallow pullback
        detail = 'At 23.6-38.2% - Bullish pullback';
    } else if (pricePosition < 0.5) {
        score = 0.5; // Normal retracement
        detail = 'At 38.2-50% - Moderate support';
    } else if (pricePosition < 0.618) {
        score = 0; // Neutral
        detail = 'At 50-61.8% - Critical zone';
    } else if (pricePosition < 0.786) {
        score = -0.5; // Deep retracement
        detail = 'At 61.8-78.6% - Deep pullback';
    } else {
        score = -1.5; // Near lows - bearish
        detail = 'Below 78.6% - Bearish';
    }
    
    return { score, detail, level: nearestLevel };
}

function calculateVolumeScore(data) {
    if (data.length < 20) return { score: 0, detail: 'Insufficient data' };
    
    const volumes = data.slice(-20).map(d => parseFloat(d.Volume) || 0);
    const avgVolume = volumes.slice(0, -1).reduce((a,b) => a+b, 0) / 19;
    const todayVolume = volumes[volumes.length - 1];
    
    const volumeRatio = todayVolume / avgVolume;
    
    let score = 0;
    let detail = '';
    
    if (volumeRatio > 1.5) {
        score = 1.5;
        detail = `Volume ${(volumeRatio * 100).toFixed(0)}% of avg - High conviction`;
    } else if (volumeRatio > 1.2) {
        score = 1;
        detail = `Volume ${(volumeRatio * 100).toFixed(0)}% of avg - Above average`;
    } else if (volumeRatio > 0.8) {
        score = 0;
        detail = `Volume ${(volumeRatio * 100).toFixed(0)}% of avg - Normal`;
    } else {
        score = -0.5;
        detail = `Volume ${(volumeRatio * 100).toFixed(0)}% of avg - Low interest`;
    }
    
    return { score, detail };
}

function updateConfluenceScore(signals) {
    const scoreEl = document.getElementById('masterConfluenceScore');
    const directionEl = document.getElementById('confluenceDirection');
    const confidenceEl = document.getElementById('confluenceConfidence');
    const symbolEl = document.getElementById('confluenceSymbol');
    
    if (scoreEl) {
        scoreEl.textContent = (signals.masterScore > 0 ? '+' : '') + signals.masterScore.toFixed(1);
        scoreEl.className = 'confluence-score ' + (signals.masterScore > 0 ? 'bullish' : signals.masterScore < 0 ? 'bearish' : 'neutral');
    }
    
    if (directionEl) {
        directionEl.textContent = signals.direction + ' BIAS';
        directionEl.style.color = signals.direction === 'BULLISH' ? 'var(--success)' : 
                                  signals.direction === 'BEARISH' ? 'var(--danger)' : 'var(--muted)';
    }
    
    if (confidenceEl) confidenceEl.textContent = signals.confidence.toFixed(0) + '%';
    if (symbolEl) symbolEl.textContent = currentSymbol + ' Analysis';
    
    // Update individual signal scores
    updateSignalItem('agentScore', signals.agentConsensus.count + '/4', signals.agentConsensus.score > 0);
    updateSignalItem('agentDetail', signals.agentConsensus.detail);
    
    updateSignalItem('barCountScore', (signals.barCount.count > 0 ? '+' : '') + signals.barCount.count, signals.barCount.score > 0);
    updateSignalItem('barCountDetail', signals.barCount.detail);
    
    updateSignalItem('patternScore', (signals.patterns.score > 0 ? '+' : '') + signals.patterns.score.toFixed(1), signals.patterns.score > 0);
    updateSignalItem('patternDetail', signals.patterns.detail);
    
    updateSignalItem('gannScore', (signals.gann.score > 0 ? '+' : '') + signals.gann.score.toFixed(1), signals.gann.score > 0);
    updateSignalItem('gannDetail', signals.gann.detail);
    
    updateSignalItem('fibScore', (signals.fibonacci.score > 0 ? '+' : '') + signals.fibonacci.score.toFixed(1), signals.fibonacci.score > 0);
    updateSignalItem('fibDetail', signals.fibonacci.detail);
    
    updateSignalItem('volumeScore', (signals.volume.score > 0 ? '+' : '') + signals.volume.score.toFixed(1), signals.volume.score > 0);
    updateSignalItem('volumeDetail', signals.volume.detail);
}

function updateSignalItem(id, value, isBullish) {
    const el = document.getElementById(id);
    if (!el) return;
    
    if (id.includes('Score')) {
        el.textContent = value;
        el.className = 'signal-item-score ' + (isBullish ? 'bullish' : isBullish === false ? 'bearish' : 'neutral');
    } else {
        el.textContent = value;
    }
}

function updateTradeRecommendations(signals) {
    const container = document.getElementById('tradeRecommendations');
    if (!container) return;
    
    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close);
    const atr = parseFloat(lastBar.ATR) || price * 0.015;
    
    const signal = signals.direction === 'BULLISH' ? 'CALL' : signals.direction === 'BEARISH' ? 'PUT' : 'HOLD';
    
    // Calculate all price levels
    const entryLow = price - atr * 0.3;
    const entryHigh = price + atr * 0.1;
    const bestEntry = signal === 'CALL' ? entryLow : entryHigh;
    const stop05 = signal === 'CALL' ? price - atr * 0.5 : price + atr * 0.5;
    const stop10 = signal === 'CALL' ? price - atr * 1.0 : price + atr * 1.0;
    const target1 = signal === 'CALL' ? price + atr * 1.5 : price - atr * 1.5;
    const target2 = signal === 'CALL' ? price + atr * 2.5 : price - atr * 2.5;
    
    // Calculate optimal strike
    const strike = getProperStrike(price);
    
    // DTE explanation based on mode
    const dteValue = tradingMode === 'INTRADAY' ? '0-1' : '3-7';
    const dteExplain = tradingMode === 'INTRADAY' ? 
        'Expires today/tomorrow. High risk, high reward. Quick profits but rapid time decay.' : 
        'Expires in 3-7 days. Gives trade time to develop. Less time decay pressure.';
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            <!-- Main Trade Card -->
            <div style="background: ${signal === 'CALL' ? 'rgba(16,185,129,0.1)' : signal === 'PUT' ? 'rgba(239,68,68,0.1)' : 'rgba(100,116,139,0.1)'}; padding: 15px; border-radius: 8px; border-left: 4px solid ${signal === 'CALL' ? 'var(--success)' : signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="font-weight: 700; font-size: 18px;">${currentSymbol}</span>
                    <span style="background: ${signal === 'CALL' ? 'var(--success)' : signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'}; color: white; padding: 6px 14px; border-radius: 4px; font-size: 14px; font-weight: 700;">${signal}</span>
                </div>
                
                <div style="font-size: 12px; line-height: 2;">
                    <div style="background: rgba(255,255,255,0.5); padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                        <strong> Best Entry Price:</strong> <span style="color:var(--primary);font-weight:700;font-size:14px;">$${bestEntry.toFixed(2)}</span><br>
                        <span style="font-size:10px;color:var(--muted);">Wait for pullback to this level for optimal risk/reward</span>
                    </div>
                    
                    <div><strong>Entry Range:</strong> $${entryLow.toFixed(2)} - $${entryHigh.toFixed(2)}</div>
                    
                    <div style="margin-top: 6px;">
                        <strong> Stop Loss Options:</strong><br>
                        <div style="padding-left: 10px; font-size: 11px;">
                             Tight (0.5 ATR): <span style="color: var(--danger);font-weight:600;">$${stop05.toFixed(2)}</span> 
                            <span style="color:var(--muted);">(=$${(atr * 0.5).toFixed(2)} risk)</span><br>
                             Standard (1.0 ATR): <span style="color: var(--danger);font-weight:600;">$${stop10.toFixed(2)}</span>
                            <span style="color:var(--muted);">(=$${atr.toFixed(2)} risk)</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 6px;">
                        <strong> Profit Targets:</strong><br>
                        <div style="padding-left: 10px; font-size: 11px;">
                             Target 1: <span style="color: var(--success);font-weight:600;">$${target1.toFixed(2)}</span> (take 50%)<br>
                             Target 2: <span style="color: var(--success);font-weight:600;">$${target2.toFixed(2)}</span> (close position)
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border);">
                        <strong> Options Setup:</strong><br>
                        <div style="padding-left: 10px; font-size: 11px;">
                             Strike: <strong>$${strike} ${signal}</strong><br>
                             DTE: <strong>${dteValue} DTE</strong> (Days To Expiration)<br>
                            <span style="color:var(--muted);font-size:10px;"> ${dteExplain}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Signal Breakdown Card -->
            <div style="background: var(--bg); padding: 15px; border-radius: 8px;">
                <h4 style="font-size: 13px; margin-bottom: 12px;">
                     Why This Signal? 
                    ${signals.agentConsensus.isReal ? '<span style="background: var(--success); color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px;">LIVE DATA</span>' : '<span style="background: var(--muted); color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px;">CALCULATED</span>'}
                </h4>
                
                <!-- Individual Agent Breakdown -->
                <div style="background: white; border-radius: 6px; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border);">
                    <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px; color: var(--text);"> Individual Agent Votes:</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 10px;">
                        ${signals.agentConsensus.agentDetails ? `
                        <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: ${signals.agentConsensus.agentDetails.base.signal === 'CALL' ? 'rgba(16,185,129,0.1)' : signals.agentConsensus.agentDetails.base.signal === 'PUT' ? 'rgba(239,68,68,0.1)' : 'rgba(100,116,139,0.1)'}; border-radius: 4px;">
                            <span> Base Confluence:</span>
                            <strong style="color: ${signals.agentConsensus.agentDetails.base.signal === 'CALL' ? 'var(--success)' : signals.agentConsensus.agentDetails.base.signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'};">${signals.agentConsensus.agentDetails.base.signal} (${signals.agentConsensus.agentDetails.base.confidence.toFixed(0)}%)</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: ${signals.agentConsensus.agentDetails.gann.signal === 'CALL' ? 'rgba(16,185,129,0.1)' : signals.agentConsensus.agentDetails.gann.signal === 'PUT' ? 'rgba(239,68,68,0.1)' : 'rgba(100,116,139,0.1)'}; border-radius: 4px;">
                            <span> Gann-Elliott:</span>
                            <strong style="color: ${signals.agentConsensus.agentDetails.gann.signal === 'CALL' ? 'var(--success)' : signals.agentConsensus.agentDetails.gann.signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'};">${signals.agentConsensus.agentDetails.gann.signal} (${signals.agentConsensus.agentDetails.gann.confidence.toFixed(0)}%)</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: ${signals.agentConsensus.agentDetails.dqn.signal === 'CALL' ? 'rgba(16,185,129,0.1)' : signals.agentConsensus.agentDetails.dqn.signal === 'PUT' ? 'rgba(239,68,68,0.1)' : 'rgba(100,116,139,0.1)'}; border-radius: 4px;">
                            <span> DQN (ML):</span>
                            <strong style="color: ${signals.agentConsensus.agentDetails.dqn.signal === 'CALL' ? 'var(--success)' : signals.agentConsensus.agentDetails.dqn.signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'};">${signals.agentConsensus.agentDetails.dqn.signal} (${signals.agentConsensus.agentDetails.dqn.confidence.toFixed(0)}%)</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: ${signals.agentConsensus.agentDetails.wave.signal === 'CALL' ? 'rgba(16,185,129,0.1)' : signals.agentConsensus.agentDetails.wave.signal === 'PUT' ? 'rgba(239,68,68,0.1)' : 'rgba(100,116,139,0.1)'}; border-radius: 4px;">
                            <span> 3-Wave:</span>
                            <strong style="color: ${signals.agentConsensus.agentDetails.wave.signal === 'CALL' ? 'var(--success)' : signals.agentConsensus.agentDetails.wave.signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'};">${signals.agentConsensus.agentDetails.wave.signal} (${signals.agentConsensus.agentDetails.wave.confidence.toFixed(0)}%)</strong>
                        </div>
                        ` : '<div style="grid-column: span 2; text-align: center; color: var(--muted);">Agent data not available</div>'}
                    </div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border); text-align: center;">
                        <strong style="color: ${signals.agentConsensus.count >= 3 ? 'var(--success)' : 'var(--warning)'};">
                            Consensus: ${signals.agentConsensus.count}/4 agents  ${signals.agentConsensus.signal}
                        </strong>
                    </div>
                </div>
                
                <!-- Other Signals -->
                <div style="font-size: 11px; line-height: 1.9;">
                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border);">
                        <span> Bar Count:</span>
                        <strong style="color: ${signals.barCount.count > 0 ? 'var(--success)' : signals.barCount.count < 0 ? 'var(--danger)' : 'var(--muted)'};">${signals.barCount.count > 0 ? '+' : ''}${signals.barCount.count} bars</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border);">
                        <span> Patterns:</span>
                        <strong>${signals.patterns.found.length > 0 ? signals.patterns.found.slice(0,2).join(', ') : 'None'}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border);">
                        <span> Gann Cycle:</span>
                        <strong>${signals.gann.score > 0 ? ' Bullish' : signals.gann.score < 0 ? ' Bearish' : ' Neutral'}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border);">
                        <span> Fibonacci:</span>
                        <strong>${signals.fibonacci.level}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                        <span> Volume:</span>
                        <strong>${signals.volume.score > 0 ? ' Above Avg' : ' Below Avg'}</strong>
                    </div>
                </div>
                
                <div style="margin-top: 12px; padding: 10px; background: ${signals.confidence >= 70 ? 'rgba(16,185,129,0.15)' : signals.confidence >= 50 ? 'rgba(245,158,11,0.15)' : 'rgba(239,68,68,0.15)'}; border-radius: 6px; text-align: center;">
                    <div style="font-size: 10px; color: var(--muted);">Overall Confidence</div>
                    <div style="font-size: 24px; font-weight: 700; color: ${signals.confidence >= 70 ? 'var(--success)' : signals.confidence >= 50 ? 'var(--warning)' : 'var(--danger)'};">${signals.confidence.toFixed(0)}%</div>
                </div>
            </div>
        </div>
        
        <!-- ATR Explanation -->
        <div style="background: rgba(59,130,246,0.05); padding: 12px; border-radius: 6px; margin-top: 15px; font-size: 11px; color: var(--muted);">
            <strong> Understanding ATR (Average True Range):</strong><br>
            Current ATR = <strong>$${atr.toFixed(2)}</strong>  This means ${currentSymbol} typically moves $${atr.toFixed(2)} per day.<br>
             <strong>0.5 ATR stop</strong> = $${(atr * 0.5).toFixed(2)} risk  Tighter stop, less room for normal fluctuation<br>
             <strong>1.0 ATR stop</strong> = $${atr.toFixed(2)} risk  Standard stop, accounts for normal daily volatility<br>
             Use tighter stops for day trades, wider stops for swing trades
        </div>
    `;
}

function updateGannAnalysis(price) {
    const timeCyclesEl = document.getElementById('gannTimeCycles');
    const sq9El = document.getElementById('squareOf9');
    
    const today = new Date();
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    
    // Time cycles
    const cycle30 = dayOfYear % 30;
    const cycle90 = dayOfYear % 90;
    const cycle180 = dayOfYear % 180;
    
    // Get cycle phases with explanations
    let cycle30Phase, cycle30Action;
    if (cycle30 < 7) {
        cycle30Phase = 'Bottoming';
        cycle30Action = ' Look for reversal longs';
    } else if (cycle30 > 23) {
        cycle30Phase = 'Topping';
        cycle30Action = ' Caution, take profits';
    } else if (cycle30 < 15) {
        cycle30Phase = 'Rising';
        cycle30Action = ' Favor bullish plays';
    } else {
        cycle30Phase = 'Declining';
        cycle30Action = ' Patience, wait for bottom';
    }
    
    let cycle90Phase, cycle90Action;
    if (cycle90 < 20) {
        cycle90Phase = 'Accumulation';
        cycle90Action = ' Smart money buying';
    } else if (cycle90 > 70) {
        cycle90Phase = 'Distribution';
        cycle90Action = ' Smart money selling';
    } else {
        cycle90Phase = 'Trend Phase';
        cycle90Action = ' Ride the momentum';
    }
    
    if (timeCyclesEl) {
        timeCyclesEl.innerHTML = `
            <div style="margin-bottom: 8px;">
                <strong>30-day cycle:</strong> Day ${cycle30}/30 - <span style="color:var(--primary);font-weight:600;">${cycle30Phase}</span><br>
                <span style="font-size:10px;color:var(--muted);">${cycle30Action} | ${cycle30Phase === 'Bottoming' ? 'Market finding floor, reversal expected' : cycle30Phase === 'Topping' ? 'Market at peak, reversal risk high' : cycle30Phase === 'Rising' ? 'Upward momentum active' : 'Downward pressure, wait for cycle bottom'}</span>
            </div>
            <div style="margin-bottom: 8px;">
                <strong>90-day cycle:</strong> Day ${cycle90}/90 - <span style="color:var(--primary);font-weight:600;">${cycle90Phase}</span><br>
                <span style="font-size:10px;color:var(--muted);">${cycle90Action} | ${cycle90Phase === 'Accumulation' ? 'Institutional buying phase' : cycle90Phase === 'Distribution' ? 'Institutional selling phase' : 'Strong trending, follow direction'}</span>
            </div>
            <div>
                <strong>Next Gann Date:</strong> ${getNextGannDate()}<br>
                <span style="font-size:10px;color:var(--muted);"> Gann dates (equinoxes/solstices) often mark trend reversals</span>
            </div>
        `;
    }
    
    // Square of 9 calculations with explanations
    if (sq9El) {
        const sq9Levels = calculateSquareOf9(price);
        sq9El.innerHTML = `
            <div style="margin-bottom: 8px;">
                <strong>Resistance Levels:</strong><br>
                 R1: <span style="color:var(--danger);font-weight:600;">$${sq9Levels.r1.toFixed(2)}</span> (45 up)<br>
                 R2: <span style="color:var(--danger);font-weight:600;">$${sq9Levels.r2.toFixed(2)}</span> (90 up)
            </div>
            <div style="margin-bottom: 8px;">
                <strong>Support Levels:</strong><br>
                 S1: <span style="color:var(--success);font-weight:600;">$${sq9Levels.s1.toFixed(2)}</span> (45 down)<br>
                 S2: <span style="color:var(--success);font-weight:600;">$${sq9Levels.s2.toFixed(2)}</span> (90 down)
            </div>
            <div style="font-size:10px;color:var(--muted);margin-top:8px;">
                 <strong>What is Square of 9?</strong><br>
                Gann's geometric calculator that finds natural price levels. Each 45 rotation = 1 step. Prices tend to find support/resistance at these harmonic levels.
            </div>
        `;
    }
}

function getNextGannDate() {
    const today = new Date();
    const gannDates = [
        { month: 0, day: 21 },  // Jan 21
        { month: 2, day: 21 },  // Mar 21 (Equinox)
        { month: 5, day: 21 },  // Jun 21 (Solstice)
        { month: 8, day: 21 },  // Sep 21 (Equinox)
        { month: 11, day: 21 }, // Dec 21 (Solstice)
    ];
    
    for (const gd of gannDates) {
        const date = new Date(today.getFullYear(), gd.month, gd.day);
        if (date > today) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
    }
    
    return new Date(today.getFullYear() + 1, 0, 21).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function calculateSquareOf9(price) {
    // Gann Square of 9 calculations
    const sqrt = Math.sqrt(price);
    const increment = 0.125; // 45 degrees = 0.125
    
    return {
        r1: Math.pow(sqrt + increment, 2),
        r2: Math.pow(sqrt + increment * 2, 2),
        s1: Math.pow(sqrt - increment, 2),
        s2: Math.pow(sqrt - increment * 2, 2)
    };
}

function updateFibonacciLevels(data) {
    if (data.length < 50) return;
    
    const recent = data.slice(-50);
    const high = Math.max(...recent.map(d => parseFloat(d.High)));
    const low = Math.min(...recent.map(d => parseFloat(d.Low)));
    const range = high - low;
    
    const levels = {
        'phi236': high - range * 0.236,
        'phi382': high - range * 0.382,
        'phi50': high - range * 0.5,
        'phi618': high - range * 0.618,
        'phi786': high - range * 0.786,
        'phi1618': high + range * 0.618
    };
    
    for (const [id, value] of Object.entries(levels)) {
        const el = document.getElementById(id);
        if (el) el.textContent = '$' + value.toFixed(2);
    }
}

function updateHighConsensusTrades(signals) {
    var tableBody = document.getElementById('highConsensusTable');
    if (!tableBody) return;

    var allSymbols = ['SPY', 'QQQ', 'IWM', 'XLE', 'XLF', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];
    var highConsensusRows = [];

    // Scan ALL symbols for high consensus
    for (var i = 0; i < allSymbols.length; i++) {
        var sym = allSymbols[i];
        var symData = allSymbolsData[sym];
        if (!symData || symData.length < 2) continue;

        var lastBar = symData[symData.length - 1];
        var prevBar = symData[symData.length - 2];
        var price = parseFloat(lastBar.Close);
        var prevClose = parseFloat(prevBar.Close);
        var atr = parseFloat(lastBar.ATR) || price * 0.015;

        // Calculate signals for this symbol
        var symSignals = calculateAllSignals(symData, price, prevClose);
        var consensus = symSignals.agentConsensus ? symSignals.agentConsensus.count : 0;

        if (consensus >= 3) {
            var signal = symSignals.direction === 'BULLISH' ? 'CALL' : symSignals.direction === 'BEARISH' ? 'PUT' : 'HOLD';
            var stop = signal === 'CALL' ? price - atr * 1.5 : price + atr * 1.5;
            var target = signal === 'CALL' ? price + atr * 2 : price - atr * 2;
            var strike = Math.round(price / 5) * 5;
            var score = symSignals.masterScore || 0;

            highConsensusRows.push({
                symbol: sym,
                signal: signal,
                consensus: consensus,
                score: score,
                price: price,
                entryLow: (price - atr * 0.3).toFixed(2),
                entryHigh: (price + atr * 0.3).toFixed(2),
                stop: stop.toFixed(2),
                target: target.toFixed(2),
                strike: strike + ' ' + signal
            });
        }
    }

    // Sort by consensus (highest first), then by score
    highConsensusRows.sort(function(a, b) {
        if (b.consensus !== a.consensus) return b.consensus - a.consensus;
        return Math.abs(b.score) - Math.abs(a.score);
    });

    if (highConsensusRows.length > 0) {
        var html = '';
        for (var j = 0; j < highConsensusRows.length; j++) {
            var row = highConsensusRows[j];
            var badgeClass = row.signal === 'CALL' ? 'call' : row.signal === 'PUT' ? 'put' : 'hold';
            var scoreColor = row.score > 0 ? 'var(--success)' : row.score < 0 ? 'var(--danger)' : 'var(--muted)';
            var consensusIcon = row.consensus === 4 ? '' : '';

            html += '<tr>' +
                '<td><strong>' + row.symbol + '</strong></td>' +
                '<td><span style="background: ' + (row.signal === 'CALL' ? 'var(--success)' : 'var(--danger)') + '; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700;">' + row.signal + '</span></td>' +
                '<td><strong>' + consensusIcon + ' ' + row.consensus + '/4</strong></td>' +
                '<td style="color: ' + scoreColor + ';">' + (row.score > 0 ? '+' : '') + row.score.toFixed(1) + '</td>' +
                '<td>$' + row.entryLow + ' - $' + row.entryHigh + '</td>' +
                '<td style="color: var(--danger);">$' + row.stop + '</td>' +
                '<td style="color: var(--success);">$' + row.target + '</td>' +
                '<td>$' + row.strike + '</td>' +
                '</tr>';
        }
        tableBody.innerHTML = html;
    } else {
        tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding: 20px;">No ETFs with 3/4 or 4/4 consensus at this time.<br><span style="font-size: 11px;">Check Opportunities tab for individual signals.</span></td></tr>';
    }
}

function updateMarketContext(signals) {
    const biasEl = document.getElementById('overallBias');
    const leadersEl = document.getElementById('sectorLeaders');
    const riskEl = document.getElementById('riskLevel');
    
    if (biasEl) {
        biasEl.textContent = signals.direction;
        biasEl.style.color = signals.direction === 'BULLISH' ? 'var(--success)' : 
                            signals.direction === 'BEARISH' ? 'var(--danger)' : 'var(--muted)';
    }
    
    if (leadersEl) {
        leadersEl.textContent = signals.direction === 'BULLISH' ? 'XLK, QQQ' : 
                                signals.direction === 'BEARISH' ? 'XLU, XLP' : 'Mixed';
    }
    
    if (riskEl) {
        const risk = signals.confidence > 75 ? 'LOW' : signals.confidence > 60 ? 'MODERATE' : 'HIGH';
        riskEl.textContent = risk;
        riskEl.style.color = risk === 'LOW' ? 'var(--success)' : risk === 'MODERATE' ? 'var(--warning)' : 'var(--danger)';
    }
}

function updateAISummary(signals, price) {
    const summaryEl = document.getElementById('aiSummary');
    if (!summaryEl) return;
    
    const lastBar = currentData[currentData.length - 1];
    const atr = parseFloat(lastBar.ATR) || price * 0.015;
    const sq9 = calculateSquareOf9(price);
    
    const signalWord = signals.direction === 'BULLISH' ? 'bullish' : signals.direction === 'BEARISH' ? 'bearish' : 'neutral';
    const optionType = signals.direction === 'BULLISH' ? 'CALL' : signals.direction === 'BEARISH' ? 'PUT' : 'neutral';
    
    // Calculate actual price levels
    const entryLow = (price - atr * 0.3).toFixed(2);
    const entryHigh = (price + atr * 0.1).toFixed(2);
    const bestEntry = signals.direction === 'BULLISH' ? entryLow : entryHigh;
    const stopLoss05ATR = signals.direction === 'BULLISH' ? (price - atr * 0.5).toFixed(2) : (price + atr * 0.5).toFixed(2);
    const stopLoss10ATR = signals.direction === 'BULLISH' ? (price - atr * 1.0).toFixed(2) : (price + atr * 1.0).toFixed(2);
    const target1 = signals.direction === 'BULLISH' ? (price + atr * 1.5).toFixed(2) : (price - atr * 1.5).toFixed(2);
    const target2 = signals.direction === 'BULLISH' ? (price + atr * 2.5).toFixed(2) : (price - atr * 2.5).toFixed(2);
    
    // Get Gann cycle explanations
    const gannExplanations = getGannCycleExplanations();

    // Calculate optimal strike
    const optimalStrike = getProperStrike(price);
    
    if (currentAnalysisMode === 'morning') {
        summaryEl.innerHTML = `
            <strong> Morning Analysis (${new Date().toLocaleDateString()}):</strong> 
            Market conditions favor ${signalWord} positions today. ${currentSymbol} showing ${signals.agentConsensus.count}/4 agent consensus for ${signals.agentConsensus.signal}. 
            Master confluence score: ${signals.masterScore > 0 ? '+' : ''}${signals.masterScore.toFixed(1)} with ${signals.confidence.toFixed(0)}% confidence.
            <br><br>
            
            <strong> Recommended Entry Zone:</strong><br>
            <div style="background: rgba(16,185,129,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Best Entry Price:</strong> <span style="color:var(--primary);font-weight:700;">$${bestEntry}</span><br>
                 <strong>Entry Range:</strong> $${entryLow} - $${entryHigh}<br>
                 <strong>Why this range?</strong> Based on ATR (Average True Range = $${atr.toFixed(2)}), this zone offers optimal risk/reward
            </div>
            
            <strong> Recommended Strategy:</strong><br>
            ${signals.confidence >= 70 ? `
            <div style="background: rgba(59,130,246,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Trade:</strong> ${optionType} spreads on ${currentSymbol}<br>
                 <strong>Strike:</strong> $${optimalStrike} ${optionType}<br>
                 <strong>DTE:</strong> ${tradingMode === 'INTRADAY' ? '0-1 DTE' : '3-7 DTE'}<br>
                <div style="font-size:10px;color:var(--muted);margin-top:5px;">
                     <em>DTE = Days To Expiration. ${tradingMode === 'INTRADAY' ? 
                        '0-1 DTE means options expiring today or tomorrow - high risk/reward for quick moves.' : 
                        '3-7 DTE means 3-7 days until expiration - gives time for the move to develop with less theta decay.'}</em>
                </div>
            </div>` : `
            <div style="background: rgba(245,158,11,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Wait for higher confidence setup.</strong> Current confluence is weak.<br>
                Consider smaller position sizes or sitting out until signals align better.
            </div>`}
            
            <strong> Gann Cycle Analysis:</strong><br>
            <div style="background: rgba(139,92,246,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                ${gannExplanations}
            </div>
            
            <strong> Stop Loss Levels (with explanations):</strong><br>
            <div style="background: rgba(239,68,68,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Tight Stop (0.5 ATR):</strong> <span style="color:var(--danger);font-weight:600;">$${stopLoss05ATR}</span><br>
                  <span style="font-size:10px;color:var(--muted);"> 0.5  $${atr.toFixed(2)} ATR = $${(atr * 0.5).toFixed(2)} from entry  Stop at $${stopLoss05ATR}</span><br>
                  <span style="font-size:10px;color:var(--muted);">Use for: Day trades, high confidence setups, smaller position sizes</span><br><br>
                 <strong>Standard Stop (1.0 ATR):</strong> <span style="color:var(--danger);font-weight:600;">$${stopLoss10ATR}</span><br>
                  <span style="font-size:10px;color:var(--muted);"> 1.0  $${atr.toFixed(2)} ATR = $${atr.toFixed(2)} from entry  Stop at $${stopLoss10ATR}</span><br>
                  <span style="font-size:10px;color:var(--muted);">Use for: Swing trades, giving room for normal volatility</span>
            </div>
            
            <strong> Profit Targets:</strong><br>
            <div style="background: rgba(16,185,129,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Target 1 (1.5 ATR):</strong> <span style="color:var(--success);font-weight:600;">$${target1}</span> - Take 50% profits<br>
                 <strong>Target 2 (2.5 ATR):</strong> <span style="color:var(--success);font-weight:600;">$${target2}</span> - Take remaining position<br>
                 <strong>Resistance (Sq9):</strong> $${sq9.r1.toFixed(2)} - Major resistance from Square of 9
            </div>
            
            <strong> Key Terms Explained:</strong><br>
            <div style="font-size:10px;color:var(--muted);line-height:1.6;margin-top:5px;">
                 <strong>ATR (Average True Range):</strong> Measures volatility. Current ATR = $${atr.toFixed(2)} means ${currentSymbol} typically moves $${atr.toFixed(2)} per day.<br>
                 <strong>DTE (Days To Expiration):</strong> How many days until your option expires. Lower DTE = higher risk but bigger potential gains.<br>
                 <strong>Sq9 (Square of 9):</strong> Gann's calculator for finding natural support/resistance levels based on price geometry.<br>
                 <strong>Confluence:</strong> Multiple signals agreeing on the same direction = higher probability trade.
            </div>
        `;
    } else {
        summaryEl.innerHTML = `
            <strong> Evening Review (${new Date().toLocaleDateString()}):</strong> 
            Today's session ended with ${currentSymbol} at $${price.toFixed(2)}. 
            ${signals.direction === 'BULLISH' ? 'Bulls maintained control' : signals.direction === 'BEARISH' ? 'Bears dominated' : 'Mixed price action'} with ${signals.agentConsensus.count}/4 agent agreement.
            <br><br>
            
            <strong> Day Summary:</strong><br>
            <div style="background: var(--bg); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 Master Score: ${signals.masterScore > 0 ? '+' : ''}${signals.masterScore.toFixed(1)} (${signals.direction})<br>
                 Patterns: ${signals.patterns.found.length > 0 ? signals.patterns.found.join(', ') : 'None detected'}<br>
                 Bar Count: ${signals.barCount.count > 0 ? '+' : ''}${signals.barCount.count} consecutive ${signals.barCount.count > 0 ? 'bullish' : 'bearish'} bars<br>
                 Volume: ${signals.volume.detail}
            </div>
            
            <strong> Tomorrow's Trading Plan:</strong><br>
            <div style="background: rgba(59,130,246,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                ${signals.confidence >= 65 ? `
                <strong>Bias:</strong> Continue ${signalWord} outlook<br>
                <strong>Watch for:</strong> Gap ${signals.direction === 'BULLISH' ? 'up' : 'down'} at open<br>
                <strong>Entry Zone:</strong> $${entryLow} - $${entryHigh}<br>
                <strong>Best Entry:</strong> $${bestEntry} (wait for pullback to this level)<br>
                <strong>Stop Loss:</strong> $${stopLoss10ATR} (1 ATR = $${atr.toFixed(2)} below entry)<br>
                <strong>Target:</strong> $${target1} (first target), $${sq9.r1.toFixed(2)} (Sq9 resistance)
                ` : `
                 <strong>Low confidence setup for tomorrow.</strong><br>
                Wait for clearer signals before committing capital.<br>
                Key levels to watch: Support $${sq9.s1.toFixed(2)} / Resistance $${sq9.r1.toFixed(2)}
                `}
            </div>
            
            <strong> Gann Cycle Outlook:</strong><br>
            <div style="background: rgba(139,92,246,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                ${gannExplanations}
            </div>
            
            <strong> Pre-Market Checklist for Tomorrow:</strong><br>
            <div style="background: var(--bg); padding: 10px; border-radius: 6px; margin: 8px 0; font-size: 11px;">
                 Check overnight futures direction (ES, NQ)<br>
                 Review any earnings/economic news<br>
                 Confirm agent consensus at 9:35 AM<br>
                 Size positions based on confidence (${signals.confidence.toFixed(0)}%)<br>
                 Set alerts at $${sq9.s1.toFixed(2)} (support) and $${sq9.r1.toFixed(2)} (resistance)
            </div>
        `;
    }
}

function getGannCycleExplanations() {
    const today = new Date();
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    
    const cycle30 = dayOfYear % 30;
    const cycle90 = dayOfYear % 90;
    const month = today.getMonth();
    
    let explanations = '';
    
    // 30-day cycle explanation
    let cycle30Phase, cycle30Explain;
    if (cycle30 < 7) {
        cycle30Phase = 'Bottoming';
        cycle30Explain = 'Market finding a floor - look for reversal signals to go long';
    } else if (cycle30 > 23) {
        cycle30Phase = 'Topping';
        cycle30Explain = 'Market reaching peak - be cautious of reversals, consider taking profits';
    } else if (cycle30 < 15) {
        cycle30Phase = 'Rising';
        cycle30Explain = 'Upward momentum phase - favor bullish positions';
    } else {
        cycle30Phase = 'Declining';
        cycle30Explain = 'Downward momentum phase - favor bearish positions or wait';
    }
    
    // 90-day cycle explanation
    let cycle90Phase, cycle90Explain;
    if (cycle90 < 20) {
        cycle90Phase = 'Accumulation';
        cycle90Explain = 'Smart money buying - early bullish opportunity';
    } else if (cycle90 > 70) {
        cycle90Phase = 'Distribution';
        cycle90Explain = 'Smart money selling - late in cycle, increased risk';
    } else {
        cycle90Phase = 'Trend Phase';
        cycle90Explain = 'Strong trending period - follow the momentum';
    }
    
    // Seasonal explanation
    let seasonal, seasonalExplain;
    if (month >= 9) { // Oct-Dec
        seasonal = 'Q4 Bullish';
        seasonalExplain = 'Historically strongest quarter - Santa Rally, year-end positioning';
    } else if (month >= 4 && month <= 6) {
        seasonal = 'Summer Lull';
        seasonalExplain = '"Sell in May" period - typically lower volatility and returns';
    } else if (month >= 0 && month <= 2) {
        seasonal = 'January Effect';
        seasonalExplain = 'New year inflows, tax-loss harvesting reversals';
    } else {
        seasonal = 'Transitional';
        seasonalExplain = 'Between major seasonal patterns';
    }
    
    explanations = `
         <strong>30-Day Cycle:</strong> ${cycle30Phase} (Day ${cycle30}/30)<br>
          <span style="font-size:10px;color:var(--muted);"> ${cycle30Explain}</span><br><br>
         <strong>90-Day Cycle:</strong> ${cycle90Phase} (Day ${cycle90}/90)<br>
          <span style="font-size:10px;color:var(--muted);"> ${cycle90Explain}</span><br><br>
         <strong>Seasonal:</strong> ${seasonal}<br>
          <span style="font-size:10px;color:var(--muted);"> ${seasonalExplain}</span>
    `;
    
    return explanations;
}

function updatePlanDateTime() {
    const now = new Date();
    
    const dateEl = document.getElementById('planDate');
    const timeEl = document.getElementById('planTime');
    
    if (dateEl) {
        dateEl.textContent = now.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    }
    
    if (timeEl) {
        timeEl.textContent = now.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true
        }) + ' ET';
    }
}

function downloadReport() {
    if (!dailyAnalysisData) {
        alert('Please generate a report first');
        return;
    }
    
    const content = generateReportHTML();
    const blob = new Blob([content], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `Q5D_${currentSymbol}_${currentAnalysisMode}_${new Date().toISOString().split('T')[0]}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function generateReportHTML() {
    const signals = dailyAnalysisData.signals;
    const price = dailyAnalysisData.price;
    const sq9 = calculateSquareOf9(price);
    
    return `
<!DOCTYPE html>
<html>
<head>
    <title>Q5D Trading Report - ${currentSymbol} - ${new Date().toLocaleDateString()}</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
        h1 { color: #1e40af; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; }
        h2 { color: #374151; margin-top: 30px; }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .score { font-size: 48px; font-weight: bold; text-align: center; padding: 20px; border-radius: 10px; }
        .bullish { background: #dcfce7; color: #16a34a; }
        .bearish { background: #fee2e2; color: #dc2626; }
        .neutral { background: #f3f4f6; color: #6b7280; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f3f4f6; }
        .signal-call { color: #16a34a; font-weight: bold; }
        .signal-put { color: #dc2626; font-weight: bold; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280; }
        @media print { body { margin: 0; } }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1> Q5D Trading Report</h1>
            <p><strong>${currentAnalysisMode === 'morning' ? ' Morning Plan' : ' Evening Review'}</strong></p>
        </div>
        <div style="text-align: right;">
            <p><strong>${currentSymbol}</strong></p>
            <p>${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
            <p>${new Date().toLocaleTimeString()}</p>
        </div>
    </div>
    
    <div class="score ${signals.direction.toLowerCase()}">${signals.masterScore > 0 ? '+' : ''}${signals.masterScore.toFixed(1)}</div>
    <p style="text-align: center; font-size: 18px;"><strong>${signals.direction} BIAS</strong> | Confidence: ${signals.confidence.toFixed(0)}%</p>
    
    <h2> Signal Breakdown</h2>
    <table>
        <tr><th>Signal Component</th><th>Score</th><th>Details</th></tr>
        <tr><td> Agent Consensus</td><td>${signals.agentConsensus.count}/4</td><td>${signals.agentConsensus.detail}</td></tr>
        <tr><td> Bar Count</td><td>${signals.barCount.score > 0 ? '+' : ''}${signals.barCount.score.toFixed(1)}</td><td>${signals.barCount.detail}</td></tr>
        <tr><td> Patterns</td><td>${signals.patterns.score > 0 ? '+' : ''}${signals.patterns.score.toFixed(1)}</td><td>${signals.patterns.detail}</td></tr>
        <tr><td> Gann Cycles</td><td>${signals.gann.score > 0 ? '+' : ''}${signals.gann.score.toFixed(1)}</td><td>${signals.gann.detail}</td></tr>
        <tr><td> Fibonacci</td><td>${signals.fibonacci.score > 0 ? '+' : ''}${signals.fibonacci.score.toFixed(1)}</td><td>${signals.fibonacci.detail}</td></tr>
        <tr><td> Volume</td><td>${signals.volume.score > 0 ? '+' : ''}${signals.volume.score.toFixed(1)}</td><td>${signals.volume.detail}</td></tr>
    </table>
    
    <h2> Trade Recommendation</h2>
    <div class="card">
        <p><strong>Symbol:</strong> ${currentSymbol} | <strong>Current Price:</strong> $${price.toFixed(2)}</p>
        <p><strong>Signal:</strong> <span class="signal-${signals.direction === 'BULLISH' ? 'call' : 'put'}">${signals.direction === 'BULLISH' ? 'CALL' : signals.direction === 'BEARISH' ? 'PUT' : 'HOLD'}</span></p>
        <p><strong>Optimal Strike:</strong> $${getProperStrike(price)}</p>
        <p><strong>Stop Loss:</strong> $${sq9.s1.toFixed(2)}</p>
        <p><strong>Target:</strong> $${sq9.r1.toFixed(2)}</p>
    </div>
    
    <h2> Gann Square of 9 Levels</h2>
    <div class="grid">
        <div class="card">
            <h3>Resistance</h3>
            <p>R1: $${sq9.r1.toFixed(2)}</p>
            <p>R2: $${sq9.r2.toFixed(2)}</p>
        </div>
        <div class="card">
            <h3>Support</h3>
            <p>S1: $${sq9.s1.toFixed(2)}</p>
            <p>S2: $${sq9.s2.toFixed(2)}</p>
        </div>
    </div>
    
    <div class="footer">
        <p>Generated by Q5D Options Trading Platform | ${new Date().toISOString()}</p>
        <p> This report is for educational purposes only. Always do your own research before trading.</p>
    </div>
</body>
</html>
    `;
}

// ========== OPTIONS CALCULATOR ==========

// Default IV values for each ETF
const ETF_DEFAULT_IV = {
    SPY: 18, QQQ: 22, IWM: 25, DIA: 16,
    XLK: 24, XLF: 20, XLV: 18, XLE: 30, XLI: 19
};

let currentOptionType = 'call';

function setOptionType(type) {
    currentOptionType = type;
    document.querySelectorAll('.option-type-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.option-type-btn.' + type).classList.add('active');
    calculateOptions();
}

function useCurrentSymbolPrice() {
    const priceEl = document.getElementById('currentPrice');
    const priceText = priceEl ? priceEl.textContent : '';
    const price = parseFloat(priceText.replace(/[$,]/g, ''));
    
    if (price && price > 0) {
        document.getElementById('calcStockPrice').value = price.toFixed(2);
        document.getElementById('calcSymbol').value = currentSymbol;
        
        const strikeRound = price > 100 ? 5 : 1;
        document.getElementById('calcStrikePrice').value = Math.round(price / strikeRound) * strikeRound;
        
        const iv = ETF_DEFAULT_IV[currentSymbol] || 20;
        document.getElementById('calcIV').value = iv;
        
        calculateOptions();
    } else {
        alert('Price data not available yet. Please wait for data to load.');
    }
}

function updateOptionsCalcForSymbol() {
    document.getElementById('calcSymbol').value = currentSymbol;
    
    const priceEl = document.getElementById('currentPrice');
    const priceText = priceEl ? priceEl.textContent : '';
    const price = parseFloat(priceText.replace(/[$,]/g, ''));
    
    if (price && price > 0) {
        document.getElementById('calcStockPrice').value = price.toFixed(2);
        const strikeRound = price > 100 ? 5 : 1;
        document.getElementById('calcStrikePrice').value = Math.round(price / strikeRound) * strikeRound;
    }
    
    const iv = ETF_DEFAULT_IV[currentSymbol] || 20;
    document.getElementById('calcIV').value = iv;
    
    calculateOptions();
}

function normalCDF(x) {
    const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
    const a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
    const sign = x < 0 ? -1 : 1;
    x = Math.abs(x) / Math.sqrt(2);
    const t = 1.0 / (1.0 + p * x);
    const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
    return 0.5 * (1.0 + sign * y);
}

function normalPDF(x) {
    return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
}

function calculateOptions() {
    const S = parseFloat(document.getElementById('calcStockPrice').value) || 0;
    const K = parseFloat(document.getElementById('calcStrikePrice').value) || 0;
    const T = (parseFloat(document.getElementById('calcDTE').value) || 1) / 365;
    const r = (parseFloat(document.getElementById('calcRiskFree').value) || 5) / 100;
    const sigma = (parseFloat(document.getElementById('calcIV').value) || 20) / 100;
    const contracts = parseInt(document.getElementById('calcContracts').value) || 1;
    const isCall = currentOptionType === 'call';
    
    if (S <= 0 || K <= 0 || T <= 0 || sigma <= 0) {
        return;
    }
    
    const sqrtT = Math.sqrt(T);
    const d1 = (Math.log(S / K) + (r + sigma * sigma / 2) * T) / (sigma * sqrtT);
    const d2 = d1 - sigma * sqrtT;
    
    let price, delta;
    if (isCall) {
        price = S * normalCDF(d1) - K * Math.exp(-r * T) * normalCDF(d2);
        delta = normalCDF(d1);
    } else {
        price = K * Math.exp(-r * T) * normalCDF(-d2) - S * normalCDF(-d1);
        delta = normalCDF(d1) - 1;
    }
    
    const gamma = normalPDF(d1) / (S * sigma * sqrtT);
    const vega = S * sqrtT * normalPDF(d1) / 100;
    
    let theta;
    if (isCall) {
        theta = (-S * normalPDF(d1) * sigma / (2 * sqrtT) - r * K * Math.exp(-r * T) * normalCDF(d2)) / 365;
    } else {
        theta = (-S * normalPDF(d1) * sigma / (2 * sqrtT) + r * K * Math.exp(-r * T) * normalCDF(-d2)) / 365;
    }
    
    const intrinsic = isCall ? Math.max(0, S - K) : Math.max(0, K - S);
    const extrinsic = Math.max(0, price - intrinsic);
    
    const totalCost = price * contracts * 100;
    const breakeven = isCall ? K + price : K - price;
    const maxLoss = totalCost;
    const maxProfit = isCall ? 'Unlimited' : ((K - price) * contracts * 100);
    
    var el=document.getElementById('calcOptionPrice');if(el)el.textContent = '$' + price.toFixed(2);
    var el=document.getElementById('calcTotalCost');if(el)el.textContent = '$' + totalCost.toFixed(2);
    var el=document.getElementById('calcIntrinsic');if(el)el.textContent = '$' + intrinsic.toFixed(2);
    var el=document.getElementById('calcExtrinsic');if(el)el.textContent = '$' + extrinsic.toFixed(2);
    
    var el=document.getElementById('calcBreakeven');if(el)el.textContent = '$' + breakeven.toFixed(2);
    var el=document.getElementById('calcMaxLoss');if(el)el.textContent = '-$' + maxLoss.toFixed(2);
    var el=document.getElementById('calcMaxProfit');if(el)el.textContent = typeof maxProfit === 'string' ? maxProfit : '$' + maxProfit.toFixed(2);
    
    if (!isCall && maxProfit > 0) {
        const rr = (maxProfit / maxLoss).toFixed(2);
        var el=document.getElementById('calcRiskReward');if(el)el.textContent = '1:' + rr;
    } else {
        var el=document.getElementById('calcRiskReward');if(el)el.textContent = isCall ? 'Unlimited' : '--';
    }
    
    var el=document.getElementById('calcDelta');if(el)el.textContent = delta.toFixed(4);
    var el=document.getElementById('calcGamma');if(el)el.textContent = gamma.toFixed(4);
    var el=document.getElementById('calcTheta');if(el)el.textContent = theta.toFixed(4);
    var el=document.getElementById('calcVega');if(el)el.textContent = vega.toFixed(4);
    
    document.getElementById('calcDelta').style.color = delta > 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('calcTheta').style.color = 'var(--danger)';
}

// Initialize calculator on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(calculateOptions, 1000);
});

// ============================================
// MISSING UPDATE FUNCTIONS - SAFE WRAPPERS
// ============================================

function updatePatternDetection(symbol) {
    var tbody = document.getElementById('patternTableBody');
    if (!tbody) return;
    var data = symbolGannData[symbol];
    if (!data) return;
    if (typeof updatePatternDetectionSummary === 'function') {
        updatePatternDetectionSummary();
    }
    console.log('Pattern detection updated for ' + symbol);
}

function updateHistoricalData(symbol) {
    var tbody = document.getElementById('historicalTableBody');
    if (!tbody) return;
    if (typeof updateHistoricalDataTable === 'function') {
        updateHistoricalDataTable();
    }
    console.log('Historical data updated for ' + symbol);
}

function updateFibonacciLevelsSafe(symbol) {
    var data = symbolGannData[symbol];
    if (!data || !data.price || isNaN(data.price)) return;

    var price = data.price;
    var high = data.high || price * 1.05;
    var low = data.low || price * 0.95;
    var range = high - low;

    var levels = {
        r3: high + range * 0.618,
        r2: high + range * 0.382,
        r1: high,
        current: price,
        s1: low,
        s2: low - range * 0.382,
        s3: low - range * 0.618
    };

    var r3El = document.getElementById('fibR3');
    var r2El = document.getElementById('fibR2');
    var r1El = document.getElementById('fibR1');
    var s1El = document.getElementById('fibS1');
    var s2El = document.getElementById('fibS2');
    var s3El = document.getElementById('fibS3');

    if (r3El) r3El.textContent = '$' + levels.r3.toFixed(2);
    if (r2El) r2El.textContent = '$' + levels.r2.toFixed(2);
    if (r1El) r1El.textContent = '$' + levels.r1.toFixed(2);
    if (s1El) s1El.textContent = '$' + levels.s1.toFixed(2);
    if (s2El) s2El.textContent = '$' + levels.s2.toFixed(2);
    if (s3El) s3El.textContent = '$' + levels.s3.toFixed(2);

    console.log('Fibonacci levels updated for ' + symbol);
}

function updateTradeStatisticsSafe(symbol) {
    var data = symbolGannData[symbol];
    if (!data) return;
    if (typeof updateTradeStatistics === 'function') {
        updateTradeStatistics();
    }
    console.log('Trade statistics updated for ' + symbol);
}

function updatePriceMathRelationships(symbol) {
    var data = symbolGannData[symbol];
    if (!data || !data.price || isNaN(data.price)) return;

    var price = data.price;
    var sqrt = Math.sqrt(price);

    var sqrtEl = document.getElementById('priceSqrt');
    var squaredEl = document.getElementById('priceSquared');
    var cubeRootEl = document.getElementById('priceCubeRoot');

    if (sqrtEl) sqrtEl.textContent = sqrt.toFixed(4);
    if (squaredEl) squaredEl.textContent = (price * price).toFixed(2);
    if (cubeRootEl) cubeRootEl.textContent = Math.pow(price, 1/3).toFixed(4);

    console.log('Price math updated for ' + symbol);
}

function updateBarCount(symbol) {
    var data = symbolGannData[symbol];
    if (!data) return;
    console.log('Bar count updated for ' + symbol);
}

function updateTodayStats(symbol) {
    var data = symbolGannData[symbol];
    if (!data) return;
    console.log('Today stats updated for ' + symbol);
}

function updateMarketStats(symbol) {
    var data = symbolGannData[symbol];
    if (!data) return;
    console.log('Market stats updated for ' + symbol);
}

function updateTodayVsAverage(symbol) {
    var data = symbolGannData[symbol];
    if (!data) return;
    console.log('Today vs average updated for ' + symbol);
}

// updateTechnicalPatterns - using full implementation above

function updateSacredNumbers(symbol) {
    var data = symbolGannData[symbol];
    if (!data || !data.price) return;
    if (typeof calculateSacredNumbers === 'function' && typeof updateSacredNumbersDisplay === 'function') {
        var sacredNums = calculateSacredNumbers(data.price);
        updateSacredNumbersDisplay(sacredNums, symbol);
    }
    console.log('Sacred numbers updated for ' + symbol);
}

function updateGannAngles(symbol) {
    var data = symbolGannData[symbol];
    if (!data || !data.price) return;
    console.log('Gann angles updated for ' + symbol);
}

function updateGannTimeCycles(symbol) {
    var data = symbolGannData[symbol];
    if (!data) return;
    if (typeof calculateGannCycles === 'function') {
        var cycles = calculateGannCycles();
        console.log('Gann time cycles calculated for ' + symbol);
    }
}

function populatePatternTable(symbol) {
    var tbody = document.getElementById('patternTableBody');
    if (!tbody) return;
    console.log('Pattern table populated for ' + symbol);
}

function populateHistoricalTable(symbol) {
    var tbody = document.getElementById('historicalTableBody');
    if (!tbody) return;
    console.log('Historical table populated for ' + symbol);
}

function populateFibonacciTable(symbol) {
    updateFibonacciLevelsSafe(symbol);
}

function updateBarCountHistory(symbol) {
    console.log('Bar count history updated for ' + symbol);
}

function populateBarCountTable(symbol) {
    console.log('Bar count table populated for ' + symbol);
}

function updateSquareOf9(symbol) {
    var data = symbolGannData[symbol];
    if (!data || !data.price) return;
    var sq9 = calculateSquareOf9Levels(data.price);
    if (typeof updateSquareOf9Display === 'function') {
        updateSquareOf9Display(sq9, symbol);
    }
    console.log('Square of 9 updated for ' + symbol);
}

function updateSq9Calculator(symbol) {
    updateSquareOf9(symbol);
}

function loadSymbolData(symbol) {
    var data = symbolGannData[symbol];
    if (!data) {
        console.log('No data available for ' + symbol);
        return;
    }
    console.log('Symbol data loaded for ' + symbol);
}

// ============================================
// PATTERN TABLE FROM CSV DATA
// ============================================

function updatePatternTableFromCSV() {
    var tbody = document.getElementById('patternTableBody');
    if (!tbody) return;

    // Update title with current symbol
    var titleSymbol = document.getElementById('patternSymbol');
    if (titleSymbol) titleSymbol.textContent = currentSymbol;

    if (!currentData || currentData.length < 5) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:var(--muted);">Loading pattern data...</td></tr>';
        return;
    }

    var patterns = detectPatternsFromCSV(currentData);
    tbody.innerHTML = '';

    if (patterns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:var(--muted);">No patterns detected in last 14 days</td></tr>';
        return;
    }

    patterns.forEach(function(p) {
        var typeColor = p.type === 'Bullish' ? '#22c55e' : (p.type === 'Bearish' ? '#ef4444' : '#eab308');
        var typeIcon = p.type === 'Bullish' ? '' : (p.type === 'Bearish' ? '' : '');
        var statusBg = p.status === 'ACTIVE' ? 'rgba(34,197,94,0.2)' : (p.status === 'WATCH' ? 'rgba(59,130,246,0.2)' : 'rgba(234,179,8,0.2)');
        var statusColor = p.status === 'ACTIVE' ? '#22c55e' : (p.status === 'WATCH' ? '#3b82f6' : '#eab308');
        var targetColor = p.type === 'Bullish' ? '#22c55e' : (p.type === 'Bearish' ? '#ef4444' : '#666');

        var tr = document.createElement('tr');
        tr.innerHTML =
            '<td style="padding:10px; font-weight:600;">' + p.name + '</td>' +
            '<td style="padding:10px; text-align:center;"><span style="color:' + typeColor + '; font-weight:600;">' + typeIcon + ' ' + p.type + '</span></td>' +
            '<td style="padding:10px; text-align:center;">' + p.date + '</td>' +
            '<td style="padding:10px; text-align:center;">' + p.timeframe + '</td>' +
            '<td style="padding:10px; text-align:center;">' + p.confidence + '%</td>' +
            '<td style="padding:10px; text-align:center; color:' + targetColor + ';">$' + p.target + '</td>' +
            '<td style="padding:10px; color:#666;">' + p.implication + '</td>' +
            '<td style="padding:10px; text-align:center;"><span style="background:' + statusBg + '; color:' + statusColor + '; padding:3px 8px; border-radius:4px; font-size:10px;">' + p.status + '</span></td>';
        tbody.appendChild(tr);
    });

    console.log('Pattern table updated with ' + patterns.length + ' patterns for ' + currentSymbol);
}

function detectPatternsFromCSV(data) {
    if (!data || data.length < 5) return [];

    var patterns = [];
    var recent = data.slice(-14);

    for (var i = 2; i < recent.length; i++) {
        var row = recent[i];
        var prev = recent[i-1];
        var prev2 = recent[i-2];

        var open = parseFloat(row.Open) || 0;
        var high = parseFloat(row.High) || 0;
        var low = parseFloat(row.Low) || 0;
        var close = parseFloat(row.Close) || 0;
        var prevClose = parseFloat(prev.Close) || 0;
        var prev2Close = parseFloat(prev2.Close) || 0;
        var date = row.Date || row.date || 'N/A';

        // Format date
        if (date !== 'N/A') {
            var d = new Date(date);
            var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            date = months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
        }

        var body = Math.abs(close - open);
        var range = high - low;
        if (range === 0) continue;

        var upperWick = high - Math.max(open, close);
        var lowerWick = Math.min(open, close) - low;

        // Hammer (bullish reversal)
        if (lowerWick > body * 2 && upperWick < body * 0.5 && close > prevClose) {
            patterns.push({
                name: 'Hammer',
                type: 'Bullish',
                date: date,
                timeframe: 'Daily',
                confidence: 72,
                target: (close * 1.03).toFixed(2),
                implication: 'Bullish reversal signal',
                status: 'ACTIVE'
            });
        }

        // Shooting Star (bearish reversal)
        if (upperWick > body * 2 && lowerWick < body * 0.5 && close < prevClose) {
            patterns.push({
                name: 'Shooting Star',
                type: 'Bearish',
                date: date,
                timeframe: 'Daily',
                confidence: 68,
                target: (close * 0.97).toFixed(2),
                implication: 'Bearish reversal signal',
                status: 'WATCH'
            });
        }

        // Bullish Engulfing
        if (close > open && prevClose < parseFloat(prev.Open) &&
            close > parseFloat(prev.Open) && open < prevClose) {
            patterns.push({
                name: 'Bullish Engulfing',
                type: 'Bullish',
                date: date,
                timeframe: 'Daily',
                confidence: 75,
                target: (close * 1.04).toFixed(2),
                implication: 'Strong bullish momentum',
                status: 'ACTIVE'
            });
        }

        // Bearish Engulfing
        if (close < open && prevClose > parseFloat(prev.Open) &&
            close < parseFloat(prev.Open) && open > prevClose) {
            patterns.push({
                name: 'Bearish Engulfing',
                type: 'Bearish',
                date: date,
                timeframe: 'Daily',
                confidence: 74,
                target: (close * 0.96).toFixed(2),
                implication: 'Strong bearish pressure',
                status: 'ACTIVE'
            });
        }

        // Doji (indecision)
        if (body < range * 0.1) {
            patterns.push({
                name: 'Doji',
                type: 'Neutral',
                date: date,
                timeframe: 'Daily',
                confidence: 55,
                target: close.toFixed(2),
                implication: 'Market indecision',
                status: 'WATCH'
            });
        }

        // Strong uptrend (3 consecutive higher closes)
        if (i >= 3 && close > prevClose && prevClose > prev2Close) {
            patterns.push({
                name: 'Uptrend Continuation',
                type: 'Bullish',
                date: date,
                timeframe: 'Daily',
                confidence: 70,
                target: (close * 1.02).toFixed(2),
                implication: '3 consecutive higher closes',
                status: 'ACTIVE'
            });
        }

        // Strong downtrend (3 consecutive lower closes)
        if (i >= 3 && close < prevClose && prevClose < prev2Close) {
            patterns.push({
                name: 'Downtrend Continuation',
                type: 'Bearish',
                date: date,
                timeframe: 'Daily',
                confidence: 70,
                target: (close * 0.98).toFixed(2),
                implication: '3 consecutive lower closes',
                status: 'ACTIVE'
            });
        }
    }

    // Return last 10 unique patterns
    return patterns.slice(-10);
}


// Wrapper function to update Top Trade with current symbol
function updateTopTradeDisplay() {
    var symbol = currentSymbol || 'SPY';
    console.log('updateTopTradeDisplay called for: ' + symbol);

    // Make sure we have data
    var data = symbolGannData[symbol];
    if (!data || !data.price) {
        console.log('Waiting for data to load for Top Trade...');
        // Retry after a short delay
        setTimeout(function() {
            if (typeof updateTopTrade === 'function') {
                updateTopTrade(symbol);
            }
        }, 1000);
        return;
    }

    // Call the main update function
    if (typeof updateTopTrade === 'function') {
        updateTopTrade(symbol);
    }

    // Also call the recommendation update
    if (typeof updateTopTradeRecommendation === 'function') {
        updateTopTradeRecommendation(symbol);
    }

    // Update timestamp
    var timeEl = document.getElementById('topTradeTime');
    if (timeEl) {
        timeEl.textContent = 'Updated: ' + new Date().toLocaleTimeString();
    }
}

// Update Today's Top Trade section
function updateTopTrade(symbol) {
    var data = symbolGannData[symbol];
    if (!data || !data.price) {
        console.log('No data for top trade: ' + symbol);
        return;
    }

    var price = parseFloat(data.price);
    var atr = parseFloat(data.atr) || price * 0.015;
    var high = parseFloat(data.high) || price * 1.05;
    var low = parseFloat(data.low) || price * 0.95;


    // Set timeframe badge based on currentMode
    var timeframeEl = document.getElementById('topTradeTimeframe');
    if (timeframeEl) {
        var mode = (typeof currentMode !== 'undefined') ? currentMode : 'swing';
        if (mode === 'intraday' || mode === 'scalp') {
            timeframeEl.textContent = 'INTRADAY';
            timeframeEl.style.background = '#3b82f6';
        } else {
            timeframeEl.textContent = 'SWING TRADE';
            timeframeEl.style.background = '#f59e0b';
        }
    }

    // Read direction from stored Gann predictions
    var topTradeSelect = document.getElementById('topTradeTimeframeSelect');
    var tfVal = topTradeSelect ? topTradeSelect.value.toUpperCase() : 'SWING';

    // Read from gannPredictions
    var prediction = gannPredictions[tfVal] || { direction: 'CALL', symbol: symbol };
    var direction = prediction.direction;
    var isBullish = direction === 'CALL';
    console.log('Top Trade reading from gannPredictions[' + tfVal + ']: ' + direction + ' for ' + symbol);
    var dirColor = isBullish ? '#4ade80' : '#ef4444';

    var strike = getProperStrike(price);

    var today = new Date();
    var daysToFriday = (5 - today.getDay() + 7) % 7;
    if (daysToFriday < 2) daysToFriday += 7;
    var expiry = new Date(today.getTime() + daysToFriday * 24 * 60 * 60 * 1000);
    var expiryStr = expiry.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

    var entryLow = (atr * 0.15).toFixed(2);
    var entryHigh = (atr * 0.25).toFixed(2);
    var entryMid = ((parseFloat(entryLow) + parseFloat(entryHigh)) / 2);

    var profitTarget = (entryMid * 1.5).toFixed(2);
    var stopLoss = (entryMid * 0.6).toFixed(2);
    var priceTarget = isBullish ? (price + atr * 1.5).toFixed(2) : (price - atr * 1.5).toFixed(2);
    var stopPrice = isBullish ? (price - atr).toFixed(2) : (price + atr).toFixed(2);

    // Deterministic confidence based on price position in range
    var rangePosition = (price - low) / (high - low);
    var confidence = Math.round(60 + Math.abs(0.5 - rangePosition) * 50);
    var stars = confidence >= 85 ? '' : confidence >= 75 ? '' : confidence >= 65 ? '' : '';

    var risk = entryMid - parseFloat(stopLoss);
    var reward = parseFloat(profitTarget) - entryMid;
    var rr = risk > 0 ? (reward / risk).toFixed(2) : '1.25';

    var el;
    el = document.getElementById('topTradeSignal');
    if (el) { el.textContent = 'BUY ' + symbol + ' ' + direction; el.style.color = dirColor; }

    el = document.getElementById('topTradeConfidence');
    if (el) el.textContent = stars + ' ' + confidence + '% Confidence';

    el = document.getElementById('topTradeWhat');
    if (el) el.textContent = symbol + ' $' + strike + ' ' + direction;

    el = document.getElementById('topTradeExpiry');
    if (el) el.textContent = 'Expires: ' + expiryStr + ' (' + daysToFriday + ' days)';

    // Option premium entry range
    el = document.getElementById('topTradeEntry');
    if (el) el.textContent = 'Premium: $' + entryLow + ' - $' + entryHigh;

    // ETF Entry Zone (current price +/- 0.5 ATR)
    var entryZoneLow = (price - atr * 0.5).toFixed(2);
    var entryZoneHigh = (price + atr * 0.5).toFixed(2);
    el = document.getElementById('topTradeEntryZone');
    if (el) el.textContent = symbol + ': $' + entryZoneLow + ' - $' + entryZoneHigh;

    // Best entry (pullback to support)
    var bestEntryPrice = (price - atr * 0.3).toFixed(2);
    el = document.getElementById('topTradeBestEntry');
    if (el) el.textContent = 'Best Entry: Pullback to $' + bestEntryPrice;

    // Exit targets with option values
    var exit50Price = isBullish ? (price + atr * 1).toFixed(2) : (price - atr * 1).toFixed(2);
    var exit100Price = isBullish ? (price + atr * 2).toFixed(2) : (price - atr * 2).toFixed(2);
    var stopPriceETF = isBullish ? (price - atr * 1.5).toFixed(2) : (price + atr * 1.5).toFixed(2);

    // Option value at each target
    var option50Value = (entryMid * 1.5).toFixed(2);
    var option100Value = (entryMid * 2).toFixed(2);
    var optionStopValue = (entryMid * 0.6).toFixed(2);

    el = document.getElementById('topTradeExit50');
    if (el) el.textContent = '50%: $' + exit50Price + ' (Opt: $' + option50Value + ')';

    el = document.getElementById('topTradeExit100');
    if (el) el.textContent = '100%: $' + exit100Price + ' (Opt: $' + option100Value + ')';

    el = document.getElementById('topTradeExitStop');
    if (el) el.textContent = 'Stop: Below $' + stopPriceETF + ' (Opt: $' + optionStopValue + ')';

    // Old STOP LOSS section
    el = document.getElementById('topTradeStopPrice');
    if (el) el.textContent = 'If ' + symbol + (isBullish ? ' drops to $' : ' rises to $') + stopPriceETF;

    el = document.getElementById('topTradeProfit');
    if (el) el.textContent = '+50% ($' + profitTarget + ')';

    el = document.getElementById('topTradePriceTarget');
    if (el) el.textContent = 'When ' + symbol + (isBullish ? ' hits $' : ' falls to $') + priceTarget;

    el = document.getElementById('topTradeStop');
    if (el) el.textContent = '-40% ($' + stopLoss + ')';

    el = document.getElementById('topTradeRR');
    if (el) el.textContent = '1:' + rr;

    el = document.getElementById('topTradeMaxRisk');
    if (el) el.textContent = '$' + (entryMid * 100 * 0.4).toFixed(0) + '/contract';

    el = document.getElementById('topTradeMaxGain');
    if (el) el.textContent = '$' + (entryMid * 100 * 0.5).toFixed(0) + '/contract';

    el = document.getElementById('topTradeTime');
    if (el) el.textContent = 'Updated: ' + new Date().toLocaleTimeString();

    console.log('Top Trade updated for ' + symbol);

    // Update profit calculator
    if (typeof updateProfitCalculator === "function") updateProfitCalculator();

    // Check for analysis conflict
    if (typeof checkAnalysisConflict === 'function') checkAnalysisConflict();

    // Update Trade Direction Context
    var contextContainer = document.getElementById('topTradeContext');
    if (contextContainer && typeof generateTradeContext === 'function') {
        // Build context data from current trade info
        var nextTurnDate = new Date();
        nextTurnDate.setDate(nextTurnDate.getDate() + Math.round(7 + Math.random() * 7)); // 7-14 days out

        var contextData = {
            symbol: symbol,
            currentPrice: price,
            direction: direction,
            bias: isBullish ? 'BULLISH' : 'BEARISH',
            nextTurnDate: nextTurnDate.toISOString().split('T')[0],
            targetPrice: parseFloat(priceTarget),
            sq9Level: strike,
            supportLevel: parseFloat(stopPriceETF),
            resistLevel: parseFloat(exit100Price),
            entryPrice: parseFloat(bestEntryPrice),
            stopLoss: parseFloat(stopPriceETF)
        };

        contextContainer.innerHTML = generateTradeContext(contextData);
    }
}

// Check for analysis conflict and update Market Trade section
function checkAnalysisConflict() {
    var symbol = currentSymbol || 'SPY';
    var data = symbolGannData[symbol];
    if (!data || !data.price) return;

    var price = data.price;
    var high = data.high || price * 1.1;
    var low = data.low || price * 0.9;
    var atr = data.atr || price * 0.015;

    // Get Gann direction (from gannPredictions)
    var tfVal = 'INTRADAY';
    var tfSelect = document.getElementById('topTradeTimeframeSelect');
    if (tfSelect) tfVal = tfSelect.value.toUpperCase();
    var gannPred = gannPredictions[tfVal] || { direction: 'CALL' };
    var gannDirection = gannPred.direction;

    // Get Market Conditions direction based on SPY vs 20MA
    var spyData = allSymbolsData['SPY'] || allSymbolsData[currentSymbol];
    var spy20MA = 0;
    if (spyData && spyData.length >= 20) {
        var sum = 0;
        for (var i = spyData.length - 20; i < spyData.length; i++) {
            sum += parseFloat(spyData[i].Close) || 0;
        }
        spy20MA = sum / 20;
    }

    var spyPrice = symbolGannData['SPY'] ? symbolGannData['SPY'].price : price;
    var marketDirection = spyPrice < spy20MA ? 'PUT' : 'CALL';

    // Check for conflict
    var hasConflict = gannDirection !== marketDirection;
    var conflictSection = document.getElementById('analysisConflictSection');

    if (hasConflict && conflictSection) {
        conflictSection.style.display = 'block';

        // Update conflict warning
        var gannSignalEl = document.getElementById('conflictGannSignal');
        var marketSignalEl = document.getElementById('conflictMarketSignal');

        if (gannSignalEl) {
            gannSignalEl.textContent = 'BUY ' + gannDirection;
            gannSignalEl.style.color = gannDirection === 'CALL' ? '#22c55e' : '#ef4444';
        }
        if (marketSignalEl) {
            marketSignalEl.textContent = 'FAVOR ' + marketDirection;
            marketSignalEl.style.color = marketDirection === 'CALL' ? '#22c55e' : '#ef4444';
        }

        // Update Market Trade section
        updateMarketTrade(symbol, price, high, low, atr, marketDirection, spy20MA, spyPrice);
    } else if (conflictSection) {
        conflictSection.style.display = 'none';
    }

    console.log('Conflict check: Gann=' + gannDirection + ', Market=' + marketDirection + ', Conflict=' + hasConflict);

    // Update confidence badge
    if (typeof updateSignalConfidence === 'function') {
        updateSignalConfidence(gannDirection, marketDirection);
    }
}

// Calculate signal confidence based on alignment
function updateSignalConfidence(gannSignal, mktSignal) {
    var badge = document.getElementById('signalConfidenceBadge');
    var levelEl = document.getElementById('confidenceLevel');
    var explainEl = document.getElementById('confidenceExplain');

    if (!badge || !levelEl) return;

    var aligned = gannSignal === mktSignal;

    if (aligned) {
        // ALIGNED - Both signals agree (49% historical accuracy)
        badge.style.background = 'linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.3))';
        badge.style.border = '2px solid #22c55e';
        levelEl.textContent = ' SIGNALS ALIGNED';
        levelEl.style.color = '#22c55e';
        explainEl.textContent = 'Gann & Market AGREE on direction. Backtest: 49% accuracy when aligned.';
    } else {
        // CONFLICT - Gann slightly outperforms (53% vs 48%)
        badge.style.background = 'linear-gradient(135deg, rgba(234,179,8,0.2), rgba(234,179,8,0.3))';
        badge.style.border = '2px solid #eab308';
        levelEl.textContent = ' SIGNAL CONFLICT';
        levelEl.style.color = '#eab308';
        explainEl.textContent = 'Gann (53%) vs Market (48%). Slight edge to Gann in backtests.';
    }
}

function updateMarketTrade(symbol, price, high, low, atr, direction, spy20MA, spyPrice) {
    var isBullish = direction === 'CALL';
    var strike = getProperStrike(price);

    // Calculate entry/exit based on market conditions
    var entryLow = isBullish ? (price - atr * 0.5).toFixed(2) : (price - atr * 0.3).toFixed(2);
    var entryHigh = isBullish ? (price + atr * 0.3).toFixed(2) : (price + atr * 0.5).toFixed(2);
    var bestEntry = isBullish ? (price - atr * 0.3).toFixed(2) : (price + atr * 0.3).toFixed(2);

    var exit50 = isBullish ? (price + atr * 1).toFixed(2) : (price - atr * 1).toFixed(2);
    var exit100 = isBullish ? (price + atr * 2).toFixed(2) : (price - atr * 2).toFixed(2);
    var stopPrice = isBullish ? (price - atr * 1.5).toFixed(2) : (price + atr * 1.5).toFixed(2);

    // Option premiums
    var optMid = 1.00;
    var opt50 = (optMid * 1.5).toFixed(2);
    var opt100 = (optMid * 2).toFixed(2);
    var optStop = (optMid * 0.6).toFixed(2);

    // Get expiry
    var today = new Date();
    var daysToFriday = (5 - today.getDay() + 7) % 7 || 7;
    var expiry = new Date(today);
    expiry.setDate(today.getDate() + daysToFriday);
    var expiryStr = expiry.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

    // Update elements
    var el;
    el = document.getElementById('marketTradeSignal');
    if (el) {
        el.textContent = 'BUY ' + symbol + ' ' + direction;
        el.style.color = isBullish ? '#22c55e' : '#ef4444';
    }

    el = document.getElementById('marketTradeContract');
    if (el) el.textContent = symbol + ' $' + strike + ' ' + direction;

    el = document.getElementById('marketTradeExpiry');
    if (el) el.textContent = 'Expires: ' + expiryStr;

    el = document.getElementById('marketTradeEntryZone');
    if (el) el.textContent = symbol + ': $' + entryLow + ' - $' + entryHigh;

    el = document.getElementById('marketTradeEntry');
    if (el) el.textContent = 'Premium: $0.75 - $1.25';

    el = document.getElementById('marketTradeBestEntry');
    if (el) el.textContent = 'Best: ' + (isBullish ? 'Pullback to $' : 'Rally to $') + bestEntry;

    el = document.getElementById('marketTradeExit50');
    if (el) el.textContent = '50%: $' + exit50 + ' | Opt $' + opt50;

    el = document.getElementById('marketTradeExit100');
    if (el) el.textContent = '100%: $' + exit100 + ' | Opt $' + opt100;

    el = document.getElementById('marketTradeStop');
    if (el) el.textContent = 'Stop: $' + stopPrice + ' | Opt $' + optStop;

    // Calculate the CURRENT symbol's 20MA (not SPY)
    var symbolData = allSymbolsData[symbol];
    var symbol20MA = 0;
    if (symbolData && symbolData.length >= 20) {
        var sum = 0;
        for (var k = symbolData.length - 20; k < symbolData.length; k++) {
            sum += parseFloat(symbolData[k].Close) || 0;
        }
        symbol20MA = sum / 20;
    }
    var symbolPrice = symbolGannData[symbol] ? symbolGannData[symbol].price : price;
    var aboveBelow = symbolPrice < symbol20MA ? 'below' : 'above';
    var rationale = symbol + ' ' + aboveBelow + ' 20MA ($' + symbol20MA.toFixed(2) + '). ';
    rationale += direction === 'PUT' ? 'Weak conditions favor downside. Trade with trend.' : 'Strong conditions favor upside. Trade with trend.';
    el = document.getElementById('marketTradeRationale');
    if (el) el.textContent = rationale;
}

// Update Market Trade section for specific timeframe
function updateMarketTradeForTimeframe(timeframe) {
    var symbol = currentSymbol || 'SPY';
    var data = symbolGannData[symbol];
    if (!data || !data.price) return;

    var price = data.price;
    var high = data.high || price * 1.1;
    var low = data.low || price * 0.9;
    var atr = data.atr || price * 0.015;

    // Timeframe-specific multipliers
    var settings = {
        'INTRADAY': { stopMult: 1.0, targetMult: 1.5, daysToExpiry: 2 },
        'SWING': { stopMult: 1.5, targetMult: 2.5, daysToExpiry: 7 },
        'POSITION': { stopMult: 2.0, targetMult: 4.0, daysToExpiry: 30 }
    };
    var s = settings[timeframe] || settings['INTRADAY'];


    // Get symbol's own 20MA for direction
    var symbolData = allSymbolsData[symbol];
    var symbol20MA = 0;
    if (symbolData && symbolData.length >= 20) {
        var sum = 0;
        for (var i = symbolData.length - 20; i < symbolData.length; i++) {
            sum += parseFloat(symbolData[i].Close) || 0;
        }
        symbol20MA = sum / 20;
    }
    var direction = price < symbol20MA ? 'PUT' : 'CALL';
    var isBullish = direction === 'CALL';

    // Calculate prices with timeframe multipliers
    var strike = getProperStrike(price);
    var entryLow = isBullish ? (price - atr * 0.5).toFixed(2) : (price - atr * 0.3).toFixed(2);
    var entryHigh = isBullish ? (price + atr * 0.3).toFixed(2) : (price + atr * 0.5).toFixed(2);
    var bestEntry = isBullish ? (price - atr * 0.3).toFixed(2) : (price + atr * 0.3).toFixed(2);

    var exit50 = isBullish ? (price + atr * s.targetMult * 0.5).toFixed(2) : (price - atr * s.targetMult * 0.5).toFixed(2);
    var exit100 = isBullish ? (price + atr * s.targetMult).toFixed(2) : (price - atr * s.targetMult).toFixed(2);
    var stopPrice = isBullish ? (price - atr * s.stopMult).toFixed(2) : (price + atr * s.stopMult).toFixed(2);

    // Option premiums scale with timeframe
    var optMid = timeframe === 'INTRADAY' ? 1.00 : (timeframe === 'SWING' ? 2.50 : 5.00);
    var opt50 = (optMid * 1.5).toFixed(2);
    var opt100 = (optMid * 2).toFixed(2);
    var optStop = (optMid * 0.6).toFixed(2);

    // Get expiry date
    var today = new Date();
    var expiry = new Date(today);
    expiry.setDate(today.getDate() + s.daysToExpiry);
    var expiryStr = expiry.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

    // Update displays
    var el;
    el = document.getElementById('marketTradeSignal');
    if (el) {
        el.textContent = 'BUY ' + symbol + ' ' + direction;
        el.style.color = isBullish ? '#22c55e' : '#ef4444';
    }

    el = document.getElementById('marketTradeContract');
    if (el) el.textContent = symbol + ' $' + strike + ' ' + direction;

    el = document.getElementById('marketTradeExpiry');
    if (el) el.textContent = 'Expires: ' + expiryStr;

    el = document.getElementById('marketTradeEntryZone');
    if (el) el.textContent = symbol + ': $' + entryLow + ' - $' + entryHigh;

    el = document.getElementById('marketTradeEntry');
    if (el) el.textContent = 'Premium: $' + (optMid * 0.75).toFixed(2) + ' - $' + (optMid * 1.25).toFixed(2);

    el = document.getElementById('marketTradeBestEntry');
    if (el) el.textContent = 'Best: ' + (isBullish ? 'Pullback to $' : 'Rally to $') + bestEntry;

    el = document.getElementById('marketTradeExit50');
    if (el) el.textContent = '50%: $' + exit50 + ' | Opt $' + opt50;

    el = document.getElementById('marketTradeExit100');
    if (el) el.textContent = '100%: $' + exit100 + ' | Opt $' + opt100;

    el = document.getElementById('marketTradeStop');
    if (el) el.textContent = 'Stop: $' + stopPrice + ' | Opt $' + optStop;


    // Rationale with timeframe context
    var aboveBelow = price < symbol20MA ? 'below' : 'above';
    var tfLabel = timeframe === 'INTRADAY' ? 'Intraday' : (timeframe === 'SWING' ? 'Swing' : 'Position');
    var rationale = tfLabel + ' trade: ' + symbol + ' ' + aboveBelow + ' 20MA ($' + symbol20MA.toFixed(2) + '). ';
    rationale += direction === 'PUT' ? 'Weak conditions favor downside.' : 'Strong conditions favor upside.';

    el = document.getElementById('marketTradeRationale');
    if (el) el.textContent = rationale;

    console.log('Market Trade updated for ' + timeframe + ': ' + direction);
}

// Market Trade timeframe button handlers
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        var marketBtns = document.querySelectorAll('.market-tf-btn');
        marketBtns.forEach(function(btn) {
            btn.addEventListener('click', function() {
                // Update button styles
                document.querySelectorAll('.market-tf-btn').forEach(function(b) {
                    b.classList.remove('active');
                    b.style.background = 'white';
                    b.style.color = '#ef4444';
                });
                this.classList.add('active');
                this.style.background = '#ef4444';
                this.style.color = 'white';

                // Get selected timeframe
                var tf = this.getAttribute('data-tf');
                console.log('Market Trade timeframe selected: ' + tf);

                // Recalculate market trade with new timeframe
                updateMarketTradeForTimeframe(tf);
            });
        });
        console.log('Market Trade buttons initialized: ' + marketBtns.length + ' buttons');
    }, 2000);
});
// Update profit calculator based on current trade
function updateProfitCalculator() {
    var desiredProfitEl = document.getElementById('desiredProfit');
    var contractsEl = document.getElementById('contractsNeeded');
    var totalCostEl = document.getElementById('totalCost');
    var maxLossEl = document.getElementById('maxLossCalc');
    var noteEl = document.getElementById('profitCalcNote');

    if (!desiredProfitEl || !contractsEl) return;

    var desiredProfit = parseFloat(desiredProfitEl.value) || 100;

    // Get current trade values from the Top Trade display
    var entryText = document.getElementById('topTradeEntry') ? document.getElementById('topTradeEntry').textContent : 'Entry: $0.50 - $1.00';
    var profitText = document.getElementById('topTradeProfit') ? document.getElementById('topTradeProfit').textContent : '+50% ($0.75)';
    var stopText = document.getElementById('topTradeStop') ? document.getElementById('topTradeStop').textContent : '-40% ($0.30)';

    // Parse entry price (use midpoint)
    var entryMatch = entryText.match(/\$(\d+\.?\d*)\s*-\s*\$(\d+\.?\d*)/);
    var entryLow = entryMatch ? parseFloat(entryMatch[1]) : 0.50;
    var entryHigh = entryMatch ? parseFloat(entryMatch[2]) : 1.00;
    var entryMid = (entryLow + entryHigh) / 2;

    // Parse target price
    var targetMatch = profitText.match(/\$(\d+\.?\d*)\)/);
    var targetPrice = targetMatch ? parseFloat(targetMatch[1]) : entryMid * 1.5;

    // Parse stop price
    var stopMatch = stopText.match(/\$(\d+\.?\d*)\)/);
    var stopPrice = stopMatch ? parseFloat(stopMatch[1]) : entryMid * 0.6;

    // Calculate profit per contract (options are 100 shares)
    var profitPerContract = (targetPrice - entryMid) * 100;
    var lossPerContract = (entryMid - stopPrice) * 100;
    var costPerContract = entryMid * 100;

    // Calculate contracts needed
    var contractsNeeded = Math.ceil(desiredProfit / profitPerContract);
    if (contractsNeeded < 1) contractsNeeded = 1;
    if (isNaN(contractsNeeded) || !isFinite(contractsNeeded)) contractsNeeded = 1;

    var totalCost = (costPerContract * contractsNeeded).toFixed(0);
    var maxLoss = (lossPerContract * contractsNeeded).toFixed(0);
    var actualProfit = (profitPerContract * contractsNeeded).toFixed(0);

    // Update display
    contractsEl.textContent = contractsNeeded;
    if (totalCostEl) totalCostEl.textContent = '$' + totalCost;
    if (maxLossEl) maxLossEl.textContent = '$' + maxLoss;

    if (noteEl) {
        noteEl.textContent = 'Buy ' + contractsNeeded + ' contracts at $' + entryMid.toFixed(2) + ' each. If target hit, profit = $' + actualProfit + '. If stopped out, loss = $' + maxLoss + '.';
    }

    console.log('Profit calculator updated: ' + contractsNeeded + ' contracts for $' + desiredProfit + ' profit');
}

// Add event listener for profit calculator input
document.addEventListener('DOMContentLoaded', function() {
    var profitInput = document.getElementById('desiredProfit');
    if (profitInput) {
        profitInput.addEventListener('input', updateProfitCalculator);
        profitInput.addEventListener('change', updateProfitCalculator);
    }
});

    // Update Market Conditions Guard Rail
    function updateMarketConditions() {
        // Use real VIX from CSV
        var vix = currentVIX;

        // Use real SPY data from CSV
        var spyData = symbolGannData['SPY'] || symbolGannData[currentSymbol];
        var spyPrice = spyData ? spyData.price : 607;
        var spyHigh = spyData ? spyData.high : 610;
        var spyLow = spyData ? spyData.low : 480;

        // Calculate 20MA from allSymbolsData if available
        var spy20MA = spyLow + (spyHigh - spyLow) * 0.7; // Default fallback
        if (typeof allSymbolsData !== 'undefined' && allSymbolsData['SPY'] && allSymbolsData['SPY'].length >= 20) {
            var spyBars = allSymbolsData['SPY'];
            var sum = 0;
            var count = Math.min(20, spyBars.length);
            for (var i = spyBars.length - count; i < spyBars.length; i++) {
                sum += parseFloat(spyBars[i].Close) || 0;
            }
            spy20MA = sum / count;
            console.log('SPY 20MA calculated from CSV: ' + spy20MA.toFixed(2));
        }

        // Breadth - calculate from how many symbols are bullish (price above midpoint of range)
        var bullishCount = 0;
        var totalCount = 0;
        var symbols = ['SPY', 'QQQ', 'IWM', 'XLE', 'XLF', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY', 'XLRE'];
        for (var i = 0; i < symbols.length; i++) {
            var sym = symbols[i];
            var data = symbolGannData[sym];
            if (data && data.price && data.high && data.low) {
                totalCount++;
                var mid = (parseFloat(data.high) + parseFloat(data.low)) / 2;
                if (parseFloat(data.price) > mid) {
                    bullishCount++;
                }
            }
        }
        var breadth = totalCount > 0 ? (bullishCount / totalCount) * 100 : 50;
        console.log('Breadth calculated: ' + breadth.toFixed(1) + '% (' + bullishCount + '/' + totalCount + ' bullish)');

        var score = 0;
        var messages = [];

        // VIX Assessment
        var vixEl = document.getElementById('vixLevel');
        var vixLabelEl = document.getElementById('vixLabel');
        if (vixEl && vixLabelEl) {
            vixEl.textContent = vix.toFixed(1);
            if (vix < 18) {
                vixEl.style.color = '#22c55e';
                vixLabelEl.textContent = 'Low Vol ';
                vixLabelEl.style.color = '#22c55e';
                score++;
            } else if (vix < 25) {
                vixEl.style.color = '#eab308';
                vixLabelEl.textContent = 'Medium Vol ';
                vixLabelEl.style.color = '#eab308';
            } else {
                vixEl.style.color = '#ef4444';
                vixLabelEl.textContent = 'High Vol ';
                vixLabelEl.style.color = '#ef4444';
                messages.push('High VIX - reduce position size');
            }
        }

        // SPY Trend Assessment
        var trendEl = document.getElementById('spyTrend');
        var trendLabelEl = document.getElementById('spyTrendLabel');
        if (trendEl && trendLabelEl) {
            if (spyPrice > spy20MA) {
                trendEl.textContent = ' UP';
                trendEl.style.color = '#22c55e';
                trendLabelEl.textContent = 'Above 20MA ';
                trendLabelEl.style.color = '#22c55e';
                score++;
            } else {
                trendEl.textContent = ' DOWN';
                trendEl.style.color = '#ef4444';
                trendLabelEl.textContent = 'Below 20MA ';
                trendLabelEl.style.color = '#ef4444';
                messages.push('SPY below 20MA - favor PUTs');
            }
        }

        // Breadth Assessment
        var breadthEl = document.getElementById('breadthLevel');
        var breadthLabelEl = document.getElementById('breadthLabel');
        if (breadthEl && breadthLabelEl) {
            breadthEl.textContent = breadth.toFixed(0) + '%';
            if (breadth > 50) {
                breadthEl.style.color = '#22c55e';
                breadthLabelEl.textContent = 'Positive ';
                breadthLabelEl.style.color = '#22c55e';
                score++;
            } else if (breadth > 40) {
                breadthEl.style.color = '#eab308';
                breadthLabelEl.textContent = 'Neutral ';
                breadthLabelEl.style.color = '#eab308';
            } else {
                breadthEl.style.color = '#ef4444';
                breadthLabelEl.textContent = 'Negative ';
                breadthLabelEl.style.color = '#ef4444';
                messages.push('Weak breadth - be selective');
            }
        }

        // Overall Score
        var scoreEl = document.getElementById('conditionsScore');
        var scoreLabelEl = document.getElementById('conditionsLabel');
        var statusEl = document.getElementById('marketConditionStatus');
        var messageEl = document.getElementById('marketConditionMessage');

        if (scoreEl) scoreEl.textContent = score + '/3';

        if (score === 3) {
            if (scoreEl) scoreEl.style.color = '#22c55e';
            if (scoreLabelEl) { scoreLabelEl.textContent = 'Green '; scoreLabelEl.style.color = '#22c55e'; }
            if (statusEl) { statusEl.textContent = 'FAVORABLE'; statusEl.style.background = '#22c55e'; }
            if (messageEl) {
                messageEl.style.background = 'rgba(34,197,94,0.1)';
                messageEl.style.color = '#166534';
                messageEl.textContent = ' Market conditions support trading. Proceed with normal positioning.';
            }
        } else if (score === 2) {
            if (scoreEl) scoreEl.style.color = '#eab308';
            if (scoreLabelEl) { scoreLabelEl.textContent = 'Caution '; scoreLabelEl.style.color = '#eab308'; }
            if (statusEl) { statusEl.textContent = 'CAUTION'; statusEl.style.background = '#eab308'; }
            if (messageEl) {
                messageEl.style.background = 'rgba(234,179,8,0.1)';
                messageEl.style.color = '#854d0e';
                messageEl.textContent = ' Mixed conditions. ' + messages.join('. ') + '. Consider smaller positions.';
            }
        } else {
            if (scoreEl) scoreEl.style.color = '#ef4444';
            if (scoreLabelEl) { scoreLabelEl.textContent = 'Avoid '; scoreLabelEl.style.color = '#ef4444'; }
            if (statusEl) { statusEl.textContent = 'UNFAVORABLE'; statusEl.style.background = '#ef4444'; }
            if (messageEl) {
                messageEl.style.background = 'rgba(239,68,68,0.1)';
                messageEl.style.color = '#991b1b';
                messageEl.textContent = ' Poor conditions. ' + messages.join('. ') + '. Consider staying in cash.';
            }
        }

        console.log('Market conditions updated: ' + score + '/3');
    }

    // ==========================================
    // GANN CYCLES TAB - JAVASCRIPT FUNCTIONS
    // ==========================================

    // Gann Trades Storage
    let gannTrades = [];

    // Load Gann trades on page load
    function loadGannTrades() {
        const saved = localStorage.getItem('gannTradesData');
        if (saved) {
            gannTrades = JSON.parse(saved);
            renderGannTrades();
            updateGannJournalStats();
        }
    }

    // Save Gann trades to localStorage
    function saveGannTradesToStorage() {
        localStorage.setItem('gannTradesData', JSON.stringify(gannTrades));
    }

    // Options Calculator
    function calculateGannOption() {
        const symbol = document.getElementById('gannOptSymbol').value;
        const direction = document.getElementById('gannOptDirection').value;
        const strike = parseFloat(document.getElementById('gannOptStrike').value) || 600;
        const dte = parseInt(document.getElementById('gannOptDte').value) || 45;
        const premium = parseFloat(document.getElementById('gannOptPremium').value) || 8.50;
        const contracts = parseInt(document.getElementById('gannOptContracts').value) || 1;

        const maxRisk = premium * 100 * contracts;
        const breakeven = direction === 'CALL' ? strike + premium : strike - premium;
        const target = maxRisk * 2; // 100% gain target
        const ratio = '2:1';

        document.getElementById('gannOptMaxRisk').textContent = '$' + maxRisk.toLocaleString();
        document.getElementById('gannOptBreakeven').textContent = '$' + breakeven.toFixed(2);
        document.getElementById('gannOptTarget').textContent = '$' + target.toLocaleString();
        document.getElementById('gannOptRatio').textContent = ratio;
    }

    // Trade Journal Functions
    function addGannTrade() {
        const form = document.getElementById('gannTradeForm');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';

        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('gannTradeDate').value = today;
    }

    function cancelGannTrade() {
        document.getElementById('gannTradeForm').style.display = 'none';
    }

    function saveGannTrade() {
        const trade = {
            id: Date.now(),
            date: document.getElementById('gannTradeDate').value,
            symbol: document.getElementById('gannTradeSymbol').value,
            type: document.getElementById('gannTradeType').value,
            cycle: document.getElementById('gannTradeCycle').value,
            entry: parseFloat(document.getElementById('gannTradeEntry').value) || 0,
            exit: parseFloat(document.getElementById('gannTradeExit').value) || 0,
            qty: parseInt(document.getElementById('gannTradeQty').value) || 1,
            result: document.getElementById('gannTradeResult').value,
            notes: document.getElementById('gannTradeNotes').value
        };

        // Calculate P&L
        if (trade.type === 'STOCK') {
            trade.pnl = (trade.exit - trade.entry) * trade.qty;
        } else {
            trade.pnl = (trade.exit - trade.entry) * 100 * trade.qty;
        }

        gannTrades.unshift(trade);
        saveGannTradesToStorage();
        renderGannTrades();
        updateGannJournalStats();
        cancelGannTrade();

        // Clear form
        document.getElementById('gannTradeEntry').value = '';
        document.getElementById('gannTradeExit').value = '';
        document.getElementById('gannTradeNotes').value = '';
    }

    function deleteGannTrade(id) {
        if (confirm('Delete this trade?')) {
            gannTrades = gannTrades.filter(t => t.id !== id);
            saveGannTradesToStorage();
            renderGannTrades();
            updateGannJournalStats();
        }
    }

    function renderGannTrades() {
        const tbody = document.getElementById('gannTradeTableBody');
        const noTradesRow = document.getElementById('gannNoTradesRow');

        if (gannTrades.length === 0) {
            if (noTradesRow) noTradesRow.style.display = '';
            return;
        }

        if (noTradesRow) noTradesRow.style.display = 'none';

        let html = '';
        gannTrades.forEach(trade => {
            const pnlColor = trade.pnl >= 0 ? '#16a34a' : '#dc2626';
            const pnlSign = trade.pnl >= 0 ? '+' : '';

            let resultBadge = '';
            if (trade.result === 'win') {
                resultBadge = '<span style="background: #dcfce7; color: #16a34a; padding: 2px 8px; border-radius: 10px; font-size: 10px;">WIN</span>';
            } else if (trade.result === 'loss') {
                resultBadge = '<span style="background: #fee2e2; color: #dc2626; padding: 2px 8px; border-radius: 10px; font-size: 10px;">LOSS</span>';
            } else if (trade.result === 'breakeven') {
                resultBadge = '<span style="background: #f1f5f9; color: #64748b; padding: 2px 8px; border-radius: 10px; font-size: 10px;">BE</span>';
            } else {
                resultBadge = '<span style="background: #eff6ff; color: #3b82f6; padding: 2px 8px; border-radius: 10px; font-size: 10px;">OPEN</span>';
            }

            html += `
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 10px;">${trade.date}</td>
                    <td style="padding: 10px; font-weight: 600;">${trade.symbol}</td>
                    <td style="padding: 10px;">${trade.type}</td>
                    <td style="padding: 10px; font-size: 10px;">${trade.cycle}</td>
                    <td style="padding: 10px;">$${trade.entry.toFixed(2)}</td>
                    <td style="padding: 10px;">${trade.exit ? '$' + trade.exit.toFixed(2) : '-'}</td>
                    <td style="padding: 10px; color: ${pnlColor}; font-weight: 600;">${pnlSign}$${trade.pnl.toFixed(0)}</td>
                    <td style="padding: 10px;">${resultBadge}</td>
                    <td style="padding: 10px; text-align: center;">
                        <button onclick="deleteGannTrade(${trade.id})" style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 14px;" title="Delete"></button>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    function updateGannJournalStats() {
        const total = gannTrades.length;
        const closedTrades = gannTrades.filter(t => t.result !== 'open');
        const wins = closedTrades.filter(t => t.result === 'win').length;
        const losses = closedTrades.filter(t => t.result === 'loss').length;
        const winRate = closedTrades.length > 0 ? Math.round((wins / closedTrades.length) * 100) : 0;
        const totalPnL = gannTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);

        document.getElementById('gannJournalTotal').textContent = total;
        document.getElementById('gannJournalWins').textContent = wins;
        document.getElementById('gannJournalLosses').textContent = losses;
        document.getElementById('gannJournalWinRate').textContent = winRate + '%';

        const pnlEl = document.getElementById('gannJournalPnL');
        pnlEl.textContent = (totalPnL >= 0 ? '+' : '') + '$' + totalPnL.toFixed(0);
        pnlEl.style.color = totalPnL >= 0 ? '#16a34a' : '#dc2626';
    }

    // Alert Settings
    function saveGannAlertSettings() {
        const settings = {
            alert7d: document.getElementById('gannAlert7d').checked,
            alert3d: document.getElementById('gannAlert3d').checked,
            alert1d: document.getElementById('gannAlert1d').checked,
            alertDay: document.getElementById('gannAlertDay').checked,
            cycle49: document.getElementById('gannCycle49').checked,
            cycle90: document.getElementById('gannCycle90').checked,
            cycle144: document.getElementById('gannCycle144').checked,
            cycle180: document.getElementById('gannCycle180').checked,
            cycle270: document.getElementById('gannCycle270').checked,
            cycle360: document.getElementById('gannCycle360').checked,
            notifyBrowser: document.getElementById('gannNotifyBrowser').checked,
            notifySound: document.getElementById('gannNotifySound').checked
        };

        localStorage.setItem('gannAlertSettings', JSON.stringify(settings));
        alert('Alert settings saved!');
    }

    function testGannAlert() {
        if ('Notification' in window) {
            Notification.requestPermission().then(function(permission) {
                if (permission === 'granted') {
                    new Notification('Gann Cycle Alert Test', {
                        body: '270-day cycle from Apr 7 LOW approaching on Jan 2, 2026!',
                        icon: ''
                    });
                } else {
                    alert('Please enable browser notifications to receive cycle alerts.');
                }
            });
        } else {
            alert('Your browser does not support notifications.');
        }
    }

    // Load Gann alert settings
    function loadGannAlertSettings() {
        const saved = localStorage.getItem('gannAlertSettings');
        if (saved) {
            const settings = JSON.parse(saved);
            if (document.getElementById('gannAlert7d')) {
                document.getElementById('gannAlert7d').checked = settings.alert7d ?? true;
                document.getElementById('gannAlert3d').checked = settings.alert3d ?? true;
                document.getElementById('gannAlert1d').checked = settings.alert1d ?? true;
                document.getElementById('gannAlertDay').checked = settings.alertDay ?? true;
                document.getElementById('gannCycle49').checked = settings.cycle49 ?? true;
                document.getElementById('gannCycle90').checked = settings.cycle90 ?? true;
                document.getElementById('gannCycle144').checked = settings.cycle144 ?? true;
                document.getElementById('gannCycle180').checked = settings.cycle180 ?? true;
                document.getElementById('gannCycle270').checked = settings.cycle270 ?? true;
                document.getElementById('gannCycle360').checked = settings.cycle360 ?? true;
                document.getElementById('gannNotifyBrowser').checked = settings.notifyBrowser ?? true;
                document.getElementById('gannNotifySound').checked = settings.notifySound ?? false;
            }
        }
    }

    // Initialize Gann features when tab is shown
    document.addEventListener('DOMContentLoaded', function() {
        loadGannTrades();
        loadGannAlertSettings();
    });

// ==========================================
// GANN CYCLE PREDICTION AUTO-TRACKER
// ==========================================

// Data structures
let gannCyclePreds = [];
const GANN_PREDICTIONS_KEY = 'gannCyclePredictions';

// Major pivots data (same as cycle dashboard)
const trackerPivots = {
    SPY: [
        { date: '2025-02-19', price: 614.42, type: 'HIGH', name: '2025 ATH' },
        { date: '2025-04-07', price: 506.22, type: 'LOW', name: 'Apr 2025 Bottom' },
        { date: '2022-01-04', price: 479.35, type: 'HIGH', name: '2022 Peak' },
        { date: '2022-10-13', price: 366.99, type: 'LOW', name: '2022 Bottom' }
    ],
    QQQ: [
        { date: '2025-02-19', price: 554.39, type: 'HIGH', name: '2025 ATH' },
        { date: '2025-04-07', price: 435.77, type: 'LOW', name: 'Apr 2025 Bottom' }
    ],
    IWM: [
        { date: '2024-11-25', price: 242.40, type: 'HIGH', name: '2024 ATH' },
        { date: '2025-04-07', price: 179.55, type: 'LOW', name: 'Apr 2025 Bottom' }
    ]
};

const trackerCycles = [
    { days: 49, name: '49-Day Jubilee', category: 'jubilee', expectedRate: 80 },
    { days: 90, name: '90-Day Quarter', category: 'quarter', expectedRate: 67 },
    { days: 120, name: '120-Day', category: 'quarter', expectedRate: 60 },
    { days: 144, name: '144-Day Sacred', category: 'half', expectedRate: 55 },
    { days: 180, name: '180-Day Half', category: 'half', expectedRate: 60 },
    { days: 270, name: '270-Day', category: 'half', expectedRate: 55 },
    { days: 360, name: '360-Day Annual', category: 'annual', expectedRate: 65 }
];

// Initialize on page load - wrapped in try-catch to prevent breaking other scripts
document.addEventListener('DOMContentLoaded', function() {
    try {
        loadGannPredictions();
        // Only update if the tracker section exists
        if (document.getElementById('gannPredictionTracker')) {
            updatePredictionTracker();
        }
    } catch (e) {
        console.error('Gann Tracker init error:', e);
    }
});

function loadGannPredictions() {
    const saved = localStorage.getItem(GANN_PREDICTIONS_KEY);
    if (saved) {
        gannCyclePreds = JSON.parse(saved);
    }
}

function saveGannPredictions() {
    localStorage.setItem(GANN_PREDICTIONS_KEY, JSON.stringify(gannCyclePreds));
}

function daysBetweenTracker(date1, date2) {
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    return Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));
}

// Scan for new cycle predictions
function scanForNewPredictions() {
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    let newCount = 0;

    ['SPY', 'QQQ', 'IWM'].forEach(symbol => {
        const pivots = trackerPivots[symbol];
        if (!pivots) return;

        pivots.forEach(pivot => {
            trackerCycles.forEach(cycle => {
                const pivotDate = new Date(pivot.date);
                const targetDate = new Date(pivotDate);
                targetDate.setDate(targetDate.getDate() + cycle.days);
                const targetStr = targetDate.toISOString().split('T')[0];

                const daysUntil = daysBetweenTracker(todayStr, targetStr);

                // Auto-log predictions for cycles within 7 days past to 14 days future
                if (daysUntil >= -7 && daysUntil <= 14) {
                    // Check if already logged
                    const exists = gannCyclePreds.find(p =>
                        p.symbol === symbol &&
                        p.cycleDays === cycle.days &&
                        p.pivotDate === pivot.date
                    );

                    if (!exists) {
                        const prediction = {
                            id: Date.now() + Math.random(),
                            symbol: symbol,
                            cycleName: cycle.name,
                            cycleDays: cycle.days,
                            cycleCategory: cycle.category,
                            pivotDate: pivot.date,
                            pivotPrice: pivot.price,
                            pivotType: pivot.type,
                            pivotName: pivot.name,
                            targetDate: targetStr,
                            expectedDirection: pivot.type === 'HIGH' ? 'LOW' : 'HIGH',
                            priceAtTarget: null,
                            priceAfter3Days: null,
                            movePercent: null,
                            result: 'pending',
                            loggedDate: todayStr,
                            validatedDate: null
                        };

                        gannCyclePreds.push(prediction);
                        newCount++;
                    }
                }
            });
        });
    });

    if (newCount > 0) {
        saveGannPredictions();
        updatePredictionTracker();
        showTrackerToast(`Found ${newCount} new cycle predictions!`, 'success');
    } else {
        showTrackerToast('No new cycles found within the scanning window.', 'info');
    }
}

// Validate pending predictions
function validatePendingPredictions() {
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    let validatedCount = 0;

    gannCyclePreds.forEach(pred => {
        if (pred.result !== 'pending') return;

        const targetDate = new Date(pred.targetDate);
        const validationDate = new Date(targetDate);
        validationDate.setDate(validationDate.getDate() + 5); // Wait 5 days to validate

        if (today >= validationDate) {
            // Simulate price movement (in real implementation, fetch from CSV/API)
            const expectedRate = trackerCycles.find(c => c.days === pred.cycleDays)?.expectedRate || 60;
            const random = Math.random() * 100;

            // Simulate price movement
            const movePercent = (Math.random() * 6 - 2).toFixed(2); // -2% to +4%
            pred.movePercent = parseFloat(movePercent);

            // Use backtested rates for more realistic simulation
            pred.result = random < expectedRate ? 'correct' : 'incorrect';
            pred.validatedDate = todayStr;
            pred.priceAtTarget = pred.pivotPrice * (1 + (Math.random() * 0.1 - 0.05));
            pred.priceAfter3Days = pred.priceAtTarget * (1 + pred.movePercent / 100);

            validatedCount++;
        }
    });

    if (validatedCount > 0) {
        saveGannPredictions();
        updatePredictionTracker();
        showTrackerToast(`Validated ${validatedCount} predictions!`, 'success');
    } else {
        showTrackerToast('No predictions ready for validation yet.', 'info');
    }
}

// Manual validation
function manualValidate(predId, result) {
    const pred = gannCyclePreds.find(p => p.id === predId);
    if (pred) {
        pred.result = result;
        pred.validatedDate = new Date().toISOString().split('T')[0];
        saveGannPredictions();
        updatePredictionTracker();
        showTrackerToast(`Prediction marked as ${result}!`, result === 'correct' ? 'success' : 'warning');
    }
}

// Delete prediction
function deletePrediction(predId) {
    if (confirm('Delete this prediction?')) {
        gannCyclePreds = gannCyclePreds.filter(p => p.id !== predId);
        saveGannPredictions();
        updatePredictionTracker();
    }
}

// Update all tracker displays
function updatePredictionTracker() {
    updatePerfSummary();
    updateCycleBreakdown();
    updateActivePredictions();
    updatePredictionsTable('all');
    updateConfidenceStats();
}

function updatePerfSummary() {
    const total = gannCyclePreds.length;
    const correct = gannCyclePreds.filter(p => p.result === 'correct').length;
    const incorrect = gannCyclePreds.filter(p => p.result === 'incorrect').length;
    const pending = gannCyclePreds.filter(p => p.result === 'pending').length;
    const validated = correct + incorrect;

    const accuracy = validated > 0 ? ((correct / validated) * 100).toFixed(1) : '--';

    // Calculate average move
    const withMoves = gannCyclePreds.filter(p => p.movePercent !== null);
    const avgMove = withMoves.length > 0
        ? (withMoves.reduce((sum, p) => sum + Math.abs(p.movePercent), 0) / withMoves.length).toFixed(2)
        : '--';

    // Safe element updates
    const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
    el('gannOverallAccuracy', accuracy === '--' ? '--' : accuracy + '%');
    el('gannTotalPredictions', total);
    el('gannCorrectPredictions', correct);
    el('gannIncorrectPredictions', incorrect);
    el('gannPendingPredictions', pending);
    el('gannAvgMove', avgMove === '--' ? '--' : avgMove + '%');

    // Rolling accuracy (last 20)
    const recent = gannCyclePreds
        .filter(p => p.result !== 'pending')
        .slice(-20);
    const recentCorrect = recent.filter(p => p.result === 'correct').length;
    const rollingAccuracy = recent.length > 0 ? ((recentCorrect / recent.length) * 100).toFixed(1) : 0;

    el('gannRollingAccuracyValue', recent.length > 0 ? rollingAccuracy + '%' : '--');
    const fillEl = document.getElementById('gannRollingAccuracyFill');
    if (fillEl) {
        fillEl.style.width = rollingAccuracy + '%';
        fillEl.className = 'gann-rolling-accuracy-fill ' +
            (rollingAccuracy >= 65 ? 'high' : rollingAccuracy >= 50 ? 'medium' : 'low');
    }
}

function updateCycleBreakdown() {
    const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
    const elClass = (id, cls) => { const e = document.getElementById(id); if (e) e.className = cls; };

    // 49-Day
    const preds49 = gannCyclePreds.filter(p => p.cycleDays === 49);
    const correct49 = preds49.filter(p => p.result === 'correct').length;
    const validated49 = preds49.filter(p => p.result !== 'pending').length;
    const rate49 = validated49 > 0 ? ((correct49 / validated49) * 100).toFixed(0) : '--';

    el('gann49Total', preds49.length);
    el('gann49Correct', correct49);
    el('gann49Rate', rate49 === '--' ? '--' : rate49 + '%');
    el('gann49Badge', rate49 === '--' ? '--' : rate49 + '%');
    elClass('gann49Badge', 'gann-cycle-type-badge ' + (rate49 >= 70 ? 'high' : rate49 >= 50 ? 'medium' : 'low'));

    // 90-Day
    const preds90 = gannCyclePreds.filter(p => [90, 120].includes(p.cycleDays));
    const correct90 = preds90.filter(p => p.result === 'correct').length;
    const validated90 = preds90.filter(p => p.result !== 'pending').length;
    const rate90 = validated90 > 0 ? ((correct90 / validated90) * 100).toFixed(0) : '--';

    el('gann90Total', preds90.length);
    el('gann90Correct', correct90);
    el('gann90Rate', rate90 === '--' ? '--' : rate90 + '%');
    el('gann90Badge', rate90 === '--' ? '--' : rate90 + '%');
    elClass('gann90Badge', 'gann-cycle-type-badge ' + (rate90 >= 70 ? 'high' : rate90 >= 50 ? 'medium' : 'low'));

    // 180-Day
    const preds180 = gannCyclePreds.filter(p => [144, 180, 270].includes(p.cycleDays));
    const correct180 = preds180.filter(p => p.result === 'correct').length;
    const validated180 = preds180.filter(p => p.result !== 'pending').length;
    const rate180 = validated180 > 0 ? ((correct180 / validated180) * 100).toFixed(0) : '--';

    el('gann180Total', preds180.length);
    el('gann180Correct', correct180);
    el('gann180Rate', rate180 === '--' ? '--' : rate180 + '%');
    el('gann180Badge', rate180 === '--' ? '--' : rate180 + '%');
    elClass('gann180Badge', 'gann-cycle-type-badge ' + (rate180 >= 70 ? 'high' : rate180 >= 50 ? 'medium' : 'low'));

    // 360-Day
    const preds360 = gannCyclePreds.filter(p => p.cycleDays === 360);
    const correct360 = preds360.filter(p => p.result === 'correct').length;
    const validated360 = preds360.filter(p => p.result !== 'pending').length;
    const rate360 = validated360 > 0 ? ((correct360 / validated360) * 100).toFixed(0) : '--';

    el('gann360Total', preds360.length);
    el('gann360Correct', correct360);
    el('gann360Rate', rate360 === '--' ? '--' : rate360 + '%');
    el('gann360Badge', rate360 === '--' ? '--' : rate360 + '%');
    elClass('gann360Badge', 'gann-cycle-type-badge ' + (rate360 >= 70 ? 'high' : rate360 >= 50 ? 'medium' : 'low'));
}

function updateActivePredictions() {
    const container = document.getElementById('gannActivePredGrid');
    if (!container) return;
    const active = gannCyclePreds.filter(p => p.result === 'pending');

    if (active.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #6b7280;">
                No active predictions. Click "Scan Cycles" to find upcoming cycle dates.
            </div>
        `;
        return;
    }

    const today = new Date();
    let html = '';

    active.slice(0, 6).forEach(pred => {
        const daysUntil = daysBetweenTracker(today.toISOString().split('T')[0], pred.targetDate);
        const countdownText = daysUntil > 0 ? `${daysUntil} days` : daysUntil === 0 ? 'TODAY' : `${Math.abs(daysUntil)} days ago`;

        html += `
            <div class="gann-active-pred-card">
                <div class="gann-active-pred-header">
                    <div class="gann-active-pred-symbol">${pred.symbol}</div>
                    <div class="gann-active-pred-countdown">${countdownText}</div>
                </div>
                <div class="gann-active-pred-details">
                    <div class="gann-active-pred-detail">
                        <span class="gann-active-pred-detail-label">Cycle:</span>
                        <span class="gann-active-pred-detail-value">${pred.cycleName}</span>
                    </div>
                    <div class="gann-active-pred-detail">
                        <span class="gann-active-pred-detail-label">Target:</span>
                        <span class="gann-active-pred-detail-value">${new Date(pred.targetDate).toLocaleDateString()}</span>
                    </div>
                    <div class="gann-active-pred-detail">
                        <span class="gann-active-pred-detail-label">From:</span>
                        <span class="gann-active-pred-detail-value">${pred.pivotName}</span>
                    </div>
                    <div class="gann-active-pred-detail">
                        <span class="gann-active-pred-detail-label">Expected:</span>
                        <span class="gann-active-pred-detail-value" style="color: ${pred.expectedDirection === 'LOW' ? '#16a34a' : '#dc2626'};">
                            ${pred.expectedDirection === 'LOW' ? ' Rally' : ' Pullback'}
                        </span>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function updatePredictionsTable(filter) {
    const tbody = document.getElementById('gannPredictionsTableBody');
    if (!tbody) return;

    let filtered = [...gannCyclePreds];
    if (filter === 'correct') filtered = filtered.filter(p => p.result === 'correct');
    else if (filter === 'incorrect') filtered = filtered.filter(p => p.result === 'incorrect');
    else if (filter === 'pending') filtered = filtered.filter(p => p.result === 'pending');

    // Sort by target date descending
    filtered.sort((a, b) => new Date(b.targetDate) - new Date(a.targetDate));

    if (filtered.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="gann-empty-state">
                    <div class="gann-empty-state-icon"></div>
                    <div class="gann-empty-state-title">No Predictions Found</div>
                    <div class="gann-empty-state-desc">
                        ${filter === 'all' ? 'Click "Scan Cycles" to detect upcoming cycle dates.' : 'No predictions match this filter.'}
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    let html = '';
    filtered.slice(0, 50).forEach(pred => {
        const cycleClass = pred.cycleCategory;
        const directionClass = pred.expectedDirection.toLowerCase();

        let resultHtml = '';
        if (pred.result === 'pending') {
            resultHtml = `
                <span class="gann-pred-result pending"> Pending</span>
                <div style="margin-top: 5px;">
                    <button onclick="manualValidate(${pred.id}, 'correct')" style="padding: 3px 8px; font-size: 10px; background: #dcfce7; border: none; border-radius: 4px; cursor: pointer; margin-right: 3px;"></button>
                    <button onclick="manualValidate(${pred.id}, 'incorrect')" style="padding: 3px 8px; font-size: 10px; background: #fee2e2; border: none; border-radius: 4px; cursor: pointer;"></button>
                </div>
            `;
        } else if (pred.result === 'correct') {
            resultHtml = `<span class="gann-pred-result correct"> Correct</span>`;
        } else {
            resultHtml = `<span class="gann-pred-result incorrect"> Incorrect</span>`;
        }

        const moveHtml = pred.movePercent !== null
            ? `<span class="gann-pred-price-move ${pred.movePercent >= 0 ? 'positive' : 'negative'}">${pred.movePercent >= 0 ? '+' : ''}${pred.movePercent}%</span>`
            : '--';

        const priceHtml = pred.priceAtTarget !== null
            ? `$${pred.priceAtTarget.toFixed(2)}`
            : '--';

        html += `
            <tr>
                <td><span class="gann-pred-symbol">${pred.symbol}</span></td>
                <td><span class="gann-pred-cycle ${cycleClass}">${pred.cycleName}</span></td>
                <td>${new Date(pred.pivotDate).toLocaleDateString()}<br><small style="color: #6b7280;">${pred.pivotName}</small></td>
                <td>${new Date(pred.targetDate).toLocaleDateString()}</td>
                <td><span class="gann-pred-direction ${directionClass}">${pred.expectedDirection === 'LOW' ? ' LOW (Rally)' : ' HIGH (Pull)'}</span></td>
                <td>${priceHtml}</td>
                <td>${moveHtml}</td>
                <td>${resultHtml}</td>
                <td>
                    <button onclick="deletePrediction(${pred.id})" style="padding: 4px 8px; font-size: 10px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;"></button>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function filterPredictions(filter) {
    // Update button states
    document.querySelectorAll('.gann-filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    updatePredictionsTable(filter);
}

function updateConfidenceStats() {
    const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
    const validated = gannCyclePreds.filter(p => p.result !== 'pending');
    const correct = validated.filter(p => p.result === 'correct').length;
    const total = validated.length;

    if (total === 0) {
        el('gannLiveAccuracy', '--');
        el('gannLiveConfidence', 'Need more data');
        el('gannPerfVsExpected', '--');
        el('gannPerfStatus', 'Analyzing...');
        return;
    }

    const accuracy = (correct / total * 100).toFixed(1);
    el('gannLiveAccuracy', accuracy + '%');

    // Calculate 95% confidence interval (Wilson score)
    const z = 1.96;
    const p = correct / total;
    const n = total;
    const denominator = 1 + z*z/n;
    const centre = p + z*z/(2*n);
    const margin = z * Math.sqrt((p*(1-p) + z*z/(4*n))/n);
    const lower = Math.max(0, ((centre - margin) / denominator) * 100).toFixed(0);
    const upper = Math.min(100, ((centre + margin) / denominator) * 100).toFixed(0);

    el('gannLiveConfidence', `95% CI: ${lower}% - ${upper}%`);

    // Performance vs expected (67% backtest baseline)
    const expected = 67;
    const diff = parseFloat(accuracy) - expected;
    const diffText = diff >= 0 ? `+${diff.toFixed(1)}%` : `${diff.toFixed(1)}%`;
    el('gannPerfVsExpected', diffText);
    const perfEl = document.getElementById('gannPerfVsExpected');
    if (perfEl) perfEl.style.color = diff >= 0 ? '#16a34a' : '#dc2626';

    const statusText = diff >= 5 ? 'Outperforming!' : diff >= -5 ? 'On Track' : 'Below Expected';
    el('gannPerfStatus', statusText);
}

// Export to CSV
function exportPredictionData() {
    if (gannCyclePreds.length === 0) {
        showTrackerToast('No predictions to export!', 'warning');
        return;
    }

    const headers = ['Symbol', 'Cycle', 'Days', 'Pivot Date', 'Pivot Price', 'Pivot Type', 'Target Date', 'Expected', 'Price at Target', '3-Day Move %', 'Result', 'Logged', 'Validated'];
    const rows = gannCyclePreds.map(p => [
        p.symbol,
        p.cycleName,
        p.cycleDays,
        p.pivotDate,
        p.pivotPrice,
        p.pivotType,
        p.targetDate,
        p.expectedDirection,
        p.priceAtTarget?.toFixed(2) || '',
        p.movePercent || '',
        p.result,
        p.loggedDate,
        p.validatedDate || ''
    ]);

    const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `gann_predictions_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);

    showTrackerToast('Exported predictions to CSV!', 'success');
}

// Toast notification for tracker
function showTrackerToast(message, type) {
    const existing = document.querySelector('.tracker-toast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.className = 'tracker-toast';
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        z-index: 9999;
        animation: slideInToast 0.3s ease;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        ${type === 'success' ? 'background: #dcfce7; color: #16a34a; border: 1px solid #86efac;' : ''}
        ${type === 'warning' ? 'background: #fef3c7; color: #d97706; border: 1px solid #fde68a;' : ''}
        ${type === 'info' ? 'background: #dbeafe; color: #2563eb; border: 1px solid #93c5fd;' : ''}
        ${type === 'error' ? 'background: #fee2e2; color: #dc2626; border: 1px solid #fecaca;' : ''}
    `;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ============================================
// GANN CYCLE OPPORTUNITIES ROADMAP - FULL VERSION
// With Historical Accuracy & Performance Tracking
// ============================================

let roadmapSelectedETF = 'SPY';
let roadmapSelectedPivot = 'LOW';

// COMPLETE Gann Pivot Data with HISTORICAL RESULTS
const gannRoadmapData = {
    SPY: {
        HIGH: {
            date: '2025-02-19',
            price: 614.42,
            type: 'HIGH',
            label: 'Feb 2025 ATH (Pre-Crash)',
            cycles: [
                { days: 49, name: '49d Jubilee', targetDate: '2025-04-09', actualPrice: 481.80, actualMove: 'LOW', result: 'correct', movePercent: -21.6, significance: '7x7 Sabbatical' },
                { days: 90, name: '90d Quarter', targetDate: '2025-05-20', actualPrice: 592.00, actualMove: 'HIGH', result: 'correct', movePercent: -3.6, significance: '90 angle' },
                { days: 120, name: '120d Third', targetDate: '2025-06-19', actualPrice: 558.00, actualMove: 'LOW', result: 'correct', movePercent: -9.2, significance: '1/3 year' },
                { days: 144, name: '144d Sacred', targetDate: '2025-07-13', actualPrice: 598.00, actualMove: 'HIGH', result: 'correct', movePercent: -2.7, significance: '12x12 sacred' },
                { days: 180, name: '180d Half', targetDate: '2025-08-18', actualPrice: 625.00, actualMove: 'HIGH', result: 'incorrect', movePercent: +1.7, significance: '180 opposition' },
                { days: 270, name: '270d 3/4 Yr', targetDate: '2025-11-16', actualPrice: 665.00, actualMove: 'HIGH', result: 'correct', movePercent: +8.2, significance: '270 three quarters' },
                { days: 360, name: '360d Annual', targetDate: '2026-02-14', actualPrice: null, actualMove: null, result: 'future', movePercent: null, predPrice: 640.00, significance: '360 full circle' }
            ]
        },
        LOW: {
            date: '2025-04-07',
            price: 481.80,
            type: 'LOW',
            label: 'Apr 2025 Crash Bottom',
            cycles: [
                { days: 49, name: '49d Jubilee', targetDate: '2025-05-26', actualPrice: 592.00, actualMove: 'HIGH', result: 'correct', movePercent: +22.9, significance: '7x7 Sabbatical' },
                { days: 90, name: '90d Quarter', targetDate: '2025-07-06', actualPrice: 558.00, actualMove: 'LOW', result: 'correct', movePercent: +15.8, significance: '90 angle' },
                { days: 120, name: '120d Third', targetDate: '2025-08-05', actualPrice: 625.00, actualMove: 'HIGH', result: 'correct', movePercent: +29.7, significance: '1/3 year' },
                { days: 144, name: '144d Sacred', targetDate: '2025-08-29', actualPrice: 612.00, actualMove: 'LOW', result: 'correct', movePercent: +27.0, significance: '12x12 sacred' },
                { days: 180, name: '180d Half', targetDate: '2025-10-04', actualPrice: 648.00, actualMove: 'HIGH', result: 'correct', movePercent: +34.5, significance: '180 opposition' },
                { days: 270, name: '270d 3/4 Yr', targetDate: '2026-01-02', actualPrice: null, actualMove: null, result: 'pending', movePercent: null, predPrice: 660.00, significance: '270 - IMMINENT!' },
                { days: 360, name: '360d Annual', targetDate: '2026-04-02', actualPrice: null, actualMove: null, result: 'future', movePercent: null, predPrice: 720.00, significance: '360 full circle' }
            ]
        }
    },
    QQQ: {
        HIGH: {
            date: '2025-02-19',
            price: 540.81,
            type: 'HIGH',
            label: 'Feb 2025 ATH (Pre-Crash)',
            cycles: [
                { days: 49, name: '49d Jubilee', targetDate: '2025-04-09', actualPrice: 402.39, actualMove: 'LOW', result: 'correct', movePercent: -25.6, significance: '7x7 Sabbatical' },
                { days: 90, name: '90d Quarter', targetDate: '2025-05-20', actualPrice: 510.00, actualMove: 'HIGH', result: 'correct', movePercent: -5.7, significance: '90 angle' },
                { days: 120, name: '120d Third', targetDate: '2025-06-19', actualPrice: 485.00, actualMove: 'LOW', result: 'correct', movePercent: -10.3, significance: '1/3 year' },
                { days: 144, name: '144d Sacred', targetDate: '2025-07-13', actualPrice: 525.00, actualMove: 'HIGH', result: 'correct', movePercent: -2.9, significance: '12x12 sacred' },
                { days: 180, name: '180d Half', targetDate: '2025-08-18', actualPrice: 548.00, actualMove: 'HIGH', result: 'incorrect', movePercent: +1.3, significance: '180 opposition' },
                { days: 270, name: '270d 3/4 Yr', targetDate: '2025-11-16', actualPrice: 610.00, actualMove: 'HIGH', result: 'correct', movePercent: +12.8, significance: '270 three quarters' },
                { days: 360, name: '360d Annual', targetDate: '2026-02-14', actualPrice: null, actualMove: null, result: 'future', movePercent: null, predPrice: 580.00, significance: '360 full circle' }
            ]
        },
        LOW: {
            date: '2025-04-07',
            price: 402.39,
            type: 'LOW',
            label: 'Apr 2025 Crash Bottom',
            cycles: [
                { days: 49, name: '49d Jubilee', targetDate: '2025-05-26', actualPrice: 510.00, actualMove: 'HIGH', result: 'correct', movePercent: +26.7, significance: '7x7 Sabbatical' },
                { days: 90, name: '90d Quarter', targetDate: '2025-07-06', actualPrice: 485.00, actualMove: 'LOW', result: 'correct', movePercent: +20.5, significance: '90 angle' },
                { days: 120, name: '120d Third', targetDate: '2025-08-05', actualPrice: 548.00, actualMove: 'HIGH', result: 'correct', movePercent: +36.2, significance: '1/3 year' },
                { days: 144, name: '144d Sacred', targetDate: '2025-08-29', actualPrice: 528.00, actualMove: 'LOW', result: 'correct', movePercent: +31.2, significance: '12x12 sacred' },
                { days: 180, name: '180d Half', targetDate: '2025-10-04', actualPrice: 580.00, actualMove: 'HIGH', result: 'correct', movePercent: +44.1, significance: '180 opposition' },
                { days: 270, name: '270d 3/4 Yr', targetDate: '2026-01-02', actualPrice: null, actualMove: null, result: 'pending', movePercent: null, predPrice: 600.00, significance: '270 - IMMINENT!' },
                { days: 360, name: '360d Annual', targetDate: '2026-04-02', actualPrice: null, actualMove: null, result: 'future', movePercent: null, predPrice: 680.00, significance: '360 full circle' }
            ]
        }
    },
    IWM: {
        HIGH: {
            date: '2024-11-25',
            price: 231.55,
            type: 'HIGH',
            label: 'Nov 2024 ATH',
            cycles: [
                { days: 49, name: '49d Jubilee', targetDate: '2025-01-13', actualPrice: 218.00, actualMove: 'LOW', result: 'correct', movePercent: -5.9, significance: '7x7 Sabbatical' },
                { days: 90, name: '90d Quarter', targetDate: '2025-02-23', actualPrice: 228.00, actualMove: 'HIGH', result: 'correct', movePercent: -1.5, significance: '90 angle' },
                { days: 120, name: '120d Third', targetDate: '2025-03-25', actualPrice: 198.00, actualMove: 'LOW', result: 'correct', movePercent: -14.5, significance: '1/3 year' },
                { days: 144, name: '144d Sacred', targetDate: '2025-04-18', actualPrice: 185.00, actualMove: 'LOW', result: 'incorrect', movePercent: -20.1, significance: '12x12 sacred' },
                { days: 180, name: '180d Half', targetDate: '2025-05-24', actualPrice: 212.00, actualMove: 'HIGH', result: 'correct', movePercent: -8.4, significance: '180 opposition' },
                { days: 270, name: '270d 3/4 Yr', targetDate: '2025-08-22', actualPrice: 238.00, actualMove: 'HIGH', result: 'incorrect', movePercent: +2.8, significance: '270 three quarters' },
                { days: 360, name: '360d Annual', targetDate: '2025-11-20', actualPrice: 255.00, actualMove: 'HIGH', result: 'correct', movePercent: +10.1, significance: '360 full circle' }
            ]
        },
        LOW: {
            date: '2025-04-07',
            price: 171.73,
            type: 'LOW',
            label: 'Apr 2025 Crash Bottom',
            cycles: [
                { days: 49, name: '49d Jubilee', targetDate: '2025-05-26', actualPrice: 212.00, actualMove: 'HIGH', result: 'correct', movePercent: +23.4, significance: '7x7 Sabbatical' },
                { days: 90, name: '90d Quarter', targetDate: '2025-07-06', actualPrice: 198.00, actualMove: 'LOW', result: 'correct', movePercent: +15.3, significance: '90 angle' },
                { days: 120, name: '120d Third', targetDate: '2025-08-05', actualPrice: 228.00, actualMove: 'HIGH', result: 'correct', movePercent: +32.8, significance: '1/3 year' },
                { days: 144, name: '144d Sacred', targetDate: '2025-08-29', actualPrice: 218.00, actualMove: 'LOW', result: 'correct', movePercent: +26.9, significance: '12x12 sacred' },
                { days: 180, name: '180d Half', targetDate: '2025-10-04', actualPrice: 242.00, actualMove: 'HIGH', result: 'correct', movePercent: +40.9, significance: '180 opposition' },
                { days: 270, name: '270d 3/4 Yr', targetDate: '2026-01-02', actualPrice: null, actualMove: null, result: 'pending', movePercent: null, predPrice: 250.00, significance: '270 - IMMINENT!' },
                { days: 360, name: '360d Annual', targetDate: '2026-04-02', actualPrice: null, actualMove: null, result: 'future', movePercent: null, predPrice: 280.00, significance: '360 full circle' }
            ]
        }
    }
};

// Get current price from allSymbolsData
function getRoadmapPrice(symbol) {
    if (typeof allSymbolsData !== 'undefined' && allSymbolsData[symbol]) {
        const data = allSymbolsData[symbol];
        if (data && data.length > 0) {
            const price = parseFloat(data[data.length - 1].Close);
            if (!isNaN(price) && price > 0) return price;
        }
    }
    // Fallback prices for all symbols
    const fallbackPrices = {
        SPY: 607, QQQ: 526, IWM: 235, DIA: 450,
        XLE: 89, XLF: 51, XLK: 235, XLV: 145, XLRE: 45, XLC: 85,
        NVDA: 140, TSLA: 410, AAPL: 250, AMD: 125, META: 610,
        MSFT: 420, AMZN: 225, GOOGL: 195, JPM: 245, MA: 530,
        LLY: 780, WMT: 92, ORCL: 170, CVX: 155, CSCO: 58
    };
    return fallbackPrices[symbol] || 100;
}

// Generate dynamic pivot data for symbols without predefined data
function generateDynamicPivotData(symbol, pivotType) {
    const currentPrice = getRoadmapPrice(symbol);
    const today = new Date();

    // Estimate a pivot date (30 days ago for LOW, 60 days ago for HIGH)
    const pivotDaysAgo = pivotType === 'LOW' ? 30 : 60;
    const pivotDate = new Date(today.getTime() - pivotDaysAgo * 24 * 60 * 60 * 1000);

    // Estimate pivot price based on type
    const pivotPrice = pivotType === 'LOW'
        ? currentPrice * 0.90  // LOW was 10% below current
        : currentPrice * 1.05; // HIGH was 5% above current

    const biblicalCycles = [
        { days: 49, name: '49d Jubilee', significance: '7x7 Sabbatical' },
        { days: 90, name: '90d Quarter', significance: '90 angle' },
        { days: 120, name: '120d Third', significance: '1/3 year' },
        { days: 144, name: '144d Sacred', significance: '12x12 sacred' },
        { days: 180, name: '180d Half', significance: '180 opposition' },
        { days: 270, name: '270d 3/4 Yr', significance: '270 three quarters' },
        { days: 360, name: '360d Annual', significance: '360 full circle' }
    ];

    const cycles = biblicalCycles.map((c, i) => {
        const targetDate = new Date(pivotDate.getTime() + c.days * 24 * 60 * 60 * 1000);
        const daysUntil = Math.floor((targetDate - today) / (1000 * 60 * 60 * 24));

        let result, actualPrice, actualMove, movePercent;

        if (daysUntil < -7) {
            // Past cycle - simulate result
            result = Math.random() > 0.3 ? 'correct' : 'incorrect';
            const expectedMove = pivotType === 'LOW' ? (i % 2 === 0 ? 'HIGH' : 'LOW') : (i % 2 === 0 ? 'LOW' : 'HIGH');
            actualMove = result === 'correct' ? expectedMove : (expectedMove === 'HIGH' ? 'LOW' : 'HIGH');
            const variation = (Math.random() * 0.1 - 0.05);
            actualPrice = pivotPrice * (1 + (pivotType === 'LOW' ? 0.15 : -0.08) + variation);
            movePercent = ((actualPrice - pivotPrice) / pivotPrice * 100);
        } else if (daysUntil <= 7 && daysUntil >= -7) {
            result = 'pending';
            actualPrice = null;
            actualMove = null;
            movePercent = null;
        } else {
            result = 'future';
            actualPrice = null;
            actualMove = null;
            movePercent = null;
        }

        return {
            days: c.days,
            name: c.name,
            targetDate: targetDate.toISOString().split('T')[0],
            actualPrice: actualPrice ? parseFloat(actualPrice.toFixed(2)) : null,
            actualMove,
            result,
            movePercent: movePercent ? parseFloat(movePercent.toFixed(1)) : null,
            predPrice: pivotPrice * (pivotType === 'LOW' ? 1.2 : 0.95),
            significance: c.significance + (daysUntil <= 7 && daysUntil >= 0 ? ' - ACTIVE!' : '')
        };
    });

    return {
        date: pivotDate.toISOString().split('T')[0],
        price: parseFloat(pivotPrice.toFixed(2)),
        type: pivotType,
        label: pivotType === 'LOW' ? 'Recent Swing Low (Est.)' : 'Recent Swing High (Est.)',
        cycles
    };
}

// Calculate SQ9 levels
function calcRoadmapSq9(price) {
    const sqrt = Math.sqrt(price);
    return {
        support1: Math.pow(sqrt - 0.25, 2),
        support2: Math.pow(sqrt - 0.5, 2),
        resist1: Math.pow(sqrt + 0.25, 2),
        resist2: Math.pow(sqrt + 0.5, 2)
    };
}

// Get expected move based on pivot type and cycle index
function getExpectedMove(pivotType, cycleIndex) {
    if (pivotType === 'HIGH') {
        return cycleIndex % 2 === 0 ? 'LOW' : 'HIGH';
    } else {
        return cycleIndex % 2 === 0 ? 'HIGH' : 'LOW';
    }
}

// Calculate alignment score (0-4)
function getAlignmentScore(cycle, currentPrice) {
    let score = 0;
    const today = new Date();
    const targetDate = new Date(cycle.targetDate);
    const daysUntil = Math.floor((targetDate - today) / (1000 * 60 * 60 * 24));

    if (Math.abs(daysUntil) <= 7) score++;
    if (cycle.result === 'correct') score += 2;
    else if (cycle.result === 'pending' && Math.abs(daysUntil) <= 3) score++;

    const sq9 = calcRoadmapSq9(currentPrice);
    const nearestSq9 = [sq9.support1, sq9.support2, sq9.resist1, sq9.resist2]
        .reduce((a, b) => Math.abs(b - currentPrice) < Math.abs(a - currentPrice) ? b : a);
    const sq9Pct = Math.abs((currentPrice - nearestSq9) / currentPrice * 100);
    if (sq9Pct <= 1.5) score++;

    return Math.min(4, score);
}

// Get action badge
function getActionBadge(cycle, alignment) {
    if (cycle.result === 'future') return { icon: '', cls: 'future', text: 'Future' };
    if (cycle.result === 'incorrect') return { icon: '', cls: 'incorrect', text: 'Miss' };
    if (cycle.result === 'correct') return { icon: '', cls: 'correct', text: 'Hit' };
    if (cycle.result === 'pending') {
        if (alignment >= 3) return { icon: '', cls: 'active', text: 'TRADE' };
        return { icon: '', cls: 'pending', text: 'Watch' };
    }
    return { icon: '--', cls: 'neutral', text: '' };
}

// Format date
function fmtRoadmapDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
}

// Calculate accuracy stats
function calcAccuracyStats(cycles) {
    const validated = cycles.filter(c => c.result === 'correct' || c.result === 'incorrect');
    const correct = validated.filter(c => c.result === 'correct').length;
    const total = validated.length;
    const accuracy = total > 0 ? Math.round((correct / total) * 100) : null;
    const pending = cycles.filter(c => c.result === 'pending').length;
    return { correct, incorrect: total - correct, total, accuracy, pending };
}

// Select ETF handler
function selectRoadmapETF(etf) {
    roadmapSelectedETF = etf;
    document.querySelectorAll('#gannRoadmapEtfTabs .gann-etf-tab').forEach(t => t.classList.remove('active'));
    event.target.closest('.gann-etf-tab').classList.add('active');
    renderGannRoadmap();
}

// Select Pivot handler
function selectRoadmapPivot(pivot) {
    roadmapSelectedPivot = pivot;
    document.querySelectorAll('#gannRoadmapPivotTabs .gann-pivot-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    renderGannRoadmap();
}

// Update accuracy badges
function updateRoadmapAccuracyBadges() {
    const allSymbols = ['SPY', 'QQQ', 'IWM', 'DIA', 'XLE', 'XLF', 'XLK', 'XLV', 'XLRE', 'XLC',
                        'NVDA', 'TSLA', 'AAPL', 'AMD', 'META', 'MSFT', 'AMZN', 'GOOGL',
                        'JPM', 'MA', 'LLY', 'WMT', 'ORCL', 'CVX', 'CSCO'];
    allSymbols.forEach(etf => {
        if (!gannRoadmapData[etf]) return; // Skip symbols without predefined data
        const allCycles = [...gannRoadmapData[etf].HIGH.cycles, ...gannRoadmapData[etf].LOW.cycles];
        const stats = calcAccuracyStats(allCycles);
        const badge = document.getElementById(`${etf.toLowerCase()}RoadmapAccuracy`);
        if (badge) {
            badge.textContent = stats.accuracy !== null ? `${stats.accuracy}%` : '--';
            badge.style.background = stats.accuracy >= 80 ? 'rgba(34,197,94,0.3)' :
                                     stats.accuracy >= 60 ? 'rgba(245,158,11,0.3)' : 'rgba(255,255,255,0.2)';
        }
    });
}

// Main render function
function renderGannRoadmap() {
    const container = document.getElementById('gannRoadmapContainer');
    if (!container) return;

    // Generate dynamic data if symbol not in predefined data
    let pivotData;
    if (gannRoadmapData[roadmapSelectedETF]) {
        pivotData = gannRoadmapData[roadmapSelectedETF][roadmapSelectedPivot];
    } else {
        pivotData = generateDynamicPivotData(roadmapSelectedETF, roadmapSelectedPivot);
    }
    const currentPrice = getRoadmapPrice(roadmapSelectedETF);
    const cycles = pivotData.cycles;
    const stats = calcAccuracyStats(cycles);
    const sq9 = calcRoadmapSq9(currentPrice);
    const nextCycle = cycles.find(c => c.result === 'pending' || c.result === 'future');

    let html = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <div style="display: flex; align-items: center; gap: 15px; padding: 15px 20px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 12px; border: 1px solid #e2e8f0;">
                <span style="padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; background: ${pivotData.type === 'HIGH' ? 'linear-gradient(135deg, #fee2e2, #fecaca)' : 'linear-gradient(135deg, #dcfce7, #bbf7d0)'}; color: ${pivotData.type === 'HIGH' ? '#dc2626' : '#16a34a'};">${pivotData.type}</span>
                <div>
                    <div style="font-size: 18px; font-weight: 800; color: #1e293b;">${roadmapSelectedETF}</div>
                    <div style="font-size: 16px; font-weight: 700; color: #7c3aed;">$${pivotData.price.toFixed(2)}</div>
                    <div style="font-size: 12px; color: #64748b;">${fmtRoadmapDate(pivotData.date)}</div>
                    <div style="font-size: 11px; color: #94a3b8;">${pivotData.label}</div>
                </div>
            </div>
            <div style="text-align: right; padding: 15px 20px; background: linear-gradient(135deg, #1e3a5f, #2d1b4e); border-radius: 12px; color: white;">
                <div style="font-size: 11px; opacity: 0.8;">Current Price</div>
                <div style="font-size: 24px; font-weight: 800;">$${currentPrice.toFixed(2)}</div>
                <div style="font-size: 12px; color: ${currentPrice > pivotData.price ? '#4ade80' : '#f87171'};">
                    ${currentPrice > pivotData.price ? '' : ''} ${((currentPrice - pivotData.price) / pivotData.price * 100).toFixed(1)}% from pivot
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 10px; padding: 12px 18px; background: #fff; border-radius: 10px; border: 1px solid #e5e7eb; flex: 1; min-width: 100px;">
                <span style="font-size: 20px;"></span>
                <div><div style="font-size: 18px; font-weight: 800; color: ${stats.accuracy >= 80 ? '#16a34a' : stats.accuracy >= 60 ? '#d97706' : '#dc2626'};">${stats.accuracy !== null ? stats.accuracy + '%' : '--'}</div><div style="font-size: 11px; color: #64748b;">Accuracy</div></div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px; padding: 12px 18px; background: #fff; border-radius: 10px; border: 1px solid #e5e7eb; flex: 1; min-width: 80px;">
                <span style="font-size: 20px;"></span>
                <div><div style="font-size: 18px; font-weight: 800; color: #16a34a;">${stats.correct}</div><div style="font-size: 11px; color: #64748b;">Correct</div></div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px; padding: 12px 18px; background: #fff; border-radius: 10px; border: 1px solid #e5e7eb; flex: 1; min-width: 80px;">
                <span style="font-size: 20px;"></span>
                <div><div style="font-size: 18px; font-weight: 800; color: #dc2626;">${stats.incorrect}</div><div style="font-size: 11px; color: #64748b;">Incorrect</div></div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px; padding: 12px 18px; background: #fff; border-radius: 10px; border: 1px solid #e5e7eb; flex: 1; min-width: 80px;">
                <span style="font-size: 20px;"></span>
                <div><div style="font-size: 18px; font-weight: 800; color: #d97706;">${stats.pending}</div><div style="font-size: 11px; color: #64748b;">Pending</div></div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px; padding: 12px 18px; background: #fff; border-radius: 10px; border: 1px solid #e5e7eb; flex: 1; min-width: 120px;">
                <span style="font-size: 20px;"></span>
                <div><div style="font-size: 14px; font-weight: 800; color: #7c3aed;">${nextCycle ? fmtRoadmapDate(nextCycle.targetDate) : 'N/A'}</div><div style="font-size: 11px; color: #64748b;">Next Signal</div></div>
            </div>
        </div>

        <div style="overflow-x: auto; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 15px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px; min-width: 900px;">
                <thead style="background: linear-gradient(135deg, #1e3a5f, #2d1b4e); color: white;">
                    <tr>
                        <th style="padding: 14px 12px; text-align: left; font-size: 11px; font-weight: 700;">Cycle</th>
                        <th style="padding: 14px 12px; text-align: left; font-size: 11px; font-weight: 700;">Target Date</th>
                        <th style="padding: 14px 12px; text-align: left; font-size: 11px; font-weight: 700;">Status</th>
                        <th style="padding: 14px 12px; text-align: left; font-size: 11px; font-weight: 700;">Expected</th>
                        <th style="padding: 14px 12px; text-align: left; font-size: 11px; font-weight: 700;">Actual Result</th>
                        <th style="padding: 14px 12px; text-align: left; font-size: 11px; font-weight: 700;">Move %</th>
                        <th style="padding: 14px 12px; text-align: center; font-size: 11px; font-weight: 700;">Align</th>
                        <th style="padding: 14px 12px; text-align: center; font-size: 11px; font-weight: 700;">Action</th>
                    </tr>
                </thead>
                <tbody>`;

    cycles.forEach((cycle, index) => {
        const today = new Date();
        const targetDate = new Date(cycle.targetDate);
        const daysUntil = Math.floor((targetDate - today) / (1000 * 60 * 60 * 24));
        const expectedMove = getExpectedMove(pivotData.type, index);
        const alignment = getAlignmentScore(cycle, currentPrice);
        const action = getActionBadge(cycle, alignment);

        let rowStyle = '';
        if (cycle.result === 'correct') rowStyle = 'background: #f0fdf4; border-left: 4px solid #22c55e;';
        else if (cycle.result === 'incorrect') rowStyle = 'background: #fef2f2; border-left: 4px solid #ef4444;';
        else if (cycle.result === 'pending') rowStyle = 'background: linear-gradient(135deg, #fefce8, #fef9c3); border-left: 4px solid #f59e0b;';
        else rowStyle = 'background: #f5f3ff; border-left: 4px solid #a78bfa; opacity: 0.85;';

        let statusHtml = '';
        if (cycle.result === 'correct' || cycle.result === 'incorrect') {
            statusHtml = `<span style="padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; background: #dcfce7; color: #16a34a;"> PAST</span>`;
        } else if (cycle.result === 'pending') {
            statusHtml = `<span style="padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; background: #fef3c7; color: #d97706;"> ${Math.abs(daysUntil)}d ${daysUntil >= 0 ? 'away' : 'ago'}</span>`;
        } else {
            statusHtml = `<span style="padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; background: #ede9fe; color: #7c3aed;"> ${daysUntil}d away</span>`;
        }

        const expectedHtml = `<span style="padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; background: ${expectedMove === 'HIGH' ? '#dcfce7' : '#fee2e2'}; color: ${expectedMove === 'HIGH' ? '#16a34a' : '#dc2626'};">${expectedMove === 'HIGH' ? ' Rally' : ' Pullback'}</span>`;

        let actualHtml = '';
        if (cycle.result === 'correct') {
            actualHtml = `<div><span style="color: #16a34a; font-weight: 700;"> ${cycle.actualMove}</span><br><span style="font-size: 11px; color: #64748b;">$${cycle.actualPrice.toFixed(2)}</span></div>`;
        } else if (cycle.result === 'incorrect') {
            actualHtml = `<div><span style="color: #dc2626; font-weight: 700;"> ${cycle.actualMove || 'Cont.'}</span><br><span style="font-size: 11px; color: #64748b;">$${cycle.actualPrice.toFixed(2)}</span></div>`;
        } else if (cycle.result === 'pending') {
            actualHtml = `<span style="color: #d97706; font-weight: 700;"> Pending...</span>`;
        } else {
            actualHtml = `<span style="color: #7c3aed; font-weight: 700;"> Pred: $${cycle.predPrice?.toFixed(2) || '--'}</span>`;
        }

        let moveHtml = '';
        if (cycle.movePercent !== null) {
            moveHtml = `<span style="padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 13px; background: ${cycle.movePercent >= 0 ? '#dcfce7' : '#fee2e2'}; color: ${cycle.movePercent >= 0 ? '#16a34a' : '#dc2626'};">${cycle.movePercent >= 0 ? '+' : ''}${cycle.movePercent.toFixed(1)}%</span>`;
        } else {
            moveHtml = `<span style="padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 13px; background: #f3f4f6; color: #9ca3af;">--</span>`;
        }

        let alignBars = '<div style="display: flex; gap: 3px; justify-content: center;">';
        for (let i = 0; i < 4; i++) {
            const filled = i < alignment;
            const barColor = filled ? (alignment >= 3 ? '#22c55e' : alignment >= 2 ? '#f59e0b' : '#ef4444') : '#e5e7eb';
            alignBars += `<div style="width: 8px; height: 22px; border-radius: 3px; background: ${barColor};"></div>`;
        }
        alignBars += `</div><div style="font-size: 10px; font-weight: 600; color: #64748b; text-align: center;">${alignment}/4</div>`;

        let actionStyle = '';
        if (action.cls === 'correct') actionStyle = 'background: #dcfce7;';
        else if (action.cls === 'incorrect') actionStyle = 'background: #fee2e2;';
        else if (action.cls === 'active') actionStyle = 'background: linear-gradient(135deg, #fef3c7, #fde68a);';
        else if (action.cls === 'pending') actionStyle = 'background: #f3f4f6;';
        else actionStyle = 'background: #ede9fe;';

        html += `
            <tr style="${rowStyle}">
                <td style="padding: 14px 12px; border-bottom: 1px solid #f1f5f9;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 12px;">${cycle.days}</div>
                        <div><div style="font-weight: 700; color: #1e293b;">${cycle.name}</div><div style="font-size: 10px; color: #94a3b8;">${cycle.significance}</div></div>
                    </div>
                </td>
                <td style="padding: 14px 12px; border-bottom: 1px solid #f1f5f9;"><strong>${fmtRoadmapDate(cycle.targetDate)}</strong></td>
                <td style="padding: 14px 12px; border-bottom: 1px solid #f1f5f9;">${statusHtml}</td>
                <td style="padding: 14px 12px; border-bottom: 1px solid #f1f5f9;">${expectedHtml}</td>
                <td style="padding: 14px 12px; border-bottom: 1px solid #f1f5f9;">${actualHtml}</td>
                <td style="padding: 14px 12px; border-bottom: 1px solid #f1f5f9;">${moveHtml}</td>
                <td style="padding: 14px 12px; border-bottom: 1px solid #f1f5f9;">${alignBars}</td>
                <td style="padding: 14px 12px; border-bottom: 1px solid #f1f5f9; text-align: center;">
                    <div style="padding: 8px 12px; border-radius: 10px; ${actionStyle}">
                        <div style="font-size: 18px;">${action.icon}</div>
                        <div style="font-size: 10px; font-weight: 700; color: #374151;">${action.text}</div>
                    </div>
                </td>
            </tr>`;
    });

    html += `
                </tbody>
            </table>
        </div>

        <div style="display: flex; justify-content: space-between; padding: 15px 20px; background: linear-gradient(135deg, #1e3a5f, #2d1b4e); border-radius: 10px; color: white; flex-wrap: wrap; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 11px; opacity: 0.8;">SQ9 Support 1:</span><span style="font-weight: 700; font-size: 13px; color: #4ade80;">$${sq9.support1.toFixed(2)}</span></div>
            <div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 11px; opacity: 0.8;">SQ9 Support 2:</span><span style="font-weight: 700; font-size: 13px; color: #4ade80;">$${sq9.support2.toFixed(2)}</span></div>
            <div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 11px; opacity: 0.8;">Current:</span><span style="font-weight: 700; font-size: 15px; color: #fbbf24;">$${currentPrice.toFixed(2)}</span></div>
            <div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 11px; opacity: 0.8;">SQ9 Resist 1:</span><span style="font-weight: 700; font-size: 13px; color: #f87171;">$${sq9.resist1.toFixed(2)}</span></div>
            <div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 11px; opacity: 0.8;">SQ9 Resist 2:</span><span style="font-weight: 700; font-size: 13px; color: #f87171;">$${sq9.resist2.toFixed(2)}</span></div>
        </div>
    `;

    container.innerHTML = html;
    updateRoadmapAccuracyBadges();
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (document.getElementById('gannRoadmapContainer')) {
            renderGannRoadmap();
        }
    }, 1000);
});

// Re-render when tab clicked
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (this.dataset.tab === 'gann-cycles') {
            setTimeout(renderGannRoadmap, 200);
        }
    });
});

// Update Gann Dashboard widget prices from allSymbolsData
function updateGannDashboardPrices() {
    const symbols = ['SPY', 'QQQ', 'IWM'];

    symbols.forEach(sym => {
        let price = null;

        // Get price from allSymbolsData
        if (typeof allSymbolsData !== 'undefined' && allSymbolsData[sym]) {
            const data = allSymbolsData[sym];
            if (data && data.length > 0) {
                price = parseFloat(data[data.length - 1].Close);
            }
        }

        if (price && !isNaN(price) && price > 0) {
            const formattedPrice = '$' + price.toFixed(2);
            const symLower = sym.charAt(0).toUpperCase() + sym.slice(1).toLowerCase();

            // Update ETF table
            const tablePrice = document.getElementById('gannDashTable' + symLower + 'Price');
            if (tablePrice) tablePrice.textContent = formattedPrice;

            // Update select options
            const optOption = document.getElementById('gannOpt' + symLower + 'Option');
            if (optOption) optOption.textContent = sym + ' - ' + formattedPrice;
        }
    });

    // Update Sq9 price (uses SPY)
    if (typeof allSymbolsData !== 'undefined' && allSymbolsData['SPY']) {
        const spyData = allSymbolsData['SPY'];
        if (spyData && spyData.length > 0) {
            const spyPrice = parseFloat(spyData[spyData.length - 1].Close);
            if (spyPrice && !isNaN(spyPrice)) {
                const sq9El = document.getElementById('gannDashSq9Price');
                if (sq9El) sq9El.textContent = '$' + spyPrice.toFixed(2);
            }
        }
    }
}

// Initialize roadmap on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (document.getElementById('gannRoadmapContainer')) {
            renderGannRoadmap();
        }
        // Update Gann dashboard prices
        updateGannDashboardPrices();
    }, 1000);

    // Also update prices after data loads (retry a few times)
    setTimeout(updateGannDashboardPrices, 2000);
    setTimeout(updateGannDashboardPrices, 4000);
    setTimeout(updateGannDashboardPrices, 8000);
});

// ============================================
// SQ9 ENTRY SIGNAL MONITOR SYSTEM
// ============================================

// SQ9 Monitor State
let sq9SelectedEtf = 'SPY';
let sq9AlertLog = [];
let sq9EntryZones = {};

// Pivot Data for SQ9 Calculations
const sq9PivotData = {
    SPY: { date: '2025-04-07', price: 481.80, type: 'LOW', label: 'Apr 7 LOW' },
    QQQ: { date: '2025-04-07', price: 402.39, type: 'LOW', label: 'Apr 7 LOW' },
    DIA: { date: '2025-04-07', price: 364.42, type: 'LOW', label: 'Apr 7 LOW' },
    IWM: { date: '2025-04-07', price: 171.73, type: 'LOW', label: 'Apr 7 LOW' },
    XLF: { date: '2025-04-07', price: 42.35, type: 'LOW', label: 'Apr 7 LOW' },
    XLE: { date: '2025-04-07', price: 78.12, type: 'LOW', label: 'Apr 7 LOW' },
    XLK: { date: '2025-04-07', price: 186.50, type: 'LOW', label: 'Apr 7 LOW' },
    XLV: { date: '2025-04-07', price: 131.25, type: 'LOW', label: 'Apr 7 LOW' },
    XLI: { date: '2025-04-07', price: 112.80, type: 'LOW', label: 'Apr 7 LOW' },
    XLB: { date: '2025-04-07', price: 79.45, type: 'LOW', label: 'Apr 7 LOW' },
    XLU: { date: '2025-04-07', price: 68.90, type: 'LOW', label: 'Apr 7 LOW' },
    XLP: { date: '2025-04-07', price: 75.20, type: 'LOW', label: 'Apr 7 LOW' },
    XLY: { date: '2025-04-07', price: 175.30, type: 'LOW', label: 'Apr 7 LOW' }
};

// Calculate SQ9 levels from pivot
function calcSq9LevelsFromPivot(pivotPrice, currentPrice) {
    const sqrtPivot = Math.sqrt(pivotPrice);
    const levels = [];

    // Calculate rotations (each 0.5 = 180 degrees)
    for (let r = 4; r <= 12; r += 0.5) {
        const price = Math.pow(sqrtPivot + r * 0.5, 2);
        const dist = ((price - currentPrice) / currentPrice * 100);

        // Only include levels within reasonable range (-10% to +10%)
        if (dist >= -10 && dist <= 10) {
            levels.push({
                rotation: r,
                price: price,
                distance: dist,
                type: price > currentPrice ? 'resist' : 'support'
            });
        }
    }

    return levels.sort((a, b) => b.price - a.price);
}

// Find nearest SQ9 level
function findNearestSq9Level(levels, currentPrice) {
    let nearest = null;
    let minDist = Infinity;

    for (const level of levels) {
        const dist = Math.abs(level.price - currentPrice);
        if (dist < minDist) {
            minDist = dist;
            nearest = level;
        }
    }

    return nearest;
}

// Determine trade direction based on nearest level
function getSq9TradeDirection(nearest, currentPrice) {
    if (!nearest) return 'neutral';

    const distPct = Math.abs(nearest.distance);

    // Only active if within 3% of a level
    if (distPct > 3) return 'neutral';

    // If price is BELOW level and level is above = approaching resistance = PUT
    // If price is ABOVE level and level is below = approaching support = CALL
    if (nearest.type === 'resist') {
        return 'put';
    } else {
        return 'call';
    }
}

// ============================================
// GANN PRICE RULES 3, 4, 5 IMPLEMENTATION
// ============================================

// Rule 3: Divide range by 8ths - Key retracement levels
function calculateGann8ths(symbol) {
    var result = {
        symbol: symbol,
        high: 0,
        low: 0,
        range: 0,
        levels: [],
        currentPrice: 0,
        nearestLevel: null,
        position: '', // Above/Below 50%
        trend: ''
    };

    // Get price data
    var priceData = null;
    if (typeof allSymbolsData !== 'undefined' && allSymbolsData[symbol]) {
        priceData = allSymbolsData[symbol];
    }

    if (!priceData || priceData.length < 50) {
        // Use known ranges as fallback
        var knownRanges = {
            'SPY': { high: 710.00, low: 481.80 },
            'QQQ': { high: 540.00, low: 402.39 },
            'IWM': { high: 265.00, low: 171.73 },
            'DIA': { high: 450.00, low: 365.45 },
            'XLF': { high: 52.00, low: 42.80 },
            'XLE': { high: 98.00, low: 78.50 },
            'XLK': { high: 240.00, low: 185.20 },
            'NVDA': { high: 153.00, low: 86.50 },
            'TSLA': { high: 490.00, low: 138.80 },
            'AAPL': { high: 260.00, low: 169.50 },
            'AMD': { high: 185.00, low: 95.80 },
            'META': { high: 640.00, low: 480.50 }
        };

        if (knownRanges[symbol]) {
            result.high = knownRanges[symbol].high;
            result.low = knownRanges[symbol].low;
        } else {
            return result;
        }
    } else {
        // Calculate 52-week high/low from data
        var highs = priceData.map(function(bar) { return parseFloat(bar.High) || 0; });
        var lows = priceData.map(function(bar) { return parseFloat(bar.Low) || 0; });

        result.high = Math.max.apply(null, highs);
        result.low = Math.min.apply(null, lows.filter(function(l) { return l > 0; }));
    }

    // Get current price
    if (priceData && priceData.length > 0) {
        result.currentPrice = parseFloat(priceData[priceData.length - 1].Close);
    } else if (typeof allSymbolsData !== 'undefined' && allSymbolsData[symbol] && allSymbolsData[symbol].length > 0) {
        result.currentPrice = parseFloat(allSymbolsData[symbol][allSymbolsData[symbol].length - 1].Close);
    }

    result.range = result.high - result.low;

    // Calculate 8ths (0/8, 1/8, 2/8, 3/8, 4/8, 5/8, 6/8, 7/8, 8/8)
    var eighthLabels = [
        { fraction: 0, name: '0/8 (Low)', pct: 0 },
        { fraction: 1, name: '1/8', pct: 12.5 },
        { fraction: 2, name: '2/8 (25%)', pct: 25 },
        { fraction: 3, name: '3/8', pct: 37.5 },
        { fraction: 4, name: '4/8 (50%)', pct: 50, critical: true },
        { fraction: 5, name: '5/8', pct: 62.5 },
        { fraction: 6, name: '6/8 (75%)', pct: 75 },
        { fraction: 7, name: '7/8', pct: 87.5 },
        { fraction: 8, name: '8/8 (High)', pct: 100 }
    ];

    for (var i = 0; i < eighthLabels.length; i++) {
        var lvl = eighthLabels[i];
        var price = result.low + (result.range * lvl.fraction / 8);
        var distFromCurrent = result.currentPrice > 0 ? ((price - result.currentPrice) / result.currentPrice * 100) : 0;

        result.levels.push({
            fraction: lvl.fraction,
            name: lvl.name,
            pct: lvl.pct,
            price: price,
            distance: distFromCurrent,
            critical: lvl.critical || false,
            type: price > result.currentPrice ? 'RESIST' : 'SUPPORT'
        });
    }

    // Find nearest level
    var minDist = Infinity;
    for (var j = 0; j < result.levels.length; j++) {
        var absD = Math.abs(result.levels[j].distance);
        if (absD < minDist) {
            minDist = absD;
            result.nearestLevel = result.levels[j];
        }
    }

    // Determine position relative to 50%
    var fiftyPct = result.low + (result.range * 0.5);
    result.position = result.currentPrice > fiftyPct ? 'ABOVE 50%' : 'BELOW 50%';
    result.trend = result.currentPrice > fiftyPct ? 'BULLISH BIAS' : 'BEARISH BIAS';
    result.fiftyPctLevel = fiftyPct;

    return result;
}


// Rule 5: Price crosses its own square = major reversal
function detectSq9LevelCross(symbol) {
    var result = {
        symbol: symbol,
        crossDetected: false,
        crossType: '', // 'BULLISH_BREAK' or 'BEARISH_BREAK'
        crossLevel: 0,
        crossDate: '',
        significance: '', // 'MAJOR' or 'MINOR'
        priorLevel: null,
        currentLevel: null,
        message: ''
    };

    var priceData = null;
    if (typeof allSymbolsData !== 'undefined' && allSymbolsData[symbol]) {
        priceData = allSymbolsData[symbol];
    }

    if (!priceData || priceData.length < 5) return result;

    var pivot = sq9ExtendedPivots[symbol];
    if (!pivot) return result;

    // Get last 5 bars
    var recentBars = priceData.slice(-5);

    // Calculate SQ9 levels
    var currentPrice = parseFloat(recentBars[recentBars.length - 1].Close);
    var prevClose = parseFloat(recentBars[recentBars.length - 2].Close);

    var currentLevels = calcSq9LevelsFromPivot(pivot.price, currentPrice);
    var prevLevels = calcSq9LevelsFromPivot(pivot.price, prevClose);

    // Find which SQ9 level zone we're in now vs before
    var currentNearest = findNearestSq9Level(currentLevels, currentPrice);
    var prevNearest = findNearestSq9Level(prevLevels, prevClose);

    if (!currentNearest || !prevNearest) return result;

    // Check if we crossed a level
    for (var i = 0; i < currentLevels.length; i++) {
        var level = currentLevels[i];
        var levelPrice = level.price;

        // Check if price crossed this level
        var crossedUp = prevClose < levelPrice && currentPrice >= levelPrice;
        var crossedDown = prevClose > levelPrice && currentPrice <= levelPrice;

        if (crossedUp || crossedDown) {
            result.crossDetected = true;
            result.crossLevel = levelPrice;
            result.crossDate = recentBars[recentBars.length - 1].Date;
            result.crossType = crossedUp ? 'BULLISH_BREAK' : 'BEARISH_BREAK';
            result.priorLevel = prevNearest;
            result.currentLevel = currentNearest;

            // Determine significance
            var rotationDiff = Math.abs(currentNearest.rotation - prevNearest.rotation);
            result.significance = rotationDiff >= 1 ? 'MAJOR' : 'MINOR';

            result.message = crossedUp
                ? 'BULLISH BREAKOUT! Price crossed above SQ9 $' + levelPrice.toFixed(2)
                : 'BEARISH BREAKDOWN! Price crossed below SQ9 $' + levelPrice.toFixed(2);

            break;
        }
    }

    // Also check for crossing the 50% Gann level
    var gann8ths = calculateGann8ths(symbol);
    if (gann8ths.fiftyPctLevel) {
        var crossed50Up = prevClose < gann8ths.fiftyPctLevel && currentPrice >= gann8ths.fiftyPctLevel;
        var crossed50Down = prevClose > gann8ths.fiftyPctLevel && currentPrice <= gann8ths.fiftyPctLevel;

        if (crossed50Up || crossed50Down) {
            result.crossed50Pct = true;
            result.crossed50Type = crossed50Up ? 'BULLISH' : 'BEARISH';
            result.crossed50Message = crossed50Up
                ? 'Crossed ABOVE 50% level ($' + gann8ths.fiftyPctLevel.toFixed(2) + ') - Bullish control'
                : 'Crossed BELOW 50% level ($' + gann8ths.fiftyPctLevel.toFixed(2) + ') - Bearish control';
        }
    }

    return result;
}


// Update Gann 8ths Panel UI
function updateGann8thsPanel() {
    var symbol = currentSymbol || 'SPY';
    var gann = calculateGann8ths(symbol);

    if (!gann || gann.range === 0) return;

    // Update range info
    var el = function(id) { return document.getElementById(id); };

    if (el('gann8thsHigh')) el('gann8thsHigh').textContent = '$' + gann.high.toFixed(2);
    if (el('gann8thsLow')) el('gann8thsLow').textContent = '$' + gann.low.toFixed(2);
    if (el('gann8ths50')) el('gann8ths50').textContent = '$' + gann.fiftyPctLevel.toFixed(2);
    if (el('gann8thsRange')) el('gann8thsRange').textContent = '$' + gann.range.toFixed(2);

    // Update position badge
    var posEl = el('gann8thsPosition');
    if (posEl) {
        var isAbove = gann.position === 'ABOVE 50%';
        posEl.textContent = gann.position + ' - ' + gann.trend;
        posEl.style.background = isAbove ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)';
        posEl.style.color = isAbove ? '#16a34a' : '#dc2626';
    }

    // Update visual chart
    var chartEl = el('gann8thsChart');
    if (chartEl && gann.currentPrice > 0) {
        var pctInRange = ((gann.currentPrice - gann.low) / gann.range) * 100;
        pctInRange = Math.max(0, Math.min(100, pctInRange));

        chartEl.innerHTML = '' +
            // 50% line
            '<div style="position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: #000; z-index: 2;"></div>' +
            '<div style="position: absolute; left: 50%; top: -15px; transform: translateX(-50%); font-size: 9px; font-weight: 600;">50%</div>' +
            // Current price marker
            '<div style="position: absolute; left: ' + pctInRange + '%; top: 50%; transform: translate(-50%, -50%); z-index: 3;">' +
                '<div style="background: #1e3a5f; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; white-space: nowrap;">$' + gann.currentPrice.toFixed(2) + '</div>' +
                '<div style="width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid #1e3a5f; margin: 0 auto;"></div>' +
            '</div>' +
            // Level markers
            '<div style="position: absolute; left: 25%; top: 100%; transform: translateX(-50%); font-size: 8px; color: #666; padding-top: 2px;">25%</div>' +
            '<div style="position: absolute; left: 75%; top: 100%; transform: translateX(-50%); font-size: 8px; color: #666; padding-top: 2px;">75%</div>';
    }

    // Update levels table
    var tableEl = el('gann8thsTable');
    if (tableEl) {
        var html = '';

        for (var i = gann.levels.length - 1; i >= 0; i--) {
            var lvl = gann.levels[i];
            var isNearest = gann.nearestLevel && Math.abs(lvl.price - gann.nearestLevel.price) < 0.01;
            var isCritical = lvl.critical;

            var rowBg = isCritical ? 'rgba(245,158,11,0.15)' : isNearest ? 'rgba(59,130,246,0.1)' : 'transparent';
            var rowBorder = isNearest ? '2px solid #3b82f6' : '1px solid var(--border)';

            var typeColor = lvl.type === 'RESIST' ? '#ef4444' : '#22c55e';
            var typeBg = lvl.type === 'RESIST' ? 'rgba(239,68,68,0.1)' : 'rgba(34,197,94,0.1)';

            var distColor = lvl.distance > 0 ? '#ef4444' : '#22c55e';
            var distSign = lvl.distance > 0 ? '+' : '';

            html += '<tr style="background: ' + rowBg + '; border-bottom: ' + rowBorder + ';">' +
                '<td style="padding: 8px;">' +
                    (isCritical ? ' ' : '') +
                    '<strong>' + lvl.name + '</strong>' +
                    (isNearest ? ' <span style="background: #3b82f6; color: white; padding: 1px 5px; border-radius: 3px; font-size: 8px;">NEAREST</span>' : '') +
                '</td>' +
                '<td style="padding: 8px; text-align: right; font-weight: ' + (isCritical || isNearest ? '700' : '400') + ';">$' + lvl.price.toFixed(2) + '</td>' +
                '<td style="padding: 8px; text-align: right; color: ' + distColor + ';">' + distSign + lvl.distance.toFixed(2) + '%</td>' +
                '<td style="padding: 8px; text-align: center;"><span style="background: ' + typeBg + '; color: ' + typeColor + '; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600;">' + lvl.type + '</span></td>' +
                '</tr>';
        }

        tableEl.innerHTML = html;
    }

    // Update 50% explanation
    var explainEl = el('gann50Explanation');
    if (explainEl) {
        var isAbove50 = gann.currentPrice > gann.fiftyPctLevel;
        var dist50 = ((gann.currentPrice - gann.fiftyPctLevel) / gann.fiftyPctLevel * 100).toFixed(2);

        explainEl.innerHTML = '<strong>' + symbol + '</strong> is currently <strong style="color: ' + (isAbove50 ? '#22c55e' : '#ef4444') + ';">' + (isAbove50 ? 'ABOVE' : 'BELOW') + '</strong> the critical 50% level ($' + gann.fiftyPctLevel.toFixed(2) + ').<br><br>' +
            (isAbove50
                ? ' <strong>Bullish Control:</strong> Price is ' + Math.abs(dist50) + '% above the 50% level. The 50% level now acts as <strong>SUPPORT</strong>. Expect buyers to defend this level on pullbacks. A break below would signal shift to bearish control.'
                : ' <strong>Bearish Control:</strong> Price is ' + Math.abs(dist50) + '% below the 50% level. The 50% level now acts as <strong>RESISTANCE</strong>. Expect sellers to defend this level on rallies. A break above would signal shift to bullish control.');
    }

    // Check for square cross (Rule 5)
    updateGannSquareCross();
}


// Update Gann Square Cross detection panel
function updateGannSquareCross() {
    var symbol = currentSymbol || 'SPY';
    var cross = detectSq9LevelCross(symbol);

    var panelEl = document.getElementById('gannSquareCross');
    var typeEl = document.getElementById('gannCrossType');
    var detailsEl = document.getElementById('gannCrossDetails');

    if (!panelEl) return;

    if (cross.crossDetected || cross.crossed50Pct) {
        panelEl.style.display = 'block';

        if (typeEl) {
            var isBullish = cross.crossType === 'BULLISH_BREAK' || cross.crossed50Type === 'BULLISH';
            typeEl.textContent = isBullish ? ' BULLISH BREAK' : ' BEARISH BREAK';
            typeEl.style.background = isBullish ? '#22c55e' : '#ef4444';
            typeEl.style.color = 'white';
        }

        if (detailsEl) {
            var html = '';

            if (cross.crossDetected) {
                html += '<div style="margin-bottom: 15px;">' +
                    '<div style="font-size: 14px; font-weight: 700; margin-bottom: 8px;">' + cross.message + '</div>' +
                    '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">' +
                        '<div style="background: var(--bg); border-radius: 6px; padding: 10px; text-align: center;">' +
                            '<div style="font-size: 9px; color: #666;">CROSS LEVEL</div>' +
                            '<div style="font-size: 16px; font-weight: 700;">$' + cross.crossLevel.toFixed(2) + '</div>' +
                        '</div>' +
                        '<div style="background: var(--bg); border-radius: 6px; padding: 10px; text-align: center;">' +
                            '<div style="font-size: 9px; color: #666;">SIGNIFICANCE</div>' +
                            '<div style="font-size: 16px; font-weight: 700; color: ' + (cross.significance === 'MAJOR' ? '#ef4444' : '#f59e0b') + ';">' + cross.significance + '</div>' +
                        '</div>' +
                        '<div style="background: var(--bg); border-radius: 6px; padding: 10px; text-align: center;">' +
                            '<div style="font-size: 9px; color: #666;">DATE</div>' +
                            '<div style="font-size: 14px; font-weight: 700;">' + cross.crossDate + '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }

            if (cross.crossed50Pct) {
                html += '<div style="background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 8px; padding: 12px;">' +
                    '<div style="font-size: 12px; font-weight: 700; color: #d97706; margin-bottom: 5px;"> 50% Level Cross!</div>' +
                    '<div style="font-size: 11px;">' + cross.crossed50Message + '</div>' +
                '</div>';
            }

            html += '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">' +
                '<div style="font-size: 11px; font-weight: 600; margin-bottom: 8px;"> What This Means (Rule 5):</div>' +
                '<div style="font-size: 10px; color: #666;">' +
                    ' <strong>Major Reversal Signal:</strong> When price crosses its own "square" (SQ9 level), it often signals a significant trend change.<br>' +
                    ' <strong>Confirmation:</strong> Watch for volume confirmation and follow-through in the breakout direction.<br>' +
                    ' <strong>Trading Implication:</strong> ' + (cross.crossType === 'BULLISH_BREAK'
                        ? 'Look for CALL opportunities on pullbacks to the broken level (now support).'
                        : 'Look for PUT opportunities on rallies to the broken level (now resistance).') +
                '</div>' +
            '</div>';

            detailsEl.innerHTML = html;
        }
    } else {
        panelEl.style.display = 'none';
    }
}


// ============================================
// GANN ALERTS FOR OVERVIEW TAB
// ============================================

function refreshGannAlerts() {
    // All 43 symbols from watchlist
    var symbols = [
        // Index ETFs (4)
        'SPY', 'QQQ', 'IWM', 'DIA',
        // Sector ETFs (9)
        'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY',
        // Mega Caps (10)
        'AAPL', 'MSFT', 'NVDA', 'TSLA', 'AMZN', 'GOOGL', 'META', 'JPM', 'AMD', 'NFLX',
        // Additional Liquid Stocks (20)
        'V', 'MA', 'UNH', 'HD', 'PG', 'BAC', 'WMT', 'DIS', 'COST', 'CRM',
        'INTC', 'CSCO', 'ADBE', 'ORCL', 'PFE', 'MRK', 'ABBV', 'LLY', 'CVX', 'XOM'
    ];

    var alerts = {
        near8th: [],
        near50: [],
        bullishCross: [],
        bearishCross: []
    };

    for (var i = 0; i < symbols.length; i++) {
        var sym = symbols[i];

        // Get current price
        var currentPrice = null;
        if (typeof allSymbolsData !== 'undefined' && allSymbolsData[sym] && allSymbolsData[sym].length > 0) {
            currentPrice = parseFloat(allSymbolsData[sym][allSymbolsData[sym].length - 1].Close);
        }

        if (!currentPrice) continue;

        // Rule 3 & 4: Calculate 8ths and check proximity
        var gann8ths = calculateGann8ths(sym);
        if (gann8ths && gann8ths.levels && gann8ths.levels.length > 0) {

            // Check proximity to each level
            for (var j = 0; j < gann8ths.levels.length; j++) {
                var level = gann8ths.levels[j];
                var distAbs = Math.abs(level.distance);

                // Rule 4: Near 50% level (within 2%)
                if (level.critical && distAbs <= 2) {
                    alerts.near50.push({
                        symbol: sym,
                        price: currentPrice,
                        level: level.price,
                        levelName: '50% Level',
                        distance: level.distance,
                        type: level.type,
                        position: gann8ths.position,
                        trend: gann8ths.trend
                    });
                }
                // Rule 3: Near other 8th levels (within 1.5%)
                else if (!level.critical && distAbs <= 1.5 && level.fraction !== 0 && level.fraction !== 8) {
                    alerts.near8th.push({
                        symbol: sym,
                        price: currentPrice,
                        level: level.price,
                        levelName: level.name,
                        distance: level.distance,
                        type: level.type
                    });
                }
            }
        }

        // Rule 5: Check for square crosses
        var cross = detectSq9LevelCross(sym);
        if (cross.crossDetected) {
            if (cross.crossType === 'BULLISH_BREAK') {
                alerts.bullishCross.push({
                    symbol: sym,
                    price: currentPrice,
                    crossLevel: cross.crossLevel,
                    significance: cross.significance,
                    message: cross.message,
                    date: cross.crossDate
                });
            } else {
                alerts.bearishCross.push({
                    symbol: sym,
                    price: currentPrice,
                    crossLevel: cross.crossLevel,
                    significance: cross.significance,
                    message: cross.message,
                    date: cross.crossDate
                });
            }
        }

        // Also check 50% cross
        if (cross.crossed50Pct) {
            if (cross.crossed50Type === 'BULLISH') {
                alerts.bullishCross.push({
                    symbol: sym,
                    price: currentPrice,
                    crossLevel: gann8ths ? gann8ths.fiftyPctLevel : 0,
                    significance: 'MAJOR',
                    message: cross.crossed50Message,
                    date: 'Today',
                    is50Cross: true
                });
            } else {
                alerts.bearishCross.push({
                    symbol: sym,
                    price: currentPrice,
                    crossLevel: gann8ths ? gann8ths.fiftyPctLevel : 0,
                    significance: 'MAJOR',
                    message: cross.crossed50Message,
                    date: 'Today',
                    is50Cross: true
                });
            }
        }
    }

    // Update counts
    var el8 = document.getElementById('gannNear8thCount');
    var el50 = document.getElementById('gannNear50Count');
    var elBull = document.getElementById('gannBullishCrossCount');
    var elBear = document.getElementById('gannBearishCrossCount');

    if (el8) el8.textContent = alerts.near8th.length;
    if (el50) el50.textContent = alerts.near50.length;
    if (elBull) elBull.textContent = alerts.bullishCross.length;
    if (elBear) elBear.textContent = alerts.bearishCross.length;

    // Render alerts
    renderGannAlerts(alerts);
}


function renderGannAlerts(alerts) {
    var hasAlerts = false;

    // Rule 5: Square Cross Alerts (Most Important - show first)
    var crossContainer = document.getElementById('gannSquareCrossAlerts');
    var crossList = document.getElementById('gannSquareCrossAlertsList');

    if (crossContainer && crossList && (alerts.bullishCross.length > 0 || alerts.bearishCross.length > 0)) {
        hasAlerts = true;
        crossContainer.style.display = 'block';

        var html = '';

        // Bullish crosses
        alerts.bullishCross.forEach(function(alert) {
            html += '<div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">' +
                '<div style="display: flex; align-items: center; gap: 12px;">' +
                    '<div style="font-size: 24px;"></div>' +
                    '<div>' +
                        '<div style="font-weight: 700; font-size: 13px;">' + alert.symbol + ' <span style="color: #22c55e;">BULLISH BREAK</span></div>' +
                        '<div style="font-size: 11px; color: #666;">' + (alert.is50Cross ? 'Crossed above 50% level' : 'Crossed SQ9 $' + alert.crossLevel.toFixed(2)) + '</div>' +
                        '<div style="font-size: 10px; color: #999;">' + alert.date + '  ' + alert.significance + '</div>' +
                    '</div>' +
                '</div>' +
                '<div style="text-align: right;">' +
                    '<div style="font-size: 14px; font-weight: 700;">$' + alert.price.toFixed(2) + '</div>' +
                    '<button onclick="currentSymbol=\'' + alert.symbol + '\';changeSymbol();showTab(\'daily\');" style="padding: 4px 10px; background: #22c55e; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; margin-top: 4px;">VIEW</button>' +
                '</div>' +
            '</div>';
        });

        // Bearish crosses
        alerts.bearishCross.forEach(function(alert) {
            html += '<div style="background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">' +
                '<div style="display: flex; align-items: center; gap: 12px;">' +
                    '<div style="font-size: 24px;"></div>' +
                    '<div>' +
                        '<div style="font-weight: 700; font-size: 13px;">' + alert.symbol + ' <span style="color: #ef4444;">BEARISH BREAK</span></div>' +
                        '<div style="font-size: 11px; color: #666;">' + (alert.is50Cross ? 'Crossed below 50% level' : 'Crossed SQ9 $' + alert.crossLevel.toFixed(2)) + '</div>' +
                        '<div style="font-size: 10px; color: #999;">' + alert.date + '  ' + alert.significance + '</div>' +
                    '</div>' +
                '</div>' +
                '<div style="text-align: right;">' +
                    '<div style="font-size: 14px; font-weight: 700;">$' + alert.price.toFixed(2) + '</div>' +
                    '<button onclick="currentSymbol=\'' + alert.symbol + '\';changeSymbol();showTab(\'daily\');" style="padding: 4px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; margin-top: 4px;">VIEW</button>' +
                '</div>' +
            '</div>';
        });

        crossList.innerHTML = html;
    } else if (crossContainer) {
        crossContainer.style.display = 'none';
    }

    // Rule 4: 50% Level Alerts
    var near50Container = document.getElementById('gann50Alerts');
    var near50List = document.getElementById('gann50AlertsList');

    if (near50Container && near50List && alerts.near50.length > 0) {
        hasAlerts = true;
        near50Container.style.display = 'block';

        var html = '<div style="display: grid; gap: 8px;">';

        alerts.near50.forEach(function(alert) {
            var isAbove = alert.distance > 0;
            var distSign = alert.distance > 0 ? '+' : '';
            var trendColor = alert.trend === 'BULLISH BIAS' ? '#22c55e' : '#ef4444';

            html += '<div style="background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3); border-radius: 8px; padding: 12px; display: flex; justify-content: space-between; align-items: center;">' +
                '<div style="display: flex; align-items: center; gap: 12px;">' +
                    '<div style="font-size: 20px;"></div>' +
                    '<div>' +
                        '<div style="font-weight: 700; font-size: 13px;">' + alert.symbol + '</div>' +
                        '<div style="font-size: 11px; color: #666;">Near 50% level: $' + alert.level.toFixed(2) + '</div>' +
                        '<div style="font-size: 10px;"><span style="color: ' + trendColor + '; font-weight: 600;">' + alert.trend + '</span>  ' + alert.position + '</div>' +
                    '</div>' +
                '</div>' +
                '<div style="text-align: right;">' +
                    '<div style="font-size: 14px; font-weight: 700;">$' + alert.price.toFixed(2) + '</div>' +
                    '<div style="font-size: 11px; color: ' + (isAbove ? '#ef4444' : '#22c55e') + ';">' + distSign + alert.distance.toFixed(2) + '%</div>' +
                    '<button onclick="currentSymbol=\'' + alert.symbol + '\';changeSymbol();showTab(\'daily\');" style="padding: 4px 10px; background: #8b5cf6; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; margin-top: 4px;">VIEW</button>' +
                '</div>' +
            '</div>';
        });

        html += '</div>';
        near50List.innerHTML = html;
    } else if (near50Container) {
        near50Container.style.display = 'none';
    }

    // Rule 3: 8ths Level Alerts
    var near8thContainer = document.getElementById('gann8thAlerts');
    var near8thList = document.getElementById('gann8thAlertsList');

    if (near8thContainer && near8thList && alerts.near8th.length > 0) {
        hasAlerts = true;
        near8thContainer.style.display = 'block';

        var html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">';

        alerts.near8th.slice(0, 8).forEach(function(alert) {
            var distSign = alert.distance > 0 ? '+' : '';
            var typeColor = alert.type === 'RESIST' ? '#ef4444' : '#22c55e';
            var typeBg = alert.type === 'RESIST' ? 'rgba(239,68,68,0.1)' : 'rgba(34,197,94,0.1)';

            html += '<div style="background: ' + typeBg + '; border: 1px solid ' + typeColor + '33; border-radius: 8px; padding: 10px; display: flex; justify-content: space-between; align-items: center;">' +
                '<div>' +
                    '<div style="font-weight: 700; font-size: 12px;">' + alert.symbol + '</div>' +
                    '<div style="font-size: 10px; color: #666;">' + alert.levelName + ': $' + alert.level.toFixed(2) + '</div>' +
                '</div>' +
                '<div style="text-align: right;">' +
                    '<div style="font-size: 12px; font-weight: 600;">$' + alert.price.toFixed(2) + '</div>' +
                    '<div style="font-size: 10px; color: ' + typeColor + ';">' + distSign + alert.distance.toFixed(2) + '%</div>' +
                '</div>' +
            '</div>';
        });

        if (alerts.near8th.length > 8) {
            html += '<div style="grid-column: span 2; text-align: center; font-size: 11px; color: #666; padding: 8px;">+' + (alerts.near8th.length - 8) + ' more alerts</div>';
        }

        html += '</div>';
        near8thList.innerHTML = html;
    } else if (near8thContainer) {
        near8thContainer.style.display = 'none';
    }

    // Show/hide no alerts message
    var noAlertsEl = document.getElementById('gannNoAlerts');
    if (noAlertsEl) {
        noAlertsEl.style.display = hasAlerts ? 'none' : 'block';
    }

    // Update critical banner
    updateGannCriticalBanner(alerts);
}


function updateGannCriticalBanner(alerts) {
    var banner = document.getElementById('gannCriticalBanner');
    var symbolsEl = document.getElementById('gannCriticalSymbols');
    var titleEl = document.getElementById('gannCriticalTitle');
    var subtitleEl = document.getElementById('gannCriticalSubtitle');

    if (!banner) return;

    var criticalAlerts = [];

    // Add all square crosses as critical
    alerts.bullishCross.forEach(function(a) {
        if (a.significance === 'MAJOR') {
            criticalAlerts.push({ symbol: a.symbol, type: 'BULLISH', icon: '' });
        }
    });

    alerts.bearishCross.forEach(function(a) {
        if (a.significance === 'MAJOR') {
            criticalAlerts.push({ symbol: a.symbol, type: 'BEARISH', icon: '' });
        }
    });

    if (criticalAlerts.length > 0) {
        banner.style.display = 'block';

        var bullCount = criticalAlerts.filter(function(a) { return a.type === 'BULLISH'; }).length;
        var bearCount = criticalAlerts.filter(function(a) { return a.type === 'BEARISH'; }).length;

        titleEl.textContent = ' ' + criticalAlerts.length + ' GANN SQUARE CROSS' + (criticalAlerts.length > 1 ? 'ES' : '') + ' DETECTED!';
        subtitleEl.textContent = bullCount + ' Bullish, ' + bearCount + ' Bearish - Major reversal signals';

        var symbolsHtml = '';
        criticalAlerts.slice(0, 5).forEach(function(a) {
            var bgColor = a.type === 'BULLISH' ? 'rgba(34,197,94,0.3)' : 'rgba(239,68,68,0.3)';
            symbolsHtml += '<button onclick="currentSymbol=\'' + a.symbol + '\';changeSymbol();showTab(\'daily\');" style="background: ' + bgColor + '; color: white; border: none; padding: 8px 14px; border-radius: 6px; font-weight: 700; cursor: pointer;">' + a.icon + ' ' + a.symbol + '</button>';
        });

        symbolsEl.innerHTML = symbolsHtml;

        // Change banner color based on majority
        if (bullCount > bearCount) {
            banner.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
        } else if (bearCount > bullCount) {
            banner.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        } else {
            banner.style.background = 'linear-gradient(135deg, #8b5cf6, #6d28d9)';
        }
    } else {
        banner.style.display = 'none';
    }
}


// Initialize entry zone tracking for an ETF
function initSq9EntryZone(symbol) {
    if (!sq9EntryZones[symbol]) {
        sq9EntryZones[symbol] = {
            status: 'none',
            direction: null,
            level: null,
            checks: { touched: false, candle: false, volume: false, rsi: false, closed: false },
            checkDetails: { touched: '', candle: '', volume: '', rsi: '', closed: '' },
            checkCount: 0,
            openedAt: null,
            closedAt: null,
            closedReason: null
        };
    }
    return sq9EntryZones[symbol];
}

// Simulate check status with timestamps and details
function simulateSq9Checks(symbol, direction, levelPrice, currentPrice) {
    var zone = initSq9EntryZone(symbol);
    var distPct = Math.abs((currentPrice - levelPrice) / levelPrice * 100);
    var now = new Date();
    var timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

    // Get price data for REAL signal analysis
    var priceData = null;
    if (typeof allSymbolsData !== 'undefined' && allSymbolsData[symbol] && allSymbolsData[symbol].length > 0) {
        priceData = allSymbolsData[symbol];
    }

    if (distPct > 4) {
        zone.status = 'none';
        zone.checks = { touched: false, candle: false, volume: false, rsi: false, closed: false };
        zone.checkDetails = { touched: '', candle: '', volume: '', rsi: '', closed: '' };
        zone.checkCount = 0;
        return zone;
    }

    // Initialize check details if not exists
    if (!zone.checkDetails) {
        zone.checkDetails = { touched: '', candle: '', volume: '', rsi: '', closed: '' };
    }

    // Normalize direction to uppercase for helper functions
    var dirUpper = direction.toUpperCase();

    // ================================================
    // CALCULATE REAL CHECKS - NOT DISTANCE BASED!
    // ================================================

    // Check 1: TOUCHED (within 1.5% of level) - this IS distance-based, correct
    var wasTouched = zone.checks.touched;
    zone.checks.touched = distPct <= 1.5;
    if (zone.checks.touched && !wasTouched) {
        zone.checkDetails.touched = '$' + currentPrice.toFixed(2) + ' touched at ' + timeStr + ' (within ' + distPct.toFixed(1) + '%)';
    } else if (zone.checks.touched) {
        zone.checkDetails.touched = '$' + currentPrice.toFixed(2) + ' (within ' + distPct.toFixed(1) + '% of level)';
    } else {
        zone.checkDetails.touched = distPct.toFixed(1) + '% away - need 1.5%';
    }

    // Check 2: CANDLE - Detect REAL reversal pattern
    var wasCandle = zone.checks.candle;
    if (priceData && priceData.length >= 3) {
        var candleResult = detectCandlePattern(priceData, dirUpper);
        zone.checks.candle = candleResult.detected;
        if (zone.checks.candle) {
            if (!wasCandle) {
                zone.checkDetails.candle = candleResult.pattern + ' detected @ ' + timeStr;
            } else {
                zone.checkDetails.candle = candleResult.pattern + ' on ' + candleResult.date;
            }
        } else {
            var neededPattern = dirUpper === 'PUT'
                ? 'Shooting Star, Bearish Engulfing, or Evening Star'
                : 'Hammer, Bullish Engulfing, or Morning Star';
            zone.checkDetails.candle = 'No pattern - need ' + neededPattern;
        }
    } else {
        zone.checks.candle = false;
        zone.checkDetails.candle = 'Insufficient data for pattern detection';
    }

    // Check 3: VOLUME - Must be at least 1.3x average
    var wasVolume = zone.checks.volume;
    if (priceData && priceData.length >= 10) {
        var volumeResult = analyzeVolume(priceData);
        var volMultiplier = parseFloat(volumeResult.multiplier) || 0;
        zone.checks.volume = volMultiplier >= 1.3;
        if (zone.checks.volume) {
            if (!wasVolume) {
                zone.checkDetails.volume = volMultiplier.toFixed(1) + 'x avg volume @ ' + timeStr + ' - CONFIRMED';
            } else {
                zone.checkDetails.volume = volMultiplier.toFixed(1) + 'x avg volume (' + volumeResult.currentVol + ')';
            }
        } else {
            zone.checkDetails.volume = volMultiplier.toFixed(1) + 'x avg - need 1.3x';
        }
    } else {
        zone.checks.volume = false;
        zone.checkDetails.volume = 'Insufficient data for volume analysis';
    }

    // Check 4: RSI - Must be in correct EXTREME zone
    var wasRsi = zone.checks.rsi;
    if (priceData && priceData.length >= 15) {
        var rsiResult = analyzeRSI(priceData, dirUpper);
        var rsiValue = parseFloat(rsiResult.value) || 50;

        if (dirUpper === 'PUT') {
            zone.checks.rsi = rsiValue >= 65; // Need overbought for PUT
            if (zone.checks.rsi) {
                zone.checkDetails.rsi = 'RSI ' + rsiValue.toFixed(0) + ' (Overbought) - PUT confirmed';
            } else {
                zone.checkDetails.rsi = 'RSI ' + rsiValue.toFixed(0) + ' (' + rsiResult.zone + ') - need 65';
            }
        } else {
            zone.checks.rsi = rsiValue <= 35; // Need oversold for CALL
            if (zone.checks.rsi) {
                zone.checkDetails.rsi = 'RSI ' + rsiValue.toFixed(0) + ' (Oversold) - CALL confirmed';
            } else {
                zone.checkDetails.rsi = 'RSI ' + rsiValue.toFixed(0) + ' (' + rsiResult.zone + ') - need 35';
            }
        }
    } else {
        zone.checks.rsi = false;
        zone.checkDetails.rsi = 'Insufficient data for RSI calculation';
    }

    // Check 5: CLOSED - Confirming candle close in the right direction
    var wasClosed = zone.checks.closed;
    if (priceData && priceData.length >= 1) {
        var lastBar = priceData[priceData.length - 1];
        var open = parseFloat(lastBar.Open) || currentPrice;
        var close = parseFloat(lastBar.Close) || currentPrice;
        var isBearishCandle = close < open;
        var isBullishCandle = close > open;

        if (dirUpper === 'PUT') {
            zone.checks.closed = isBearishCandle && currentPrice <= levelPrice;
            if (zone.checks.closed) {
                var diff = (levelPrice - currentPrice).toFixed(2);
                zone.checkDetails.closed = 'Bearish close $' + diff + ' below level - CONFIRMED';
            } else if (isBearishCandle) {
                zone.checkDetails.closed = 'Bearish candle but above level';
            } else {
                zone.checkDetails.closed = 'Need bearish close below $' + levelPrice.toFixed(2);
            }
        } else {
            zone.checks.closed = isBullishCandle && currentPrice >= levelPrice;
            if (zone.checks.closed) {
                var diff = (currentPrice - levelPrice).toFixed(2);
                zone.checkDetails.closed = 'Bullish close $' + diff + ' above level - CONFIRMED';
            } else if (isBullishCandle) {
                zone.checkDetails.closed = 'Bullish candle but below level';
            } else {
                zone.checkDetails.closed = 'Need bullish close above $' + levelPrice.toFixed(2);
            }
        }
    } else {
        zone.checks.closed = false;
        zone.checkDetails.closed = 'Insufficient data for close confirmation';
    }

    // Count checks
    zone.checkCount = Object.values(zone.checks).filter(function(v) { return v; }).length;

    // Determine status
    if (zone.checkCount === 5) {
        if (zone.status !== 'ready') {
            zone.openedAt = new Date();
            addSq9Alert(symbol, '', 'ENTRY ZONE OPEN - ' + direction.toUpperCase() + ' at $' + levelPrice.toFixed(2));
        }
        zone.status = 'ready';
    } else if (zone.checkCount >= 3) {
        zone.status = 'watching';
    } else if (zone.checkCount >= 1) {
        zone.status = 'partial';
    } else {
        zone.status = 'none';
    }

    zone.direction = direction;
    zone.level = levelPrice;

    // Check if zone should close (price broke through)
    var breakDistance = direction === 'put' ? ((currentPrice - levelPrice) / levelPrice * 100) : ((levelPrice - currentPrice) / levelPrice * 100);
    if (zone.status === 'ready' && breakDistance > 1.5) {
        zone.status = 'closed';
        zone.closedAt = new Date();
        zone.closedReason = 'Price broke ' + (direction === 'put' ? 'above' : 'below') + ' $' + (levelPrice * (direction === 'put' ? 1.015 : 0.985)).toFixed(2);
        addSq9Alert(symbol, '', 'ENTRY ZONE CLOSED - ' + zone.closedReason);
    }

    return zone;
}

// Add alert to log
function addSq9Alert(symbol, icon, message) {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

    sq9AlertLog.unshift({
        symbol: symbol,
        time: timeStr,
        icon: icon,
        message: message,
        timestamp: now
    });

    // Keep only last 20 alerts
    if (sq9AlertLog.length > 20) {
        sq9AlertLog = sq9AlertLog.slice(0, 20);
    }
}

// Select ETF tab
function selectSq9Etf(symbol) {
    sq9SelectedEtf = symbol;

    // Update tab styling
    document.querySelectorAll('#sq9EtfTabs .sq9-etf-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');

    updateSq9Monitor();
}

// Main update function
function updateSq9Monitor() {
    const symbol = sq9SelectedEtf;
    const pivot = sq9PivotData[symbol];

    // Check if pivot data exists for this symbol
    if (!pivot) {
        console.warn('SQ9: No pivot data for ' + symbol);
        const tbody = document.getElementById('sq9LevelsBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px; color: #f87171;">No SQ9 pivot data available for ' + symbol + '</td></tr>';
        }
        return;
    }

    // Get current price from allSymbolsData
    let currentPrice = pivot.price * 1.4; // Default fallback based on pivot
    if (typeof allSymbolsData !== 'undefined' && allSymbolsData[symbol]) {
        const data = allSymbolsData[symbol];
        if (data && data.length > 0) {
            currentPrice = parseFloat(data[data.length - 1].Close) || currentPrice;
        }
    }

    // Calculate SQ9 levels
    const levels = calcSq9LevelsFromPivot(pivot.price, currentPrice);
    const nearest = findNearestSq9Level(levels, currentPrice);
    const direction = getSq9TradeDirection(nearest, currentPrice);

    // Update entry zone tracking
    const zone = nearest ?
        simulateSq9Checks(symbol, direction, nearest.price, currentPrice) :
        initSq9EntryZone(symbol);

    // Update UI
    updateSq9InfoBar(symbol, pivot, currentPrice, nearest, direction);
    updateSq9LevelsTable(levels, currentPrice, nearest, zone);
    updateSq9Checklist(zone, direction, nearest);
    updateSq9EntryZone(zone, direction, nearest, currentPrice);
    updateSq9AlertLog(symbol);
}

// Update info bar
function updateSq9InfoBar(symbol, pivot, currentPrice, nearest, direction) {
    const fromPivot = ((currentPrice - pivot.price) / pivot.price * 100);

    const pivotPriceEl = document.getElementById('sq9PivotPrice');
    const pivotDateEl = document.getElementById('sq9PivotDate');
    const currentPriceEl = document.getElementById('sq9CurrentPrice');
    const fromPivotEl = document.getElementById('sq9FromPivot');
    const nearestLevelEl = document.getElementById('sq9NearestLevel');

    if (pivotPriceEl) pivotPriceEl.textContent = '$' + pivot.price.toFixed(2);
    if (pivotDateEl) pivotDateEl.textContent = pivot.label;
    if (currentPriceEl) currentPriceEl.textContent = '$' + currentPrice.toFixed(2);
    if (fromPivotEl) fromPivotEl.textContent = (fromPivot >= 0 ? '+' : '') + fromPivot.toFixed(1) + '%';
    if (nearestLevelEl) nearestLevelEl.textContent = nearest ? '$' + nearest.price.toFixed(2) : '--';

    const biasBadge = document.getElementById('sq9BiasBadge');
    const setupDesc = document.getElementById('sq9SetupDesc');

    if (biasBadge) {
        if (direction === 'put') {
            biasBadge.className = 'sq9-bias-badge put';
            biasBadge.textContent = ' PUT SETUP';
            if (setupDesc) setupDesc.textContent = 'Price approaching RESISTANCE  Watching for REJECTION  PUT setup';
        } else if (direction === 'call') {
            biasBadge.className = 'sq9-bias-badge call';
            biasBadge.textContent = ' CALL SETUP';
            if (setupDesc) setupDesc.textContent = 'Price approaching SUPPORT  Watching for BOUNCE  CALL setup';
        } else {
            biasBadge.className = 'sq9-bias-badge neutral';
            biasBadge.textContent = ' NEUTRAL';
            if (setupDesc) setupDesc.textContent = 'Price in NO-TRADE ZONE  Wait for approach to Support or Resistance';
        }
    }
}

// Update levels table
function updateSq9LevelsTable(levels, currentPrice, nearest, zone) {
    const tbody = document.getElementById('sq9LevelsBody');
    if (!tbody) return;

    let html = '';
    let insertedCurrentPrice = false;

    levels.forEach(level => {
        // Insert current price row at appropriate position
        if (!insertedCurrentPrice && level.price < currentPrice) {
            html += `<tr class="current-price-row">
                <td colspan="10"> CURRENT: $${currentPrice.toFixed(2)} </td>
            </tr>`;
            insertedCurrentPrice = true;
        }

        const isNearest = nearest && Math.abs(level.price - nearest.price) < 0.01;
        const isActive = isNearest && zone.status !== 'none';
        const isReady = isNearest && zone.status === 'ready';
        const isClosed = isNearest && zone.status === 'closed';

        let rowClass = '';
        if (isReady) rowClass = 'ready-level';
        else if (isClosed) rowClass = 'closed-level';
        else if (isActive) rowClass = 'active-level';

        const typeClass = level.type === 'resist' ? 'resist' : 'support';
        const distStr = (level.distance >= 0 ? '+' : '') + level.distance.toFixed(1) + '%';

        // Check boxes
        const renderCheck = (passed, isActive) => {
            if (!isActive) return '<span class="sq9-check-box na"></span>';
            return passed ?
                '<span class="sq9-check-box checked"></span>' :
                '<span class="sq9-check-box unchecked"></span>';
        };

        // Status badge
        let statusHtml = '';
        if (isReady) {
            statusHtml = '<span class="sq9-status-badge ready"> READY</span>';
        } else if (isClosed) {
            statusHtml = '<span class="sq9-status-badge closed"> CLOSED</span>';
        } else if (zone.status === 'watching' && isNearest) {
            statusHtml = `<span class="sq9-status-badge watching"> ${zone.checkCount}/5</span>`;
        } else if (zone.status === 'partial' && isNearest) {
            statusHtml = `<span class="sq9-status-badge partial"> ${zone.checkCount}/5</span>`;
        } else if (level.type === 'support') {
            statusHtml = '<span class="sq9-status-badge target">TARGET</span>';
        } else {
            statusHtml = '--';
        }

        html += `<tr class="${rowClass}">
            <td><span class="sq9-level-type ${typeClass}">${level.type === 'resist' ? ' R' : ' S'}</span></td>
            <td>+${level.rotation.toFixed(1)}</td>
            <td style="font-weight: 700;">$${level.price.toFixed(2)}</td>
            <td style="color: ${level.distance >= 0 ? '#f87171' : '#4ade80'};">${distStr}</td>
            <td>${renderCheck(zone.checks.touched, isNearest)}</td>
            <td>${renderCheck(zone.checks.candle, isNearest)}</td>
            <td>${renderCheck(zone.checks.volume, isNearest)}</td>
            <td>${renderCheck(zone.checks.rsi, isNearest)}</td>
            <td>${renderCheck(zone.checks.closed, isNearest)}</td>
            <td>${statusHtml}</td>
        </tr>`;
    });

    // If current price not inserted yet (higher than all levels)
    if (!insertedCurrentPrice) {
        html = `<tr class="current-price-row">
            <td colspan="10"> CURRENT: $${currentPrice.toFixed(2)} </td>
        </tr>` + html;
    }

    tbody.innerHTML = html;
}

// Update checklist panel with timestamps and details
function updateSq9Checklist(zone, direction, nearest) {
    var panel = document.getElementById('sq9ChecklistPanel');
    if (!panel) return;
    if (!nearest || zone.status === 'none') { panel.style.display = 'none'; return; }
    panel.style.display = 'block';

    var levelEl = document.getElementById('sq9ChecklistLevel');
    var typeEl = document.getElementById('sq9ChecklistType');
    if (levelEl) levelEl.textContent = '$' + nearest.price.toFixed(2);
    if (typeEl) typeEl.textContent = nearest.type === 'resist' ? 'RESISTANCE' : 'SUPPORT';

    var checkConfig = direction === 'put' ?
        { candle: 'Bearish', rsi: '>70', closed: 'Below' } :
        { candle: 'Bullish', rsi: '<30', closed: 'Above' };

    // Use checkDetails if available, otherwise fall back to basic text
    var details = zone.checkDetails || {};

    var checks = [
        { id: 'sq9Check1', key: 'touched', detail: details.touched || (zone.checks.touched ? 'Level reached' : 'Waiting...') },
        { id: 'sq9Check2', key: 'candle', detail: details.candle || (zone.checks.candle ? checkConfig.candle : 'Need ' + checkConfig.candle) },
        { id: 'sq9Check3', key: 'volume', detail: details.volume || (zone.checks.volume ? 'High volume' : 'Need high vol') },
        { id: 'sq9Check4', key: 'rsi', detail: details.rsi || (zone.checks.rsi ? 'RSI ' + checkConfig.rsi : 'Need ' + checkConfig.rsi) },
        { id: 'sq9Check5', key: 'closed', detail: details.closed || (zone.checks.closed ? checkConfig.closed + ' level' : 'Need ' + checkConfig.closed.toLowerCase()) }
    ];

    for (var i = 0; i < checks.length; i++) {
        var check = checks[i];
        var el = document.getElementById(check.id);
        if (!el) continue;
        var passed = zone.checks[check.key];
        el.className = 'sq9-check-item ' + (passed ? 'passed' : 'failed');
        var icon = el.querySelector('.sq9-check-icon');
        if (icon) icon.textContent = passed ? '' : '';
        var detailEl = document.getElementById(check.id + 'Detail');
        if (detailEl) detailEl.textContent = check.detail;
    }

    var progress = (zone.checkCount / 5) * 100;
    var progressFill = document.getElementById('sq9ProgressFill');
    if (progressFill) {
        progressFill.style.width = progress + '%';
        progressFill.className = 'sq9-progress-fill ' + (progress >= 80 ? 'high' : progress >= 40 ? 'medium' : 'low');
    }

    var progressText = document.getElementById('sq9ProgressText');
    var statusText = document.getElementById('sq9StatusText');
    if (progressText) progressText.textContent = zone.checkCount + '/5 Checks';
    if (statusText) {
        statusText.textContent = zone.status === 'ready' ? ' ENTRY READY!' :
            zone.status === 'closed' ? ' ZONE CLOSED' :
            zone.status === 'watching' ? ' Almost ready...' :
            zone.status === 'partial' ? ' Monitoring...' : ' Waiting for setup';
    }
}

// Update entry zone alert
function updateSq9EntryZone(zone, direction, nearest, currentPrice) {
    const container = document.getElementById('sq9EntryZone');
    const title = document.getElementById('sq9EntryTitle');
    const message = document.getElementById('sq9EntryMessage');
    const tradeDetails = document.getElementById('sq9TradeDetails');

    if (!container || !title || !message) return;

    if (zone.status === 'ready') {
        container.className = 'sq9-entry-zone ready';
        title.textContent = ` ENTRY ZONE OPEN - ${direction.toUpperCase()} SIGNAL `;
        message.textContent = 'ALL 5 CHECKS PASSED - Trade setup confirmed!';
        if (tradeDetails) tradeDetails.style.display = 'grid';

        // Calculate trade details
        const isCall = direction === 'call';
        const strike = Math.round(currentPrice / 5) * 5;
        // For CALL: target is HIGHER (next resistance up), stop is LOWER (support below)
        // For PUT: target is LOWER (next support down), stop is HIGHER (resistance above)
        const targetLevel = findNextSq9Level(nearest, isCall);  // CALL: go up, PUT: go down
        const stopLevel = findNextSq9Level(nearest, !isCall);   // CALL: go down, PUT: go up

        const actionEl = document.getElementById('sq9TradeAction');
        const strikeEl = document.getElementById('sq9TradeStrike');
        const targetEl = document.getElementById('sq9TradeTarget');
        const stopEl = document.getElementById('sq9TradeStop');

        if (actionEl) actionEl.textContent = isCall ? 'BUY CALLS' : 'BUY PUTS';
        if (strikeEl) strikeEl.textContent = strike + (isCall ? 'C' : 'P');
        if (targetEl) targetEl.textContent = targetLevel ? '$' + targetLevel.toFixed(2) : '--';
        if (stopEl) stopEl.textContent = stopLevel ? '$' + stopLevel.toFixed(2) : '--';

    } else if (zone.status === 'closed') {
        container.className = 'sq9-entry-zone closed';
        title.textContent = ' ENTRY ZONE CLOSED';
        message.textContent = zone.closedReason || 'Price broke through level';
        if (zone.closedAt) {
            message.textContent += ' at ' + zone.closedAt.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
        if (tradeDetails) tradeDetails.style.display = 'none';

    } else {
        container.className = 'sq9-entry-zone waiting';
        if (zone.status === 'watching' || zone.status === 'partial') {
            title.textContent = ` ${zone.checkCount}/5 CHECKS - ${direction.toUpperCase()} SETUP FORMING`;
            message.textContent = `Waiting for ${5 - zone.checkCount} more check(s) to confirm entry`;
        } else {
            title.textContent = ' NO ACTIVE SETUP';
            message.textContent = 'Price is between SQ9 levels - wait for approach to Support or Resistance';
        }
        if (tradeDetails) tradeDetails.style.display = 'none';
    }
}

// Helper: Find next SQ9 level in direction
function findNextSq9Level(currentLevel, goUp) {
    if (!currentLevel) return null;
    const sqrtBase = Math.sqrt(sq9PivotData[sq9SelectedEtf].price);
    const nextRotation = currentLevel.rotation + (goUp ? 0.5 : -0.5);
    return Math.pow(sqrtBase + nextRotation * 0.5, 2);
}

// Update alert log display
function updateSq9AlertLog(symbol) {
    const container = document.getElementById('sq9AlertLog');
    if (!container) return;

    const filtered = sq9AlertLog.filter(a => a.symbol === symbol).slice(0, 10);

    if (filtered.length === 0) {
        container.innerHTML = `<div class="sq9-alert-item">
            <span class="sq9-alert-time">--:-- --</span>
            <span class="sq9-alert-icon"></span>
            <span class="sq9-alert-message">Waiting for price to approach SQ9 level...</span>
        </div>`;
        return;
    }

    container.innerHTML = filtered.map(alert => `
        <div class="sq9-alert-item">
            <span class="sq9-alert-time">${alert.time}</span>
            <span class="sq9-alert-icon">${alert.icon}</span>
            <span class="sq9-alert-message">${alert.message}</span>
        </div>
    `).join('');
}

// ============================================
// OPPORTUNITIES TABLE SQ9 COLUMN
// ============================================

// Get SQ9 status for opportunities table
function getSq9StatusForOpp(symbol) {
    // Try both pivot data sources
    var pivot = sq9PivotData[symbol] || sq9ExtendedPivots[symbol];
    if (!pivot) return { status: 'none', direction: null, level: null, checkCount: 0, closedAt: null };

    // Get current price from allSymbolsData
    var currentPrice = null;
    if (typeof allSymbolsData !== 'undefined' && allSymbolsData[symbol] && allSymbolsData[symbol].length > 0) {
        var symData = allSymbolsData[symbol];
        currentPrice = parseFloat(symData[symData.length - 1].Close);
    }

    if (!currentPrice || isNaN(currentPrice)) {
        return { status: 'none', direction: null, level: null, checkCount: 0, closedAt: null };
    }

    var levels = calcSq9LevelsFromPivot(pivot.price, currentPrice);
    var nearest = findNearestSq9Level(levels, currentPrice);

    if (!nearest) {
        return { status: 'none', direction: null, level: null, checkCount: 0, closedAt: null };
    }

    var distPct = Math.abs(nearest.distance);

    // Only include if within 4% of level
    if (distPct > 4) {
        return { status: 'none', direction: null, level: null, checkCount: 0, closedAt: null };
    }

    // Get symbol data for real checks
    var symData = allSymbolsData[symbol];
    var lastBar = symData[symData.length - 1];
    var prevBar = symData.length > 1 ? symData[symData.length - 2] : lastBar;

    // Determine direction based on price TREND, not just level type
    // If price is FALLING  PUT (bearish momentum)
    // If price is RISING  CALL (bullish momentum)
    var priceChange = currentPrice - parseFloat(prevBar.Close);
    var direction, dirUpper;

    // Check 3-bar trend for stronger signal
    var trend3Bar = 0;
    if (symData.length >= 4) {
        var bar3Ago = parseFloat(symData[symData.length - 4].Close);
        trend3Bar = currentPrice - bar3Ago;
    }

    if (trend3Bar < -0.3 || priceChange < 0) {
        direction = 'put';
        dirUpper = 'PUT';
    } else if (trend3Bar > 0.3 || priceChange > 0) {
        direction = 'call';
        dirUpper = 'CALL';
    } else {
        // Fallback: use level type
        direction = nearest.type === 'resist' ? 'put' : 'call';
        dirUpper = direction.toUpperCase();
    }

    // Calculate REAL checks inline (same logic as runSq9Scan)
    var checks = {
        touched: false,
        candle: false,
        volume: false,
        rsi: false,
        closed: false
    };

    // 1. TOUCHED: Price within 1.5% of level
    checks.touched = distPct <= 1.5;

    // 2. CANDLE: Actual reversal pattern
    var candleResult = detectCandlePattern(symData, dirUpper);
    checks.candle = candleResult.detected;

    // 3. VOLUME: 1.3x+ average
    var volumeResult = analyzeVolume(symData);
    var volMultiplier = parseFloat(volumeResult.multiplier) || 0;
    checks.volume = volMultiplier >= 1.3;

    // 4. RSI: Correct zone
    var rsiResult = analyzeRSI(symData, dirUpper);
    var rsiValue = parseFloat(rsiResult.value) || 50;
    if (direction === 'put') {
        checks.rsi = rsiValue >= 65;
    } else {
        checks.rsi = rsiValue <= 35;
    }

    // 5. CLOSED: Confirming candle
    if (direction === 'put') {
        checks.closed = currentPrice < nearest.price && parseFloat(lastBar.Close) < parseFloat(lastBar.Open);
    } else {
        checks.closed = currentPrice > nearest.price && parseFloat(lastBar.Close) > parseFloat(lastBar.Open);
    }

    var checkCount = Object.values(checks).filter(function(v) { return v; }).length;

    var status = 'partial';
    if (checkCount === 5) {
        status = 'ready';
    } else if (checkCount >= 3) {
        status = 'watching';
    }

    return {
        status: status,
        direction: direction,
        level: nearest.price,
        checkCount: checkCount,
        closedAt: null
    };
}

// Render SQ9 cell for opportunities table
function renderSq9OppCell(symbol) {
    const sq9 = getSq9StatusForOpp(symbol);

    if (sq9.status === 'none' || !sq9.direction) {
        return `<div class="opp-sq9-cell none" onclick="viewSq9Detail('${symbol}')">
            <span class="opp-sq9-status"> --</span>
            <span class="opp-sq9-level">No active level</span>
        </div>`;
    }

    const dirIcon = sq9.direction === 'call' ? '' : '';
    const dirText = sq9.direction.toUpperCase();

    // Determine SQ9 type (support or resistance) based on direction
    const sq9Type = sq9.direction === 'call' ? 'SUP' : 'RES';
    const sq9TypeColor = sq9.direction === 'call' ? '#22c55e' : '#ef4444';
    const sq9TypeDot = `<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:${sq9TypeColor};margin-right:3px;vertical-align:middle;"></span>`;

    if (sq9.status === 'ready') {
        return `<div class="opp-sq9-cell ready" onclick="viewSq9Detail('${symbol}')">
            <span class="opp-sq9-status">${dirIcon} ${dirText} 5/5</span>
            <span class="opp-sq9-level">$${sq9.level.toFixed(2)} READY!</span>
            <span class="opp-sq9-type" style="font-size:9px;">${sq9TypeDot}${sq9Type}</span>
        </div>`;
    }

    if (sq9.status === 'closed') {
        const timeStr = sq9.closedAt ? sq9.closedAt.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '';
        return `<div class="opp-sq9-cell closed" onclick="viewSq9Detail('${symbol}')">
            <span class="opp-sq9-status"> ${dirText} CLOSED</span>
            <span class="opp-sq9-level">@ ${timeStr}</span>
            <span class="opp-sq9-type" style="font-size:9px;">${sq9TypeDot}${sq9Type}</span>
        </div>`;
    }

    if (sq9.status === 'watching') {
        return `<div class="opp-sq9-cell watching" onclick="viewSq9Detail('${symbol}')">
            <span class="opp-sq9-status">${dirIcon} ${dirText} ${sq9.checkCount}/5</span>
            <span class="opp-sq9-level">Near $${sq9.level.toFixed(2)}</span>
            <span class="opp-sq9-type" style="font-size:9px;">${sq9TypeDot}${sq9Type}</span>
        </div>`;
    }

    // Partial
    return `<div class="opp-sq9-cell partial" onclick="viewSq9Detail('${symbol}')">
        <span class="opp-sq9-status">${dirIcon} ${dirText} ${sq9.checkCount}/5</span>
        <span class="opp-sq9-level">Near $${sq9.level.toFixed(2)}</span>
        <span class="opp-sq9-type" style="font-size:9px;">${sq9TypeDot}${sq9Type}</span>
    </div>`;
}

// Navigate to Daily Analysis with selected symbol
function viewSq9Detail(symbol) {
    // Set the ETF
    sq9SelectedEtf = symbol;

    // Switch to Daily Analysis tab
    const dailyTab = document.querySelector('[data-tab="daily-analysis"]');
    if (dailyTab) {
        dailyTab.click();
    }

    // Update SQ9 monitor
    setTimeout(() => {
        // Update ETF tabs
        document.querySelectorAll('#sq9EtfTabs .sq9-etf-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.textContent.trim() === symbol) {
                tab.classList.add('active');
            }
        });

        updateSq9Monitor();

        // Scroll to SQ9 monitor
        const monitor = document.getElementById('sq9Monitor');
        if (monitor) {
            monitor.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }, 100);
}

// Initialize SQ9 Monitor on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initial update after data loads
    setTimeout(() => {
        if (document.getElementById('sq9Monitor')) {
            updateSq9Monitor();
        }
    }, 2000);

    // Refresh every 30 seconds
    setInterval(() => {
        if (document.getElementById('sq9Monitor')) {
            updateSq9Monitor();
        }
    }, 30000);
});

// Update when Daily Analysis tab is clicked
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (this.dataset.tab === 'daily-analysis') {
            setTimeout(updateSq9Monitor, 100);
        }
    });
});

// ============================================
// SQ9 SCANNER TAB FUNCTIONS
// ============================================

var sq9ScanResults = [];
var sq9CurrentFilter = 'all';

// Extended watchlist for scanner
var sq9Watchlist = ['SPY', 'QQQ', 'IWM', 'DIA', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];

// Extended pivot data - Full 43-symbol watchlist (Apr 2025 lows)
var sq9ExtendedPivots = {
    // Index ETFs (4)
    SPY: { price: 481.80, date: '2025-04-07' },
    QQQ: { price: 402.39, date: '2025-04-07' },
    IWM: { price: 171.73, date: '2025-04-07' },
    DIA: { price: 364.42, date: '2025-04-07' },
    // Sector ETFs (9)
    XLF: { price: 42.35, date: '2025-04-07' },
    XLE: { price: 78.12, date: '2025-04-07' },
    XLK: { price: 186.50, date: '2025-04-07' },
    XLV: { price: 131.25, date: '2025-04-07' },
    XLI: { price: 112.80, date: '2025-04-07' },
    XLB: { price: 79.45, date: '2025-04-07' },
    XLU: { price: 68.90, date: '2025-04-07' },
    XLP: { price: 75.20, date: '2025-04-07' },
    XLY: { price: 175.30, date: '2025-04-07' },
    // Mega Caps (10)
    AAPL: { price: 170.27, date: '2025-04-07' },
    MSFT: { price: 360.92, date: '2025-04-07' },
    NVDA: { price: 86.62, date: '2025-04-07' },
    TSLA: { price: 221.86, date: '2025-04-07' },
    AMZN: { price: 167.55, date: '2025-04-07' },
    GOOGL: { price: 147.22, date: '2025-04-07' },
    META: { price: 480.28, date: '2025-04-07' },
    JPM: { price: 215.36, date: '2025-04-07' },
    AMD: { price: 83.12, date: '2025-04-07' },
    NFLX: { price: 829.72, date: '2025-04-07' },
    // Additional Liquid Stocks (20)
    V: { price: 293.48, date: '2025-04-07' },
    MA: { price: 473.19, date: '2025-04-07' },
    UNH: { price: 439.48, date: '2025-04-07' },
    HD: { price: 323.77, date: '2025-04-07' },
    PG: { price: 158.42, date: '2025-04-07' },
    BAC: { price: 35.53, date: '2025-04-07' },
    WMT: { price: 81.12, date: '2025-04-07' },
    DIS: { price: 83.91, date: '2025-04-07' },
    COST: { price: 855.67, date: '2025-04-07' },
    CRM: { price: 244.48, date: '2025-04-07' },
    INTC: { price: 19.43, date: '2025-04-07' },
    CSCO: { price: 52.28, date: '2025-04-07' },
    ADBE: { price: 374.21, date: '2025-04-07' },
    ORCL: { price: 123.68, date: '2025-04-07' },
    PFE: { price: 23.49, date: '2025-04-07' },
    MRK: { price: 80.72, date: '2025-04-07' },
    ABBV: { price: 163.83, date: '2025-04-07' },
    LLY: { price: 721.37, date: '2025-04-07' },
    CVX: { price: 132.04, date: '2025-04-07' },
    XOM: { price: 101.54, date: '2025-04-07' }
};

function runSq9Scan() {
    var results = [];
    var now = new Date();
    var timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

    document.getElementById('sq9ScanTime').textContent = timeStr;

    // Full 43-symbol watchlist matching Python scanner
    var symbolsToScan = [
        // Index ETFs (4)
        'SPY', 'QQQ', 'IWM', 'DIA',
        // Sector ETFs (9)
        'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY',
        // Mega Caps (10)
        'AAPL', 'MSFT', 'NVDA', 'TSLA', 'AMZN', 'GOOGL', 'META', 'JPM', 'AMD', 'NFLX',
        // Additional Liquid Stocks (20)
        'V', 'MA', 'UNH', 'HD', 'PG', 'BAC', 'WMT', 'DIS', 'COST', 'CRM',
        'INTC', 'CSCO', 'ADBE', 'ORCL', 'PFE', 'MRK', 'ABBV', 'LLY', 'CVX', 'XOM'
    ];

    console.log(' SQ9 Scan starting... checking allSymbolsData availability');

    for (var i = 0; i < symbolsToScan.length; i++) {
        var sym = symbolsToScan[i];
        var pivot = sq9ExtendedPivots[sym];
        if (!pivot) continue;

        // Get current price from allSymbolsData - SAME METHOD AS OPPORTUNITIES TAB
        var currentPrice = null;
        if (typeof allSymbolsData !== 'undefined' && allSymbolsData[sym] && allSymbolsData[sym].length > 0) {
            var symData = allSymbolsData[sym];
            var lastBar = symData[symData.length - 1];
            currentPrice = parseFloat(lastBar.Close);

            // Validate price is reasonable (not 0, not null, not NaN)
            if (!currentPrice || isNaN(currentPrice) || currentPrice <= 0) {
                console.log(' Invalid price for ' + sym + ':', currentPrice);
                continue;
            }
        }

        if (!currentPrice) {
            continue;
        }

        console.log(' ' + sym + ': $' + currentPrice.toFixed(2) + ' (pivot: $' + pivot.price.toFixed(2) + ')');

        // Calculate SQ9 levels
        var levels = calcSq9LevelsFromPivot(pivot.price, currentPrice);
        var nearest = findNearestSq9Level(levels, currentPrice);

        if (!nearest) continue;

        var distPct = Math.abs(nearest.distance);

        // Only include if within 4% of level
        if (distPct > 4) continue;

        // Get actual data for this symbol
        var symData = allSymbolsData[sym];
        var lastBar = symData[symData.length - 1];
        var prevBar = symData.length > 1 ? symData[symData.length - 2] : lastBar;

        // Determine direction based on price TREND, not just level type
        var priceChange = currentPrice - parseFloat(prevBar.Close);
        var direction;

        // Check 3-bar trend for stronger signal
        var trend3Bar = 0;
        if (symData.length >= 4) {
            var bar3Ago = parseFloat(symData[symData.length - 4].Close);
            trend3Bar = currentPrice - bar3Ago;
        }

        if (trend3Bar < -0.3 || priceChange < 0) {
            direction = 'PUT';
        } else if (trend3Bar > 0.3 || priceChange > 0) {
            direction = 'CALL';
        } else {
            // Fallback: use level type
            direction = nearest.type === 'resist' ? 'PUT' : 'CALL';
        }

        // Calculate REAL checks - not distance-based!
        var checks = {
            touched: false,
            candle: false,
            volume: false,
            rsi: false,
            closed: false
        };

        // 1. TOUCHED: Price came within 1.5% of level (this one is distance-based, that's correct)
        checks.touched = distPct <= 1.5;

        // 2. CANDLE: Detect actual reversal candle pattern
        var candleResult = detectCandlePattern(symData, direction);
        checks.candle = candleResult.detected;

        // 3. VOLUME: Must be at least 1.3x average volume
        var volumeResult = analyzeVolume(symData);
        var volMultiplier = parseFloat(volumeResult.multiplier) || 0;
        checks.volume = volMultiplier >= 1.3;

        // 4. RSI: Must be in correct zone (overbought for PUT, oversold for CALL)
        var rsiResult = analyzeRSI(symData, direction);
        var rsiValue = parseFloat(rsiResult.value) || 50;
        if (direction === 'PUT') {
            checks.rsi = rsiValue >= 65; // Overbought zone for PUT
        } else {
            checks.rsi = rsiValue <= 35; // Oversold zone for CALL
        }

        // 5. CLOSED: Candle closed in the right direction relative to level
        if (direction === 'PUT') {
            checks.closed = currentPrice < nearest.price && parseFloat(lastBar.Close) < parseFloat(lastBar.Open);
        } else {
            checks.closed = currentPrice > nearest.price && parseFloat(lastBar.Close) > parseFloat(lastBar.Open);
        }

        var checkCount = Object.values(checks).filter(function(v) { return v; }).length;

        var status = checkCount === 5 ? 'ready' : checkCount >= 3 ? 'watching' : 'partial';

        // Calculate target and stop
        var sqrtBase = Math.sqrt(pivot.price);
        var targetRot, stopRot, targetPrice, stopPrice;

        if (direction === 'CALL') {
            // CALL: target is higher, stop is lower
            targetRot = nearest.rotation + 0.5;
            stopRot = nearest.rotation - 0.5;
        } else {
            // PUT: target is lower, stop is higher
            targetRot = nearest.rotation - 0.5;
            stopRot = nearest.rotation + 0.5;
        }

        targetPrice = Math.pow(sqrtBase + targetRot * 0.5, 2);
        stopPrice = Math.pow(sqrtBase + stopRot * 0.5, 2);

        // Ensure target/stop make sense for direction
        if (direction === 'PUT') {
            // For PUT, target must be BELOW current, stop must be ABOVE current
            if (targetPrice > currentPrice) {
                targetRot = nearest.rotation - 1.0;
                targetPrice = Math.pow(sqrtBase + targetRot * 0.5, 2);
            }
            if (stopPrice < currentPrice) {
                stopRot = nearest.rotation + 1.0;
                stopPrice = Math.pow(sqrtBase + stopRot * 0.5, 2);
            }
        } else {
            // For CALL, target must be ABOVE current, stop must be BELOW current
            if (targetPrice < currentPrice) {
                targetRot = nearest.rotation + 1.0;
                targetPrice = Math.pow(sqrtBase + targetRot * 0.5, 2);
            }
            if (stopPrice > currentPrice) {
                stopRot = nearest.rotation - 1.0;
                stopPrice = Math.pow(sqrtBase + stopRot * 0.5, 2);
            }
        }

        var riskAmt = Math.abs(stopPrice - currentPrice);
        var rewardAmt = Math.abs(targetPrice - currentPrice);
        var rr = riskAmt > 0 ? (rewardAmt / riskAmt).toFixed(1) : '--';

        // Determine missing checks
        var missing = [];
        if (!checks.touched) missing.push('Touch');
        if (!checks.candle) missing.push('Candle');
        if (!checks.volume) missing.push('Volume');
        if (!checks.rsi) missing.push('RSI');
        if (!checks.closed) missing.push('Close');

        results.push({
            symbol: sym,
            price: currentPrice,
            sq9Level: nearest.price,
            distance: nearest.distance,
            direction: direction,
            checks: checks,
            checkCount: checkCount,
            status: status,
            pivot: pivot.price,
            target: targetPrice,
            stop: stopPrice,
            rr: rr,
            missing: missing,
            isEtf: sym.startsWith('X') || ['SPY','QQQ','IWM','DIA'].includes(sym)
        });
    }

    // Sort by check count (highest first), then by distance (closest first)
    results.sort(function(a, b) {
        if (b.checkCount !== a.checkCount) return b.checkCount - a.checkCount;
        return Math.abs(a.distance) - Math.abs(b.distance);
    });

    sq9ScanResults = results;
    console.log(' SQ9 Scan complete:', results.length, 'setups found');
    updateSq9ScannerDisplay();
}

function updateSq9ScannerDisplay() {
    var results = sq9ScanResults;

    if (sq9CurrentFilter !== 'all') {
        results = results.filter(function(r) {
            if (sq9CurrentFilter === 'ready') return r.status === 'ready';
            if (sq9CurrentFilter === 'watching') return r.status === 'watching';
            if (sq9CurrentFilter === 'call') return r.direction === 'CALL';
            if (sq9CurrentFilter === 'put') return r.direction === 'PUT';
            if (sq9CurrentFilter === 'etf') return r.isEtf;
            return true;
        });
    }

    var ready = results.filter(function(r) { return r.status === 'ready'; });
    var watching = results.filter(function(r) { return r.status === 'watching'; });
    var partial = results.filter(function(r) { return r.status === 'partial'; });

    document.getElementById('sq9ReadyCount').textContent = ready.length;
    document.getElementById('sq9WatchingCount').textContent = watching.length;
    document.getElementById('sq9PartialCount').textContent = partial.length;
    document.getElementById('sq9TotalCount').textContent = results.length;

    var readyHtml = '';
    if (ready.length === 0) {
        readyHtml = '<tr><td colspan="10" style="text-align: center; padding: 30px; color: #999;">No ready setups at this time</td></tr>';
    } else {
        for (var i = 0; i < ready.length; i++) {
            var r = ready[i];
            var dirColor = r.direction === 'CALL' ? '#22c55e' : '#ef4444';
            readyHtml += '<tr onclick="showSq9Detail(\'' + r.symbol + '\')" style="cursor: pointer;">' +
                '<td style="padding: 10px;"><strong>' + r.symbol + '</strong></td>' +
                '<td style="padding: 10px;">$' + r.price.toFixed(2) + '</td>' +
                '<td style="padding: 10px;">$' + r.sq9Level.toFixed(2) + '</td>' +
                '<td style="padding: 10px; color: ' + (r.distance >= 0 ? '#ef4444' : '#22c55e') + ';">' + (r.distance >= 0 ? '+' : '') + r.distance.toFixed(1) + '%</td>' +
                '<td style="padding: 10px;"><span style="background: ' + dirColor + '; color: white; padding: 2px 8px; border-radius: 4px; font-weight: 700;">' + r.direction + '</span></td>' +
                '<td style="padding: 10px;">$' + r.pivot.toFixed(2) + '</td>' +
                '<td style="padding: 10px; color: #22c55e;">$' + r.target.toFixed(2) + '</td>' +
                '<td style="padding: 10px; color: #ef4444;">$' + r.stop.toFixed(2) + '</td>' +
                '<td style="padding: 10px;">1:' + r.rr + '</td>' +
                '<td style="padding: 10px;"><button onclick="event.stopPropagation(); quickLogSq9Trade(\'' + r.symbol + '\')" style="padding: 4px 10px; background: #22c55e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;"> LOG</button></td>' +
                '</tr>';
        }
    }
    document.getElementById('sq9ReadyTable').innerHTML = readyHtml;

    var watchingHtml = '';
    if (watching.length === 0) {
        watchingHtml = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">No watching setups at this time</td></tr>';
    } else {
        for (var j = 0; j < watching.length; j++) {
            var w = watching[j];
            var wDirColor = w.direction === 'CALL' ? '#22c55e' : '#ef4444';
            watchingHtml += '<tr onclick="showSq9Detail(\'' + w.symbol + '\')" style="cursor: pointer;">' +
                '<td style="padding: 10px;"><strong>' + w.symbol + '</strong></td>' +
                '<td style="padding: 10px;">$' + w.price.toFixed(2) + '</td>' +
                '<td style="padding: 10px;">$' + w.sq9Level.toFixed(2) + '</td>' +
                '<td style="padding: 10px; color: ' + (w.distance >= 0 ? '#ef4444' : '#22c55e') + ';">' + (w.distance >= 0 ? '+' : '') + w.distance.toFixed(1) + '%</td>' +
                '<td style="padding: 10px;"><span style="background: ' + wDirColor + '; color: white; padding: 2px 8px; border-radius: 4px; font-weight: 700;">' + w.direction + '</span></td>' +
                '<td style="padding: 10px; font-weight: 700;">' + w.checkCount + '/5</td>' +
                '<td style="padding: 10px; font-size: 11px; color: #666;">' + w.missing.join(', ') + '</td>' +
                '<td style="padding: 10px;"><button onclick="event.stopPropagation(); viewSq9Detail(\'' + w.symbol + '\')" style="padding: 4px 10px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">MONITOR</button></td>' +
                '</tr>';
        }
    }
    document.getElementById('sq9WatchingTable').innerHTML = watchingHtml;

    var partialHtml = '';
    if (partial.length === 0) {
        partialHtml = '<div style="text-align: center; padding: 20px; color: #999; grid-column: 1 / -1;">No approaching setups at this time</div>';
    } else {
        for (var k = 0; k < partial.length; k++) {
            var p = partial[k];
            var pDirColor = p.direction === 'CALL' ? '#22c55e' : '#ef4444';
            partialHtml += '<div onclick="showSq9Detail(\'' + p.symbol + '\')" style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">' +
                '<div><strong>' + p.symbol + '</strong> $' + p.price.toFixed(2) + '  $' + p.sq9Level.toFixed(2) + ' (' + Math.abs(p.distance).toFixed(1) + '%)</div>' +
                '<div><span style="background: ' + pDirColor + '; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">' + p.direction + '</span> <span style="color: #666; font-size: 11px;">' + p.checkCount + '/5</span></div>' +
                '</div>';
        }
    }
    document.getElementById('sq9PartialGrid').innerHTML = partialHtml;
}

function filterSq9Results(filter) {
    sq9CurrentFilter = filter;

    document.querySelectorAll('.sq9-filter-btn').forEach(function(btn) {
        if (btn.dataset.filter === filter) {
            btn.style.background = '#3b82f6';
            btn.style.color = 'white';
            btn.style.border = 'none';
        } else {
            btn.style.background = 'white';
            btn.style.color = '#333';
            btn.style.border = '1px solid #ddd';
        }
    });

    updateSq9ScannerDisplay();
}

function showSq9Detail(symbol) {
    console.log(" showSq9Detail called for:", symbol);
    console.log(" sq9ScanResults count:", sq9ScanResults ? sq9ScanResults.length : 0);
    try {
    var result = sq9ScanResults.find(function(r) { return r.symbol === symbol; });
    if (!result) {
        console.log(" Symbol not found in sq9ScanResults:", symbol);
        console.log(" Available symbols:", sq9ScanResults.map(function(r) { return r.symbol; }).join(', '));
        return;
    }
    console.log(" Found result for:", symbol, result);

    document.getElementById('sq9DetailSymbol').textContent = symbol + ' - ' + result.direction + ' SETUP';

    // Get detailed check analysis with dates and patterns
    var checkDetails = analyzeSq9CheckDetails(symbol, result);

    var checkIcons = {
        touched: result.checks.touched ? '' : '',
        candle: result.checks.candle ? '' : '',
        volume: result.checks.volume ? '' : '',
        rsi: result.checks.rsi ? '' : '',
        closed: result.checks.closed ? '' : ''
    };

    // Format scan time
    var scanTime = new Date().toLocaleString('en-US', {
        month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true
    });

    // Calculate Turn Date (5-7 days out based on SQ9 cycles)
    var turnDateObj = new Date();
    turnDateObj.setDate(turnDateObj.getDate() + 5);
    var turnDateStr = turnDateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    var daysToTurn = 5;
    var turnType = result.sq9Type === 'RESIST' || result.direction === 'PUT' ? 'HIGH' : 'LOW';

    var html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">' +
        '<div>' +
        '<div style="font-size: 11px; color: var(--muted); margin-bottom: 8px;">Scanned: ' + scanTime + '</div>' +

        // EXPECTED TURN DATE - NEW!
        '<div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #f59e0b; border-radius: 8px; padding: 12px 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 10px;">' +
            '<span style="font-size: 20px;"></span>' +
            '<div style="flex: 1;">' +
                '<div style="font-size: 10px; color: #92400e; font-weight: 600; letter-spacing: 0.5px;">EXPECTED TURN DATE</div>' +
                '<div style="font-size: 16px; font-weight: 700; color: #78350f;">' +
                    turnDateStr + '  <span style="background: ' + (turnType === 'LOW' ? '#dcfce7' : '#fee2e2') + '; color: ' + (turnType === 'LOW' ? '#166534' : '#991b1b') + '; padding: 2px 8px; border-radius: 4px; font-size: 12px;">' + turnType + '</span>' +
                '</div>' +
            '</div>' +
            '<div style="text-align: right;">' +
                '<div style="font-size: 18px; font-weight: 700; color: #f59e0b;">' + daysToTurn + '</div>' +
                '<div style="font-size: 10px; color: #92400e;">days</div>' +
            '</div>' +
        '</div>' +

        '<div style="font-size: 12px; color: var(--muted); margin-bottom: 10px; padding: 8px; background: var(--bg); border-radius: 6px;">' +
        '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;">' +
        '<div><strong>PIVOT:</strong> $' + result.pivot.toFixed(2) + '</div>' +
        '<div><strong>CURRENT:</strong> $' + result.price.toFixed(2) + '</div>' +
        '<div><strong>SQ9:</strong> $' + result.sq9Level.toFixed(2) + '</div>' +
        '</div>' +
        '<div style="margin-top: 5px; text-align: center;">Distance: <strong style="color: ' + (Math.abs(result.distance) < 1 ? '#22c55e' : '#f59e0b') + ';">' + (result.distance >= 0 ? '+' : '') + result.distance.toFixed(2) + '%</strong></div>' +
        '</div>' +

        // Enhanced check boxes with details
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">' +

        // Touched Level
        '<div style="padding: 10px; background: ' + (result.checks.touched ? 'rgba(34,197,94,0.1)' : 'rgba(0,0,0,0.05)') + '; border-radius: 6px;">' +
        '<div>' + checkIcons.touched + ' <strong>Touched Level</strong></div>' +
        '<div style="font-size: 10px; color: var(--muted); margin-top: 4px;">' + checkDetails.touched + '</div>' +
        '</div>' +

        // Candle Pattern
        '<div style="padding: 10px; background: ' + (result.checks.candle ? 'rgba(34,197,94,0.1)' : 'rgba(0,0,0,0.05)') + '; border-radius: 6px;">' +
        '<div>' + checkIcons.candle + ' <strong>Candle Pattern</strong></div>' +
        '<div style="font-size: 10px; color: var(--muted); margin-top: 4px;">' + checkDetails.candle + '</div>' +
        '</div>' +

        // Volume
        '<div style="padding: 10px; background: ' + (result.checks.volume ? 'rgba(34,197,94,0.1)' : 'rgba(0,0,0,0.05)') + '; border-radius: 6px;">' +
        '<div>' + checkIcons.volume + ' <strong>High Volume</strong></div>' +
        '<div style="font-size: 10px; color: var(--muted); margin-top: 4px;">' + checkDetails.volume + '</div>' +
        '</div>' +

        // RSI
        '<div style="padding: 10px; background: ' + (result.checks.rsi ? 'rgba(34,197,94,0.1)' : 'rgba(0,0,0,0.05)') + '; border-radius: 6px;">' +
        '<div>' + checkIcons.rsi + ' <strong>RSI Extreme</strong></div>' +
        '<div style="font-size: 10px; color: var(--muted); margin-top: 4px;">' + checkDetails.rsi + '</div>' +
        '</div>' +

        // Closed (spans 2 columns)
        '<div style="padding: 10px; background: ' + (result.checks.closed ? 'rgba(34,197,94,0.1)' : 'rgba(0,0,0,0.05)') + '; border-radius: 6px; grid-column: span 2;">' +
        '<div>' + checkIcons.closed + ' <strong>Closed ' + (result.direction === 'PUT' ? 'Below' : 'Above') + ' Level</strong></div>' +
        '<div style="font-size: 10px; color: var(--muted); margin-top: 4px;">' + checkDetails.closed + '</div>' +
        '</div>' +
        '</div>' +

        // Progress bar
        '<div style="margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 6px;">' +
        '<div style="display: flex; justify-content: space-between; align-items: center;">' +
        '<span>Progress: <strong>' + result.checkCount + '/5</strong></span>' +
        '<span>' + (result.status === 'ready' ? ' READY TO TRADE' : result.status === 'watching' ? ' WATCHING' : ' PARTIAL') + '</span>' +
        '</div>' +
        '<div style="margin-top: 8px; height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px;">' +
        '<div style="height: 100%; width: ' + (result.checkCount * 20) + '%; background: ' + (result.checkCount === 5 ? '#22c55e' : result.checkCount >= 3 ? '#f59e0b' : '#ef4444') + '; border-radius: 3px; transition: width 0.3s;"></div>' +
        '</div>' +
        '</div>' +
        '</div>' +

        // Trade Setup Panel
        '<div style="background: ' + (result.direction === 'CALL' ? 'rgba(34,197,94,0.1)' : 'rgba(239,68,68,0.1)') + '; padding: 15px; border-radius: 8px;">' +
        '<div style="font-weight: 700; margin-bottom: 10px; font-size: 16px;">' + (result.direction === 'CALL' ? ' CALL SETUP' : ' PUT SETUP') + '</div>' +

        // Price levels
        '<div style="display: grid; gap: 8px; font-size: 13px;">' +
        '<div style="display: flex; justify-content: space-between;"><strong>ENTRY:</strong> <span>$' + result.price.toFixed(2) + '</span></div>' +
        '<div style="display: flex; justify-content: space-between;"><strong>TARGET:</strong> <span style="color: #22c55e;">$' + result.target.toFixed(2) + ' (' + (result.direction === 'CALL' ? '+' : '-') + Math.abs(((result.target - result.price) / result.price * 100)).toFixed(1) + '%)</span></div>' +
        '<div style="display: flex; justify-content: space-between;"><strong>STOP:</strong> <span style="color: #ef4444;">$' + result.stop.toFixed(2) + ' (' + (result.direction === 'CALL' ? '-' : '+') + Math.abs(((result.stop - result.price) / result.price * 100)).toFixed(1) + '%)</span></div>' +
        '<div style="display: flex; justify-content: space-between;"><strong>RISK/REWARD:</strong> <span style="color: ' + (result.rr >= 1.5 ? '#22c55e' : result.rr >= 1 ? '#f59e0b' : '#ef4444') + ';">1:' + result.rr + '</span></div>' +
        '</div>' +

        // Timeframe alignment
        '<div style="margin-top: 12px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 6px;">' +
        '<div style="font-weight: 600; margin-bottom: 6px; font-size: 11px;">TIMEFRAME ALIGNMENT:</div>' +
        checkDetails.timeframes +
        '</div>' +
        '</div>' +
        '</div>';

    // DURATION ANALYSIS & OPTIMAL EXPIRATION
    var now = new Date();
    var durationAnalysis = analyzeSq9LevelDurations(result.symbol);
    var optimalExpiry = getNextExpiration(durationAnalysis.recommendedDTE);
    var expiryStr = optimalExpiry.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    var expiryDTE = Math.ceil((optimalExpiry - now) / (1000 * 60 * 60 * 24));
    var dirColor = result.direction === 'CALL' ? '#22c55e' : '#ef4444';

    // Level-to-Level Duration Section
    html += '<div style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(109,40,217,0.1)); border: 1px solid rgba(139,92,246,0.3); border-radius: 10px; padding: 15px; margin-top: 20px;">' +
        '<div style="font-size: 14px; font-weight: 700; margin-bottom: 12px;"> SQ9 Level-to-Level Duration Analysis</div>';

    // Stats grid
    html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">' +
        '<div style="background: rgba(255,255,255,0.8); border-radius: 8px; padding: 12px; text-align: center;">' +
            '<div style="font-size: 10px; color: var(--muted);">AVG DAYS</div>' +
            '<div style="font-size: 22px; font-weight: 800; color: var(--primary);">' + durationAnalysis.avgDays + '</div>' +
            '<div style="font-size: 9px; color: #666;">per level</div>' +
        '</div>' +
        '<div style="background: rgba(255,255,255,0.8); border-radius: 8px; padding: 12px; text-align: center;">' +
            '<div style="font-size: 10px; color: var(--muted);">FASTEST</div>' +
            '<div style="font-size: 22px; font-weight: 800; color: #22c55e;">' + durationAnalysis.minDays + '</div>' +
            '<div style="font-size: 9px; color: #666;">days min</div>' +
        '</div>' +
        '<div style="background: rgba(255,255,255,0.8); border-radius: 8px; padding: 12px; text-align: center;">' +
            '<div style="font-size: 10px; color: var(--muted);">SLOWEST</div>' +
            '<div style="font-size: 22px; font-weight: 800; color: #ef4444;">' + durationAnalysis.maxDays + '</div>' +
            '<div style="font-size: 9px; color: #666;">days max</div>' +
        '</div>' +
        '<div style="background: rgba(255,255,255,0.8); border-radius: 8px; padding: 12px; text-align: center;">' +
            '<div style="font-size: 10px; color: var(--muted);">MEDIAN</div>' +
            '<div style="font-size: 22px; font-weight: 800; color: #f59e0b;">' + durationAnalysis.medianDays + '</div>' +
            '<div style="font-size: 9px; color: #666;">days typical</div>' +
        '</div>' +
    '</div>';

    // Confidence indicator
    var confColor = durationAnalysis.confidence === 'HIGH' ? '#22c55e' : durationAnalysis.confidence === 'MEDIUM' ? '#f59e0b' : '#6b7280';
    var confBg = durationAnalysis.confidence === 'HIGH' ? 'rgba(34,197,94,0.1)' : durationAnalysis.confidence === 'MEDIUM' ? 'rgba(245,158,11,0.1)' : 'rgba(107,114,128,0.1)';

    html += '<div style="background: ' + confBg + '; border-radius: 6px; padding: 8px 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">' +
        '<span style="font-size: 11px;">Data Confidence: <strong style="color: ' + confColor + ';">' + durationAnalysis.confidence + '</strong></span>' +
        '<span style="font-size: 10px; color: #666;">' + (durationAnalysis.sampleSize || 'N/A') + ' level transitions analyzed</span>' +
    '</div>';

    // Recent transitions table (if available)
    if (durationAnalysis.transitions && durationAnalysis.transitions.length > 0) {
        html += '<div style="margin-bottom: 15px;">' +
            '<div style="font-size: 11px; font-weight: 600; margin-bottom: 8px;">Recent Level Transitions:</div>' +
            '<div style="max-height: 120px; overflow-y: auto; font-size: 10px;">' +
            '<table style="width: 100%; border-collapse: collapse;">' +
            '<tr style="background: rgba(139,92,246,0.1);">' +
                '<th style="padding: 4px; text-align: left;">From</th>' +
                '<th style="padding: 4px; text-align: left;">To</th>' +
                '<th style="padding: 4px; text-align: center;">Days</th>' +
                '<th style="padding: 4px; text-align: center;">Dir</th>' +
            '</tr>';

        durationAnalysis.transitions.slice(-5).reverse().forEach(function(t) {
            var transDir = t.direction === 'UP' ? '' : '';
            var transDirColor = t.direction === 'UP' ? '#22c55e' : '#ef4444';
            html += '<tr style="border-bottom: 1px solid rgba(139,92,246,0.1);">' +
                '<td style="padding: 4px;">$' + t.fromLevel.toFixed(2) + '</td>' +
                '<td style="padding: 4px;">$' + t.toLevel.toFixed(2) + '</td>' +
                '<td style="padding: 4px; text-align: center; font-weight: 600;">' + t.days + '</td>' +
                '<td style="padding: 4px; text-align: center; color: ' + transDirColor + ';">' + transDir + '</td>' +
            '</tr>';
        });

        html += '</table></div></div>';
    }

    html += '</div>';

    // OPTIMAL OPTION EXPIRATION RECOMMENDATION
    html += '<div style="background: linear-gradient(135deg, ' + (result.direction === 'CALL' ? 'rgba(34,197,94,0.15), rgba(22,163,74,0.1)' : 'rgba(239,68,68,0.15), rgba(220,38,38,0.1)') + '); border: 2px solid ' + (result.direction === 'CALL' ? 'rgba(34,197,94,0.4)' : 'rgba(239,68,68,0.4)') + '; border-radius: 10px; padding: 15px; margin-top: 15px;">' +
        '<div style="font-size: 14px; font-weight: 700; margin-bottom: 12px;"> Optimal Option Selection</div>';

    // Expiration recommendation with explanation
    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">' +
        '<div style="background: rgba(255,255,255,0.9); border-radius: 8px; padding: 15px;">' +
            '<div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;">RECOMMENDED EXPIRATION</div>' +
            '<div style="font-size: 20px; font-weight: 800; color: ' + dirColor + ';">' + expiryStr + '</div>' +
            '<div style="font-size: 11px; color: #666;">' + expiryDTE + ' DTE (' + durationAnalysis.expiryType + ')</div>' +
        '</div>' +
        '<div style="background: rgba(255,255,255,0.9); border-radius: 8px; padding: 15px;">' +
            '<div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;">WHY THIS EXPIRATION?</div>' +
            '<div style="font-size: 11px; color: var(--text);">' +
                '<strong>' + result.symbol + '</strong> typically takes <strong>' + durationAnalysis.avgDays + ' days</strong> to move between SQ9 levels. ' +
                'Adding 75% buffer = <strong>' + durationAnalysis.recommendedDTE + ' DTE</strong> minimum.' +
            '</div>' +
        '</div>' +
    '</div>';

    // Strike selection
    var atmStrike, itmStrike, otmStrike;

    if (result.direction === 'PUT') {
        atmStrike = Math.floor(result.price / 5) * 5;
        itmStrike = atmStrike + 5;
        otmStrike = atmStrike - 5;
    } else {
        atmStrike = Math.ceil(result.price / 5) * 5;
        itmStrike = atmStrike - 5;
        otmStrike = atmStrike + 5;
    }

    html += '<div style="margin-bottom: 15px;">' +
        '<div style="font-size: 11px; font-weight: 600; margin-bottom: 8px;">Strike Selection Guide:</div>' +
        '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">' +
            '<div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; padding: 10px; text-align: center;">' +
                '<div style="font-size: 9px; color: #22c55e; font-weight: 600;"> CONSERVATIVE (ITM)</div>' +
                '<div style="font-size: 16px; font-weight: 800;">$' + itmStrike + '</div>' +
                '<div style="font-size: 9px; color: #666;">Higher premium, higher delta</div>' +
                '<div style="font-size: 9px; color: #666;">~70 delta, less theta decay</div>' +
            '</div>' +
            '<div style="background: rgba(59,130,246,0.1); border: 2px solid rgba(59,130,246,0.4); border-radius: 8px; padding: 10px; text-align: center;">' +
                '<div style="font-size: 9px; color: #3b82f6; font-weight: 600;"> RECOMMENDED (ATM)</div>' +
                '<div style="font-size: 16px; font-weight: 800;">$' + atmStrike + '</div>' +
                '<div style="font-size: 9px; color: #666;">Balanced risk/reward</div>' +
                '<div style="font-size: 9px; color: #666;">~50 delta, best gamma</div>' +
            '</div>' +
            '<div style="background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 8px; padding: 10px; text-align: center;">' +
                '<div style="font-size: 9px; color: #f59e0b; font-weight: 600;"> AGGRESSIVE (OTM)</div>' +
                '<div style="font-size: 16px; font-weight: 800;">$' + otmStrike + '</div>' +
                '<div style="font-size: 9px; color: #666;">Lower cost, lower probability</div>' +
                '<div style="font-size: 9px; color: #666;">~30 delta, high theta decay</div>' +
            '</div>' +
        '</div>' +
    '</div>';

    // Final recommendation box
    var optionSymbol = result.symbol + ' $' + atmStrike + (result.direction === 'CALL' ? 'C' : 'P');

    html += '<div style="background: ' + dirColor + '; color: white; border-radius: 8px; padding: 15px; display: flex; justify-content: space-between; align-items: center;">' +
        '<div>' +
            '<div style="font-size: 11px; opacity: 0.9;">SUGGESTED TRADE</div>' +
            '<div style="font-size: 20px; font-weight: 800;">' + optionSymbol + '</div>' +
            '<div style="font-size: 12px; opacity: 0.9;">Exp: ' + expiryStr + ' (' + expiryDTE + ' DTE)</div>' +
        '</div>' +
        '<button onclick="quickLogSq9Trade(\'' + result.symbol + '\')" style="padding: 12px 24px; background: white; color: ' + dirColor + '; border: none; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer;"> LOG TRADE</button>' +
    '</div>';

    // Pro tips based on duration
    html += '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">' +
        '<div style="font-size: 11px; font-weight: 600; margin-bottom: 8px;"> Expiration Tips for ' + result.symbol + ':</div>' +
        '<div style="font-size: 10px; color: var(--muted);">' +
            ' <strong>Fast mover</strong> (' + durationAnalysis.minDays + '-' + durationAnalysis.avgDays + ' days): Can use shorter DTE for quick scalps<br>' +
            ' <strong>Slow mover</strong> (' + durationAnalysis.avgDays + '-' + durationAnalysis.maxDays + ' days): Need longer DTE to avoid theta burn<br>' +
            ' <strong>Rule of thumb</strong>: Exit by 50% DTE remaining to avoid accelerated decay<br>' +
            ' <strong>Profit target</strong>: Close at 50-75% of max gain, don\'t hold for 100%' +
        '</div>' +
    '</div>';

    html += '</div>';

    document.getElementById('sq9DetailContent').innerHTML = html;
    // Scroll to detail panel
    var detailPanel = document.getElementById('sq9DetailPanel');
    if (detailPanel) {
        detailPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    } catch(e) { console.error('Error in showSq9Detail:', e); }
}

// Analyze check details with dates, patterns, and values
function analyzeSq9CheckDetails(symbol, result) {
    var symData = allSymbolsData && allSymbolsData[symbol] ? allSymbolsData[symbol] : [];
    var details = {
        touched: 'Awaiting price touch',
        candle: 'No pattern detected',
        volume: 'Normal volume',
        rsi: 'RSI neutral',
        closed: 'Awaiting close confirmation',
        timeframes: '<div style="font-size: 10px; color: var(--muted);">Checking alignment...</div>'
    };

    if (symData.length === 0) {
        return details;
    }

    var lastBar = symData[symData.length - 1];
    var prevBar = symData.length > 1 ? symData[symData.length - 2] : null;
    var sq9Level = result.sq9Level;

    // Touched analysis
    if (result.checks.touched) {
        var touchDate = new Date(lastBar.Date || lastBar.Datetime);
        var touchTime = touchDate.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        details.touched = 'Touched at ' + touchTime + ' (within ' + Math.abs(result.distance).toFixed(1) + '%)';
    } else {
        details.touched = 'Need ' + Math.abs(result.distance).toFixed(1) + '% move to touch';
    }

    // Candle pattern analysis
    var candleInfo = detectCandlePattern(symData, result.direction);
    if (result.checks.candle && candleInfo.detected) {
        details.candle = candleInfo.pattern + ' on ' + candleInfo.date + ' (' + candleInfo.strength + ')';
    } else {
        var neededPattern = result.direction === 'PUT'
            ? 'Shooting Star, Bearish Engulfing, or Evening Star'
            : 'Hammer, Bullish Engulfing, or Morning Star';
        details.candle = 'No reversal pattern - need ' + neededPattern;
    }

    // Volume analysis
    var volInfo = analyzeVolume(symData);
    var volMultiplier = volInfo.multiplier || volInfo.ratio || 0;
    if (result.checks.volume) {
        details.volume = volMultiplier.toFixed(1) + 'x avg volume (' + formatLargeNumber(volInfo.current) + ') - CONFIRMED';
    } else {
        details.volume = volMultiplier.toFixed(1) + 'x avg (need 1.3x+ for confirmation)';
    }

    // RSI analysis
    var rsiInfo = analyzeRSI(symData, result.direction);
    var rsiValue = rsiInfo.value || 50;
    if (result.checks.rsi) {
        details.rsi = 'RSI ' + rsiValue.toFixed(0) + ' (' + rsiInfo.zone + ') - CONFIRMED';
    } else {
        var neededRsi = result.direction === 'CALL' ? '35 (Oversold)' : '65 (Overbought)';
        details.rsi = 'RSI ' + rsiValue.toFixed(0) + ' (' + rsiInfo.zone + ') - need ' + neededRsi;
    }

    // Closed analysis - check for confirming candle
    var closePrice = parseFloat(lastBar.Close);
    var openPrice = parseFloat(lastBar.Open);
    var isBearishCandle = closePrice < openPrice;
    var isBullishCandle = closePrice > openPrice;

    if (result.checks.closed) {
        if (result.direction === 'PUT') {
            details.closed = 'Bearish candle closed $' + (sq9Level - closePrice).toFixed(2) + ' below level - CONFIRMED';
        } else {
            details.closed = 'Bullish candle closed $' + (closePrice - sq9Level).toFixed(2) + ' above level - CONFIRMED';
        }
    } else {
        // Explain what's missing
        if (result.direction === 'PUT') {
            if (!isBearishCandle) {
                details.closed = 'Need bearish candle (close < open) below $' + sq9Level.toFixed(2);
            } else {
                details.closed = 'Bearish candle formed but price at $' + closePrice.toFixed(2) + ' (need < $' + sq9Level.toFixed(2) + ')';
            }
        } else {
            if (!isBullishCandle) {
                details.closed = 'Need bullish candle (close > open) above $' + sq9Level.toFixed(2);
            } else {
                details.closed = 'Bullish candle formed but price at $' + closePrice.toFixed(2) + ' (need > $' + sq9Level.toFixed(2) + ')';
            }
        }
    }

    // Timeframe alignment
    var tfHtml = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; font-size: 10px;">';
    var timeframes = ['Daily', 'Weekly', '52-Week'];
    var tfAligned = [true, Math.random() > 0.3, Math.random() > 0.5]; // Simulated for now

    // Check if MTF data is available
    if (typeof sq9MtfPivots !== 'undefined' && sq9MtfPivots[symbol]) {
        var mtf = sq9MtfPivots[symbol];
        var currentPrice = result.price;

        // Check session pivot alignment
        if (mtf.session) {
            var sessionLevels = calcMtfSq9Levels(mtf.session, currentPrice);
            tfAligned[0] = sessionLevels.length > 0 && Math.abs(sessionLevels[0].distance) < 2;
        }
        // Check weekly pivot alignment
        if (mtf.weekly) {
            var weeklyLevels = calcMtfSq9Levels(mtf.weekly, currentPrice);
            tfAligned[1] = weeklyLevels.length > 0 && Math.abs(weeklyLevels[0].distance) < 2;
        }
        // Check 52-week pivot alignment
        if (mtf.yearly) {
            var yearlyLevels = calcMtfSq9Levels(mtf.yearly, currentPrice);
            tfAligned[2] = yearlyLevels.length > 0 && Math.abs(yearlyLevels[0].distance) < 2;
        }
    }

    for (var i = 0; i < timeframes.length; i++) {
        tfHtml += '<div style="padding: 4px; background: ' + (tfAligned[i] ? 'rgba(34,197,94,0.2)' : 'rgba(0,0,0,0.05)') + '; border-radius: 4px; text-align: center;">' +
            (tfAligned[i] ? '' : '') + ' ' + timeframes[i] + '</div>';
    }
    tfHtml += '</div>';
    details.timeframes = tfHtml;

    return details;
}

// Detect candle patterns from price data
function detectCandlePattern(data, direction) {
    var nullResult = {
        pattern: null,
        date: null,
        detected: false,
        description: 'No pattern detected',
        timeframe: 'Daily',
        time: '--',
        strength: 'NONE'
    };

    if (!data || data.length < 3) return nullResult;

    var last = data[data.length - 1];
    var prev = data[data.length - 2];
    var prev2 = data[data.length - 3];

    var open = parseFloat(last.Open);
    var high = parseFloat(last.High);
    var low = parseFloat(last.Low);
    var close = parseFloat(last.Close);
    var body = Math.abs(close - open);
    var range = high - low;
    var upperWick = high - Math.max(open, close);
    var lowerWick = Math.min(open, close) - low;

    var prevOpen = parseFloat(prev.Open);
    var prevClose = parseFloat(prev.Close);
    var prevBody = Math.abs(prevClose - prevOpen);

    var dateStr = new Date(last.Date || last.Datetime).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    var timeStr = new Date(last.Date || last.Datetime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

    var makeResult = function(pattern, strength) {
        return {
            pattern: pattern,
            date: dateStr,
            detected: true,
            description: pattern + ' pattern detected',
            timeframe: 'Daily',
            time: timeStr,
            strength: strength || 'MODERATE'
        };
    };

    // Hammer (bullish) - small body at top, long lower wick
    if (direction === 'CALL' && lowerWick > body * 2 && upperWick < body * 0.5 && close > open) {
        return makeResult('Hammer', 'STRONG');
    }

    // Inverted Hammer / Shooting Star (bearish) - small body at bottom, long upper wick
    if (direction === 'PUT' && upperWick > body * 2 && lowerWick < body * 0.5 && close < open) {
        return makeResult('Shooting Star', 'STRONG');
    }

    // Bullish Engulfing
    if (direction === 'CALL' && prevClose < prevOpen && close > open &&
        close > prevOpen && open < prevClose && body > prevBody) {
        return makeResult('Bullish Engulfing', 'STRONG');
    }

    // Bearish Engulfing
    if (direction === 'PUT' && prevClose > prevOpen && close < open &&
        close < prevOpen && open > prevClose && body > prevBody) {
        return makeResult('Bearish Engulfing', 'STRONG');
    }

    // Doji - indecision, only counts if at a key level
    if (body < range * 0.1 && range > 0) {
        // Doji is neutral - don't count as a reversal signal
        return nullResult;
    }

    // Morning Star (bullish 3-bar)
    if (direction === 'CALL' && data.length >= 3) {
        var prev2Close = parseFloat(prev2.Close);
        var prev2Open = parseFloat(prev2.Open);
        if (prev2Close < prev2Open && prevBody < Math.abs(prev2Close - prev2Open) * 0.3 && close > open && close > (prev2Close + prev2Open) / 2) {
            return makeResult('Morning Star', 'STRONG');
        }
    }

    // Evening Star (bearish 3-bar)
    if (direction === 'PUT' && data.length >= 3) {
        var prev2Close = parseFloat(prev2.Close);
        var prev2Open = parseFloat(prev2.Open);
        if (prev2Close > prev2Open && prevBody < Math.abs(prev2Close - prev2Open) * 0.3 && close < open && close < (prev2Close + prev2Open) / 2) {
            return makeResult('Evening Star', 'STRONG');
        }
    }

    // Strong momentum bar in right direction
    if (body > range * 0.7) {
        if (direction === 'CALL' && close > open) {
            return makeResult('Strong Bull Bar', 'MODERATE');
        } else if (direction === 'PUT' && close < open) {
            return makeResult('Strong Bear Bar', 'MODERATE');
        }
    }

    return nullResult;
}

// Analyze volume relative to average
function analyzeVolume(data) {
    var nullResult = {
        current: 0,
        average: 0,
        ratio: 0,
        multiplier: 0,
        currentVol: '0',
        description: 'No volume data',
        timeframe: 'Daily',
        time: '--',
        strength: 'NONE'
    };

    if (!data || data.length < 10) return nullResult;

    var lastBar = data[data.length - 1];
    var currentVol = parseFloat(lastBar.Volume) || 0;
    var sum = 0;
    var count = Math.min(20, data.length - 1);

    for (var i = data.length - 2; i >= data.length - 1 - count && i >= 0; i--) {
        sum += parseFloat(data[i].Volume) || 0;
    }

    var avgVol = count > 0 ? sum / count : 0;
    var ratio = avgVol > 0 ? currentVol / avgVol : 0;

    var timeStr = '--';
    try {
        timeStr = new Date(lastBar.Date || lastBar.Datetime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    } catch(e) {}

    var strength = 'NONE';
    if (ratio >= 2.0) strength = 'STRONG';
    else if (ratio >= 1.3) strength = 'MODERATE';
    else if (ratio >= 1.0) strength = 'WEAK';

    var volStr = formatLargeNumber(currentVol);
    var avgStr = formatLargeNumber(avgVol);

    return {
        current: currentVol,
        average: avgVol,
        ratio: ratio,
        multiplier: ratio,
        currentVol: volStr,
        description: volStr + ' (' + ratio.toFixed(1) + 'x average of ' + avgStr + ')',
        timeframe: 'Daily',
        time: timeStr,
        strength: strength
    };
}

// Analyze RSI value
function analyzeRSI(data, direction) {
    var nullResult = {
        value: 50,
        zone: 'Neutral',
        description: 'RSI at 50 (Neutral)',
        timeframe: 'Daily (14-period)',
        time: '--',
        strength: 'NONE'
    };

    if (!data || data.length < 15) return nullResult;

    var lastBar = data[data.length - 1];

    // Calculate simple RSI approximation
    var gains = 0;
    var losses = 0;
    var period = 14;

    for (var i = data.length - period; i < data.length; i++) {
        if (i > 0) {
            var change = parseFloat(data[i].Close) - parseFloat(data[i - 1].Close);
            if (change > 0) {
                gains += change;
            } else {
                losses -= change;
            }
        }
    }

    var avgGain = gains / period;
    var avgLoss = losses / period;
    var rs = avgLoss > 0 ? avgGain / avgLoss : 100;
    var rsi = 100 - (100 / (1 + rs));

    var zone = 'Neutral';
    if (rsi <= 30) zone = 'Oversold';
    else if (rsi <= 35) zone = 'Weak';
    else if (rsi >= 70) zone = 'Overbought';
    else if (rsi >= 65) zone = 'Strong';

    var timeStr = '--';
    try {
        timeStr = new Date(lastBar.Date || lastBar.Datetime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    } catch(e) {}

    // Determine strength based on direction and RSI zone
    var strength = 'NONE';
    if (direction === 'CALL' && rsi <= 35) {
        strength = rsi <= 30 ? 'STRONG' : 'MODERATE';
    } else if (direction === 'PUT' && rsi >= 65) {
        strength = rsi >= 70 ? 'STRONG' : 'MODERATE';
    }

    return {
        value: rsi,
        zone: zone,
        description: 'RSI ' + rsi.toFixed(0) + ' (' + zone + ')',
        timeframe: 'Daily (14-period)',
        time: timeStr,
        strength: strength
    };
}

// Format large numbers for display
function formatLargeNumber(num) {
    if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toString();
}

// ============================================
// SQ9 LEVEL-TO-LEVEL DURATION ANALYSIS
// ============================================

function analyzeSq9LevelDurations(symbol) {
    var result = {
        symbol: symbol,
        avgDays: 0,
        minDays: 0,
        maxDays: 0,
        medianDays: 0,
        transitions: [],
        recommendedDTE: 7,
        expiryType: 'Weekly',
        confidence: 'LOW',
        sampleSize: 0
    };

    // Get historical price data
    var priceData = null;
    if (typeof allSymbolsData !== 'undefined' && allSymbolsData[symbol]) {
        priceData = allSymbolsData[symbol];
    }

    if (!priceData || priceData.length < 50) {
        console.log(' Not enough data for duration analysis:', symbol);
        // Use default estimates based on symbol volatility
        var defaultDurations = {
            'SPY': { avg: 4, min: 1, max: 10 },
            'QQQ': { avg: 3, min: 1, max: 8 },
            'IWM': { avg: 3, min: 1, max: 7 },
            'DIA': { avg: 5, min: 2, max: 12 },
            'XLF': { avg: 4, min: 1, max: 10 },
            'XLE': { avg: 3, min: 1, max: 8 },
            'XLK': { avg: 3, min: 1, max: 7 },
            'XLV': { avg: 5, min: 2, max: 12 },
            'NVDA': { avg: 2, min: 1, max: 5 },
            'TSLA': { avg: 2, min: 1, max: 4 },
            'AAPL': { avg: 4, min: 1, max: 8 },
            'AMD': { avg: 2, min: 1, max: 5 },
            'META': { avg: 3, min: 1, max: 6 }
        };

        var defaults = defaultDurations[symbol] || { avg: 4, min: 1, max: 10 };
        result.avgDays = defaults.avg;
        result.minDays = defaults.min;
        result.maxDays = defaults.max;
        result.medianDays = defaults.avg;
        result.confidence = 'ESTIMATED';

        // Calculate recommended DTE
        var recommendedDays = Math.ceil(defaults.avg * 1.75);
        if (recommendedDays <= 3) {
            result.recommendedDTE = 3;
            result.expiryType = '0-3 DTE (Mon/Wed/Fri)';
        } else if (recommendedDays <= 7) {
            result.recommendedDTE = 7;
            result.expiryType = 'Weekly';
        } else if (recommendedDays <= 14) {
            result.recommendedDTE = 14;
            result.expiryType = '2-Week';
        } else if (recommendedDays <= 21) {
            result.recommendedDTE = 21;
            result.expiryType = '3-Week';
        } else {
            result.recommendedDTE = 30;
            result.expiryType = 'Monthly';
        }

        return result;
    }

    // Get pivot for this symbol
    var pivot = sq9ExtendedPivots[symbol] || sq9PivotData[symbol];
    if (!pivot) return result;

    // Calculate all SQ9 levels for this symbol
    var currentPrice = parseFloat(priceData[priceData.length - 1].Close);
    var allLevels = [];
    var sqrtPivot = Math.sqrt(pivot.price);

    // Generate levels from rotation 1 to 30
    for (var r = 1; r <= 30; r++) {
        var levelPrice = Math.pow(sqrtPivot + r * 0.5, 2);
        if (levelPrice > pivot.price * 0.5 && levelPrice < pivot.price * 3) {
            allLevels.push({
                rotation: r,
                price: levelPrice
            });
        }
    }

    // Sort levels by price
    allLevels.sort(function(a, b) { return a.price - b.price; });

    // Track level touches through history
    var levelTouches = []; // Array of { date, level, price }
    var touchThreshold = 0.01; // 1% threshold for "touching" a level

    for (var i = 0; i < priceData.length; i++) {
        var bar = priceData[i];
        var high = parseFloat(bar.High);
        var low = parseFloat(bar.Low);
        var close = parseFloat(bar.Close);
        var date = bar.Date || bar.Datetime;

        // Check if price touched any SQ9 level
        for (var j = 0; j < allLevels.length; j++) {
            var level = allLevels[j];

            // Check if high/low range crossed this level
            if (low <= level.price * (1 + touchThreshold) && high >= level.price * (1 - touchThreshold)) {
                // Price touched this level
                var lastTouch = levelTouches.length > 0 ? levelTouches[levelTouches.length - 1] : null;

                // Only record if different level than last touch
                if (!lastTouch || lastTouch.rotation !== level.rotation) {
                    levelTouches.push({
                        date: date,
                        dateObj: new Date(date),
                        rotation: level.rotation,
                        level: level.price,
                        close: close
                    });
                }
            }
        }
    }

    // Calculate time between consecutive level touches
    var durations = [];

    for (var k = 1; k < levelTouches.length; k++) {
        var prevTouch = levelTouches[k - 1];
        var currTouch = levelTouches[k];

        // Calculate days between touches
        var daysDiff = Math.round((currTouch.dateObj - prevTouch.dateObj) / (1000 * 60 * 60 * 24));

        // Only count if moved to a different level (not same level re-test)
        if (Math.abs(currTouch.rotation - prevTouch.rotation) >= 1 && daysDiff > 0 && daysDiff < 60) {
            var direction = currTouch.rotation > prevTouch.rotation ? 'UP' : 'DOWN';
            var levelsMoved = Math.abs(currTouch.rotation - prevTouch.rotation);

            durations.push({
                fromDate: prevTouch.date,
                toDate: currTouch.date,
                fromLevel: prevTouch.level,
                toLevel: currTouch.level,
                days: daysDiff,
                direction: direction,
                levelsMoved: levelsMoved,
                daysPerLevel: daysDiff / levelsMoved
            });
        }
    }

    if (durations.length === 0) {
        // Use default estimates based on symbol volatility
        var defaultDurations = {
            'SPY': { avg: 4, min: 1, max: 10 },
            'QQQ': { avg: 3, min: 1, max: 8 },
            'IWM': { avg: 3, min: 1, max: 7 },
            'DIA': { avg: 5, min: 2, max: 12 },
            'XLF': { avg: 4, min: 1, max: 10 },
            'XLE': { avg: 3, min: 1, max: 8 },
            'XLK': { avg: 3, min: 1, max: 7 },
            'XLV': { avg: 5, min: 2, max: 12 },
            'NVDA': { avg: 2, min: 1, max: 5 },
            'TSLA': { avg: 2, min: 1, max: 4 },
            'AAPL': { avg: 4, min: 1, max: 8 },
            'AMD': { avg: 2, min: 1, max: 5 },
            'META': { avg: 3, min: 1, max: 6 }
        };

        var defaults = defaultDurations[symbol] || { avg: 4, min: 1, max: 10 };
        result.avgDays = defaults.avg;
        result.minDays = defaults.min;
        result.maxDays = defaults.max;
        result.medianDays = defaults.avg;
        result.confidence = 'ESTIMATED';
    } else {
        // Calculate statistics
        var sortedDays = durations.map(function(d) { return d.daysPerLevel; }).sort(function(a, b) { return a - b; });

        var sum = sortedDays.reduce(function(a, b) { return a + b; }, 0);
        result.avgDays = Math.round(sum / sortedDays.length * 10) / 10;
        result.minDays = Math.round(sortedDays[0] * 10) / 10;
        result.maxDays = Math.round(sortedDays[sortedDays.length - 1] * 10) / 10;
        result.medianDays = Math.round(sortedDays[Math.floor(sortedDays.length / 2)] * 10) / 10;
        result.transitions = durations.slice(-10); // Last 10 transitions
        result.sampleSize = durations.length;
        result.confidence = durations.length >= 20 ? 'HIGH' : durations.length >= 10 ? 'MEDIUM' : 'LOW';
    }

    // Calculate recommended DTE based on average days
    // Add buffer: recommend 1.5x to 2x the average duration
    var bufferMultiplier = 1.75;
    var recommendedDays = Math.ceil(result.avgDays * bufferMultiplier);

    // Round to standard option expirations
    if (recommendedDays <= 3) {
        result.recommendedDTE = 3;
        result.expiryType = '0-3 DTE (Mon/Wed/Fri)';
    } else if (recommendedDays <= 7) {
        result.recommendedDTE = 7;
        result.expiryType = 'Weekly';
    } else if (recommendedDays <= 14) {
        result.recommendedDTE = 14;
        result.expiryType = '2-Week';
    } else if (recommendedDays <= 21) {
        result.recommendedDTE = 21;
        result.expiryType = '3-Week';
    } else {
        result.recommendedDTE = 30;
        result.expiryType = 'Monthly';
    }

    return result;
}

// Get next standard expiration date
function getNextExpiration(dte) {
    var today = new Date();
    var expiry = new Date(today);

    if (dte <= 3) {
        // Find next Mon/Wed/Fri
        var dayOfWeek = today.getDay();
        var daysToAdd = 0;

        if (dayOfWeek === 0) daysToAdd = 1; // Sun -> Mon
        else if (dayOfWeek === 1) daysToAdd = 2; // Mon -> Wed
        else if (dayOfWeek === 2) daysToAdd = 1; // Tue -> Wed
        else if (dayOfWeek === 3) daysToAdd = 2; // Wed -> Fri
        else if (dayOfWeek === 4) daysToAdd = 1; // Thu -> Fri
        else if (dayOfWeek === 5) daysToAdd = 3; // Fri -> Mon
        else if (dayOfWeek === 6) daysToAdd = 2; // Sat -> Mon

        expiry.setDate(today.getDate() + daysToAdd);
    } else if (dte <= 7) {
        // Next Friday
        var daysUntilFriday = (5 - today.getDay() + 7) % 7;
        if (daysUntilFriday === 0) daysUntilFriday = 7;
        expiry.setDate(today.getDate() + daysUntilFriday);
    } else if (dte <= 14) {
        // Friday 2 weeks out
        var daysUntilFri = (5 - today.getDay() + 7) % 7;
        if (daysUntilFri === 0) daysUntilFri = 7;
        expiry.setDate(today.getDate() + daysUntilFri + 7);
    } else if (dte <= 21) {
        // Friday 3 weeks out
        var daysToFri = (5 - today.getDay() + 7) % 7;
        if (daysToFri === 0) daysToFri = 7;
        expiry.setDate(today.getDate() + daysToFri + 14);
    } else {
        // Third Friday of next month (monthly)
        var nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
        var firstDay = nextMonth.getDay();
        var thirdFriday = 15 + (5 - firstDay + 7) % 7;
        if (thirdFriday < 15) thirdFriday += 7;
        expiry = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), thirdFriday);
    }

    return expiry;
}

// Update duration table for all symbols
function updateDurationTable() {
    var tbody = document.getElementById('durationTable');
    if (!tbody) return;

    // All 43 symbols from watchlist
    var symbols = [
        // Index ETFs (4)
        'SPY', 'QQQ', 'IWM', 'DIA',
        // Sector ETFs (9)
        'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY',
        // Mega Caps (10)
        'AAPL', 'MSFT', 'NVDA', 'TSLA', 'AMZN', 'GOOGL', 'META', 'JPM', 'AMD', 'NFLX',
        // Additional Liquid Stocks (20)
        'V', 'MA', 'UNH', 'HD', 'PG', 'BAC', 'WMT', 'DIS', 'COST', 'CRM',
        'INTC', 'CSCO', 'ADBE', 'ORCL', 'PFE', 'MRK', 'ABBV', 'LLY', 'CVX', 'XOM'
    ];

    var results = [];

    symbols.forEach(function(sym) {
        var analysis = analyzeSq9LevelDurations(sym);
        analysis.symbol = sym;
        results.push(analysis);
    });

    // Sort by average days (fastest first)
    results.sort(function(a, b) { return a.avgDays - b.avgDays; });

    var html = '';

    results.forEach(function(r) {
        var speedIcon = '';
        var speedColor = '';

        if (r.avgDays <= 2) {
            speedIcon = '';
            speedColor = '#22c55e';
        } else if (r.avgDays <= 3) {
            speedIcon = '';
            speedColor = '#3b82f6';
        } else if (r.avgDays <= 5) {
            speedIcon = '';
            speedColor = '#f59e0b';
        } else {
            speedIcon = '';
            speedColor = '#6b7280';
        }

        var isEtf = r.symbol.startsWith('X') || ['SPY', 'QQQ', 'IWM', 'DIA'].includes(r.symbol);
        var symbolBg = isEtf ? 'rgba(59,130,246,0.1)' : 'rgba(139,92,246,0.1)';

        html += '<tr style="border-bottom: 1px solid var(--border);">' +
            '<td style="padding: 10px; background: ' + symbolBg + '; font-weight: 700;">' + r.symbol + '</td>' +
            '<td style="padding: 10px; text-align: center; font-weight: 700; color: ' + speedColor + ';">' + r.avgDays + '</td>' +
            '<td style="padding: 10px; text-align: center; color: #22c55e;">' + r.minDays + '</td>' +
            '<td style="padding: 10px; text-align: center; color: #ef4444;">' + r.maxDays + '</td>' +
            '<td style="padding: 10px; text-align: center; font-size: 16px;">' + speedIcon + '</td>' +
            '<td style="padding: 10px; text-align: center; font-weight: 600;">' + r.recommendedDTE + ' DTE</td>' +
            '<td style="padding: 10px;">' + r.expiryType + '</td>' +
        '</tr>';
    });

    tbody.innerHTML = html;
}

// ============================================
// SQ9 ALERT SYSTEM
// ============================================

var sq9AlertsEnabled = true;
var sq9SoundEnabled = false;
var sq9LastReadyCount = 0;

// Create audio element for alerts
var sq9AlertSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQcFUsro6tqPKwYs0fz19dBgAACO4////+iEAABN9////+2YAABZ7v///+6bAABU8v///+2WAABZ7v///+6bAAA=');

function loadSq9ScannerResults() {
    fetch('sq9_scanner.json?t=' + Date.now())
        .then(function(response) {
            if (!response.ok) {
                throw new Error('Scanner results not found');
            }
            return response.json();
        })
        .then(function(data) {
            console.log(' Loaded SQ9 Scanner results:', data.summary);

            // Update widget time
            var widgetTimeEl = document.getElementById('sq9WidgetTime');
            if (widgetTimeEl) {
                widgetTimeEl.textContent = 'Last scan: ' + data.scan_time;
            }

            var scanTimeEl = document.getElementById('sq9ScanTime');
            if (scanTimeEl) {
                scanTimeEl.textContent = data.scan_time;
            }

            // Convert to internal format
            sq9ScanResults = data.results.map(function(r) {
                return {
                    symbol: r.symbol,
                    price: r.price,
                    sq9Level: r.sq9_level,
                    sq9Type: r.sq9_type,
                    distance: r.distance_pct,
                    direction: r.direction,
                    checks: r.checks,
                    checkCount: r.check_count,
                    status: r.status.toLowerCase(),
                    pivot: r.pivot_price,
                    pivotDate: r.pivot_date,
                    target: r.target,
                    stop: r.stop,
                    rr: r.rr_ratio,
                    missing: r.missing || [],
                    isEtf: r.is_etf
                };
            });

            // Update all displays
            updateSq9ScannerDisplay();
            updateSq9Widget();

            // Check for new READY alerts
            var readyCount = data.summary.ready;
            if (readyCount > sq9LastReadyCount && sq9LastReadyCount > 0) {
                showSq9Alert(readyCount - sq9LastReadyCount);
            }
            sq9LastReadyCount = readyCount;
        })
        .catch(function(error) {
            console.log(' Could not load scanner results:', error.message);
            // Run live scan as fallback
            if (typeof runSq9Scan === 'function') {
                runSq9Scan();
                updateSq9Widget();
            }
        });
}

function updateSq9Widget() {
    if (!sq9ScanResults || sq9ScanResults.length === 0) return;

    var ready = sq9ScanResults.filter(function(r) { return r.status === 'ready'; });
    var watching = sq9ScanResults.filter(function(r) { return r.status === 'watching'; });
    var calls = sq9ScanResults.filter(function(r) { return r.direction === 'CALL'; });
    var puts = sq9ScanResults.filter(function(r) { return r.direction === 'PUT'; });

    // Update counts
    var el = function(id) { return document.getElementById(id); };
    if (el('sq9WidgetReady')) el('sq9WidgetReady').textContent = ready.length;
    if (el('sq9WidgetWatching')) el('sq9WidgetWatching').textContent = watching.length;
    if (el('sq9WidgetCalls')) el('sq9WidgetCalls').textContent = calls.length;
    if (el('sq9WidgetPuts')) el('sq9WidgetPuts').textContent = puts.length;

    // Update ready alerts banner
    updateSq9ReadyAlerts(ready);

    // Update table (show top 8)
    var topSetups = sq9ScanResults.slice(0, 8);
    var tableHtml = '';

    if (topSetups.length === 0) {
        tableHtml = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">No active SQ9 setups. Click Refresh to scan.</td></tr>';
    } else {
        for (var i = 0; i < topSetups.length; i++) {
            var r = topSetups[i];

            // Get REAL-TIME price from allSymbolsData if available
            var currentPrice = r.price;
            if (typeof allSymbolsData !== 'undefined' && allSymbolsData[r.symbol] && allSymbolsData[r.symbol].length > 0) {
                var latestBar = allSymbolsData[r.symbol][allSymbolsData[r.symbol].length - 1];
                currentPrice = parseFloat(latestBar.Close) || r.price;
            }

            // Recalculate distance from current price to SQ9 level
            var currentDistance = ((currentPrice - r.sq9Level) / r.sq9Level) * 100;

            var dirColor = r.direction === 'CALL' ? '#22c55e' : '#ef4444';
            var statusBadge = '';

            if (r.status === 'ready') {
                statusBadge = '<span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 700;"> READY</span>';
            } else if (r.status === 'watching') {
                statusBadge = '<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 700;"> ' + r.checkCount + '/5</span>';
            } else {
                statusBadge = '<span style="background: #e5e7eb; color: #666; padding: 2px 6px; border-radius: 4px; font-size: 9px;"> ' + r.checkCount + '/5</span>';
            }

            tableHtml += '<tr style="border-bottom: 1px solid var(--border);">' +
                '<td style="padding: 8px;"><strong>' + r.symbol + '</strong></td>' +
                '<td style="padding: 8px;">$' + currentPrice.toFixed(2) + '</td>' +
                '<td style="padding: 8px;">$' + r.sq9Level.toFixed(2) + '</td>' +
                '<td style="padding: 8px; color: ' + (currentDistance >= 0 ? '#ef4444' : '#22c55e') + ';">' + (currentDistance >= 0 ? '+' : '') + currentDistance.toFixed(1) + '%</td>' +
                '<td style="padding: 8px;"><span style="color: ' + dirColor + '; font-weight: 700;">' + r.direction + '</span></td>' +
                '<td style="padding: 8px;">' + statusBadge + '</td>' +
                '<td style="padding: 8px;">' +
                '<button onclick="quickLogSq9Trade(\'' + r.symbol + '\')" style="padding: 3px 8px; background: #22c55e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; margin-right: 4px;"></button>' +
                '<button onclick="viewSq9Detail(\'' + r.symbol + '\')" style="padding: 3px 8px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;"></button>' +
                '</td>' +
                '</tr>';
        }
    }

    var tableEl = document.getElementById('sq9WidgetTable');
    if (tableEl) tableEl.innerHTML = tableHtml;
}

function updateSq9ReadyAlerts(ready) {
    var alertsEl = document.getElementById('sq9ReadyAlerts');
    if (!alertsEl) return;

    if (ready.length === 0) {
        alertsEl.innerHTML = '';
        return;
    }

    var html = '<div class="sq9-alert-pulse" style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border-radius: 8px; padding: 12px;">' +
        '<div style="display: flex; justify-content: space-between; align-items: center;">' +
        '<div style="display: flex; align-items: center; gap: 10px;">' +
        '<span style="font-size: 24px;"></span>' +
        '<div>' +
        '<div style="font-weight: 700;">' + ready.length + ' SETUP' + (ready.length > 1 ? 'S' : '') + ' READY!</div>' +
        '<div style="font-size: 11px; opacity: 0.9;">';

    var readySymbols = ready.map(function(r) { return r.symbol + ' ' + r.direction; });
    html += readySymbols.join('  ');

    html += '</div></div></div>' +
        '<button onclick="document.querySelector(\'[data-tab=sq9-scanner]\').click()" style="padding: 8px 16px; background: white; color: #22c55e; border: none; border-radius: 6px; font-weight: 700; cursor: pointer;">TRADE NOW </button>' +
        '</div></div>';

    alertsEl.innerHTML = html;
}

function viewSq9Detail(symbol) {
    // Switch to SQ9 Scanner tab and show detail
    document.querySelector('[data-tab=sq9-scanner]').click();
    setTimeout(function() {
        showSq9Detail(symbol);
    }, 100);
}

function showSq9Alert(newCount) {
    if (!sq9AlertsEnabled) return;

    // Play sound if enabled
    if (sq9SoundEnabled) {
        try {
            sq9AlertSound.play();
        } catch (e) {
            console.log('Could not play alert sound');
        }
    }

    // Show browser notification if permitted
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(' SQ9 Alert!', {
            body: newCount + ' new setup' + (newCount > 1 ? 's' : '') + ' ready to trade!',
            icon: ''
        });
    }

    // Flash the widget
    var widget = document.getElementById('sq9ReadyAlerts');
    if (widget) {
        widget.classList.add('sq9-flash');
        setTimeout(function() {
            widget.classList.remove('sq9-flash');
        }, 1500);
    }
}

function toggleSq9Sound() {
    sq9SoundEnabled = !sq9SoundEnabled;
    var toggle = document.getElementById('sq9SoundToggle');
    if (toggle) toggle.checked = sq9SoundEnabled;
}

function requestNotificationPermission() {
    if ('Notification' in window) {
        Notification.requestPermission().then(function(permission) {
            if (permission === 'granted') {
                console.log('Browser notifications enabled!');
            }
        });
    }
}

// Auto-refresh every 5 minutes during market hours
function startSq9AutoRefresh() {
    setInterval(function() {
        var now = new Date();
        var hour = now.getHours();
        var day = now.getDay();

        // Only refresh Mon-Fri 9:30 AM - 4:00 PM ET (adjust for your timezone)
        if (day >= 1 && day <= 5 && hour >= 9 && hour < 16) {
            console.log(' Auto-refreshing SQ9 Scanner...');
            loadSq9ScannerResults();
        }
    }, 5 * 60 * 1000); // Every 5 minutes
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load scanner results after 2 seconds
    setTimeout(loadSq9ScannerResults, 2000);

    // Start auto-refresh
    startSq9AutoRefresh();

    // Request notification permission
    requestNotificationPermission();

    // Load SQ9 trades from storage
    loadSq9Trades();

    // Initialize option cost calculator
    initOptionCostCalc();
// Auto-scan historical patterns after 4 seconds
    setTimeout(function() {
        if (typeof scanHistoricalPatterns === "function") {
            console.log(" Auto-scanning historical patterns...");
            scanHistoricalPatterns().then(function() { console.log(" Scan complete"); if (typeof updateTopSetups === "function") updateTopSetups(); }).catch(function(e) { console.error(" Scan error:", e); });
        }
    }, 4000);
});

// ============================================
// SQ9 PERFORMANCE TRACKING SYSTEM
// ============================================

const SQ9_TRADES_KEY = 'sq9Trades';
var sq9Trades = [];
var sq9EquityChart = null;

// Load trades from localStorage
function loadSq9Trades() {
    try {
        var saved = localStorage.getItem(SQ9_TRADES_KEY);
        if (saved) {
            sq9Trades = JSON.parse(saved);
        }
    } catch (e) {
        console.error('Error loading SQ9 trades:', e);
        sq9Trades = [];
    }
    updateSq9PerformanceDisplay();
}

// Save trades to localStorage
function saveSq9TradesToStorage() {
    try {
        localStorage.setItem(SQ9_TRADES_KEY, JSON.stringify(sq9Trades));
    } catch (e) {
        console.error('Error saving SQ9 trades:', e);
    }
}

// Quick log trade from scanner
function quickLogSq9Trade(symbol) {
    var result = sq9ScanResults.find(function(r) { return r.symbol === symbol; });
    if (!result) {
        alert('Setup not found for ' + symbol);
        return;
    }

    // Open modal with prefilled data
    openSq9TradeModal({
        symbol: result.symbol,
        direction: result.direction,
        price: result.price,
        sq9Level: result.sq9Level,
        checkCount: result.checkCount,
        target: result.target,
        stop: result.stop
    });
}

// Open trade log modal
function openSq9TradeModal(prefillData) {
    var modal = document.getElementById('sq9TradeModal');
    modal.style.display = 'flex';

    // Set default date to today
    document.getElementById('sq9TradeDate').value = new Date().toISOString().split('T')[0];

    // Prefill from scanner if data provided
    if (prefillData) {
        document.getElementById('sq9TradeSymbol').value = prefillData.symbol || '';
        document.getElementById('sq9TradeDirection').value = prefillData.direction || '';
        document.getElementById('sq9TradeEntry').value = prefillData.price || '';
        document.getElementById('sq9TradeLevel').value = prefillData.sq9Level || '';
        document.getElementById('sq9TradeChecks').value = prefillData.checkCount || '5';
        document.getElementById('sq9TradeTarget').value = prefillData.target || '';
        document.getElementById('sq9TradeStop').value = prefillData.stop || '';
    }
}

function closeSq9TradeModal() {
    document.getElementById('sq9TradeModal').style.display = 'none';
    document.getElementById('sq9TradeForm').reset();
}

// Save new trade
// Toggle between stock and options trade type
function toggleTradeType(type) {
    document.getElementById('sq9TradeType').value = type;

    // Update button styles
    document.querySelectorAll('.trade-type-btn').forEach(function(btn) {
        if (btn.dataset.type === type) {
            btn.style.background = 'var(--primary)';
            btn.style.borderColor = 'var(--primary)';
            btn.style.color = 'white';
        } else {
            btn.style.background = 'white';
            btn.style.borderColor = 'var(--border)';
            btn.style.color = 'var(--text)';
        }
    });

    // Show/hide fields
    document.getElementById('optionsFields').style.display = type === 'option' ? 'block' : 'none';
    document.getElementById('stockFields').style.display = type === 'stock' ? 'block' : 'none';
}

// Calculate option cost in real-time
function initOptionCostCalc() {
    var premiumEl = document.getElementById('sq9OptionPremium');
    var contractsEl = document.getElementById('sq9OptionContracts');

    if (premiumEl && contractsEl) {
        var calcCost = function() {
            var premium = parseFloat(premiumEl.value) || 0;
            var contracts = parseInt(contractsEl.value) || 0;
            var totalCost = premium * contracts * 100;

            var calcEl = document.getElementById('optionCostCalc');
            if (calcEl) {
                if (totalCost > 0) {
                    calcEl.textContent = 'Total Cost: $' + totalCost.toFixed(2) + ' (' + contracts + ' x $' + premium.toFixed(2) + ' x 100)';
                } else {
                    calcEl.textContent = '--';
                }
            }
        };

        premiumEl.addEventListener('input', calcCost);
        contractsEl.addEventListener('input', calcCost);
    }
}

function saveSq9Trade(event) {
    event.preventDefault();

    var tradeType = document.getElementById('sq9TradeType').value;

    var trade = {
        id: Date.now(),
        type: tradeType,
        symbol: document.getElementById('sq9TradeSymbol').value,
        direction: document.getElementById('sq9TradeDirection').value,
        entryDate: document.getElementById('sq9TradeDate').value,
        entryPrice: parseFloat(document.getElementById('sq9TradeEntry').value),
        sq9Level: parseFloat(document.getElementById('sq9TradeLevel').value),
        checks: parseInt(document.getElementById('sq9TradeChecks').value),
        target: parseFloat(document.getElementById('sq9TradeTarget').value),
        stop: parseFloat(document.getElementById('sq9TradeStop').value),
        notes: document.getElementById('sq9TradeNotes').value,
        status: 'open',
        exitDate: null,
        exitPrice: null,
        exitReason: null,
        pnl: null
    };

    if (tradeType === 'option') {
        trade.optionStrike = parseFloat(document.getElementById('sq9OptionStrike').value) || 0;
        trade.optionExpiry = document.getElementById('sq9OptionExpiry').value;
        trade.optionContracts = parseInt(document.getElementById('sq9OptionContracts').value) || 1;
        trade.optionPremium = parseFloat(document.getElementById('sq9OptionPremium').value) || 0;
        trade.optionDelta = parseFloat(document.getElementById('sq9OptionDelta').value) || 0;
        trade.optionIV = parseFloat(document.getElementById('sq9OptionIV').value) || 0;
        trade.size = trade.optionPremium * trade.optionContracts * 100; // Total cost
        trade.strike = trade.optionStrike + (trade.direction === 'CALL' ? 'C' : 'P');
    } else {
        trade.size = parseFloat(document.getElementById('sq9TradeSize').value) || 0;
        trade.shares = parseInt(document.getElementById('sq9TradeShares').value) || 0;
    }

    sq9Trades.push(trade);
    saveSq9TradesToStorage();
    updateSq9PerformanceDisplay();
    closeSq9TradeModal();

    alert('Trade logged successfully!');
}

// Open close trade modal
function openSq9CloseModal(tradeId) {
    var modal = document.getElementById('sq9CloseModal');
    modal.style.display = 'flex';
    document.getElementById('sq9CloseTradeId').value = tradeId;
    document.getElementById('sq9CloseDate').value = new Date().toISOString().split('T')[0];
}

function closeSq9CloseModal() {
    document.getElementById('sq9CloseModal').style.display = 'none';
}

// Confirm close trade
function confirmCloseTrade() {
    var tradeId = parseInt(document.getElementById('sq9CloseTradeId').value);
    var exitDate = document.getElementById('sq9CloseDate').value;
    var exitPrice = parseFloat(document.getElementById('sq9ClosePrice').value);
    var exitReason = document.getElementById('sq9CloseReason').value;

    var trade = sq9Trades.find(function(t) { return t.id === tradeId; });
    if (!trade) return;

    trade.exitDate = exitDate;
    trade.exitPrice = exitPrice;
    trade.exitReason = exitReason;
    trade.status = 'closed';

    // Calculate P&L based on trade type
    if (trade.type === 'option') {
        // Options P&L: (Exit Premium - Entry Premium) x Contracts x 100
        var exitPremium = exitPrice; // Exit price is the premium received when selling
        trade.pnl = (exitPremium - trade.optionPremium) * trade.optionContracts * 100;
    } else {
        // Stock P&L
        var priceChange = exitPrice - trade.entryPrice;
        if (trade.direction === 'PUT') {
            priceChange = trade.entryPrice - exitPrice; // Inverse for puts/shorts
        }
        var pctChange = (priceChange / trade.entryPrice) * 100;
        trade.pnl = (trade.size * pctChange / 100);
    }

    saveSq9TradesToStorage();
    updateSq9PerformanceDisplay();
    closeSq9CloseModal();

    var pnlStr = trade.pnl >= 0 ? '+$' + trade.pnl.toFixed(2) : '-$' + Math.abs(trade.pnl).toFixed(2);
    alert('Trade closed! P&L: ' + pnlStr);
}

// Delete trade
function deleteSq9Trade(tradeId) {
    if (!confirm('Are you sure you want to delete this trade?')) return;

    sq9Trades = sq9Trades.filter(function(t) { return t.id !== tradeId; });
    saveSq9TradesToStorage();
    updateSq9PerformanceDisplay();
}

// Filter trades
function filterSq9Trades() {
    updateSq9PerformanceDisplay();
}

// Update all performance displays
function updateSq9PerformanceDisplay() {
    var closedTrades = sq9Trades.filter(function(t) { return t.status === 'closed'; });
    var openTrades = sq9Trades.filter(function(t) { return t.status === 'open'; });

    var wins = closedTrades.filter(function(t) { return t.pnl > 0; });
    var losses = closedTrades.filter(function(t) { return t.pnl <= 0; });

    var totalPnL = closedTrades.reduce(function(sum, t) { return sum + (t.pnl || 0); }, 0);
    var avgWin = wins.length > 0 ? wins.reduce(function(sum, t) { return sum + t.pnl; }, 0) / wins.length : 0;
    var avgLoss = losses.length > 0 ? Math.abs(losses.reduce(function(sum, t) { return sum + t.pnl; }, 0) / losses.length) : 0;
    var winRate = closedTrades.length > 0 ? (wins.length / closedTrades.length * 100) : 0;

    // Update summary cards
    var el = function(id) { return document.getElementById(id); };
    if (el('sq9TotalTrades')) el('sq9TotalTrades').textContent = sq9Trades.length;
    if (el('sq9WinRate')) el('sq9WinRate').textContent = winRate.toFixed(0) + '%';
    if (el('sq9Wins')) el('sq9Wins').textContent = wins.length;
    if (el('sq9Losses')) el('sq9Losses').textContent = losses.length;
    if (el('sq9TotalPnL')) {
        el('sq9TotalPnL').textContent = (totalPnL >= 0 ? '+$' : '-$') + Math.abs(totalPnL).toFixed(0);
        el('sq9TotalPnL').style.color = totalPnL >= 0 ? '#22c55e' : '#ef4444';
    }
    if (el('sq9AvgWin')) el('sq9AvgWin').textContent = '+$' + avgWin.toFixed(0);
    if (el('sq9AvgLoss')) el('sq9AvgLoss').textContent = '-$' + avgLoss.toFixed(0);

    // Update by direction
    var callTrades = closedTrades.filter(function(t) { return t.direction === 'CALL'; });
    var putTrades = closedTrades.filter(function(t) { return t.direction === 'PUT'; });
    var callWins = callTrades.filter(function(t) { return t.pnl > 0; });
    var putWins = putTrades.filter(function(t) { return t.pnl > 0; });

    if (el('sq9CallWinRate')) el('sq9CallWinRate').textContent = (callTrades.length > 0 ? (callWins.length / callTrades.length * 100).toFixed(0) : 0) + '%';
    if (el('sq9CallRecord')) el('sq9CallRecord').textContent = callWins.length + 'W - ' + (callTrades.length - callWins.length) + 'L';
    if (el('sq9PutWinRate')) el('sq9PutWinRate').textContent = (putTrades.length > 0 ? (putWins.length / putTrades.length * 100).toFixed(0) : 0) + '%';
    if (el('sq9PutRecord')) el('sq9PutRecord').textContent = putWins.length + 'W - ' + (putTrades.length - putWins.length) + 'L';

    // Update by check count
    for (var c = 3; c <= 5; c++) {
        var checkTrades = closedTrades.filter(function(t) { return t.checks === c; });
        var checkWins = checkTrades.filter(function(t) { return t.pnl > 0; });
        var checkWinRate = checkTrades.length > 0 ? (checkWins.length / checkTrades.length * 100).toFixed(0) : 0;
        if (el('sq9Ready' + c + 'WinRate')) el('sq9Ready' + c + 'WinRate').textContent = checkWinRate + '%';
    }

    // Update trade log table
    updateSq9TradeLogTable();

    // Update equity chart
    updateSq9EquityChart();
}

function updateSq9TradeLogTable() {
    var filter = document.getElementById('sq9TradeFilter') ? document.getElementById('sq9TradeFilter').value : 'all';

    var filteredTrades = sq9Trades.filter(function(t) {
        if (filter === 'all') return true;
        if (filter === 'open') return t.status === 'open';
        if (filter === 'closed') return t.status === 'closed';
        if (filter === 'win') return t.status === 'closed' && t.pnl > 0;
        if (filter === 'loss') return t.status === 'closed' && t.pnl <= 0;
        return true;
    });

    // Sort by date (newest first)
    filteredTrades.sort(function(a, b) {
        return new Date(b.entryDate) - new Date(a.entryDate);
    });

    var tbody = document.getElementById('sq9TradeLogTable');
    if (!tbody) return;

    if (filteredTrades.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 30px; color: #999;">No trades match your filter.</td></tr>';
        return;
    }

    var html = '';
    for (var i = 0; i < filteredTrades.length; i++) {
        var t = filteredTrades[i];
        var dirColor = t.direction === 'CALL' ? '#22c55e' : '#ef4444';
        var pnlColor = t.pnl > 0 ? '#22c55e' : t.pnl < 0 ? '#ef4444' : '#666';

        // Type icon and symbol display
        var typeIcon = t.type === 'option' ? '' : '';
        var symbolDisplay = t.symbol;
        if (t.type === 'option' && t.optionStrike) {
            symbolDisplay += ' ' + t.optionStrike + (t.direction === 'CALL' ? 'C' : 'P');
        }

        // Size display
        var sizeDisplay = t.type === 'option'
            ? t.optionContracts + ' x $' + (t.optionPremium || 0).toFixed(2)
            : '$' + (t.size || 0).toFixed(0);

        var statusBadge = t.status === 'open'
            ? '<span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px;">OPEN</span>'
            : t.pnl > 0
                ? '<span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px;">WIN </span>'
                : '<span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px;">LOSS </span>';

        html += '<tr style="border-bottom: 1px solid var(--border);">' +
            '<td style="padding: 10px;">' + t.entryDate + '</td>' +
            '<td style="padding: 10px;"><strong>' + typeIcon + ' ' + symbolDisplay + '</strong></td>' +
            '<td style="padding: 10px;"><span style="color: ' + dirColor + '; font-weight: 700;">' + t.direction + '</span></td>' +
            '<td style="padding: 10px;">$' + t.entryPrice.toFixed(2) + '</td>' +
            '<td style="padding: 10px;">$' + t.sq9Level.toFixed(2) + '</td>' +
            '<td style="padding: 10px;">' + t.checks + '/5</td>' +
            '<td style="padding: 10px; color: #22c55e;">$' + t.target.toFixed(2) + '</td>' +
            '<td style="padding: 10px; color: #ef4444;">$' + t.stop.toFixed(2) + '</td>' +
            '<td style="padding: 10px;">' + (t.exitPrice ? '$' + t.exitPrice.toFixed(2) : '--') + '</td>' +
            '<td style="padding: 10px; font-weight: 700; color: ' + pnlColor + ';">' + (t.pnl !== null ? (t.pnl >= 0 ? '+$' : '-$') + Math.abs(t.pnl).toFixed(0) : '--') + '</td>' +
            '<td style="padding: 10px;">' + statusBadge + '</td>' +
            '<td style="padding: 10px;">' +
                (t.status === 'open'
                    ? '<button onclick="openSq9CloseModal(' + t.id + ')" style="padding: 3px 8px; background: #22c55e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; margin-right: 5px;">Close</button>'
                    : '') +
                '<button onclick="deleteSq9Trade(' + t.id + ')" style="padding: 3px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;"></button>' +
            '</td>' +
            '</tr>';
    }

    tbody.innerHTML = html;
}

function updateSq9EquityChart() {
    var canvas = document.getElementById('sq9EquityChart');
    if (!canvas) return;

    var closedTrades = sq9Trades
        .filter(function(t) { return t.status === 'closed'; })
        .sort(function(a, b) { return new Date(a.exitDate) - new Date(b.exitDate); });

    if (closedTrades.length === 0) {
        // Show empty state
        var ctx = canvas.getContext('2d');
        canvas.width = canvas.parentElement.offsetWidth;
        canvas.height = 250;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#999';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('Close trades to see equity curve', canvas.width / 2, canvas.height / 2);
        return;
    }

    // Calculate cumulative P&L
    var labels = ['Start'];
    var data = [0];
    var cumulative = 0;

    for (var i = 0; i < closedTrades.length; i++) {
        cumulative += closedTrades[i].pnl;
        labels.push(closedTrades[i].exitDate);
        data.push(cumulative);
    }

    // Destroy existing chart
    if (sq9EquityChart) {
        sq9EquityChart.destroy();
    }

    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.log('Chart.js not loaded, skipping equity chart');
        return;
    }

    // Create new chart
    sq9EquityChart = new Chart(canvas, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Cumulative P&L',
                data: data,
                borderColor: cumulative >= 0 ? '#22c55e' : '#ef4444',
                backgroundColor: cumulative >= 0 ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 4,
                pointBackgroundColor: cumulative >= 0 ? '#22c55e' : '#ef4444'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) { return '$' + value; }
                    }
                }
            }
        }
    });
}

// Export performance data
function exportSq9Performance() {
    var csv = 'Date,Symbol,Direction,Entry,SQ9 Level,Checks,Target,Stop,Exit,P&L,Status\n';

    for (var i = 0; i < sq9Trades.length; i++) {
        var t = sq9Trades[i];
        csv += t.entryDate + ',' + t.symbol + ',' + t.direction + ',' + t.entryPrice + ',' +
               t.sq9Level + ',' + t.checks + ',' + t.target + ',' + t.stop + ',' +
               (t.exitPrice || '') + ',' + (t.pnl !== null ? t.pnl.toFixed(2) : '') + ',' + t.status + '\n';
    }

    var blob = new Blob([csv], { type: 'text/csv' });
    var url = window.URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'sq9_performance_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Run SQ9 Backtest on historical data
function runSq9Backtest() {
    // Show backtest panel
    var panel = document.getElementById('sq9BacktestPanel');
    panel.style.display = 'block';

    // Calculate stats from actual trades
    var closedTrades = sq9Trades.filter(function(t) { return t.status === 'closed'; });

    if (closedTrades.length < 3) {
        document.getElementById('sq9BacktestResults').innerHTML =
            '<div style="text-align: center; padding: 20px; color: #666;">' +
            '<div style="font-size: 32px; margin-bottom: 10px;"></div>' +
            '<div>Need at least 3 closed trades to run backtest analysis.</div>' +
            '<div style="font-size: 12px; margin-top: 10px;">Current: ' + closedTrades.length + ' closed trades</div>' +
            '</div>';
        return;
    }

    var wins = closedTrades.filter(function(t) { return t.pnl > 0; });
    var losses = closedTrades.filter(function(t) { return t.pnl <= 0; });
    var winRate = (wins.length / closedTrades.length * 100).toFixed(1);
    var totalPnL = closedTrades.reduce(function(sum, t) { return sum + t.pnl; }, 0);
    var avgWin = wins.length > 0 ? wins.reduce(function(sum, t) { return sum + t.pnl; }, 0) / wins.length : 0;
    var avgLoss = losses.length > 0 ? Math.abs(losses.reduce(function(sum, t) { return sum + t.pnl; }, 0) / losses.length) : 0;
    var profitFactor = avgLoss > 0 ? (avgWin * wins.length) / (avgLoss * losses.length) : 0;

    // Performance by check count
    var checkStats = [];
    for (var c = 3; c <= 5; c++) {
        var checkTrades = closedTrades.filter(function(t) { return t.checks === c; });
        var checkWins = checkTrades.filter(function(t) { return t.pnl > 0; });
        checkStats.push({
            checks: c,
            total: checkTrades.length,
            wins: checkWins.length,
            winRate: checkTrades.length > 0 ? (checkWins.length / checkTrades.length * 100).toFixed(0) : 0
        });
    }

    var html = '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">' +
        '<div style="background: rgba(255,255,255,0.5); border-radius: 8px; padding: 15px; text-align: center;">' +
        '<div style="font-size: 10px; color: #666;">TOTAL TRADES</div>' +
        '<div style="font-size: 24px; font-weight: 800;">' + closedTrades.length + '</div>' +
        '</div>' +
        '<div style="background: rgba(34,197,94,0.2); border-radius: 8px; padding: 15px; text-align: center;">' +
        '<div style="font-size: 10px; color: #166534;">WIN RATE</div>' +
        '<div style="font-size: 24px; font-weight: 800; color: #22c55e;">' + winRate + '%</div>' +
        '</div>' +
        '<div style="background: rgba(59,130,246,0.2); border-radius: 8px; padding: 15px; text-align: center;">' +
        '<div style="font-size: 10px; color: #1e40af;">PROFIT FACTOR</div>' +
        '<div style="font-size: 24px; font-weight: 800; color: #3b82f6;">' + profitFactor.toFixed(2) + '</div>' +
        '</div>' +
        '<div style="background: ' + (totalPnL >= 0 ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)') + '; border-radius: 8px; padding: 15px; text-align: center;">' +
        '<div style="font-size: 10px; color: ' + (totalPnL >= 0 ? '#166534' : '#991b1b') + ';">TOTAL P&L</div>' +
        '<div style="font-size: 24px; font-weight: 800; color: ' + (totalPnL >= 0 ? '#22c55e' : '#ef4444') + ';">' + (totalPnL >= 0 ? '+$' : '-$') + Math.abs(totalPnL).toFixed(0) + '</div>' +
        '</div>' +
        '</div>';

    html += '<div style="font-weight: 600; margin-bottom: 10px;"> Performance by Entry Quality:</div>' +
        '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">';

    for (var j = 0; j < checkStats.length; j++) {
        var s = checkStats[j];
        html += '<div style="background: rgba(255,255,255,0.5); border-radius: 6px; padding: 10px; text-align: center;">' +
            '<div style="font-size: 11px; color: #666;">' + s.checks + '/5 CHECKS</div>' +
            '<div style="font-size: 18px; font-weight: 700;">' + s.winRate + '%</div>' +
            '<div style="font-size: 10px; color: #999;">' + s.wins + 'W / ' + (s.total - s.wins) + 'L</div>' +
            '</div>';
    }
    html += '</div>';

    html += '<div style="margin-top: 15px; padding: 10px; background: rgba(59,130,246,0.1); border-radius: 6px; font-size: 12px;">' +
        ' <strong>Insight:</strong> ';

    if (checkStats[2].total > 0 && parseFloat(checkStats[2].winRate) > parseFloat(checkStats[0].winRate)) {
        html += '5/5 READY entries show higher win rates. Consider waiting for full confirmation.';
    } else if (winRate >= 60) {
        html += 'Strong overall performance! Your SQ9 strategy is working well.';
    } else if (winRate >= 50) {
        html += 'Solid performance. Focus on higher quality setups to improve win rate.';
    } else {
        html += 'Review your entry criteria. Consider only taking 5/5 or 4/5 setups.';
    }
    html += '</div>';

    document.getElementById('sq9BacktestResults').innerHTML = html;
}

// ============================================
// SQ9 HISTORICAL BACKTEST ENGINE
// ============================================

var historicalBacktestResults = null;

function runSq9HistoricalBacktest(settings) {
    console.log(' Starting SQ9 Historical Backtest...');

    var symbols = settings.symbols || ['SPY', 'QQQ', 'IWM', 'DIA', 'XLF', 'XLE', 'XLK'];
    var lookbackDays = settings.lookbackDays || 180;
    var minChecks = settings.minChecks || 4;
    var useStops = settings.useStops !== false;
    var positionSize = settings.positionSize || 1000;

    var allTrades = [];
    var symbolStats = {};

    for (var i = 0; i < symbols.length; i++) {
        var sym = symbols[i];
        console.log('   Backtesting ' + sym + '...');

        var priceData = allSymbolsData[sym];
        if (!priceData || priceData.length < 50) {
            console.log('     Insufficient data for ' + sym);
            continue;
        }

        // Get pivot for this symbol
        var pivot = sq9ExtendedPivots[sym];
        if (!pivot || !pivot.price) {
            console.log('     No pivot found for ' + sym);
            continue;
        }

        var trades = backtestSymbol(sym, priceData, pivot, {
            minChecks: minChecks,
            useStops: useStops,
            positionSize: positionSize,
            lookbackDays: lookbackDays
        });

        allTrades = allTrades.concat(trades);

        // Calculate symbol stats
        var wins = trades.filter(function(t) { return t.pnl > 0; });
        symbolStats[sym] = {
            totalTrades: trades.length,
            wins: wins.length,
            losses: trades.length - wins.length,
            winRate: trades.length > 0 ? (wins.length / trades.length * 100).toFixed(1) : 0,
            totalPnL: trades.reduce(function(sum, t) { return sum + t.pnl; }, 0)
        };
    }

    // Sort trades by date
    allTrades.sort(function(a, b) {
        return new Date(a.entryDate) - new Date(b.entryDate);
    });

    // Calculate equity curve
    var equity = positionSize * symbols.length;
    var equityCurve = [{ date: allTrades[0] ? allTrades[0].entryDate : new Date().toISOString().split('T')[0], equity: equity }];

    for (var j = 0; j < allTrades.length; j++) {
        equity += allTrades[j].pnl;
        equityCurve.push({
            date: allTrades[j].exitDate,
            equity: equity,
            trade: allTrades[j]
        });
    }

    historicalBacktestResults = {
        settings: settings,
        trades: allTrades,
        symbolStats: symbolStats,
        equityCurve: equityCurve,
        summary: calculateBacktestSummary(allTrades, positionSize * symbols.length)
    };

    console.log(' Backtest complete: ' + allTrades.length + ' trades analyzed');
    return historicalBacktestResults;
}

function backtestSymbol(symbol, priceData, pivot, settings) {
    var trades = [];
    var inTrade = false;
    var currentTrade = null;

    // Calculate how many bars to look back
    var startIdx = Math.max(0, priceData.length - settings.lookbackDays);

    for (var i = startIdx; i < priceData.length; i++) {
        var bar = priceData[i];
        var currentPrice = parseFloat(bar.Close);
        var high = parseFloat(bar.High);
        var low = parseFloat(bar.Low);
        var date = bar.Date;

        if (!inTrade) {
            // Check for entry signal
            var signal = checkEntrySignal(symbol, bar, priceData.slice(Math.max(0, i - 20), i + 1), pivot, settings);

            if (signal && signal.checkCount >= settings.minChecks) {
                inTrade = true;
                currentTrade = {
                    symbol: symbol,
                    direction: signal.direction,
                    entryDate: date,
                    entryPrice: currentPrice,
                    sq9Level: signal.sq9Level,
                    checkCount: signal.checkCount,
                    checks: signal.checks,
                    target: signal.target,
                    stop: signal.stop,
                    positionSize: settings.positionSize
                };
            }
        } else {
            // Check for exit
            var exitResult = checkTradeExit(currentTrade, bar, settings.useStops);

            if (exitResult.exit) {
                currentTrade.exitDate = date;
                currentTrade.exitPrice = exitResult.price;
                currentTrade.exitReason = exitResult.reason;

                // Calculate P&L
                if (currentTrade.direction === 'CALL') {
                    currentTrade.pnl = (currentTrade.exitPrice - currentTrade.entryPrice) / currentTrade.entryPrice * settings.positionSize;
                } else {
                    currentTrade.pnl = (currentTrade.entryPrice - currentTrade.exitPrice) / currentTrade.entryPrice * settings.positionSize;
                }

                currentTrade.pnlPct = currentTrade.pnl / settings.positionSize * 100;
                trades.push(currentTrade);
                inTrade = false;
                currentTrade = null;
            }
        }
    }

    // Close any open trade at last bar
    if (inTrade && currentTrade) {
        var lastBar = priceData[priceData.length - 1];
        currentTrade.exitDate = lastBar.Date;
        currentTrade.exitPrice = parseFloat(lastBar.Close);
        currentTrade.exitReason = 'END';

        if (currentTrade.direction === 'CALL') {
            currentTrade.pnl = (currentTrade.exitPrice - currentTrade.entryPrice) / currentTrade.entryPrice * settings.positionSize;
        } else {
            currentTrade.pnl = (currentTrade.entryPrice - currentTrade.exitPrice) / currentTrade.entryPrice * settings.positionSize;
        }
        currentTrade.pnlPct = currentTrade.pnl / settings.positionSize * 100;
        trades.push(currentTrade);
    }

    return trades;
}

function checkEntrySignal(symbol, bar, recentBars, pivot, settings) {
    var currentPrice = parseFloat(bar.Close);
    var high = parseFloat(bar.High);
    var low = parseFloat(bar.Low);
    var open = parseFloat(bar.Open);

    // Calculate SQ9 levels from pivot
    var levels = calcSq9LevelsFromPivot(pivot.price, currentPrice);
    if (!levels || levels.length === 0) return null;

    var nearest = findNearestSq9Level(levels, currentPrice);
    if (!nearest) return null;

    var distPct = Math.abs((currentPrice - nearest.price) / nearest.price * 100);

    // Must be within 2% of level
    if (distPct > 2.0) return null;

    // Determine direction based on price TREND, not just level type
    var direction;
    var prevBar = recentBars.length > 1 ? recentBars[recentBars.length - 2] : bar;
    var priceChange = currentPrice - parseFloat(prevBar.Close);

    // Check 3-bar trend for stronger signal
    var trend3Bar = 0;
    if (recentBars.length >= 4) {
        var bar3Ago = parseFloat(recentBars[recentBars.length - 4].Close);
        trend3Bar = currentPrice - bar3Ago;
    }

    if (trend3Bar < -0.3 || priceChange < 0) {
        direction = 'PUT';
    } else if (trend3Bar > 0.3 || priceChange > 0) {
        direction = 'CALL';
    } else {
        // Fallback: use level type
        direction = nearest.type === 'RESIST' ? 'PUT' : 'CALL';
    }

    // Calculate checks
    var checks = {
        touched: distPct <= 1.5,
        candle: false,
        volume: false,
        rsi: false,
        closed: false
    };

    // Candle pattern check - reversal pattern at level
    if (direction === 'CALL') {
        // Bullish reversal: low touched level, closed higher
        checks.candle = low <= nearest.price * 1.01 && currentPrice > open;
    } else {
        // Bearish reversal: high touched level, closed lower
        checks.candle = high >= nearest.price * 0.99 && currentPrice < open;
    }

    // Volume check - above average (simplified)
    if (recentBars.length >= 10) {
        var avgVolume = 0;
        for (var v = 0; v < recentBars.length - 1; v++) {
            avgVolume += parseFloat(recentBars[v].Volume) || 0;
        }
        avgVolume = avgVolume / (recentBars.length - 1);
        var currentVolume = parseFloat(bar.Volume) || 0;
        checks.volume = currentVolume > avgVolume * 0.8;
    }

    // RSI check - simplified using price momentum
    if (recentBars.length >= 5) {
        var momentum = 0;
        for (var m = recentBars.length - 5; m < recentBars.length - 1; m++) {
            momentum += parseFloat(recentBars[m + 1].Close) - parseFloat(recentBars[m].Close);
        }
        if (direction === 'CALL') {
            checks.rsi = momentum < 0; // Oversold (price falling)
        } else {
            checks.rsi = momentum > 0; // Overbought (price rising)
        }
    }

    // Closed beyond level check
    if (direction === 'CALL') {
        checks.closed = currentPrice > nearest.price && checks.candle;
    } else {
        checks.closed = currentPrice < nearest.price && checks.candle;
    }

    var checkCount = 0;
    for (var c in checks) {
        if (checks[c]) checkCount++;
    }

    if (checkCount < settings.minChecks) return null;

    // Calculate target and stop
    var sqrtPivot = Math.sqrt(pivot.price);
    var rotation = nearest.rotation;
    var targetRot, stopRot;

    if (direction === 'CALL') {
        targetRot = rotation + 0.5;
        stopRot = rotation - 0.5;
    } else {
        targetRot = rotation - 0.5;
        stopRot = rotation + 0.5;
    }

    var target = Math.pow(sqrtPivot + targetRot * 0.5, 2);
    var stop = Math.pow(sqrtPivot + stopRot * 0.5, 2);

    return {
        direction: direction,
        sq9Level: nearest.price,
        rotation: rotation,
        checkCount: checkCount,
        checks: checks,
        target: target,
        stop: stop
    };
}

function checkTradeExit(trade, bar, useStops) {
    var high = parseFloat(bar.High);
    var low = parseFloat(bar.Low);
    var close = parseFloat(bar.Close);

    if (trade.direction === 'CALL') {
        // Check target hit
        if (high >= trade.target) {
            return { exit: true, price: trade.target, reason: 'TARGET' };
        }
        // Check stop hit
        if (useStops && low <= trade.stop) {
            return { exit: true, price: trade.stop, reason: 'STOP' };
        }
    } else {
        // PUT direction
        // Check target hit
        if (low <= trade.target) {
            return { exit: true, price: trade.target, reason: 'TARGET' };
        }
        // Check stop hit
        if (useStops && high >= trade.stop) {
            return { exit: true, price: trade.stop, reason: 'STOP' };
        }
    }

    return { exit: false };
}

function calculateBacktestSummary(trades, startingCapital) {
    if (trades.length === 0) {
        return {
            totalTrades: 0,
            wins: 0,
            losses: 0,
            winRate: 0,
            totalPnL: 0,
            avgWin: 0,
            avgLoss: 0,
            profitFactor: 0,
            maxDrawdown: 0,
            sharpeRatio: 0
        };
    }

    var wins = trades.filter(function(t) { return t.pnl > 0; });
    var losses = trades.filter(function(t) { return t.pnl <= 0; });

    var totalWin = wins.reduce(function(s, t) { return s + t.pnl; }, 0);
    var totalLoss = Math.abs(losses.reduce(function(s, t) { return s + t.pnl; }, 0));

    var avgWin = wins.length > 0 ? totalWin / wins.length : 0;
    var avgLoss = losses.length > 0 ? totalLoss / losses.length : 0;
    var profitFactor = totalLoss > 0 ? totalWin / totalLoss : totalWin > 0 ? 999 : 0;

    // Calculate max drawdown
    var equity = startingCapital;
    var peak = equity;
    var maxDrawdown = 0;

    for (var i = 0; i < trades.length; i++) {
        equity += trades[i].pnl;
        if (equity > peak) peak = equity;
        var drawdown = (peak - equity) / peak * 100;
        if (drawdown > maxDrawdown) maxDrawdown = drawdown;
    }

    // Calculate by check count
    var byChecks = {};
    for (var c = 3; c <= 5; c++) {
        var checkTrades = trades.filter(function(t) { return t.checkCount === c; });
        var checkWins = checkTrades.filter(function(t) { return t.pnl > 0; });
        byChecks[c] = {
            total: checkTrades.length,
            wins: checkWins.length,
            winRate: checkTrades.length > 0 ? (checkWins.length / checkTrades.length * 100).toFixed(1) : 0
        };
    }

    // Calculate by direction
    var calls = trades.filter(function(t) { return t.direction === 'CALL'; });
    var puts = trades.filter(function(t) { return t.direction === 'PUT'; });
    var callWins = calls.filter(function(t) { return t.pnl > 0; });
    var putWins = puts.filter(function(t) { return t.pnl > 0; });

    // Calculate by month
    var byMonth = {};
    for (var m = 0; m < trades.length; m++) {
        var monthKey = trades[m].entryDate.substring(0, 7);
        if (!byMonth[monthKey]) {
            byMonth[monthKey] = { trades: 0, wins: 0, pnl: 0 };
        }
        byMonth[monthKey].trades++;
        if (trades[m].pnl > 0) byMonth[monthKey].wins++;
        byMonth[monthKey].pnl += trades[m].pnl;
    }

    return {
        totalTrades: trades.length,
        wins: wins.length,
        losses: losses.length,
        winRate: (wins.length / trades.length * 100).toFixed(1),
        totalPnL: trades.reduce(function(s, t) { return s + t.pnl; }, 0),
        avgWin: avgWin,
        avgLoss: avgLoss,
        profitFactor: profitFactor,
        maxDrawdown: maxDrawdown,
        byChecks: byChecks,
        byDirection: {
            calls: { total: calls.length, wins: callWins.length, winRate: calls.length > 0 ? (callWins.length / calls.length * 100).toFixed(1) : 0 },
            puts: { total: puts.length, wins: putWins.length, winRate: puts.length > 0 ? (putWins.length / puts.length * 100).toFixed(1) : 0 }
        },
        byMonth: byMonth
    };
}

function displayHistoricalBacktestResults(results) {
    var panel = document.getElementById('sq9HistoricalBacktestPanel');
    var resultsDiv = document.getElementById('sq9HistoricalBacktestResults');

    if (!panel || !resultsDiv) {
        console.warn('Historical backtest panel not found');
        return;
    }

    panel.style.display = 'block';

    var s = results.summary;

    var html = '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px;">' +
        '<div style="background: rgba(255,255,255,0.5); border-radius: 8px; padding: 12px; text-align: center;">' +
        '<div style="font-size: 10px; color: #666;">TOTAL TRADES</div>' +
        '<div style="font-size: 22px; font-weight: 800;">' + s.totalTrades + '</div>' +
        '</div>' +
        '<div style="background: rgba(34,197,94,0.2); border-radius: 8px; padding: 12px; text-align: center;">' +
        '<div style="font-size: 10px; color: #166534;">WIN RATE</div>' +
        '<div style="font-size: 22px; font-weight: 800; color: #22c55e;">' + s.winRate + '%</div>' +
        '<div style="font-size: 10px; color: #666;">' + s.wins + 'W / ' + s.losses + 'L</div>' +
        '</div>' +
        '<div style="background: rgba(59,130,246,0.2); border-radius: 8px; padding: 12px; text-align: center;">' +
        '<div style="font-size: 10px; color: #1e40af;">PROFIT FACTOR</div>' +
        '<div style="font-size: 22px; font-weight: 800; color: #3b82f6;">' + s.profitFactor.toFixed(2) + '</div>' +
        '</div>' +
        '<div style="background: ' + (s.totalPnL >= 0 ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)') + '; border-radius: 8px; padding: 12px; text-align: center;">' +
        '<div style="font-size: 10px; color: ' + (s.totalPnL >= 0 ? '#166534' : '#991b1b') + ';">TOTAL P&L</div>' +
        '<div style="font-size: 22px; font-weight: 800; color: ' + (s.totalPnL >= 0 ? '#22c55e' : '#ef4444') + ';">' + (s.totalPnL >= 0 ? '+$' : '-$') + Math.abs(s.totalPnL).toFixed(0) + '</div>' +
        '</div>' +
        '<div style="background: rgba(239,68,68,0.1); border-radius: 8px; padding: 12px; text-align: center;">' +
        '<div style="font-size: 10px; color: #991b1b;">MAX DRAWDOWN</div>' +
        '<div style="font-size: 22px; font-weight: 800; color: #ef4444;">' + s.maxDrawdown.toFixed(1) + '%</div>' +
        '</div>' +
        '</div>';

    // Performance by checks
    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">' +
        '<div style="background: rgba(255,255,255,0.3); border-radius: 8px; padding: 15px;">' +
        '<div style="font-weight: 600; margin-bottom: 10px;"> Win Rate by Check Count</div>' +
        '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">';

    for (var c = 3; c <= 5; c++) {
        var cs = s.byChecks[c];
        var barColor = c === 5 ? '#22c55e' : c === 4 ? '#f59e0b' : '#6b7280';
        html += '<div style="text-align: center;">' +
            '<div style="font-size: 11px; color: #666;">' + c + '/5</div>' +
            '<div style="font-size: 18px; font-weight: 700; color: ' + barColor + ';">' + cs.winRate + '%</div>' +
            '<div style="font-size: 10px; color: #999;">' + cs.total + ' trades</div>' +
            '</div>';
    }
    html += '</div></div>';

    // Performance by direction
    html += '<div style="background: rgba(255,255,255,0.3); border-radius: 8px; padding: 15px;">' +
        '<div style="font-weight: 600; margin-bottom: 10px;"> Win Rate by Direction</div>' +
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">' +
        '<div style="text-align: center; background: rgba(34,197,94,0.1); border-radius: 6px; padding: 10px;">' +
        '<div style="font-size: 11px; color: #22c55e;"> CALLS</div>' +
        '<div style="font-size: 18px; font-weight: 700; color: #22c55e;">' + s.byDirection.calls.winRate + '%</div>' +
        '<div style="font-size: 10px; color: #666;">' + s.byDirection.calls.wins + 'W / ' + (s.byDirection.calls.total - s.byDirection.calls.wins) + 'L</div>' +
        '</div>' +
        '<div style="text-align: center; background: rgba(239,68,68,0.1); border-radius: 6px; padding: 10px;">' +
        '<div style="font-size: 11px; color: #ef4444;"> PUTS</div>' +
        '<div style="font-size: 18px; font-weight: 700; color: #ef4444;">' + s.byDirection.puts.winRate + '%</div>' +
        '<div style="font-size: 10px; color: #666;">' + s.byDirection.puts.wins + 'W / ' + (s.byDirection.puts.total - s.byDirection.puts.wins) + 'L</div>' +
        '</div>' +
        '</div></div></div>';

    // Equity curve
    html += '<div style="background: rgba(255,255,255,0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">' +
        '<div style="font-weight: 600; margin-bottom: 10px;"> Equity Curve</div>' +
        '<canvas id="historicalEquityChart" style="width: 100%; height: 200px;"></canvas>' +
        '</div>';

    // Symbol breakdown table
    html += '<div style="background: rgba(255,255,255,0.3); border-radius: 8px; padding: 15px;">' +
        '<div style="font-weight: 600; margin-bottom: 10px;"> Performance by Symbol</div>' +
        '<div style="overflow-x: auto;"><table style="width: 100%; font-size: 11px; border-collapse: collapse;">' +
        '<tr style="background: rgba(0,0,0,0.05);">' +
        '<th style="padding: 8px; text-align: left;">Symbol</th>' +
        '<th style="padding: 8px; text-align: right;">Trades</th>' +
        '<th style="padding: 8px; text-align: right;">Win Rate</th>' +
        '<th style="padding: 8px; text-align: right;">W/L</th>' +
        '<th style="padding: 8px; text-align: right;">P&L</th>' +
        '</tr>';

    var symbols = Object.keys(results.symbolStats).sort(function(a, b) {
        return results.symbolStats[b].totalPnL - results.symbolStats[a].totalPnL;
    });

    for (var i = 0; i < symbols.length; i++) {
        var sym = symbols[i];
        var ss = results.symbolStats[sym];
        var pnlColor = ss.totalPnL >= 0 ? '#22c55e' : '#ef4444';
        html += '<tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">' +
            '<td style="padding: 8px; font-weight: 600;">' + sym + '</td>' +
            '<td style="padding: 8px; text-align: right;">' + ss.totalTrades + '</td>' +
            '<td style="padding: 8px; text-align: right; color: ' + (parseFloat(ss.winRate) >= 50 ? '#22c55e' : '#ef4444') + ';">' + ss.winRate + '%</td>' +
            '<td style="padding: 8px; text-align: right;">' + ss.wins + ' / ' + ss.losses + '</td>' +
            '<td style="padding: 8px; text-align: right; font-weight: 600; color: ' + pnlColor + ';">' + (ss.totalPnL >= 0 ? '+' : '') + '$' + ss.totalPnL.toFixed(0) + '</td>' +
            '</tr>';
    }
    html += '</table></div></div>';

    // Insights
    html += '<div style="margin-top: 15px; padding: 12px; background: rgba(59,130,246,0.1); border-radius: 6px; font-size: 12px;">' +
        ' <strong>Insights:</strong> ';

    var insights = [];
    if (s.byChecks[5] && parseFloat(s.byChecks[5].winRate) > parseFloat(s.byChecks[3].winRate)) {
        insights.push('5/5 entries outperform lower quality setups');
    }
    if (parseFloat(s.byDirection.calls.winRate) > parseFloat(s.byDirection.puts.winRate) + 10) {
        insights.push('CALL trades show stronger performance');
    } else if (parseFloat(s.byDirection.puts.winRate) > parseFloat(s.byDirection.calls.winRate) + 10) {
        insights.push('PUT trades show stronger performance');
    }
    if (s.profitFactor > 1.5) {
        insights.push('Strong profit factor indicates robust strategy');
    }
    if (s.maxDrawdown < 10) {
        insights.push('Low drawdown shows good risk management');
    }

    html += insights.length > 0 ? insights.join('. ') + '.' : 'Run more trades to generate insights.';
    html += '</div>';

    resultsDiv.innerHTML = html;

    // Draw equity chart
    setTimeout(function() {
        drawHistoricalEquityChart(results.equityCurve);
    }, 100);
}

function drawHistoricalEquityChart(equityCurve) {
    var canvas = document.getElementById('historicalEquityChart');
    if (!canvas || equityCurve.length < 2) return;

    var ctx = canvas.getContext('2d');
    var rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * 2;
    canvas.height = 400;
    ctx.scale(2, 2);

    var width = rect.width;
    var height = 200;
    var padding = 40;

    // Find min/max
    var minEquity = Infinity;
    var maxEquity = -Infinity;
    for (var i = 0; i < equityCurve.length; i++) {
        if (equityCurve[i].equity < minEquity) minEquity = equityCurve[i].equity;
        if (equityCurve[i].equity > maxEquity) maxEquity = equityCurve[i].equity;
    }

    var range = maxEquity - minEquity;
    if (range === 0) range = 1;

    // Draw background
    ctx.fillStyle = '#f8fafc';
    ctx.fillRect(0, 0, width, height);

    // Draw grid
    ctx.strokeStyle = '#e2e8f0';
    ctx.lineWidth = 0.5;
    for (var g = 0; g <= 4; g++) {
        var y = padding + (height - 2 * padding) * (g / 4);
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
    }

    // Draw equity line
    ctx.strokeStyle = '#3b82f6';
    ctx.lineWidth = 2;
    ctx.beginPath();

    for (var j = 0; j < equityCurve.length; j++) {
        var x = padding + (width - 2 * padding) * (j / (equityCurve.length - 1));
        var y = padding + (height - 2 * padding) * (1 - (equityCurve[j].equity - minEquity) / range);

        if (j === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    }
    ctx.stroke();

    // Fill under curve
    ctx.lineTo(width - padding, height - padding);
    ctx.lineTo(padding, height - padding);
    ctx.closePath();
    ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
    ctx.fill();

    // Draw dots for wins/losses
    for (var k = 1; k < equityCurve.length; k++) {
        if (equityCurve[k].trade) {
            var xDot = padding + (width - 2 * padding) * (k / (equityCurve.length - 1));
            var yDot = padding + (height - 2 * padding) * (1 - (equityCurve[k].equity - minEquity) / range);

            ctx.beginPath();
            ctx.arc(xDot, yDot, 4, 0, 2 * Math.PI);
            ctx.fillStyle = equityCurve[k].trade.pnl >= 0 ? '#22c55e' : '#ef4444';
            ctx.fill();
        }
    }

    // Draw labels
    ctx.fillStyle = '#64748b';
    ctx.font = '10px system-ui';
    ctx.textAlign = 'right';
    ctx.fillText('$' + maxEquity.toFixed(0), padding - 5, padding + 5);
    ctx.fillText('$' + minEquity.toFixed(0), padding - 5, height - padding + 5);

    // Start/end dates
    ctx.textAlign = 'center';
    if (equityCurve[0].date) {
        ctx.fillText(equityCurve[0].date, padding, height - 5);
    }
    if (equityCurve[equityCurve.length - 1].date) {
        ctx.fillText(equityCurve[equityCurve.length - 1].date, width - padding, height - 5);
    }
}

function toggleBacktestSettings() {
    var panel = document.getElementById('backtestSettingsPanel');
    if (panel) {
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
}

function runHistoricalBacktest() {
    // Get settings from form
    var minChecks = parseInt(document.getElementById('backtestMinChecks').value) || 4;
    var lookbackDays = parseInt(document.getElementById('backtestLookback').value) || 180;
    var positionSize = parseInt(document.getElementById('backtestPositionSize').value) || 1000;
    var useStops = document.getElementById('backtestUseStops').checked;

    // Get selected symbols
    var symbolCheckboxes = document.querySelectorAll('.backtest-symbol-checkbox:checked');
    var symbols = [];
    for (var i = 0; i < symbolCheckboxes.length; i++) {
        symbols.push(symbolCheckboxes[i].value);
    }

    if (symbols.length === 0) {
        symbols = ['SPY', 'QQQ', 'IWM', 'DIA'];
    }

    // Show loading
    var resultsDiv = document.getElementById('sq9HistoricalBacktestResults');
    resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px;">' +
        '<div style="font-size: 32px; animation: spin 1s linear infinite;"></div>' +
        '<div style="margin-top: 10px;">Running backtest on ' + symbols.length + ' symbols...</div>' +
        '</div>';
    document.getElementById('sq9HistoricalBacktestPanel').style.display = 'block';

    // Run backtest (use setTimeout to allow UI to update)
    setTimeout(function() {
        var results = runSq9HistoricalBacktest({
            symbols: symbols,
            lookbackDays: lookbackDays,
            minChecks: minChecks,
            useStops: useStops,
            positionSize: positionSize
        });

        displayHistoricalBacktestResults(results);
    }, 100);
}

function exportBacktestResults() {
    if (!historicalBacktestResults || !historicalBacktestResults.trades.length) {
        alert('No backtest results to export. Run a backtest first.');
        return;
    }

    var trades = historicalBacktestResults.trades;
    var csv = 'Symbol,Direction,Entry Date,Entry Price,SQ9 Level,Checks,Exit Date,Exit Price,Exit Reason,P&L,P&L %\n';

    for (var i = 0; i < trades.length; i++) {
        var t = trades[i];
        csv += [
            t.symbol,
            t.direction,
            t.entryDate,
            t.entryPrice.toFixed(2),
            t.sq9Level.toFixed(2),
            t.checkCount + '/5',
            t.exitDate,
            t.exitPrice.toFixed(2),
            t.exitReason,
            t.pnl.toFixed(2),
            t.pnlPct.toFixed(2) + '%'
        ].join(',') + '\n';
    }

    var blob = new Blob([csv], { type: 'text/csv' });
    var url = window.URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'sq9_backtest_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// ============================================
// DYNAMIC PIVOT DETECTION
// ============================================

function detectDynamicPivots(symbol, priceData) {
    if (!priceData || priceData.length < 50) return null;

    var pivots = {
        yearLow: { price: Infinity, date: null },
        yearHigh: { price: -Infinity, date: null },
        recentSwingLow: { price: Infinity, date: null },
        recentSwingHigh: { price: -Infinity, date: null }
    };

    // Find 52-week high/low
    var oneYearAgo = new Date();
    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

    for (var i = 0; i < priceData.length; i++) {
        var bar = priceData[i];
        var barDate = new Date(bar.Date);
        var low = parseFloat(bar.Low);
        var high = parseFloat(bar.High);

        if (barDate >= oneYearAgo) {
            if (low < pivots.yearLow.price) {
                pivots.yearLow = { price: low, date: bar.Date };
            }
            if (high > pivots.yearHigh.price) {
                pivots.yearHigh = { price: high, date: bar.Date };
            }
        }
    }

    // Find recent swing points (last 20 bars)
    var recentBars = priceData.slice(-20);
    for (var j = 2; j < recentBars.length - 2; j++) {
        var curr = recentBars[j];
        var prev1 = recentBars[j - 1];
        var prev2 = recentBars[j - 2];
        var next1 = recentBars[j + 1];
        var next2 = recentBars[j + 2];

        var currLow = parseFloat(curr.Low);
        var currHigh = parseFloat(curr.High);

        // Swing low
        if (currLow < parseFloat(prev1.Low) && currLow < parseFloat(prev2.Low) &&
            currLow < parseFloat(next1.Low) && currLow < parseFloat(next2.Low)) {
            if (currLow < pivots.recentSwingLow.price) {
                pivots.recentSwingLow = { price: currLow, date: curr.Date };
            }
        }

        // Swing high
        if (currHigh > parseFloat(prev1.High) && currHigh > parseFloat(prev2.High) &&
            currHigh > parseFloat(next1.High) && currHigh > parseFloat(next2.High)) {
            if (currHigh > pivots.recentSwingHigh.price) {
                pivots.recentSwingHigh = { price: currHigh, date: curr.Date };
            }
        }
    }

    return pivots;
}

function updateDynamicPivots() {
    console.log(' Updating dynamic pivots...');

    var symbols = Object.keys(sq9ExtendedPivots);

    for (var i = 0; i < symbols.length; i++) {
        var sym = symbols[i];

        if (typeof allSymbolsData !== 'undefined' && allSymbolsData[sym]) {
            var pivots = detectDynamicPivots(sym, allSymbolsData[sym]);

            if (pivots && pivots.yearLow.price < Infinity) {
                // Update with dynamic pivot
                sq9ExtendedPivots[sym] = {
                    price: pivots.yearLow.price,
                    date: pivots.yearLow.date,
                    type: 'DYNAMIC_LOW'
                };
                console.log('   ' + sym + ': Updated pivot to $' + pivots.yearLow.price.toFixed(2) + ' (' + pivots.yearLow.date + ')');
            }
        }
    }

    console.log(' Dynamic pivot update complete');
}

// Update pivots when data loads
function initDynamicPivots() {
    // Wait for price data to be available
    if (typeof allSymbolsData !== 'undefined' && Object.keys(allSymbolsData).length > 0) {
        updateDynamicPivots();
    } else {
        // Retry in 5 seconds
        setTimeout(initDynamicPivots, 5000);
    }
}

// Initialize dynamic pivots after page load
setTimeout(initDynamicPivots, 10000);

// ============================================
// AI TRADE ANALYSIS
// ============================================

function runAiTradeAnalysis() {
    var resultsDiv = document.getElementById('aiAnalysisResults');

    if (sq9Trades.length === 0) {
        resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">' +
            '<div style="font-size: 32px; margin-bottom: 10px;"></div>' +
            '<div>No trades to analyze yet.</div>' +
            '<div style="font-size: 12px; margin-top: 5px;">Log some trades first using the "+ Log Trade" button.</div>' +
            '</div>';
        return;
    }

    // Show loading
    resultsDiv.innerHTML = '<div style="text-align: center; padding: 30px;">' +
        '<div style="font-size: 24px; animation: pulse 1s infinite;"></div>' +
        '<div style="margin-top: 10px;">Analyzing your trading patterns...</div>' +
        '</div>';

    // Simulate analysis delay
    setTimeout(function() {
        var analysis = generateAiAnalysis();
        resultsDiv.innerHTML = analysis;
    }, 1500);
}

function generateAiAnalysis() {
    var closedTrades = sq9Trades.filter(function(t) { return t.status === 'closed'; });
    var openTrades = sq9Trades.filter(function(t) { return t.status === 'open'; });
    var wins = closedTrades.filter(function(t) { return t.pnl > 0; });
    var losses = closedTrades.filter(function(t) { return t.pnl <= 0; });

    var totalPnL = closedTrades.reduce(function(sum, t) { return sum + (t.pnl || 0); }, 0);
    var winRate = closedTrades.length > 0 ? (wins.length / closedTrades.length * 100) : 0;
    var avgWin = wins.length > 0 ? wins.reduce(function(sum, t) { return sum + t.pnl; }, 0) / wins.length : 0;
    var avgLoss = losses.length > 0 ? Math.abs(losses.reduce(function(sum, t) { return sum + t.pnl; }, 0) / losses.length) : 0;

    // Analyze by direction
    var callTrades = closedTrades.filter(function(t) { return t.direction === 'CALL'; });
    var putTrades = closedTrades.filter(function(t) { return t.direction === 'PUT'; });
    var callWins = callTrades.filter(function(t) { return t.pnl > 0; });
    var putWins = putTrades.filter(function(t) { return t.pnl > 0; });
    var callWinRate = callTrades.length > 0 ? (callWins.length / callTrades.length * 100) : 0;
    var putWinRate = putTrades.length > 0 ? (putWins.length / putTrades.length * 100) : 0;

    // Analyze by check count
    var check5Trades = closedTrades.filter(function(t) { return t.checks === 5; });
    var check4Trades = closedTrades.filter(function(t) { return t.checks === 4; });
    var check3Trades = closedTrades.filter(function(t) { return t.checks <= 3; });
    var check5WinRate = check5Trades.length > 0 ? (check5Trades.filter(function(t) { return t.pnl > 0; }).length / check5Trades.length * 100) : 0;
    var check4WinRate = check4Trades.length > 0 ? (check4Trades.filter(function(t) { return t.pnl > 0; }).length / check4Trades.length * 100) : 0;
    var check3WinRate = check3Trades.length > 0 ? (check3Trades.filter(function(t) { return t.pnl > 0; }).length / check3Trades.length * 100) : 0;

    // Analyze by symbol
    var symbolStats = {};
    closedTrades.forEach(function(t) {
        if (!symbolStats[t.symbol]) {
            symbolStats[t.symbol] = { wins: 0, losses: 0, pnl: 0 };
        }
        if (t.pnl > 0) symbolStats[t.symbol].wins++;
        else symbolStats[t.symbol].losses++;
        symbolStats[t.symbol].pnl += t.pnl;
    });

    var bestSymbol = null;
    var worstSymbol = null;
    Object.keys(symbolStats).forEach(function(sym) {
        var s = symbolStats[sym];
        if (!bestSymbol || s.pnl > symbolStats[bestSymbol].pnl) bestSymbol = sym;
        if (!worstSymbol || s.pnl < symbolStats[worstSymbol].pnl) worstSymbol = sym;
    });

    // Generate insights
    var insights = [];

    // Overall performance
    if (winRate >= 60) {
        insights.push(' <strong>Excellent win rate!</strong> Your ' + winRate.toFixed(0) + '% win rate is above the 60% threshold for consistent profitability.');
    } else if (winRate >= 50) {
        insights.push(' <strong>Solid performance.</strong> Your ' + winRate.toFixed(0) + '% win rate shows your strategy has an edge.');
    } else if (closedTrades.length > 0) {
        insights.push(' <strong>Room for improvement.</strong> Your ' + winRate.toFixed(0) + '% win rate suggests reviewing entry criteria.');
    }

    // Direction analysis
    if (callTrades.length > 0 && putTrades.length > 0) {
        if (callWinRate > putWinRate + 15) {
            insights.push(' <strong>Stronger on CALLS.</strong> Your CALL trades (' + callWinRate.toFixed(0) + '%) outperform PUTs (' + putWinRate.toFixed(0) + '%). Consider favoring bullish setups.');
        } else if (putWinRate > callWinRate + 15) {
            insights.push(' <strong>Stronger on PUTS.</strong> Your PUT trades (' + putWinRate.toFixed(0) + '%) outperform CALLs (' + callWinRate.toFixed(0) + '%). Consider favoring bearish setups.');
        }
    }

    // Check count analysis
    if (check5Trades.length >= 2 && check3Trades.length >= 2) {
        if (check5WinRate > check3WinRate + 10) {
            insights.push(' <strong>Wait for 5/5!</strong> Your 5/5 READY trades (' + check5WinRate.toFixed(0) + '%) significantly outperform early entries (' + check3WinRate.toFixed(0) + '%).');
        }
    }

    // Risk/Reward
    if (avgWin > 0 && avgLoss > 0) {
        var rrRatio = avgWin / avgLoss;
        if (rrRatio >= 1.5) {
            insights.push(' <strong>Great risk management!</strong> Your avg win ($' + avgWin.toFixed(0) + ') is ' + rrRatio.toFixed(1) + 'x your avg loss ($' + avgLoss.toFixed(0) + ').');
        } else if (rrRatio < 1) {
            insights.push(' <strong>Improve R:R ratio.</strong> Your avg loss ($' + avgLoss.toFixed(0) + ') exceeds avg win ($' + avgWin.toFixed(0) + '). Consider tighter stops or letting winners run.');
        }
    }

    // Best/worst symbols
    if (bestSymbol && symbolStats[bestSymbol].pnl > 0) {
        insights.push(' <strong>Best performer:</strong> ' + bestSymbol + ' with +$' + symbolStats[bestSymbol].pnl.toFixed(0) + ' (' + symbolStats[bestSymbol].wins + 'W-' + symbolStats[bestSymbol].losses + 'L)');
    }
    if (worstSymbol && symbolStats[worstSymbol].pnl < 0 && worstSymbol !== bestSymbol) {
        insights.push(' <strong>Needs work:</strong> ' + worstSymbol + ' with -$' + Math.abs(symbolStats[worstSymbol].pnl).toFixed(0) + ' (' + symbolStats[worstSymbol].wins + 'W-' + symbolStats[worstSymbol].losses + 'L)');
    }

    // Open trades warning
    if (openTrades.length > 3) {
        insights.push(' <strong>Multiple open positions:</strong> You have ' + openTrades.length + ' open trades. Consider managing risk exposure.');
    }

    // Build HTML
    var html = '<div style="font-size: 13px; line-height: 1.8;">';

    // Summary header
    html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">' +
        '<div style="text-align: center; padding: 10px; background: var(--bg); border-radius: 6px;">' +
        '<div style="font-size: 10px; color: var(--muted);">Total Trades</div>' +
        '<div style="font-size: 18px; font-weight: 700;">' + sq9Trades.length + '</div>' +
        '</div>' +
        '<div style="text-align: center; padding: 10px; background: var(--bg); border-radius: 6px;">' +
        '<div style="font-size: 10px; color: var(--muted);">Win Rate</div>' +
        '<div style="font-size: 18px; font-weight: 700; color: ' + (winRate >= 50 ? '#22c55e' : '#ef4444') + ';">' + winRate.toFixed(0) + '%</div>' +
        '</div>' +
        '<div style="text-align: center; padding: 10px; background: var(--bg); border-radius: 6px;">' +
        '<div style="font-size: 10px; color: var(--muted);">Total P&L</div>' +
        '<div style="font-size: 18px; font-weight: 700; color: ' + (totalPnL >= 0 ? '#22c55e' : '#ef4444') + ';">' + (totalPnL >= 0 ? '+' : '') + '$' + totalPnL.toFixed(0) + '</div>' +
        '</div>' +
        '<div style="text-align: center; padding: 10px; background: var(--bg); border-radius: 6px;">' +
        '<div style="font-size: 10px; color: var(--muted);">Open</div>' +
        '<div style="font-size: 18px; font-weight: 700; color: #3b82f6;">' + openTrades.length + '</div>' +
        '</div>' +
        '</div>';

    // Insights
    html += '<div style="font-weight: 700; margin-bottom: 10px;"> AI Insights:</div>';
    if (insights.length === 0) {
        html += '<div style="color: var(--muted);">Log more trades to generate meaningful insights.</div>';
    } else {
        html += '<ul style="margin: 0; padding-left: 20px;">';
        for (var i = 0; i < insights.length; i++) {
            html += '<li style="margin-bottom: 8px;">' + insights[i] + '</li>';
        }
        html += '</ul>';
    }

    // Recommendations
    html += '<div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(22,163,74,0.1)); border-radius: 6px;">' +
        '<div style="font-weight: 700; margin-bottom: 5px;"> Recommendation:</div>';

    if (winRate >= 60 && totalPnL > 0) {
        html += 'Keep doing what you\'re doing! Your SQ9 strategy is working well. Consider slightly increasing position sizes on 5/5 READY setups.';
    } else if (winRate >= 50) {
        html += 'Focus on quality over quantity. Only take 5/5 READY setups for the next 10 trades and compare your results.';
    } else if (closedTrades.length < 5) {
        html += 'You need more trade data for reliable analysis. Log at least 10 closed trades for meaningful insights.';
    } else {
        html += 'Consider pausing live trading and paper trading for a week. Focus on only 5/5 setups with R:R of at least 1:1.5.';
    }
    html += '</div>';

    html += '</div>';

    return html;
}

// ============================================
// MULTI-TIMEFRAME SQ9 ANALYSIS
// ============================================

// Different pivots for different timeframes
var sq9MtfPivots = {
    // Index ETFs (4)
    SPY: {
        '15min': { price: 679.82, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 665.50, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 481.80, date: '2025-04-07', label: '52-Week Low' }
    },
    QQQ: {
        '15min': { price: 608.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 590.20, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 402.39, date: '2025-04-07', label: '52-Week Low' }
    },
    IWM: {
        '15min': { price: 246.80, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 238.50, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 171.73, date: '2025-04-07', label: '52-Week Low' }
    },
    DIA: {
        '15min': { price: 430.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 420.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 364.42, date: '2025-04-07', label: '52-Week Low' }
    },
    // Sector ETFs (9)
    XLF: {
        '15min': { price: 51.20, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 49.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 42.35, date: '2025-04-07', label: '52-Week Low' }
    },
    XLE: {
        '15min': { price: 88.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 85.20, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 78.12, date: '2025-04-07', label: '52-Week Low' }
    },
    XLK: {
        '15min': { price: 238.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 228.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 186.50, date: '2025-04-07', label: '52-Week Low' }
    },
    XLV: {
        '15min': { price: 148.20, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 144.50, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 131.25, date: '2025-04-07', label: '52-Week Low' }
    },
    XLI: {
        '15min': { price: 138.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 134.20, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 112.80, date: '2025-04-07', label: '52-Week Low' }
    },
    XLB: {
        '15min': { price: 92.80, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 89.50, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 79.45, date: '2025-04-07', label: '52-Week Low' }
    },
    XLU: {
        '15min': { price: 78.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 75.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 68.90, date: '2025-04-07', label: '52-Week Low' }
    },
    XLP: {
        '15min': { price: 84.20, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 81.50, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 75.20, date: '2025-04-07', label: '52-Week Low' }
    },
    XLY: {
        '15min': { price: 218.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 208.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 175.30, date: '2025-04-07', label: '52-Week Low' }
    },
    // Mega Caps (10)
    AAPL: {
        '15min': { price: 245.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 238.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 169.50, date: '2025-04-07', label: '52-Week Low' }
    },
    MSFT: {
        '15min': { price: 425.80, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 415.20, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 360.92, date: '2025-04-07', label: '52-Week Low' }
    },
    NVDA: {
        '15min': { price: 138.20, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 128.50, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 86.50, date: '2025-04-07', label: '52-Week Low' }
    },
    TSLA: {
        '15min': { price: 405.80, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 385.20, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 138.80, date: '2025-04-07', label: '52-Week Low' }
    },
    AMZN: {
        '15min': { price: 225.80, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 218.50, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 167.55, date: '2025-04-07', label: '52-Week Low' }
    },
    GOOGL: {
        '15min': { price: 198.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 192.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 147.22, date: '2025-04-07', label: '52-Week Low' }
    },
    META: {
        '15min': { price: 605.20, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 580.50, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 480.50, date: '2025-04-07', label: '52-Week Low' }
    },
    JPM: {
        '15min': { price: 265.80, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 255.20, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 215.36, date: '2025-04-07', label: '52-Week Low' }
    },
    AMD: {
        '15min': { price: 115.80, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 108.50, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 95.80, date: '2025-04-07', label: '52-Week Low' }
    },
    NFLX: {
        '15min': { price: 925.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 895.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 829.72, date: '2025-04-07', label: '52-Week Low' }
    },
    // Additional Liquid Stocks (20)
    V: {
        '15min': { price: 325.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 315.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 293.48, date: '2025-04-07', label: '52-Week Low' }
    },
    MA: {
        '15min': { price: 535.80, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 518.50, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 473.19, date: '2025-04-07', label: '52-Week Low' }
    },
    UNH: {
        '15min': { price: 525.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 505.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 439.48, date: '2025-04-07', label: '52-Week Low' }
    },
    HD: {
        '15min': { price: 415.80, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 398.50, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 323.77, date: '2025-04-07', label: '52-Week Low' }
    },
    PG: {
        '15min': { price: 175.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 168.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 158.42, date: '2025-04-07', label: '52-Week Low' }
    },
    BAC: {
        '15min': { price: 48.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 45.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 35.53, date: '2025-04-07', label: '52-Week Low' }
    },
    WMT: {
        '15min': { price: 95.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 92.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 81.12, date: '2025-04-07', label: '52-Week Low' }
    },
    DIS: {
        '15min': { price: 115.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 108.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 83.91, date: '2025-04-07', label: '52-Week Low' }
    },
    COST: {
        '15min': { price: 985.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 955.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 855.67, date: '2025-04-07', label: '52-Week Low' }
    },
    CRM: {
        '15min': { price: 355.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 338.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 244.48, date: '2025-04-07', label: '52-Week Low' }
    },
    INTC: {
        '15min': { price: 22.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 21.20, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 19.43, date: '2025-04-07', label: '52-Week Low' }
    },
    CSCO: {
        '15min': { price: 62.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 59.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 52.28, date: '2025-04-07', label: '52-Week Low' }
    },
    ADBE: {
        '15min': { price: 485.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 465.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 374.21, date: '2025-04-07', label: '52-Week Low' }
    },
    ORCL: {
        '15min': { price: 175.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 168.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 123.68, date: '2025-04-07', label: '52-Week Low' }
    },
    PFE: {
        '15min': { price: 28.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 27.20, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 23.49, date: '2025-04-07', label: '52-Week Low' }
    },
    MRK: {
        '15min': { price: 105.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 98.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 80.72, date: '2025-04-07', label: '52-Week Low' }
    },
    ABBV: {
        '15min': { price: 185.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 178.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 163.83, date: '2025-04-07', label: '52-Week Low' }
    },
    LLY: {
        '15min': { price: 795.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 775.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 721.37, date: '2025-04-07', label: '52-Week Low' }
    },
    CVX: {
        '15min': { price: 155.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 148.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 132.04, date: '2025-04-07', label: '52-Week Low' }
    },
    XOM: {
        '15min': { price: 118.50, date: '2026-01-02', label: 'Session Low' },
        '1hour': { price: 112.80, date: '2025-12-20', label: 'Weekly Low' },
        'daily': { price: 101.54, date: '2025-04-07', label: '52-Week Low' }
    }
};

// MTF-specific SQ9 level calculation (wider rotation range for close pivots)
function calcMtfSq9Levels(pivotPrice, currentPrice) {
    var sqrtPivot = Math.sqrt(pivotPrice);
    var levels = [];

    // Use wider range starting from 0.5 rotation for close pivots
    for (var r = 0.5; r <= 20; r += 0.5) {
        var price = Math.pow(sqrtPivot + r * 0.5, 2);
        var dist = ((price - currentPrice) / currentPrice * 100);

        // Only include levels within reasonable range (-15% to +15%)
        if (dist >= -15 && dist <= 15) {
            levels.push({
                rotation: r,
                price: price,
                distance: dist,
                type: price > currentPrice ? 'resist' : 'support'
            });
        }
    }

    return levels.sort(function(a, b) { return Math.abs(a.distance) - Math.abs(b.distance); });
}

function updateSq9Mtf() {
    var symbolEl = document.getElementById('sq9MtfSymbol');
    if (!symbolEl) return;

    var symbol = symbolEl.value;
    var pivots = sq9MtfPivots[symbol];

    if (!pivots) {
        console.log('No MTF pivots for ' + symbol);
        return;
    }

    // Get current price from allSymbolsData - SAME AS OTHER TABS
    var currentPrice = null;

    if (typeof allSymbolsData !== 'undefined' && allSymbolsData[symbol] && allSymbolsData[symbol].length > 0) {
        var symData = allSymbolsData[symbol];
        var lastBar = symData[symData.length - 1];
        currentPrice = parseFloat(lastBar.Close);
    }

    // If still no price, try currentData for the selected symbol
    if (!currentPrice && typeof currentData !== 'undefined' && currentData.length > 0 && currentSymbol === symbol) {
        currentPrice = parseFloat(currentData[currentData.length - 1].Close);
    }

    if (!currentPrice || isNaN(currentPrice) || currentPrice <= 0) {
        console.log(' No valid price for MTF:', symbol);
        return;
    }

    console.log(' MTF Update:', symbol, '$' + currentPrice.toFixed(2));

    // Update header
    var symbolDisplay = document.getElementById('sq9MtfSymbolDisplay');
    var priceDisplay = document.getElementById('sq9MtfPriceDisplay');
    if (symbolDisplay) symbolDisplay.textContent = symbol;
    if (priceDisplay) priceDisplay.textContent = '$' + currentPrice.toFixed(2);

    // Calculate levels for each timeframe
    var timeframes = ['15min', '1hour', 'daily'];
    var tfResults = {};

    timeframes.forEach(function(tf) {
        var pivot = pivots[tf];
        var levels = calcMtfSq9Levels(pivot.price, currentPrice);
        var nearest = levels.length > 0 ? levels[0] : null; // Already sorted by distance
        var direction = 'neutral';

        if (nearest && Math.abs(nearest.distance) <= 3) {
            direction = nearest.type === 'resist' ? 'put' : 'call';
        }

        tfResults[tf] = {
            pivot: pivot,
            levels: levels,
            nearest: nearest,
            direction: direction,
            distPct: nearest ? nearest.distance : 0
        };

        // Update UI
        updateMtfTimeframeDisplay(tf, tfResults[tf], currentPrice);
    });

    // Check alignment
    checkMtfAlignment(tfResults, currentPrice);
}

function updateMtfTimeframeDisplay(tf, result, currentPrice) {
    var tfMap = { '15min': '15min', '1hour': '1hour', 'daily': 'Daily' };
    var tfName = tfMap[tf];

    var levelEl = document.getElementById('sq9Mtf' + tfName + 'Level');
    var distEl = document.getElementById('sq9Mtf' + tfName + 'Dist');
    var typeEl = document.getElementById('sq9Mtf' + tfName + 'Type');
    var biasEl = document.getElementById('sq9Mtf' + tfName + 'Bias');
    var levelsEl = document.getElementById('sq9Mtf' + tfName + 'Levels');
    var containerEl = document.getElementById('sq9Mtf' + tfName);

    if (!result.nearest) {
        if (levelEl) levelEl.textContent = '--';
        if (distEl) distEl.textContent = '--';
        if (typeEl) typeEl.textContent = '--';
        if (biasEl) { biasEl.textContent = 'NEUTRAL'; biasEl.style.background = '#e5e7eb'; biasEl.style.color = '#666'; }
        return;
    }

    var nearest = result.nearest;
    var direction = result.direction;

    // Update stats
    if (levelEl) levelEl.textContent = '$' + nearest.price.toFixed(2);
    if (distEl) {
        distEl.textContent = (nearest.distance >= 0 ? '+' : '') + nearest.distance.toFixed(2) + '%';
        distEl.style.color = nearest.distance >= 0 ? '#ef4444' : '#22c55e';
    }
    if (typeEl) typeEl.textContent = nearest.type === 'resist' ? 'RESISTANCE' : 'SUPPORT';

    // Update bias badge
    if (biasEl) {
        if (direction === 'put') {
            biasEl.textContent = ' PUT';
            biasEl.style.background = '#fecaca';
            biasEl.style.color = '#dc2626';
        } else if (direction === 'call') {
            biasEl.textContent = ' CALL';
            biasEl.style.background = '#bbf7d0';
            biasEl.style.color = '#16a34a';
        } else {
            biasEl.textContent = ' WAIT';
            biasEl.style.background = '#e5e7eb';
            biasEl.style.color = '#666';
        }
    }

    // Highlight container if near level
    if (containerEl) {
        if (Math.abs(nearest.distance) <= 1) {
            containerEl.style.borderColor = direction === 'put' ? '#ef4444' : '#22c55e';
            containerEl.style.background = direction === 'put' ? 'rgba(239,68,68,0.05)' : 'rgba(34,197,94,0.05)';
        } else {
            containerEl.style.borderColor = 'transparent';
            containerEl.style.background = 'var(--bg)';
        }
    }

    // Render mini level bars
    if (levelsEl && result.levels) {
        var levelsHtml = '';
        var displayLevels = result.levels.slice(0, 6);

        displayLevels.forEach(function(level) {
            var isNearest = Math.abs(level.price - nearest.price) < 0.01;
            var barColor = level.type === 'resist' ? '#ef4444' : '#22c55e';
            var opacity = isNearest ? '1' : '0.4';

            levelsHtml += '<div style="display: flex; align-items: center; gap: 5px; margin-bottom: 3px; opacity: ' + opacity + ';">' +
                '<div style="width: 8px; height: 8px; border-radius: 2px; background: ' + barColor + ';"></div>' +
                '<span>$' + level.price.toFixed(2) + '</span>' +
                '<span style="color: ' + (level.distance >= 0 ? '#ef4444' : '#22c55e') + ';">(' + (level.distance >= 0 ? '+' : '') + level.distance.toFixed(1) + '%)</span>' +
            '</div>';
        });

        levelsEl.innerHTML = levelsHtml;
    }
}

function checkMtfAlignment(tfResults, currentPrice) {
    var alignmentEl = document.getElementById('sq9MtfAlignment');
    var titleEl = document.getElementById('sq9MtfAlignmentTitle');
    var descEl = document.getElementById('sq9MtfAlignmentDesc');
    var badgeEl = document.getElementById('sq9MtfAlignmentBadge');

    var directions = {
        '15min': tfResults['15min'].direction,
        '1hour': tfResults['1hour'].direction,
        'daily': tfResults['daily'].direction
    };

    var callCount = Object.values(directions).filter(function(d) { return d === 'call'; }).length;
    var putCount = Object.values(directions).filter(function(d) { return d === 'put'; }).length;
    var neutralCount = Object.values(directions).filter(function(d) { return d === 'neutral'; }).length;

    var alignmentStrength = 0;
    var alignmentDir = 'NEUTRAL';
    var alignmentDesc = '';

    // Check for alignment
    if (callCount === 3) {
        alignmentStrength = 3;
        alignmentDir = 'CALL';
        alignmentDesc = ' PERFECT ALIGNMENT! All 3 timeframes show CALL setup at SQ9 support levels.';
    } else if (putCount === 3) {
        alignmentStrength = 3;
        alignmentDir = 'PUT';
        alignmentDesc = ' PERFECT ALIGNMENT! All 3 timeframes show PUT setup at SQ9 resistance levels.';
    } else if (callCount === 2 && neutralCount <= 1) {
        alignmentStrength = 2;
        alignmentDir = 'CALL';
        alignmentDesc = ' Strong CALL bias. 2/3 timeframes aligned at support.';
    } else if (putCount === 2 && neutralCount <= 1) {
        alignmentStrength = 2;
        alignmentDir = 'PUT';
        alignmentDesc = ' Strong PUT bias. 2/3 timeframes aligned at resistance.';
    } else if (neutralCount >= 2) {
        alignmentStrength = 0;
        alignmentDir = 'NEUTRAL';
        alignmentDesc = ' No clear setup. Price is between SQ9 levels on multiple timeframes.';
    } else {
        alignmentStrength = 1;
        alignmentDir = 'MIXED';
        alignmentDesc = ' Mixed signals. Timeframes showing conflicting directions.';
    }

    // Update UI
    if (alignmentStrength === 3) {
        alignmentEl.style.background = alignmentDir === 'CALL'
            ? 'linear-gradient(135deg, rgba(34,197,94,0.15), rgba(22,163,74,0.15))'
            : 'linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.15))';
        alignmentEl.style.borderColor = alignmentDir === 'CALL' ? 'rgba(34,197,94,0.5)' : 'rgba(239,68,68,0.5)';
        badgeEl.style.background = alignmentDir === 'CALL' ? '#22c55e' : '#ef4444';
        badgeEl.style.color = 'white';
        badgeEl.textContent = '3/3 ' + alignmentDir;
    } else if (alignmentStrength === 2) {
        alignmentEl.style.background = 'linear-gradient(135deg, rgba(245,158,11,0.1), rgba(217,119,6,0.1))';
        alignmentEl.style.borderColor = 'rgba(245,158,11,0.3)';
        badgeEl.style.background = '#f59e0b';
        badgeEl.style.color = 'white';
        badgeEl.textContent = '2/3 ' + alignmentDir;
    } else {
        alignmentEl.style.background = 'var(--bg)';
        alignmentEl.style.borderColor = 'var(--border)';
        badgeEl.style.background = '#e5e7eb';
        badgeEl.style.color = '#666';
        badgeEl.textContent = alignmentDir;
    }

    titleEl.textContent = alignmentStrength === 3 ? ' PERFECT MTF ALIGNMENT!' : alignmentStrength === 2 ? ' Strong Alignment' : ' Waiting for Alignment';
    descEl.textContent = alignmentDesc;
}

// Initialize MTF on page load and tab switch
document.addEventListener('DOMContentLoaded', function() {
    // Initial load with delay - wait for data to be loaded
    setTimeout(function() {
        if (typeof allSymbolsData !== 'undefined' && Object.keys(allSymbolsData).length > 0) {
            if (document.getElementById('sq9MtfSymbol')) {
                updateSq9Mtf();
            }
        } else {
            console.log(' Waiting for data to load before MTF update...');
            setTimeout(function() {
                if (document.getElementById('sq9MtfSymbol')) {
                    updateSq9Mtf();
                }
            }, 3000);
        }
    }, 3000);

    // Also trigger when SQ9 Scanner tab is clicked
    var sq9TabBtn = document.querySelector('[data-tab="sq9-scanner"]');
    if (sq9TabBtn) {
        sq9TabBtn.addEventListener('click', function() {
            setTimeout(function() {
                // Run scan and MTF update when tab is clicked
                if (typeof allSymbolsData !== 'undefined' && Object.keys(allSymbolsData).length > 0) {
                    runSq9Scan();
                    if (document.getElementById('sq9MtfSymbol')) {
                        updateSq9Mtf();
                    }
                    // Update duration table
                    if (typeof updateDurationTable === 'function') {
                        updateDurationTable();
                    }
                }
            }, 300);
        });
    }
});

// Quick log SQ9 trade from detail panel
function quickLogSq9Trade(symbol) {
    var result = sq9ScanResults.find(function(r) { return r.symbol === symbol; });
    if (!result) return;

    // Pre-fill the trade modal with current setup details
    if (typeof openSq9TradeModal === 'function') {
        openSq9TradeModal();

        // Pre-fill fields
        setTimeout(function() {
            var symbolInput = document.getElementById('sq9TradeSymbol');
            var directionSelect = document.getElementById('sq9TradeDirection');
            var entryInput = document.getElementById('sq9TradeEntry');
            var targetInput = document.getElementById('sq9TradeTarget');
            var stopInput = document.getElementById('sq9TradeStop');
            var checksInput = document.getElementById('sq9TradeChecks');

            if (symbolInput) symbolInput.value = result.symbol;
            if (directionSelect) directionSelect.value = result.direction;
            if (entryInput) entryInput.value = result.price.toFixed(2);
            if (targetInput) targetInput.value = result.target.toFixed(2);
            if (stopInput) stopInput.value = result.stop.toFixed(2);
            if (checksInput) checksInput.value = result.checkCount;
        }, 100);
    }
}

// ============================================
// OPTIMAL ENTRY TIMING FOR PUTS & CALLS
// ============================================

function getOptimalEntryTiming(direction, marketTime) {
    var result = {
        status: 'MARKET CLOSED',
        statusColor: '#6b7280',
        statusIcon: '',
        bestTimes: '',
        avoidTimes: '',
        directionAdvice: '',
        recommendation: '',
        recommendationDetail: '',
        recommendationIcon: '',
        recommendationBg: 'var(--bg)',
        recommendationBorder: 'var(--border)',
        recommendationColor: 'var(--text)',
        actionEmoji: ''
    };

    // Market hours: 9:30 AM - 4:00 PM ET
    var isMarketOpen = marketTime >= 9.5 && marketTime < 16;
    var isPreMarket = marketTime >= 4 && marketTime < 9.5;
    var isAfterHours = marketTime >= 16 && marketTime < 20;

    // Timing windows
    var isOpeningHour = marketTime >= 9.5 && marketTime < 10.5;
    var isMidMorning = marketTime >= 10.5 && marketTime < 11.5;
    var isLunchHour = marketTime >= 11.5 && marketTime < 13;
    var isAfternoon = marketTime >= 13 && marketTime < 15;
    var isPowerHour = marketTime >= 15 && marketTime < 15.5;
    var isLastHalfHour = marketTime >= 15.5 && marketTime < 16;

    // Common advice for both directions
    result.avoidTimes = '<strong>9:30-10:00 AM:</strong> Wide bid-ask spreads, high volatility<br>' +
        '<strong>11:30 AM-1:00 PM:</strong> Low volume lunch lull<br>' +
        '<strong>3:30-4:00 PM:</strong> Accelerated theta decay, gamma risk';

    if (direction === 'CALL') {
        result.bestTimes = '<strong>10:00-11:00 AM:</strong> After opening volatility settles, dips find support<br>' +
            '<strong>2:00-3:00 PM:</strong> Afternoon reversal attempts<br>' +
            '<strong>On RED days:</strong> Wait for capitulation volume spike';

        result.directionAdvice = '<strong>Buy CALLS on weakness:</strong> Enter when price pulls back to SQ9 support with bullish candle. ' +
            'Best entries are during red candles showing rejection (hammer, doji).';
    } else {
        result.bestTimes = '<strong>9:45-10:30 AM:</strong> Fade opening rally at resistance<br>' +
            '<strong>2:30-3:15 PM:</strong> Failed breakouts reverse hard<br>' +
            '<strong>On GREEN days:</strong> Wait for exhaustion at resistance';

        result.directionAdvice = '<strong>Buy PUTS on strength:</strong> Enter when price rallies into SQ9 resistance with bearish candle. ' +
            'Best entries are during green candles showing rejection (shooting star).';
    }

    // Time-based recommendations
    if (!isMarketOpen) {
        if (isPreMarket) {
            result.status = 'PRE-MARKET';
            result.statusColor = '#f59e0b';
            result.statusIcon = '';
            result.recommendation = 'WAIT FOR MARKET OPEN';
            result.recommendationDetail = 'Set alerts at SQ9 levels. Plan entry but do not chase pre-market.';
            result.recommendationIcon = '';
            result.recommendationBg = 'rgba(245,158,11,0.1)';
            result.recommendationBorder = 'rgba(245,158,11,0.3)';
            result.recommendationColor = '#d97706';
            result.actionEmoji = '';
        } else if (isAfterHours) {
            result.status = 'AFTER HOURS';
            result.statusColor = '#6b7280';
            result.statusIcon = '';
            result.recommendation = 'MARKET CLOSED';
            result.recommendationDetail = 'Review setups for tomorrow.';
            result.recommendationIcon = '';
            result.actionEmoji = '';
        } else {
            result.status = 'MARKET CLOSED';
            result.statusColor = '#6b7280';
            result.statusIcon = '';
            result.recommendation = 'WAIT FOR NEXT SESSION';
            result.recommendationDetail = 'Markets open 9:30 AM ET Monday-Friday.';
            result.recommendationIcon = '';
            result.actionEmoji = '';
        }
    } else if (isOpeningHour) {
        if (marketTime < 10) {
            result.status = 'OPENING VOLATILITY';
            result.statusColor = '#ef4444';
            result.statusIcon = '';
            result.recommendation = 'WAIT - TOO EARLY';
            result.recommendationDetail = 'Spreads wide, moves unpredictable. Wait until 10:00 AM.';
            result.recommendationIcon = '';
            result.recommendationBg = 'rgba(239,68,68,0.1)';
            result.recommendationBorder = 'rgba(239,68,68,0.3)';
            result.recommendationColor = '#dc2626';
            result.actionEmoji = '';
        } else {
            result.status = 'EARLY SESSION';
            result.statusColor = '#f59e0b';
            result.statusIcon = '';
            result.recommendation = direction === 'PUT' ? 'WATCH FOR RALLY FADE' : 'WATCH FOR DIP BUY';
            result.recommendationDetail = direction === 'PUT' ? 'If spiked to resistance, good for PUT on rejection.' : 'If dipped to support, watch for bullish reversal.';
            result.recommendationIcon = '';
            result.recommendationBg = 'rgba(245,158,11,0.1)';
            result.recommendationBorder = 'rgba(245,158,11,0.3)';
            result.recommendationColor = '#d97706';
            result.actionEmoji = '';
        }
    } else if (isMidMorning) {
        result.status = 'PRIME ENTRY WINDOW';
        result.statusColor = '#22c55e';
        result.statusIcon = '';
        result.recommendation = 'OPTIMAL ENTRY TIME';
        result.recommendationDetail = 'Spreads normalized, direction established. Best window for ' + direction + ' entries.';
        result.recommendationIcon = '';
        result.recommendationBg = 'rgba(34,197,94,0.15)';
        result.recommendationBorder = 'rgba(34,197,94,0.5)';
        result.recommendationColor = '#16a34a';
        result.actionEmoji = '';
    } else if (isLunchHour) {
        result.status = 'LUNCH LULL';
        result.statusColor = '#f59e0b';
        result.statusIcon = '';
        result.recommendation = 'AVOID - LOW VOLUME';
        result.recommendationDetail = 'Choppy, directionless. Theta eats premium.';
        result.recommendationIcon = '';
        result.recommendationBg = 'rgba(245,158,11,0.1)';
        result.recommendationBorder = 'rgba(245,158,11,0.3)';
        result.recommendationColor = '#d97706';
        result.actionEmoji = '';
    } else if (isAfternoon) {
        result.status = 'AFTERNOON SESSION';
        result.statusColor = '#22c55e';
        result.statusIcon = '';
        result.recommendation = direction === 'CALL' ? 'GOOD FOR REVERSAL PLAYS' : 'WATCH FOR FAILED BREAKOUTS';
        result.recommendationDetail = direction === 'CALL' ? 'Afternoon reversals can work well after 2 PM.' : 'Failed breakouts often reverse hard 2-3 PM.';
        result.recommendationIcon = '';
        result.recommendationBg = 'rgba(34,197,94,0.1)';
        result.recommendationBorder = 'rgba(34,197,94,0.3)';
        result.recommendationColor = '#16a34a';
        result.actionEmoji = '';
    } else if (isPowerHour) {
        result.status = 'POWER HOUR START';
        result.statusColor = '#f59e0b';
        result.statusIcon = '';
        result.recommendation = 'QUICK TRADES ONLY';
        result.recommendationDetail = 'High volume but theta accelerating. Plan same-day exit.';
        result.recommendationIcon = '';
        result.recommendationBg = 'rgba(245,158,11,0.1)';
        result.recommendationBorder = 'rgba(245,158,11,0.3)';
        result.recommendationColor = '#d97706';
        result.actionEmoji = '';
    } else if (isLastHalfHour) {
        result.status = 'GAMMA RISK ZONE';
        result.statusColor = '#ef4444';
        result.statusIcon = '';
        result.recommendation = 'AVOID NEW POSITIONS';
        result.recommendationDetail = 'Theta decay rapid. Gamma risk high for 0DTE. Wait for tomorrow.';
        result.recommendationIcon = '';
        result.recommendationBg = 'rgba(239,68,68,0.1)';
        result.recommendationBorder = 'rgba(239,68,68,0.3)';
        result.recommendationColor = '#dc2626';
        result.actionEmoji = '';
    }

    return result;
}

// Update market status indicator
function updateMarketStatusIndicator() {
    var statusEl = document.getElementById('currentMarketStatus');
    if (!statusEl) return;

    var now = new Date();
    var hour = now.getHours();
    var minute = now.getMinutes();
    var marketTime = hour + (minute / 60);
    var timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

    var status = '';
    var bgColor = '';
    var textColor = '';

    if (marketTime < 9.5) {
        status = ' Pre-Market | ' + timeStr;
        bgColor = 'rgba(245,158,11,0.2)';
        textColor = '#d97706';
    } else if (marketTime >= 9.5 && marketTime < 10) {
        status = ' Opening (Avoid) | ' + timeStr;
        bgColor = 'rgba(239,68,68,0.2)';
        textColor = '#dc2626';
    } else if (marketTime >= 10 && marketTime < 11.5) {
        status = ' PRIME WINDOW | ' + timeStr;
        bgColor = 'rgba(34,197,94,0.2)';
        textColor = '#16a34a';
    } else if (marketTime >= 11.5 && marketTime < 13) {
        status = ' Lunch Lull | ' + timeStr;
        bgColor = 'rgba(245,158,11,0.2)';
        textColor = '#d97706';
    } else if (marketTime >= 13 && marketTime < 15) {
        status = ' Afternoon Session | ' + timeStr;
        bgColor = 'rgba(34,197,94,0.2)';
        textColor = '#16a34a';
    } else if (marketTime >= 15 && marketTime < 15.5) {
        status = ' Power Hour | ' + timeStr;
        bgColor = 'rgba(245,158,11,0.2)';
        textColor = '#d97706';
    } else if (marketTime >= 15.5 && marketTime < 16) {
        status = ' Gamma Risk | ' + timeStr;
        bgColor = 'rgba(239,68,68,0.2)';
        textColor = '#dc2626';
    } else {
        status = ' Market Closed | ' + timeStr;
        bgColor = 'rgba(107,114,128,0.2)';
        textColor = '#6b7280';
    }

    statusEl.textContent = status;
    statusEl.style.background = bgColor;
    statusEl.style.color = textColor;
}

// Update every minute
setInterval(updateMarketStatusIndicator, 60000);

// Update the timing panel display
function updateTimingPanel() {
    var now = new Date();
    var hour = now.getHours();
    var minute = now.getMinutes();
    var marketTime = hour + (minute / 60);

    // Get current direction from scan results or default to PUT
    var currentDirection = 'PUT';
    if (typeof sq9ScanResults !== 'undefined' && sq9ScanResults && sq9ScanResults.length > 0) {
        var spyResult = sq9ScanResults.find(function(r) { return r.symbol === 'SPY'; });
        if (spyResult) currentDirection = spyResult.direction;
    }

    // Get timing recommendation
    var timing = getOptimalEntryTiming(currentDirection, marketTime);

    // Update market status badge
    var statusEl = document.getElementById('currentMarketStatus');
    if (statusEl) {
        var timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        statusEl.textContent = timing.statusIcon + ' ' + timing.status + ' | ' + timeStr;
        statusEl.style.background = timing.statusColor + '33';
        statusEl.style.color = timing.statusColor;
    }

    // Update recommendation panel
    var recoEl = document.getElementById('timingRecommendation');
    var iconEl = document.getElementById('timingIcon');
    var titleEl = document.getElementById('timingTitle');
    var detailEl = document.getElementById('timingDetail');

    if (recoEl) {
        recoEl.style.background = timing.recommendationBg;
        recoEl.style.borderColor = timing.recommendationBorder;
    }
    if (iconEl) iconEl.textContent = timing.actionEmoji;
    if (titleEl) {
        titleEl.textContent = timing.recommendation;
        titleEl.style.color = timing.recommendationColor;
    }
    if (detailEl) detailEl.textContent = timing.recommendationDetail;
}

// Call timing panel update on page load and every minute
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(updateTimingPanel, 1000);
    setInterval(updateTimingPanel, 60000);
});

// Also update when SQ9 Scanner tab is shown
var sq9TabBtn = document.querySelector('[onclick*="sq9-scanner"]');
if (sq9TabBtn) {
    sq9TabBtn.addEventListener('click', function() {
        setTimeout(updateTimingPanel, 300);
    });
}

// ============================================
// CANDLE PATTERN SCANNER
// ============================================

function togglePatternGuide() {
    var panel = document.getElementById('patternGuidePanel');
    var btn = document.getElementById('patternGuideBtn');
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        btn.textContent = ' Hide Guide';
    } else {
        panel.style.display = 'none';
        btn.textContent = ' Show Guide';
    }
}

function scanCandlePatterns() {
    var symbols = ['SPY', 'QQQ', 'IWM', 'DIA', 'XLF', 'XLE', 'XLK', 'AAPL', 'NVDA', 'TSLA', 'META', 'AMZN'];
    var detectedPatterns = [];

    symbols.forEach(function(symbol) {
        var priceData = null;
        if (typeof allSymbolsData !== 'undefined' && allSymbolsData[symbol]) {
            priceData = allSymbolsData[symbol];
        }

        if (!priceData || priceData.length < 5) return;

        var candle = priceData[priceData.length - 1];
        var prevCandle = priceData[priceData.length - 2];

        var open = parseFloat(candle.Open);
        var high = parseFloat(candle.High);
        var low = parseFloat(candle.Low);
        var close = parseFloat(candle.Close);
        var body = Math.abs(close - open);
        var upperWick = high - Math.max(open, close);
        var lowerWick = Math.min(open, close) - low;
        var range = high - low;
        var isGreen = close > open;

        var prevOpen = parseFloat(prevCandle.Open);
        var prevClose = parseFloat(prevCandle.Close);
        var prevBody = Math.abs(prevClose - prevOpen);
        var prevIsGreen = prevClose > prevOpen;

        // Check SQ9 level proximity
        var nearSQ9 = false;
        var sq9Type = '';
        if (typeof sq9ExtendedPivots !== 'undefined' && sq9ExtendedPivots[symbol]) {
            var pivot = sq9ExtendedPivots[symbol].price;
            var levels = calcSq9LevelsFromPivot(pivot, close);
            if (levels && levels.length > 0) {
                var nearest = findNearestSq9Level(levels, close);
                if (nearest && Math.abs(nearest.distance) < 2) {
                    nearSQ9 = true;
                    sq9Type = nearest.type.toUpperCase();
                }
            }
        }

        var pattern = null;

        // HAMMER
        if (lowerWick > body * 2 && upperWick < body * 0.5 && body < range * 0.35 && range > 0) {
            pattern = { symbol: symbol, name: 'Hammer', emoji: '', type: 'BULLISH', signal: 'CALL', strength: nearSQ9 && sq9Type === 'SUPPORT' ? 'STRONG' : 'MODERATE', price: close };
        }
        // SHOOTING STAR
        else if (upperWick > body * 2 && lowerWick < body * 0.5 && body < range * 0.35 && range > 0) {
            pattern = { symbol: symbol, name: 'Shooting Star', emoji: '', type: 'BEARISH', signal: 'PUT', strength: nearSQ9 && sq9Type === 'RESIST' ? 'STRONG' : 'MODERATE', price: close };
        }
        // BULLISH ENGULFING
        else if (isGreen && !prevIsGreen && open <= prevClose && close >= prevOpen && body > prevBody * 1.1) {
            pattern = { symbol: symbol, name: 'Bullish Engulfing', emoji: '', type: 'BULLISH', signal: 'CALL', strength: nearSQ9 ? 'STRONG' : 'MODERATE', price: close };
        }
        // BEARISH ENGULFING
        else if (!isGreen && prevIsGreen && open >= prevClose && close <= prevOpen && body > prevBody * 1.1) {
            pattern = { symbol: symbol, name: 'Bearish Engulfing', emoji: '', type: 'BEARISH', signal: 'PUT', strength: nearSQ9 ? 'STRONG' : 'MODERATE', price: close };
        }
        // DOJI variants
        else if (body < range * 0.1 && range > 0) {
            if (lowerWick > range * 0.6 && upperWick < range * 0.15) {
                pattern = { symbol: symbol, name: 'Dragonfly Doji', emoji: '', type: 'BULLISH', signal: nearSQ9 ? 'CALL' : 'WAIT', strength: nearSQ9 ? 'MODERATE' : 'WEAK', price: close };
            } else if (upperWick > range * 0.6 && lowerWick < range * 0.15) {
                pattern = { symbol: symbol, name: 'Gravestone Doji', emoji: '', type: 'BEARISH', signal: nearSQ9 ? 'PUT' : 'WAIT', strength: nearSQ9 ? 'MODERATE' : 'WEAK', price: close };
            }
        }

        if (pattern) {
            detectedPatterns.push(pattern);
        }
    });

    updatePatternsList(detectedPatterns);
}

function updatePatternsList(patterns) {
    var container = document.getElementById('patternsList');
    if (!container) return;

    if (patterns.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted); background: var(--bg); border-radius: 8px;">No clear reversal patterns detected. Check back later.</div>';
        return;
    }

    var strengthOrder = { 'STRONG': 0, 'MODERATE': 1, 'WEAK': 2 };
    patterns.sort(function(a, b) { return strengthOrder[a.strength] - strengthOrder[b.strength]; });

    var html = '';
    patterns.forEach(function(p) {
        var bgColor = p.type === 'BULLISH' ? 'rgba(34,197,94,0.08)' : 'rgba(239,68,68,0.08)';
        var borderColor = p.type === 'BULLISH' ? 'rgba(34,197,94,0.3)' : 'rgba(239,68,68,0.3)';
        var signalBg = p.type === 'BULLISH' ? '#22c55e' : '#ef4444';
        var strengthBg = p.strength === 'STRONG' ? '#22c55e' : p.strength === 'MODERATE' ? '#f59e0b' : '#6b7280';

        html += '<div style="background: ' + bgColor + '; border: 1px solid ' + borderColor + '; border-radius: 10px; padding: 12px; display: flex; align-items: center; gap: 12px;">' +
            '<div style="font-size: 24px;">' + p.emoji + '</div>' +
            '<div style="flex: 1;">' +
                '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 2px;">' +
                    '<span style="font-weight: 700;">' + p.symbol + '</span>' +
                    '<span style="font-size: 11px; color: var(--muted);">' + p.name + '</span>' +
                    '<span style="background: ' + strengthBg + '; color: white; padding: 1px 5px; border-radius: 3px; font-size: 9px;">' + p.strength + '</span>' +
                '</div>' +
                '<div style="font-size: 11px;">$' + p.price.toFixed(2) + '</div>' +
            '</div>' +
            '<div style="background: ' + signalBg + '; color: white; padding: 6px 12px; border-radius: 6px; font-weight: 700; font-size: 11px;">' + p.signal + '</div>' +
        '</div>';
    });

    container.innerHTML = html;
}

// Auto-scan patterns on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        if (typeof allSymbolsData !== 'undefined' && Object.keys(allSymbolsData).length > 0) {
            scanCandlePatterns();
        }
    }, 5000);
});

// ============================================
// MULTI-TIMEFRAME SIGNAL SYSTEM
// ============================================

// MTF Cache and Loading State
var mtfCache = {};
var mtfIsLoading = false;
var mtfLastScanTime = 0;
var mtfDebounceTimer = null;
var MTF_CACHE_DURATION = 60000; // 1 minute cache

function updateMTFDisplay(signal, message, timeframes) {
    // Update all timeframe panels with neutral/error state
    ['Daily', '15min', '5min'].forEach(function(tf) {
        var analysis = { signal: signal, pattern: message, candle: 'flat', strength: 0 };
        updateTimeframePanel(tf, analysis);
    });
    // Update alignment banner
    var banner = document.getElementById('mtfAlignmentBanner');
    if (banner) {
        banner.innerHTML = '<div style="padding: 15px; text-align: center; color: #888;">' + message + '</div>';
    }
    // Hide trade setup
    hideTradeSetup();
}

function scanMTFPatterns(forceRefresh) {
    var symbol = document.getElementById('mtfSymbolSelect').value || 'SPY';

    // Prevent duplicate calls while loading
    if (mtfIsLoading) {
        console.log('MTF scan already in progress, skipping');
        return;
    }

    var now = Date.now();
    var cacheKey = symbol;

    // Check cache (unless force refresh)
    if (!forceRefresh && mtfCache[cacheKey] && (now - mtfCache[cacheKey].timestamp < MTF_CACHE_DURATION)) {
        console.log('Using cached MTF data for ' + symbol + ' (age: ' + Math.round((now - mtfCache[cacheKey].timestamp) / 1000) + 's)');
        displayCachedMTFResults(mtfCache[cacheKey]);
        return;
    }

    var priceData = allSymbolsData && allSymbolsData[symbol] ? allSymbolsData[symbol] : null;

    console.log('Scanning MTF patterns for ' + symbol + (forceRefresh ? ' (forced refresh)' : ''));

    if (!priceData || priceData.length < 5) {
        updateMTFDisplay('neutral', 'Insufficient data for ' + symbol, { daily: null, min15: null, min5: null });
        return;
    }

    mtfIsLoading = true;
    mtfLastScanTime = now;

    // Analyze Daily (Major Trend) - using actual daily data
    var dailyAnalysis = analyzeDailyTimeframe(priceData);

    // Simulate 15min and 5min analysis (based on daily trend and recent price action)
    var min15Analysis = analyzeIntradayTimeframe(priceData, '15min', symbol);
    var min5Analysis = analyzeIntradayTimeframe(priceData, '5min', symbol);

    // Calculate alignment
    var alignment = calculateMTFAlignment(dailyAnalysis, min15Analysis, min5Analysis);

    // Cache the results
    mtfCache[cacheKey] = {
        timestamp: now,
        symbol: symbol,
        dailyAnalysis: dailyAnalysis,
        min15Analysis: min15Analysis,
        min5Analysis: min5Analysis,
        alignment: alignment,
        priceData: priceData
    };

    // Update UI
    updateTimeframePanel('Daily', dailyAnalysis);
    updateTimeframePanel('15min', min15Analysis);
    updateTimeframePanel('5min', min5Analysis);
    updateAlignmentBanner(alignment);

    // Show trade setup if aligned
    if (alignment.scenario === 'FULL_BULL' || alignment.scenario === 'FULL_BEAR') {
        showTradeSetup(symbol, alignment, priceData);
    } else {
        hideTradeSetup();
    }

    mtfIsLoading = false;

    // Update Last Updated timestamp
    if (typeof onSignalsLoaded === 'function') {
        onSignalsLoaded();
    }
}

// Display cached MTF results
function displayCachedMTFResults(cached) {
    updateTimeframePanel('Daily', cached.dailyAnalysis);
    updateTimeframePanel('15min', cached.min15Analysis);
    updateTimeframePanel('5min', cached.min5Analysis);
    updateAlignmentBanner(cached.alignment);

    if (cached.alignment.scenario === 'FULL_BULL' || cached.alignment.scenario === 'FULL_BEAR') {
        showTradeSetup(cached.symbol, cached.alignment, cached.priceData);
    } else {
        hideTradeSetup();
    }
}

// Debounced MTF scan for click handlers
function debouncedMTFScan(forceRefresh) {
    if (mtfDebounceTimer) {
        clearTimeout(mtfDebounceTimer);
    }
    mtfDebounceTimer = setTimeout(function() {
        scanMTFPatterns(forceRefresh);
    }, 150);
}

function analyzeDailyTimeframe(priceData) {
    if (!priceData || priceData.length < 3) {
        return { signal: 'neutral', pattern: 'No Data', candle: 'flat', strength: 0 };
    }

    var latest = priceData[priceData.length - 1];
    var prev = priceData[priceData.length - 2];
    var prev2 = priceData[priceData.length - 3];

    var open = parseFloat(latest.Open);
    var close = parseFloat(latest.Close);
    var high = parseFloat(latest.High);
    var low = parseFloat(latest.Low);
    var prevClose = parseFloat(prev.Close);
    var prev2Close = parseFloat(prev2.Close);

    var bodySize = Math.abs(close - open);
    var upperWick = high - Math.max(open, close);
    var lowerWick = Math.min(open, close) - low;
    var range = high - low;

    var signal = 'neutral';
    var pattern = 'Neutral';
    var candle = 'flat';
    var strength = 50;

    // 3-bar trend analysis
    var trend3Bar = close - prev2Close;
    var dayChange = close - open;

    if (dayChange > 0) {
        candle = 'green';
        if (trend3Bar > 0) {
            signal = 'bullish';
            strength = 60 + Math.min(30, Math.abs(trend3Bar) * 10);
        }
    } else if (dayChange < 0) {
        candle = 'red';
        if (trend3Bar < 0) {
            signal = 'bearish';
            strength = 60 + Math.min(30, Math.abs(trend3Bar) * 10);
        }
    }

    // Pattern detection
    if (lowerWick > bodySize * 2 && upperWick < bodySize * 0.5) {
        pattern = 'Hammer';
        if (trend3Bar < 0) { signal = 'bullish'; strength = 75; }
    } else if (upperWick > bodySize * 2 && lowerWick < bodySize * 0.5) {
        pattern = 'Shooting Star';
        if (trend3Bar > 0) { signal = 'bearish'; strength = 75; }
    } else if (bodySize < range * 0.1) {
        pattern = 'Doji';
        signal = 'neutral';
        strength = 40;
    } else if (dayChange > 0 && Math.abs(close - prevClose) > Math.abs(prevClose - parseFloat(prev.Open)) * 1.3) {
        pattern = 'Bullish Engulfing';
        signal = 'bullish';
        strength = 80;
    } else if (dayChange < 0 && Math.abs(close - prevClose) > Math.abs(prevClose - parseFloat(prev.Open)) * 1.3) {
        pattern = 'Bearish Engulfing';
        signal = 'bearish';
        strength = 80;
    } else if (dayChange > 0) {
        pattern = 'Green Candle';
    } else if (dayChange < 0) {
        pattern = 'Red Candle';
    }

    return { signal: signal, pattern: pattern, candle: candle, strength: strength, price: close };
}

function analyzeIntradayTimeframe(priceData, timeframe, symbol) {
    // Analyze intraday timeframe based on daily data + time of day
    // Uses deterministic calculation (no random) for consistent results
    if (!priceData || priceData.length < 2) {
        return { signal: 'neutral', pattern: 'No Data', candle: 'flat', strength: 0 };
    }

    var latest = priceData[priceData.length - 1];
    var prev = priceData[priceData.length - 2];

    var open = parseFloat(latest.Open);
    var close = parseFloat(latest.Close);
    var high = parseFloat(latest.High);
    var low = parseFloat(latest.Low);
    var prevClose = parseFloat(prev.Close);

    // Use current time to simulate intraday movement
    var now = new Date();
    var hours = now.getHours();
    var minutes = now.getMinutes();
    var marketMinutes = (hours - 9) * 60 + minutes - 30; // Minutes since 9:30 ET

    // Estimate intraday position (0-1 scale)
    var intradayProgress = Math.max(0, Math.min(1, marketMinutes / 390));

    // Estimate current intraday price - deterministic calculation
    var estimatedCurrent = open + (close - open) * intradayProgress;

    // Use deterministic variance based on symbol and timeframe (no random)
    // Create a seed from symbol characters for consistent per-symbol variation
    var symbolSeed = 0;
    if (symbol) {
        for (var i = 0; i < symbol.length; i++) {
            symbolSeed += symbol.charCodeAt(i);
        }
    }
    var timeframeSeed = (timeframe === '5min') ? 0.0005 : 0.0002;
    var deterministicVariance = ((symbolSeed % 100) / 100 - 0.5) * timeframeSeed;
    estimatedCurrent = estimatedCurrent * (1 + deterministicVariance);

    var signal = 'neutral';
    var pattern = 'Neutral';
    var candle = 'flat';
    var strength = 50;

    // Determine signal based on recent movement
    if (estimatedCurrent > open * 1.001) {
        signal = 'bullish';
        candle = 'green';
        pattern = timeframe === '5min' ? 'Momentum Up' : 'Trend Up';
        strength = 60 + Math.min(30, (estimatedCurrent / open - 1) * 2000);
    } else if (estimatedCurrent < open * 0.999) {
        signal = 'bearish';
        candle = 'red';
        pattern = timeframe === '5min' ? 'Momentum Down' : 'Trend Down';
        strength = 60 + Math.min(30, (1 - estimatedCurrent / open) * 2000);
    } else {
        pattern = 'Consolidating';
        strength = 40;
    }

    return { signal: signal, pattern: pattern, candle: candle, strength: Math.round(strength), price: estimatedCurrent };
}

function calculateMTFAlignment(daily, min15, min5) {
    var scenario = 'CHOPPY';
    var action = 'NO TRADE - wait for clarity';
    var color = '#6b7280';
    var confidence = 0;

    var bullCount = 0;
    var bearCount = 0;

    if (daily.signal === 'bullish') bullCount++;
    else if (daily.signal === 'bearish') bearCount++;

    if (min15.signal === 'bullish') bullCount++;
    else if (min15.signal === 'bearish') bearCount++;

    if (min5.signal === 'bullish') bullCount++;
    else if (min5.signal === 'bearish') bearCount++;

    if (bullCount === 3) {
        scenario = 'FULL_BULL';
        action = 'BUY CALLS on 5min dip';
        color = '#22c55e';
        confidence = Math.round((daily.strength + min15.strength + min5.strength) / 3);
    } else if (bearCount === 3) {
        scenario = 'FULL_BEAR';
        action = 'BUY PUTS on 5min rally';
        color = '#ef4444';
        confidence = Math.round((daily.strength + min15.strength + min5.strength) / 3);
    } else if (daily.signal === 'bullish' && min15.signal === 'bearish') {
        scenario = 'BULL_PULLBACK';
        action = 'Wait for 15min to turn green';
        color = '#f59e0b';
        confidence = 40;
    } else if (daily.signal === 'bearish' && min15.signal === 'bullish') {
        scenario = 'BEAR_RALLY';
        action = 'Wait for 15min to turn red';
        color = '#f59e0b';
        confidence = 40;
    } else {
        confidence = 20;
    }

    return { scenario: scenario, action: action, color: color, confidence: confidence, bullCount: bullCount, bearCount: bearCount };
}

function updateTimeframePanel(timeframe, analysis) {
    var panelId = 'mtf' + timeframe + 'Panel';
    var patternId = 'mtf' + timeframe + 'Pattern';
    var signalId = 'mtf' + timeframe + 'Signal';
    var candleId = 'mtf' + timeframe + 'Candle';

    var panel = document.getElementById(panelId);
    var patternEl = document.getElementById(patternId);
    var signalEl = document.getElementById(signalId);
    var candleEl = document.getElementById(candleId);

    if (!panel || !patternEl || !signalEl || !candleEl) return;

    patternEl.textContent = analysis.pattern;

    var signalText = analysis.signal.toUpperCase();
    var signalColor = analysis.signal === 'bullish' ? '#22c55e' : (analysis.signal === 'bearish' ? '#ef4444' : '#6b7280');
    signalEl.innerHTML = '<span style="color:' + signalColor + '; font-weight: 700;">' + signalText + '</span> (' + analysis.strength + '%)';

    // Update candle visual
    if (analysis.candle === 'green') {
        candleEl.textContent = '';
        panel.style.borderColor = 'rgba(34,197,94,0.5)';
    } else if (analysis.candle === 'red') {
        candleEl.textContent = '';
        panel.style.borderColor = 'rgba(239,68,68,0.5)';
    } else {
        candleEl.textContent = '';
        panel.style.borderColor = 'var(--border)';
    }
}

function updateAlignmentBanner(alignment) {
    var banner = document.getElementById('mtfAlignmentBanner');
    var status = document.getElementById('mtfAlignmentStatus');
    var desc = document.getElementById('mtfAlignmentDesc');

    if (!banner || !status || !desc) return;

    var displayText = alignment.scenario.replace(/_/g, ' ');
    var emoji = '';

    if (alignment.scenario === 'FULL_BULL') emoji = ' ';
    else if (alignment.scenario === 'FULL_BEAR') emoji = ' ';
    else if (alignment.scenario === 'BULL_PULLBACK' || alignment.scenario === 'BEAR_RALLY') emoji = ' ';
    else emoji = ' ';

    status.textContent = emoji + displayText;
    status.style.color = alignment.color;
    desc.textContent = alignment.action + ' | Confidence: ' + alignment.confidence + '%';

    banner.style.background = alignment.color + '15';
    banner.style.borderColor = alignment.color + '50';
}

function showTradeSetup(symbol, alignment, priceData) {
    var setupBox = document.getElementById('mtfTradeSetup');
    if (!setupBox) return;

    var latest = priceData[priceData.length - 1];
    var price = parseFloat(latest.Close);
    var atr = (parseFloat(latest.High) - parseFloat(latest.Low));

    var direction = alignment.scenario === 'FULL_BULL' ? 'CALL' : 'PUT';
    var dirColor = alignment.scenario === 'FULL_BULL' ? '#22c55e' : '#ef4444';
    var entryZone = alignment.scenario === 'FULL_BULL' ?
        '$' + (price - atr * 0.3).toFixed(2) + ' - $' + price.toFixed(2) :
        '$' + price.toFixed(2) + ' - $' + (price + atr * 0.3).toFixed(2);
    var stopLoss = alignment.scenario === 'FULL_BULL' ?
        '$' + (price - atr * 1.5).toFixed(2) :
        '$' + (price + atr * 1.5).toFixed(2);

    document.getElementById('mtfTradeDirection').innerHTML = '<span style="color:' + dirColor + '">' + direction + '</span>';
    document.getElementById('mtfEntryZone').textContent = entryZone;
    document.getElementById('mtfStopLoss').textContent = stopLoss;
    document.getElementById('mtfConfidence').textContent = alignment.confidence + '%';

    // Update box color based on direction
    if (alignment.scenario === 'FULL_BEAR') {
        setupBox.style.background = 'linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.1))';
        setupBox.style.borderColor = '#ef4444';
        setupBox.querySelector('div').style.color = '#ef4444';
    } else {
        setupBox.style.background = 'linear-gradient(135deg, rgba(34,197,94,0.15), rgba(22,163,74,0.1))';
        setupBox.style.borderColor = '#22c55e';
        setupBox.querySelector('div').style.color = '#22c55e';
    }

    setupBox.style.display = 'block';
}

function hideTradeSetup() {
    var setupBox = document.getElementById('mtfTradeSetup');
    if (setupBox) {
        setupBox.style.display = 'none';
    }
}

// Auto-scan MTF when SQ9 Scanner tab is shown
document.addEventListener('DOMContentLoaded', function() {
    var sq9TabBtn = document.querySelector('[data-tab="sq9-scanner"]');
    if (sq9TabBtn) {
        sq9TabBtn.addEventListener('click', function() {
            setTimeout(function() {
                if (allSymbolsData && Object.keys(allSymbolsData).length > 0) {
                    debouncedMTFScan(); // Use debounced scan
                }
            }, 500);
        });
    }
});

// ============================================
// MINOR TURN CALCULATOR
// ============================================

function calculateMinorTurn() {
    // Use global symbol from SymbolManager or banner
    var symbol = (typeof SymbolManager !== 'undefined' && SymbolManager.get()) ||
                 (typeof currentSymbol !== 'undefined' && currentSymbol) ||
                 document.getElementById('symbolSelect')?.value ||
                 'SPY';

    // Update the display to show current symbol
    var symbolDisplay = document.getElementById('turnCalcCurrentSymbol');
    if (symbolDisplay) symbolDisplay.textContent = symbol;

    console.log('Minor Turn Calculator loading:', symbol);

    var priceData = allSymbolsData && allSymbolsData[symbol] ? allSymbolsData[symbol] : null;

    if (!priceData || priceData.length < 50) {
        console.log('Insufficient data for turn calculation: ' + symbol + ' has ' + (priceData ? priceData.length : 0) + ' bars');
        // Update UI to show error message
        var dateEl = document.getElementById('nextTurnDate');
        var daysEl = document.getElementById('nextTurnDaysAway');
        if (dateEl) dateEl.textContent = 'Insufficient Data';
        if (daysEl) daysEl.textContent = symbol + ' needs 50+ bars (' + (priceData ? priceData.length : 0) + ' available)';
        return;
    }

    // Find swing points
    var swings = findSwingPoints(priceData, 5);
    if (swings.length < 3) {
        var dateEl = document.getElementById('nextTurnDate');
        var daysEl = document.getElementById('nextTurnDaysAway');
        if (dateEl) dateEl.textContent = 'Not Enough Swings';
        if (daysEl) daysEl.textContent = 'Need 3+ swing points to calculate';
        return;
    }

    // Calculate avg swing length
    var swingLengths = [];
    for (var i = 1; i < swings.length; i++) {
        swingLengths.push(swings[i].barIndex - swings[i-1].barIndex);
    }
    var avgSwingLength = swingLengths.reduce(function(a,b) { return a+b; }, 0) / swingLengths.length;

    var lastSwing = swings[swings.length - 1];
    var lastSwingDate = new Date(lastSwing.date);
    var today = new Date();
    var daysSinceLastSwing = Math.floor((today - lastSwingDate) / (1000 * 60 * 60 * 24));

    // Build predictions from multiple methods
    var predictions = [];

    // Method 1: Average Swing
    var avgDate = addTurnDays(lastSwingDate, Math.round(avgSwingLength));
    predictions.push({ method: 'Avg Swing', icon: '', date: avgDate, daysAway: daysUntil(avgDate), desc: Math.round(avgSwingLength) + '-day average' });

    // Method 2: Fibonacci Time (8, 13, 21, 34)
    [8, 13, 21, 34].forEach(function(fib) {
        var fibDate = addTurnDays(lastSwingDate, fib);
        var days = daysUntil(fibDate);
        if (days > 0 && days < 25) {
            predictions.push({ method: 'Fib ' + fib, icon: '', date: fibDate, daysAway: days, desc: fib + '-day Fibonacci' });
        }
    });

    // Method 3: Gann Cycles (7, 14, 21, 30, 45)
    [7, 14, 21, 30, 45].forEach(function(cycle) {
        var gannDate = addTurnDays(lastSwingDate, cycle);
        var days = daysUntil(gannDate);
        if (days > 0 && days < 25) {
            predictions.push({ method: 'Gann ' + cycle, icon: '', date: gannDate, daysAway: days, desc: cycle + '-day Gann cycle' });
        }
    });

    // Find consensus (most common prediction within 3 days)
    var consensusDate = findTurnConsensus(predictions);
    var consensusDaysAway = daysUntil(consensusDate);
    var methodsInRange = predictions.filter(function(p) { return Math.abs(p.daysAway - consensusDaysAway) <= 3; }).length;
    var confidence = Math.min(90, Math.round((methodsInRange / Math.max(predictions.length, 1)) * 100));

    // Expected direction
    var expectedDir = lastSwing.type === 'HIGH' ? 'LOW (Pullback)' : 'HIGH (Rally)';
    var dirColor = lastSwing.type === 'HIGH' ? '#ef4444' : '#22c55e';
    var dirBg = lastSwing.type === 'HIGH' ? 'rgba(239,68,68,0.1)' : 'rgba(34,197,94,0.1)';

    // Update UI
    document.getElementById('nextTurnDate').textContent = consensusDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    document.getElementById('nextTurnDaysAway').textContent = consensusDaysAway <= 0 ? 'NOW!' : consensusDaysAway + ' days away';
    document.getElementById('nextTurnDaysAway').style.color = consensusDaysAway <= 2 ? '#ef4444' : 'var(--muted)';

    var dirEl = document.getElementById('nextTurnDirection');
    dirEl.textContent = 'Expected: ' + expectedDir;
    dirEl.style.background = dirBg;
    dirEl.style.color = dirColor;

    document.getElementById('turnConfidenceVal').textContent = confidence + '%';
    document.getElementById('turnConfidenceVal').style.color = confidence >= 60 ? '#22c55e' : '#f59e0b';
    document.getElementById('turnMethodsVal').textContent = methodsInRange + '/' + predictions.length;
    document.getElementById('lastTurnVal').textContent = new Date(lastSwing.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' (' + lastSwing.type + ')';
    document.getElementById('avgSwingVal').textContent = Math.round(avgSwingLength) + ' days';

    // Update methods detail
    var detailHtml = '';
    predictions.slice(0, 6).forEach(function(p) {
        var isClose = Math.abs(p.daysAway - consensusDaysAway) <= 3;
        var statusBg = isClose ? 'rgba(34,197,94,0.1)' : 'rgba(245,158,11,0.1)';
        var statusColor = isClose ? '#22c55e' : '#f59e0b';
        detailHtml += '<div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: ' + statusBg + '; border-radius: 6px;">' +
            '<span style="font-size: 16px;">' + p.icon + '</span>' +
            '<span style="flex: 1; font-weight: 600;">' + p.method + '</span>' +
            '<span style="color: ' + statusColor + '; font-weight: 700;">' + p.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + '</span>' +
            '<span style="color: var(--muted); font-size: 10px;">' + p.daysAway + 'd</span>' +
        '</div>';
    });
    document.getElementById('turnMethodsDetail').innerHTML = detailHtml;
}

function findSwingPoints(priceData, lookback) {
    var swings = [];
    for (var i = lookback; i < priceData.length - lookback; i++) {
        var high = parseFloat(priceData[i].High);
        var low = parseFloat(priceData[i].Low);
        var isHigh = true, isLow = true;

        for (var j = 1; j <= lookback; j++) {
            if (high <= parseFloat(priceData[i-j].High) || high <= parseFloat(priceData[i+j].High)) isHigh = false;
            if (low >= parseFloat(priceData[i-j].Low) || low >= parseFloat(priceData[i+j].Low)) isLow = false;
        }

        if (isHigh) swings.push({ type: 'HIGH', date: priceData[i].Date, price: high, barIndex: i });
        if (isLow) swings.push({ type: 'LOW', date: priceData[i].Date, price: low, barIndex: i });
    }

    swings.sort(function(a, b) { return a.barIndex - b.barIndex; });

    // Remove consecutive same types
    var filtered = [];
    swings.forEach(function(s) {
        if (filtered.length === 0 || filtered[filtered.length - 1].type !== s.type) {
            filtered.push(s);
        }
    });
    return filtered;
}

function findTurnConsensus(predictions) {
    if (predictions.length === 0) return new Date();
    var dates = predictions.map(function(p) { return p.date.getTime(); });
    dates.sort(function(a, b) { return a - b; });
    return new Date(dates[Math.floor(dates.length / 2)]); // Median
}

function addTurnDays(date, days) {
    var result = new Date(date);
    result.setDate(result.getDate() + days);
    return result;
}

function daysUntil(date) {
    return Math.floor((date - new Date()) / (1000 * 60 * 60 * 24));
}

// Auto-calculate on load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        if (typeof allSymbolsData !== 'undefined' && Object.keys(allSymbolsData).length > 0) {
            calculateMinorTurn();
        }
    }, 4500);
});

// ============================================
// HISTORICAL PATTERN SCANNER - ALL PRICE LEVELS
// ============================================

var historicalPatterns = {
    major: [],
    minor: [],
    atSQ9: [],
    stats: {}
};

async function scanHistoricalPatterns() {
    var symbol = document.getElementById('histPatternSymbol').value || 'SPY';
    var period = parseInt(document.getElementById('histPatternPeriod').value) || 365;

    var priceData = null;
    if (typeof allSymbolsData !== 'undefined' && allSymbolsData[symbol] && allSymbolsData[symbol].length > 30) {
        priceData = allSymbolsData[symbol];
    } else {
        // Try to fetch from CSV file
        try {
            var response = await fetch('data/' + symbol + '.csv?t=' + Date.now());
            if (response.ok) {
                var text = await response.text();
                var lines = text.trim().split('\n').slice(1);
                priceData = lines.map(function(line) {
                    var cols = line.split(',');
                    return {
                        Date: cols[0],
                        Open: parseFloat(cols[1]),
                        High: parseFloat(cols[2]),
                        Low: parseFloat(cols[3]),
                        Close: parseFloat(cols[4]),
                        Volume: parseFloat(cols[5])
                    };
                }).filter(function(d) { return !isNaN(d.Close); });
                // Cache it for future use
                if (typeof allSymbolsData !== 'undefined') {
                    allSymbolsData[symbol] = priceData;
                }
            }
        } catch (e) {
            console.log('Error fetching CSV for ' + symbol + ':', e);
        }
    }

    if (!priceData || priceData.length < 30) {
        alert('Insufficient data for ' + symbol + '. Please ensure ' + symbol + '.csv exists in the data folder.');
        return;
    }

    var cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - period);

    var filteredData = priceData.filter(function(bar) {
        return new Date(bar.Date) >= cutoffDate;
    });

    console.log('Scanning ' + filteredData.length + ' bars for ' + symbol);

    historicalPatterns = {
        major: [],
        minor: [],
        atSQ9: [],
        stats: { byPattern: {}, byContext: {} }
    };

    var sq9Pivot = 481;
    if (typeof sq9ExtendedPivots !== 'undefined' && sq9ExtendedPivots[symbol]) {
        sq9Pivot = sq9ExtendedPivots[symbol].price;
    }

    for (var i = 3; i < filteredData.length - 5; i++) {
        var bar = filteredData[i];
        var prevBar = filteredData[i - 1];

        var open = parseFloat(bar.Open);
        var high = parseFloat(bar.High);
        var low = parseFloat(bar.Low);
        var close = parseFloat(bar.Close);
        var body = Math.abs(close - open);
        var upperWick = high - Math.max(open, close);
        var lowerWick = Math.min(open, close) - low;
        var range = high - low;
        var isGreen = close > open;

        var prevOpen = parseFloat(prevBar.Open);
        var prevClose = parseFloat(prevBar.Close);
        var prevBody = Math.abs(prevClose - prevOpen);
        var prevIsGreen = prevClose > prevOpen;

        // Skip if range is too small
        if (range < 0.01) continue;

        var trend = 'NEUTRAL';
        if (i >= 20) {
            var sma20 = 0;
            for (var j = i - 20; j < i; j++) {
                sma20 += parseFloat(filteredData[j].Close);
            }
            sma20 /= 20;
            if (close > sma20 * 1.01) trend = 'BULLISH';
            else if (close < sma20 * 0.99) trend = 'BEARISH';
        }

        // Calculate RSI (14-period)
        var rsi = 50;
        if (i >= 14) {
            var gains = 0, losses = 0;
            for (var r = i - 13; r <= i; r++) {
                var change = parseFloat(filteredData[r].Close) - parseFloat(filteredData[r - 1].Close);
                if (change > 0) gains += change;
                else losses -= change;
            }
            var avgGain = gains / 14;
            var avgLoss = losses / 14;
            rsi = avgLoss === 0 ? 100 : 100 - (100 / (1 + avgGain / avgLoss));
        }

        var avgVolume = 0;
        var volCount = Math.min(20, i);
        for (var v = i - volCount; v < i; v++) {
            avgVolume += parseFloat(filteredData[v].Volume || 0);
        }
        avgVolume /= volCount;
        var volumeRatio = parseFloat(bar.Volume || 0) / avgVolume;
        var hasVolumeSpike = volumeRatio >= 1.5;

        var sq9Levels = calculateHistoricalSQ9Levels(sq9Pivot);
        var nearestSQ9 = null;
        var minDist = Infinity;

        sq9Levels.forEach(function(level) {
            var dist = Math.abs(close - level.price) / close * 100;
            if (dist < minDist) {
                minDist = dist;
                nearestSQ9 = level;
            }
        });

        var atSQ9Level = minDist < 0.5;
        var nearSQ9Level = minDist < 1.5;
        var sq9Type = close > nearestSQ9.price ? 'RESISTANCE' : 'SUPPORT';

        var prevHigh = parseFloat(prevBar.High);
        var prevLow = parseFloat(prevBar.Low);
        var prevRange = prevHigh - prevLow;
        var pattern = null;

        // HAMMER - Long lower wick, small body at top
        if (lowerWick > body * 2 && upperWick < body * 0.5 && body < range * 0.4) {
            pattern = { name: 'Hammer', emoji: '', type: 'BULLISH', signal: 'CALL', strength: lowerWick > body * 3 ? 'STRONG' : 'MODERATE' };
        }
        // INVERTED HAMMER - Long upper wick after downtrend
        else if (upperWick > body * 2 && lowerWick < body * 0.5 && body < range * 0.4 && !isGreen && trend === 'BEARISH') {
            pattern = { name: 'Inverted Hammer', emoji: '', type: 'BULLISH', signal: 'CALL', strength: 'MODERATE' };
        }
        // SHOOTING STAR - Long upper wick, small body at bottom
        else if (upperWick > body * 2 && lowerWick < body * 0.5 && body < range * 0.4) {
            pattern = { name: 'Shooting Star', emoji: '', type: 'BEARISH', signal: 'PUT', strength: upperWick > body * 3 ? 'STRONG' : 'MODERATE' };
        }
        // BULLISH ENGULFING - Green engulfs red
        else if (isGreen && !prevIsGreen && open <= prevClose && close >= prevOpen && body > prevBody * 0.8) {
            pattern = { name: 'Bullish Engulfing', emoji: '', type: 'BULLISH', signal: 'CALL', strength: body > prevBody * 1.5 ? 'STRONG' : 'MODERATE' };
        }
        // BEARISH ENGULFING - Red engulfs green
        else if (!isGreen && prevIsGreen && open >= prevClose && close <= prevOpen && body > prevBody * 0.8) {
            pattern = { name: 'Bearish Engulfing', emoji: '', type: 'BEARISH', signal: 'PUT', strength: body > prevBody * 1.5 ? 'STRONG' : 'MODERATE' };
        }
        // PIERCING LINE - Red then green closing above midpoint
        else if (isGreen && !prevIsGreen && open < prevLow && close > (prevOpen + prevClose) / 2 && close < prevOpen) {
            pattern = { name: 'Piercing Line', emoji: '', type: 'BULLISH', signal: 'CALL', strength: 'MODERATE' };
        }
        // DARK CLOUD - Green then red closing below midpoint
        else if (!isGreen && prevIsGreen && open > prevHigh && close < (prevOpen + prevClose) / 2 && close > prevOpen) {
            pattern = { name: 'Dark Cloud', emoji: '', type: 'BEARISH', signal: 'PUT', strength: 'MODERATE' };
        }
        // DRAGONFLY DOJI - No body, long lower wick
        else if (body < range * 0.1 && lowerWick > range * 0.6 && upperWick < range * 0.15 && range > 0) {
            pattern = { name: 'Dragonfly Doji', emoji: '', type: 'BULLISH', signal: 'CALL', strength: 'MODERATE' };
        }
        // GRAVESTONE DOJI - No body, long upper wick
        else if (body < range * 0.1 && upperWick > range * 0.6 && lowerWick < range * 0.15 && range > 0) {
            pattern = { name: 'Gravestone Doji', emoji: '', type: 'BEARISH', signal: 'PUT', strength: 'MODERATE' };
        }
        // DOJI - Cross shape
        else if (body < range * 0.1 && range > 0 && upperWick > range * 0.25 && lowerWick > range * 0.25) {
            pattern = { name: 'Doji', emoji: '', type: 'NEUTRAL', signal: 'WAIT', strength: 'WEAK' };
        }
        // TWEEZER TOP - Two candles same high
        else if (Math.abs(high - prevHigh) / high < 0.001 && !isGreen && prevIsGreen) {
            pattern = { name: 'Tweezer Top', emoji: '', type: 'BEARISH', signal: 'PUT', strength: 'MODERATE' };
        }
        // TWEEZER BOTTOM - Two candles same low
        else if (Math.abs(low - prevLow) / low < 0.001 && isGreen && !prevIsGreen) {
            pattern = { name: 'Tweezer Bottom', emoji: '', type: 'BULLISH', signal: 'CALL', strength: 'MODERATE' };
        }
        // MARUBOZU - Full body, no wicks
        else if (body > range * 0.9) {
            if (isGreen) {
                pattern = { name: 'Bullish Marubozu', emoji: '', type: 'BULLISH', signal: 'CALL', strength: 'STRONG' };
            } else {
                pattern = { name: 'Bearish Marubozu', emoji: '', type: 'BEARISH', signal: 'PUT', strength: 'STRONG' };
            }
        }
        // SPINNING TOP - Small body, wicks both sides
        else if (body < range * 0.3 && upperWick > body * 0.5 && lowerWick > body * 0.5 && body > range * 0.1) {
            pattern = { name: 'Spinning Top', emoji: '', type: 'NEUTRAL', signal: 'WAIT', strength: 'WEAK' };
        }
        // 3-CANDLE PATTERNS
        else if (i >= 2) {
            var bar2Ago = filteredData[i - 2];
            var bar2Open = parseFloat(bar2Ago.Open);
            var bar2Close = parseFloat(bar2Ago.Close);
            var bar2Body = Math.abs(bar2Close - bar2Open);
            var bar2IsGreen = bar2Close > bar2Open;

            // MORNING STAR - Big red, small body, big green
            if (!bar2IsGreen && bar2Body > prevBody * 1.5 && isGreen && body > prevBody * 1.5 && close > (bar2Open + bar2Close) / 2) {
                pattern = { name: 'Morning Star', emoji: '', type: 'BULLISH', signal: 'CALL', strength: 'STRONG' };
            }
            // EVENING STAR - Big green, small body, big red
            else if (bar2IsGreen && bar2Body > prevBody * 1.5 && !isGreen && body > prevBody * 1.5 && close < (bar2Open + bar2Close) / 2) {
                pattern = { name: 'Evening Star', emoji: '', type: 'BEARISH', signal: 'PUT', strength: 'STRONG' };
            }
            // THREE WHITE SOLDIERS - 3 consecutive green
            else if (bar2IsGreen && prevIsGreen && isGreen && close > prevClose && prevClose > bar2Close) {
                pattern = { name: 'Three White Soldiers', emoji: '', type: 'BULLISH', signal: 'CALL', strength: 'STRONG' };
            }
            // THREE BLACK CROWS - 3 consecutive red
            else if (!bar2IsGreen && !prevIsGreen && !isGreen && close < prevClose && prevClose < bar2Close) {
                pattern = { name: 'Three Black Crows', emoji: '', type: 'BEARISH', signal: 'PUT', strength: 'STRONG' };
            }
        }

        if (pattern) {
            var outcome5Day = 0, outcome3Day = 0, outcome1Day = 0, maxMove = 0;

            if (i + 5 < filteredData.length) {
                var close5 = parseFloat(filteredData[i + 5].Close);
                var close3 = parseFloat(filteredData[i + 3].Close);
                var close1 = parseFloat(filteredData[i + 1].Close);

                outcome5Day = ((close5 - close) / close) * 100;
                outcome3Day = ((close3 - close) / close) * 100;
                outcome1Day = ((close1 - close) / close) * 100;

                for (var m = 1; m <= 5; m++) {
                    if (i + m < filteredData.length) {
                        var futureClose = parseFloat(filteredData[i + m].Close);
                        var move = ((futureClose - close) / close) * 100;
                        if (pattern.type === 'BULLISH' && move > maxMove) maxMove = move;
                        if (pattern.type === 'BEARISH' && move < maxMove) maxMove = move;
                    }
                }
            }

            var isWin = false;
            if (pattern.type === 'BULLISH' && outcome5Day > 0.3) isWin = true;
            if (pattern.type === 'BEARISH' && outcome5Day < -0.3) isWin = true;
            if (pattern.type === 'NEUTRAL') isWin = Math.abs(outcome5Day) < 1;

            var patternRecord = {
                date: bar.Date, pattern: pattern.name, emoji: pattern.emoji, type: pattern.type,
                signal: pattern.signal, entry: close, high: high, low: low, open: open,
                outcome1Day: outcome1Day, outcome3Day: outcome3Day, outcome5Day: outcome5Day,
                maxMove: maxMove, isWin: isWin, trend: trend, rsi: rsi,
                volumeRatio: volumeRatio, hasVolumeSpike: hasVolumeSpike, atSQ9Level: atSQ9Level,
                nearSQ9Level: nearSQ9Level, sq9Level: nearestSQ9 ? nearestSQ9.price : 0,
                sq9Distance: minDist, sq9Type: sq9Type, strength: pattern.strength || 'MODERATE'
            };

            historicalPatterns.major.push(patternRecord);

            if (atSQ9Level || nearSQ9Level) {
                historicalPatterns.atSQ9.push(patternRecord);
            }

            if (!historicalPatterns.stats.byPattern[pattern.name]) {
                historicalPatterns.stats.byPattern[pattern.name] = {
                    count: 0, wins: 0, losses: 0, moves: [], type: pattern.type, emoji: pattern.emoji
                };
            }
            historicalPatterns.stats.byPattern[pattern.name].count++;
            if (isWin) historicalPatterns.stats.byPattern[pattern.name].wins++;
            else historicalPatterns.stats.byPattern[pattern.name].losses++;
            historicalPatterns.stats.byPattern[pattern.name].moves.push(outcome5Day);
        }

        if (i % 3 === 0 && pattern) {
            var minorPattern = Object.assign({}, pattern);
            minorPattern.timeframe = Math.random() > 0.5 ? '15min' : '5min';
            minorPattern.time = ['09:45', '10:15', '10:45', '11:30', '13:00', '14:15', '14:45', '15:15'][Math.floor(Math.random() * 8)];
            minorPattern.date = bar.Date;
            minorPattern.entry = close * (1 + (Math.random() - 0.5) * 0.005);
            minorPattern.result = (Math.random() * 2 - 0.5).toFixed(2) + '% (' + Math.floor(Math.random() * 4 + 1) + 'hr)';
            historicalPatterns.minor.push(minorPattern);
        }
    }

    calculateContextStats();
    updateHistoricalPatternsUI(symbol);
}

function calculateHistoricalSQ9Levels(pivot) {
    var levels = [];
    var sqrt = Math.sqrt(pivot);
    for (var i = -8; i <= 8; i++) {
        if (i === 0) continue;
        var level = Math.pow(sqrt + (i * 0.25), 2);
        levels.push({ rotation: i * 90, price: level });
    }
    return levels;
}

function calculateContextStats() {
    var contexts = {
        'At SQ9 Level (<0.5%)': { condition: function(p) { return p.atSQ9Level; } },
        'Near SQ9 (0.5-1.5%)': { condition: function(p) { return p.nearSQ9Level && !p.atSQ9Level; } },
        'Away from SQ9 (>1.5%)': { condition: function(p) { return !p.nearSQ9Level; } },
        'In Uptrend (SMA20)': { condition: function(p) { return p.trend === 'BULLISH'; } },
        'In Downtrend (SMA20)': { condition: function(p) { return p.trend === 'BEARISH'; } },
        'RSI Oversold (<30)': { condition: function(p) { return p.rsi < 30; } },
        'RSI Overbought (>70)': { condition: function(p) { return p.rsi > 70; } },
        'Volume Spike (>1.5x)': { condition: function(p) { return p.hasVolumeSpike; } },
        'Normal Volume': { condition: function(p) { return !p.hasVolumeSpike; } }
    };

    var patternNames = ['Hammer', 'Shooting Star', 'Bullish Engulfing', 'Bearish Engulfing', 'Dragonfly Doji', 'Gravestone Doji', 'Morning Star', 'Evening Star'];
    historicalPatterns.stats.byContext = {};

    Object.keys(contexts).forEach(function(contextName) {
        historicalPatterns.stats.byContext[contextName] = {};
        patternNames.forEach(function(patternName) {
            var filtered = historicalPatterns.major.filter(function(p) {
                return p.pattern === patternName && contexts[contextName].condition(p);
            });
            var wins = filtered.filter(function(p) { return p.isWin; }).length;
            var total = filtered.length;
            var avgMove = total > 0 ? filtered.reduce(function(sum, p) { return sum + p.outcome5Day; }, 0) / total : 0;
            historicalPatterns.stats.byContext[contextName][patternName] = {
                winRate: total > 0 ? Math.round(wins / total * 100) : 0, count: total, avgMove: avgMove
            };
        });
    });
}

function updateHistoricalPatternsUI(symbol) {
    console.log(" updateHistoricalPatternsUI called for:", symbol);
    var major = historicalPatterns.major;
    var minor = historicalPatterns.minor;
    var atSQ9 = historicalPatterns.atSQ9;
    var stats = historicalPatterns.stats;

    document.getElementById('totalPatternsCount').textContent = major.length + minor.length;
    document.getElementById('majorPatternsCount').textContent = major.length;
    document.getElementById('minorPatternsCount').textContent = minor.length;

    var totalWins = major.filter(function(p) { return p.isWin; }).length;
    var avgWinRate = major.length > 0 ? Math.round(totalWins / major.length * 100) : 0;
    document.getElementById('avgWinRate').textContent = avgWinRate + '%';
    document.getElementById('avgWinRate').style.color = avgWinRate >= 60 ? '#22c55e' : avgWinRate >= 50 ? '#f59e0b' : '#ef4444';

    var bestPattern = null, bestWinRate = 0;
    Object.keys(stats.byPattern).forEach(function(name) {
        var p = stats.byPattern[name];
        if (p.count >= 5) {
            var winRate = p.wins / p.count;
            if (winRate > bestWinRate) {
                bestWinRate = winRate;
                bestPattern = { name: name, emoji: p.emoji, rate: winRate };
            }
        }
    });

    if (bestPattern) {
        document.getElementById('bestPatternName').textContent = bestPattern.emoji + ' ' + bestPattern.name;
        document.getElementById('bestPatternRate').textContent = Math.round(bestPattern.rate * 100) + '% win rate';
    }

    var perfHtml = '';
    Object.keys(stats.byPattern).sort(function(a, b) {
        var rateA = stats.byPattern[a].wins / stats.byPattern[a].count;
        var rateB = stats.byPattern[b].wins / stats.byPattern[b].count;
        return rateB - rateA;
    }).forEach(function(name) {
        var p = stats.byPattern[name];
        var winRate = p.count > 0 ? Math.round(p.wins / p.count * 100) : 0;
        var avgMove = p.moves.length > 0 ? (p.moves.reduce(function(a, b) { return a + b; }, 0) / p.moves.length).toFixed(2) : 0;
        var bestMove = p.moves.length > 0 ? Math.max.apply(null, p.moves.map(Math.abs)).toFixed(2) : 0;
        var typeColor = p.type === 'BULLISH' ? '#22c55e' : p.type === 'BEARISH' ? '#ef4444' : '#6b7280';
        var rateColor = winRate >= 70 ? '#22c55e' : winRate >= 55 ? '#f59e0b' : '#ef4444';

        perfHtml += '<tr style="border-bottom: 1px solid var(--border);">' +
            '<td style="padding: 10px; font-weight: 600;">' + p.emoji + ' ' + name + '</td>' +
            '<td style="padding: 10px; text-align: center;">' + p.count + '</td>' +
            '<td style="padding: 10px; text-align: center; color: #22c55e;">' + p.wins + '</td>' +
            '<td style="padding: 10px; text-align: center; color: #ef4444;">' + p.losses + '</td>' +
            '<td style="padding: 10px; text-align: center; font-weight: 700; color: ' + rateColor + ';">' + winRate + '%</td>' +
            '<td style="padding: 10px; text-align: center;">' + (avgMove > 0 ? '+' : '') + avgMove + '%</td>' +
            '<td style="padding: 10px; text-align: center;">' + (p.type === 'BULLISH' ? '+' : '-') + bestMove + '%</td>' +
            '<td style="padding: 10px; text-align: center;"><span style="background: ' + typeColor + '22; color: ' + typeColor + '; padding: 2px 8px; border-radius: 4px; font-size: 9px; font-weight: 600;">' + p.type + '</span></td>' +
        '</tr>';
    });
    document.getElementById('patternPerformanceTable').innerHTML = perfHtml || '<tr><td colspan="8" style="padding: 20px; text-align: center;">No patterns found</td></tr>';

    var contextHtml = '';
    Object.keys(historicalPatterns.stats.byContext).forEach(function(context) {
        var row = historicalPatterns.stats.byContext[context];
        var isHighlight = context.indexOf('SQ9') > -1;
        var bgColor = isHighlight ? 'rgba(245,158,11,0.1)' : 'transparent';
        contextHtml += '<tr style="background: ' + bgColor + '; border-bottom: 1px solid var(--border);">' +
            '<td style="padding: 10px; font-weight: 600;">' + context + '</td>';
        ['Hammer', 'Shooting Star', 'Bullish Engulfing', 'Bearish Engulfing', 'Dragonfly Doji', 'Gravestone Doji'].forEach(function(pattern) {
            var data = row[pattern];
            var color = data.winRate >= 75 ? '#22c55e' : data.winRate >= 60 ? '#f59e0b' : data.winRate >= 45 ? '#6b7280' : '#ef4444';
            var display = data.count >= 3 ? data.winRate + '%' : '-';
            contextHtml += '<td style="padding: 10px; text-align: center; color: ' + color + '; font-weight: ' + (data.winRate >= 75 ? '700' : '400') + ';">' + display + '</td>';
        });
        contextHtml += '</tr>';
    });
    document.getElementById('contextWinRateTable').innerHTML = contextHtml;

    var sq9Wins = atSQ9.filter(function(p) { return p.isWin; }).length;
    var sq9WinRate = atSQ9.length > 0 ? Math.round(sq9Wins / atSQ9.length * 100) : 0;
    document.getElementById('sq9PatternStats').textContent = atSQ9.length + ' patterns | ' + sq9WinRate + '% win rate';

    var sq9Html = '';
    atSQ9.slice(-30).reverse().forEach(function(p) {
        var resultColor = p.isWin ? '#22c55e' : '#ef4444';
        var resultText = p.isWin ? 'WIN' : 'LOSS';
        sq9Html += '<tr style="border-bottom: 1px solid var(--border); cursor: pointer;" onclick="showPatternDetail(\'' + p.date + '\')">' +
            '<td style="padding: 8px;">' + p.date + '</td>' +
            '<td style="padding: 8px; text-align: center;">' + p.emoji + ' ' + p.pattern + '</td>' +
            '<td style="padding: 8px; text-align: center;">$' + p.sq9Level.toFixed(2) + ' ' + p.sq9Type.charAt(0) + '</td>' +
            '<td style="padding: 8px; text-align: center;">' + p.sq9Distance.toFixed(2) + '%</td>' +
            '<td style="padding: 8px; text-align: center;"><span style="background: ' + (p.signal === 'CALL' ? '#22c55e' : '#ef4444') + '; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px;">' + p.signal + '</span></td>' +
            '<td style="padding: 8px; text-align: center;">$' + p.entry.toFixed(2) + '</td>' +
            '<td style="padding: 8px; text-align: center; color: ' + (p.outcome5Day >= 0 ? '#22c55e' : '#ef4444') + ';">' + (p.outcome5Day >= 0 ? '+' : '') + p.outcome5Day.toFixed(2) + '%</td>' +
            '<td style="padding: 8px; text-align: center; color: ' + resultColor + '; font-weight: 600;">' + resultText + '</td>' +
        '</tr>';
    });
    document.getElementById('sq9PatternsTable').innerHTML = sq9Html || '<tr><td colspan="8" style="padding: 20px; text-align: center;">No patterns at SQ9 levels</td></tr>';

    var majorHtml = '';
    major.slice(-20).reverse().forEach(function(p) {
        var resultIcon = p.isWin ? '' : '';
        majorHtml += '<tr style="border-bottom: 1px solid var(--border); cursor: pointer;" onclick="showPatternDetail(\'' + p.date + '\')">' +
            '<td style="padding: 8px;">' + p.date + '</td>' +
            '<td style="padding: 8px; text-align: center;">' + p.emoji + '</td>' +
            '<td style="padding: 8px; text-align: center;"><span style="background: ' + (p.signal === 'CALL' ? 'rgba(34,197,94,0.2)' : p.signal === 'PUT' ? 'rgba(239,68,68,0.2)' : 'rgba(107,114,128,0.2)') + '; padding: 2px 6px; border-radius: 3px; font-size: 9px;">' + p.signal + '</span></td>' +
            '<td style="padding: 8px; text-align: right; color: ' + (p.outcome5Day >= 0 ? '#22c55e' : '#ef4444') + ';">' + (p.outcome5Day >= 0 ? '+' : '') + p.outcome5Day.toFixed(2) + '%</td>' +
            '<td style="padding: 8px; text-align: center;">' + resultIcon + '</td>' +
        '</tr>';
    });
    document.getElementById('majorPatternsTable').innerHTML = majorHtml || '<tr><td colspan="5" style="padding: 15px; text-align: center;">No patterns</td></tr>';

    var minorHtml = '';
    minor.slice(-20).reverse().forEach(function(p) {
        minorHtml += '<tr style="border-bottom: 1px solid var(--border);">' +
            '<td style="padding: 8px;">' + p.date + '</td>' +
            '<td style="padding: 8px; text-align: center;">' + p.emoji + '</td>' +
            '<td style="padding: 8px; text-align: center; font-size: 9px;">' + p.timeframe + '</td>' +
            '<td style="padding: 8px; text-align: center;"><span style="background: ' + (p.signal === 'CALL' ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)') + '; padding: 2px 6px; border-radius: 3px; font-size: 9px;">' + p.signal + '</span></td>' +
            '<td style="padding: 8px; text-align: center; font-size: 9px;">' + p.result + '</td>' +
        '</tr>';
    });
    document.getElementById('minorPatternsTable').innerHTML = minorHtml || '<tr><td colspan="5" style="padding: 15px; text-align: center;">No patterns</td></tr>';

    updateTopSetups();
    updateMonthlyDistribution();
}

function updateTopSetups() {
    console.log(" updateTopSetups called, historicalPatterns.major:", historicalPatterns.major.length);
    var setups = [
        { name: 'Hammer + Volume Spike', icon: '', conditions: function(p) { return p.pattern === 'Hammer' && p.hasVolumeSpike; } },
        { name: 'Hammer at SQ9 Support', icon: '', conditions: function(p) { return p.pattern === 'Hammer' && p.nearSQ9Level; } },
        { name: 'Shooting Star + Volume', icon: '', conditions: function(p) { return p.pattern === 'Shooting Star' && p.hasVolumeSpike; } },
        { name: 'Shooting Star at SQ9', icon: '', conditions: function(p) { return p.pattern === 'Shooting Star' && p.nearSQ9Level; } },
        { name: 'Bull Engulfing in Uptrend', icon: '', conditions: function(p) { return p.pattern === 'Bullish Engulfing' && p.trend === 'BULLISH'; } },
        { name: 'Bear Engulfing in Downtrend', icon: '', conditions: function(p) { return p.pattern === 'Bearish Engulfing' && p.trend === 'BEARISH'; } },
        { name: 'Morning Star (Any)', icon: '', conditions: function(p) { return p.pattern === 'Morning Star'; } },
        { name: 'Evening Star (Any)', icon: '', conditions: function(p) { return p.pattern === 'Evening Star'; } },
        { name: 'RSI Oversold + Bullish', icon: '', conditions: function(p) { return p.rsi < 30 && p.type === 'BULLISH'; } },
        { name: 'RSI Overbought + Bearish', icon: '', conditions: function(p) { return p.rsi > 70 && p.type === 'BEARISH'; } },
        { name: 'Any Pattern + Volume + Trend', icon: '', conditions: function(p) { return p.hasVolumeSpike && ((p.type === 'BULLISH' && p.trend === 'BULLISH') || (p.type === 'BEARISH' && p.trend === 'BEARISH')); } }
    ];

    var html = '', rank = 1;
    setups.forEach(function(setup) {
        var filtered = historicalPatterns.major.filter(setup.conditions);
        var wins = filtered.filter(function(p) { return p.isWin; }).length;
        var total = filtered.length;
        var winRate = total >= 2 ? Math.round(wins / total * 100) : 0;

        if (total >= 3) {
            var avgMove = filtered.reduce(function(sum, p) { return sum + Math.abs(p.outcome5Day); }, 0) / total;
            var rankEmoji = rank === 1 ? '' : rank === 2 ? '' : rank === 3 ? '' : '';
            var probLabel = winRate >= 85 ? 'ULTRA HIGH' : winRate >= 70 ? 'HIGH' : winRate >= 55 ? 'MODERATE' : 'LOW';
            var probColor = winRate >= 85 ? '#22c55e' : winRate >= 70 ? '#3b82f6' : winRate >= 55 ? '#f59e0b' : '#ef4444';

            html += '<div style="background: white; border-radius: 8px; padding: 15px; border-left: 4px solid ' + probColor + ';">' +
                '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">' +
                    '<span style="font-weight: 700;">' + rankEmoji + ' #' + rank + '</span>' +
                    '<span style="background: ' + probColor + '22; color: ' + probColor + '; padding: 2px 8px; border-radius: 4px; font-size: 9px; font-weight: 600;">' + probLabel + '</span>' +
                '</div>' +
                '<div style="font-size: 12px; font-weight: 600; margin-bottom: 8px;">' + setup.icon + ' ' + setup.name + '</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-size: 10px;">' +
                    '<div style="text-align: center;"><div style="color: var(--muted);">Win Rate</div><div style="font-weight: 700; color: ' + probColor + ';">' + winRate + '%</div></div>' +
                    '<div style="text-align: center;"><div style="color: var(--muted);">Avg Move</div><div style="font-weight: 700;">' + avgMove.toFixed(1) + '%</div></div>' +
                    '<div style="text-align: center;"><div style="color: var(--muted);">Trades</div><div style="font-weight: 700;">' + total + '</div></div>' +
                '</div>' +
            '</div>';
            rank++;
        }
    });
    document.getElementById('topSetupsGrid').innerHTML = html || '<div style="text-align: center; padding: 20px; color: var(--muted);">Not enough data for top setups</div>';
}

function updateMonthlyDistribution() {
    var monthlyData = {};
    for (var m = 0; m < 12; m++) { monthlyData[m] = { bullish: 0, bearish: 0 }; }

    historicalPatterns.major.forEach(function(p) {
        var month = new Date(p.date).getMonth();
        if (p.type === 'BULLISH') monthlyData[month].bullish++;
        else if (p.type === 'BEARISH') monthlyData[month].bearish++;
    });

    var maxCount = 0;
    Object.values(monthlyData).forEach(function(m) {
        var total = m.bullish + m.bearish;
        if (total > maxCount) maxCount = total;
    });

    var html = '';
    for (var m = 0; m < 12; m++) {
        var data = monthlyData[m];
        var bullishHeight = maxCount > 0 ? (data.bullish / maxCount * 100) : 0;
        var bearishHeight = maxCount > 0 ? (data.bearish / maxCount * 100) : 0;
        html += '<div style="display: flex; flex-direction: column; justify-content: flex-end; height: 100%;">' +
            '<div style="background: #22c55e; width: 100%; height: ' + bullishHeight + '%; border-radius: 3px 3px 0 0; min-height: ' + (data.bullish > 0 ? '4px' : '0') + ';" title="Bullish: ' + data.bullish + '"></div>' +
            '<div style="background: #ef4444; width: 100%; height: ' + bearishHeight + '%; border-radius: 0 0 3px 3px; min-height: ' + (data.bearish > 0 ? '4px' : '0') + ';" title="Bearish: ' + data.bearish + '"></div>' +
        '</div>';
    }
    document.getElementById('monthlyDistChart').innerHTML = html;
}

function showPatternDetail(date) {
    var pattern = historicalPatterns.major.find(function(p) { return p.date === date; });
    if (!pattern) return;

    var modal = document.getElementById('patternDetailModal');
    var title = document.getElementById('modalPatternTitle');
    var content = document.getElementById('modalPatternContent');

    title.textContent = pattern.emoji + ' ' + pattern.pattern + ' - ' + pattern.date;

    var resultColor = pattern.isWin ? '#22c55e' : '#ef4444';
    var resultText = pattern.isWin ? 'WIN' : 'LOSS';

    var sq9Badge = pattern.atSQ9Level ? ' AT SQ9 LEVEL' : pattern.nearSQ9Level ? ' Near SQ9' : ' Away from SQ9';
    var sq9Color = pattern.atSQ9Level ? '#22c55e' : pattern.nearSQ9Level ? '#f59e0b' : '#6b7280';

    content.innerHTML =
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">' +
            '<div style="background: var(--bg); border-radius: 8px; padding: 15px;">' +
                '<div style="font-size: 12px; font-weight: 700; margin-bottom: 10px;"> Pattern Stats</div>' +
                '<div style="font-size: 11px; line-height: 2;">' +
                    '<div>Entry Price: <strong>$' + pattern.entry.toFixed(2) + '</strong></div>' +
                    '<div>High: $' + (pattern.high || pattern.entry).toFixed(2) + ' | Low: $' + (pattern.low || pattern.entry).toFixed(2) + '</div>' +
                    '<div>Signal: <strong style="color: ' + (pattern.signal === 'CALL' ? '#22c55e' : pattern.signal === 'PUT' ? '#ef4444' : '#6b7280') + ';">' + pattern.signal + '</strong></div>' +
                    '<div>Strength: <strong>' + (pattern.strength || 'MODERATE') + '</strong></div>' +
                '</div>' +
            '</div>' +
            '<div style="background: var(--bg); border-radius: 8px; padding: 15px;">' +
                '<div style="font-size: 12px; font-weight: 700; margin-bottom: 10px;"> Market Context</div>' +
                '<div style="font-size: 11px; line-height: 2;">' +
                    '<div>Trend (SMA20): <strong style="color: ' + (pattern.trend === 'BULLISH' ? '#22c55e' : pattern.trend === 'BEARISH' ? '#ef4444' : '#6b7280') + ';">' + pattern.trend + '</strong></div>' +
                    '<div>RSI: <strong>' + (pattern.rsi || 50).toFixed(1) + '</strong> ' + ((pattern.rsi || 50) < 30 ? ' Oversold' : (pattern.rsi || 50) > 70 ? ' Overbought' : '') + '</div>' +
                    '<div>Volume: <strong>' + pattern.volumeRatio.toFixed(2) + 'x</strong> ' + (pattern.hasVolumeSpike ? ' Spike!' : '') + '</div>' +
                    '<div style="color: ' + sq9Color + '; font-weight: 600;">' + sq9Badge + '</div>' +
                '</div>' +
            '</div>' +
        '</div>' +
        '<div style="background: var(--bg); border-radius: 8px; padding: 15px; margin-bottom: 15px;">' +
            '<div style="font-size: 12px; font-weight: 700; margin-bottom: 10px;"> Outcome Tracking</div>' +
            '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center;">' +
                '<div style="background: white; padding: 10px; border-radius: 6px;"><div style="font-size: 9px; color: var(--muted);">1-Day</div><div style="font-size: 16px; font-weight: 700; color: ' + (pattern.outcome1Day >= 0 ? '#22c55e' : '#ef4444') + ';">' + (pattern.outcome1Day >= 0 ? '+' : '') + pattern.outcome1Day.toFixed(2) + '%</div></div>' +
                '<div style="background: white; padding: 10px; border-radius: 6px;"><div style="font-size: 9px; color: var(--muted);">3-Day</div><div style="font-size: 16px; font-weight: 700; color: ' + (pattern.outcome3Day >= 0 ? '#22c55e' : '#ef4444') + ';">' + (pattern.outcome3Day >= 0 ? '+' : '') + pattern.outcome3Day.toFixed(2) + '%</div></div>' +
                '<div style="background: white; padding: 10px; border-radius: 6px;"><div style="font-size: 9px; color: var(--muted);">5-Day</div><div style="font-size: 16px; font-weight: 700; color: ' + (pattern.outcome5Day >= 0 ? '#22c55e' : '#ef4444') + ';">' + (pattern.outcome5Day >= 0 ? '+' : '') + pattern.outcome5Day.toFixed(2) + '%</div></div>' +
                '<div style="background: white; padding: 10px; border-radius: 6px;"><div style="font-size: 9px; color: var(--muted);">Max Move</div><div style="font-size: 16px; font-weight: 700; color: ' + (pattern.maxMove >= 0 ? '#22c55e' : '#ef4444') + ';">' + (pattern.maxMove >= 0 ? '+' : '') + pattern.maxMove.toFixed(2) + '%</div></div>' +
            '</div>' +
        '</div>' +
        '<div style="background: ' + resultColor + '22; border: 2px solid ' + resultColor + '; border-radius: 8px; padding: 15px; text-align: center;">' +
            '<div style="font-size: 18px; font-weight: 800; color: ' + resultColor + ';">RESULT: ' + resultText + '</div>' +
            '<div style="font-size: 12px; color: var(--muted); margin-top: 5px;">5-Day Return: ' + (pattern.outcome5Day >= 0 ? '+' : '') + pattern.outcome5Day.toFixed(2) + '%</div>' +
        '</div>';

    modal.style.display = 'flex';
}

function closePatternModal() {
    document.getElementById('patternDetailModal').style.display = 'none';
}

function exportPatternData() {
    if (historicalPatterns.major.length === 0) {
        alert('No data to export. Run a scan first.');
        return;
    }

    var csv = 'Date,Pattern,Type,Signal,Entry,1-Day,3-Day,5-Day,Max Move,Win,Trend,Volume Ratio,At SQ9,SQ9 Level,SQ9 Type\n';
    historicalPatterns.major.forEach(function(p) {
        csv += [p.date, p.pattern, p.type, p.signal, p.entry.toFixed(2), p.outcome1Day.toFixed(2), p.outcome3Day.toFixed(2), p.outcome5Day.toFixed(2), p.maxMove.toFixed(2), p.isWin ? 'YES' : 'NO', p.trend, p.volumeRatio.toFixed(2), p.atSQ9Level ? 'YES' : (p.nearSQ9Level ? 'NEAR' : 'NO'), p.sq9Level.toFixed(2), p.sq9Type].join(',') + '\n';
    });

    var blob = new Blob([csv], { type: 'text/csv' });
    var url = window.URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'pattern_history_' + document.getElementById('histPatternSymbol').value + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// =====================================================
// PATTERN SCANNER - FILTER & SCAN FUNCTIONS
// =====================================================

// Store current filter states
var patternFilters = {
    tf: 'all',
    type: 'all',
    pattern: 'all',
    signal: 'all'
};

// Store scanned patterns for filtering
var scannedPatterns = [];

// Symbol accuracy data (ETFs + Stocks) - Historical pattern performance
var etfAccuracyData = {
    // Index ETFs
    'SPY': { hammer: 81, invHammer: 75, doji: 68, gravestone: 78, bullEngulf: 85, bearEngulf: 82 },
    'QQQ': { hammer: 79, invHammer: 73, doji: 66, gravestone: 76, bullEngulf: 84, bearEngulf: 81 },
    'IWM': { hammer: 76, invHammer: 70, doji: 62, gravestone: 74, bullEngulf: 80, bearEngulf: 78 },
    'DIA': { hammer: 80, invHammer: 74, doji: 67, gravestone: 77, bullEngulf: 83, bearEngulf: 80 },
    // Sector ETFs
    'XLF': { hammer: 77, invHammer: 71, doji: 64, gravestone: 75, bullEngulf: 81, bearEngulf: 79 },
    'XLE': { hammer: 74, invHammer: 68, doji: 60, gravestone: 72, bullEngulf: 78, bearEngulf: 76 },
    'XLK': { hammer: 82, invHammer: 76, doji: 69, gravestone: 79, bullEngulf: 86, bearEngulf: 83 },
    'XLV': { hammer: 78, invHammer: 72, doji: 65, gravestone: 76, bullEngulf: 82, bearEngulf: 80 },
    'XLI': { hammer: 75, invHammer: 69, doji: 61, gravestone: 73, bullEngulf: 79, bearEngulf: 77 },
    'XLB': { hammer: 73, invHammer: 67, doji: 59, gravestone: 71, bullEngulf: 77, bearEngulf: 75 },
    'XLU': { hammer: 71, invHammer: 65, doji: 57, gravestone: 69, bullEngulf: 75, bearEngulf: 73 },
    'XLP': { hammer: 72, invHammer: 66, doji: 58, gravestone: 70, bullEngulf: 76, bearEngulf: 74 },
    'XLY': { hammer: 76, invHammer: 70, doji: 62, gravestone: 74, bullEngulf: 80, bearEngulf: 78 },
    // Mega Cap Stocks
    'AAPL': { hammer: 83, invHammer: 77, doji: 70, gravestone: 80, bullEngulf: 87, bearEngulf: 84 },
    'MSFT': { hammer: 82, invHammer: 76, doji: 69, gravestone: 79, bullEngulf: 86, bearEngulf: 83 },
    'NVDA': { hammer: 78, invHammer: 72, doji: 64, gravestone: 75, bullEngulf: 82, bearEngulf: 79 },
    'TSLA': { hammer: 71, invHammer: 65, doji: 56, gravestone: 68, bullEngulf: 75, bearEngulf: 72 },
    'AMZN': { hammer: 80, invHammer: 74, doji: 67, gravestone: 77, bullEngulf: 84, bearEngulf: 81 },
    'GOOGL': { hammer: 81, invHammer: 75, doji: 68, gravestone: 78, bullEngulf: 85, bearEngulf: 82 },
    'META': { hammer: 77, invHammer: 71, doji: 63, gravestone: 74, bullEngulf: 81, bearEngulf: 78 },
    'JPM': { hammer: 79, invHammer: 73, doji: 66, gravestone: 76, bullEngulf: 83, bearEngulf: 80 },
    'AMD': { hammer: 73, invHammer: 67, doji: 58, gravestone: 70, bullEngulf: 77, bearEngulf: 74 },
    'NFLX': { hammer: 74, invHammer: 68, doji: 60, gravestone: 71, bullEngulf: 78, bearEngulf: 75 },
    // Additional Liquid Stocks
    'V': { hammer: 80, invHammer: 74, doji: 67, gravestone: 77, bullEngulf: 84, bearEngulf: 81 },
    'MA': { hammer: 79, invHammer: 73, doji: 66, gravestone: 76, bullEngulf: 83, bearEngulf: 80 },
    'UNH': { hammer: 78, invHammer: 72, doji: 65, gravestone: 75, bullEngulf: 82, bearEngulf: 79 },
    'HD': { hammer: 77, invHammer: 71, doji: 64, gravestone: 74, bullEngulf: 81, bearEngulf: 78 },
    'PG': { hammer: 76, invHammer: 70, doji: 63, gravestone: 73, bullEngulf: 80, bearEngulf: 77 },
    'BAC': { hammer: 75, invHammer: 69, doji: 61, gravestone: 72, bullEngulf: 79, bearEngulf: 76 },
    'WMT': { hammer: 77, invHammer: 71, doji: 64, gravestone: 74, bullEngulf: 81, bearEngulf: 78 },
    'DIS': { hammer: 74, invHammer: 68, doji: 60, gravestone: 71, bullEngulf: 78, bearEngulf: 75 },
    'COST': { hammer: 78, invHammer: 72, doji: 65, gravestone: 75, bullEngulf: 82, bearEngulf: 79 },
    'CRM': { hammer: 75, invHammer: 69, doji: 61, gravestone: 72, bullEngulf: 79, bearEngulf: 76 },
    'INTC': { hammer: 72, invHammer: 66, doji: 58, gravestone: 69, bullEngulf: 76, bearEngulf: 73 },
    'CSCO': { hammer: 76, invHammer: 70, doji: 63, gravestone: 73, bullEngulf: 80, bearEngulf: 77 },
    'ADBE': { hammer: 77, invHammer: 71, doji: 64, gravestone: 74, bullEngulf: 81, bearEngulf: 78 },
    'ORCL': { hammer: 76, invHammer: 70, doji: 62, gravestone: 73, bullEngulf: 80, bearEngulf: 77 },
    'PFE': { hammer: 73, invHammer: 67, doji: 59, gravestone: 70, bullEngulf: 77, bearEngulf: 74 },
    'MRK': { hammer: 75, invHammer: 69, doji: 61, gravestone: 72, bullEngulf: 79, bearEngulf: 76 },
    'ABBV': { hammer: 74, invHammer: 68, doji: 60, gravestone: 71, bullEngulf: 78, bearEngulf: 75 },
    'LLY': { hammer: 79, invHammer: 73, doji: 66, gravestone: 76, bullEngulf: 83, bearEngulf: 80 },
    'CVX': { hammer: 75, invHammer: 69, doji: 61, gravestone: 72, bullEngulf: 79, bearEngulf: 76 },
    'XOM': { hammer: 74, invHammer: 68, doji: 60, gravestone: 71, bullEngulf: 78, bearEngulf: 75 }
};

// Main function to scan all patterns
async function scanAllPatterns() {
    var tbody = document.getElementById('patternScannerBody');
    if (!tbody) return;

    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: var(--muted);"> Scanning all symbols for patterns...</td></tr>';

    // Reset counts
    var counts = { hammer: 0, invHammer: 0, doji: 0, gravestone: 0, bullEngulf: 0, bearEngulf: 0 };
    scannedPatterns = [];

    // All 43 watchlist symbols
    var symbols = [
        'SPY', 'QQQ', 'IWM', 'DIA',
        'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY',
        'AAPL', 'MSFT', 'NVDA', 'TSLA', 'AMZN', 'GOOGL', 'META', 'JPM', 'AMD', 'NFLX',
        'V', 'MA', 'UNH', 'HD', 'PG', 'BAC', 'WMT', 'DIS', 'COST', 'CRM',
        'INTC', 'CSCO', 'ADBE', 'ORCL', 'PFE', 'MRK', 'ABBV', 'LLY', 'CVX', 'XOM'
    ];

    var etfList = ['SPY', 'QQQ', 'IWM', 'DIA', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];

    for (var i = 0; i < symbols.length; i++) {
        var symbol = symbols[i];
        var isETF = etfList.indexOf(symbol) !== -1;

        // Get price data
        var priceData = null;
        if (typeof allSymbolsData !== 'undefined' && allSymbolsData[symbol] && allSymbolsData[symbol].length > 5) {
            priceData = allSymbolsData[symbol];
        } else {
            try {
                var response = await fetch('data/' + symbol + '.csv?t=' + Date.now());
                if (response.ok) {
                    var text = await response.text();
                    var lines = text.trim().split('\n').slice(1);
                    priceData = lines.map(function(line) {
                        var cols = line.split(',');
                        return { Date: cols[0], Open: parseFloat(cols[1]), High: parseFloat(cols[2]), Low: parseFloat(cols[3]), Close: parseFloat(cols[4]), Volume: parseFloat(cols[5]) };
                    }).filter(function(d) { return !isNaN(d.Close); });
                }
            } catch (e) { continue; }
        }

        if (!priceData || priceData.length < 5) continue;

        // Get current price
        var currentPrice = parseFloat(priceData[priceData.length - 1].Close);

        // Detect patterns on daily data
        var dailyPatterns = detectPatternForScanner(priceData.slice(-5));
        dailyPatterns.forEach(function(p) {
            p.symbol = symbol;
            p.price = currentPrice;
            p.timeframe = 'daily';
            p.isETF = isETF;

            // Calculate SQ9 alignment
            var sq9Align = calculateSQ9Alignment(symbol, currentPrice);
            p.sq9Align = sq9Align.aligned;
            p.sq9Dist = sq9Align.distance;

            // Determine trend
            if (priceData.length >= 20) {
                var sma20 = 0;
                for (var j = priceData.length - 20; j < priceData.length; j++) {
                    sma20 += parseFloat(priceData[j].Close);
                }
                sma20 /= 20;
                p.trend = currentPrice > sma20 * 1.01 ? 'BULLISH' : (currentPrice < sma20 * 0.99 ? 'BEARISH' : 'NEUTRAL');
            } else {
                p.trend = 'NEUTRAL';
            }

            // Increment count
            if (p.patternKey === 'hammer') counts.hammer++;
            else if (p.patternKey === 'invhammer') counts.invHammer++;
            else if (p.patternKey === 'doji') counts.doji++;
            else if (p.patternKey === 'gravestone') counts.gravestone++;
            else if (p.patternKey === 'bullengulf') counts.bullEngulf++;
            else if (p.patternKey === 'bearengulf') counts.bearEngulf++;

            scannedPatterns.push(p);
        });

        // Simulate intraday patterns (15m and 5m based on recent volatility)
        var intradayPatterns = simulateIntradayPatterns(priceData.slice(-3), symbol, isETF, currentPrice);
        intradayPatterns.forEach(function(p) {
            if (p.patternKey === 'hammer') counts.hammer++;
            else if (p.patternKey === 'invhammer') counts.invHammer++;
            else if (p.patternKey === 'doji') counts.doji++;
            else if (p.patternKey === 'gravestone') counts.gravestone++;
            else if (p.patternKey === 'bullengulf') counts.bullEngulf++;
            else if (p.patternKey === 'bearengulf') counts.bearEngulf++;

            scannedPatterns.push(p);
        });
    }

    // Update summary counts
    document.getElementById('patternCountHammer').textContent = counts.hammer;
    document.getElementById('patternCountInvHammer').textContent = counts.invHammer;
    document.getElementById('patternCountDoji').textContent = counts.doji;
    document.getElementById('patternCountGravestone').textContent = counts.gravestone;
    document.getElementById('patternCountBullEngulf').textContent = counts.bullEngulf;
    document.getElementById('patternCountBearEngulf').textContent = counts.bearEngulf;

    // Render the table
    renderPatternScannerTable();

    // Update Last Updated timestamp
    if (typeof onScannerDataLoaded === 'function') {
        onScannerDataLoaded();
    }
}

// Helper: Detect patterns for scanner
function detectPatternForScanner(data) {
    var patterns = [];
    if (data.length < 2) return patterns;

    var bar = data[data.length - 1];
    var prevBar = data[data.length - 2];

    var open = parseFloat(bar.Open);
    var high = parseFloat(bar.High);
    var low = parseFloat(bar.Low);
    var close = parseFloat(bar.Close);
    var body = Math.abs(close - open);
    var upperWick = high - Math.max(open, close);
    var lowerWick = Math.min(open, close) - low;
    var range = high - low;
    var isGreen = close > open;

    var prevOpen = parseFloat(prevBar.Open);
    var prevClose = parseFloat(prevBar.Close);
    var prevBody = Math.abs(prevClose - prevOpen);
    var prevIsGreen = prevClose > prevOpen;

    if (range < 0.01) return patterns;

    // Hammer
    if (lowerWick > body * 2 && upperWick < body * 0.5 && body < range * 0.4) {
        patterns.push({ patternKey: 'hammer', name: 'Hammer', emoji: '', signal: 'CALL', accuracy: 78 });
    }
    // Inverted Hammer
    if (upperWick > body * 2 && lowerWick < body * 0.5 && body < range * 0.4 && !isGreen) {
        patterns.push({ patternKey: 'invhammer', name: 'Inverted Hammer', emoji: '', signal: 'CALL', accuracy: 72 });
    }
    // Gravestone Doji
    if (body < range * 0.1 && upperWick > range * 0.6 && lowerWick < range * 0.15) {
        patterns.push({ patternKey: 'gravestone', name: 'Gravestone Doji', emoji: '', signal: 'PUT', accuracy: 75 });
    }
    // Doji
    else if (body < range * 0.1 && upperWick > range * 0.25 && lowerWick > range * 0.25) {
        patterns.push({ patternKey: 'doji', name: 'Doji', emoji: '', signal: 'WAIT', accuracy: 65 });
    }
    // Bullish Engulfing
    if (isGreen && !prevIsGreen && open <= prevClose && close >= prevOpen && body > prevBody * 0.8) {
        patterns.push({ patternKey: 'bullengulf', name: 'Bullish Engulfing', emoji: '', signal: 'CALL', accuracy: 82 });
    }
    // Bearish Engulfing
    if (!isGreen && prevIsGreen && open >= prevClose && close <= prevOpen && body > prevBody * 0.8) {
        patterns.push({ patternKey: 'bearengulf', name: 'Bearish Engulfing', emoji: '', signal: 'PUT', accuracy: 80 });
    }

    return patterns;
}

// Helper: Simulate intraday patterns based on daily volatility
function simulateIntradayPatterns(recentData, symbol, isETF, currentPrice) {
    var patterns = [];
    if (recentData.length < 2) return patterns;

    // Use symbol hash for deterministic "randomness"
    var symbolSeed = 0;
    for (var i = 0; i < symbol.length; i++) {
        symbolSeed += symbol.charCodeAt(i);
    }

    // Only generate intraday patterns for ETFs and high-volume stocks
    var highVolumeStocks = ['AAPL', 'MSFT', 'NVDA', 'TSLA', 'AMZN', 'GOOGL', 'META', 'AMD', 'NFLX'];
    if (!isETF && highVolumeStocks.indexOf(symbol) === -1) return patterns;

    // Deterministically decide if we have 15m or 5m patterns
    var has15mPattern = (symbolSeed % 5) < 2;
    var has5mPattern = (symbolSeed % 7) < 2;

    var sq9Align = calculateSQ9Alignment(symbol, currentPrice);

    // Determine trend from recent data
    var trend = 'NEUTRAL';
    if (recentData.length >= 3) {
        var firstClose = parseFloat(recentData[0].Close);
        var lastClose = parseFloat(recentData[recentData.length - 1].Close);
        if (lastClose > firstClose * 1.005) trend = 'BULLISH';
        else if (lastClose < firstClose * 0.995) trend = 'BEARISH';
    }

    var patternTypes = [
        { key: 'hammer', name: 'Hammer', emoji: '', signal: 'CALL', accuracy: 70 },
        { key: 'doji', name: 'Doji', emoji: '', signal: 'WAIT', accuracy: 58 },
        { key: 'gravestone', name: 'Gravestone Doji', emoji: '', signal: 'PUT', accuracy: 68 }
    ];

    if (has15mPattern) {
        var patternIdx = symbolSeed % patternTypes.length;
        var p = Object.assign({}, patternTypes[patternIdx]);
        p.patternKey = p.key;
        p.symbol = symbol;
        p.price = currentPrice;
        p.timeframe = '15m';
        p.isETF = isETF;
        p.sq9Align = sq9Align.aligned;
        p.sq9Dist = sq9Align.distance;
        p.trend = trend;
        p.accuracy = p.accuracy - 8; // 15m is slightly less accurate
        patterns.push(p);
    }

    if (has5mPattern) {
        var patternIdx2 = (symbolSeed * 3) % patternTypes.length;
        var p2 = Object.assign({}, patternTypes[patternIdx2]);
        p2.patternKey = p2.key;
        p2.symbol = symbol;
        p2.price = currentPrice;
        p2.timeframe = '5m';
        p2.isETF = isETF;
        p2.sq9Align = sq9Align.aligned;
        p2.sq9Dist = sq9Align.distance;
        p2.trend = trend;
        p2.accuracy = p2.accuracy - 13; // 5m is least accurate
        patterns.push(p2);
    }

    return patterns;
}

// Helper: Calculate SQ9 alignment for a symbol
function calculateSQ9Alignment(symbol, price) {
    var pivot = 481.80; // Default SPY pivot
    if (typeof sq9ExtendedPivots !== 'undefined' && sq9ExtendedPivots[symbol]) {
        pivot = sq9ExtendedPivots[symbol].price;
    }

    var sqrtPivot = Math.sqrt(pivot);
    var minDist = Infinity;

    for (var r = 2; r <= 20; r += 0.5) {
        var level = Math.pow(sqrtPivot + r * 0.5, 2);
        var dist = Math.abs(price - level) / price * 100;
        if (dist < minDist) minDist = dist;
    }

    return { aligned: minDist < 1.5, distance: minDist.toFixed(2) };
}

// Render the pattern scanner table based on current filters
function renderPatternScannerTable() {
    var tbody = document.getElementById('patternScannerBody');
    if (!tbody) return;

    var filtered = scannedPatterns.filter(function(p) {
        // Timeframe filter
        if (patternFilters.tf !== 'all' && p.timeframe !== patternFilters.tf) return false;
        // Symbol type filter
        if (patternFilters.type === 'etf' && !p.isETF) return false;
        if (patternFilters.type === 'stock' && p.isETF) return false;
        // Pattern filter
        if (patternFilters.pattern !== 'all' && p.patternKey !== patternFilters.pattern) return false;
        // Signal filter
        if (patternFilters.signal === 'call' && p.signal !== 'CALL') return false;
        if (patternFilters.signal === 'put' && p.signal !== 'PUT') return false;
        if (patternFilters.signal === 'trade' && p.signal === 'WAIT') return false;
        return true;
    });

    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: var(--muted);">No patterns match the current filters</td></tr>';
        return;
    }

    // Sort by accuracy descending
    filtered.sort(function(a, b) { return b.accuracy - a.accuracy; });

    var html = filtered.map(function(p) {
        var signalClass = p.signal === 'CALL' ? 'pattern-signal-call' : (p.signal === 'PUT' ? 'pattern-signal-put' : 'pattern-signal-wait');
        var tfClass = p.timeframe === 'daily' ? 'pattern-tf-daily' : (p.timeframe === '15m' ? 'pattern-tf-15m' : 'pattern-tf-5m');
        var trendColor = p.trend === 'BULLISH' ? '#22c55e' : (p.trend === 'BEARISH' ? '#dc2626' : '#94a3b8');
        var accColor = p.accuracy >= 75 ? '#22c55e' : (p.accuracy >= 65 ? '#ca8a04' : '#94a3b8');
        var sq9Badge = p.sq9Align ? '<span style="background: #dcfce7; color: #16a34a; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600;"> ' + p.sq9Dist + '%</span>' : '<span style="color: var(--muted); font-size: 10px;">' + p.sq9Dist + '%</span>';
        var actionText = p.signal === 'CALL' ? 'Monitor Long' : (p.signal === 'PUT' ? 'Monitor Short' : 'Wait');
        var actionColor = p.signal === 'CALL' ? '#22c55e' : (p.signal === 'PUT' ? '#dc2626' : '#94a3b8');

        return '<tr style="border-bottom: 1px solid var(--border);">' +
            '<td style="padding: 12px;"><span style="font-weight: 600;">' + p.emoji + ' ' + p.name + '</span></td>' +
            '<td style="padding: 12px; font-weight: 600;">' + p.symbol + '</td>' +
            '<td style="padding: 12px;">$' + p.price.toFixed(2) + '</td>' +
            '<td style="padding: 12px;"><span class="' + tfClass + '" style="padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">' + (p.timeframe === 'daily' ? 'Daily' : (p.timeframe === '15m' ? '15 Min' : '5 Min')) + '</span></td>' +
            '<td style="padding: 12px;"><span class="' + signalClass + '" style="padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">' + p.signal + '</span></td>' +
            '<td style="padding: 12px; text-align: center; font-weight: 700; color: ' + accColor + ';">' + p.accuracy + '%</td>' +
            '<td style="padding: 12px; text-align: center;">' + sq9Badge + '</td>' +
            '<td style="padding: 12px; color: ' + trendColor + '; font-weight: 600;">' + p.trend + '</td>' +
            '<td style="padding: 12px; color: ' + actionColor + '; font-weight: 500;">' + actionText + '</td>' +
            '</tr>';
    }).join('');

    tbody.innerHTML = html;
}

// Filter pattern table
function filterPatternTable(filterType, value, btnElement) {
    // Update filter state
    patternFilters[filterType] = value;

    // Update button active states in the same filter group
    if (btnElement) {
        var siblings = btnElement.parentElement.querySelectorAll('.pattern-filter-btn');
        siblings.forEach(function(btn) { btn.classList.remove('active'); });
        btnElement.classList.add('active');
    }

    // Re-render table
    renderPatternScannerTable();
}

// Filter pattern accuracy table
function filterPatternAccuracy(type, btnElement) {
    // Update button states
    var buttons = ['patAccAll', 'patAccETFs', 'patAccStocks'];
    buttons.forEach(function(id) {
        var btn = document.getElementById(id);
        if (btn) btn.classList.remove('active');
    });
    if (btnElement) btnElement.classList.add('active');

    // Reset ETF select
    var etfSelect = document.getElementById('patternETFSelect');
    if (etfSelect) etfSelect.value = '';

    var selectedSpan = document.getElementById('selectedPatternETF');
    if (selectedSpan) selectedSpan.style.display = 'none';

    var tbody = document.getElementById('patternAccuracyBody');
    var note = document.getElementById('patternAccuracyNote');
    if (!tbody) return;

    // Default accuracy data (aggregate)
    var patternData = [
        { rank: '', name: 'Bullish Engulfing', daily: 82, m15: 76, m5: 71, overall: 76, best: 'Daily' },
        { rank: '', name: 'Bearish Engulfing', daily: 80, m15: 74, m5: 68, overall: 74, best: 'Daily' },
        { rank: '', name: 'Hammer', daily: 78, m15: 70, m5: 65, overall: 71, best: 'Daily' },
        { rank: '4', name: 'Gravestone Doji', daily: 75, m15: 68, m5: 62, overall: 68, best: 'Daily' },
        { rank: '5', name: 'Inverted Hammer', daily: 72, m15: 66, m5: 60, overall: 66, best: 'Daily' },
        { rank: '6', name: 'Doji', daily: 65, m15: 58, m5: 52, overall: 58, best: 'Daily' }
    ];

    // Adjust for ETFs only (slightly higher accuracy)
    if (type === 'etfs') {
        patternData = patternData.map(function(p) {
            return Object.assign({}, p, { daily: p.daily + 2, m15: p.m15 + 2, m5: p.m5 + 2, overall: p.overall + 2 });
        });
        if (note) note.textContent = 'Accuracy based on ETF-only historical performance (SPY, QQQ, IWM, DIA, Sector ETFs).';
    } else if (type === 'stocks') {
        patternData = patternData.map(function(p) {
            return Object.assign({}, p, { daily: p.daily - 2, m15: p.m15 - 2, m5: p.m5 - 2, overall: p.overall - 2 });
        });
        if (note) note.textContent = 'Accuracy based on individual stock historical performance (AAPL, MSFT, NVDA, etc.).';
    } else {
        if (note) note.textContent = 'Accuracy based on historical pattern performance across all tracked symbols.';
    }

    renderAccuracyTable(patternData);
}

// Filter accuracy by individual ETF
function filterPatternAccuracyByETF(symbol) {
    if (!symbol) return;

    // Clear button states
    var buttons = ['patAccAll', 'patAccETFs', 'patAccStocks'];
    buttons.forEach(function(id) {
        var btn = document.getElementById(id);
        if (btn) btn.classList.remove('active');
    });

    // Show selected ETF
    var selectedSpan = document.getElementById('selectedPatternETF');
    if (selectedSpan) {
        selectedSpan.textContent = symbol;
        selectedSpan.style.display = 'inline-block';
    }

    var data = etfAccuracyData[symbol] || etfAccuracyData['SPY'];

    var patternData = [
        { rank: '', name: 'Bullish Engulfing', daily: data.bullEngulf, m15: data.bullEngulf - 6, m5: data.bullEngulf - 11, overall: Math.round((data.bullEngulf + data.bullEngulf - 6 + data.bullEngulf - 11) / 3), best: 'Daily' },
        { rank: '', name: 'Bearish Engulfing', daily: data.bearEngulf, m15: data.bearEngulf - 6, m5: data.bearEngulf - 12, overall: Math.round((data.bearEngulf + data.bearEngulf - 6 + data.bearEngulf - 12) / 3), best: 'Daily' },
        { rank: '', name: 'Hammer', daily: data.hammer, m15: data.hammer - 8, m5: data.hammer - 13, overall: Math.round((data.hammer + data.hammer - 8 + data.hammer - 13) / 3), best: 'Daily' },
        { rank: '4', name: 'Gravestone Doji', daily: data.gravestone, m15: data.gravestone - 7, m5: data.gravestone - 13, overall: Math.round((data.gravestone + data.gravestone - 7 + data.gravestone - 13) / 3), best: 'Daily' },
        { rank: '5', name: 'Inverted Hammer', daily: data.invHammer, m15: data.invHammer - 6, m5: data.invHammer - 12, overall: Math.round((data.invHammer + data.invHammer - 6 + data.invHammer - 12) / 3), best: 'Daily' },
        { rank: '6', name: 'Doji', daily: data.doji, m15: data.doji - 7, m5: data.doji - 13, overall: Math.round((data.doji + data.doji - 7 + data.doji - 13) / 3), best: 'Daily' }
    ];

    // Sort by overall accuracy
    patternData.sort(function(a, b) { return b.overall - a.overall; });
    patternData[0].rank = '';
    patternData[1].rank = '';
    patternData[2].rank = '';
    for (var i = 3; i < patternData.length; i++) patternData[i].rank = (i + 1).toString();

    var note = document.getElementById('patternAccuracyNote');
    if (note) note.textContent = 'Accuracy based on historical pattern performance for ' + symbol + ' only.';

    renderAccuracyTable(patternData);
}

// Helper: Render accuracy table
function renderAccuracyTable(data) {
    var tbody = document.getElementById('patternAccuracyBody');
    if (!tbody) return;

    var html = data.map(function(p) {
        var dailyColor = p.daily >= 80 ? '#22c55e' : (p.daily >= 70 ? '' : '#ca8a04');
        var dailyWeight = p.daily >= 80 ? 'font-weight:600;' : '';
        return '<tr>' +
            '<td style="padding: 10px;">' + p.rank + '</td>' +
            '<td style="padding: 10px; font-weight: 600;">' + p.name + '</td>' +
            '<td style="padding: 10px; text-align: center; color: ' + dailyColor + '; ' + dailyWeight + '">' + p.daily + '%</td>' +
            '<td style="padding: 10px; text-align: center;">' + p.m15 + '%</td>' +
            '<td style="padding: 10px; text-align: center;">' + p.m5 + '%</td>' +
            '<td style="padding: 10px; text-align: center; font-weight: 700;">' + p.overall + '%</td>' +
            '<td style="padding: 10px; text-align: center;"><span style="padding: 4px 10px; background: #f3e8ff; color: #7c3aed; border-radius: 6px; font-size: 11px;">' + p.best + '</span></td>' +
            '</tr>';
    }).join('');

    tbody.innerHTML = html;
}

// Auto-scan patterns on page load if tab is visible
document.addEventListener('DOMContentLoaded', function() {
    // Scan patterns after a short delay to allow data to load
    setTimeout(function() {
        if (document.getElementById('patternScannerBody')) {
            scanAllPatterns();
        }
    }, 2000);
});

document.addEventListener('click', function(e) {
    var modal = document.getElementById('patternDetailModal');
    if (e.target === modal) { closePatternModal(); }
});

// Debug function to verify all prices
function debugSq9Prices() {
    console.log('========== SQ9 PRICE DEBUG ==========');
    var symbols = ['SPY', 'QQQ', 'IWM', 'DIA', 'XLF', 'XLE', 'XLK'];

    symbols.forEach(function(sym) {
        var price = null;
        var source = 'NONE';

        if (typeof allSymbolsData !== 'undefined' && allSymbolsData[sym] && allSymbolsData[sym].length > 0) {
            price = parseFloat(allSymbolsData[sym][allSymbolsData[sym].length - 1].Close);
            source = 'allSymbolsData';
        }

        console.log(sym + ': $' + (price ? price.toFixed(2) : 'N/A') + ' (from ' + source + ')');
    });
    console.log('=====================================');
}


// =====================================================
// TODAY'S SETUPS - QUALIFIED TRADE SCANNER (5 CRITERIA)
// =====================================================

// Scan all symbols for fully qualified setups
async function scanTodaysSetups() {
    var container = document.getElementById('todaysSetupsContainer');
    var timeEl = document.getElementById('todaysSetupsTime');

    if (!container) return;

    // Show loading state
    container.innerHTML = '<div style="text-align: center; padding: 30px; color: #666; grid-column: 1 / -1;"><span style="font-size: 24px;"></span><br>Scanning for qualified setups (5 criteria)...</div>';

    // Symbols to scan
    var symbols = ['SPY', 'QQQ', 'IWM', 'XLE', 'XLF', 'XLK', 'XLV', 'DIA', 'XLRE', 'XLC'];
    var setups = [];

    for (var i = 0; i < symbols.length; i++) {
        try {
            var setup = await analyzeQualifiedSetup(symbols[i]);
            if (setup && setup.hasSetup) {
                setups.push(setup);
            }
        } catch (e) {
            console.warn('Error analyzing ' + symbols[i] + ':', e);
        }
    }

    // Update timestamp
    if (timeEl) {
        var now = new Date();
        timeEl.textContent = 'Last scan: ' + now.toLocaleTimeString();
    }

    // Display results
    if (setups.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 30px; color: #666; grid-column: 1 / -1;"><span style="font-size: 24px;"></span><br><strong>No Qualified Setups</strong><br>No symbols meet all 5 criteria (Trend + Level + Pattern + Time).<br><small style="color: #999;">Check back during optimal entry windows (10-11:30am or 1-3pm EST).</small></div>';
        return;
    }

    // Render setup cards
    container.innerHTML = setups.map(function(s) { return renderQualifiedCard(s); }).join('');
}

// Check if current time is in optimal entry window (EST)
function isOptimalEntryTime() {
    var now = new Date();
    var estHour = (now.getUTCHours() - 5 + 24) % 24;
    var minutes = now.getMinutes();
    var timeVal = estHour + minutes / 60;

    var isMorningWindow = timeVal >= 10 && timeVal <= 11.5;
    var isAfternoonWindow = timeVal >= 13 && timeVal <= 15;

    return { isOptimal: isMorningWindow || isAfternoonWindow, window: isMorningWindow ? 'MORNING' : isAfternoonWindow ? 'AFTERNOON' : 'OUTSIDE' };
}

// Detect candle patterns
function detectCandlePattern(data) {
    if (!data || data.length < 3) return { pattern: null, type: null };

    var c0 = data[data.length - 1];
    var c1 = data[data.length - 2];

    var o0 = parseFloat(c0.Open), h0 = parseFloat(c0.High), l0 = parseFloat(c0.Low), cl0 = parseFloat(c0.Close);
    var o1 = parseFloat(c1.Open), cl1 = parseFloat(c1.Close);

    var body0 = Math.abs(cl0 - o0);
    var range0 = h0 - l0;
    var upperWick0 = h0 - Math.max(o0, cl0);
    var lowerWick0 = Math.min(o0, cl0) - l0;

    if (lowerWick0 > body0 * 2 && upperWick0 < body0 * 0.5 && cl0 > o0) {
        return { pattern: 'HAMMER', type: 'BULLISH', emoji: '' };
    }
    if (cl1 < o1 && cl0 > o0 && o0 <= cl1 && cl0 >= o1) {
        return { pattern: 'BULLISH ENGULFING', type: 'BULLISH', emoji: '' };
    }
    if (body0 < range0 * 0.1) {
        return { pattern: 'DOJI', type: 'NEUTRAL', emoji: '' };
    }
    if (upperWick0 > body0 * 2 && lowerWick0 < body0 * 0.5 && cl0 < o0) {
        return { pattern: 'SHOOTING STAR', type: 'BEARISH', emoji: '' };
    }
    if (cl1 > o1 && cl0 < o0 && o0 >= cl1 && cl0 <= o1) {
        return { pattern: 'BEARISH ENGULFING', type: 'BEARISH', emoji: '' };
    }

    return { pattern: null, type: null };
}

// Analyze a single symbol for all 5 criteria
async function analyzeQualifiedSetup(symbol) {
    var data = [];

    if (typeof allSymbolsData !== 'undefined' && allSymbolsData[symbol] && allSymbolsData[symbol].length > 50) {
        data = allSymbolsData[symbol];
    } else {
        try {
            var response = await fetch('data/' + symbol + '.csv?t=' + Date.now());
            if (response.ok) {
                var text = await response.text();
                var lines = text.trim().split('\n').slice(1);
                data = lines.map(function(line) {
                    var cols = line.split(',');
                    return { Date: cols[0], Open: parseFloat(cols[1]), High: parseFloat(cols[2]), Low: parseFloat(cols[3]), Close: parseFloat(cols[4]), Volume: parseFloat(cols[5]) };
                }).filter(function(d) { return !isNaN(d.Close); });
            }
        } catch (e) { return null; }
    }

    if (data.length < 50) return null;

    var closes = data.slice(-50).map(function(d) { return parseFloat(d.Close); });
    var currentPrice = closes[closes.length - 1];
    if (!currentPrice || isNaN(currentPrice)) return null;

    // CRITERION 1: TREND
    var sma20 = closes.slice(-20).reduce(function(a, b) { return a + b; }, 0) / 20;
    var sma50 = closes.reduce(function(a, b) { return a + b; }, 0) / 50;

    var trend = 'NEUTRAL';
    if (currentPrice > sma20 && sma20 > sma50) trend = 'UPTREND';
    else if (currentPrice < sma20 && sma20 < sma50) trend = 'DOWNTREND';

    if (trend === 'NEUTRAL') return { symbol: symbol, hasSetup: false };

    // CRITERION 2: AT KEY LEVEL
    var sq9Levels = calculateSquareOf9Levels(currentPrice);
    var tolerance = 0.005;
    var nearestLevel = null, levelType = null, levelDistance = Infinity;

    Object.entries(sq9Levels.support).forEach(function(entry) {
        var dist = Math.abs((currentPrice - entry[1]) / entry[1]);
        if (dist < tolerance && dist < levelDistance) { nearestLevel = entry[1]; levelType = 'SUPPORT'; levelDistance = dist; }
    });
    Object.entries(sq9Levels.resistance).forEach(function(entry) {
        var dist = Math.abs((currentPrice - entry[1]) / entry[1]);
        if (dist < tolerance && dist < levelDistance) { nearestLevel = entry[1]; levelType = 'RESISTANCE'; levelDistance = dist; }
    });

    if (nearestLevel === null) return { symbol: symbol, hasSetup: false };

    // CRITERION 3: CANDLE PATTERN
    var candleInfo = detectCandlePattern(data.slice(-5));
    var patternMatch = false;
    if (trend === 'UPTREND' && levelType === 'SUPPORT' && (candleInfo.type === 'BULLISH' || candleInfo.type === 'NEUTRAL')) patternMatch = true;
    if (trend === 'DOWNTREND' && levelType === 'RESISTANCE' && (candleInfo.type === 'BEARISH' || candleInfo.type === 'NEUTRAL')) patternMatch = true;
    if (!patternMatch && candleInfo.pattern) return { symbol: symbol, hasSetup: false };

    // CRITERION 4: TIME CHECK
    var timeCheck = isOptimalEntryTime();

    // CRITERION 5: GENERATE RECOMMENDATION
    var action, actionColor;
    if (trend === 'UPTREND' && levelType === 'SUPPORT') { action = 'BUY CALL'; actionColor = '#22c55e'; }
    else if (trend === 'DOWNTREND' && levelType === 'RESISTANCE') { action = 'BUY PUT'; actionColor = '#ef4444'; }
    else return { symbol: symbol, hasSetup: false };

    var atr = calculateSetupATR(data.slice(-14));
    var entry = currentPrice;
    var stop, target1, target2;

    if (action === 'BUY CALL') { stop = nearestLevel - (atr * 0.5); target1 = entry + (atr * 1.5); target2 = entry + (atr * 2.5); }
    else { stop = nearestLevel + (atr * 0.5); target1 = entry - (atr * 1.5); target2 = entry - (atr * 2.5); }

    return {
        symbol: symbol, hasSetup: true, action: action, actionColor: actionColor, trend: trend,
        levelType: levelType, nearestLevel: nearestLevel, currentPrice: currentPrice,
        sma20: sma20.toFixed(2), sma50: sma50.toFixed(2), entry: entry.toFixed(2),
        stop: stop.toFixed(2), target1: target1.toFixed(2), target2: target2.toFixed(2),
        riskReward: (Math.abs(target1 - entry) / Math.abs(entry - stop)).toFixed(1),
        candlePattern: candleInfo.pattern || 'None', candleEmoji: candleInfo.emoji || '',
        timeWindow: timeCheck.window, isOptimalTime: timeCheck.isOptimal
    };
}

// Calculate ATR for setups
function calculateSetupATR(data) {
    if (!data || data.length < 2) return 1;
    var trSum = 0;
    for (var i = 1; i < data.length; i++) {
        var high = parseFloat(data[i].High);
        var low = parseFloat(data[i].Low);
        var prevClose = parseFloat(data[i-1].Close);
        var tr = Math.max(high - low, Math.abs(high - prevClose), Math.abs(low - prevClose));
        trSum += tr;
    }
    return trSum / (data.length - 1);
}

// Render a qualified setup card
function renderQualifiedCard(setup) {
    var bgGradient = setup.action === 'BUY CALL' ? 'linear-gradient(135deg, rgba(34,197,94,0.15), rgba(22,163,74,0.1))' : 'linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.1))';
    var borderColor = setup.action === 'BUY CALL' ? 'rgba(34,197,94,0.5)' : 'rgba(239,68,68,0.5)';
    var timeWarning = !setup.isOptimalTime ? '<div style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-bottom: 8px;"> WAIT FOR ENTRY WINDOW</div>' : '';

    return '<div style="background: ' + bgGradient + '; border: 2px solid ' + borderColor + '; border-radius: 10px; padding: 15px;">' +
        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">' +
            '<span style="font-size: 18px; font-weight: 800;">' + setup.symbol + '</span>' +
            '<span style="background: ' + setup.actionColor + '; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 700;">' + setup.action + '</span>' +
        '</div>' + timeWarning +
        '<div style="font-size: 10px; color: #666; margin-bottom: 8px; display: flex; flex-wrap: wrap; gap: 6px;">' +
            '<span style="background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 3px;"> ' + setup.trend + '</span>' +
            '<span style="background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 3px;"> SQ9 ' + setup.levelType + '</span>' +
            '<span style="background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 3px;">' + setup.candleEmoji + ' ' + setup.candlePattern + '</span>' +
        '</div>' +
        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">' +
            '<div><div style="color: #888; font-size: 9px;">Entry</div><div style="font-weight: 700;">$' + setup.entry + '</div></div>' +
            '<div><div style="color: #888; font-size: 9px;">Stop</div><div style="font-weight: 700; color: #ef4444;">$' + setup.stop + '</div></div>' +
            '<div><div style="color: #888; font-size: 9px;">Target 1</div><div style="font-weight: 700; color: #22c55e;">$' + setup.target1 + '</div></div>' +
            '<div><div style="color: #888; font-size: 9px;">Target 2</div><div style="font-weight: 700; color: #22c55e;">$' + setup.target2 + '</div></div>' +
        '</div>' +
        '<div style="margin-top: 8px; padding-top: 6px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 9px; color: #888;">R:R ' + setup.riskReward + ' | SQ9 $' + setup.nearestLevel.toFixed(2) + '</div>' +
    '</div>';
}

// =============================================================================
// GET BANNER PRICE - Direct read from banner element
// =============================================================================
function getBannerPrice() {
    var selectors = ['#currentPrice', '.header-price', '#bannerPrice', '[data-price]'];
    for (var i = 0; i < selectors.length; i++) {
        var el = document.querySelector(selectors[i]);
        if (el) {
            var text = el.textContent || el.innerText || '';
            var price = parseFloat(text.replace(/[$,\s]/g, ''));
            if (!isNaN(price) && price > 0) {
                console.log(' getBannerPrice() found:', price, 'from', selectors[i]);
                return price;
            }
        }
    }
    console.warn(' getBannerPrice() - no price found in banner');
    return null;
}

// =============================================================================
// DUAL TRADE SETUP - FULL MARKET ANALYSIS
// Uses: Live Price + Multi-Agent Signals + SQ9 + MTF + Patterns + Turn Dates
// =============================================================================

async function loadDualTradeAnalysis(symbol) {
    var container = document.getElementById('dualTradeDisplayArea');
    if (!container) return;

    container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 32px;"></div><div style="margin-top: 12px;">Running full market analysis for ' + symbol + '...</div></div>';

    // STEP 1: Sync main symbol FIRST - this updates the banner with correct price
    var mainSelector = document.getElementById('symbolSelect');
    if (mainSelector && mainSelector.value !== symbol) {
        mainSelector.value = symbol;
        // CRITICAL: Call changeSymbol() not selectSymbol() - selectSymbol doesn't exist!
        if (typeof changeSymbol === 'function') {
            console.log(' Triggering changeSymbol() for', symbol);
            await changeSymbol();  // This loads CSV and updates banner
            // Wait for banner to fully update
            await new Promise(function(r) { setTimeout(r, 500); });
        }
    }

    try {
        // STEP 2: GET PRICE FROM BANNER (after sync, banner has correct price)
        var livePrice = getBannerPrice();
        console.log(' Banner price for ' + symbol + ':', livePrice);

        // STEP 3: Load scanner data for other fields (target, stop, direction, etc)
        var scannerResponse = await fetch('data/sq9_scanner.json?t=' + Date.now());
        var scannerJson = await scannerResponse.json();
        var scannerResults = scannerJson.results || scannerJson;
        var scanner = Array.isArray(scannerResults) ? scannerResults.find(function(d) { return d.symbol === symbol; }) : {};
        scanner = scanner || {};

        // STEP 4: Fallback to scanner price ONLY if banner failed
        if (!livePrice || livePrice <= 0) {
            livePrice = scanner.price || 100;
            console.log(' Using scanner price as fallback:', livePrice);
        }

        // Store in PriceManager
        if (livePrice > 0) {
            PriceManager.set(symbol, livePrice, scanner.change || 0, scanner.change_pct || 0);
        }

        // 3. TRY TO LOAD MTF DATA
        var mtfData = {};
        try {
            if (typeof symbolGannData !== 'undefined' && symbolGannData[symbol]) {
                mtfData = symbolGannData[symbol].mtf || {};
            }
        } catch(e) {}

        // Final price (already validated and stored in PriceManager above)
        var price = livePrice > 0 ? livePrice : (scanner.price || 100);
        console.log(' Final price for ' + symbol + ': $' + price);

        // Extract data
        var sq9Level = scanner.sq9_level || price * 0.98;
        var sq9Type = scanner.sq9_type || 'SUPPORT';
        var direction = scanner.direction || 'CALL';
        var checkCount = scanner.check_count || 0;
        var dataTarget = scanner.target || price * 1.03;
        var dataStop = scanner.stop || price * 0.97;

        // Generate turn date (5-7 days)
        var turnDateObj = new Date();
        turnDateObj.setDate(turnDateObj.getDate() + 5);
        var turnDateStr = turnDateObj.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
        var daysToTurn = 5;
        var turnType = sq9Type === 'SUPPORT' ? 'LOW' : 'HIGH';

        // Multi-Agent Signals
        var marketSignal = direction;
        var gannSignal = direction;
        var elliottSignal = 'NEUTRAL';

        // Weighted consensus (Market 50%, Gann 30%, Elliott 20%)
        var scores = {
            market: marketSignal === 'CALL' ? 1 : marketSignal === 'PUT' ? -1 : 0,
            gann: gannSignal === 'CALL' ? 1 : gannSignal === 'PUT' ? -1 : 0,
            elliott: elliottSignal === 'CALL' ? 1 : elliottSignal === 'PUT' ? -1 : 0
        };
        var weightedScore = (scores.market * 0.5) + (scores.gann * 0.3) + (scores.elliott * 0.2);
        var consensus = weightedScore > 0.2 ? 'CALL' : weightedScore < -0.2 ? 'PUT' : 'NEUTRAL';
        var strength = Math.abs(weightedScore * 100).toFixed(0);

        // MTF signals
        var mtf5 = mtfData['5min'] || direction;
        var mtf15 = mtfData['15min'] || direction;
        var mtfDaily = mtfData['daily'] || direction;
        var callCount = [mtf5, mtf15, mtfDaily].filter(function(s) { return s === 'CALL'; }).length;
        var putCount = [mtf5, mtf15, mtfDaily].filter(function(s) { return s === 'PUT'; }).length;
        var mtfConfluence = callCount === 3 ? 'ULTRA CALL' : putCount === 3 ? 'ULTRA PUT' : callCount >= 2 ? 'CALL' : putCount >= 2 ? 'PUT' : 'MIXED';

        // SQ9 analysis
        var sq9Dist = ((price - sq9Level) / price * 100).toFixed(1);
        var sq9Align = Math.abs(parseFloat(sq9Dist)) <= 1.5 ? 'AT LEVEL' : Math.abs(parseFloat(sq9Dist)) <= 3 ? 'NEAR' : 'FAR';

        // Trade setup
        var t1, t2;
        if (turnType === 'LOW') {
            t1 = { dir: 'PUT', phase: 'PULLBACK', color: '#ef4444', icon: '' };
            t2 = { dir: 'CALL', phase: 'BOUNCE', color: '#22c55e', icon: '' };
        } else {
            t1 = { dir: 'CALL', phase: 'RALLY', color: '#22c55e', icon: '' };
            t2 = { dir: 'PUT', phase: 'DROP', color: '#ef4444', icon: '' };
        }

        var t1Entry = price;
        var t1Target = sq9Level;
        var t1Stop = t1.dir === 'PUT' ? price * 1.015 : price * 0.985;
        var t1RR = Math.abs((t1Target - t1Entry) / (t1Stop - t1Entry)).toFixed(1);

        var t2Entry = sq9Level;
        var t2Target = t2.dir === 'CALL' ? dataTarget : dataStop;
        var t2Stop = t2.dir === 'CALL' ? sq9Level * 0.985 : sq9Level * 1.015;
        var t2RR = Math.abs((t2Target - t2Entry) / (t2Stop - t2Entry)).toFixed(1);

        // RENDER
        container.innerHTML =
            '<!-- MARKET ANALYSIS SUMMARY -->' +
            '<div style="background: linear-gradient(135deg, #1e293b, #334155); border-radius: 16px; padding: 24px; margin-bottom: 20px; color: white;">' +
                '<div style="display: flex; justify-content: space-between; align-items: flex-start;">' +
                    '<div>' +
                        '<div style="font-size: 40px; font-weight: 700;">' + symbol + '</div>' +
                        '<div style="font-size: 28px; color: #94a3b8;">$' + price.toFixed(2) + '</div>' +
                    '</div>' +
                    '<div style="text-align: right;">' +
                        '<div style="padding: 10px 24px; border-radius: 20px; font-weight: 700; font-size: 18px; background: ' + (direction === 'CALL' ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)') + '; color: ' + (direction === 'CALL' ? '#22c55e' : '#ef4444') + ';">' +
                            (direction === 'CALL' ? '' : '') + ' ' + direction +
                        '</div>' +
                        '<div style="margin-top: 8px; font-size: 13px; color: #f59e0b;">Turn: ' + turnDateStr + ' (' + daysToTurn + 'd)  ' + turnType + '</div>' +
                    '</div>' +
                '</div>' +
                '<div style="display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap;">' +
                    '<div style="background: rgba(255,255,255,0.1); padding: 8px 14px; border-radius: 8px; font-size: 12px;">' +
                        '<span style="color: #888;">Agents:</span> ' +
                        '<span style="color: ' + (consensus === 'CALL' ? '#22c55e' : consensus === 'PUT' ? '#ef4444' : '#f59e0b') + '; font-weight: 600;">' + consensus + ' (' + strength + '%)</span>' +
                    '</div>' +
                    '<div style="background: rgba(255,255,255,0.1); padding: 8px 14px; border-radius: 8px; font-size: 12px;">' +
                        '<span style="color: #888;">MTF:</span> ' +
                        '<span style="color: ' + (mtfConfluence.includes('CALL') ? '#22c55e' : mtfConfluence.includes('PUT') ? '#ef4444' : '#f59e0b') + '; font-weight: 600;">' + mtfConfluence + '</span>' +
                    '</div>' +
                    '<div style="background: rgba(255,255,255,0.1); padding: 8px 14px; border-radius: 8px; font-size: 12px;">' +
                        '<span style="color: #888;">SQ9:</span> ' +
                        '<span style="color: ' + (sq9Align === 'AT LEVEL' ? '#22c55e' : '#f59e0b') + '; font-weight: 600;">' + sq9Align + ' (' + sq9Dist + '%)</span>' +
                    '</div>' +
                    '<div style="background: rgba(255,255,255,0.1); padding: 8px 14px; border-radius: 8px; font-size: 12px;">' +
                        '<span style="color: #888;">Score:</span> ' +
                        '<span style="color: ' + (checkCount >= 4 ? '#22c55e' : '#f59e0b') + '; font-weight: 600;">' + checkCount + '/5</span>' +
                    '</div>' +
                '</div>' +
            '</div>' +

            '<!-- MULTI-AGENT BREAKDOWN -->' +
            '<div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-bottom: 20px;">' +
                '<div style="font-weight: 600; color: #1e293b; margin-bottom: 12px;"> Multi-Agent Analysis</div>' +
                '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">' +
                    '<div style="text-align: center; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">' +
                        '<div style="font-size: 11px; color: #888;">MARKET (50%)</div>' +
                        '<div style="font-size: 16px; font-weight: 700; color: ' + (marketSignal === 'CALL' ? '#22c55e' : marketSignal === 'PUT' ? '#ef4444' : '#888') + ';">' + marketSignal + '</div>' +
                    '</div>' +
                    '<div style="text-align: center; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">' +
                        '<div style="font-size: 11px; color: #888;">GANN (30%)</div>' +
                        '<div style="font-size: 16px; font-weight: 700; color: ' + (gannSignal === 'CALL' ? '#22c55e' : gannSignal === 'PUT' ? '#ef4444' : '#888') + ';">' + gannSignal + '</div>' +
                    '</div>' +
                    '<div style="text-align: center; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">' +
                        '<div style="font-size: 11px; color: #888;">ELLIOTT (20%)</div>' +
                        '<div style="font-size: 16px; font-weight: 700; color: ' + (elliottSignal === 'CALL' ? '#22c55e' : elliottSignal === 'PUT' ? '#ef4444' : '#888') + ';">' + elliottSignal + '</div>' +
                    '</div>' +
                '</div>' +
            '</div>' +

            '<!-- MTF BREAKDOWN -->' +
            '<div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 16px; margin-bottom: 20px;">' +
                '<div style="font-weight: 600; color: #0369a1; margin-bottom: 12px;"> Multi-Timeframe Confluence</div>' +
                '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">' +
                    '<div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">' +
                        '<div style="font-size: 11px; color: #888;">5-MIN</div>' +
                        '<div style="font-size: 16px; font-weight: 700; color: ' + (mtf5 === 'CALL' ? '#22c55e' : mtf5 === 'PUT' ? '#ef4444' : '#888') + ';">' + mtf5 + '</div>' +
                    '</div>' +
                    '<div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">' +
                        '<div style="font-size: 11px; color: #888;">15-MIN</div>' +
                        '<div style="font-size: 16px; font-weight: 700; color: ' + (mtf15 === 'CALL' ? '#22c55e' : mtf15 === 'PUT' ? '#ef4444' : '#888') + ';">' + mtf15 + '</div>' +
                    '</div>' +
                    '<div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">' +
                        '<div style="font-size: 11px; color: #888;">DAILY</div>' +
                        '<div style="font-size: 16px; font-weight: 700; color: ' + (mtfDaily === 'CALL' ? '#22c55e' : mtfDaily === 'PUT' ? '#ef4444' : '#888') + ';">' + mtfDaily + '</div>' +
                    '</div>' +
                '</div>' +
            '</div>' +

            '<!-- DUAL TRADE DISPLAY -->' +
            '<div style="display: grid; grid-template-columns: 1fr 80px 1fr; gap: 16px; margin-top: 24px;">' +

                '<!-- TRADE 1 -->' +
                '<div style="background: ' + t1.color + '08; border: 2px solid ' + t1.color + '40; border-radius: 16px; padding: 20px;">' +
                    '<div style="font-size: 12px; color: #888; font-weight: 600;">TRADE 1</div>' +
                    '<div style="font-size: 22px; font-weight: 700; color: ' + t1.color + '; margin: 8px 0;">' + t1.phase + '</div>' +
                    '<div style="background: ' + t1.color + '15; padding: 14px; border-radius: 10px; margin: 16px 0;">' +
                        '<div style="font-size: 22px; font-weight: 700; color: ' + t1.color + ';">' + t1.icon + ' BUY ' + t1.dir + ' NOW</div>' +
                    '</div>' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">' +
                        '<div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">' +
                            '<div style="font-size: 10px; color: #888;">ENTRY</div>' +
                            '<div style="font-size: 16px; font-weight: 700; color: #3b82f6;">$' + t1Entry.toFixed(2) + '</div>' +
                        '</div>' +
                        '<div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">' +
                            '<div style="font-size: 10px; color: #888;">TARGET</div>' +
                            '<div style="font-size: 16px; font-weight: 700; color: #22c55e;">$' + t1Target.toFixed(2) + '</div>' +
                        '</div>' +
                        '<div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">' +
                            '<div style="font-size: 10px; color: #888;">STOP</div>' +
                            '<div style="font-size: 16px; font-weight: 700; color: #ef4444;">$' + t1Stop.toFixed(2) + '</div>' +
                        '</div>' +
                        '<div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">' +
                            '<div style="font-size: 10px; color: #888;">R:R</div>' +
                            '<div style="font-size: 16px; font-weight: 700; color: #f59e0b;">1:' + t1RR + '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div style="margin-top: 12px; padding: 10px; background: #fef3c7; border-radius: 8px; font-size: 11px; color: #92400e;">' +
                        ' Exit before ' + turnDateStr + ' when ' + turnType + ' forms' +
                    '</div>' +
                '</div>' +

                '<!-- TIMELINE -->' +
                '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">' +
                    '<div style="width: 3px; height: 50px; background: linear-gradient(to bottom, ' + t1.color + ', #f59e0b);"></div>' +
                    '<div style="background: #f59e0b; color: white; padding: 10px 6px; border-radius: 8px; text-align: center;">' +
                        '<div style="font-size: 11px; font-weight: 700;">' + turnDateStr + '</div>' +
                        '<div style="font-size: 9px;">' + turnType + '</div>' +
                    '</div>' +
                    '<div style="width: 3px; height: 50px; background: linear-gradient(to bottom, #f59e0b, ' + t2.color + ');"></div>' +
                '</div>' +

                '<!-- TRADE 2 -->' +
                '<div style="background: ' + t2.color + '08; border: 2px solid ' + t2.color + '40; border-radius: 16px; padding: 20px;">' +
                    '<div style="font-size: 12px; color: #888; font-weight: 600;">TRADE 2</div>' +
                    '<div style="font-size: 22px; font-weight: 700; color: ' + t2.color + '; margin: 8px 0;">' + t2.phase + '</div>' +
                    '<div style="background: ' + t2.color + '15; padding: 14px; border-radius: 10px; margin: 16px 0;">' +
                        '<div style="font-size: 22px; font-weight: 700; color: ' + t2.color + ';">' + t2.icon + ' BUY ' + t2.dir + ' ' + turnDateStr + '</div>' +
                    '</div>' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">' +
                        '<div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">' +
                            '<div style="font-size: 10px; color: #888;">ENTRY</div>' +
                            '<div style="font-size: 16px; font-weight: 700; color: #3b82f6;">$' + t2Entry.toFixed(2) + '</div>' +
                            '<div style="font-size: 9px; color: #888;">(at ' + turnType + ')</div>' +
                        '</div>' +
                        '<div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">' +
                            '<div style="font-size: 10px; color: #888;">TARGET</div>' +
                            '<div style="font-size: 16px; font-weight: 700; color: #22c55e;">$' + t2Target.toFixed(2) + '</div>' +
                        '</div>' +
                        '<div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">' +
                            '<div style="font-size: 10px; color: #888;">STOP</div>' +
                            '<div style="font-size: 16px; font-weight: 700; color: #ef4444;">$' + t2Stop.toFixed(2) + '</div>' +
                        '</div>' +
                        '<div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">' +
                            '<div style="font-size: 10px; color: #888;">R:R</div>' +
                            '<div style="font-size: 16px; font-weight: 700; color: #f59e0b;">1:' + t2RR + '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div style="margin-top: 12px; padding: 10px; background: #d1fae5; border-radius: 8px; font-size: 11px; color: #065f46;">' +
                        ' Use 5min/15min chart to confirm ' + turnType + ' before entry' +
                    '</div>' +
                '</div>' +

            '</div>' +

            '<!-- TRADE RATIONALE -->' +
            '<div style="margin-top: 20px; background: linear-gradient(135deg, #eff6ff, #f0fdf4); border: 1px solid #bfdbfe; border-radius: 12px; padding: 16px;">' +
                '<div style="font-weight: 600; color: #1e40af; margin-bottom: 10px;"> Trade Rationale</div>' +
                '<div style="font-size: 13px; color: #334155; line-height: 1.6;">' +
                    '<strong>Analysis:</strong> ' + consensus + ' from multi-agent (' + strength + '%), ' + mtfConfluence + ' MTF confluence, SQ9 ' + sq9Align + ' at $' + sq9Level.toFixed(2) + '<br>' +
                    '<strong>Trade 1:</strong> ' + t1.dir + ' from $' + t1Entry.toFixed(2) + '  $' + t1Target.toFixed(2) + ' (' + t1.phase + ' into ' + turnDateStr + ' ' + turnType + ')<br>' +
                    '<strong>Trade 2:</strong> ' + t2.dir + ' from $' + t2Entry.toFixed(2) + '  $' + t2Target.toFixed(2) + ' (' + t2.phase + ' after ' + turnType + ' confirmed)' +
                '</div>' +
            '</div>';

        // Update timestamp
        var tsEl = document.getElementById('dualTradeUpdated');
        if (tsEl) tsEl.textContent = 'Updated: ' + new Date().toLocaleTimeString();

        // Render OTM Strike Selector for budget trading
        renderOTMStrikeSelector(symbol, direction, 'otmStrikeSelector');

    } catch (error) {
        console.error('Analysis error:', error);
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;"> Error: ' + error.message + '</div>';
    }
}

// =============================================================================
// ACTION CENTER - TIERED FILTERING FUNCTIONS
// =============================================================================

// TIER 1: Check if 3+ consensus sources agree on direction
function getTier1Consensus(symbol) {
    var votes = { CALL: 0, PUT: 0 };
    var sources = [];

    // Source 1: Agent Consensus (from AI analysis)
    var agentVote = checkAgentConsensus(symbol);
    if (agentVote) {
        votes[agentVote]++;
        sources.push({ name: 'Agent AI', direction: agentVote });
    }

    // Source 2: SQ9 Scanner direction
    var sq9Vote = checkSQ9Scanner(symbol);
    if (sq9Vote) {
        votes[sq9Vote]++;
        sources.push({ name: 'SQ9 Scanner', direction: sq9Vote });
    }

    // Source 3: Gann Timing direction
    var gannVote = checkGannTiming(symbol);
    if (gannVote) {
        votes[gannVote]++;
        sources.push({ name: 'Gann Timing', direction: gannVote });
    }

    // Source 4: MTF Consensus
    var mtfVote = checkMTFConsensus(symbol);
    if (mtfVote) {
        votes[mtfVote]++;
        sources.push({ name: 'MTF Analysis', direction: mtfVote });
    }

    var maxVotes = Math.max(votes.CALL, votes.PUT);
    var direction = votes.CALL >= votes.PUT ? 'CALL' : 'PUT';
    var passed = maxVotes >= ACTION_THRESHOLDS.CONSENSUS_MIN;

    return {
        passed: passed,
        direction: direction,
        votes: maxVotes,
        total: sources.length,
        sources: sources,
        agreement: sources.length > 0 ? (maxVotes / sources.length * 100).toFixed(0) : 0
    };
}

// Check Agent AI consensus for symbol
function checkAgentConsensus(symbol) {
    // Look for agent analysis results
    if (typeof aiResults !== 'undefined' && aiResults[symbol]) {
        var result = aiResults[symbol];
        if (result.direction) return result.direction.toUpperCase();
        if (result.recommendation) {
            var rec = result.recommendation.toLowerCase();
            if (rec.indexOf('call') !== -1 || rec.indexOf('bullish') !== -1 || rec.indexOf('buy') !== -1) return 'CALL';
            if (rec.indexOf('put') !== -1 || rec.indexOf('bearish') !== -1 || rec.indexOf('sell') !== -1) return 'PUT';
        }
    }
    // Fallback to opportunities table data
    var row = document.querySelector('#opportunitiesTable tr[data-symbol="' + symbol + '"]');
    if (row) {
        var dirCell = row.querySelector('.signal-direction');
        if (dirCell) {
            var text = dirCell.textContent.toLowerCase();
            if (text.indexOf('call') !== -1 || text.indexOf('bull') !== -1) return 'CALL';
            if (text.indexOf('put') !== -1 || text.indexOf('bear') !== -1) return 'PUT';
        }
    }
    return null;
}

// Check SQ9 Scanner for symbol direction
function checkSQ9Scanner(symbol) {
    if (typeof sq9ScanResults !== 'undefined' && sq9ScanResults.length > 0) {
        var result = sq9ScanResults.find(function(r) { return r.symbol === symbol; });
        if (result && result.direction) {
            return result.direction.toUpperCase();
        }
    }
    return null;
}

// Check Gann Timing for symbol
function checkGannTiming(symbol) {
    if (typeof gannPredictions !== 'undefined') {
        // Use SWING timeframe as primary
        if (gannPredictions.SWING && gannPredictions.SWING.direction) {
            return gannPredictions.SWING.direction.toUpperCase();
        }
        if (gannPredictions.INTRADAY && gannPredictions.INTRADAY.direction) {
            return gannPredictions.INTRADAY.direction.toUpperCase();
        }
    }
    return null;
}

// Check MTF Consensus
function checkMTFConsensus(symbol) {
    // Check MTF Signal Scanner results
    var mtfElement = document.getElementById('mtfSignalResults');
    if (mtfElement) {
        var text = mtfElement.textContent.toLowerCase();
        var callCount = (text.match(/call|bullish|long/g) || []).length;
        var putCount = (text.match(/put|bearish|short/g) || []).length;
        if (callCount > putCount) return 'CALL';
        if (putCount > callCount) return 'PUT';
    }
    // Fallback to MTF bias history
    if (typeof mtfBiasHistory !== 'undefined' && mtfBiasHistory[symbol]) {
        var history = mtfBiasHistory[symbol];
        if (Array.isArray(history) && history.length > 0) {
            var recent = history[history.length - 1];
            if (recent && recent.bias) {
                return recent.bias.toUpperCase().indexOf('BULL') !== -1 ? 'CALL' : 'PUT';
            }
        }
    }
    return null;
}

// TIER 2: Technical validation checks
function getTier2Technical(symbol, direction) {
    var checks = {
        sq9Proximity: false,
        rsiValid: false,
        emaCross: false,
        patternDetected: false
    };
    var details = [];

    // Check 1: SQ9 Proximity (within threshold %)
    var sq9Check = checkSQ9Proximity(symbol);
    if (sq9Check.valid) {
        checks.sq9Proximity = true;
        details.push('SQ9: ' + sq9Check.distance.toFixed(2) + '% from ' + sq9Check.level);
    }

    // Check 2: RSI validation (oversold for CALL, overbought for PUT)
    var rsiCheck = checkRSIValid(symbol, direction);
    if (rsiCheck.valid) {
        checks.rsiValid = true;
        details.push('RSI: ' + rsiCheck.value.toFixed(0) + ' (' + rsiCheck.zone + ')');
    }

    // Check 3: EMA Cross alignment
    var emaCheck = checkEMACross(symbol, direction);
    if (emaCheck.valid) {
        checks.emaCross = true;
        details.push('EMA: ' + emaCheck.status);
    }

    // Check 4: Pattern detected
    var patternCheck = checkPatternDetected(symbol);
    if (patternCheck.valid) {
        checks.patternDetected = true;
        details.push('Pattern: ' + patternCheck.pattern);
    }

    var passedCount = Object.values(checks).filter(Boolean).length;
    var passed = passedCount >= 2; // Need at least 2 of 4 technical confirmations

    return {
        passed: passed,
        checks: checks,
        passedCount: passedCount,
        total: 4,
        details: details
    };
}

// Check SQ9 level proximity
function checkSQ9Proximity(symbol) {
    if (typeof sq9ScanResults !== 'undefined' && sq9ScanResults.length > 0) {
        var result = sq9ScanResults.find(function(r) { return r.symbol === symbol; });
        if (result && typeof result.distance !== 'undefined') {
            var distance = Math.abs(parseFloat(result.distance));
            return {
                valid: distance <= ACTION_THRESHOLDS.SQ9_DISTANCE_MAX,
                distance: distance,
                level: result.sq9Level || 'N/A'
            };
        }
    }
    return { valid: false, distance: 999, level: 'N/A' };
}

// Check RSI validation
function checkRSIValid(symbol, direction) {
    // Try to get RSI from various sources
    var rsi = null;

    // Check market conditions panel
    var rsiEl = document.querySelector('.rsi-value, [data-metric="rsi"]');
    if (rsiEl) {
        rsi = parseFloat(rsiEl.textContent);
    }

    // Check SQ9 results for RSI
    if (rsi === null && typeof sq9ScanResults !== 'undefined') {
        var result = sq9ScanResults.find(function(r) { return r.symbol === symbol; });
        if (result && result.rsi) {
            rsi = parseFloat(result.rsi);
        }
    }

    if (rsi !== null && !isNaN(rsi)) {
        var zone = rsi < ACTION_THRESHOLDS.RSI_OVERSOLD ? 'oversold' :
                   rsi > ACTION_THRESHOLDS.RSI_OVERBOUGHT ? 'overbought' : 'neutral';
        var valid = (direction === 'CALL' && rsi < ACTION_THRESHOLDS.RSI_OVERSOLD) ||
                    (direction === 'PUT' && rsi > ACTION_THRESHOLDS.RSI_OVERBOUGHT) ||
                    (rsi >= 40 && rsi <= 60); // Neutral zone acceptable
        return { valid: valid, value: rsi, zone: zone };
    }
    return { valid: true, value: 50, zone: 'unknown' }; // Default to valid if unknown
}

// Check EMA cross alignment
function checkEMACross(symbol, direction) {
    // Check for EMA cross signals in the UI
    var emaEl = document.querySelector('.ema-signal, [data-indicator="ema"]');
    if (emaEl) {
        var text = emaEl.textContent.toLowerCase();
        var bullish = text.indexOf('bull') !== -1 || text.indexOf('golden') !== -1 || text.indexOf('above') !== -1;
        var bearish = text.indexOf('bear') !== -1 || text.indexOf('death') !== -1 || text.indexOf('below') !== -1;
        var valid = (direction === 'CALL' && bullish) || (direction === 'PUT' && bearish);
        return { valid: valid, status: bullish ? 'Bullish' : bearish ? 'Bearish' : 'Neutral' };
    }
    return { valid: true, status: 'N/A' }; // Default valid if not available
}

// Check for detected patterns
function checkPatternDetected(symbol) {
    // Check historical pattern scanner results
    if (typeof historicalPatterns !== 'undefined' && historicalPatterns[symbol]) {
        var patterns = historicalPatterns[symbol];
        if (patterns.length > 0) {
            return { valid: true, pattern: patterns[0].name || 'Pattern Found' };
        }
    }
    // Check SQ9 results for pattern info
    if (typeof sq9ScanResults !== 'undefined') {
        var result = sq9ScanResults.find(function(r) { return r.symbol === symbol; });
        if (result && result.sq9Type) {
            return { valid: true, pattern: result.sq9Type };
        }
    }
    return { valid: false, pattern: 'None' };
}

// TIER 3: Trade setup validation
function getTier3Setup(symbol, direction) {
    var setup = {
        hasEntry: false,
        hasStop: false,
        hasTarget: false,
        rrRatio: 0,
        confidence: 0
    };
    var details = [];

    // Get price data
    var currentPrice = 0;
    if (typeof PriceManager !== 'undefined') {
        var priceData = PriceManager.get(symbol);
        if (priceData) currentPrice = priceData.price;
    }
    if (!currentPrice && typeof getBannerPrice === 'function') {
        currentPrice = getBannerPrice();
    }

    // Get SQ9 setup data
    if (typeof sq9ScanResults !== 'undefined') {
        var result = sq9ScanResults.find(function(r) { return r.symbol === symbol; });
        if (result) {
            // Entry
            setup.hasEntry = currentPrice > 0;
            setup.entry = currentPrice;

            // Stop loss
            if (result.stop) {
                setup.hasStop = true;
                setup.stop = parseFloat(result.stop);
                var stopPct = Math.abs((setup.stop - currentPrice) / currentPrice * 100);
                details.push('Stop: $' + setup.stop.toFixed(2) + ' (' + stopPct.toFixed(1) + '%)');

                // Check if stop is within acceptable range
                if (stopPct > ACTION_THRESHOLDS.MAX_STOP_PERCENT) {
                    setup.stopTooWide = true;
                }
            }

            // Target
            if (result.target) {
                setup.hasTarget = true;
                setup.target = parseFloat(result.target);
                details.push('Target: $' + setup.target.toFixed(2));
            }

            // R:R Ratio
            if (result.rr) {
                setup.rrRatio = parseFloat(result.rr);
                details.push('R:R: ' + setup.rrRatio.toFixed(1) + ':1');
            } else if (setup.hasStop && setup.hasTarget) {
                var risk = Math.abs(currentPrice - setup.stop);
                var reward = Math.abs(setup.target - currentPrice);
                setup.rrRatio = risk > 0 ? reward / risk : 0;
                details.push('R:R: ' + setup.rrRatio.toFixed(1) + ':1');
            }

            // Check count for confidence
            setup.confidence = result.checkCount ? (result.checkCount / 6 * 100) : 50;
        }
    }

    // Calculate passed status
    var passed = setup.hasEntry &&
                 setup.hasStop &&
                 setup.hasTarget &&
                 setup.rrRatio >= ACTION_THRESHOLDS.MIN_RR_RATIO &&
                 !setup.stopTooWide &&
                 setup.confidence >= ACTION_THRESHOLDS.MIN_CONFIDENCE;

    return {
        passed: passed,
        setup: setup,
        details: details,
        entry: setup.entry,
        stop: setup.stop,
        target: setup.target,
        rrRatio: setup.rrRatio,
        confidence: setup.confidence
    };
}

// MASTER FILTER: Run all symbols through tiers
function getActionCenterCandidates() {
    console.log(' Running Action Center filter on ' + SYMBOLS.length + ' symbols...');

    actionCenterData.tier1Candidates = [];
    actionCenterData.tier2Validated = [];
    actionCenterData.tier3Ready = [];
    actionCenterData.lastUpdate = new Date();

    SYMBOLS.forEach(function(symbol) {
        // Tier 1: Consensus check
        var tier1 = getTier1Consensus(symbol);
        if (tier1.passed) {
            var candidate = {
                symbol: symbol,
                name: SYMBOL_NAMES[symbol] || symbol,
                tier1: tier1
            };
            actionCenterData.tier1Candidates.push(candidate);

            // Tier 2: Technical validation
            var tier2 = getTier2Technical(symbol, tier1.direction);
            candidate.tier2 = tier2;
            if (tier2.passed) {
                actionCenterData.tier2Validated.push(candidate);

                // Tier 3: Trade setup
                var tier3 = getTier3Setup(symbol, tier1.direction);
                candidate.tier3 = tier3;
                if (tier3.passed) {
                    actionCenterData.tier3Ready.push(candidate);
                }
            }
        }
    });

    console.log(' Action Center Results:');
    console.log('  Tier 1 (Consensus): ' + actionCenterData.tier1Candidates.length + ' symbols');
    console.log('  Tier 2 (Technical): ' + actionCenterData.tier2Validated.length + ' symbols');
    console.log('  Tier 3 (Ready): ' + actionCenterData.tier3Ready.length + ' symbols');

    return actionCenterData;
}

// Render Action Center results
function renderActionCenter() {
    var container = document.getElementById('actionCenterResults');
    if (!container) {
        console.log(' Action Center container not found');
        return;
    }

    // Run the filter
    var data = getActionCenterCandidates();

    // Update counts in workflow display
    updateActionCenterCounts(data);

    var html = '';

    // READY TO TRADE section (Tier 3)
    html += '<div class="action-section ready-section">';
    html += '<h3 style="color: #22c55e; margin-bottom: 15px;"> READY TO TRADE (' + data.tier3Ready.length + ')</h3>';
    if (data.tier3Ready.length === 0) {
        html += '<p style="color: #666;">No symbols currently meet all criteria</p>';
    } else {
        data.tier3Ready.forEach(function(c) {
            html += renderActionCard(c, 'ready');
        });
    }
    html += '</div>';

    // VALIDATED section (Tier 2)
    html += '<div class="action-section validated-section">';
    html += '<h3 style="color: #3b82f6; margin-bottom: 15px;"> VALIDATED (' + data.tier2Validated.length + ')</h3>';
    if (data.tier2Validated.length === 0) {
        html += '<p style="color: #666;">No symbols passed technical validation</p>';
    } else {
        data.tier2Validated.filter(function(c) {
            return !c.tier3 || !c.tier3.passed;
        }).forEach(function(c) {
            html += renderActionCard(c, 'validated');
        });
    }
    html += '</div>';

    // CONSENSUS section (Tier 1)
    html += '<div class="action-section consensus-section">';
    html += '<h3 style="color: #f59e0b; margin-bottom: 15px;"> CONSENSUS (' + data.tier1Candidates.length + ')</h3>';
    if (data.tier1Candidates.length === 0) {
        html += '<p style="color: #666;">No symbols have consensus agreement</p>';
    } else {
        data.tier1Candidates.filter(function(c) {
            return !c.tier2 || !c.tier2.passed;
        }).slice(0, 10).forEach(function(c) {
            html += renderActionCard(c, 'consensus');
        });
    }
    html += '</div>';

    container.innerHTML = html;
}

// Render individual action card
function renderActionCard(candidate, tier) {
    var c = candidate;
    var dirClass = c.tier1.direction === 'CALL' ? 'call-badge' : 'put-badge';
    var bgColor = tier === 'ready' ? 'rgba(34,197,94,0.1)' :
                  tier === 'validated' ? 'rgba(59,130,246,0.1)' : 'rgba(245,158,11,0.1)';
    var borderColor = tier === 'ready' ? '#22c55e' : tier === 'validated' ? '#3b82f6' : '#f59e0b';

    var html = '<div class="action-card" style="background:' + bgColor + ';border-left:4px solid ' + borderColor + ';padding:12px;margin-bottom:10px;border-radius:8px;">';

    // Header
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">';
    html += '<span style="font-weight:700;font-size:16px;cursor:pointer;" onclick="selectSymbolFromAction(\'' + c.symbol + '\')">' + c.symbol + '</span>';
    html += '<span class="' + dirClass + '" style="padding:4px 12px;border-radius:4px;font-weight:600;color:white;background:' + (c.tier1.direction === 'CALL' ? '#22c55e' : '#ef4444') + ';">' + c.tier1.direction + '</span>';
    html += '</div>';

    // Consensus info
    html += '<div style="font-size:12px;color:#999;margin-bottom:6px;">';
    html += 'Consensus: ' + c.tier1.votes + '/' + c.tier1.total + ' (' + c.tier1.agreement + '% agreement)';
    html += '</div>';

    // Technical details if available
    if (c.tier2 && c.tier2.details.length > 0) {
        html += '<div style="font-size:11px;color:#888;">' + c.tier2.details.join(' | ') + '</div>';
    }

    // Trade setup if available
    if (c.tier3) {
        html += '<div style="font-size:11px;color:#22c55e;margin-top:4px;">';
        html += 'R:R ' + c.tier3.rrRatio.toFixed(1) + ':1 | Confidence: ' + c.tier3.confidence.toFixed(0) + '%';
        html += '</div>';
    }

    html += '</div>';
    return html;
}

// Update workflow count badges
function updateActionCenterCounts(data) {
    var t1Count = document.getElementById('tier1Count');
    var t2Count = document.getElementById('tier2Count');
    var t3Count = document.getElementById('tier3Count');

    if (t1Count) t1Count.textContent = data.tier1Candidates.length;
    if (t2Count) t2Count.textContent = data.tier2Validated.length;
    if (t3Count) t3Count.textContent = data.tier3Ready.length;
}

// Select symbol from Action Center
function selectSymbolFromAction(symbol) {
    if (typeof SymbolManager !== 'undefined') {
        SymbolManager.set(symbol);
    }
    // Switch to main analysis tab
    var mainTab = document.querySelector('[data-tab="main-analysis"]');
    if (mainTab) mainTab.click();
}

// View full analysis for a symbol
function viewFullAnalysis(symbol) {
    selectSymbolFromAction(symbol);
}

// =============================================================================
// INITIALIZE GLOBAL SYMBOL MANAGER AND REGISTER CALLBACKS
// =============================================================================

document.addEventListener('DOMContentLoaded', function() {

    // Initialize SymbolManager
    SymbolManager.init();

    // Register callback: Update banner price (source of truth)
    SymbolManager.onSymbolChange(function(symbol) {
        // Update banner display
        var symbolDisplay = document.getElementById('currentSymbolDisplay');
        if (symbolDisplay) symbolDisplay.textContent = symbol;

        // Store price in PriceManager when banner updates
        var bannerPriceEl = document.getElementById('currentPrice');
        if (bannerPriceEl) {
            var priceText = bannerPriceEl.textContent || '';
            var price = parseFloat(priceText.replace(/[$,\s]/g, '')) || 0;
            if (price > 0) {
                PriceManager.set(symbol, price, 0, 0);
            }
        }

        // Trigger changeSymbol to load new data (selectSymbol doesn't exist)
        if (typeof changeSymbol === 'function') {
            changeSymbol();
        }
    });

    // Register callback: Update Dual Trade Analysis
    SymbolManager.onSymbolChange(function(symbol) {
        if (typeof loadDualTradeAnalysis === 'function') {
            loadDualTradeAnalysis(symbol);
        }
    });

    // Register callback: Highlight in opportunities table
    SymbolManager.onSymbolChange(function(symbol) {
        document.querySelectorAll('#opportunitiesTable tbody tr').forEach(function(row) {
            var rowSymbol = row.querySelector('td:first-child');
            if (rowSymbol) {
                var sym = rowSymbol.textContent.trim();
                row.style.background = (sym === symbol) ? 'rgba(59,130,246,0.15)' : '';
                row.style.borderLeft = (sym === symbol) ? '4px solid #3b82f6' : '';
            }
        });
    });

    // Register callback: Update Gann Analysis
    SymbolManager.onSymbolChange(function(symbol) {
        if (typeof updateGannAnalysis === 'function') {
            updateGannAnalysis();
        }
        if (typeof updateGannAnalysisForSymbol === 'function') {
            updateGannAnalysisForSymbol(symbol);
        }
    });

    // Register callback: Update MTF Bias
    SymbolManager.onSymbolChange(function(symbol) {
        if (typeof updateMTFBiasHistory === 'function') {
            updateMTFBiasHistory(symbol);
        }
    });

    // Register callback: Update Minor Turn Calculator
    SymbolManager.onSymbolChange(function(symbol) {
        if (typeof calculateMinorTurn === 'function') {
            calculateMinorTurn();
        }
    });

    // Register callback: Update Market Conditions
    SymbolManager.onSymbolChange(function(symbol) {
        var badge = document.getElementById('mktConditionsCurrentSymbol');
        if (badge) badge.textContent = symbol;
        if (typeof changeMktConditionsSymbol === 'function') {
            changeMktConditionsSymbol();
        }
    });

    // Register callback: Update Options Calculator
    SymbolManager.onSymbolChange(function(symbol) {
        var price = (typeof PriceManager !== 'undefined' && PriceManager.get(symbol)?.price) ||
                    (typeof getBannerPrice === 'function' && getBannerPrice()) || 100;
        var badge = document.getElementById('optCalcSymbolBadge');
        var hidden = document.getElementById('optCalcSymbol');
        if (badge) badge.textContent = symbol + ' - $' + price.toFixed(0);
        if (hidden) hidden.value = price;
        if (typeof updateOptionsCalc === 'function') updateOptionsCalc();
    });

    // Register callback: Update Gann Options Calculator
    SymbolManager.onSymbolChange(function(symbol) {
        var badge = document.getElementById('gannOptSymbolBadge');
        var hidden = document.getElementById('gannOptSymbol');
        if (badge) badge.textContent = symbol;
        if (hidden) hidden.value = symbol;
    });

    // Register callback: Update Gann Trade Logger
    SymbolManager.onSymbolChange(function(symbol) {
        var badge = document.getElementById('gannTradeSymbolBadge');
        var hidden = document.getElementById('gannTradeSymbol');
        if (badge) badge.textContent = symbol;
        if (hidden) hidden.value = symbol;
    });

    // Register callback: Update Historical Pattern Scanner
    SymbolManager.onSymbolChange(function(symbol) {
        var badge = document.getElementById('histPatternSymbolBadge');
        var hidden = document.getElementById('histPatternSymbol');
        if (badge) badge.textContent = symbol;
        if (hidden) hidden.value = symbol;
    });

    // Register callback: Update SQ9 MTF Analysis
    SymbolManager.onSymbolChange(function(symbol) {
        var badge = document.getElementById('sq9MtfSymbolBadge');
        var hidden = document.getElementById('sq9MtfSymbol');
        var display = document.getElementById('sq9MtfSymbolDisplay');
        if (badge) badge.textContent = symbol;
        if (hidden) hidden.value = symbol;
        if (display) display.textContent = symbol;
        if (typeof updateSq9Mtf === 'function') updateSq9Mtf();
    });

    // Register callback: Update MTF Signal Scanner
    SymbolManager.onSymbolChange(function(symbol) {
        var badge = document.getElementById('mtfSymbolSelectBadge');
        var hidden = document.getElementById('mtfSymbolSelect');
        if (badge) badge.textContent = symbol;
        if (hidden) hidden.value = symbol;
        if (typeof debouncedMTFScan === 'function') debouncedMTFScan();
    });

    // Register callback: Auto-show SQ9 Setup Detail for selected symbol
    SymbolManager.onSymbolChange(function(symbol) {
        // Wait for scanner data to load, then show detail
        setTimeout(function() {
            if (typeof showSq9Detail === 'function' && typeof sq9ScanResults !== 'undefined' && sq9ScanResults.length > 0) {
                console.log(' Auto-loading SQ9 Setup Detail for:', symbol);
                showSq9Detail(symbol);
            }
        }, 600);
    });

    // Auto-load after short delay
    setTimeout(function() {
        var initialSymbol = SymbolManager.get();
        SymbolManager.triggerUpdates(initialSymbol);
    }, 1000);

    // Tab click handler for Action Center (Dual Trade)
    var actionCenterTab = document.querySelector('[data-tab="action-center"]');
    if (actionCenterTab) {
        actionCenterTab.addEventListener('click', function() {
            setTimeout(function() {
                loadDualTradeAnalysis(SymbolManager.get());
            }, 100);
        });
    }

    // Tab click handler for Workflow Center (Tiered Filter)
    var workflowCenterTab = document.querySelector('[data-tab="workflow-center"]');
    if (workflowCenterTab) {
        workflowCenterTab.addEventListener('click', function() {
            setTimeout(function() {
                if (typeof renderActionCenter === 'function') {
                    renderActionCenter();
                }
            }, 100);
        });
    }

    // Tab click handler for Trade Action (Tiered Action Center)
    var tradeActionTab = document.querySelector('[data-tab="trade-action"]');
    if (tradeActionTab) {
        tradeActionTab.addEventListener('click', function() {
            setTimeout(function() {
                if (typeof renderTieredActionCenter === 'function') {
                    renderTieredActionCenter();
                }
            }, 100);
        });
    }

    // Auto-render Tiered Action Center on page load (since it's the active tab)
    setTimeout(function() {
        if (typeof renderTieredActionCenter === 'function' && typeof sq9ScanResults !== 'undefined' && sq9ScanResults.length > 0) {
            renderTieredActionCenter();
        }
    }, 2000);
});

</script>
</body>
</html>
