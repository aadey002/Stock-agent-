<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Agent 4 - Q5D Options Trading Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #3b82f6; --secondary: #8b5cf6; --accent: #06b6d4;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #0891b2;
            --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0;
            --text: #1e293b; --muted: #64748b; --light: #94a3b8;
            --intraday: #f59e0b; --swing: #8b5cf6;
            --ai-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
        
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 10px 0; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1600px; margin: 0 auto; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .logo h1 { font-size: 16px; font-weight: 700; }
        .logo p { font-size: 9px; opacity: 0.9; }
        
        .live-price-ticker { display: flex; align-items: center; gap: 12px; background: rgba(0,0,0,0.2); padding: 6px 14px; border-radius: 8px; }
        .ticker-symbol { font-size: 13px; font-weight: 700; }
        .ticker-price { font-size: 20px; font-weight: 800; }
        .ticker-change { font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        .ticker-change.positive { background: rgba(16,185,129,0.3); }
        .ticker-change.negative { background: rgba(239,68,68,0.3); }
        
        .header-controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .status-badge { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 15px; font-size: 10px; font-weight: 600; }
        .status-badge.online { background: rgba(16,185,129,0.3); }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        
        .symbol-select select { padding: 5px 8px; border: none; border-radius: 5px; font-size: 11px; background: rgba(255,255,255,0.9); cursor: pointer; font-weight: 600; }
        .refresh-btn { padding: 5px 12px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 5px; font-size: 11px; font-weight: 600; cursor: pointer; }
        
        .container { max-width: 1600px; margin: 0 auto; padding: 12px; }
        
        .mode-toggle-container { display: flex; justify-content: center; margin-bottom: 12px; }
        .mode-toggle { display: flex; background: var(--card); border-radius: 8px; padding: 3px; border: 1px solid var(--border); }
        .mode-btn { padding: 8px 20px; border: none; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 5px; }
        .mode-btn.intraday { background: transparent; color: var(--muted); }
        .mode-btn.swing { background: transparent; color: var(--muted); }
        .mode-btn.active.intraday { background: linear-gradient(135deg, var(--intraday), #d97706); color: white; }
        .mode-btn.active.swing { background: linear-gradient(135deg, var(--swing), #6d28d9); color: white; }
        
        .symbol-banner { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 8px 14px; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; font-size: 14px; }
        .symbol-banner.intraday-mode { background: linear-gradient(135deg, var(--intraday), #d97706); }
        .symbol-banner.swing-mode { background: linear-gradient(135deg, var(--swing), #6d28d9); }
        
        .tabs { display: flex; gap: 3px; background: var(--card); border-radius: 8px; padding: 4px; margin-bottom: 12px; overflow-x: auto; border: 1px solid var(--border); }
        .tab-btn { padding: 7px 12px; background: transparent; border: none; border-radius: 5px; color: var(--muted); font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .tab-btn:hover { color: var(--primary); background: rgba(59,130,246,0.05); }
        .tab-btn.active { color: white; background: var(--primary); }
        .tab-btn.ai-tab { background: var(--ai-gradient); color: white; }
        .tab-btn.ai-tab:not(.active) { background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2)); color: var(--secondary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 14px; margin-bottom: 12px; }
        .card-title { font-size: 14px; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        
        .grid { display: grid; gap: 12px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
        .grid-5 { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
        
        .metric { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 10px; }
        .metric-label { font-size: 9px; font-weight: 600; color: var(--muted); text-transform: uppercase; margin-bottom: 4px; }
        .metric-value { font-size: 18px; font-weight: 700; }
        .metric-value.positive { color: var(--success); }
        .metric-value.negative { color: var(--danger); }
        .metric-sub { font-size: 9px; color: var(--light); margin-top: 2px; }
        
        .badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600; text-transform: uppercase; }
        .badge-success { background: rgba(16,185,129,0.15); color: var(--success); }
        .badge-danger { background: rgba(239,68,68,0.15); color: var(--danger); }
        .badge-warning { background: rgba(245,158,11,0.15); color: var(--warning); }
        .badge-info { background: rgba(8,145,178,0.15); color: var(--info); }
        .badge-primary { background: rgba(59,130,246,0.15); color: var(--primary); }
        .badge-ultra { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .badge-intraday { background: linear-gradient(135deg, var(--intraday), #d97706); color: white; }
        .badge-swing { background: linear-gradient(135deg, var(--swing), #6d28d9); color: white; }
        
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { text-align: left; padding: 8px; font-size: 9px; font-weight: 600; color: var(--muted); text-transform: uppercase; background: var(--bg); border-bottom: 1px solid var(--border); }
        td { padding: 8px; border-bottom: 1px solid var(--border); }
        tr:hover { background: rgba(59,130,246,0.02); }
        
        .chart-box { position: relative; height: 280px; }
        
        .dual-signal-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .signal-panel { border-radius: 8px; padding: 14px; }
        .signal-panel.intraday { background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(217,119,6,0.05)); border: 2px solid var(--intraday); }
        .signal-panel.swing { background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(109,40,217,0.05)); border: 2px solid var(--swing); }
        .signal-panel-title { font-size: 13px; font-weight: 700; margin-bottom: 10px; }
        .signal-panel-title.intraday { color: var(--intraday); }
        .signal-panel-title.swing { color: var(--swing); }
        
        .ref-data-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 11px; }
        .ref-label { color: var(--muted); }
        .ref-value { font-weight: 600; }
        .ref-value.positive { color: var(--success); }
        .ref-value.negative { color: var(--danger); }
        
        .bar-count-display { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .bar-count-item { background: var(--bg); border-radius: 6px; padding: 10px; text-align: center; }
        .bar-count-value { font-size: 24px; font-weight: 800; }
        .bar-count-label { font-size: 10px; color: var(--muted); margin-top: 3px; }
        
        .pattern-item { background: var(--bg); border-radius: 6px; padding: 8px; margin-bottom: 6px; }
        .pattern-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .pattern-name { font-weight: 600; font-size: 12px; }
        .pattern-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
        .pattern-fill { height: 100%; border-radius: 2px; }
        .pattern-fill.bullish { background: var(--success); }
        .pattern-fill.bearish { background: var(--danger); }
        .pattern-fill.neutral { background: var(--warning); }

        /* AI Assistant Styles */
        .ai-assistant-container { display: grid; grid-template-columns: 1fr 350px; gap: 15px; height: calc(100vh - 200px); min-height: 500px; }
        .ai-chat-panel { display: flex; flex-direction: column; background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .ai-chat-header { background: var(--ai-gradient); color: white; padding: 12px 16px; display: flex; align-items: center; gap: 10px; }
        .ai-avatar { width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .ai-chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .ai-message { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.5; }
        .ai-message.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai-message.assistant { background: var(--bg); color: var(--text); align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid var(--border); }
        .ai-message.assistant .message-content { white-space: pre-wrap; }
        .ai-message.assistant table { font-size: 11px; margin: 8px 0; }
        .ai-message.assistant th, .ai-message.assistant td { padding: 4px 8px; }
        .ai-chat-input { display: flex; gap: 8px; padding: 12px; border-top: 1px solid var(--border); background: var(--bg); }
        .ai-chat-input input { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 20px; font-size: 13px; outline: none; }
        .ai-chat-input input:focus { border-color: var(--primary); }
        .ai-chat-input button { padding: 10px 20px; background: var(--ai-gradient); color: white; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 13px; }
        .ai-chat-input button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .ai-quick-actions { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 14px; }
        .ai-quick-actions h4 { font-size: 13px; margin-bottom: 10px; color: var(--secondary); }
        .quick-action-btn { display: block; width: 100%; padding: 8px 12px; margin-bottom: 6px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; font-size: 11px; text-align: left; cursor: pointer; transition: all 0.2s; }
        .quick-action-btn:hover { border-color: var(--primary); background: rgba(59,130,246,0.05); }
        
        .ai-data-context { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-top: 12px; }
        .ai-data-context h4 { font-size: 12px; margin-bottom: 8px; color: var(--muted); }
        .context-item { font-size: 11px; padding: 3px 0; display: flex; justify-content: space-between; }
        
        .typing-indicator { display: flex; gap: 4px; padding: 10px 14px; }
        .typing-dot { width: 8px; height: 8px; background: var(--muted); border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; flex-direction: column; gap: 15px; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 900px) {
            .ai-assistant-container { grid-template-columns: 1fr; height: auto; }
            .dual-signal-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div>Loading data...</div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üìä</div>
                <div><h1>Stock Agent 4</h1><p>Q5D Options Platform</p></div>
            </div>
            
            <div class="live-price-ticker">
                <div>
                    <div class="ticker-symbol" id="tickerSymbol">SPY</div>
                    <div style="font-size:9px;opacity:0.8;">S&P 500 ETF</div>
                </div>
                <div class="ticker-price" id="tickerPrice">$675.02</div>
                <div>
                    <div class="ticker-change positive" id="tickerChange">+$6.29</div>
                    <div style="font-size:9px;margin-top:1px;" id="tickerPct">+0.94%</div>
                </div>
            </div>
            
            <div class="header-controls">
                <div class="status-badge online"><span class="status-dot"></span><span>LIVE</span></div>
                <div class="symbol-select">
                    <select id="symbolSelect" onchange="changeSymbol()">
                        <optgroup label="Major ETFs">
                            <option value="SPY">SPY</option>
                            <option value="QQQ">QQQ</option>
                            <option value="IWM">IWM</option>
                            <option value="DIA">DIA</option>
                        </optgroup>
                        <optgroup label="Sectors">
                            <option value="XLK">XLK</option>
                            <option value="XLF">XLF</option>
                            <option value="XLV">XLV</option>
                            <option value="XLE">XLE</option>
                        </optgroup>
                    </select>
                </div>
                <button class="refresh-btn" onclick="loadAllData()">‚Üª Refresh</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="mode-toggle-container">
            <div class="mode-toggle">
                <button class="mode-btn intraday active" onclick="setTradingMode('intraday')">‚ö° INTRADAY</button>
                <button class="mode-btn swing" onclick="setTradingMode('swing')">üåä SWING</button>
            </div>
        </div>

        <div class="symbol-banner intraday-mode" id="symbolBanner">
            <div><strong id="currentSymbolDisplay">SPY</strong> - <span id="currentSymbolName">S&P 500 ETF</span> | <span id="currentModeDisplay">INTRADAY</span></div>
            <div style="font-size:11px;">üìÖ <span id="dataDate">--</span> üïê <span id="dataTime">--</span></div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="overview">üìä Overview</button>
            <button class="tab-btn" data-tab="charts">üìà Charts</button>
            <button class="tab-btn" data-tab="barcount">üî¢ Bar Count</button>
            <button class="tab-btn" data-tab="signals">üéØ Signals</button>
            <button class="tab-btn" data-tab="agents">ü§ñ Agents</button>
            <button class="tab-btn" data-tab="patterns">üìê Patterns</button>
            <button class="tab-btn" data-tab="trades">üìù Trades</button>
            <button class="tab-btn ai-tab" data-tab="ai-assistant">üß† AI Assistant</button>
        </div>

        <!-- OVERVIEW TAB -->
        <div id="overview" class="tab-content active">
            <div class="grid grid-5">
                <div class="metric"><div class="metric-label">Price</div><div class="metric-value" id="currentPrice">--</div><div class="metric-sub" id="priceSource">Loading...</div></div>
                <div class="metric"><div class="metric-label">Change</div><div class="metric-value" id="dailyChange">--</div><div class="metric-sub" id="changePct">--</div></div>
                <div class="metric"><div class="metric-label">Volume</div><div class="metric-value" id="volumeDisplay">--</div><div class="metric-sub" id="volumeVsAvgSmall">vs avg</div></div>
                <div class="metric"><div class="metric-label">Signal</div><div class="metric-value" id="signalStatus">--</div><div class="metric-sub" id="signalConf">--</div></div>
                <div class="metric"><div class="metric-label">ATR</div><div class="metric-value" id="atrDisplay">--</div><div class="metric-sub">Volatility</div></div>
            </div>

            <div class="dual-signal-container">
                <div class="signal-panel intraday">
                    <div class="signal-panel-title intraday">‚ö° INTRADAY (0-1 DTE)</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <div>
                            <div class="ref-data-row"><span class="ref-label">Signal</span><span class="badge badge-success" id="intradaySignal">CALL</span></div>
                            <div class="ref-data-row"><span class="ref-label">Entry</span><span class="ref-value" id="intradayEntry">--</span></div>
                            <div class="ref-data-row"><span class="ref-label">Stop</span><span class="ref-value negative" id="intradayStop">--</span></div>
                        </div>
                        <div>
                            <div class="ref-data-row"><span class="ref-label">Target 1</span><span class="ref-value positive" id="intradayT1">--</span></div>
                            <div class="ref-data-row"><span class="ref-label">Target 2</span><span class="ref-value positive" id="intradayT2">--</span></div>
                            <div class="ref-data-row"><span class="ref-label">Strike</span><span class="ref-value" id="intradayStrike">--</span></div>
                        </div>
                    </div>
                </div>
                <div class="signal-panel swing">
                    <div class="signal-panel-title swing">üåä SWING (3-5 DTE)</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <div>
                            <div class="ref-data-row"><span class="ref-label">Signal</span><span class="badge badge-success" id="swingSignal">CALL</span></div>
                            <div class="ref-data-row"><span class="ref-label">Entry</span><span class="ref-value" id="swingEntry">--</span></div>
                            <div class="ref-data-row"><span class="ref-label">Stop</span><span class="ref-value negative" id="swingStop">--</span></div>
                        </div>
                        <div>
                            <div class="ref-data-row"><span class="ref-label">Target 1</span><span class="ref-value positive" id="swingT1">--</span></div>
                            <div class="ref-data-row"><span class="ref-label">Target 2</span><span class="ref-value positive" id="swingT2">--</span></div>
                            <div class="ref-data-row"><span class="ref-label">Strike</span><span class="ref-value" id="swingStrike">--</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìã Reference Data</div>
                <div class="grid grid-4">
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">52W High</span><span class="ref-value positive" id="week52High">--</span></div>
                        <div class="ref-data-row"><span class="ref-label">52W Low</span><span class="ref-value negative" id="week52Low">--</span></div>
                    </div>
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">Today High</span><span class="ref-value" id="todayHigh">--</span></div>
                        <div class="ref-data-row"><span class="ref-label">Today Low</span><span class="ref-value" id="todayLow">--</span></div>
                    </div>
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">Avg Vol (20D)</span><span class="ref-value" id="avgVolume20">--</span></div>
                        <div class="ref-data-row"><span class="ref-label">Vol vs Avg</span><span class="ref-value" id="volumeVsAvg">--</span></div>
                    </div>
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">Fibonacci Zone</span><span class="badge badge-info" id="fibZone">--</span></div>
                        <div class="ref-data-row"><span class="ref-label">Trend</span><span class="badge" id="trendBadge">--</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CHARTS TAB -->
        <div id="charts" class="tab-content">
            <div class="card">
                <div class="card-title">üìà Price Chart with Fibonacci Levels</div>
                <div class="chart-box"><canvas id="priceChart"></canvas></div>
                <div class="grid grid-2" style="margin-top:12px;">
                    <div style="background:rgba(239,68,68,0.05);border-radius:6px;padding:10px;">
                        <h4 style="font-size:12px;color:var(--danger);margin-bottom:8px;">Resistance</h4>
                        <div class="ref-data-row"><span class="ref-label">R3 (161.8%)</span><span class="ref-value" id="chartR3">--</span></div>
                        <div class="ref-data-row"><span class="ref-label">R2 (127.2%)</span><span class="ref-value" id="chartR2">--</span></div>
                        <div class="ref-data-row"><span class="ref-label">R1 (100%)</span><span class="ref-value" id="chartR1">--</span></div>
                    </div>
                    <div style="background:rgba(16,185,129,0.05);border-radius:6px;padding:10px;">
                        <h4 style="font-size:12px;color:var(--success);margin-bottom:8px;">Support</h4>
                        <div class="ref-data-row"><span class="ref-label">S1 (38.2%)</span><span class="ref-value" id="chartS1">--</span></div>
                        <div class="ref-data-row"><span class="ref-label">S2 (50.0%)</span><span class="ref-value" id="chartS2">--</span></div>
                        <div class="ref-data-row"><span class="ref-label">S3 (61.8%)</span><span class="ref-value" id="chartS3">--</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BAR COUNT TAB - Enhanced -->
        <div id="barcount" class="tab-content">
            <div class="card">
                <div class="card-title">üî¢ Bar Count Analysis</div>
                <div style="display:flex;gap:15px;margin-bottom:15px;flex-wrap:wrap;">
                    <div>
                        <label style="font-size:11px;color:var(--muted);">Bars to Analyze:</label>
                        <select id="barCountSelect" onchange="updateBarCountTable()" style="padding:6px 10px;border:1px solid var(--border);border-radius:5px;margin-left:8px;">
                            <option value="20">20 Bars</option>
                            <option value="50">50 Bars</option>
                            <option value="100">100 Bars</option>
                            <option value="200">200 Bars</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:11px;color:var(--muted);">Symbol:</label>
                        <select id="barCountSymbol" onchange="updateBarCountTable()" style="padding:6px 10px;border:1px solid var(--border);border-radius:5px;margin-left:8px;">
                            <option value="SPY">SPY</option>
                            <option value="QQQ">QQQ</option>
                            <option value="IWM">IWM</option>
                            <option value="DIA">DIA</option>
                            <option value="XLK">XLK</option>
                            <option value="XLF">XLF</option>
                        </select>
                    </div>
                </div>
                
                <div class="bar-count-display">
                    <div class="bar-count-item">
                        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">üìä Base Confluence</div>
                        <div class="bar-count-value" id="baseBarCount">+5</div>
                        <div class="bar-count-label">Consecutive Bars</div>
                    </div>
                    <div class="bar-count-item">
                        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">üîÆ Gann-Elliott</div>
                        <div class="bar-count-value" id="gannBarCount">+7</div>
                        <div class="bar-count-label">Wave Progress</div>
                    </div>
                    <div class="bar-count-item">
                        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">üß† DQN/RL</div>
                        <div class="bar-count-value" id="dqnBarCount">+2</div>
                        <div class="bar-count-label">Momentum</div>
                    </div>
                    <div class="bar-count-item">
                        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">üåä 3-Wave</div>
                        <div class="bar-count-value" id="waveBarCount">+4</div>
                        <div class="bar-count-label">Impulse</div>
                    </div>
                </div>
            </div>

            <!-- Trend Reversal Statistics -->
            <div class="card">
                <div class="card-title">üìä Trend Reversal Statistics</div>
                <p style="font-size:11px;color:var(--muted);margin-bottom:12px;">Average bars before trend reversal based on historical data</p>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Avg Bullish Run</th>
                                <th>Avg Bearish Run</th>
                                <th>Current Run</th>
                                <th>% of Avg</th>
                                <th>Reversal Risk</th>
                            </tr>
                        </thead>
                        <tbody id="reversalStatsTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìà Bar Count History</div>
                <div class="table-wrap" style="max-height:300px;overflow-y:auto;">
                    <table>
                        <thead><tr><th>#</th><th>Date</th><th>O/H/L/C</th><th>Dir</th><th>Base</th><th>Gann</th><th>DQN</th><th>Wave</th><th>Avg</th></tr></thead>
                        <tbody id="barCountTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SIGNALS TAB -->
        <div id="signals" class="tab-content">
            <div class="card">
                <div class="card-title">‚ö° Intraday vs üåä Swing Parameters</div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Parameter</th><th style="color:var(--intraday);">‚ö° INTRADAY</th><th style="color:var(--swing);">üåä SWING</th></tr></thead>
                        <tbody>
                            <tr><td>Timeframe</td><td>5-min, 15-min</td><td>Daily, 4-Hour</td></tr>
                            <tr><td>Options Expiry</td><td>0DTE - 1DTE</td><td>3-5 DTE</td></tr>
                            <tr><td>Fast SMA</td><td>5</td><td>10</td></tr>
                            <tr><td>Slow SMA</td><td>20</td><td>30</td></tr>
                            <tr><td>Stop Loss</td><td>0.5-1.0 ATR</td><td>1.5-2.0 ATR</td></tr>
                            <tr><td>Target</td><td>1.0-2.0 ATR</td><td>3.0-4.0 ATR</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- AGENTS TAB -->
        <div id="agents" class="tab-content">
            <div class="card">
                <div class="card-title">ü§ñ Agent Signals</div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Agent</th><th>Intraday</th><th>Conf</th><th>Swing</th><th>Conf</th></tr></thead>
                        <tbody>
                            <tr><td>üìä Base Confluence</td><td><span class="badge badge-success" id="baseIntradaySignal">CALL</span></td><td id="baseIntradayConf">72%</td><td><span class="badge badge-success" id="baseSwingSignal">CALL</span></td><td id="baseSwingConf">68%</td></tr>
                            <tr><td>üîÆ Gann-Elliott</td><td><span class="badge badge-success" id="gannIntradaySignal">CALL</span></td><td id="gannIntradayConf">75%</td><td><span class="badge badge-success" id="gannSwingSignal">CALL</span></td><td id="gannSwingConf">70%</td></tr>
                            <tr><td>üß† DQN/RL</td><td><span class="badge badge-warning" id="dqnIntradaySignal">HOLD</span></td><td id="dqnIntradayConf">58%</td><td><span class="badge badge-success" id="dqnSwingSignal">CALL</span></td><td id="dqnSwingConf">65%</td></tr>
                            <tr><td>üåä 3-Wave</td><td><span class="badge badge-success" id="waveIntradaySignal">CALL</span></td><td id="waveIntradayConf">68%</td><td><span class="badge badge-success" id="waveSwingSignal">CALL</span></td><td id="waveSwingConf">72%</td></tr>
                            <tr style="background:var(--bg);"><td><strong>CONSENSUS</strong></td><td><span class="badge badge-ultra" id="intradayConsensus">3/4</span></td><td id="intradayConsensusConf">68%</td><td><span class="badge badge-ultra" id="swingConsensus">4/4</span></td><td id="swingConsensusConf">69%</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PATTERNS TAB -->
        <div id="patterns" class="tab-content">
            <div class="card">
                <div class="card-title">üìê Fibonacci Levels</div>
                <div class="grid grid-2">
                    <div><div class="ref-data-row"><span class="ref-label">R3 (161.8%)</span><span class="ref-value" id="fibR3">--</span></div><div class="ref-data-row"><span class="ref-label">R2 (127.2%)</span><span class="ref-value" id="fibR2">--</span></div><div class="ref-data-row"><span class="ref-label">R1 (100%)</span><span class="ref-value" id="fibR1">--</span></div></div>
                    <div><div class="ref-data-row"><span class="ref-label">S1 (38.2%)</span><span class="ref-value" id="fibS1">--</span></div><div class="ref-data-row"><span class="ref-label">S2 (50.0%)</span><span class="ref-value" id="fibS2">--</span></div><div class="ref-data-row"><span class="ref-label">S3 (61.8%)</span><span class="ref-value" id="fibS3">--</span></div></div>
                </div>
            </div>
            <div class="grid grid-3">
                <div class="card"><div class="card-title">üìä Technical</div><div class="pattern-item"><div class="pattern-header"><span class="pattern-name">Double Bottom</span><span class="badge badge-success">72%</span></div><div class="pattern-bar"><div class="pattern-fill bullish" style="width:72%"></div></div></div><div class="pattern-item"><div class="pattern-header"><span class="pattern-name">Ascending Triangle</span><span class="badge badge-success">65%</span></div><div class="pattern-bar"><div class="pattern-fill bullish" style="width:65%"></div></div></div></div>
                <div class="card"><div class="card-title">üïØÔ∏è Candlestick</div><div class="pattern-item"><div class="pattern-header"><span class="pattern-name">Bullish Engulfing</span><span class="badge badge-success">78%</span></div><div class="pattern-bar"><div class="pattern-fill bullish" style="width:78%"></div></div></div><div class="pattern-item"><div class="pattern-header"><span class="pattern-name">Hammer</span><span class="badge badge-success">70%</span></div><div class="pattern-bar"><div class="pattern-fill bullish" style="width:70%"></div></div></div></div>
                <div class="card"><div class="card-title">‚¨õ Point & Figure</div><div class="pattern-item"><div class="pattern-header"><span class="pattern-name">Double Top BO</span><span class="badge badge-success">75%</span></div><div class="pattern-bar"><div class="pattern-fill bullish" style="width:75%"></div></div></div><div class="pattern-item"><div class="pattern-header"><span class="pattern-name">Bullish Catapult</span><span class="badge badge-success">68%</span></div><div class="pattern-bar"><div class="pattern-fill bullish" style="width:68%"></div></div></div></div>
            </div>
        </div>

        <!-- TRADES TAB -->
        <div id="trades" class="tab-content">
            <div class="grid grid-4">
                <div class="metric"><div class="metric-label">Total Trades</div><div class="metric-value">24</div></div>
                <div class="metric"><div class="metric-label">Win Rate</div><div class="metric-value positive">71%</div></div>
                <div class="metric"><div class="metric-label">Total P&L</div><div class="metric-value positive">+$2,450</div></div>
                <div class="metric"><div class="metric-label">Avg Trade</div><div class="metric-value positive">+$102</div></div>
            </div>
            <div class="card">
                <div class="card-title">üìù Log Trade</div>
                <div class="grid grid-4">
                    <select style="padding:8px;border:1px solid var(--border);border-radius:5px;"><option>‚ö° Intraday</option><option>üåä Swing</option></select>
                    <select style="padding:8px;border:1px solid var(--border);border-radius:5px;"><option>üìà CALL</option><option>üìâ PUT</option></select>
                    <input type="text" placeholder="Strike" style="padding:8px;border:1px solid var(--border);border-radius:5px;">
                    <input type="number" placeholder="Premium" style="padding:8px;border:1px solid var(--border);border-radius:5px;">
                </div>
                <button style="width:100%;margin-top:10px;padding:10px;background:var(--primary);color:white;border:none;border-radius:5px;font-weight:600;cursor:pointer;">Log Trade</button>
            </div>
        </div>

        <!-- AI ASSISTANT TAB -->
        <div id="ai-assistant" class="tab-content">
            <div class="ai-assistant-container">
                <div class="ai-chat-panel">
                    <div class="ai-chat-header">
                        <div class="ai-avatar">üß†</div>
                        <div>
                            <div style="font-weight:700;">Gann Trading Assistant</div>
                            <div style="font-size:11px;opacity:0.9;">Powered by Tunnel Through the Air Principles</div>
                        </div>
                    </div>
                    <div class="ai-chat-messages" id="aiChatMessages">
                        <div class="ai-message assistant">
                            <div class="message-content">Welcome to the Gann Trading Assistant! üéØ

I'm trained on W.D. Gann's "Tunnel Through the Air" principles and the core methodology of this Q5D Options Platform.

I can help you with:
‚Ä¢ üìä Analyze any ETF/stock data on the dashboard
‚Ä¢ üéØ Find high-consensus trades (3/4, 4/4 agent agreement)
‚Ä¢ üìà Recommend optimal strikes and expiries
‚Ä¢ üîç Search for market news and analysis
‚Ä¢ üìã Generate custom reports across all symbols
‚Ä¢ üåä Explain Gann cycles, time factors, and price geometry

Try asking me something like:
"Show me all ETFs with 4/4 agent consensus today"
"What's the best strike for SPY calls expiring Friday?"
"Explain the Gann Square of 9 setup for QQQ"</div>
                        </div>
                    </div>
                    <div class="ai-chat-input">
                        <input type="text" id="aiInput" placeholder="Ask about trades, analysis, Gann methods..." onkeypress="if(event.key==='Enter')sendAiMessage()">
                        <button onclick="sendAiMessage()" id="aiSendBtn">Send</button>
                    </div>
                </div>
                
                <div>
                    <div class="ai-quick-actions">
                        <h4>üöÄ Quick Actions</h4>
                        <button class="quick-action-btn" onclick="askAi('Show me all ETFs with intraday 3/4 or 4/4 agent consensus today')">üìä High Consensus Trades</button>
                        <button class="quick-action-btn" onclick="askAi('What are the best CALL options for the next 2 days across all ETFs?')">üìà Best CALLs (2 Days)</button>
                        <button class="quick-action-btn" onclick="askAi('What are the best PUT options for the next 2 days across all ETFs?')">üìâ Best PUTs (2 Days)</button>
                        <button class="quick-action-btn" onclick="askAi('Analyze SPY using Gann time cycles - when is the next reversal likely?')">üîÆ Gann Time Analysis</button>
                        <button class="quick-action-btn" onclick="askAi('What is the optimal strike price for ' + currentSymbol + ' based on Fibonacci and ATR?')">üéØ Optimal Strike</button>
                        <button class="quick-action-btn" onclick="askAi('Compare all sector ETFs - which sectors are showing the strongest momentum?')">üåç Sector Comparison</button>
                        <button class="quick-action-btn" onclick="askAi('Explain the Tunnel Through the Air trading principles')">üìö Gann Principles</button>
                        <button class="quick-action-btn" onclick="askAi('Search for latest SPY and QQQ market news')">üì∞ Market News</button>
                    </div>
                    
                    <div class="ai-data-context">
                        <h4>üìä Current Data Context</h4>
                        <div class="context-item"><span>Symbol:</span><span id="aiContextSymbol">SPY</span></div>
                        <div class="context-item"><span>Price:</span><span id="aiContextPrice">$675.02</span></div>
                        <div class="context-item"><span>Signal:</span><span id="aiContextSignal">CALL</span></div>
                        <div class="context-item"><span>Consensus:</span><span id="aiContextConsensus">3/4</span></div>
                        <div class="context-item"><span>Mode:</span><span id="aiContextMode">INTRADAY</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// Global State
let currentSymbol = 'SPY';
let tradingMode = 'intraday';
let currentData = [];
let allSymbolsData = {};
let priceChart;

const SYMBOLS = ['SPY', 'QQQ', 'IWM', 'DIA', 'XLK', 'XLF', 'XLV', 'XLE'];
const SYMBOL_NAMES = {
    'SPY': 'S&P 500 ETF', 'QQQ': 'Nasdaq 100 ETF', 'IWM': 'Russell 2000 ETF', 'DIA': 'Dow Jones ETF',
    'XLK': 'Technology', 'XLF': 'Financials', 'XLV': 'Healthcare', 'XLE': 'Energy'
};

const TRADING_PARAMS = {
    intraday: { fastSMA: 5, slowSMA: 20, atrPeriod: 10, stopATR: 0.75, target1ATR: 1.0, target2ATR: 1.5 },
    swing: { fastSMA: 10, slowSMA: 30, atrPeriod: 14, stopATR: 1.5, target1ATR: 2.0, target2ATR: 3.0 }
};

// Gann Knowledge Base
const GANN_KNOWLEDGE = {
    tunnelThroughAir: `"The Tunnel Through the Air" (1927) by W.D. Gann is both a novel and a trading treatise that encodes his most powerful trading secrets.

CORE PRINCIPLES:
1. TIME IS MORE IMPORTANT THAN PRICE - Gann believed time cycles were the primary factor in market movement
2. NATURAL LAW - Markets follow natural laws based on geometry, astronomy, and biblical cycles
3. THE SQUARE OF 9 - A mathematical tool using the square root relationship of price and time
4. PRICE AND TIME SQUARING - When price and time equal (square), expect major reversals
5. ANNIVERSARY DATES - Major tops and bottoms tend to repeat on anniversary dates

KEY CYCLES FROM THE BOOK:
‚Ä¢ 7-year cycle (biblical)
‚Ä¢ 10-year cycle (decade)
‚Ä¢ 20-year cycle (generation)
‚Ä¢ 30-year cycle (Saturn)
‚Ä¢ 60-year cycle (major)
‚Ä¢ 90-year cycle (master)

GEOMETRIC ANGLES:
‚Ä¢ 1x1 (45¬∞) - Most important, balance of time and price
‚Ä¢ 2x1 (63.75¬∞) - Strong bull market
‚Ä¢ 1x2 (26.25¬∞) - Weak market
‚Ä¢ 4x1 (75¬∞) - Extreme strength
‚Ä¢ 1x4 (15¬∞) - Extreme weakness`,

    squareOf9: `THE GANN SQUARE OF 9:
A spiral of numbers starting from 1 in the center, expanding outward.

HOW TO USE:
1. Find the square root of the current price
2. Add or subtract 2 for 360¬∞ move (full cycle)
3. Add or subtract 0.25 for 45¬∞ move
4. Add or subtract 0.5 for 90¬∞ move
5. Square the result for target price

EXAMPLE for SPY at $675:
‚àö675 = 25.98
+0.5 (90¬∞) = 26.48 ‚Üí 26.48¬≤ = $701.19 (resistance)
-0.5 (90¬∞) = 25.48 ‚Üí 25.48¬≤ = $649.23 (support)
+1.0 (180¬∞) = 26.98 ‚Üí 26.98¬≤ = $727.92 (major resistance)`,

    timeCycles: `GANN TIME CYCLES:
‚Ä¢ 30 calendar days = minor cycle
‚Ä¢ 45 calendar days = important
‚Ä¢ 60 calendar days = significant
‚Ä¢ 90 calendar days = major
‚Ä¢ 120 calendar days = important
‚Ä¢ 144 calendar days = Fibonacci
‚Ä¢ 180 calendar days = half year
‚Ä¢ 270 calendar days = 3/4 year
‚Ä¢ 360 calendar days = annual

TRADING DATES:
Watch for reversals on:
‚Ä¢ Equinoxes (Mar 21, Sep 21)
‚Ä¢ Solstices (Jun 21, Dec 21)
‚Ä¢ 45 days from major highs/lows
‚Ä¢ Anniversary dates of previous moves`
};

// Platform Core Principles
const PLATFORM_PRINCIPLES = `Q5D OPTIONS TRADING PLATFORM - CORE PRINCIPLES:

MULTI-AGENT CONSENSUS SYSTEM:
This platform uses 4 independent trading agents that must agree before generating signals:

1. BASE CONFLUENCE AGENT - SMA crossover with ATR-based stops
2. GANN-ELLIOTT AGENT - Combines Gann geometry with Elliott Wave patterns
3. DQN/RL AGENT - Deep Q-Network reinforcement learning model
4. 3-WAVE AGENT - Simplified impulse wave detection

SIGNAL CLASSIFICATION:
‚Ä¢ 1/4 agents agree = NO TRADE (insufficient consensus)
‚Ä¢ 2/4 agents agree = SINGLE signal (low confidence)
‚Ä¢ 3/4 agents agree = SUPER signal (tradeable)
‚Ä¢ 4/4 agents agree = ULTRA signal (highest confidence)

DUAL TIMEFRAME APPROACH:
‚Ä¢ INTRADAY: 0-1 DTE options, 5-15 min charts, tight stops (0.5-1 ATR)
‚Ä¢ SWING: 3-5 DTE options, daily charts, wider stops (1.5-2 ATR)

KEY ASSUMPTIONS:
1. Multiple independent signals reduce false positives
2. Time cycles (Gann) predict WHEN to trade
3. Price geometry (Fibonacci) predicts WHERE price will go
4. ATR-based position sizing manages risk
5. Options provide leverage with defined risk`;

document.addEventListener('DOMContentLoaded', () => {
    initTabs();
    loadAllData();
    loadAllSymbolsData();
    setInterval(loadAllData, 60000);
});

function initTabs() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(btn.dataset.tab).classList.add('active');
            btn.classList.add('active');
        };
    });
}

function setTradingMode(mode) {
    tradingMode = mode;
    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.mode-btn.${mode}`).classList.add('active');
    document.getElementById('symbolBanner').className = `symbol-banner ${mode}-mode`;
    document.getElementById('currentModeDisplay').textContent = mode.toUpperCase();
    document.getElementById('aiContextMode').textContent = mode.toUpperCase();
}

function changeSymbol() {
    currentSymbol = document.getElementById('symbolSelect').value;
    document.getElementById('currentSymbolDisplay').textContent = currentSymbol;
    document.getElementById('currentSymbolName').textContent = SYMBOL_NAMES[currentSymbol] || currentSymbol;
    document.getElementById('tickerSymbol').textContent = currentSymbol;
    document.getElementById('aiContextSymbol').textContent = currentSymbol;
    loadAllData();
}

function parseCSV(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return [];
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
        const values = line.split(',');
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i]?.trim() || '');
        return obj;
    });
}

async function loadAllData() {
    document.getElementById('loadingOverlay').classList.add('active');
    try {
        let r = await fetch(`data/${currentSymbol}.csv?t=${Date.now()}`).catch(() => null);
        if (!r?.ok) r = await fetch('data/SPY.csv?t=' + Date.now()).catch(() => null);
        if (r?.ok) {
            currentData = parseCSV(await r.text());
            if (currentData.length) {
                updateDashboard();
                updateBarCountTable();
                updateReversalStats();
                updatePriceChart();
            }
        }
    } catch (e) { console.error('Error:', e); }
    document.getElementById('loadingOverlay').classList.remove('active');
}

async function loadAllSymbolsData() {
    for (const symbol of SYMBOLS) {
        try {
            const r = await fetch(`data/${symbol}.csv?t=${Date.now()}`).catch(() => null);
            if (r?.ok) {
                allSymbolsData[symbol] = parseCSV(await r.text());
            }
        } catch (e) { console.error(`Error loading ${symbol}:`, e); }
    }
}

function updateDashboard() {
    const lat = currentData[currentData.length - 1];
    const prev = currentData[currentData.length - 2] || lat;
    const price = parseFloat(lat.Close) || 0;
    const prevPrice = parseFloat(prev.Close) || price;
    const chg = price - prevPrice;
    const pct = prevPrice ? (chg / prevPrice * 100) : 0;
    const atr = parseFloat(lat.ATR) || 5;
    const bias = (lat.Bias || '').toUpperCase();

    // Header ticker
    document.getElementById('tickerPrice').textContent = '$' + price.toFixed(2);
    document.getElementById('tickerChange').textContent = (chg >= 0 ? '+' : '') + '$' + Math.abs(chg).toFixed(2);
    document.getElementById('tickerChange').className = 'ticker-change ' + (chg >= 0 ? 'positive' : 'negative');
    document.getElementById('tickerPct').textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';

    // Metrics
    document.getElementById('currentPrice').textContent = '$' + price.toFixed(2);
    document.getElementById('priceSource').textContent = `${currentData.length} bars`;
    document.getElementById('dailyChange').textContent = (chg >= 0 ? '+' : '') + '$' + Math.abs(chg).toFixed(2);
    document.getElementById('dailyChange').className = 'metric-value ' + (chg >= 0 ? 'positive' : 'negative');
    document.getElementById('changePct').textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
    document.getElementById('volumeDisplay').textContent = ((parseFloat(lat.Volume) || 0) / 1e6).toFixed(1) + 'M';
    document.getElementById('signalStatus').textContent = bias || 'HOLD';
    document.getElementById('signalConf').textContent = `${lat.PriceConfluence || 0}/4`;
    document.getElementById('atrDisplay').textContent = '$' + atr.toFixed(2);

    // Date/Time
    const dateStr = lat.Date || '';
    const [datePart, timePart] = dateStr.includes('T') ? dateStr.split('T') : [dateStr, 'EOD'];
    document.getElementById('dataDate').textContent = datePart;
    document.getElementById('dataTime').textContent = timePart.replace('Z', '');

    // AI Context
    document.getElementById('aiContextPrice').textContent = '$' + price.toFixed(2);
    document.getElementById('aiContextSignal').textContent = bias || 'HOLD';
    document.getElementById('aiContextConsensus').textContent = `${lat.PriceConfluence || 0}/4`;

    // Signals
    const ip = TRADING_PARAMS.intraday;
    const sp = TRADING_PARAMS.swing;
    
    document.getElementById('intradaySignal').textContent = bias || 'HOLD';
    document.getElementById('intradaySignal').className = `badge badge-${bias === 'CALL' ? 'success' : (bias === 'PUT' ? 'danger' : 'warning')}`;
    document.getElementById('intradayEntry').textContent = '$' + price.toFixed(2);
    document.getElementById('intradayStop').textContent = '$' + (bias === 'PUT' ? (price + atr * ip.stopATR) : (price - atr * ip.stopATR)).toFixed(2);
    document.getElementById('intradayT1').textContent = '$' + (bias === 'PUT' ? (price - atr * ip.target1ATR) : (price + atr * ip.target1ATR)).toFixed(2);
    document.getElementById('intradayT2').textContent = '$' + (bias === 'PUT' ? (price - atr * ip.target2ATR) : (price + atr * ip.target2ATR)).toFixed(2);
    document.getElementById('intradayStrike').textContent = '$' + Math.round(price) + ' ' + (bias || 'CALL');
    
    document.getElementById('swingSignal').textContent = bias || 'HOLD';
    document.getElementById('swingSignal').className = `badge badge-${bias === 'CALL' ? 'success' : (bias === 'PUT' ? 'danger' : 'warning')}`;
    document.getElementById('swingEntry').textContent = '$' + (price - 2).toFixed(0) + '-' + (price + 2).toFixed(0);
    document.getElementById('swingStop').textContent = '$' + (bias === 'PUT' ? (price + atr * sp.stopATR) : (price - atr * sp.stopATR)).toFixed(2);
    document.getElementById('swingT1').textContent = '$' + (bias === 'PUT' ? (price - atr * sp.target1ATR) : (price + atr * sp.target1ATR)).toFixed(2);
    document.getElementById('swingT2').textContent = '$' + (bias === 'PUT' ? (price - atr * sp.target2ATR) : (price + atr * sp.target2ATR)).toFixed(2);
    document.getElementById('swingStrike').textContent = '$' + (Math.round(price/5)*5) + ' ' + (bias || 'CALL');

    updateReferenceData();
    updateFibonacci();
}

function updateReferenceData() {
    const lat = currentData[currentData.length - 1];
    const yearData = currentData.slice(-252);
    const price = parseFloat(lat.Close) || 0;
    
    const highs = yearData.map(d => parseFloat(d.High) || 0);
    const lows = yearData.map(d => parseFloat(d.Low) || 0);
    
    document.getElementById('week52High').textContent = '$' + Math.max(...highs).toFixed(2);
    document.getElementById('week52Low').textContent = '$' + Math.min(...lows).toFixed(2);
    document.getElementById('todayHigh').textContent = '$' + (parseFloat(lat.High) || 0).toFixed(2);
    document.getElementById('todayLow').textContent = '$' + (parseFloat(lat.Low) || 0).toFixed(2);
    
    const todayVol = parseFloat(lat.Volume) || 0;
    const volumes20 = currentData.slice(-20).map(d => parseFloat(d.Volume) || 0);
    const avgVol = volumes20.reduce((a, b) => a + b, 0) / 20;
    
    document.getElementById('avgVolume20').textContent = (avgVol / 1e6).toFixed(1) + 'M';
    document.getElementById('volumeVsAvg').textContent = ((todayVol/avgVol - 1) * 100).toFixed(0) + '%';
    document.getElementById('volumeVsAvgSmall').textContent = ((todayVol/avgVol - 1) * 100).toFixed(0) + '% vs avg';
}

function updateFibonacci() {
    const recent = currentData.slice(-60);
    const highs = recent.map(d => parseFloat(d.High) || 0);
    const lows = recent.map(d => parseFloat(d.Low) || 0);
    const swingHigh = Math.max(...highs);
    const swingLow = Math.min(...lows);
    const price = parseFloat(currentData[currentData.length - 1].Close) || 0;
    const range = swingHigh - swingLow;
    
    const fib382 = swingHigh - (range * 0.382);
    const fib500 = swingHigh - (range * 0.500);
    const fib618 = swingHigh - (range * 0.618);
    const fib100 = swingHigh;
    const fib1272 = swingLow + (range * 1.272);
    const fib1618 = swingLow + (range * 1.618);
    
    document.getElementById('fibR1').textContent = '$' + fib100.toFixed(2);
    document.getElementById('fibR2').textContent = '$' + fib1272.toFixed(2);
    document.getElementById('fibR3').textContent = '$' + fib1618.toFixed(2);
    document.getElementById('fibS1').textContent = '$' + fib382.toFixed(2);
    document.getElementById('fibS2').textContent = '$' + fib500.toFixed(2);
    document.getElementById('fibS3').textContent = '$' + fib618.toFixed(2);
    
    document.getElementById('chartR1').textContent = '$' + fib100.toFixed(2);
    document.getElementById('chartR2').textContent = '$' + fib1272.toFixed(2);
    document.getElementById('chartR3').textContent = '$' + fib1618.toFixed(2);
    document.getElementById('chartS1').textContent = '$' + fib382.toFixed(2);
    document.getElementById('chartS2').textContent = '$' + fib500.toFixed(2);
    document.getElementById('chartS3').textContent = '$' + fib618.toFixed(2);
    
    // Fib zone
    let zone = 'NEUTRAL';
    if (price > fib100) zone = 'BREAKOUT';
    else if (price > fib382) zone = 'STRONG';
    else if (price > fib500) zone = 'PULLBACK';
    else zone = 'DEEP';
    document.getElementById('fibZone').textContent = zone;
    
    // Trend
    const fastSMA = parseFloat(currentData[currentData.length-1].FastSMA) || price;
    const slowSMA = parseFloat(currentData[currentData.length-1].SlowSMA) || price;
    const trend = fastSMA > slowSMA ? 'BULLISH' : 'BEARISH';
    document.getElementById('trendBadge').textContent = trend;
    document.getElementById('trendBadge').className = `badge badge-${trend === 'BULLISH' ? 'success' : 'danger'}`;
    
    window.fibLevels = { fib100, fib1272, fib1618, fib382, fib500, fib618 };
}

function updateBarCountTable() {
    const barCount = parseInt(document.getElementById('barCountSelect')?.value || 20);
    const data = currentData.slice(-barCount);
    const table = document.getElementById('barCountTable');
    if (!table) return;
    
    let html = '';
    let baseCount = 0, gannCount = 0, dqnCount = 0, waveCount = 0;
    
    data.forEach((d, i) => {
        const o = parseFloat(d.Open) || 0;
        const c = parseFloat(d.Close) || 0;
        const isBullish = c >= o;
        
        if (isBullish) {
            baseCount = baseCount >= 0 ? baseCount + 1 : 1;
            gannCount = gannCount >= 0 ? gannCount + 1 : 1;
            dqnCount = dqnCount >= 0 ? dqnCount + 1 : 1;
            waveCount = waveCount >= 0 ? waveCount + 1 : 1;
        } else {
            baseCount = baseCount <= 0 ? baseCount - 1 : -1;
            gannCount = gannCount <= 0 ? gannCount - 1 : -1;
            dqnCount = dqnCount <= 0 ? dqnCount - 1 : -1;
            waveCount = waveCount <= 0 ? waveCount - 1 : -1;
        }
        
        const avg = (baseCount + gannCount + dqnCount + waveCount) / 4;
        const date = (d.Date || '').split('T')[0].slice(5);
        
        html += `<tr>
            <td>${data.length - i}</td>
            <td>${date}</td>
            <td style="font-size:10px;">${o.toFixed(0)}/${(parseFloat(d.High)||0).toFixed(0)}/${(parseFloat(d.Low)||0).toFixed(0)}/${c.toFixed(0)}</td>
            <td>${isBullish ? 'üìà' : 'üìâ'}</td>
            <td class="${baseCount > 0 ? 'positive' : 'negative'}">${baseCount > 0 ? '+' : ''}${baseCount}</td>
            <td class="${gannCount > 0 ? 'positive' : 'negative'}">${gannCount > 0 ? '+' : ''}${gannCount}</td>
            <td class="${dqnCount > 0 ? 'positive' : 'negative'}">${dqnCount > 0 ? '+' : ''}${dqnCount}</td>
            <td class="${waveCount > 0 ? 'positive' : 'negative'}">${waveCount > 0 ? '+' : ''}${waveCount}</td>
            <td><span class="badge badge-${avg > 2 ? 'success' : (avg < -2 ? 'danger' : 'warning')}">${avg.toFixed(1)}</span></td>
        </tr>`;
    });
    
    table.innerHTML = html;
    
    document.getElementById('baseBarCount').textContent = (baseCount > 0 ? '+' : '') + baseCount;
    document.getElementById('baseBarCount').style.color = baseCount > 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('gannBarCount').textContent = (gannCount > 0 ? '+' : '') + gannCount;
    document.getElementById('gannBarCount').style.color = gannCount > 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('dqnBarCount').textContent = (dqnCount > 0 ? '+' : '') + dqnCount;
    document.getElementById('dqnBarCount').style.color = dqnCount > 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('waveBarCount').textContent = (waveCount > 0 ? '+' : '') + waveCount;
    document.getElementById('waveBarCount').style.color = waveCount > 0 ? 'var(--success)' : 'var(--danger)';
}

function updateReversalStats() {
    const table = document.getElementById('reversalStatsTable');
    if (!table) return;
    
    let html = '';
    
    for (const symbol of SYMBOLS) {
        const data = allSymbolsData[symbol] || currentData;
        if (!data || data.length < 50) continue;
        
        // Calculate average run lengths
        let bullishRuns = [], bearishRuns = [], currentRun = 0, lastDir = null;
        
        for (const d of data) {
            const isBullish = parseFloat(d.Close) >= parseFloat(d.Open);
            
            if (lastDir === null) {
                lastDir = isBullish;
                currentRun = 1;
            } else if (isBullish === lastDir) {
                currentRun++;
            } else {
                if (lastDir) bullishRuns.push(currentRun);
                else bearishRuns.push(currentRun);
                lastDir = isBullish;
                currentRun = 1;
            }
        }
        
        const avgBullish = bullishRuns.length ? (bullishRuns.reduce((a,b) => a+b, 0) / bullishRuns.length).toFixed(1) : 'N/A';
        const avgBearish = bearishRuns.length ? (bearishRuns.reduce((a,b) => a+b, 0) / bearishRuns.length).toFixed(1) : 'N/A';
        const currentDir = lastDir ? 'Bullish' : 'Bearish';
        const avgForDir = lastDir ? parseFloat(avgBullish) : parseFloat(avgBearish);
        const pctOfAvg = avgForDir ? ((currentRun / avgForDir) * 100).toFixed(0) : 'N/A';
        
        let risk = 'LOW';
        let riskClass = 'success';
        if (pctOfAvg !== 'N/A') {
            const pct = parseInt(pctOfAvg);
            if (pct > 150) { risk = 'HIGH'; riskClass = 'danger'; }
            else if (pct > 100) { risk = 'MEDIUM'; riskClass = 'warning'; }
        }
        
        html += `<tr>
            <td><strong>${symbol}</strong></td>
            <td>${avgBullish} bars</td>
            <td>${avgBearish} bars</td>
            <td>${currentRun} (${currentDir})</td>
            <td>${pctOfAvg}%</td>
            <td><span class="badge badge-${riskClass}">${risk}</span></td>
        </tr>`;
    }
    
    table.innerHTML = html;
}

function updatePriceChart() {
    const data = currentData.slice(-60);
    const ctx = document.getElementById('priceChart');
    if (!ctx) return;
    
    if (priceChart) priceChart.destroy();
    
    const fib = window.fibLevels || {};
    const colors = data.map(d => parseFloat(d.Close) >= parseFloat(d.Open) ? '#10b981' : '#ef4444');
    
    priceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => (d.Date || '').split('T')[0].slice(5)),
            datasets: [{
                label: 'Price',
                data: data.map(d => parseFloat(d.Close) || 0),
                backgroundColor: colors,
                borderColor: colors
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                annotation: {
                    annotations: {
                        r1: { type: 'line', yMin: fib.fib100, yMax: fib.fib100, borderColor: '#ef4444', borderWidth: 1, borderDash: [5,5] },
                        s1: { type: 'line', yMin: fib.fib382, yMax: fib.fib382, borderColor: '#10b981', borderWidth: 1, borderDash: [5,5] },
                        s2: { type: 'line', yMin: fib.fib500, yMax: fib.fib500, borderColor: '#14b8a6', borderWidth: 1, borderDash: [5,5] }
                    }
                }
            },
            scales: { y: { ticks: { callback: v => '$' + v } } }
        }
    });
}

// AI Assistant Functions
function askAi(question) {
    document.getElementById('aiInput').value = question;
    sendAiMessage();
}

async function sendAiMessage() {
    const input = document.getElementById('aiInput');
    const message = input.value.trim();
    if (!message) return;
    
    const messagesDiv = document.getElementById('aiChatMessages');
    
    // Add user message
    messagesDiv.innerHTML += `<div class="ai-message user">${message}</div>`;
    input.value = '';
    
    // Add typing indicator
    messagesDiv.innerHTML += `<div class="ai-message assistant typing-indicator" id="typingIndicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    document.getElementById('aiSendBtn').disabled = true;
    
    try {
        const response = await generateAiResponse(message);
        
        // Remove typing indicator
        document.getElementById('typingIndicator')?.remove();
        
        // Add AI response
        messagesDiv.innerHTML += `<div class="ai-message assistant"><div class="message-content">${response}</div></div>`;
    } catch (e) {
        document.getElementById('typingIndicator')?.remove();
        messagesDiv.innerHTML += `<div class="ai-message assistant"><div class="message-content">Sorry, I encountered an error. Please try again.</div></div>`;
    }
    
    document.getElementById('aiSendBtn').disabled = false;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

async function generateAiResponse(userMessage) {
    const lowerMsg = userMessage.toLowerCase();
    
    // Build context from dashboard data
    let dashboardContext = buildDashboardContext();
    
    // System prompt with Gann knowledge
    const systemPrompt = `You are the Gann Trading Assistant for the Q5D Options Trading Platform. You have deep knowledge of W.D. Gann's trading methods, especially "The Tunnel Through the Air."

${PLATFORM_PRINCIPLES}

${GANN_KNOWLEDGE.tunnelThroughAir}

${GANN_KNOWLEDGE.squareOf9}

${GANN_KNOWLEDGE.timeCycles}

CURRENT DASHBOARD DATA:
${dashboardContext}

INSTRUCTIONS:
1. Always provide specific, actionable trading guidance
2. Reference Gann principles when relevant
3. Use the actual dashboard data in your responses
4. Format tables and data clearly
5. Be concise but thorough
6. Never hallucinate data - only use what's provided
7. For news searches, acknowledge you'll provide general market context`;

    // Try to call Claude API
    try {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                model: "claude-sonnet-4-20250514",
                max_tokens: 1500,
                messages: [
                    { role: "user", content: systemPrompt + "\n\nUser Question: " + userMessage }
                ]
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            return data.content[0].text;
        }
    } catch (e) {
        console.log("API call failed, using local response");
    }
    
    // Fallback to local responses
    return generateLocalResponse(userMessage, dashboardContext);
}

function buildDashboardContext() {
    let context = `CURRENT SYMBOL: ${currentSymbol}\n`;
    context += `TRADING MODE: ${tradingMode.toUpperCase()}\n\n`;
    
    // Current symbol data
    if (currentData.length) {
        const lat = currentData[currentData.length - 1];
        context += `${currentSymbol} DATA:\n`;
        context += `- Price: $${parseFloat(lat.Close).toFixed(2)}\n`;
        context += `- Signal: ${lat.Bias || 'HOLD'}\n`;
        context += `- Agent Consensus: ${lat.PriceConfluence || 0}/4\n`;
        context += `- ATR: $${parseFloat(lat.ATR || 5).toFixed(2)}\n\n`;
    }
    
    // All symbols summary
    context += `ALL SYMBOLS SUMMARY:\n`;
    for (const symbol of SYMBOLS) {
        const data = allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            const signal = lat.Bias || 'HOLD';
            const consensus = lat.PriceConfluence || 0;
            const price = parseFloat(lat.Close).toFixed(2);
            context += `- ${symbol}: $${price}, ${signal}, ${consensus}/4 consensus\n`;
        }
    }
    
    return context;
}

function generateLocalResponse(message, context) {
    const lowerMsg = message.toLowerCase();
    
    // High consensus trades
    if (lowerMsg.includes('consensus') || lowerMsg.includes('3/4') || lowerMsg.includes('4/4')) {
        let trades = [];
        for (const symbol of SYMBOLS) {
            const data = allSymbolsData[symbol];
            if (data && data.length) {
                const lat = data[data.length - 1];
                const consensus = parseInt(lat.PriceConfluence) || 0;
                if (consensus >= 3) {
                    trades.push({
                        symbol,
                        signal: lat.Bias || 'HOLD',
                        consensus,
                        price: parseFloat(lat.Close).toFixed(2)
                    });
                }
            }
        }
        
        if (trades.length === 0) {
            return "üìä No ETFs currently have 3/4 or 4/4 agent consensus. The market may be in a consolidation phase. Consider waiting for clearer signals or reviewing individual agents for potential setups.";
        }
        
        let response = "üìä **HIGH CONSENSUS TRADES TODAY:**\n\n";
        response += "| Symbol | Signal | Consensus | Price |\n";
        response += "|--------|--------|-----------|-------|\n";
        trades.forEach(t => {
            response += `| ${t.symbol} | ${t.signal} | ${t.consensus}/4 | $${t.price} |\n`;
        });
        
        response += "\nüéØ **RECOMMENDATION:** Focus on " + trades.filter(t => t.consensus === 4).map(t => t.symbol).join(", ") || trades[0].symbol;
        response += " for highest probability trades.";
        
        return response;
    }
    
    // Best calls/puts
    if (lowerMsg.includes('call') || lowerMsg.includes('put')) {
        const isCall = lowerMsg.includes('call');
        let recommendations = [];
        
        for (const symbol of SYMBOLS) {
            const data = allSymbolsData[symbol];
            if (data && data.length) {
                const lat = data[data.length - 1];
                const signal = (lat.Bias || '').toUpperCase();
                if ((isCall && signal === 'CALL') || (!isCall && signal === 'PUT')) {
                    const price = parseFloat(lat.Close);
                    const atr = parseFloat(lat.ATR) || 5;
                    recommendations.push({
                        symbol,
                        price: price.toFixed(2),
                        strike: Math.round(price),
                        target: (isCall ? price + atr * 2 : price - atr * 2).toFixed(2),
                        consensus: lat.PriceConfluence || 0
                    });
                }
            }
        }
        
        recommendations.sort((a, b) => b.consensus - a.consensus);
        
        if (recommendations.length === 0) {
            return `üìä No strong ${isCall ? 'CALL' : 'PUT'} signals across ETFs currently. Consider waiting for better setups or check individual symbols for developing patterns.`;
        }
        
        let response = `üìà **BEST ${isCall ? 'CALL' : 'PUT'} OPTIONS (Next 2 Days):**\n\n`;
        response += "| Symbol | Strike | Target | Consensus |\n";
        response += "|--------|--------|--------|----------|\n";
        recommendations.slice(0, 5).forEach(r => {
            response += `| ${r.symbol} | $${r.strike} | $${r.target} | ${r.consensus}/4 |\n`;
        });
        
        response += `\nüí° **TOP PICK:** ${recommendations[0].symbol} $${recommendations[0].strike} ${isCall ? 'CALL' : 'PUT'}`;
        response += `\nüéØ Target: $${recommendations[0].target}`;
        
        return response;
    }
    
    // Gann/Tunnel Through Air
    if (lowerMsg.includes('gann') || lowerMsg.includes('tunnel') || lowerMsg.includes('square of 9')) {
        return `üìö **GANN'S TUNNEL THROUGH THE AIR PRINCIPLES:**

${GANN_KNOWLEDGE.tunnelThroughAir.substring(0, 1500)}

üîÆ **APPLYING TO ${currentSymbol}:**
Current Price: Check the dashboard for live price
Use Square of 9 to calculate:
- Next resistance: ‚àöPrice + 0.5, then square
- Next support: ‚àöPrice - 0.5, then square

Would you like me to calculate specific Gann levels for ${currentSymbol}?`;
    }
    
    // Optimal strike
    if (lowerMsg.includes('strike') || lowerMsg.includes('optimal')) {
        if (currentData.length) {
            const lat = currentData[currentData.length - 1];
            const price = parseFloat(lat.Close);
            const atr = parseFloat(lat.ATR) || 5;
            const signal = lat.Bias || 'HOLD';
            
            const atmStrike = Math.round(price);
            const otmStrike = signal === 'CALL' ? Math.ceil(price / 5) * 5 : Math.floor(price / 5) * 5;
            
            return `üéØ **OPTIMAL STRIKE FOR ${currentSymbol}:**

Current Price: $${price.toFixed(2)}
Signal: ${signal}
ATR: $${atr.toFixed(2)}

**Recommended Strikes:**

üìç **INTRADAY (0DTE):**
- ATM: $${atmStrike} (Delta ~0.50)
- Aggressive: $${signal === 'CALL' ? atmStrike + 1 : atmStrike - 1} (Higher reward)

üìç **SWING (3-5 DTE):**
- Conservative: $${otmStrike} (Delta ~0.40-0.45)
- Target: $${(signal === 'CALL' ? price + atr * 3 : price - atr * 3).toFixed(2)}

üí° **TIP:** For 0DTE, stick with ATM for better delta. For swing trades, slight OTM gives better risk/reward.`;
        }
    }
    
    // Sector comparison
    if (lowerMsg.includes('sector') || lowerMsg.includes('compare')) {
        let sectors = [];
        for (const symbol of ['XLK', 'XLF', 'XLV', 'XLE']) {
            const data = allSymbolsData[symbol];
            if (data && data.length > 20) {
                const lat = data[data.length - 1];
                const prev20 = data[data.length - 21];
                const perf = ((parseFloat(lat.Close) - parseFloat(prev20.Close)) / parseFloat(prev20.Close) * 100).toFixed(2);
                sectors.push({
                    symbol,
                    name: SYMBOL_NAMES[symbol],
                    perf,
                    signal: lat.Bias || 'HOLD'
                });
            }
        }
        
        sectors.sort((a, b) => parseFloat(b.perf) - parseFloat(a.perf));
        
        let response = "üåç **SECTOR COMPARISON (20-Day Performance):**\n\n";
        response += "| Rank | Sector | Symbol | 20D % | Signal |\n";
        response += "|------|--------|--------|-------|--------|\n";
        sectors.forEach((s, i) => {
            response += `| ${i + 1} | ${s.name} | ${s.symbol} | ${s.perf}% | ${s.signal} |\n`;
        });
        
        response += `\nüèÜ **STRONGEST:** ${sectors[0].name} (${sectors[0].symbol})`;
        response += `\n‚ö†Ô∏è **WEAKEST:** ${sectors[sectors.length-1].name} (${sectors[sectors.length-1].symbol})`;
        
        return response;
    }
    
    // Default response
    return `I understand you're asking about: "${message}"

Based on the current dashboard data for ${currentSymbol}:
${context}

How can I help you further? You can ask me about:
‚Ä¢ High consensus trades (3/4 or 4/4 agent agreement)
‚Ä¢ Best CALL or PUT options for the next 2 days
‚Ä¢ Optimal strike prices for any symbol
‚Ä¢ Gann time cycles and Square of 9 analysis
‚Ä¢ Sector comparisons and rotation
‚Ä¢ Explanation of platform principles`;
}
</script>
</body>
</html>
