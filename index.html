<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Agent 3 - Q5D Trading Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #3b82f6; --secondary: #8b5cf6; --accent: #06b6d4;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #0891b2;
            --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0;
            --text: #1e293b; --muted: #64748b; --light: #94a3b8;
        }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
        
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 15px 0; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1600px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 45px; height: 45px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .logo h1 { font-size: 20px; font-weight: 700; }
        .logo p { font-size: 11px; opacity: 0.9; }
        .header-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        
        .status-badge { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-badge.online { background: rgba(16,185,129,0.3); }
        .status-badge.offline { background: rgba(239,68,68,0.3); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        
        .symbol-select { display: flex; align-items: center; gap: 8px; }
        .symbol-select label { font-size: 12px; opacity: 0.9; }
        .symbol-select select { padding: 8px 12px; border: none; border-radius: 8px; font-size: 13px; background: rgba(255,255,255,0.9); cursor: pointer; font-weight: 600; }
        .refresh-btn { padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .refresh-btn:hover { background: rgba(255,255,255,0.3); }
        
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        /* Current Symbol Banner */
        .symbol-banner { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 12px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .symbol-banner h2 { font-size: 18px; }
        .symbol-banner .date-time { display: flex; gap: 20px; font-size: 13px; }
        .symbol-banner .date-time span { opacity: 0.9; }
        .symbol-banner .date-time strong { opacity: 1; }
        
        .tabs { display: flex; gap: 5px; background: var(--card); border-radius: 12px; padding: 6px; margin-bottom: 20px; overflow-x: auto; border: 1px solid var(--border); }
        .tab-btn { padding: 10px 16px; background: transparent; border: none; border-radius: 8px; color: var(--muted); font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .tab-btn:hover { color: var(--primary); background: rgba(59,130,246,0.05); }
        .tab-btn.active { color: white; background: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .card-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .card-title .icon { font-size: 18px; }
        
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .grid-5 { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
        
        .metric { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
        .metric-label { font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .metric-value { font-size: 24px; font-weight: 700; }
        .metric-value.positive { color: var(--success); }
        .metric-value.negative { color: var(--danger); }
        .metric-sub { font-size: 11px; color: var(--light); margin-top: 4px; }
        
        .agent-card { background: var(--card); border: 2px solid var(--border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; position: relative; }
        .agent-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .agent-card.bullish { border-color: var(--success); background: linear-gradient(135deg, rgba(16,185,129,0.05), transparent); }
        .agent-card.bearish { border-color: var(--danger); background: linear-gradient(135deg, rgba(239,68,68,0.05), transparent); }
        .agent-card.neutral { border-color: var(--warning); background: linear-gradient(135deg, rgba(245,158,11,0.05), transparent); }
        .agent-icon { font-size: 32px; margin-bottom: 10px; }
        .agent-name { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .agent-type { font-size: 12px; color: var(--muted); margin-bottom: 12px; }
        .agent-signal { display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 700; }
        .agent-signal.call { background: rgba(16,185,129,0.15); color: var(--success); }
        .agent-signal.put { background: rgba(239,68,68,0.15); color: var(--danger); }
        .agent-signal.hold { background: rgba(245,158,11,0.15); color: var(--warning); }
        .agent-confidence { margin-top: 12px; }
        .conf-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 6px; }
        .conf-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
        .conf-fill.high { background: var(--success); }
        .conf-fill.med { background: var(--warning); }
        .conf-fill.low { background: var(--danger); }
        .agent-details { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
        .agent-card.expanded .agent-details { display: block; }
        .detail-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; }
        .detail-label { color: var(--muted); }
        .detail-value { font-weight: 600; }
        
        .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge-success { background: rgba(16,185,129,0.15); color: var(--success); }
        .badge-danger { background: rgba(239,68,68,0.15); color: var(--danger); }
        .badge-warning { background: rgba(245,158,11,0.15); color: var(--warning); }
        .badge-info { background: rgba(8,145,178,0.15); color: var(--info); }
        .badge-primary { background: rgba(59,130,246,0.15); color: var(--primary); }
        .badge-ultra { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .badge-super { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
        
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px; font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; background: var(--bg); border-bottom: 1px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: rgba(59,130,246,0.02); }
        
        .chart-box { position: relative; height: 250px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card); border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 700; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); }
        .modal-body { padding: 20px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; color: var(--muted); margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #2563eb; }
        
        .sector-item { margin-bottom: 12px; }
        .sector-header { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px; }
        .sector-name { font-weight: 600; }
        .sector-perf { font-weight: 700; }
        .sector-perf.positive { color: var(--success); }
        .sector-perf.negative { color: var(--danger); }
        .sector-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
        .sector-fill { height: 100%; border-radius: 4px; }
        .sector-fill.positive { background: var(--success); }
        .sector-fill.negative { background: var(--danger); }
        
        .holding-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); }
        .holding-item:last-child { border-bottom: none; }
        .holding-info { display: flex; align-items: center; gap: 12px; }
        .holding-rank { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; }
        .holding-rank.top { background: rgba(16,185,129,0.15); color: var(--success); }
        .holding-rank.bottom { background: rgba(239,68,68,0.15); color: var(--danger); }
        .holding-symbol { font-weight: 700; }
        .holding-name { font-size: 12px; color: var(--muted); }
        .holding-perf { font-weight: 700; font-size: 14px; }
        
        .condition-card { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--bg); border-radius: 10px; margin-bottom: 12px; }
        .condition-icon { font-size: 28px; }
        .condition-info { flex: 1; }
        .condition-label { font-size: 12px; color: var(--muted); }
        .condition-value { font-size: 18px; font-weight: 700; }
        .condition-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        
        .empty-state { text-align: center; padding: 40px; color: var(--muted); }
        .progress { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); border-radius: 4px; transition: width 0.5s; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; flex-direction: column; gap: 15px; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">Loading data...</div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üìä</div>
                <div>
                    <h1>Stock Agent 3</h1>
                    <p>Q5D Professional Trading Platform</p>
                </div>
            </div>
            <div class="header-controls">
                <div class="status-badge online" id="statusBadge">
                    <span class="status-dot"></span>
                    <span id="statusText">ONLINE</span>
                </div>
                <div class="symbol-select">
                    <label>Symbol:</label>
                    <select id="symbolSelect" onchange="changeSymbol()">
                        <optgroup label="Major ETFs">
                            <option value="SPY">SPY - S&P 500</option>
                            <option value="QQQ">QQQ - Nasdaq 100</option>
                            <option value="IWM">IWM - Russell 2000</option>
                            <option value="DIA">DIA - Dow Jones</option>
                        </optgroup>
                        <optgroup label="Sector ETFs">
                            <option value="XLK">XLK - Technology</option>
                            <option value="XLF">XLF - Financials</option>
                            <option value="XLV">XLV - Healthcare</option>
                            <option value="XLE">XLE - Energy</option>
                            <option value="XLI">XLI - Industrials</option>
                            <option value="XLP">XLP - Consumer Staples</option>
                            <option value="XLY">XLY - Consumer Disc.</option>
                            <option value="XLU">XLU - Utilities</option>
                            <option value="XLB">XLB - Materials</option>
                            <option value="XLRE">XLRE - Real Estate</option>
                        </optgroup>
                    </select>
                </div>
                <button class="refresh-btn" onclick="loadAllData()">‚Üª Refresh</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Current Symbol Banner -->
        <div class="symbol-banner">
            <h2><span id="currentSymbolDisplay">SPY</span> - <span id="currentSymbolName">S&P 500 ETF</span></h2>
            <div class="date-time">
                <span>üìÖ Date: <strong id="dataDate">--</strong></span>
                <span>üïê Time: <strong id="dataTime">--</strong></span>
                <span>üîÑ Updated: <strong id="lastRefresh">--</strong></span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="overview">üìä Overview</button>
            <button class="tab-btn" data-tab="agents">ü§ñ Agents</button>
            <button class="tab-btn" data-tab="signals">üìà Signal History</button>
            <button class="tab-btn" data-tab="trades">üìù Trade Log</button>
            <button class="tab-btn" data-tab="market">üåç Market</button>
            <button class="tab-btn" data-tab="sectors">üîÑ Sectors</button>
            <button class="tab-btn" data-tab="etf">üì¶ ETF Holdings</button>
            <button class="tab-btn" data-tab="analytics">üìâ Analytics</button>
        </div>

        <!-- OVERVIEW TAB -->
        <div id="overview" class="tab-content active">
            <div class="grid grid-4">
                <div class="metric"><div class="metric-label">Current Price (<span class="symbolTag">SPY</span>)</div><div class="metric-value" id="currentPrice">--</div><div class="metric-sub" id="priceSource">Loading...</div></div>
                <div class="metric"><div class="metric-label">24H Change</div><div class="metric-value" id="dailyChange">--</div><div class="metric-sub" id="changePct">--</div></div>
                <div class="metric"><div class="metric-label">Volume</div><div class="metric-value" id="volumeDisplay">--</div><div class="metric-sub">Daily Volume</div></div>
                <div class="metric"><div class="metric-label">Signal</div><div class="metric-value" id="signalStatus">--</div><div class="metric-sub" id="signalConf">--</div></div>
            </div>

            <h3 class="card-title" style="margin: 25px 0 15px;"><span class="icon">ü§ñ</span> Agent Signals for <span class="symbolTag">SPY</span> (Click for Details)</h3>
            <div class="grid grid-4" id="agentCardsContainer">
                <!-- Base Agent -->
                <div class="agent-card bullish" onclick="toggleAgent(this)">
                    <div class="agent-icon">üìä</div>
                    <div class="agent-name">Base Confluence</div>
                    <div class="agent-type">SMA + Technical</div>
                    <span class="agent-signal call" id="baseSignal">CALL</span>
                    <div class="agent-confidence">
                        <div style="display:flex;justify-content:space-between;font-size:12px;"><span>Confidence</span><span id="baseConf">72%</span></div>
                        <div class="conf-bar"><div class="conf-fill high" id="baseConfBar" style="width:72%"></div></div>
                    </div>
                    <div class="agent-details">
                        <div class="detail-row"><span class="detail-label">Fast SMA</span><span class="detail-value" id="baseFastSMA">--</span></div>
                        <div class="detail-row"><span class="detail-label">Slow SMA</span><span class="detail-value" id="baseSlowSMA">--</span></div>
                        <div class="detail-row"><span class="detail-label">ATR (14)</span><span class="detail-value" id="baseATR">--</span></div>
                        <div class="detail-row"><span class="detail-label">Bias</span><span class="detail-value" id="baseBias">--</span></div>
                    </div>
                </div>
                <!-- Gann Agent -->
                <div class="agent-card bullish" onclick="toggleAgent(this)">
                    <div class="agent-icon">üîÆ</div>
                    <div class="agent-name">Gann-Elliott</div>
                    <div class="agent-type">Wave + Fibonacci</div>
                    <span class="agent-signal call" id="gannSignal">CALL</span>
                    <div class="agent-confidence">
                        <div style="display:flex;justify-content:space-between;font-size:12px;"><span>Confidence</span><span id="gannConf">78%</span></div>
                        <div class="conf-bar"><div class="conf-fill high" id="gannConfBar" style="width:78%"></div></div>
                    </div>
                    <div class="agent-details">
                        <div class="detail-row"><span class="detail-label">Geo Level</span><span class="detail-value" id="gannGeo">--</span></div>
                        <div class="detail-row"><span class="detail-label">Phi Level</span><span class="detail-value" id="gannPhi">--</span></div>
                        <div class="detail-row"><span class="detail-label">Price Confluence</span><span class="detail-value" id="gannPriceConf">--</span></div>
                        <div class="detail-row"><span class="detail-label">Time Confluence</span><span class="detail-value" id="gannTimeConf">--</span></div>
                    </div>
                </div>
                <!-- DQN Agent -->
                <div class="agent-card neutral" onclick="openRLModal()">
                    <div class="agent-icon">üß†</div>
                    <div class="agent-name">DQN/RL Agent</div>
                    <div class="agent-type">Deep Q-Network</div>
                    <span class="agent-signal hold" id="dqnSignal">HOLD</span>
                    <div class="agent-confidence">
                        <div style="display:flex;justify-content:space-between;font-size:12px;"><span>Confidence</span><span id="dqnConf">62%</span></div>
                        <div class="conf-bar"><div class="conf-fill med" id="dqnConfBar" style="width:62%"></div></div>
                    </div>
                    <div class="agent-details">
                        <div class="detail-row"><span class="detail-label">Q(CALL)</span><span class="detail-value" id="dqnQCall">0.72</span></div>
                        <div class="detail-row"><span class="detail-label">Q(PUT)</span><span class="detail-value" id="dqnQPut">0.18</span></div>
                        <div class="detail-row"><span class="detail-label">Q(HOLD)</span><span class="detail-value" id="dqnQHold">0.10</span></div>
                        <div style="margin-top:8px;font-size:11px;color:var(--primary);">Click for full RL details ‚Üí</div>
                    </div>
                </div>
                <!-- 3-Wave Agent -->
                <div class="agent-card neutral" onclick="toggleAgent(this)">
                    <div class="agent-icon">üåä</div>
                    <div class="agent-name">3-Wave System</div>
                    <div class="agent-type">Profit Targets</div>
                    <span class="agent-signal hold" id="waveSignal">HOLD</span>
                    <div class="agent-confidence">
                        <div style="display:flex;justify-content:space-between;font-size:12px;"><span>Confidence</span><span id="waveConf">55%</span></div>
                        <div class="conf-bar"><div class="conf-fill med" id="waveConfBar" style="width:55%"></div></div>
                    </div>
                    <div class="agent-details">
                        <div class="detail-row"><span class="detail-label">Target 1</span><span class="detail-value positive" id="waveT1">--</span></div>
                        <div class="detail-row"><span class="detail-label">Target 2</span><span class="detail-value positive" id="waveT2">--</span></div>
                        <div class="detail-row"><span class="detail-label">Target 3</span><span class="detail-value positive" id="waveT3">--</span></div>
                        <div class="detail-row"><span class="detail-label">Stop Loss</span><span class="detail-value negative" id="waveStop">--</span></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <div class="card-title"><span class="icon">üìà</span> <span class="symbolTag">SPY</span> Price Chart (60 Days)</div>
                    <div class="chart-box"><canvas id="priceChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-title"><span class="icon">üó≥Ô∏è</span> Recent Voting Log</div>
                    <div class="table-wrap" style="max-height:300px;overflow-y:auto;">
                        <table>
                            <thead><tr><th>Date</th><th>Base</th><th>Gann</th><th>DQN</th><th>Result</th></tr></thead>
                            <tbody id="votingLogTable"><tr><td colspan="5" class="empty-state">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- AGENTS TAB -->
        <div id="agents" class="tab-content">
            <div class="card">
                <div class="card-title"><span class="icon">‚öôÔ∏è</span> Agent Configuration for <span class="symbolTag">SPY</span></div>
                <div id="tuningDisplay"><div class="empty-state">Loading tuning data...</div></div>
            </div>
        </div>

        <!-- SIGNALS TAB -->
        <div id="signals" class="tab-content">
            <div class="grid grid-4" style="margin-bottom:20px;">
                <div class="metric"><div class="metric-label">Total Signals</div><div class="metric-value" id="totalSignals3Y">--</div></div>
                <div class="metric"><div class="metric-label">ULTRA (4/4)</div><div class="metric-value positive" id="ultraCount">--</div></div>
                <div class="metric"><div class="metric-label">SUPER (3/4)</div><div class="metric-value" style="color:var(--primary)" id="superCount">--</div></div>
                <div class="metric"><div class="metric-label">Win Rate</div><div class="metric-value" id="signalWinRate">--</div></div>
            </div>
            <div class="card">
                <div class="card-title"><span class="icon">üìú</span> Historical Signals for <span class="symbolTag">SPY</span></div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Date</th><th>Signal</th><th>Level</th><th>Base</th><th>Gann</th><th>DQN</th><th>Entry</th><th>Stop</th><th>Target</th></tr></thead>
                        <tbody id="signalHistoryTable"><tr><td colspan="9" class="empty-state">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TRADES TAB -->
        <div id="trades" class="tab-content">
            <div class="grid grid-5" style="margin-bottom:20px;">
                <div class="metric"><div class="metric-label">Total Trades</div><div class="metric-value" id="totalTrades">--</div></div>
                <div class="metric"><div class="metric-label">Win Rate</div><div class="metric-value" id="winRate">--</div></div>
                <div class="metric"><div class="metric-label">Total P&L</div><div class="metric-value" id="totalPnl">--</div></div>
                <div class="metric"><div class="metric-label">Avg Win</div><div class="metric-value positive" id="avgWin">--</div></div>
                <div class="metric"><div class="metric-label">Avg Loss</div><div class="metric-value negative" id="avgLoss">--</div></div>
            </div>
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-title"><span class="icon">‚ûï</span> Log New Trade</div>
                    <form id="tradeForm" onsubmit="logTrade(event)">
                        <div class="form-row">
                            <div class="form-group"><label>Type</label><select id="tradeType"><option value="paper">üìù Paper</option><option value="live">üí∞ Live</option></select></div>
                            <div class="form-group"><label>Symbol</label><input type="text" id="tradeSymbol" value="SPY"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Direction</label><select id="tradeDirection"><option value="CALL">üìà CALL</option><option value="PUT">üìâ PUT</option></select></div>
                            <div class="form-group"><label>Entry Date</label><input type="date" id="tradeEntryDate"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Entry Price</label><input type="number" step="0.01" id="tradeEntryPrice" placeholder="$0.00"></div>
                            <div class="form-group"><label>Size ($)</label><input type="number" step="0.01" id="tradeSize" placeholder="$1000"></div>
                        </div>
                        <div class="form-group"><label>Notes</label><textarea id="tradeNotes" rows="2"></textarea></div>
                        <button type="submit" class="btn btn-primary" style="width:100%;">Log Trade</button>
                    </form>
                </div>
                <div class="card">
                    <div class="card-title"><span class="icon">üìã</span> My Trades</div>
                    <div class="table-wrap" style="max-height:400px;overflow-y:auto;">
                        <table>
                            <thead><tr><th>Date</th><th>Symbol</th><th>Dir</th><th>Entry</th><th>P&L</th><th>Type</th></tr></thead>
                            <tbody id="myTradesTable"><tr><td colspan="6" class="empty-state">No trades logged</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- MARKET TAB -->
        <div id="market" class="tab-content">
            <div class="card">
                <div class="card-title"><span class="icon">üåç</span> Market Conditions</div>
                <div class="grid grid-3" id="marketGrid">
                    <div class="condition-card">
                        <div class="condition-icon">üìà</div>
                        <div class="condition-info"><div class="condition-label">VIX Estimate</div><div class="condition-value" id="vixValue">--</div></div>
                        <span class="condition-badge" id="vixBadge" style="background:var(--warning);color:white;">--</span>
                    </div>
                    <div class="condition-card">
                        <div class="condition-icon">üéØ</div>
                        <div class="condition-info"><div class="condition-label">Trade Allowed</div><div class="condition-value" id="tradeAllowed">--</div></div>
                        <span class="condition-badge" id="tradeBadge">--</span>
                    </div>
                    <div class="condition-card">
                        <div class="condition-icon">üòä</div>
                        <div class="condition-info"><div class="condition-label">Sentiment</div><div class="condition-value" id="sentiment">--</div></div>
                        <span class="condition-badge" id="sentimentBadge">--</span>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-title"><span class="icon">üìã</span> Full Market Data</div>
                <pre id="marketJson" style="background:var(--bg);padding:15px;border-radius:8px;font-size:12px;max-height:300px;overflow:auto;">Loading...</pre>
            </div>
        </div>

        <!-- SECTORS TAB -->
        <div id="sectors" class="tab-content">
            <div class="card">
                <div class="card-title"><span class="icon">üîÑ</span> Sector Performance</div>
                <div id="sectorBars"><div class="empty-state">Loading sectors...</div></div>
            </div>
            <div class="grid grid-2">
                <div class="card"><div class="card-title" style="color:var(--success);">üìà Top Sectors</div><div id="topSectors"><div class="empty-state">Loading...</div></div></div>
                <div class="card"><div class="card-title" style="color:var(--danger);">üìâ Bottom Sectors</div><div id="bottomSectors"><div class="empty-state">Loading...</div></div></div>
            </div>
        </div>

        <!-- ETF TAB -->
        <div id="etf" class="tab-content">
            <div class="card">
                <div class="card-title"><span class="icon">üì¶</span> ETF Holdings for <span class="symbolTag">SPY</span></div>
            </div>
            <div class="grid grid-2">
                <div class="card"><div class="card-title" style="color:var(--success);">üöÄ Top 3 Holdings</div><div id="topHoldings"><div class="empty-state">Loading...</div></div></div>
                <div class="card"><div class="card-title" style="color:var(--danger);">üìâ Bottom 3 Holdings</div><div id="bottomHoldings"><div class="empty-state">Loading...</div></div></div>
            </div>
            <div class="card">
                <div class="card-title"><span class="icon">üìä</span> Holdings Data</div>
                <pre id="holdingsJson" style="background:var(--bg);padding:15px;border-radius:8px;font-size:12px;max-height:300px;overflow:auto;">Loading...</pre>
            </div>
        </div>

        <!-- ANALYTICS TAB -->
        <div id="analytics" class="tab-content">
            <div class="grid grid-4" style="margin-bottom:20px;">
                <div class="metric"><div class="metric-label">Sharpe Ratio</div><div class="metric-value" id="sharpeRatio">--</div></div>
                <div class="metric"><div class="metric-label">Max Drawdown</div><div class="metric-value negative" id="maxDrawdown">--</div></div>
                <div class="metric"><div class="metric-label">Profit Factor</div><div class="metric-value" id="profitFactor">--</div></div>
                <div class="metric"><div class="metric-label">Avg R</div><div class="metric-value" id="avgR">--</div></div>
            </div>
            <div class="grid grid-2">
                <div class="card"><div class="card-title"><span class="icon">üìä</span> Win Rate by Agent</div><div class="chart-box"><canvas id="winRateChart"></canvas></div></div>
                <div class="card"><div class="card-title"><span class="icon">üìà</span> Confluence Distribution</div><div class="chart-box"><canvas id="confluenceChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <!-- RL Modal -->
    <div class="modal" id="rlModal" onclick="if(event.target===this)closeModal()">
        <div class="modal-content">
            <div class="modal-header"><span class="modal-title">üß† DQN/RL Agent Details</span><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <div class="modal-body">
                <div class="card" style="margin-bottom:15px;">
                    <div class="card-title">Network Architecture</div>
                    <div class="detail-row"><span class="detail-label">Input</span><span class="detail-value">30 features</span></div>
                    <div class="detail-row"><span class="detail-label">Hidden</span><span class="detail-value">[128, 64, 32] + ReLU</span></div>
                    <div class="detail-row"><span class="detail-label">Output</span><span class="detail-value">3 (Buy/Sell/Hold)</span></div>
                </div>
                <div class="card" style="margin-bottom:15px;">
                    <div class="card-title">Training</div>
                    <div class="detail-row"><span class="detail-label">Episodes</span><span class="detail-value">2,500 / 10,000</span></div>
                    <div class="progress" style="margin:10px 0;"><div class="progress-fill" style="width:25%"></div></div>
                    <div class="detail-row"><span class="detail-label">Avg Reward</span><span class="detail-value positive">+182.4</span></div>
                </div>
                <div class="card">
                    <div class="card-title">Q-Values</div>
                    <div class="detail-row"><span class="detail-label">Q(CALL)</span><span class="detail-value positive" id="modalQCall">0.72</span></div>
                    <div class="detail-row"><span class="detail-label">Q(PUT)</span><span class="detail-value" id="modalQPut">0.18</span></div>
                    <div class="detail-row"><span class="detail-label">Q(HOLD)</span><span class="detail-value" id="modalQHold">0.10</span></div>
                </div>
            </div>
        </div>
    </div>

<script>
// Symbol names mapping
const SYMBOL_NAMES = {
    'SPY': 'S&P 500 ETF', 'QQQ': 'Nasdaq 100 ETF', 'IWM': 'Russell 2000 ETF', 'DIA': 'Dow Jones ETF',
    'XLK': 'Technology Sector', 'XLF': 'Financials Sector', 'XLV': 'Healthcare Sector',
    'XLE': 'Energy Sector', 'XLI': 'Industrials Sector', 'XLP': 'Consumer Staples',
    'XLY': 'Consumer Discretionary', 'XLU': 'Utilities Sector', 'XLB': 'Materials Sector', 'XLRE': 'Real Estate Sector'
};

let priceChart, winRateChart, confluenceChart;
let currentData = [], trades = [], myTrades = [];
let currentSymbol = 'SPY';

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    initTabs();
    loadMyTrades();
    loadAllData();
    setInterval(loadAllData, 60000);
});

function initTabs() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(btn.dataset.tab).classList.add('active');
            btn.classList.add('active');
        };
    });
}

function parseCSV(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return [];
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
        const values = line.split(',');
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i]?.trim() || '');
        return obj;
    });
}

async function loadJSON(path) {
    try {
        const r = await fetch(path + '?t=' + Date.now());
        if (r.ok) return await r.json();
    } catch(e) {}
    return null;
}

function showLoading(show, msg = 'Loading data...') {
    document.getElementById('loadingOverlay').classList.toggle('active', show);
    document.getElementById('loadingText').textContent = msg;
}

function setStatus(online) {
    const badge = document.getElementById('statusBadge');
    badge.className = 'status-badge ' + (online ? 'online' : 'offline');
    document.getElementById('statusText').textContent = online ? 'ONLINE' : 'OFFLINE';
}

function updateSymbolTags() {
    document.querySelectorAll('.symbolTag').forEach(el => el.textContent = currentSymbol);
    document.getElementById('currentSymbolDisplay').textContent = currentSymbol;
    document.getElementById('currentSymbolName').textContent = SYMBOL_NAMES[currentSymbol] || currentSymbol;
    document.getElementById('tradeSymbol').value = currentSymbol;
}

function changeSymbol() {
    currentSymbol = document.getElementById('symbolSelect').value;
    updateSymbolTags();
    loadAllData();
}

function toggleAgent(card) { card.classList.toggle('expanded'); }
function openRLModal() { document.getElementById('rlModal').classList.add('active'); }
function closeModal() { document.getElementById('rlModal').classList.remove('active'); }

async function loadAllData() {
    showLoading(true, `Loading ${currentSymbol} data...`);
    updateSymbolTags();
    
    try {
        // Try to load selected symbol's CSV
        let r = await fetch(`data/${currentSymbol}.csv?t=${Date.now()}`).catch(() => null);
        if (!r?.ok) r = await fetch(`data/${currentSymbol}_confluence.csv?t=${Date.now()}`).catch(() => null);
        
        // Fallback to SPY if symbol not found
        if (!r?.ok && currentSymbol !== 'SPY') {
            console.log(`${currentSymbol} data not found, loading SPY as fallback`);
            r = await fetch('data/SPY.csv?t=' + Date.now()).catch(() => null);
            if (!r?.ok) r = await fetch('data/SPY_confluence.csv?t=' + Date.now()).catch(() => null);
        }
        
        if (r?.ok) {
            currentData = parseCSV(await r.text());
            if (currentData.length) {
                const lat = currentData[currentData.length - 1];
                const prev = currentData[currentData.length - 2] || lat;
                const price = parseFloat(lat.Close) || 0;
                const prevPrice = parseFloat(prev.Close) || price;
                const chg = price - prevPrice;
                const pct = prevPrice ? (chg / prevPrice * 100) : 0;

                // Update price display
                document.getElementById('currentPrice').textContent = '$' + price.toFixed(2);
                document.getElementById('priceSource').textContent = `${currentData.length} bars loaded`;
                document.getElementById('dailyChange').textContent = (chg >= 0 ? '+' : '') + chg.toFixed(2);
                document.getElementById('dailyChange').className = 'metric-value ' + (chg >= 0 ? 'positive' : 'negative');
                document.getElementById('changePct').textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
                
                // Volume
                const vol = parseFloat(lat.Volume) || 0;
                document.getElementById('volumeDisplay').textContent = (vol / 1e6).toFixed(2) + 'M';

                // Separate Date and Time
                const dateStr = lat.Date || '';
                if (dateStr.includes('T')) {
                    const [datePart, timePart] = dateStr.split('T');
                    document.getElementById('dataDate').textContent = datePart;
                    document.getElementById('dataTime').textContent = timePart.replace('Z', '') || 'EOD';
                } else {
                    document.getElementById('dataDate').textContent = dateStr;
                    document.getElementById('dataTime').textContent = 'EOD';
                }
                document.getElementById('lastRefresh').textContent = new Date().toLocaleTimeString();

                // Agent details
                if (lat.FastSMA) document.getElementById('baseFastSMA').textContent = '$' + parseFloat(lat.FastSMA).toFixed(2);
                if (lat.SlowSMA) document.getElementById('baseSlowSMA').textContent = '$' + parseFloat(lat.SlowSMA).toFixed(2);
                if (lat.ATR) document.getElementById('baseATR').textContent = parseFloat(lat.ATR).toFixed(2);
                if (lat.Bias) document.getElementById('baseBias').textContent = lat.Bias;
                if (lat.GeoLevel) document.getElementById('gannGeo').textContent = '$' + parseFloat(lat.GeoLevel).toFixed(2);
                if (lat.PhiLevel) document.getElementById('gannPhi').textContent = '$' + parseFloat(lat.PhiLevel).toFixed(2);
                if (lat.PriceConfluence) document.getElementById('gannPriceConf').textContent = lat.PriceConfluence;
                if (lat.TimeConfluence) document.getElementById('gannTimeConf').textContent = lat.TimeConfluence;

                // Signal
                const bias = (lat.Bias || '').toUpperCase();
                document.getElementById('signalStatus').textContent = bias || 'NEUTRAL';
                document.getElementById('signalConf').textContent = `Confluence: ${lat.PriceConfluence || 0}/4`;

                setStatus(true);
                updatePriceChart();
                updateSignalHistory();
            }
        } else {
            setStatus(false);
            document.getElementById('currentPrice').textContent = 'N/A';
            document.getElementById('priceSource').textContent = `No data for ${currentSymbol}`;
        }

        // Load trades
        await loadTrades();
        
        // Load other data (these are global, not per-symbol)
        await loadMarketConditions();
        await loadSectorData();
        await loadETFHoldings();
        await loadVotingLog();
        await loadTuning();
        
        initCharts();

    } catch (e) {
        console.error('Error:', e);
        setStatus(false);
    }
    
    showLoading(false);
}

async function loadTrades() {
    let r = await fetch('data/portfolio_confluence.csv?t=' + Date.now()).catch(() => null);
    if (!r?.ok) r = await fetch('reports/portfolio_confluence.csv?t=' + Date.now()).catch(() => null);
    
    if (r?.ok) {
        trades = parseCSV(await r.text());
        const closed = trades.filter(t => t.PNL && !isNaN(parseFloat(t.PNL)));
        const wins = closed.filter(t => parseFloat(t.PNL) > 0);
        const losses = closed.filter(t => parseFloat(t.PNL) < 0);
        const winRate = closed.length ? (wins.length / closed.length * 100) : 0;
        const totalPnl = closed.reduce((s, t) => s + (parseFloat(t.PNL) || 0), 0);
        const avgWin = wins.length ? wins.reduce((s, t) => s + parseFloat(t.PNL), 0) / wins.length : 0;
        const avgLoss = losses.length ? Math.abs(losses.reduce((s, t) => s + parseFloat(t.PNL), 0) / losses.length) : 0;

        document.getElementById('totalTrades').textContent = trades.length;
        document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
        document.getElementById('winRate').className = 'metric-value ' + (winRate >= 50 ? 'positive' : 'negative');
        document.getElementById('totalPnl').textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2);
        document.getElementById('totalPnl').className = 'metric-value ' + (totalPnl >= 0 ? 'positive' : 'negative');
        document.getElementById('avgWin').textContent = '+$' + avgWin.toFixed(2);
        document.getElementById('avgLoss').textContent = '-$' + avgLoss.toFixed(2);
    }
}

async function loadMarketConditions() {
    const data = await loadJSON('data/market_conditions.json');
    if (!data) return;

    const vol = data.conditions?.volatility || {};
    const sent = data.conditions?.sentiment || {};

    document.getElementById('vixValue').textContent = vol.vix_estimate ? vol.vix_estimate.toFixed(1) : '--';
    document.getElementById('vixBadge').textContent = vol.level || '--';
    document.getElementById('tradeAllowed').textContent = data.trade_allowed ? 'YES' : 'NO';
    document.getElementById('tradeBadge').textContent = data.trade_allowed ? 'ACTIVE' : 'PAUSED';
    document.getElementById('tradeBadge').style.background = data.trade_allowed ? 'var(--success)' : 'var(--danger)';
    document.getElementById('tradeBadge').style.color = 'white';
    document.getElementById('sentiment').textContent = sent.sentiment || '--';
    document.getElementById('sentimentBadge').textContent = sent.sentiment || '--';
    document.getElementById('marketJson').textContent = JSON.stringify(data, null, 2);
}

async function loadSectorData() {
    const data = await loadJSON('data/sector_rotation.json');
    const container = document.getElementById('sectorBars');
    const topC = document.getElementById('topSectors');
    const bottomC = document.getElementById('bottomSectors');

    if (!data) {
        container.innerHTML = '<div class="empty-state">No sector data</div>';
        return;
    }

    let sectors = [];
    if (data.sectors) {
        sectors = Object.entries(data.sectors).map(([sym, info]) => ({
            symbol: sym, name: info.name || sym, perf: info.performance_1m || info.performance || 0
        })).sort((a, b) => b.perf - a.perf);
    }

    if (!sectors.length) {
        container.innerHTML = '<pre style="background:var(--bg);padding:15px;border-radius:8px;font-size:12px;">' + JSON.stringify(data, null, 2) + '</pre>';
        return;
    }

    const maxP = Math.max(...sectors.map(s => Math.abs(s.perf)), 5);
    container.innerHTML = sectors.map(s => {
        const w = Math.min(Math.abs(s.perf) / maxP * 100, 100);
        const pos = s.perf >= 0;
        return `<div class="sector-item"><div class="sector-header"><span class="sector-name">${s.symbol}</span><span class="sector-perf ${pos ? 'positive' : 'negative'}">${pos ? '+' : ''}${s.perf.toFixed(2)}%</span></div><div class="sector-bar"><div class="sector-fill ${pos ? 'positive' : 'negative'}" style="width:${w}%"></div></div></div>`;
    }).join('');

    topC.innerHTML = sectors.slice(0, 3).map((s, i) => `<div class="holding-item"><div class="holding-info"><div class="holding-rank top">${i + 1}</div><div><div class="holding-symbol">${s.symbol}</div><div class="holding-name">${s.name}</div></div></div><div class="holding-perf positive">+${s.perf.toFixed(2)}%</div></div>`).join('');
    bottomC.innerHTML = sectors.slice(-3).reverse().map((s, i) => `<div class="holding-item"><div class="holding-info"><div class="holding-rank bottom">${i + 1}</div><div><div class="holding-symbol">${s.symbol}</div><div class="holding-name">${s.name}</div></div></div><div class="holding-perf negative">${s.perf.toFixed(2)}%</div></div>`).join('');
}

async function loadETFHoldings() {
    const data = await loadJSON('data/etf_holdings_analysis.json');
    const topC = document.getElementById('topHoldings');
    const bottomC = document.getElementById('bottomHoldings');
    const json = document.getElementById('holdingsJson');

    if (!data) {
        topC.innerHTML = bottomC.innerHTML = '<div class="empty-state">No data</div>';
        return;
    }

    json.textContent = JSON.stringify(data, null, 2);
    let holdings = Array.isArray(data) ? data : (data.holdings || data.top_holdings || []);
    if (!holdings.length) return;

    const sorted = [...holdings].sort((a, b) => (b.performance || b.change || 0) - (a.performance || a.change || 0));
    topC.innerHTML = sorted.slice(0, 3).map((h, i) => {
        const p = h.performance || h.change || 0;
        return `<div class="holding-item"><div class="holding-info"><div class="holding-rank top">${i + 1}</div><div><div class="holding-symbol">${h.symbol || h.ticker}</div><div class="holding-name">${h.name || ''}</div></div></div><div class="holding-perf positive">+${p.toFixed(2)}%</div></div>`;
    }).join('');
    bottomC.innerHTML = sorted.slice(-3).reverse().map((h, i) => {
        const p = h.performance || h.change || 0;
        return `<div class="holding-item"><div class="holding-info"><div class="holding-rank bottom">${i + 1}</div><div><div class="holding-symbol">${h.symbol || h.ticker}</div><div class="holding-name">${h.name || ''}</div></div></div><div class="holding-perf negative">${p.toFixed(2)}%</div></div>`;
    }).join('');
}

async function loadVotingLog() {
    const data = await loadJSON('data/voting_log.json');
    const tbody = document.getElementById('votingLogTable');
    if (!data) { tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No voting data</td></tr>'; return; }

    const votes = Array.isArray(data) ? data.slice(-10) : (data.votes || data.log || []).slice(-10);
    if (!votes.length) { tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No votes</td></tr>'; return; }

    tbody.innerHTML = votes.reverse().map(v => {
        const base = v.base || v.base_confluence || '--';
        const gann = v.gann || v.gann_elliott || '--';
        const dqn = v.dqn || v.rl_dqn || '--';
        const result = v.result || v.consensus || v.majority || '--';
        const date = (v.timestamp || v.date || '--').split('T')[0];
        return `<tr><td>${date}</td><td><span class="badge badge-${base === 'CALL' ? 'success' : 'danger'}">${base}</span></td><td><span class="badge badge-${gann === 'CALL' ? 'success' : 'danger'}">${gann}</span></td><td><span class="badge badge-info">${dqn}</span></td><td><strong>${result}</strong></td></tr>`;
    }).join('');
}

async function loadTuning() {
    const data = await loadJSON('data/tuning_confluence.json');
    const container = document.getElementById('tuningDisplay');
    if (!data) { container.innerHTML = '<div class="empty-state">No tuning data</div>'; return; }
    container.innerHTML = '<pre style="background:var(--bg);padding:15px;border-radius:8px;font-size:12px;max-height:400px;overflow:auto;">' + JSON.stringify(data, null, 2) + '</pre>';
}

function updateSignalHistory() {
    const tbody = document.getElementById('signalHistoryTable');
    if (!currentData.length) { tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No data</td></tr>'; return; }

    const signals = currentData.filter(d => d.Bias && d.Bias !== '').slice(-100);
    document.getElementById('totalSignals3Y').textContent = signals.length;
    document.getElementById('ultraCount').textContent = signals.filter(s => parseInt(s.PriceConfluence) >= 4).length;
    document.getElementById('superCount').textContent = signals.filter(s => parseInt(s.PriceConfluence) >= 3).length;

    tbody.innerHTML = signals.reverse().slice(0, 50).map(s => {
        const sig = (s.Bias || '').toUpperCase();
        const conf = parseInt(s.PriceConfluence) || 0;
        const level = conf >= 4 ? 'ULTRA' : (conf >= 3 ? 'SUPER' : 'BASIC');
        const price = parseFloat(s.Close) || 0;
        const atr = parseFloat(s.ATR) || 0;
        const stop = sig === 'CALL' ? price - atr : price + atr;
        const target = sig === 'CALL' ? price + (atr * 2) : price - (atr * 2);
        return `<tr>
            <td>${(s.Date || '').split('T')[0]}</td>
            <td><span class="badge badge-${sig === 'CALL' ? 'success' : 'danger'}">${sig || 'HOLD'}</span></td>
            <td><span class="badge badge-${level === 'ULTRA' ? 'ultra' : (level === 'SUPER' ? 'super' : 'info')}">${level}</span></td>
            <td><span class="badge badge-${sig === 'CALL' ? 'success' : 'warning'}">${sig || '--'}</span></td>
            <td><span class="badge badge-${sig === 'CALL' ? 'success' : 'warning'}">${sig || '--'}</span></td>
            <td><span class="badge badge-info">ML</span></td>
            <td>$${price.toFixed(2)}</td>
            <td style="color:var(--danger)">$${stop.toFixed(2)}</td>
            <td style="color:var(--success)">$${target.toFixed(2)}</td>
        </tr>`;
    }).join('');
}

function updatePriceChart() {
    if (!currentData.length) return;
    const data = currentData.slice(-60);
    const ctx = document.getElementById('priceChart');
    if (priceChart) priceChart.destroy();

    priceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => (d.Date || '').split('T')[0].slice(5)),
            datasets: [{ label: currentSymbol, data: data.map(d => parseFloat(d.Close) || 0), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4, pointRadius: 2 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v => '$' + v } } } }
    });
}

function initCharts() {
    const wrCtx = document.getElementById('winRateChart');
    if (wrCtx && !wrCtx.dataset.init) {
        winRateChart = new Chart(wrCtx, {
            type: 'bar',
            data: { labels: ['Base', 'Gann', 'DQN', '3-Wave', 'SUPER', 'ULTRA'], datasets: [{ label: 'Win %', data: [65, 72, 62, 71, 78, 89], backgroundColor: ['#3b82f6', '#8b5cf6', '#06b6d4', '#f59e0b', '#10b981', '#059669'] }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
        wrCtx.dataset.init = '1';
    }

    const cfCtx = document.getElementById('confluenceChart');
    if (cfCtx && !cfCtx.dataset.init) {
        confluenceChart = new Chart(cfCtx, {
            type: 'doughnut',
            data: { labels: ['ULTRA', 'SUPER', 'Basic', 'None'], datasets: [{ data: [15, 35, 30, 20], backgroundColor: ['#059669', '#3b82f6', '#f59e0b', '#94a3b8'] }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
        cfCtx.dataset.init = '1';
    }
}

// Trade logging
function logTrade(e) {
    e.preventDefault();
    const trade = {
        id: Date.now(),
        type: document.getElementById('tradeType').value,
        symbol: document.getElementById('tradeSymbol').value,
        direction: document.getElementById('tradeDirection').value,
        entryDate: document.getElementById('tradeEntryDate').value,
        entryPrice: parseFloat(document.getElementById('tradeEntryPrice').value),
        size: parseFloat(document.getElementById('tradeSize').value) || 1000,
        notes: document.getElementById('tradeNotes').value,
        pnl: null, status: 'OPEN'
    };
    myTrades.push(trade);
    localStorage.setItem('myTrades', JSON.stringify(myTrades));
    document.getElementById('tradeForm').reset();
    document.getElementById('tradeSymbol').value = currentSymbol;
    renderMyTrades();
    alert('Trade logged!');
}

function loadMyTrades() {
    const saved = localStorage.getItem('myTrades');
    if (saved) myTrades = JSON.parse(saved);
    renderMyTrades();
}

function renderMyTrades() {
    const tbody = document.getElementById('myTradesTable');
    if (!myTrades.length) { tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No trades</td></tr>'; return; }
    tbody.innerHTML = [...myTrades].reverse().map(t => `<tr><td>${t.entryDate}</td><td>${t.symbol}</td><td><span class="badge badge-${t.direction === 'CALL' ? 'success' : 'danger'}">${t.direction}</span></td><td>$${t.entryPrice?.toFixed(2) || '--'}</td><td>${t.pnl !== null ? (t.pnl >= 0 ? '+' : '') + '$' + t.pnl.toFixed(2) : '--'}</td><td><span class="badge badge-${t.type === 'paper' ? 'info' : 'primary'}">${t.type}</span></td></tr>`).join('');
}
</script>
</body>
</html>
