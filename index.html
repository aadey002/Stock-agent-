<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Agent 4 - Q5D Options Trading Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #3b82f6; --secondary: #8b5cf6; --accent: #06b6d4;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #0891b2;
            --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0;
            --text: #1e293b; --muted: #64748b; --light: #94a3b8;
            --intraday: #f59e0b; --swing: #8b5cf6;
            --ai-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
        
        /* LOGIN SCREEN STYLES */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d1b4e 50%, #1a1a2e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .login-screen.hidden { display: none; }
        
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 420px;
            text-align: center;
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }
        
        .login-title {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        
        .login-subtitle {
            color: var(--muted);
            font-size: 14px;
            margin-bottom: 30px;
        }
        
        .login-form { text-align: left; }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            outline: none;
        }
        
        .form-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        .form-group input.error {
            border-color: var(--danger);
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }
        
        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .login-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }
        
        .login-error.show { display: block; }
        
        .login-footer {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--muted);
        }
        
        .login-footer a {
            color: var(--primary);
            text-decoration: none;
        }
        
        /* Remember me checkbox */
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .remember-me input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }
        
        .remember-me label {
            font-size: 13px;
            color: var(--muted);
            cursor: pointer;
        }
        
        /* Logout Button in Header */
        .logout-btn {
            padding: 5px 12px;
            background: rgba(239, 68, 68, 0.2);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 5px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.4);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
        }
        
        .user-avatar {
            width: 24px;
            height: 24px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Main app hidden until logged in */
        .main-app { display: none; }
        .main-app.visible { display: block; }
        
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 10px 0; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1600px; margin: 0 auto; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .logo h1 { font-size: 16px; font-weight: 700; }
        .logo p { font-size: 9px; opacity: 0.9; }
        
        .live-price-ticker { display: flex; align-items: center; gap: 12px; background: rgba(0,0,0,0.2); padding: 6px 14px; border-radius: 8px; }
        .ticker-symbol { font-size: 13px; font-weight: 700; }
        .ticker-price { font-size: 20px; font-weight: 800; }
        .ticker-change { font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
        .ticker-change.positive { background: rgba(16,185,129,0.3); }
        .ticker-change.negative { background: rgba(239,68,68,0.3); }
        
        .header-controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .status-badge { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 15px; font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .status-badge:hover { transform: scale(1.05); }
        .status-badge.online { background: rgba(16,185,129,0.3); }
        .status-badge.warning { background: rgba(245,158,11,0.3); }
        .status-badge.critical { background: rgba(239,68,68,0.3); }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        
        .symbol-select select { padding: 5px 8px; border: none; border-radius: 5px; font-size: 11px; background: rgba(255,255,255,0.9); cursor: pointer; font-weight: 600; }
        .refresh-btn { padding: 5px 12px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 5px; font-size: 11px; font-weight: 600; cursor: pointer; }
        
        .container { max-width: 1600px; margin: 0 auto; padding: 12px; }
        
        .mode-toggle-container { display: flex; justify-content: center; margin-bottom: 12px; }
        .mode-toggle { display: flex; background: var(--card); border-radius: 8px; padding: 3px; border: 1px solid var(--border); }
        .mode-btn { padding: 8px 20px; border: none; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 5px; }
        .mode-btn.intraday { background: transparent; color: var(--muted); }
        .mode-btn.swing { background: transparent; color: var(--muted); }
        .mode-btn.active.intraday { background: linear-gradient(135deg, var(--intraday), #d97706); color: white; }
        .mode-btn.active.swing { background: linear-gradient(135deg, var(--swing), #6d28d9); color: white; }
        
        .symbol-banner { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 8px 14px; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; font-size: 14px; }
        .symbol-banner.intraday-mode { background: linear-gradient(135deg, var(--intraday), #d97706); }
        .symbol-banner.swing-mode { background: linear-gradient(135deg, var(--swing), #6d28d9); }
        
        .tabs { display: flex; gap: 3px; background: var(--card); border-radius: 8px; padding: 4px; margin-bottom: 12px; overflow-x: auto; border: 1px solid var(--border); }
        .tab-btn { padding: 7px 12px; background: transparent; border: none; border-radius: 5px; color: var(--muted); font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .tab-btn:hover { color: var(--primary); background: rgba(59,130,246,0.05); }
        .tab-btn.active { color: white; background: var(--primary); }
        .tab-btn.ai-tab { background: var(--ai-gradient); color: white; }
        .tab-btn.ai-tab:not(.active) { background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2)); color: var(--secondary); }
        .tab-btn.health-tab { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .tab-btn.health-tab:not(.active) { background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.2)); color: var(--success); }
        .tab-btn.charts-tab { background: linear-gradient(135deg, #0891b2, #0e7490); color: white; }
        .tab-btn.charts-tab:not(.active) { background: linear-gradient(135deg, rgba(8,145,178,0.2), rgba(14,116,144,0.2)); color: var(--accent); }
        .tab-btn.analysis-tab { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .tab-btn.analysis-tab:not(.active) { background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(217,119,6,0.2)); color: var(--warning); }
        
                /* Enhanced Multi-Charts Styles */
        .multi-charts-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px; }
        @media (max-width: 1200px) { .multi-charts-container { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .multi-charts-container { grid-template-columns: 1fr; } }
        
        .mtf-summary { background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(139,92,246,0.05)); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .mtf-summary-title { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--text); }
        .mtf-summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        @media (max-width: 900px) { .mtf-summary-grid { grid-template-columns: repeat(2, 1fr); } }
        .mtf-summary-item { text-align: center; padding: 10px; background: white; border-radius: 8px; border: 1px solid var(--border); }
        .mtf-summary-item .title { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
        .mtf-summary-item .value { font-size: 18px; font-weight: 700; }
        .mtf-summary-item .value.bullish { color: var(--success); }
        .mtf-summary-item .value.bearish { color: var(--danger); }
        .mtf-summary-item .value.neutral { color: var(--warning); }
        
        .chart-panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .chart-panel-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--bg); border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 8px; }
        .chart-panel-title { display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 13px; }
        .chart-panel-title .icon { width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .chart-panel-title .icon.intraday { background: rgba(245,158,11,0.2); }
        .chart-panel-title .icon.swing { background: rgba(139,92,246,0.2); }
        .chart-panel-title .icon.position { background: rgba(16,185,129,0.2); }
        .chart-controls { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .chart-select { padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 10px; background: white; cursor: pointer; }
        .chart-body { position: relative; height: 350px; background: #fff; }
        .chart-canvas-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
        .chart-legend { position: absolute; top: 8px; left: 10px; z-index: 10; display: flex; align-items: center; gap: 8px; }
        .chart-legend .symbol { background: rgba(59,130,246,0.9); color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        .chart-legend .price { font-size: 13px; font-weight: 700; color: var(--success); }
        .chart-legend .price.down { color: var(--danger); }
        .chart-loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; color: var(--muted); display: none; }
        
        .signal-badge-mtf { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 8px; }
        .signal-badge-mtf.call { background: var(--success); color: white; }
        .signal-badge-mtf.put { background: var(--danger); color: white; }
        .signal-badge-mtf.hold { background: var(--warning); color: white; }
        
        .settings-btn-mtf { background: var(--secondary); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .settings-btn-mtf:hover { opacity: 0.9; }
        .settings-panel-mtf { display: none; background: var(--bg); border-top: 1px solid var(--border); padding: 10px 12px; font-size: 11px; }
        .settings-panel-mtf.show { display: block; }
        .settings-row-mtf { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .settings-row-mtf label { display: flex; align-items: center; gap: 4px; cursor: pointer; color: var(--muted); }
        .settings-row-mtf input[type="checkbox"] { width: 14px; height: 14px; accent-color: var(--primary); }
        
        .pattern-alert-mtf { margin: 0 12px 10px; padding: 8px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .pattern-alert-mtf.bullish { background: rgba(16,185,129,0.15); color: #059669; border-left: 3px solid var(--success); }
        .pattern-alert-mtf.bearish { background: rgba(239,68,68,0.15); color: #dc2626; border-left: 3px solid var(--danger); }
        
        .fib-levels-mtf { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; padding: 8px 12px; background: var(--bg); border-top: 1px solid var(--border); }
        .fib-level-mtf { padding: 4px 6px; border-radius: 4px; text-align: center; font-size: 9px; }
        .fib-level-mtf.support { background: rgba(16,185,129,0.1); color: var(--success); }
        .fib-level-mtf.resistance { background: rgba(239,68,68,0.1); color: var(--danger); }
        
        .mtf-legend { display: flex; gap: 12px; padding: 6px 12px; background: var(--bg); border-top: 1px solid var(--border); font-size: 10px; flex-wrap: wrap; }
        .legend-item-mtf { display: flex; align-items: center; gap: 4px; color: var(--muted); }
        .legend-color-mtf { width: 12px; height: 3px; border-radius: 2px; }


        /* Daily Analysis Styles */
        .daily-report { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 15px; }
        .report-header { background: linear-gradient(135deg, #1e3a5f 0%, #2d1b4e 50%, #1a1a2e 100%); color: white; padding: 20px; }
        .report-header h2 { font-size: 20px; margin-bottom: 5px; }
        .report-header .report-meta { font-size: 12px; opacity: 0.8; }
        .report-body { padding: 20px; }
        .report-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .report-section:last-child { margin-bottom: 0; border-bottom: none; }
        .report-section-title { font-size: 14px; font-weight: 700; color: var(--primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .signal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .signal-card { background: var(--bg); border-radius: 8px; padding: 12px; border-left: 4px solid var(--primary); }
        .signal-card.bullish { border-left-color: var(--success); }
        .signal-card.bearish { border-left-color: var(--danger); }
        .signal-card.neutral { border-left-color: var(--warning); }
        .signal-card-title { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
        .signal-card-value { font-size: 16px; font-weight: 700; }
        .signal-card-detail { font-size: 10px; color: var(--muted); margin-top: 4px; }
        .consensus-meter { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin: 8px 0; }
        .consensus-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .consensus-fill.high { background: linear-gradient(90deg, var(--success), #34d399); }
        .consensus-fill.medium { background: linear-gradient(90deg, var(--warning), #fbbf24); }
        .consensus-fill.low { background: linear-gradient(90deg, var(--danger), #f87171); }
        .trade-recommendation { background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.1)); border: 1px solid rgba(16,185,129,0.3); border-radius: 10px; padding: 15px; }
        .trade-recommendation.put { background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(220,38,38,0.1)); border-color: rgba(239,68,68,0.3); }
        .strike-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .strike-table th, .strike-table td { padding: 8px 12px; text-align: left; font-size: 12px; }
        .strike-table th { background: var(--bg); color: var(--muted); font-weight: 600; }
        .strike-table tr:hover { background: rgba(59,130,246,0.05); }
        .gann-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .gann-item { background: var(--bg); padding: 10px; border-radius: 6px; text-align: center; }
        .gann-item-label { font-size: 10px; color: var(--muted); }
        .gann-item-value { font-size: 14px; font-weight: 700; color: var(--secondary); }
        .phi-levels { display: flex; flex-wrap: wrap; gap: 8px; }
        .phi-level { background: rgba(139,92,246,0.1); padding: 6px 12px; border-radius: 20px; font-size: 11px; }
        .phi-level span { font-weight: 700; color: var(--secondary); }
        .report-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .report-btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .report-btn.primary { background: var(--primary); color: white; }
        .report-btn.secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
        .report-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .eod-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        @media (max-width: 768px) { .eod-summary { grid-template-columns: repeat(2, 1fr); } }
        .eod-metric { text-align: center; padding: 15px; background: var(--bg); border-radius: 8px; }
        .eod-metric-value { font-size: 24px; font-weight: 700; }
        .eod-metric-label { font-size: 11px; color: var(--muted); }
        
        /* Daily Analysis Styles */
        .analysis-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .analysis-time { display: flex; gap: 15px; align-items: center; }
        .analysis-time-btn { padding: 10px 20px; border: 2px solid var(--border); background: white; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .analysis-time-btn.active { border-color: var(--primary); background: var(--primary); color: white; }
        .analysis-time-btn:hover:not(.active) { border-color: var(--primary); }
        .report-actions { display: flex; gap: 10px; }
        .report-btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .report-btn.primary { background: var(--primary); color: white; }
        .report-btn.success { background: var(--success); color: white; }
        .report-btn.warning { background: var(--warning); color: white; }
        .signal-confluence-card { background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(139,92,246,0.05)); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .confluence-score { font-size: 48px; font-weight: 800; text-align: center; margin: 15px 0; }
        .confluence-score.bullish { color: var(--success); }
        .confluence-score.bearish { color: var(--danger); }
        .confluence-score.neutral { color: var(--warning); }
        .signal-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .signal-item { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
        .signal-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .signal-item-name { font-weight: 600; font-size: 12px; }
        .signal-item-score { font-weight: 700; font-size: 14px; padding: 4px 10px; border-radius: 4px; }
        .signal-item-score.bullish { background: rgba(16,185,129,0.1); color: var(--success); }
        .signal-item-score.bearish { background: rgba(239,68,68,0.1); color: var(--danger); }
        .signal-item-score.neutral { background: rgba(245,158,11,0.1); color: var(--warning); }
        .signal-item-detail { font-size: 11px; color: var(--muted); }
        .trading-plan { background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .trading-plan-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 15px 20px; }
        .trading-plan-body { padding: 20px; }
        .plan-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .plan-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .plan-section-title { font-weight: 700; font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .trade-recommendation { background: rgba(16,185,129,0.05); border: 1px solid rgba(16,185,129,0.2); border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .trade-recommendation.put { background: rgba(239,68,68,0.05); border-color: rgba(239,68,68,0.2); }
        .trade-rec-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .trade-rec-symbol { font-weight: 700; font-size: 16px; }
        .trade-rec-signal { padding: 4px 12px; border-radius: 4px; font-weight: 600; font-size: 12px; }
        .trade-rec-signal.call { background: var(--success); color: white; }
        .trade-rec-signal.put { background: var(--danger); color: white; }
        .trade-rec-details { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 11px; }
        .trade-rec-detail { text-align: center; }
        .trade-rec-detail-label { color: var(--muted); }
        .trade-rec-detail-value { font-weight: 600; margin-top: 2px; }
        .gann-analysis { background: linear-gradient(135deg, rgba(139,92,246,0.05), rgba(168,85,247,0.05)); border-radius: 8px; padding: 15px; }
        .phi-levels { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .phi-level { text-align: center; padding: 10px; background: white; border-radius: 6px; }
        .phi-level-name { font-size: 10px; color: var(--muted); }
        .phi-level-value { font-weight: 700; font-size: 14px; color: var(--secondary); }

        /* Gann Analysis Tab Styles */
        #gann-analysis { position: relative; }
        .gann-background-pattern {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 50% 50%, rgba(212,160,23,0.03) 0%, transparent 50%),
                linear-gradient(0deg, transparent 49.5%, rgba(212,160,23,0.05) 50%, transparent 50.5%),
                linear-gradient(90deg, transparent 49.5%, rgba(212,160,23,0.05) 50%, transparent 50.5%);
            background-size: 100% 100%, 50px 50px, 50px 50px;
            pointer-events: none;
            z-index: 0;
        }
        .gann-card { position: relative; z-index: 1; }
        .gann-confluence-card .gann-glow {
            animation: gannPulse 2s ease-in-out infinite;
        }
        @keyframes gannPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(212,160,23,0.3); }
            50% { box-shadow: 0 0 25px rgba(212,160,23,0.6); }
        }
        .gann-tab:hover { filter: brightness(1.1); }
        .cycle-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.05);
            padding: 6px 10px;
            border-radius: 6px;
        }
        .cycle-bar-label {
            font-size: 10px;
            min-width: 80px;
            color: var(--muted);
        }
        .cycle-bar-track {
            flex: 1;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        .cycle-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .cycle-bar-value {
            font-size: 10px;
            font-weight: 600;
            min-width: 50px;
            text-align: right;
        }
        .angle-badge {
            background: rgba(212,160,23,0.1);
            border: 1px solid rgba(212,160,23,0.2);
            border-radius: 4px;
            padding: 4px 6px;
            text-align: center;
        }
        .angle-badge.active {
            background: rgba(212,160,23,0.3);
            border-color: #d4a017;
        }
        .angle-badge-name {
            font-size: 9px;
            color: var(--muted);
        }
        .angle-badge-value {
            font-size: 11px;
            font-weight: 600;
            color: var(--text);
        }
        .sacred-number {
            background: rgba(245,158,11,0.1);
            border: 1px solid rgba(245,158,11,0.2);
            border-radius: 4px;
            padding: 6px;
            text-align: center;
        }
        .sacred-number-value {
            font-size: 14px;
            font-weight: 700;
            color: #f59e0b;
        }
        .sacred-number-label {
            font-size: 8px;
            color: var(--muted);
        }
        .confluence-factor {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.03);
            border-radius: 6px;
        }
        .confluence-factor-icon {
            font-size: 16px;
            width: 24px;
            text-align: center;
        }
        .confluence-factor-text {
            flex: 1;
            font-size: 11px;
        }
        .confluence-factor-score {
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .confluence-factor-score.active {
            background: rgba(34,197,94,0.2);
            color: #22c55e;
        }
        .confluence-factor-score.inactive {
            background: rgba(107,114,128,0.1);
            color: var(--muted);
        }
        .sq9-level {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px dashed rgba(0,0,0,0.05);
        }
        .sq9-level:last-child { border-bottom: none; }
        .sq9-angle { color: var(--muted); }
        .sq9-price { font-weight: 600; }
        .sq9-diff { font-size: 9px; color: var(--muted); }
        .gann-date-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            background: rgba(255,255,255,0.5);
            border-radius: 4px;
        }
        .gann-date-item.near {
            background: rgba(245,158,11,0.2);
            border: 1px solid #f59e0b;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 14px; margin-bottom: 12px; }
        .card-title { font-size: 14px; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        
        .grid { display: grid; gap: 12px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
        .grid-5 { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
        
        .metric { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 10px; }
        .metric-label { font-size: 9px; font-weight: 600; color: var(--muted); text-transform: uppercase; margin-bottom: 4px; }
        .metric-value { font-size: 18px; font-weight: 700; }
        .metric-value.positive { color: var(--success); }
        .metric-value.negative { color: var(--danger); }
        .metric-sub { font-size: 9px; color: var(--light); margin-top: 2px; }
        
        .badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600; text-transform: uppercase; }
        .badge-success { background: rgba(16,185,129,0.15); color: var(--success); }
        .badge-danger { background: rgba(239,68,68,0.15); color: var(--danger); }
        .badge-warning { background: rgba(245,158,11,0.15); color: var(--warning); }
        .badge-info { background: rgba(8,145,178,0.15); color: var(--info); }
        .badge-primary { background: rgba(59,130,246,0.15); color: var(--primary); }
        .badge-ultra { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .badge-intraday { background: linear-gradient(135deg, var(--intraday), #d97706); color: white; }
        .badge-swing { background: linear-gradient(135deg, var(--swing), #6d28d9); color: white; }
        .badge-secondary { background: rgba(156,163,175,0.2); color: #6b7280; }

        .turn-rally { color: #22c55e; font-weight: 600; }
        .turn-pullback { color: #22c55e; font-weight: 600; }
        .turn-breakdown { color: #ef4444; font-weight: 600; }
        .turn-reversal { color: #f59e0b; font-weight: 600; }

        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { text-align: left; padding: 8px; font-size: 9px; font-weight: 600; color: var(--muted); text-transform: uppercase; background: var(--bg); border-bottom: 1px solid var(--border); }
        td { padding: 8px; border-bottom: 1px solid var(--border); }
        tr:hover { background: rgba(59,130,246,0.02); }
        
        .chart-box { position: relative; height: 280px; }
        
        .dual-signal-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .signal-panel { border-radius: 8px; padding: 14px; }
        .signal-panel.intraday { background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(217,119,6,0.05)); border: 2px solid var(--intraday); }
        .signal-panel.swing { background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(109,40,217,0.05)); border: 2px solid var(--swing); }
        .signal-panel-title { font-size: 13px; font-weight: 700; margin-bottom: 10px; }
        .signal-panel-title.intraday { color: var(--intraday); }
        .signal-panel-title.swing { color: var(--swing); }
        
        .ref-data-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 11px; }
        .ref-label { color: var(--muted); }
        .ref-value { font-weight: 600; }
        .ref-value.positive { color: var(--success); }
        .ref-value.negative { color: var(--danger); }
        
        .bar-count-display { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .bar-count-item { background: var(--bg); border-radius: 6px; padding: 10px; text-align: center; }
        .bar-count-value { font-size: 24px; font-weight: 800; }
        .bar-count-label { font-size: 10px; color: var(--muted); margin-top: 3px; }
        
        .pattern-item { background: var(--bg); border-radius: 6px; padding: 8px; margin-bottom: 6px; }
        .pattern-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .pattern-name { font-weight: 600; font-size: 12px; }
        .pattern-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
        .pattern-fill { height: 100%; border-radius: 2px; }
        .pattern-fill.bullish { background: var(--success); }
        .pattern-fill.bearish { background: var(--danger); }
        .pattern-fill.neutral { background: var(--warning); }

        /* AI Assistant Styles */
        .ai-assistant-container { display: grid; grid-template-columns: 1fr 320px; gap: 15px; min-height: 500px; }
        .ai-chat-panel { display: flex; flex-direction: column; background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .ai-chat-header { background: var(--ai-gradient); color: white; padding: 12px 16px; display: flex; align-items: center; gap: 10px; }
        .ai-avatar { width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .ai-chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; max-height: 450px; }
        .ai-message { max-width: 90%; padding: 10px 14px; border-radius: 12px; font-size: 12px; line-height: 1.6; }
        .ai-message.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai-message.assistant { background: var(--bg); color: var(--text); align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid var(--border); }
        .ai-message.assistant .message-content { white-space: pre-wrap; }
        .ai-chat-input { display: flex; gap: 8px; padding: 12px; border-top: 1px solid var(--border); background: var(--bg); }
        .ai-chat-input input { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 20px; font-size: 12px; outline: none; }
        .ai-chat-input input:focus { border-color: var(--primary); }
        .ai-chat-input button { padding: 10px 20px; background: var(--ai-gradient); color: white; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 12px; }
        .ai-chat-input button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .ai-sidebar { display: flex; flex-direction: column; gap: 12px; }
        .ai-quick-actions { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
        .ai-quick-actions h4 { font-size: 12px; margin-bottom: 8px; color: var(--secondary); }
        .quick-action-btn { display: block; width: 100%; padding: 7px 10px; margin-bottom: 5px; background: var(--bg); border: 1px solid var(--border); border-radius: 5px; font-size: 10px; text-align: left; cursor: pointer; transition: all 0.2s; }
        .quick-action-btn:hover { border-color: var(--primary); background: rgba(59,130,246,0.05); }
        
        .ai-data-context { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
        .ai-data-context h4 { font-size: 11px; margin-bottom: 8px; color: var(--muted); }
        .context-item { font-size: 10px; padding: 3px 0; display: flex; justify-content: space-between; }
        
        .typing-indicator { display: flex; gap: 4px; padding: 10px 14px; }
        .typing-dot { width: 8px; height: 8px; background: var(--muted); border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; flex-direction: column; gap: 15px; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 900px) {
            .ai-assistant-container { grid-template-columns: 1fr; }
            .dual-signal-container { grid-template-columns: 1fr; }
        }

        /* Trade Log Styles */
        .form-group-trade {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .form-group-trade label {
            font-size: 10px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
        }
        .form-group-trade input,
        .form-group-trade select {
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 12px;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-group-trade input:focus,
        .form-group-trade select:focus {
            border-color: var(--primary);
        }
        
        .trade-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .trade-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        .trade-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .trade-btn.secondary {
            background: var(--bg);
            color: var(--muted);
            border: 1px solid var(--border);
        }
        .trade-btn.secondary:hover {
            background: var(--border);
        }
        
        .action-btn {
            padding: 6px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .action-btn:hover {
            background: var(--card);
            border-color: var(--primary);
            color: var(--primary);
        }
        .action-btn.danger:hover {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        #tradeTable th {
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 10;
        }
        #tradeTable td {
            vertical-align: middle;
        }
        
        .trade-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            margin-right: 4px;
        }
        .trade-action-btn.edit {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
        }
        .trade-action-btn.delete {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .pnl-positive { color: var(--success); font-weight: 600; }
        .pnl-negative { color: var(--danger); font-weight: 600; }
        
        .status-badge-trade {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
        }
        .status-badge-trade.open { background: rgba(59, 130, 246, 0.15); color: var(--primary); }
        .status-badge-trade.closed { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .status-badge-trade.stopped { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        

        /* Options Calculator Styles */
        .options-calc-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 900px) {
            .options-calc-container { grid-template-columns: 1fr; }
        }
        .calc-inputs {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        .calc-inputs h3 {
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .calc-form-group {
            margin-bottom: 15px;
        }
        .calc-form-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        .calc-form-group input,
        .calc-form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .calc-form-group input:focus,
        .calc-form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        .calc-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .option-type-toggle {
            display: flex;
            gap: 8px;
        }
        .option-type-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-type-btn.call.active {
            border-color: var(--success);
            background: rgba(16,185,129,0.1);
            color: var(--success);
        }
        .option-type-btn.put.active {
            border-color: var(--danger);
            background: rgba(239,68,68,0.1);
            color: var(--danger);
        }
        .calc-results {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .calc-result-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        .calc-result-card h4 {
            font-size: 14px;
            margin-bottom: 12px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .result-item {
            background: var(--bg);
            padding: 10px;
            border-radius: 6px;
        }
        .result-item .label {
            font-size: 10px;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .result-item .value {
            font-size: 18px;
            font-weight: 700;
        }
        .result-item .value.positive { color: var(--success); }
        .result-item .value.negative { color: var(--danger); }
        .greeks-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .greek-item {
            background: linear-gradient(135deg, rgba(139,92,246,0.05), rgba(168,85,247,0.05));
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .greek-item .greek-name {
            font-size: 10px;
            color: var(--secondary);
            font-weight: 600;
            text-transform: uppercase;
        }
        .greek-item .greek-value {
            font-size: 16px;
            font-weight: 700;
            margin-top: 4px;
        }
        .use-current-btn {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
        }
        .use-current-btn:hover {
            opacity: 0.9;
        }
        .greeks-reference {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg);
            border-radius: 8px;
            font-size: 11px;
        }
        .greeks-reference h5 {
            font-size: 12px;
            margin-bottom: 10px;
            color: var(--text);
        }
        .greeks-reference table {
            width: 100%;
        }
        .greeks-reference td {
            padding: 4px 8px;
            border-bottom: 1px solid var(--border);
        }

        /* Print Styles */
        @media print {
            .login-screen, .header, .tabs, .mode-toggle-container, .symbol-banner,
            .action-btn, .trade-btn, .trade-action-btn, #tradeForm, .ai-sidebar {
                display: none !important;
            }
            .main-app { display: block !important; }
            .card { break-inside: avoid; box-shadow: none; border: 1px solid #ccc; }
            body { background: white; }
        }

        /* Health Monitor Styles */
        .health-banner {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.1));
            border: 2px solid var(--success);
        }
        .health-banner.warning {
            background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(217,119,6,0.1));
            border-color: var(--warning);
        }
        .health-banner.critical {
            background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.1));
            border-color: var(--danger);
        }
        .health-banner-icon { font-size: 32px; }
        .health-banner-content { flex: 1; }
        .health-banner-title { font-size: 18px; font-weight: 700; color: var(--text); }
        .health-banner-subtitle { font-size: 12px; color: var(--muted); margin-top: 2px; }
        .refresh-health-btn {
            padding: 8px 16px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .refresh-health-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16,185,129,0.3); }

        .health-metric {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s;
        }
        .health-metric.healthy { border-color: var(--success); background: rgba(16,185,129,0.05); }
        .health-metric.warning { border-color: var(--warning); background: rgba(245,158,11,0.05); }
        .health-metric.critical { border-color: var(--danger); background: rgba(239,68,68,0.05); }
        .health-metric-icon { font-size: 28px; margin-bottom: 8px; }
        .health-metric-label { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
        .health-metric-value { font-size: 18px; font-weight: 700; margin: 6px 0; }
        .health-metric-status { font-size: 10px; padding: 3px 8px; border-radius: 10px; display: inline-block; }
        .health-metric-status.ok { background: rgba(16,185,129,0.15); color: var(--success); }
        .health-metric-status.warn { background: rgba(245,158,11,0.15); color: var(--warning); }
        .health-metric-status.error { background: rgba(239,68,68,0.15); color: var(--danger); }

        .health-timeline { display: flex; flex-direction: column; gap: 10px; }
        .timeline-item { display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg); border-radius: 6px; }
        .timeline-label { color: var(--muted); font-size: 12px; }
        .timeline-value { font-weight: 600; font-size: 12px; }

        .connection-grid { display: flex; flex-direction: column; gap: 10px; }
        .connection-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg); border-radius: 6px; }
        .connection-indicator { font-size: 14px; }
        .connection-indicator.online { color: var(--success); }
        .connection-indicator.offline { color: var(--danger); }
        .connection-indicator.unknown { color: var(--muted); }
        .connection-status { margin-left: auto; font-size: 11px; color: var(--muted); }

        .health-alerts { display: flex; flex-direction: column; gap: 8px; }
        .health-alert {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 12px;
        }
        .health-alert.info { background: rgba(8,145,178,0.1); color: var(--info); border-left: 3px solid var(--info); }
        .health-alert.warning { background: rgba(245,158,11,0.1); color: #b45309; border-left: 3px solid var(--warning); }
        .health-alert.critical { background: rgba(239,68,68,0.1); color: var(--danger); border-left: 3px solid var(--danger); }
        .health-alert.success { background: rgba(16,185,129,0.1); color: var(--success); border-left: 3px solid var(--success); }
        .alert-icon { font-size: 16px; }

        .sys-info-item { background: var(--bg); padding: 12px; border-radius: 6px; }
        .sys-info-label { font-size: 10px; color: var(--muted); text-transform: uppercase; margin-bottom: 4px; }
        .sys-info-value { font-size: 13px; font-weight: 600; }
        .sys-info-value a { color: var(--primary); text-decoration: none; }

        .troubleshoot-accordion { display: flex; flex-direction: column; gap: 8px; }
        .troubleshoot-item { border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
        .troubleshoot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg);
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }
        .troubleshoot-header:hover { background: var(--border); }
        .troubleshoot-toggle { font-size: 18px; color: var(--muted); }
        .troubleshoot-content {
            display: none;
            padding: 16px;
            font-size: 12px;
            line-height: 1.8;
        }
        .troubleshoot-content.show { display: block; }
        .troubleshoot-content ol { margin-left: 20px; }
        .troubleshoot-content li { margin-bottom: 6px; }
        .troubleshoot-content a { color: var(--primary); }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo"></div>
            <h1 class="login-title">Stock Agent 4</h1>
            <p class="login-subtitle">Q5D Options Trading Platform</p>
            
            <div class="login-error" id="loginError">
                Invalid username or password. Please try again.
            </div>
            
            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter your username" required autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required autocomplete="current-password">
                </div>
                
                <div class="remember-me">
                    <input type="checkbox" id="rememberMe" checked>
                    <label for="rememberMe">Remember me (stay logged in)</label>
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">
                    Sign In
                </button>
            </form>
            
            <div class="login-footer">
                <p> Secure Access | Powered by Gann Principles</p>
            </div>
        </div>
    </div>

    <!-- MAIN APPLICATION (Hidden until login) -->
    <div class="main-app" id="mainApp">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div>Loading data...</div>
        </div>

        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon"></div>
                    <div><h1>Stock Agent 4</h1><p>Q5D Options Platform</p></div>
                </div>
                
                <div class="live-price-ticker">
                    <div>
                        <div class="ticker-symbol" id="tickerSymbol">SPY</div>
                        <div style="font-size:9px;opacity:0.8;" id="tickerName">S&P 500 ETF</div>
                    </div>
                    <div class="ticker-price" id="tickerPrice">$675.02</div>
                    <div>
                        <div class="ticker-change positive" id="tickerChange">+$6.29</div>
                        <div style="font-size:9px;margin-top:1px;" id="tickerPct">+0.94%</div>
                    </div>
                </div>
                
                <div class="header-controls">
                    <div class="status-badge" id="headerHealthBadge" onclick="switchToHealthTab()"><span class="status-dot" id="headerHealthDot"></span><span id="headerHealthText">CHECKING</span></div>
                    <div class="symbol-select">
                        <select id="symbolSelect" onchange="changeSymbol()">
                            <optgroup label="Major ETFs">
                                <option value="SPY">SPY</option>
                                <option value="QQQ">QQQ</option>
                                <option value="IWM">IWM</option>
                                <option value="DIA">DIA</option>
                            </optgroup>
                            <optgroup label="Sectors">
                                <option value="XLF">XLF - Financials</option>
                                <option value="XLE">XLE - Energy</option>
                                <option value="XLK">XLK - Technology</option>
                                <option value="XLV">XLV - Healthcare</option>
                                <option value="XLI">XLI - Industrials</option>
                                <option value="XLB">XLB - Materials</option>
                                <option value="XLU">XLU - Utilities</option>
                                <option value="XLP">XLP - Staples</option>
                                <option value="XLY">XLY - Discretionary</option>
                                <option value="XLRE">XLRE - Real Estate</option>
                                <option value="XLC">XLC - Comm Services</option>
                            </optgroup>
                        </select>
                    </div>
                    <button class="refresh-btn" onclick="loadAllData()"> Refresh</button>
                    <div class="user-info">
                        <div class="user-avatar"></div>
                        <span id="loggedInUser">User</span>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">Logout</button>
                </div>
            </div>
        </header>

    <div class="container">
        <div class="mode-toggle-container">
            <div class="mode-toggle">
                <button class="mode-btn intraday active" onclick="setTradingMode('intraday')"> INTRADAY</button>
                <button class="mode-btn swing" onclick="setTradingMode('swing')"> SWING</button>
            </div>
        </div>

        <div class="symbol-banner intraday-mode" id="symbolBanner">
            <div><strong id="currentSymbolDisplay">SPY</strong> - <span id="currentSymbolName">S&P 500 ETF</span> | <span id="currentModeDisplay">INTRADAY</span></div>
            <div style="font-size:11px;"> <span id="dataDate">--</span>  <span id="dataTime">--</span></div>
        </div>

        <!-- Market Stats Row -->
        <div id="marketStatsRow" style="display: flex; gap: 20px; justify-content: center; align-items: center; padding: 8px 15px; background: var(--card); border-radius: 8px; margin-bottom: 12px; font-size: 12px; border: 1px solid var(--border);">
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="color: var(--muted);">Today:</span>
                <span style="color: #ef4444;" id="statTodayLow">L: $--</span>
                <span style="color: var(--muted);">|</span>
                <span style="color: #22c55e;" id="statTodayHigh">H: $--</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="color: var(--muted);">52W:</span>
                <span id="stat52WRange" style="color: var(--text);">$-- - $--</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="color: var(--muted);">Vol:</span>
                <span id="statVolumeVsAvg" style="color: var(--text);">-- vs Avg</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
                <span style="color: var(--muted);"></span>
                <span id="globalLastUpdated" style="color: var(--muted); font-size: 11px;" title="Last data refresh">--</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="overview"> Overview</button>
            <button class="tab-btn" data-tab="barcount"> Bar Count</button>
            <button class="tab-btn" data-tab="signals"> Signals & Agents</button>
            <button class="tab-btn" data-tab="patterns"> Patterns</button>
            <button class="tab-btn" data-tab="trades"> Trades</button>
            <button class="tab-btn" data-tab="opportunities">Opportunities</button>
            <button class="tab-btn health-tab" data-tab="health"> Health</button>
            <button class="tab-btn ai-tab" data-tab="ai-assistant"> AI Assistant</button>
            <button class="tab-btn analysis-tab" data-tab="daily-analysis"> Daily Analysis</button>
            <button class="tab-btn gann-tab" data-tab="gann-analysis" style="background: linear-gradient(135deg, #d4a017, #b8860b); color: white;"> Gann Analysis</button>
            <button class="tab-btn charts-tab" data-tab="multi-charts"> Multi-Charts</button>
            <button class="tab-btn" data-tab="options-calc" style="background: linear-gradient(135deg, #10b981, #059669); color: white;"> Options Calc</button>
        </div>

        <!-- OVERVIEW TAB -->
        <div id="overview" class="tab-content active">
            <div class="grid grid-5">
                <div class="metric"><div class="metric-label">Price</div><div class="metric-value" id="currentPrice">--</div><div class="metric-sub" id="priceSource">Loading...</div></div>
                <div class="metric"><div class="metric-label">Change</div><div class="metric-value" id="dailyChange">--</div><div class="metric-sub" id="changePct">--</div></div>
                <div class="metric"><div class="metric-label">Volume</div><div class="metric-value" id="volumeDisplay">--</div><div class="metric-sub" id="volumeVsAvgSmall">vs avg</div></div>
                <div class="metric"><div class="metric-label">Signal</div><div class="metric-value" id="signalStatus">--</div><div class="metric-sub" id="signalConf">--</div></div>
                <div class="metric"><div class="metric-label">ATR</div><div class="metric-value" id="atrDisplay">--</div><div class="metric-sub">Volatility</div></div>
            </div>

            <!-- Fibonacci Zone Display -->
            <div class="card" style="background: linear-gradient(135deg, rgba(139,92,246,0.05), rgba(168,85,247,0.05)); border: 1px solid rgba(139,92,246,0.2);">
                <div class="card-title" style="color: #8b5cf6;"> Fibonacci Price Zones</div>
                <div id="fibZoneDisplay" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; padding: 10px; background: var(--bg); border-radius: 8px; font-size: 11px;">
                    <div class="fib-level" style="text-align: center; padding: 6px 10px; background: rgba(239,68,68,0.1); border-radius: 4px;">
                        <div style="color: var(--muted); font-size: 9px;">S3 (61.8%)</div>
                        <div id="fibS3" style="font-weight: 600; color: #22c55e;">$--</div>
                    </div>
                    <div class="fib-level" style="text-align: center; padding: 6px 10px; background: rgba(239,68,68,0.08); border-radius: 4px;">
                        <div style="color: var(--muted); font-size: 9px;">S2 (50%)</div>
                        <div id="fibS2" style="font-weight: 600; color: #22c55e;">$--</div>
                    </div>
                    <div class="fib-level" style="text-align: center; padding: 6px 10px; background: rgba(239,68,68,0.05); border-radius: 4px;">
                        <div style="color: var(--muted); font-size: 9px;">S1 (38.2%)</div>
                        <div id="fibS1" style="font-weight: 600; color: #22c55e;">$--</div>
                    </div>
                    <div id="currentPriceZone" class="fib-level" style="text-align: center; padding: 8px 12px; background: linear-gradient(135deg, rgba(212,160,23,0.3), rgba(212,160,23,0.1)); border: 2px solid #d4a017; border-radius: 6px;">
                        <div style="color: #d4a017; font-size: 9px; font-weight: 600;"> CURRENT</div>
                        <div id="fibCurrentPrice" style="font-weight: 700; color: #d4a017; font-size: 14px;">$--</div>
                    </div>
                    <div class="fib-level" style="text-align: center; padding: 6px 10px; background: rgba(34,197,94,0.05); border-radius: 4px;">
                        <div style="color: var(--muted); font-size: 9px;">R1 (100%)</div>
                        <div id="fibR1" style="font-weight: 600; color: #ef4444;">$--</div>
                    </div>
                    <div class="fib-level" style="text-align: center; padding: 6px 10px; background: rgba(34,197,94,0.08); border-radius: 4px;">
                        <div style="color: var(--muted); font-size: 9px;">R2 (127.2%)</div>
                        <div id="fibR2" style="font-weight: 600; color: #ef4444;">$--</div>
                    </div>
                    <div class="fib-level" style="text-align: center; padding: 6px 10px; background: rgba(34,197,94,0.1); border-radius: 4px;">
                        <div style="color: var(--muted); font-size: 9px;">R3 (161.8%)</div>
                        <div id="fibR3" style="font-weight: 600; color: #ef4444;">$--</div>
                    </div>
                </div>
                <div id="fibZoneStatus" style="margin-top: 10px; padding: 8px 12px; background: rgba(34,197,94,0.1); border-radius: 6px; font-size: 11px; text-align: center;">
                    <span style="color: var(--muted);">Current Zone:</span>
                    <span id="fibZoneLabel" style="font-weight: 600; color: #22c55e; margin-left: 5px;">Between S1 and R1</span>
                </div>
            </div>

            <!-- Multi-Timeframe Trend Display -->
            <div class="card" style="background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(16,185,129,0.05)); border: 1px solid rgba(59,130,246,0.2);">
                <div class="card-title" style="color: #3b82f6;"> Multi-Timeframe Trend</div>
                <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
                    <div style="text-align: center; padding: 12px 20px; background: var(--bg); border-radius: 8px; min-width: 120px;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;"> INTRADAY</div>
                        <div id="trendIntraday" style="font-size: 16px; font-weight: 700; color: #22c55e;">BULLISH</div>
                    </div>
                    <div style="text-align: center; padding: 12px 20px; background: var(--bg); border-radius: 8px; min-width: 120px;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;"> SWING</div>
                        <div id="trendSwing" style="font-size: 16px; font-weight: 700; color: #22c55e;">BULLISH</div>
                    </div>
                    <div style="text-align: center; padding: 12px 20px; background: var(--bg); border-radius: 8px; min-width: 120px;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 4px;"> POSITION</div>
                        <div id="trendPosition" style="font-size: 16px; font-weight: 700; color: #22c55e;">BULLISH</div>
                    </div>
                </div>
            </div>

            <!-- Gann Quick View Summary Table -->
            <div class="card" style="background: linear-gradient(135deg, rgba(212,160,23,0.08), rgba(184,134,11,0.05)); border: 1px solid rgba(212,160,23,0.3);">
                <div class="card-title" style="color: #d4a017;"> Gann Quick View</div>
                <div class="table-wrap">
                    <table style="font-size: 11px;">
                        <thead>
                            <tr style="background: rgba(212,160,23,0.1);">
                                <th style="color: #d4a017;">Trend</th>
                                <th style="color: #d4a017;">Vol vs Avg</th>
                                <th style="color: #d4a017;">Bars in Trend</th>
                                <th style="color: #d4a017;">Cycle Phase</th>
                                <th style="color: #d4a017;">Next Cycle Turn</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td id="gannQvTrend" style="font-weight: 600; color: #22c55e;">BULLISH</td>
                                <td id="gannQvVolume" style="color: #22c55e;">+12%</td>
                                <td id="gannQvBars">7</td>
                                <td id="gannQvCyclePhase" style="color: #eab308;">MID</td>
                                <td id="gannQvNextTurn">Dec 21</td>
                            </tr>
                        </tbody>
                        <thead>
                            <tr style="background: rgba(212,160,23,0.1);">
                                <th style="color: #d4a017;">Gann Score</th>
                                <th style="color: #d4a017;">Agent Consensus</th>
                                <th style="color: #d4a017;">Reversal Risk</th>
                                <th style="color: #d4a017;">MTF Alignment</th>
                                <th style="color: #d4a017;">Entry Window</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td id="gannQvScore" style="font-weight: 600; color: #22c55e;">75/100</td>
                                <td id="gannQvConsensus" style="color: #22c55e;">3/4</td>
                                <td id="gannQvReversal" style="color: #22c55e;">LOW</td>
                                <td id="gannQvMtf" style="color: #22c55e;">3/3</td>
                                <td id="gannQvEntry" style="color: #22c55e;">OPEN</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reference Data -->
            <div class="card">
                <div class="card-title"> Reference Data</div>
                <div class="grid grid-4">
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">52W High</span><span class="ref-value positive" id="week52High">$609.07</span></div>
                        <div class="ref-data-row"><span class="ref-label">52W Low</span><span class="ref-value negative" id="week52Low">$479.05</span></div>
                    </div>
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">Today High</span><span class="ref-value" id="todayHigh">$607.51</span></div>
                        <div class="ref-data-row"><span class="ref-label">Today Low</span><span class="ref-value" id="todayLow">$604.35</span></div>
                    </div>
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">Avg Vol (20D)</span><span class="ref-value" id="avgVolume20">42.5M</span></div>
                        <div class="ref-data-row"><span class="ref-label">Vol vs Avg</span><span class="ref-value" id="volumeVsAvg">+12%</span></div>
                    </div>
                    <div style="background:var(--bg);border-radius:6px;padding:10px;">
                        <div class="ref-data-row"><span class="ref-label">Open</span><span class="ref-value" id="todayOpen">$605.20</span></div>
                        <div class="ref-data-row"><span class="ref-label">Prev Close</span><span class="ref-value" id="prevClose">$604.85</span></div>
                    </div>
                </div>
            </div>

            <!-- Trade Statistics Section -->
            <div class="card" style="background: linear-gradient(135deg, rgba(16,185,129,0.05), rgba(6,182,212,0.05)); border: 1px solid rgba(16,185,129,0.2);">
                <div class="card-title" style="color: #10b981;" id="statsTitle">SPY - S&P 500  Trade Statistics (Last 30 Days)</div>
                <div class="grid grid-4" style="gap: 10px;">
                    <div style="background: var(--bg); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Win Rate</div>
                        <div id="statsWinRate" style="font-size: 20px; font-weight: 700; color: #22c55e;">68%</div>
                    </div>
                    <div style="background: var(--bg); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Avg Win</div>
                        <div id="statsAvgWin" style="font-size: 20px; font-weight: 700; color: #22c55e;">+$3.42</div>
                    </div>
                    <div style="background: var(--bg); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Avg Loss</div>
                        <div id="statsAvgLoss" style="font-size: 20px; font-weight: 700; color: #ef4444;">-$1.85</div>
                    </div>
                    <div style="background: var(--bg); border-radius: 8px; padding: 12px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Total Trades</div>
                        <div id="statsTotalTrades" style="font-size: 20px; font-weight: 700; color: var(--text);">22</div>
                    </div>
                </div>
                <div class="grid grid-3" style="gap: 10px; margin-top: 10px;">
                    <div style="background: rgba(34,197,94,0.1); border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Best Day</div>
                        <div id="statsBestDay" style="font-size: 14px; font-weight: 600; color: #22c55e;">+$8.50</div>
                    </div>
                    <div style="background: rgba(239,68,68,0.1); border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Worst Day</div>
                        <div id="statsWorstDay" style="font-size: 14px; font-weight: 600; color: #ef4444;">-$4.20</div>
                    </div>
                    <div style="background: rgba(139,92,246,0.1); border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted);">Current Streak</div>
                        <div id="statsStreak" style="font-size: 14px; font-weight: 600; color: #8b5cf6;">3 wins</div>
                    </div>
                </div>
            </div>

            <!-- Upcoming Events Widget -->
            <div class="card" style="background: linear-gradient(135deg, rgba(245,158,11,0.08), rgba(234,179,8,0.05)); border: 1px solid rgba(245,158,11,0.2);">
                <div class="card-title" style="color: #f59e0b;"> Upcoming Market Events (Next 7 Days)</div>
                <div id="upcomingEventsWidget" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <div style="background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); border-radius: 6px; padding: 8px 12px; font-size: 11px;">
                        <div style="font-weight: 600; color: #ef4444;">Dec 11 (Wed)</div>
                        <div style="color: var(--text);">CPI Report 8:30 AM</div>
                    </div>
                    <div style="background: rgba(245,158,11,0.15); border: 1px solid rgba(245,158,11,0.3); border-radius: 6px; padding: 8px 12px; font-size: 11px;">
                        <div style="font-weight: 600; color: #f59e0b;">Dec 12 (Thu)</div>
                        <div style="color: var(--text);">PPI Report 8:30 AM</div>
                    </div>
                    <div style="background: rgba(139,92,246,0.15); border: 1px solid rgba(139,92,246,0.3); border-radius: 6px; padding: 8px 12px; font-size: 11px;">
                        <div style="font-weight: 600; color: #8b5cf6;">Dec 12 (Thu)</div>
                        <div style="color: var(--text);">Jobless Claims</div>
                    </div>
                    <div style="background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); border-radius: 6px; padding: 8px 12px; font-size: 11px;">
                        <div style="font-weight: 600; color: #ef4444;">Dec 18 (Wed)</div>
                        <div style="color: var(--text);">FOMC Decision 2:00 PM</div>
                    </div>
                    <div style="background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.3); border-radius: 6px; padding: 8px 12px; font-size: 11px;">
                        <div style="font-weight: 600; color: #22c55e;">Dec 13 (Fri)</div>
                        <div style="color: var(--text);">Quad Witching</div>
                    </div>
                    <div style="background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.3); border-radius: 6px; padding: 8px 12px; font-size: 11px;">
                        <div style="font-weight: 600; color: #3b82f6;">Dec 16 (Mon)</div>
                        <div style="color: var(--text);">Retail Sales</div>
                    </div>
                </div>
            </div>

            <!-- Pattern Detection Summary -->
            <div class="card" style="background: linear-gradient(135deg, rgba(139,92,246,0.08), rgba(168,85,247,0.05)); border: 1px solid rgba(139,92,246,0.2);">
                <div class="card-title" style="color: #8b5cf6;"> Pattern Detection (Last 14 Days)</div>
                <div id="patternDetectionSummary" style="font-size: 11px; line-height: 1.8;">
                    <!-- Generated dynamically -->
                </div>
            </div>

            <!-- Historical Data Table -->
            <div class="card">
                <div class="card-title"> Historical Data (Last 10 Days)</div>

                <!-- Summary Row -->
                <div id="historicalSummary" style="background: rgba(59,130,246,0.1); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 11px; display: flex; flex-wrap: wrap; gap: 15px;">
                    <!-- Generated dynamically -->
                </div>

                <div class="table-wrap" style="max-height: 450px; overflow-y: auto; overflow-x: auto;">
                    <table style="font-size: 10px; white-space: nowrap;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>O/H/L/C</th>
                                <th>Change</th>
                                <th>GAP</th>
                                <th>Candle</th>
                                <th>Trend</th>
                                <th>Close Pos</th>
                                <th>Vol</th>
                                <th>OH</th>
                                <th>Events</th>
                            </tr>
                        </thead>
                        <tbody id="historicalDataTable">
                            <!-- Generated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- AI Quick Analysis Card -->
            <div class="card" style="background: linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05)); border: 1px solid rgba(102,126,234,0.2);">
                <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">
                    <span> AI Quick Analysis</span>
                    <button onclick="refreshOverviewAI()" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:5px 12px;border-radius:5px;font-size:11px;cursor:pointer;"> Refresh</button>
                </div>
                <div id="overviewAiAnalysis" style="font-size:12px;line-height:1.8;color:var(--text);">
                    <div style="text-align:center;padding:20px;color:var(--muted);">
                        <div style="font-size:24px;margin-bottom:8px;"></div>
                        Loading AI analysis...
                    </div>
                </div>
            </div>

            <!-- Data Pattern Detection Card -->
            <div class="card" style="background: linear-gradient(135deg, rgba(16,185,129,0.05), rgba(34,197,94,0.05)); border: 1px solid rgba(16,185,129,0.2);">
                <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">
                    <span> Data Pattern Detection</span>
                    <button onclick="updateDataPatternDetection()" style="background:linear-gradient(135deg,#10b981,#22c55e);color:white;border:none;padding:5px 12px;border-radius:5px;font-size:11px;cursor:pointer;"> Scan</button>
                </div>
                <div id="dataPatternDetection" style="font-size:12px;line-height:1.6;color:var(--text);">
                    <div style="text-align:center;padding:20px;color:var(--muted);">
                        <div style="font-size:24px;margin-bottom:8px;"></div>
                        Loading pattern detection...
                    </div>
                </div>
            </div>
        </div>

        <!-- BAR COUNT TAB - FIXED -->
        <div id="barcount" class="tab-content">
            <div class="card">
                <div class="card-title"> Bar Count Analysis</div>
                <div style="display:flex;gap:15px;margin-bottom:15px;flex-wrap:wrap;align-items:center;">
                    <div>
                        <label style="font-size:11px;color:var(--muted);">Bars to Analyze:</label>
                        <select id="barCountSelect" onchange="updateBarCountAnalysis()" style="padding:6px 10px;border:1px solid var(--border);border-radius:5px;margin-left:8px;">
                            <option value="5">5 Bars</option>
                            <option value="10">10 Bars</option>
                            <option value="15">15 Bars</option>
                            <option value="20" selected>20 Bars</option>
                            <option value="25">25 Bars</option>
                            <option value="30">30 Bars</option>
                            <option value="35">35 Bars</option>
                            <option value="40">40 Bars</option>
                            <option value="45">45 Bars</option>
                            <option value="50">50 Bars</option>
                            <option value="55">55 Bars</option>
                            <option value="60">60 Bars</option>
                            <option value="65">65 Bars</option>
                            <option value="70">70 Bars</option>
                            <option value="75">75 Bars</option>
                            <option value="80">80 Bars</option>
                            <option value="85">85 Bars</option>
                            <option value="90">90 Bars</option>
                            <option value="95">95 Bars</option>
                            <option value="100">100 Bars</option>
                        </select>
                    </div>
                    <div style="background:var(--bg);padding:6px 12px;border-radius:5px;font-size:12px;">
                        <strong>Current Symbol:</strong> <span id="barCountCurrentSymbol" style="color:var(--primary);font-weight:700;">SPY</span>
                        <span style="color:var(--muted);font-size:10px;margin-left:5px;">(synced with header)</span>
                    </div>
                </div>
                
                <div class="bar-count-display">
                    <div class="bar-count-item">
                        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;"> Base Confluence</div>
                        <div class="bar-count-value" id="baseBarCount">+5</div>
                        <div class="bar-count-label">Consecutive Bars</div>
                    </div>
                    <div class="bar-count-item">
                        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;"> Gann-Elliott</div>
                        <div class="bar-count-value" id="gannBarCount">+7</div>
                        <div class="bar-count-label">Wave Progress</div>
                    </div>
                    <div class="bar-count-item">
                        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;"> DQN/RL</div>
                        <div class="bar-count-value" id="dqnBarCount">+2</div>
                        <div class="bar-count-label">Momentum</div>
                    </div>
                    <div class="bar-count-item">
                        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;"> 3-Wave</div>
                        <div class="bar-count-value" id="waveBarCount">+4</div>
                        <div class="bar-count-label">Impulse</div>
                    </div>
                </div>
            </div>

            <!-- Trend Reversal Statistics -->
            <div class="card">
                <div class="card-title"> Trend Reversal Statistics</div>
                <p style="font-size:11px;color:var(--muted);margin-bottom:12px;">Average bars before trend reversal based on historical data. Sorted by reversal risk (HIGH first).</p>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr><th>Symbol</th><th>Avg Bullish Run</th><th>Avg Bearish Run</th><th>Current Run</th><th>% of Avg</th><th>Reversal Risk</th></tr>
                        </thead>
                        <tbody id="reversalStatsTable">
                            <tr>
                                <td style="font-weight: 600;">XLV</td>
                                <td style="text-align: center;">9 bars</td>
                                <td style="text-align: center;">7 bars</td>
                                <td style="text-align: center; color: #ef4444; font-weight: 600;">-8 (Bear)</td>
                                <td style="text-align: center;">114%</td>
                                <td><span class="badge badge-danger">HIGH</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLB</td>
                                <td style="text-align: center;">8 bars</td>
                                <td style="text-align: center;">10 bars</td>
                                <td style="text-align: center; color: #ef4444; font-weight: 600;">-9 (Bear)</td>
                                <td style="text-align: center;">90%</td>
                                <td><span class="badge badge-danger">HIGH</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLY</td>
                                <td style="text-align: center;">11 bars</td>
                                <td style="text-align: center;">9 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+10 (Bull)</td>
                                <td style="text-align: center;">91%</td>
                                <td><span class="badge badge-danger">HIGH</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLK</td>
                                <td style="text-align: center;">11 bars</td>
                                <td style="text-align: center;">8 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+8 (Bull)</td>
                                <td style="text-align: center;">73%</td>
                                <td><span class="badge badge-warning">MEDIUM</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLE</td>
                                <td style="text-align: center;">7 bars</td>
                                <td style="text-align: center;">9 bars</td>
                                <td style="text-align: center; color: #ef4444; font-weight: 600;">-6 (Bear)</td>
                                <td style="text-align: center;">67%</td>
                                <td><span class="badge badge-warning">MEDIUM</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLI</td>
                                <td style="text-align: center;">10 bars</td>
                                <td style="text-align: center;">8 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+6 (Bull)</td>
                                <td style="text-align: center;">60%</td>
                                <td><span class="badge badge-warning">MEDIUM</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">SPY</td>
                                <td style="text-align: center;">12 bars</td>
                                <td style="text-align: center;">8 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+7 (Bull)</td>
                                <td style="text-align: center;">58%</td>
                                <td><span class="badge badge-success">LOW</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">QQQ</td>
                                <td style="text-align: center;">10 bars</td>
                                <td style="text-align: center;">7 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+5 (Bull)</td>
                                <td style="text-align: center;">50%</td>
                                <td><span class="badge badge-success">LOW</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLP</td>
                                <td style="text-align: center;">8 bars</td>
                                <td style="text-align: center;">7 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+4 (Bull)</td>
                                <td style="text-align: center;">50%</td>
                                <td><span class="badge badge-success">LOW</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLF</td>
                                <td style="text-align: center;">8 bars</td>
                                <td style="text-align: center;">6 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+3 (Bull)</td>
                                <td style="text-align: center;">38%</td>
                                <td><span class="badge badge-success">LOW</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">IWM</td>
                                <td style="text-align: center;">9 bars</td>
                                <td style="text-align: center;">11 bars</td>
                                <td style="text-align: center; color: #ef4444; font-weight: 600;">-4 (Bear)</td>
                                <td style="text-align: center;">36%</td>
                                <td><span class="badge badge-success">LOW</span></td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">XLU</td>
                                <td style="text-align: center;">7 bars</td>
                                <td style="text-align: center;">6 bars</td>
                                <td style="text-align: center; color: #22c55e; font-weight: 600;">+2 (Bull)</td>
                                <td style="text-align: center;">29%</td>
                                <td><span class="badge badge-success">LOW</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-title"> Bar Count History</div>
                <div class="table-wrap" style="max-height:300px;overflow-y:auto;">
                    <table>
                        <thead><tr><th>#</th><th>Date</th><th>O/H/L/C</th><th>Dir</th><th>Base</th><th>Gann</th><th>DQN</th><th>Wave</th><th>Avg</th></tr></thead>
                        <tbody id="barCountTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Historical Averages Section -->
            <div class="card" style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px;"> Historical Averages (Last 20 Days)</h3>
                <p style="font-size: 11px; color: var(--muted); margin-bottom: 15px;">Use these to set realistic daily targets. Don't expect more than the average move.</p>
                <div class="table-wrap">
                    <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--bg);">
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border);">SYMBOL</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">AVG OH</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">MAX OH</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">AVG OL</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">MAX OL</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">AVG OC</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">AVG RANGE</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">CALL TARGET</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 1px solid var(--border);">PUT TARGET</th>
                            </tr>
                        </thead>
                        <tbody id="historicalAvgBody">
                            <tr>
                                <td style="padding: 10px; font-weight: 600;">SPY</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="spyAvgOH">+$4.25</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="spyMaxOH">+$8.50</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="spyAvgOL">-$3.80</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="spyMaxOL">-$7.20</td>
                                <td style="padding: 10px; text-align: center;" id="spyAvgOC">+$1.20</td>
                                <td style="padding: 10px; text-align: center;" id="spyAvgRange">$8.05</td>
                                <td style="padding: 10px; text-align: center; background: rgba(34,197,94,0.1); color: #22c55e; font-weight: 600;" id="spyCallTarget">+$3.50</td>
                                <td style="padding: 10px; text-align: center; background: rgba(239,68,68,0.1); color: #ef4444; font-weight: 600;" id="spyPutTarget">-$3.00</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; font-weight: 600;">QQQ</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="qqqAvgOH">+$5.10</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="qqqMaxOH">+$10.20</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="qqqAvgOL">-$4.50</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="qqqMaxOL">-$9.80</td>
                                <td style="padding: 10px; text-align: center;" id="qqqAvgOC">+$0.85</td>
                                <td style="padding: 10px; text-align: center;" id="qqqAvgRange">$9.60</td>
                                <td style="padding: 10px; text-align: center; background: rgba(34,197,94,0.1); color: #22c55e; font-weight: 600;" id="qqqCallTarget">+$4.25</td>
                                <td style="padding: 10px; text-align: center; background: rgba(239,68,68,0.1); color: #ef4444; font-weight: 600;" id="qqqPutTarget">-$3.75</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; font-weight: 600;">IWM</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="iwmAvgOH">+$2.40</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="iwmMaxOH">+$5.10</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="iwmAvgOL">-$2.20</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="iwmMaxOL">-$4.80</td>
                                <td style="padding: 10px; text-align: center;" id="iwmAvgOC">+$0.45</td>
                                <td style="padding: 10px; text-align: center;" id="iwmAvgRange">$4.60</td>
                                <td style="padding: 10px; text-align: center; background: rgba(34,197,94,0.1); color: #22c55e; font-weight: 600;" id="iwmCallTarget">+$2.00</td>
                                <td style="padding: 10px; text-align: center; background: rgba(239,68,68,0.1); color: #ef4444; font-weight: 600;" id="iwmPutTarget">-$1.80</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; font-weight: 600;">XLF</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="xlfAvgOH">+$0.45</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="xlfMaxOH">+$0.95</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="xlfAvgOL">-$0.40</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="xlfMaxOL">-$0.85</td>
                                <td style="padding: 10px; text-align: center;" id="xlfAvgOC">+$0.12</td>
                                <td style="padding: 10px; text-align: center;" id="xlfAvgRange">$0.85</td>
                                <td style="padding: 10px; text-align: center; background: rgba(34,197,94,0.1); color: #22c55e; font-weight: 600;" id="xlfCallTarget">+$0.38</td>
                                <td style="padding: 10px; text-align: center; background: rgba(239,68,68,0.1); color: #ef4444; font-weight: 600;" id="xlfPutTarget">-$0.33</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; font-weight: 600;">XLE</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="xleAvgOH">+$0.85</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="xleMaxOH">+$1.80</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="xleAvgOL">-$0.75</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="xleMaxOL">-$1.65</td>
                                <td style="padding: 10px; text-align: center;" id="xleAvgOC">+$0.08</td>
                                <td style="padding: 10px; text-align: center;" id="xleAvgRange">$1.60</td>
                                <td style="padding: 10px; text-align: center; background: rgba(34,197,94,0.1); color: #22c55e; font-weight: 600;" id="xleCallTarget">+$0.70</td>
                                <td style="padding: 10px; text-align: center; background: rgba(239,68,68,0.1); color: #ef4444; font-weight: 600;" id="xlePutTarget">-$0.62</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; font-weight: 600;">XLK</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="xlkAvgOH">+$2.80</td>
                                <td style="padding: 10px; text-align: center; color: #22c55e;" id="xlkMaxOH">+$5.60</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="xlkAvgOL">-$2.50</td>
                                <td style="padding: 10px; text-align: center; color: #ef4444;" id="xlkMaxOL">-$5.20</td>
                                <td style="padding: 10px; text-align: center;" id="xlkAvgOC">+$0.65</td>
                                <td style="padding: 10px; text-align: center;" id="xlkAvgRange">$5.30</td>
                                <td style="padding: 10px; text-align: center; background: rgba(34,197,94,0.1); color: #22c55e; font-weight: 600;" id="xlkCallTarget">+$2.30</td>
                                <td style="padding: 10px; text-align: center; background: rgba(239,68,68,0.1); color: #ef4444; font-weight: 600;" id="xlkPutTarget">-$2.05</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: rgba(59,130,246,0.1); border-radius: 8px; font-size: 11px;">
                    <strong> How to use:</strong> CALL TARGET = 85% of AVG OH (realistic profit). PUT TARGET = 85% of AVG OL. Don't chase moves beyond MAX values - those are rare outliers.
                </div>
            </div>

            <!-- Today vs Average Section -->
            <div class="card" style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px;"> Today vs Average</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div style="border-radius: 8px; padding: 15px; text-align: center; background: rgba(234,179,8,0.1);" id="todayOHvsAvgBox">
                        <div style="font-size: 11px; color: var(--muted);">Today OH vs Avg</div>
                        <div style="font-size: 24px; font-weight: 700;" id="todayOHpct">89%</div>
                        <div style="font-size: 11px; color: var(--muted);" id="todayOHdetail">$3.80 of $4.25 avg</div>
                        <div style="font-size: 11px; color: #eab308; margin-top: 5px;" id="todayOHstatus">Nearing avg - consider taking profits</div>
                    </div>
                    <div style="border-radius: 8px; padding: 15px; text-align: center; background: rgba(239,68,68,0.1);" id="todayOLvsAvgBox">
                        <div style="font-size: 11px; color: var(--muted);">Today OL vs Avg</div>
                        <div style="font-size: 24px; font-weight: 700;" id="todayOLpct">110%</div>
                        <div style="font-size: 11px; color: var(--muted);" id="todayOLdetail">$4.20 of $3.80 avg</div>
                        <div style="font-size: 11px; color: #ef4444; margin-top: 5px;" id="todayOLstatus">Exceeded avg - strong selling pressure</div>
                    </div>
                    <div style="border-radius: 8px; padding: 15px; text-align: center; background: rgba(34,197,94,0.1);" id="todayRangevsAvgBox">
                        <div style="font-size: 11px; color: var(--muted);">Today Range vs Avg</div>
                        <div style="font-size: 24px; font-weight: 700;" id="todayRangePct">99%</div>
                        <div style="font-size: 11px; color: var(--muted);" id="todayRangeDetail">$8.00 of $8.05 avg</div>
                        <div style="font-size: 11px; color: #22c55e; margin-top: 5px;" id="todayRangeStatus">Normal volatility day</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIGNALS TAB -->
        <div id="signals" class="tab-content">
            <!-- Parameters Table -->
            <div class="card">
                <div class="card-title"> Intraday vs  Swing vs  Position Parameters</div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Parameter</th><th style="color:var(--intraday);"> INTRADAY</th><th style="color:var(--swing);"> SWING</th><th style="color:#a855f7;"> POSITION</th></tr></thead>
                        <tbody>
                            <tr><td>Timeframe</td><td>5-min, 15-min</td><td>Daily, 4-Hour</td><td>Weekly, Monthly</td></tr>
                            <tr><td>Options Expiry</td><td>0DTE - 1DTE</td><td>3-5 DTE</td><td>30-45 DTE</td></tr>
                            <tr><td>Fast SMA</td><td>5</td><td>10</td><td>20</td></tr>
                            <tr><td>Slow SMA</td><td>20</td><td>30</td><td>50</td></tr>
                            <tr><td>Stop Loss</td><td>0.5-1.0 ATR</td><td>1.5-2.0 ATR</td><td>2.5-3.0 ATR</td></tr>
                            <tr><td>Target</td><td>1.0-2.0 ATR</td><td>3.0-4.0 ATR</td><td>5.0-8.0 ATR</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Agent Signals Table -->
            <div class="card">
                <div class="card-title"> Agent Signals</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Agent</th>
                                <th style="color:var(--intraday);">Intraday</th>
                                <th>Conf</th>
                                <th style="color:var(--swing);">Swing</th>
                                <th>Conf</th>
                                <th style="color:#a855f7;">Position</th>
                                <th>Conf</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td> Base Confluence Agent</td>
                                <td><span class="badge badge-success" id="sigBaseIntraday">BULLISH</span></td>
                                <td id="sigBaseIntradayConf">72%</td>
                                <td><span class="badge badge-success" id="sigBaseSwing">BULLISH</span></td>
                                <td id="sigBaseSwingConf">68%</td>
                                <td><span class="badge badge-success" id="sigBasePosition">BULLISH</span></td>
                                <td id="sigBasePositionConf">75%</td>
                            </tr>
                            <tr>
                                <td> Gann-Elliott Agent</td>
                                <td><span class="badge badge-success" id="sigGannIntraday">BULLISH</span></td>
                                <td id="sigGannIntradayConf">75%</td>
                                <td><span class="badge badge-success" id="sigGannSwing">BULLISH</span></td>
                                <td id="sigGannSwingConf">70%</td>
                                <td><span class="badge badge-success" id="sigGannPosition">BULLISH</span></td>
                                <td id="sigGannPositionConf">78%</td>
                            </tr>
                            <tr>
                                <td> DQN/RL Agent</td>
                                <td><span class="badge badge-warning" id="sigDqnIntraday">NEUTRAL</span></td>
                                <td id="sigDqnIntradayConf">58%</td>
                                <td><span class="badge badge-success" id="sigDqnSwing">BULLISH</span></td>
                                <td id="sigDqnSwingConf">65%</td>
                                <td><span class="badge badge-success" id="sigDqnPosition">BULLISH</span></td>
                                <td id="sigDqnPositionConf">71%</td>
                            </tr>
                            <tr>
                                <td> 3-Wave Agent</td>
                                <td><span class="badge badge-success" id="sigWaveIntraday">BULLISH</span></td>
                                <td id="sigWaveIntradayConf">68%</td>
                                <td><span class="badge badge-danger" id="sigWaveSwing">BEARISH</span></td>
                                <td id="sigWaveSwingConf">62%</td>
                                <td><span class="badge badge-success" id="sigWavePosition">BULLISH</span></td>
                                <td id="sigWavePositionConf">74%</td>
                            </tr>
                            <tr style="background:var(--bg); font-weight: 600;">
                                <td><strong>CONSENSUS</strong></td>
                                <td><span class="badge badge-ultra" id="sigConsensusIntraday">3/4 BULLISH</span></td>
                                <td id="sigConsensusIntradayConf">68%</td>
                                <td><span class="badge badge-ultra" id="sigConsensusSwing">3/4 BULLISH</span></td>
                                <td id="sigConsensusSwingConf">66%</td>
                                <td><span class="badge badge-ultra" id="sigConsensusPosition">4/4 BULLISH</span></td>
                                <td id="sigConsensusPositionConf">75%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Fibonacci Levels Section -->
            <div class="card">
                <div class="card-title"> Fibonacci Levels (<span id="sigFibSymbol">SPY</span>)</div>
                <div style="background: rgba(59,130,246,0.1); border-left: 4px solid #3b82f6; padding: 12px 15px; border-radius: 6px; margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #666;"> Proximity Alert</div>
                    <div style="font-size: 16px; font-weight: 600;" id="sigFibProximity">Loading...</div>
                </div>
                <div class="table-wrap">
                    <table style="font-size: 11px;">
                        <thead>
                            <tr>
                                <th>Level</th>
                                <th>Price</th>
                                <th>Distance</th>
                                <th></th>
                                <th>Date Set</th>
                                <th>TF</th>
                                <th>Implication</th>
                            </tr>
                        </thead>
                        <tbody id="sigFibTable">
                            <!-- Generated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Technical Patterns Section -->
            <div class="card">
                <div class="card-title"> Technical Patterns Detected</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Pattern</th>
                                <th>Type</th>
                                <th>Date Detected</th>
                                <th>Timeframe</th>
                                <th>Confidence</th>
                                <th>Target</th>
                                <th>Implication</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Double Bottom</strong></td>
                                <td style="color: #22c55e;">Bullish</td>
                                <td>Dec 8</td>
                                <td>Daily</td>
                                <td>72%</td>
                                <td>$605.00</td>
                                <td>Reversal confirmed</td>
                                <td><span class="badge badge-success">ACTIVE</span></td>
                            </tr>
                            <tr>
                                <td><strong>Ascending Triangle</strong></td>
                                <td style="color: #22c55e;">Bullish</td>
                                <td>Dec 6</td>
                                <td>4-Hour</td>
                                <td>65%</td>
                                <td>$600.00</td>
                                <td>Breakout pending</td>
                                <td><span class="badge badge-success">ACTIVE</span></td>
                            </tr>
                            <tr>
                                <td><strong>Bullish Engulfing</strong></td>
                                <td style="color: #22c55e;">Bullish</td>
                                <td>Dec 10</td>
                                <td>Daily</td>
                                <td>78%</td>
                                <td>$598.50</td>
                                <td>Momentum shift</td>
                                <td><span class="badge badge-warning">FORMING</span></td>
                            </tr>
                            <tr>
                                <td><strong>Head & Shoulders (Inv)</strong></td>
                                <td style="color: #22c55e;">Bullish</td>
                                <td>Dec 3</td>
                                <td>Weekly</td>
                                <td>58%</td>
                                <td>$620.00</td>
                                <td>Major reversal</td>
                                <td><span class="badge badge-secondary">WATCH</span></td>
                            </tr>
                            <tr>
                                <td><strong>Rising Wedge</strong></td>
                                <td style="color: #ef4444;">Bearish</td>
                                <td>Dec 5</td>
                                <td>4-Hour</td>
                                <td>45%</td>
                                <td>$585.00</td>
                                <td>Potential pullback</td>
                                <td><span class="badge badge-secondary">WATCH</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- AGENTS TAB - MERGED INTO SIGNALS & AGENTS TAB -->
        <!-- <div id="agents" class="tab-content">
            Content merged into Signals & Agents tab above
        </div> -->

        <!-- PATTERNS TAB -->
        <div id="patterns" class="tab-content">
            <!-- Pattern Summary -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="background: rgba(34,197,94,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                    <div style="font-size: 11px; color: #666;">Bullish Patterns</div>
                    <div style="font-size: 24px; font-weight: 700; color: #22c55e;">5</div>
                </div>
                <div style="background: rgba(239,68,68,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                    <div style="font-size: 11px; color: #666;">Bearish Patterns</div>
                    <div style="font-size: 24px; font-weight: 700; color: #ef4444;">1</div>
                </div>
                <div style="background: rgba(59,130,246,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                    <div style="font-size: 11px; color: #666;">Avg Confidence</div>
                    <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">71%</div>
                </div>
                <div style="background: rgba(168,85,247,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                    <div style="font-size: 11px; color: #666;">Active Setups</div>
                    <div style="font-size: 24px; font-weight: 700; color: #a855f7;">6</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title"> Fibonacci Levels</div>
                <div class="grid grid-2">
                    <div>
                        <div class="ref-data-row"><span class="ref-label">R3 (161.8%)</span><span class="ref-value" id="fibR3" style="color: #22c55e;">$612.40</span></div>
                        <div class="ref-data-row"><span class="ref-label">R2 (127.2%)</span><span class="ref-value" id="fibR2" style="color: #22c55e;">$605.20</span></div>
                        <div class="ref-data-row"><span class="ref-label">R1 (100%)</span><span class="ref-value" id="fibR1" style="color: #22c55e;">$598.50</span></div>
                    </div>
                    <div>
                        <div class="ref-data-row"><span class="ref-label">S1 (38.2%)</span><span class="ref-value" id="fibS1" style="color: #ef4444;">$590.15</span></div>
                        <div class="ref-data-row"><span class="ref-label">S2 (50.0%)</span><span class="ref-value" id="fibS2" style="color: #ef4444;">$586.80</span></div>
                        <div class="ref-data-row"><span class="ref-label">S3 (61.8%)</span><span class="ref-value" id="fibS3" style="color: #ef4444;">$582.50</span></div>
                    </div>
                </div>
            </div>
            <div class="grid grid-3">
                <div class="card">
                    <div class="card-title"> Technical</div>
                    <div class="pattern-item">
                        <div class="pattern-header"><span class="pattern-name">Double Bottom</span><span class="badge badge-success">72%</span></div>
                        <div class="pattern-bar"><div class="pattern-fill bullish" style="width:72%"></div></div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">Daily | Dec 8 | Reversal confirmed at support</div>
                    </div>
                    <div class="pattern-item">
                        <div class="pattern-header"><span class="pattern-name">Ascending Triangle</span><span class="badge badge-success">65%</span></div>
                        <div class="pattern-bar"><div class="pattern-fill bullish" style="width:65%"></div></div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">4-Hour | Dec 6 | Breakout pending above $600</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title"> Candlestick</div>
                    <div class="pattern-item">
                        <div class="pattern-header"><span class="pattern-name">Bullish Engulfing</span><span class="badge badge-success">78%</span></div>
                        <div class="pattern-bar"><div class="pattern-fill bullish" style="width:78%"></div></div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">Daily | Dec 10 | Strong momentum shift</div>
                    </div>
                    <div class="pattern-item">
                        <div class="pattern-header"><span class="pattern-name">Hammer</span><span class="badge badge-success">70%</span></div>
                        <div class="pattern-bar"><div class="pattern-fill bullish" style="width:70%"></div></div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">4-Hour | Dec 9 | Support bounce confirmed</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title"> Point & Figure</div>
                    <div class="pattern-item">
                        <div class="pattern-header"><span class="pattern-name">Double Top BO</span><span class="badge badge-success">75%</span></div>
                        <div class="pattern-bar"><div class="pattern-fill bullish" style="width:75%"></div></div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">Daily | Dec 7 | Breakout target $605</div>
                    </div>
                    <div class="pattern-item">
                        <div class="pattern-header"><span class="pattern-name">Bullish Catapult</span><span class="badge badge-success">68%</span></div>
                        <div class="pattern-bar"><div class="pattern-fill bullish" style="width:68%"></div></div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">Weekly | Dec 5 | Strong continuation signal</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TRADES TAB - COMPREHENSIVE TRADE LOG -->
        <div id="trades" class="tab-content">
            <!-- Trade Journal Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="font-size: 14px; font-weight: 600; color: var(--text); margin: 0;"> Trade Journal</h3>
                <span id="tradesLastUpdated" class="section-timestamp" style="font-size: 10px; color: var(--muted);" title="Last updated"> --</span>
            </div>
            <!-- Trade Statistics Dashboard -->
            <div class="grid grid-5">
                <div class="metric">
                    <div class="metric-label">Total Trades</div>
                    <div class="metric-value" id="statTotalTrades">0</div>
                    <div class="metric-sub" id="statTradesThisWeek">0 this week</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Win Rate</div>
                    <div class="metric-value positive" id="statWinRate">0%</div>
                    <div class="metric-sub" id="statWinLoss">0W / 0L</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Total P&L</div>
                    <div class="metric-value" id="statTotalPnL">$0.00</div>
                    <div class="metric-sub" id="statAvgTrade">Avg: $0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Best Trade</div>
                    <div class="metric-value positive" id="statBestTrade">$0.00</div>
                    <div class="metric-sub" id="statBestSymbol">--</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Worst Trade</div>
                    <div class="metric-value negative" id="statWorstTrade">$0.00</div>
                    <div class="metric-sub" id="statWorstSymbol">--</div>
                </div>
            </div>

            <!-- Log New Trade Form -->
            <div class="card">
                <div class="card-title"> Log New Trade</div>
                <form id="tradeForm" onsubmit="logTrade(event)">
                    <div class="grid grid-4" style="margin-bottom:12px;">
                        <div class="form-group-trade">
                            <label>Date</label>
                            <input type="date" id="tradeDate" required>
                        </div>
                        <div class="form-group-trade">
                            <label>Symbol</label>
                            <select id="tradeSymbol" required>
                                <option value="SPY">SPY</option>
                                <option value="QQQ">QQQ</option>
                                <option value="IWM">IWM</option>
                                <option value="DIA">DIA</option>
                                <option value="XLF">XLF</option>
                                <option value="XLE">XLE</option>
                                <option value="XLK">XLK</option>
                                <option value="XLV">XLV</option>
                                <option value="XLI">XLI</option>
                                <option value="XLB">XLB</option>
                                <option value="XLU">XLU</option>
                                <option value="XLP">XLP</option>
                                <option value="XLY">XLY</option>
                                <option value="XLRE">XLRE</option>
                                <option value="XLC">XLC</option>
                            </select>
                        </div>
                        <div class="form-group-trade">
                            <label>Direction</label>
                            <select id="tradeDirection" required>
                                <option value="CALL"> CALL</option>
                                <option value="PUT"> PUT</option>
                            </select>
                        </div>
                        <div class="form-group-trade">
                            <label>Trade Type</label>
                            <select id="tradeType" required>
                                <option value="INTRADAY"> Intraday (0DTE)</option>
                                <option value="SWING"> Swing (3-5 DTE)</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-5" style="margin-bottom:12px;">
                        <div class="form-group-trade">
                            <label>Strike Price</label>
                            <input type="number" id="tradeStrike" placeholder="675" step="1" required>
                        </div>
                        <div class="form-group-trade">
                            <label>Contracts</label>
                            <select id="tradeContracts" required>
                                <option value="1">1 Contract</option>
                                <option value="2">2 Contracts</option>
                                <option value="3">3 Contracts</option>
                                <option value="4">4 Contracts</option>
                                <option value="5">5 Contracts</option>
                                <option value="10">10 Contracts</option>
                            </select>
                        </div>
                        <div class="form-group-trade">
                            <label>Entry Premium</label>
                            <input type="number" id="tradeEntry" placeholder="2.50" step="0.01" required>
                        </div>
                        <div class="form-group-trade">
                            <label>Exit Premium</label>
                            <input type="number" id="tradeExit" placeholder="3.75" step="0.01">
                        </div>
                        <div class="form-group-trade">
                            <label>Agent Consensus</label>
                            <select id="tradeConsensus">
                                <option value="4/4">4/4 ULTRA</option>
                                <option value="3/4" selected>3/4 SUPER</option>
                                <option value="2/4">2/4 SINGLE</option>
                                <option value="1/4">1/4 WEAK</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-2" style="margin-bottom:12px;">
                        <div class="form-group-trade">
                            <label>Status</label>
                            <select id="tradeStatus" onchange="toggleExitField()">
                                <option value="CLOSED"> Closed</option>
                                <option value="OPEN"> Open</option>
                                <option value="STOPPED"> Stopped Out</option>
                            </select>
                        </div>
                        <div class="form-group-trade">
                            <label>Notes</label>
                            <input type="text" id="tradeNotes" placeholder="Morning breakout, hit T1...">
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;">
                        <button type="submit" class="trade-btn primary"> Log Trade</button>
                        <button type="button" class="trade-btn secondary" onclick="clearTradeForm()">Clear Form</button>
                    </div>
                </form>
            </div>

            <!-- Trade Actions Bar -->
            <div class="card" style="padding:10px;">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                    <div style="display:flex;gap:8px;align-items:center;">
                        <label style="font-size:11px;color:var(--muted);">Filter:</label>
                        <select id="filterSymbol" onchange="filterTrades()" style="padding:5px;border:1px solid var(--border);border-radius:4px;font-size:11px;">
                            <option value="ALL">All Symbols</option>
                            <option value="SPY">SPY</option>
                            <option value="QQQ">QQQ</option>
                            <option value="IWM">IWM</option>
                            <option value="DIA">DIA</option>
                            <option value="XLF">XLF</option>
                            <option value="XLE">XLE</option>
                            <option value="XLK">XLK</option>
                            <option value="XLV">XLV</option>
                            <option value="XLI">XLI</option>
                            <option value="XLB">XLB</option>
                            <option value="XLU">XLU</option>
                            <option value="XLP">XLP</option>
                            <option value="XLY">XLY</option>
                            <option value="XLRE">XLRE</option>
                            <option value="XLC">XLC</option>
                        </select>
                        <select id="filterDirection" onchange="filterTrades()" style="padding:5px;border:1px solid var(--border);border-radius:4px;font-size:11px;">
                            <option value="ALL">All Directions</option>
                            <option value="CALL">CALL Only</option>
                            <option value="PUT">PUT Only</option>
                        </select>
                        <select id="filterStatus" onchange="filterTrades()" style="padding:5px;border:1px solid var(--border);border-radius:4px;font-size:11px;">
                            <option value="ALL">All Status</option>
                            <option value="OPEN">Open</option>
                            <option value="CLOSED">Closed</option>
                            <option value="STOPPED">Stopped</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="action-btn" onclick="printTrades()"> Print</button>
                        <button class="action-btn" onclick="exportCSV()"> Export CSV</button>
                        <button class="action-btn" onclick="shareTrades()"> Share</button>
                        <button class="action-btn" onclick="emailTrades()"> Email</button>
                        <button class="action-btn danger" onclick="clearAllTrades()"> Clear All</button>
                    </div>
                </div>
            </div>

            <!-- Trade History Table -->
            <div class="card">
                <div class="card-title"> Trade History <span id="tradeCount" style="font-size:11px;color:var(--muted);margin-left:8px;">(0 trades)</span></div>
                <div class="table-wrap" style="max-height:400px;overflow-y:auto;">
                    <table id="tradeTable">
                        <thead>
                            <tr>
                                <th style="width:30px;">#</th>
                                <th>Date</th>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Strike</th>
                                <th>Contracts</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>P&L</th>
                                <th>Consensus</th>
                                <th>Status</th>
                                <th>Notes</th>
                                <th style="width:80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tradeTableBody">
                            <tr><td colspan="13" style="text-align:center;color:var(--muted);padding:30px;">No trades logged yet. Start by logging your first trade above!</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Trade Analytics -->
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-title"> Performance by Symbol</div>
                    <div id="symbolPerformance">
                        <p style="color:var(--muted);font-size:12px;">Log trades to see performance breakdown</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title"> Performance by Direction</div>
                    <div id="directionPerformance">
                        <p style="color:var(--muted);font-size:12px;">Log trades to see CALL vs PUT performance</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title"> Agent Consensus Analysis</div>
                <div id="consensusAnalysis" class="grid grid-4">
                    <div style="background:var(--bg);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--muted);">4/4 ULTRA</div>
                        <div style="font-size:20px;font-weight:700;" id="ultra44WinRate">--%</div>
                        <div style="font-size:10px;color:var(--muted);" id="ultra44Count">0 trades</div>
                    </div>
                    <div style="background:var(--bg);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--muted);">3/4 SUPER</div>
                        <div style="font-size:20px;font-weight:700;" id="super34WinRate">--%</div>
                        <div style="font-size:10px;color:var(--muted);" id="super34Count">0 trades</div>
                    </div>
                    <div style="background:var(--bg);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--muted);">2/4 SINGLE</div>
                        <div style="font-size:20px;font-weight:700;" id="single24WinRate">--%</div>
                        <div style="font-size:10px;color:var(--muted);" id="single24Count">0 trades</div>
                    </div>
                    <div style="background:var(--bg);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--muted);">1/4 WEAK</div>
                        <div style="font-size:20px;font-weight:700;" id="weak14WinRate">--%</div>
                        <div style="font-size:10px;color:var(--muted);" id="weak14Count">0 trades</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- OPPORTUNITIES TAB -->
        <div id="opportunities" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom: 15px;">Trading Opportunities - All Symbols</h3>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 11px; color: #666;">Total Opportunities</div>
                        <div style="font-size: 24px; font-weight: 700;" id="opp-total">12</div>
                    </div>
                    <div style="background: rgba(34,197,94,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 11px; color: #666;">Ready Now</div>
                        <div style="font-size: 24px; font-weight: 700; color: #22c55e;" id="opp-ready">2</div>
                    </div>
                    <div style="background: rgba(234,179,8,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 11px; color: #666;">Coming Soon</div>
                        <div style="font-size: 24px; font-weight: 700; color: #eab308;" id="opp-soon">4</div>
                    </div>
                    <div style="background: rgba(59,130,246,0.1); border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 11px; color: #666;">Calls / Puts</div>
                        <div style="font-size: 24px; font-weight: 700;" id="opp-ratio">7 / 5</div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <button onclick="filterOppTable('all')" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px;">All</button>
                    <button onclick="filterOppTable('calls')" style="padding: 8px 16px; background: #e5e7eb; color: #333; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px;">Calls Only</button>
                    <button onclick="filterOppTable('puts')" style="padding: 8px 16px; background: #e5e7eb; color: #333; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px;">Puts Only</button>
                    <button onclick="filterOppTable('ready')" style="padding: 8px 16px; background: #e5e7eb; color: #333; border: none; border-radius: 6px; cursor: pointer;">Ready Now</button>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f0f0f0;">
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">STATUS</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">SYMBOL</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">SECTOR</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">PRICE</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">NEXT TURN</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">DAYS</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">STAGE</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">% DONE</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">RISK</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">TURN DIR</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">TRADE</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">TARGET</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">PATTERN</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">TF</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">DETECTED</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">SCORE</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="oppTableBody">
                            <tr><td style="padding: 10px;">READY</td><td><strong>SPY</strong></td><td>Index</td><td>$594.82</td><td>Dec 10</td><td>0</td><td><span style="background: rgba(249,115,22,0.2); color: #f97316; padding: 3px 8px; border-radius: 4px; font-weight: 600;">LATE</span></td><td style="color: #f97316; font-weight: 600;">78%</td><td><span style="background: rgba(239,68,68,0.2); color: #ef4444; padding: 3px 8px; border-radius: 4px;">HIGH</span></td><td class="turn-rally"> RALLY</td><td style="color: #22c55e; font-weight: 600;">CALL</td><td>$612.50</td><td>Cycle Low</td><td>Daily</td><td>Dec 08</td><td>72</td><td><button onclick="viewChart('SPY')" style="padding: 4px 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">VIEW</button></td></tr>
                            <tr><td style="padding: 10px;">READY</td><td><strong>QQQ</strong></td><td>Tech</td><td>$518.34</td><td>Dec 10</td><td>0</td><td><span style="background: rgba(234,179,8,0.2); color: #eab308; padding: 3px 8px; border-radius: 4px; font-weight: 600;">MID</span></td><td style="color: #eab308; font-weight: 600;">55%</td><td><span style="background: rgba(234,179,8,0.2); color: #eab308; padding: 3px 8px; border-radius: 4px;">MED</span></td><td class="turn-rally"> RALLY</td><td style="color: #22c55e; font-weight: 600;">CALL</td><td>$538.00</td><td>Cycle Low</td><td>Daily</td><td>Dec 08</td><td>68</td><td><button onclick="viewChart('QQQ')" style="padding: 4px 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">VIEW</button></td></tr>
                            <tr><td style="padding: 10px;">SOON</td><td><strong>IWM</strong></td><td>Small Cap</td><td>$238.91</td><td>Dec 12</td><td>2</td><td><span style="background: rgba(239,68,68,0.2); color: #ef4444; padding: 3px 8px; border-radius: 4px; font-weight: 600;">EXHAUSTED</span></td><td style="color: #ef4444; font-weight: 600;">92%</td><td><span style="background: rgba(239,68,68,0.2); color: #ef4444; padding: 3px 8px; border-radius: 4px;">HIGH</span></td><td class="turn-breakdown"> BREAKDOWN</td><td style="color: #ef4444; font-weight: 600;">PUT</td><td>$228.00</td><td>Cycle High</td><td>Daily</td><td>Dec 09</td><td>65</td><td><button onclick="viewChart('IWM')" style="padding: 4px 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">VIEW</button></td></tr>
                            <tr><td style="padding: 10px;">SOON</td><td><strong>XLF</strong></td><td>Financial</td><td>$48.23</td><td>Dec 13</td><td>3</td><td><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 3px 8px; border-radius: 4px; font-weight: 600;">EARLY</span></td><td style="color: #22c55e; font-weight: 600;">25%</td><td><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 3px 8px; border-radius: 4px;">LOW</span></td><td class="turn-pullback"> PULLBACK</td><td style="color: #22c55e; font-weight: 600;">CALL</td><td>$51.00</td><td>Cycle Low</td><td>Weekly</td><td>Dec 07</td><td>71</td><td><button onclick="viewChart('XLF')" style="padding: 4px 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">VIEW</button></td></tr>
                            <tr><td style="padding: 10px;">SOON</td><td><strong>XLE</strong></td><td>Energy</td><td>$87.56</td><td>Dec 14</td><td>4</td><td><span style="background: rgba(249,115,22,0.2); color: #f97316; padding: 3px 8px; border-radius: 4px; font-weight: 600;">LATE</span></td><td style="color: #f97316; font-weight: 600;">85%</td><td><span style="background: rgba(239,68,68,0.2); color: #ef4444; padding: 3px 8px; border-radius: 4px;">HIGH</span></td><td class="turn-breakdown"> BREAKDOWN</td><td style="color: #ef4444; font-weight: 600;">PUT</td><td>$82.00</td><td>Cycle High</td><td>Daily</td><td>Dec 09</td><td>58</td><td><button onclick="viewChart('XLE')" style="padding: 4px 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">VIEW</button></td></tr>
                            <tr><td style="padding: 10px;">SOON</td><td><strong>XLK</strong></td><td>Technology</td><td>$234.78</td><td>Dec 11</td><td>1</td><td><span style="background: rgba(234,179,8,0.2); color: #eab308; padding: 3px 8px; border-radius: 4px; font-weight: 600;">MID</span></td><td style="color: #eab308; font-weight: 600;">48%</td><td><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 3px 8px; border-radius: 4px;">LOW</span></td><td class="turn-rally"> RALLY</td><td style="color: #22c55e; font-weight: 600;">CALL</td><td>$245.00</td><td>Cycle Low</td><td>Daily</td><td>Dec 08</td><td>74</td><td><button onclick="viewChart('XLK')" style="padding: 4px 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">VIEW</button></td></tr>
                            <tr><td style="padding: 10px;">WAITING</td><td><strong>XLV</strong></td><td>Healthcare</td><td>$146.32</td><td>Dec 18</td><td>8</td><td><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 3px 8px; border-radius: 4px; font-weight: 600;">EARLY</span></td><td style="color: #22c55e; font-weight: 600;">18%</td><td><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 3px 8px; border-radius: 4px;">LOW</span></td><td class="turn-pullback"> PULLBACK</td><td style="color: #22c55e; font-weight: 600;">CALL</td><td>$152.00</td><td>Cycle Low</td><td>Weekly</td><td>Dec 05</td><td>52</td><td><button onclick="viewChart('XLV')" style="padding: 4px 10px; background: #9ca3af; color: white; border: none; border-radius: 4px; cursor: pointer;">VIEW</button></td></tr>
                            <tr><td style="padding: 10px;">WAITING</td><td><strong>XLI</strong></td><td>Industrial</td><td>$139.87</td><td>Dec 20</td><td>10</td><td><span style="background: rgba(234,179,8,0.2); color: #eab308; padding: 3px 8px; border-radius: 4px; font-weight: 600;">MID</span></td><td style="color: #eab308; font-weight: 600;">62%</td><td><span style="background: rgba(234,179,8,0.2); color: #eab308; padding: 3px 8px; border-radius: 4px;">MED</span></td><td class="turn-rally"> RALLY</td><td style="color: #22c55e; font-weight: 600;">CALL</td><td>$148.00</td><td>Cycle Low</td><td>Weekly</td><td>Dec 04</td><td>48</td><td><button onclick="viewChart('XLI')" style="padding: 4px 10px; background: #9ca3af; color: white; border: none; border-radius: 4px; cursor: pointer;">VIEW</button></td></tr>
                            <tr><td style="padding: 10px;">WAITING</td><td><strong>XLB</strong></td><td>Materials</td><td>$89.45</td><td>Dec 22</td><td>12</td><td><span style="background: rgba(249,115,22,0.2); color: #f97316; padding: 3px 8px; border-radius: 4px; font-weight: 600;">LATE</span></td><td style="color: #f97316; font-weight: 600;">88%</td><td><span style="background: rgba(239,68,68,0.2); color: #ef4444; padding: 3px 8px; border-radius: 4px;">HIGH</span></td><td class="turn-breakdown"> BREAKDOWN</td><td style="color: #ef4444; font-weight: 600;">PUT</td><td>$84.00</td><td>Cycle High</td><td>Daily</td><td>Dec 06</td><td>45</td><td><button onclick="viewChart('XLB')" style="padding: 4px 10px; background: #9ca3af; color: white; border: none; border-radius: 4px; cursor: pointer;">VIEW</button></td></tr>
                            <tr><td style="padding: 10px;">WAITING</td><td><strong>XLU</strong></td><td>Utilities</td><td>$77.89</td><td>Dec 25</td><td>15</td><td><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 3px 8px; border-radius: 4px; font-weight: 600;">EARLY</span></td><td style="color: #22c55e; font-weight: 600;">12%</td><td><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 3px 8px; border-radius: 4px;">LOW</span></td><td class="turn-reversal"> REVERSAL</td><td style="color: #22c55e; font-weight: 600;">CALL</td><td>$82.00</td><td>Cycle Low</td><td>Weekly</td><td>Dec 03</td><td>41</td><td><button onclick="viewChart('XLU')" style="padding: 4px 10px; background: #9ca3af; color: white; border: none; border-radius: 4px; cursor: pointer;">VIEW</button></td></tr>
                            <tr><td style="padding: 10px;">WAITING</td><td><strong>XLP</strong></td><td>Consumer Staples</td><td>$81.23</td><td>Dec 28</td><td>18</td><td><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 3px 8px; border-radius: 4px; font-weight: 600;">EARLY</span></td><td style="color: #22c55e; font-weight: 600;">22%</td><td><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 3px 8px; border-radius: 4px;">LOW</span></td><td class="turn-pullback"> PULLBACK</td><td style="color: #22c55e; font-weight: 600;">CALL</td><td>$85.00</td><td>Cycle Low</td><td>Daily</td><td>Dec 02</td><td>38</td><td><button onclick="viewChart('XLP')" style="padding: 4px 10px; background: #9ca3af; color: white; border: none; border-radius: 4px; cursor: pointer;">VIEW</button></td></tr>
                            <tr><td style="padding: 10px;">WAITING</td><td><strong>XLY</strong></td><td>Consumer Disc</td><td>$225.67</td><td>Dec 30</td><td>20</td><td><span style="background: rgba(234,179,8,0.2); color: #eab308; padding: 3px 8px; border-radius: 4px; font-weight: 600;">MID</span></td><td style="color: #eab308; font-weight: 600;">45%</td><td><span style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 3px 8px; border-radius: 4px;">LOW</span></td><td class="turn-rally"> RALLY</td><td style="color: #22c55e; font-weight: 600;">CALL</td><td>$240.00</td><td>Cycle Low</td><td>Weekly</td><td>Dec 01</td><td>35</td><td><button onclick="viewChart('XLY')" style="padding: 4px 10px; background: #9ca3af; color: white; border: none; border-radius: 4px; cursor: pointer;">VIEW</button></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- HEALTH MONITOR TAB -->
        <div id="health" class="tab-content">
            <!-- System Status Banner -->
            <div class="health-banner" id="healthBanner">
                <div class="health-banner-icon" id="healthBannerIcon"></div>
                <div class="health-banner-content">
                    <div class="health-banner-title" id="healthBannerTitle">System Healthy</div>
                    <div class="health-banner-subtitle" id="healthBannerSubtitle">All systems operational</div>
                </div>
                <div id="healthTrafficSummary" style="display: flex; gap: 8px; align-items: center; margin-right: 15px;">
                    <span id="trafficGreenCount" style="font-size: 14px;"> 4</span>
                    <span id="trafficYellowCount" style="font-size: 14px;"> 0</span>
                    <span id="trafficRedCount" style="font-size: 14px;"> 0</span>
                </div>
                <span id="healthLastUpdated" class="section-timestamp" style="font-size: 10px; color: var(--muted); margin-right: 10px;" title="Last health check"> --</span>
                <button class="refresh-health-btn" onclick="runHealthCheck()"> Run Check</button>
            </div>

            <!-- Health Metrics Grid -->
            <div class="grid grid-4">
                <div class="health-metric" id="healthDataFresh">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="health-metric-icon"></div>
                        <div class="health-traffic-light" id="dataFreshnessLight"></div>
                    </div>
                    <div class="health-metric-label">Data Freshness</div>
                    <div class="health-metric-value" id="dataFreshnessValue">Checking...</div>
                    <div class="health-metric-status" id="dataFreshnessStatus">--</div>
                </div>
                <div class="health-metric" id="healthMarket">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="health-metric-icon"></div>
                        <div class="health-traffic-light" id="marketStatusLight"></div>
                    </div>
                    <div class="health-metric-label">Market Status</div>
                    <div class="health-metric-value" id="marketStatusValue">Checking...</div>
                    <div class="health-metric-status" id="marketStatusStatus">--</div>
                </div>
                <div class="health-metric" id="healthWorkflow">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="health-metric-icon"></div>
                        <div class="health-traffic-light" id="workflowStatusLight"></div>
                    </div>
                    <div class="health-metric-label">Agent Workflow</div>
                    <div class="health-metric-value" id="workflowStatusValue">Checking...</div>
                    <div class="health-metric-status" id="workflowStatusStatus">--</div>
                </div>
                <div class="health-metric" id="healthDataQuality">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="health-metric-icon"></div>
                        <div class="health-traffic-light" id="dataQualityLight"></div>
                    </div>
                    <div class="health-metric-label">Data Quality</div>
                    <div class="health-metric-value" id="dataQualityValue">Checking...</div>
                    <div class="health-metric-status" id="dataQualityStatus">--</div>
                </div>
            </div>

            <!-- Detailed Status Cards -->
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-title"> Data Timeline</div>
                    <div class="health-timeline">
                        <div class="timeline-item">
                            <span class="timeline-label">Last Data Point:</span>
                            <span class="timeline-value" id="lastDataDate">--</span>
                        </div>
                        <div class="timeline-item">
                            <span class="timeline-label">Days Since Update:</span>
                            <span class="timeline-value" id="daysSinceUpdate">--</span>
                        </div>
                        <div class="timeline-item">
                            <span class="timeline-label">Expected Update:</span>
                            <span class="timeline-value" id="expectedUpdate">--</span>
                        </div>
                        <div class="timeline-item">
                            <span class="timeline-label">Total Bars Loaded:</span>
                            <span class="timeline-value" id="totalBarsLoaded">--</span>
                        </div>
                        <div class="timeline-item">
                            <span class="timeline-label">Date Range:</span>
                            <span class="timeline-value" id="dataDateRange">--</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"> Connection Status</div>
                    <div class="table-wrap">
                        <table style="font-size: 11px;">
                            <thead>
                                <tr><th>Connection</th><th>Status</th><th>Light</th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>GitHub Pages</td>
                                    <td id="connGitHubStatus">--</td>
                                    <td id="connGitHubLight"></td>
                                </tr>
                                <tr>
                                    <td>Data Feed (<span id="connDataSymbol">SPY</span>.csv)</td>
                                    <td id="connDataStatus">--</td>
                                    <td id="connDataLight"></td>
                                </tr>
                                <tr>
                                    <td>Portfolio Feed</td>
                                    <td id="connPortfolioStatus">--</td>
                                    <td id="connPortfolioLight"></td>
                                </tr>
                                <tr>
                                    <td>Local Storage</td>
                                    <td id="connLocalStorageStatus">--</td>
                                    <td id="connLocalStorageLight"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Alerts & Issues -->
            <div class="card">
                <div class="card-title"> Alerts & Issues</div>
                <div id="healthAlerts" class="health-alerts">
                    <div class="health-alert info">
                        <span class="alert-icon"></span>
                        <span>Running initial health check...</span>
                    </div>
                </div>
            </div>

            <!-- Component Status with Last Run -->
            <div class="card">
                <div class="card-title"> Component Status</div>
                <div class="table-wrap">
                    <table style="font-size: 11px;">
                        <thead>
                            <tr><th>Component</th><th>Last Run</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Data Fetch</td>
                                <td id="compDataFetchTime">--</td>
                                <td id="compDataFetchLight"></td>
                            </tr>
                            <tr>
                                <td>Agent Workflow</td>
                                <td id="compWorkflowTime">--</td>
                                <td id="compWorkflowLight"></td>
                            </tr>
                            <tr>
                                <td>Health Check</td>
                                <td id="compHealthCheckTime">--</td>
                                <td id="compHealthCheckLight"></td>
                            </tr>
                            <tr>
                                <td>GitHub Deploy</td>
                                <td id="compDeployTime">--</td>
                                <td id="compDeployLight"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- System Log -->
            <div class="card">
                <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span> System Log (Last 10 Events)</span>
                    <button onclick="clearSystemLog()" style="background: var(--danger); color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 10px; cursor: pointer;">Clear Log</button>
                </div>
                <div class="table-wrap" style="max-height: 200px; overflow-y: auto;">
                    <table style="font-size: 10px;">
                        <thead>
                            <tr><th>Date/Time</th><th>Event</th><th>Status</th></tr>
                        </thead>
                        <tbody id="systemLogTable">
                            <tr><td colspan="3" style="text-align: center; color: var(--muted);">No events logged yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- System Info -->
            <div class="card">
                <div class="card-title"> System Information</div>
                <div class="grid grid-3">
                    <div class="sys-info-item">
                        <div class="sys-info-label">Platform Version</div>
                        <div class="sys-info-value">Stock Agent 4 v7.2</div>
                    </div>
                    <div class="sys-info-item">
                        <div class="sys-info-label">Dashboard</div>
                        <div class="sys-info-value">Q5D Options Platform</div>
                    </div>
                    <div class="sys-info-item">
                        <div class="sys-info-label">Last Health Check</div>
                        <div class="sys-info-value" id="lastHealthCheck">--</div>
                    </div>
                    <div class="sys-info-item">
                        <div class="sys-info-label">Workflow Schedule</div>
                        <div class="sys-info-value">9:35 AM & 4:05 PM ET</div>
                    </div>
                    <div class="sys-info-item">
                        <div class="sys-info-label">Data Source</div>
                        <div class="sys-info-value">Tiingo API</div>
                    </div>
                    <div class="sys-info-item">
                        <div class="sys-info-label">Repository</div>
                        <div class="sys-info-value"><a href="https://github.com/aadey002/Stock-agent-" target="_blank">Stock-agent-</a></div>
                    </div>
                </div>
            </div>

            <!-- Troubleshooting Guide -->
            <div class="card">
                <div class="card-title"> Troubleshooting Guide</div>
                <div class="troubleshoot-accordion">
                    <div class="troubleshoot-item">
                        <div class="troubleshoot-header" onclick="toggleTroubleshoot(this)">
                            <span> Data Not Updating</span>
                            <span class="troubleshoot-toggle">+</span>
                        </div>
                        <div class="troubleshoot-content">
                            <ol>
                                <li>Check GitHub Actions: <a href="https://github.com/aadey002/Stock-agent-/actions" target="_blank">View Workflows</a></li>
                                <li>Verify TIINGO_TOKEN secret is set in repository settings</li>
                                <li>Check if market was open (no updates on weekends/holidays)</li>
                                <li>Manually trigger workflow: Actions  Run workflow</li>
                                <li>Check workflow logs for errors</li>
                            </ol>
                        </div>
                    </div>
                    <div class="troubleshoot-item">
                        <div class="troubleshoot-header" onclick="toggleTroubleshoot(this)">
                            <span> Dashboard Shows Stale Data</span>
                            <span class="troubleshoot-toggle">+</span>
                        </div>
                        <div class="troubleshoot-content">
                            <ol>
                                <li>Hard refresh: Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)</li>
                                <li>Clear browser cache</li>
                                <li>Check if gh-pages branch has latest data</li>
                                <li>Verify GitHub Pages deployment completed</li>
                            </ol>
                        </div>
                    </div>
                    <div class="troubleshoot-item">
                        <div class="troubleshoot-header" onclick="toggleTroubleshoot(this)">
                            <span> Workflow Failing</span>
                            <span class="troubleshoot-toggle">+</span>
                        </div>
                        <div class="troubleshoot-content">
                            <ol>
                                <li>Check Actions tab for error messages</li>
                                <li>Common issues: API rate limits, invalid token, network timeouts</li>
                                <li>Verify Python dependencies are installed</li>
                                <li>Check if Tiingo API is operational</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI ASSISTANT TAB -->
        <div id="ai-assistant" class="tab-content">
            <div class="ai-assistant-container">
                <div class="ai-chat-panel">
                    <div class="ai-chat-header">
                        <div class="ai-avatar"></div>
                        <div>
                            <div style="font-weight:700;">Gann Trading Assistant</div>
                            <div style="font-size:10px;opacity:0.9;">Tunnel Through the Air  Mystifying Square  Divine Proportions</div>
                        </div>
                    </div>
                    <div class="ai-chat-messages" id="aiChatMessages">
                        <div class="ai-message assistant">
                            <div class="message-content">Welcome to the Gann Trading Assistant! 

I'm trained on W.D. Gann's principles from "Tunnel Through the Air", the Mystifying Square (Square of 9), and Divine Proportions (Fibonacci/Golden Ratio).

I can help you with:
  Analyze any ETF/stock on the dashboard
  Find high-consensus trades (3/4, 4/4)
  Recommend optimal strikes
  Gann time cycles & Square of 9
  Divine Proportions (Phi/Fibonacci)
  Generate custom reports

Try: "Show me all ETFs with 4/4 consensus"</div>
                        </div>
                    </div>
                    <div class="ai-chat-input">
                        <input type="text" id="aiInput" placeholder="Ask about trades, Gann methods, analysis..." onkeypress="if(event.key==='Enter')sendAiMessage()">
                        <button onclick="sendAiMessage()" id="aiSendBtn">Send</button>
                    </div>
                </div>
                
                <div class="ai-sidebar">
                    <div class="ai-quick-actions">
                        <h4> Quick Actions</h4>
                        <button class="quick-action-btn" onclick="askAi('Show me all ETFs with 3/4 or 4/4 agent consensus today')"> High Consensus Trades</button>
                        <button class="quick-action-btn" onclick="askAi('Which ETFs are breaking out today?')"> Morning Breakouts</button>
                        <button class="quick-action-btn" onclick="askAi('Scan for all patterns')"> Pattern Scan</button>
                        <button class="quick-action-btn" onclick="askAi('Show momentum rankings')"> Momentum Leaders</button>
                        <button class="quick-action-btn" onclick="askAi('Any reversal patterns forming?')"> Reversal Scan</button>
                        <button class="quick-action-btn" onclick="askAi('What are the best CALL options for the next 2 days?')"> Best CALLs</button>
                        <button class="quick-action-btn" onclick="askAi('What are the best PUT options for the next 2 days?')"> Best PUTs</button>
                        <button class="quick-action-btn" onclick="askAi('What is the optimal strike for ' + currentSymbol + '?')"> Optimal Strike</button>
                        <button class="quick-action-btn" onclick="askAi('When is the best time to trade options?')"> Best Time to Trade</button>
                        <button class="quick-action-btn" onclick="askAi('Show bar count for all ETFs')"> Bar Count</button>
                    </div>
                    
                    <div class="ai-data-context">
                        <h4> Current Context</h4>
                        <div class="context-item"><span>Symbol:</span><span id="aiContextSymbol">SPY</span></div>
                        <div class="context-item"><span>Price:</span><span id="aiContextPrice">$675.02</span></div>
                        <div class="context-item"><span>Signal:</span><span id="aiContextSignal">CALL</span></div>
                        <div class="context-item"><span>Consensus:</span><span id="aiContextConsensus">3/4</span></div>
                        <div class="context-item"><span>Mode:</span><span id="aiContextMode">INTRADAY</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DAILY ANALYSIS TAB -->
        <div id="daily-analysis" class="tab-content">
            <div class="analysis-header">
                <div>
                    <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 4px;"> Daily Trading Analysis</h2>
                    <p style="font-size: 12px; color: var(--muted);">Comprehensive signal confluence with Gann & Fibonacci analysis</p>
                </div>
                <div class="analysis-time">
                    <button class="analysis-time-btn active" onclick="switchAnalysisMode('morning')" id="morningBtn"> Morning Plan</button>
                    <button class="analysis-time-btn" onclick="switchAnalysisMode('evening')" id="eveningBtn"> Evening Review</button>
                    <span id="analysisLastUpdated" class="section-timestamp" style="font-size: 10px; color: var(--muted); margin-left: 10px;" title="Last updated"> --</span>
                </div>
                <div class="report-actions">
                    <button class="report-btn primary" onclick="generateDailyReport()"> Generate Report</button>
                    <button class="report-btn success" onclick="downloadReport()"> Download PDF</button>
                    <button class="report-btn warning" onclick="refreshAnalysis()"> Refresh</button>
                </div>
            </div>

            <!-- Signal Confluence Score -->
            <div class="signal-confluence-card">
                <div style="text-align: center;">
                    <h3 style="font-size: 14px; color: var(--muted); margin-bottom: 5px;"> MASTER SIGNAL CONFLUENCE</h3>
                    <div style="font-size: 12px; color: var(--muted);" id="confluenceSymbol">SPY Analysis</div>
                </div>
                <div class="confluence-score bullish" id="masterConfluenceScore">+7.5</div>
                <div style="text-align: center; margin-bottom: 15px;">
                    <span id="confluenceDirection" style="font-size: 18px; font-weight: 700; color: var(--success);">BULLISH BIAS</span>
                    <span style="font-size: 12px; color: var(--muted); margin-left: 10px;">Confidence: <span id="confluenceConfidence">85%</span></span>
                </div>
                
                <div class="signal-breakdown">
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Agent Consensus</span>
                            <span class="signal-item-score bullish" id="agentScore">4/4</span>
                        </div>
                        <div class="signal-item-detail" id="agentDetail">All 4 agents agree: CALL signal</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Bar Count</span>
                            <span class="signal-item-score bullish" id="barCountScore">+12</span>
                        </div>
                        <div class="signal-item-detail" id="barCountDetail">12 consecutive bullish bars</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Pattern Score</span>
                            <span class="signal-item-score bullish" id="patternScore">+3</span>
                        </div>
                        <div class="signal-item-detail" id="patternDetail">Bull flag + Golden cross detected</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Gann Cycle</span>
                            <span class="signal-item-score bullish" id="gannScore">+2</span>
                        </div>
                        <div class="signal-item-detail" id="gannDetail">Time cycle supports upside</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Fibonacci</span>
                            <span class="signal-item-score neutral" id="fibScore">0</span>
                        </div>
                        <div class="signal-item-detail" id="fibDetail">At 50% retracement level</div>
                    </div>
                    <div class="signal-item">
                        <div class="signal-item-header">
                            <span class="signal-item-name"> Volume</span>
                            <span class="signal-item-score bullish" id="volumeScore">+1.5</span>
                        </div>
                        <div class="signal-item-detail" id="volumeDetail">Above average volume confirmed</div>
                    </div>
                </div>
            </div>

            <!-- Trading Plan -->
            <div class="trading-plan" id="tradingPlanContainer">
                <div class="trading-plan-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="font-size: 16px; margin-bottom: 4px;" id="planTitle"> Morning Trading Plan</h3>
                            <div style="font-size: 11px; opacity: 0.9;" id="planDate">Wednesday, November 26, 2025</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 11px; opacity: 0.9;">Generated at</div>
                            <div style="font-weight: 600;" id="planTime">9:35 AM ET</div>
                        </div>
                    </div>
                </div>
                <div class="trading-plan-body">
                    <!-- Top Trade Recommendations -->
                    <div class="plan-section">
                        <div class="plan-section-title"> Top Trade Recommendations</div>
                        <div id="tradeRecommendations">
                            <!-- Generated dynamically -->
                        </div>
                    </div>

                    <!-- Gann Analysis -->
                    <div class="plan-section">
                        <div class="plan-section-title"> Gann Time Cycles & Square of 9</div>
                        <div class="gann-analysis" id="gannAnalysis">
                            <div class="grid grid-2" style="gap: 20px;">
                                <div>
                                    <h4 style="font-size: 12px; margin-bottom: 10px;"> Time Cycles</h4>
                                    <div style="font-size: 11px; color: var(--muted); line-height: 1.8;" id="gannTimeCycles">
                                         30-day cycle: Bottoming phase<br>
                                         90-day cycle: Mid-cycle thrust<br>
                                         180-day cycle: Bullish continuation<br>
                                         Annual cycle: Q4 strength expected
                                    </div>
                                </div>
                                <div>
                                    <h4 style="font-size: 12px; margin-bottom: 10px;"> Square of 9 Levels</h4>
                                    <div style="font-size: 11px; color: var(--muted); line-height: 1.8;" id="squareOf9">
                                         Resistance 1: <span style="color:var(--danger);font-weight:600;">$685.00</span><br>
                                         Resistance 2: <span style="color:var(--danger);font-weight:600;">$692.50</span><br>
                                         Support 1: <span style="color:var(--success);font-weight:600;">$672.00</span><br>
                                         Support 2: <span style="color:var(--success);font-weight:600;">$665.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Divine Proportions -->
                    <div class="plan-section">
                        <div class="plan-section-title"> Divine Proportions (Phi/Fibonacci)</div>
                        <div class="phi-levels" id="phiLevels">
                            <div class="phi-level">
                                <div class="phi-level-name">23.6% Retrace</div>
                                <div class="phi-level-value" id="phi236">$678.50</div>
                            </div>
                            <div class="phi-level">
                                <div class="phi-level-name">38.2% Retrace</div>
                                <div class="phi-level-value" id="phi382">$675.20</div>
                            </div>
                            <div class="phi-level">
                                <div class="phi-level-name">50% Retrace</div>
                                <div class="phi-level-value" id="phi50">$672.00</div>
                            </div>
                            <div class="phi-level">
                                <div class="phi-level-name">61.8% (Golden)</div>
                                <div class="phi-level-value" id="phi618">$668.80</div>
                            </div>
                            <div class="phi-level">
                                <div class="phi-level-name">78.6% Retrace</div>
                                <div class="phi-level-value" id="phi786">$664.50</div>
                            </div>
                            <div class="phi-level">
                                <div class="phi-level-name">161.8% Ext</div>
                                <div class="phi-level-value" id="phi1618">$695.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- High Consensus Trades -->
                    <div class="plan-section">
                        <div class="plan-section-title"> High Consensus Trades (3/4 or 4/4)</div>
                        <div class="table-wrap">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Signal</th>
                                        <th>Consensus</th>
                                        <th>Confluence</th>
                                        <th>Entry Zone</th>
                                        <th>Stop</th>
                                        <th>Target</th>
                                        <th>Strike</th>
                                    </tr>
                                </thead>
                                <tbody id="highConsensusTable">
                                    <!-- Generated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Market Context -->
                    <div class="plan-section">
                        <div class="plan-section-title"> Market Context</div>
                        <div class="grid grid-3" style="gap: 15px;" id="marketContext">
                            <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 10px; color: var(--muted);">Overall Bias</div>
                                <div style="font-size: 16px; font-weight: 700; color: var(--success);" id="overallBias">BULLISH</div>
                            </div>
                            <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 10px; color: var(--muted);">Sector Leaders</div>
                                <div style="font-size: 12px; font-weight: 600;" id="sectorLeaders">XLK, XLF</div>
                            </div>
                            <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 10px; color: var(--muted);">Risk Level</div>
                                <div style="font-size: 16px; font-weight: 700; color: var(--warning);" id="riskLevel">MODERATE</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Summary -->
                    <div class="plan-section" style="border-bottom: none;">
                        <div class="plan-section-title"> AI Trading Summary</div>
                        <div style="background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); padding: 15px; border-radius: 8px; font-size: 12px; line-height: 1.8;" id="aiSummary">
                            <strong>Morning Analysis:</strong> Market conditions favor bullish positions today. SPY showing strong momentum with 4/4 agent consensus. Key levels to watch: Support at $672 (50% Fib), Resistance at $685 (Square of 9). 
                            <br><br>
                            <strong>Recommended Strategy:</strong> Focus on CALL spreads on high-consensus ETFs (SPY, QQQ). Entry on pullbacks to Fibonacci support levels. Time stops align with Gann 30-day cycle completion around Dec 15.
                            <br><br>
                            <strong>Risk Management:</strong> Position size 1-2% per trade. Stop losses below 61.8% Fibonacci level. Take profits at 161.8% extension or when 3+ agents flip to HOLD.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evening Review Section (Hidden by default) -->
            <div id="eveningReviewSection" style="display: none;">
                <div class="trading-plan">
                    <div class="trading-plan-header" style="background: linear-gradient(135deg, #1e3a5f, #2d1b4e);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="font-size: 16px; margin-bottom: 4px;"> Evening Review & Next Day Plan</h3>
                                <div style="font-size: 11px; opacity: 0.9;" id="eveningDate">Wednesday, November 26, 2025</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 11px; opacity: 0.9;">Market Close</div>
                                <div style="font-weight: 600;">4:00 PM ET</div>
                            </div>
                        </div>
                    </div>
                    <div class="trading-plan-body">
                        <!-- Today's Performance -->
                        <div class="plan-section">
                            <div class="plan-section-title"> Today's Performance</div>
                            <div class="grid grid-4" style="gap: 15px;" id="todayPerformance">
                                <div style="background: rgba(16,185,129,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="spyChange">+0.85%</div>
                                    <div style="font-size: 11px; color: var(--muted);">SPY</div>
                                </div>
                                <div style="background: rgba(16,185,129,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="qqqChange">+1.20%</div>
                                    <div style="font-size: 11px; color: var(--muted);">QQQ</div>
                                </div>
                                <div style="background: rgba(239,68,68,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--danger);" id="iwmChange">-0.35%</div>
                                    <div style="font-size: 11px; color: var(--muted);">IWM</div>
                                </div>
                                <div style="background: rgba(16,185,129,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="diaChange">+0.45%</div>
                                    <div style="font-size: 11px; color: var(--muted);">DIA</div>
                                </div>
                            </div>
                        </div>

                        <!-- Signal Accuracy -->
                        <div class="plan-section">
                            <div class="plan-section-title"> Signal Accuracy Review</div>
                            <div id="signalAccuracy" style="font-size: 12px; line-height: 1.8; color: var(--muted);">
                                 Morning CALL signal on SPY:  Correct (+0.85%)<br>
                                 QQQ breakout prediction:  Correct (+1.20%)<br>
                                 IWM neutral signal:  Missed downside<br>
                                 Overall accuracy today: <span style="color: var(--success); font-weight: 700;">75%</span>
                            </div>
                        </div>

                        <!-- Tomorrow's Outlook -->
                        <div class="plan-section">
                            <div class="plan-section-title"> Tomorrow's Outlook</div>
                            <div id="tomorrowOutlook" style="background: var(--bg); padding: 15px; border-radius: 8px; font-size: 12px; line-height: 1.8;">
                                <strong>Key Events:</strong> Pre-Thanksgiving trading, expect lower volume<br>
                                <strong>Bias:</strong> Continuation of bullish momentum likely<br>
                                <strong>Watch List:</strong> SPY for breakout above $685, QQQ tech rotation<br>
                                <strong>Caution:</strong> Holiday-shortened week, reduced liquidity
                            </div>
                        </div>

                        <!-- Next Day Trade Setups -->
                        <div class="plan-section" style="border-bottom: none;">
                            <div class="plan-section-title"> Next Day Trade Setups</div>
                            <div id="nextDaySetups">
                                <!-- Generated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GANN ANALYSIS TAB -->
        <div id="gann-analysis" class="tab-content">
            <!-- Sacred geometry background pattern -->
            <div class="gann-background-pattern"></div>

            <!-- Gann Header -->
            <div class="card gann-header-card" style="background: linear-gradient(135deg, rgba(212,160,23,0.15), rgba(184,134,11,0.1)); border: 1px solid rgba(212,160,23,0.3); margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <h2 style="font-size: 20px; font-weight: 700; color: #d4a017; margin: 0; display: flex; align-items: center; gap: 10px;">
                             W.D. Gann Master Analysis
                            <span id="gannLastUpdated" class="section-timestamp" style="font-size: 10px; color: var(--muted); font-weight: normal;"> --</span>
                        </h2>
                        <p style="font-size: 11px; color: var(--muted); margin: 4px 0 0 0;">"Time is more important than price" - W.D. Gann</p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="font-size: 12px; color: var(--muted);">Analyzing:</span>
                        <span id="gannCurrentSymbol" style="font-size: 16px; font-weight: 700; color: #d4a017;">SPY</span>
                        <span id="gannCurrentPrice" style="font-size: 16px; font-weight: 600; color: var(--text);">$---</span>
                        <button onclick="updateGannAnalysis()" style="background: linear-gradient(135deg, #d4a017, #b8860b); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;"> Recalculate</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-2" style="gap: 15px;">
                <!-- SECTION 1: Square of 9 Calculator -->
                <div class="card gann-card" style="background: linear-gradient(135deg, rgba(212,160,23,0.08), rgba(0,0,0,0)); border: 1px solid rgba(212,160,23,0.2);">
                    <div class="card-title" style="color: #d4a017; border-bottom: 1px solid rgba(212,160,23,0.2); padding-bottom: 10px; margin-bottom: 15px;">
                         Square of 9 Calculator
                    </div>
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="font-size: 11px; color: var(--muted); display: block; margin-bottom: 4px;">Input Price</label>
                            <input type="number" id="sq9Input" placeholder="Enter price" style="width: 100%; padding: 8px 12px; border: 1px solid rgba(212,160,23,0.3); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 14px;" onchange="updateSquareOf9()">
                        </div>
                        <button onclick="autoFillSq9Price()" style="background: rgba(212,160,23,0.2); color: #d4a017; border: 1px solid rgba(212,160,23,0.3); padding: 8px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; align-self: flex-end;">Use Current</button>
                    </div>

                    <!-- Visual Square of 9 Spiral -->
                    <div id="sq9Visual" style="position: relative; width: 100%; height: 200px; background: radial-gradient(circle, rgba(212,160,23,0.1) 0%, transparent 70%); border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center;">
                        <div id="sq9Spiral" style="font-size: 11px; text-align: center; color: var(--muted);">
                            Enter price to generate Square of 9
                        </div>
                    </div>

                    <!-- Support & Resistance Levels -->
                    <div class="grid grid-2" style="gap: 10px;">
                        <div style="background: rgba(34,197,94,0.1); border-radius: 8px; padding: 10px;">
                            <h4 style="font-size: 11px; color: #22c55e; margin-bottom: 8px; font-weight: 600;"> SUPPORT LEVELS</h4>
                            <div id="sq9Support" style="font-size: 10px; line-height: 1.6;">
                                <div style="display: flex; justify-content: space-between;"><span>-45:</span><span style="color: #22c55e; font-weight: 600;">$602.15</span></div>
                                <div style="display: flex; justify-content: space-between;"><span>-90:</span><span style="color: #22c55e; font-weight: 600;">$597.28</span></div>
                                <div style="display: flex; justify-content: space-between;"><span>-180:</span><span style="color: #22c55e; font-weight: 600;">$587.54</span></div>
                                <div style="display: flex; justify-content: space-between;"><span>-360:</span><span style="color: #22c55e; font-weight: 600;">$568.06</span></div>
                            </div>
                        </div>
                        <div style="background: rgba(239,68,68,0.1); border-radius: 8px; padding: 10px;">
                            <h4 style="font-size: 11px; color: #ef4444; margin-bottom: 8px; font-weight: 600;"> RESISTANCE LEVELS</h4>
                            <div id="sq9Resistance" style="font-size: 10px; line-height: 1.6;">
                                <div style="display: flex; justify-content: space-between;"><span>+45:</span><span style="color: #ef4444; font-weight: 600;">$612.03</span></div>
                                <div style="display: flex; justify-content: space-between;"><span>+90:</span><span style="color: #ef4444; font-weight: 600;">$616.90</span></div>
                                <div style="display: flex; justify-content: space-between;"><span>+180:</span><span style="color: #ef4444; font-weight: 600;">$626.64</span></div>
                                <div style="display: flex; justify-content: space-between;"><span>+360:</span><span style="color: #ef4444; font-weight: 600;">$646.12</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: Gann Time Cycles -->
                <div class="card gann-card" style="background: linear-gradient(135deg, rgba(212,160,23,0.08), rgba(0,0,0,0)); border: 1px solid rgba(212,160,23,0.2);">
                    <div class="card-title" style="color: #d4a017; border-bottom: 1px solid rgba(212,160,23,0.2); padding-bottom: 10px; margin-bottom: 15px;">
                         Gann Time Cycles
                    </div>

                    <!-- Cycle Turn Alert -->
                    <div id="cycleAlert" style="display: none; background: rgba(245,158,11,0.2); border: 1px solid #f59e0b; border-radius: 8px; padding: 10px; margin-bottom: 15px; text-align: center;">
                        <span style="font-size: 14px;"></span>
                        <span style="font-size: 12px; font-weight: 600; color: #f59e0b;"> CYCLE TURN ZONE - High probability reversal window!</span>
                    </div>

                    <!-- Important Gann Dates -->
                    <div style="background: rgba(139,92,246,0.1); border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                        <h4 style="font-size: 11px; color: #8b5cf6; margin-bottom: 8px;"> Sacred Calendar Dates</h4>
                        <div id="gannDates" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; font-size: 10px;">
                            <div style="background: rgba(139,92,246,0.15); padding: 6px 8px; border-radius: 4px;"><span style="color: var(--muted);">Winter Solstice:</span> <span style="color: #8b5cf6; font-weight: 600;">Dec 21</span></div>
                            <div style="background: rgba(139,92,246,0.15); padding: 6px 8px; border-radius: 4px;"><span style="color: var(--muted);">Spring Equinox:</span> <span style="color: #8b5cf6; font-weight: 600;">Mar 20</span></div>
                            <div style="background: rgba(139,92,246,0.15); padding: 6px 8px; border-radius: 4px;"><span style="color: var(--muted);">Summer Solstice:</span> <span style="color: #8b5cf6; font-weight: 600;">Jun 21</span></div>
                            <div style="background: rgba(139,92,246,0.15); padding: 6px 8px; border-radius: 4px;"><span style="color: var(--muted);">Fall Equinox:</span> <span style="color: #8b5cf6; font-weight: 600;">Sep 22</span></div>
                        </div>
                    </div>

                    <!-- Cycle Progress Bars -->
                    <div id="cycleProgress" style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="background: var(--bg); border-radius: 6px; padding: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 10px;">
                                <span style="color: var(--muted);">7-Day Cycle</span>
                                <span style="color: #22c55e; font-weight: 600;">Day 3 of 7</span>
                            </div>
                            <div style="background: var(--border); border-radius: 4px; height: 6px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #22c55e, #10b981); height: 100%; width: 43%; border-radius: 4px;"></div>
                            </div>
                        </div>
                        <div style="background: var(--bg); border-radius: 6px; padding: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 10px;">
                                <span style="color: var(--muted);">30-Day Cycle</span>
                                <span style="color: #f59e0b; font-weight: 600;">Day 22 of 30</span>
                            </div>
                            <div style="background: var(--border); border-radius: 4px; height: 6px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #f59e0b, #eab308); height: 100%; width: 73%; border-radius: 4px;"></div>
                            </div>
                        </div>
                        <div style="background: var(--bg); border-radius: 6px; padding: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 10px;">
                                <span style="color: var(--muted);">90-Day Cycle</span>
                                <span style="color: #3b82f6; font-weight: 600;">Day 68 of 90</span>
                            </div>
                            <div style="background: var(--border); border-radius: 4px; height: 6px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #3b82f6, #6366f1); height: 100%; width: 76%; border-radius: 4px;"></div>
                            </div>
                        </div>
                        <div style="background: var(--bg); border-radius: 6px; padding: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 10px;">
                                <span style="color: var(--muted);">Annual Cycle</span>
                                <span style="color: #8b5cf6; font-weight: 600;">Day 345 of 365</span>
                            </div>
                            <div style="background: var(--border); border-radius: 4px; height: 6px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #8b5cf6, #a855f7); height: 100%; width: 95%; border-radius: 4px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-2" style="gap: 15px; margin-top: 15px;">
                <!-- SECTION 3: Gann Angles -->
                <div class="card gann-card" style="background: linear-gradient(135deg, rgba(212,160,23,0.08), rgba(0,0,0,0)); border: 1px solid rgba(212,160,23,0.2);">
                    <div class="card-title" style="color: #d4a017; border-bottom: 1px solid rgba(212,160,23,0.2); padding-bottom: 10px; margin-bottom: 15px;">
                         Gann Angles from Pivot
                    </div>

                    <!-- Pivot Detection -->
                    <div class="grid grid-2" style="gap: 10px; margin-bottom: 15px;">
                        <div style="background: rgba(34,197,94,0.1); border-radius: 8px; padding: 10px;">
                            <div style="font-size: 10px; color: var(--muted);">Last Significant Low</div>
                            <div id="gannPivotLow" style="font-size: 14px; font-weight: 600; color: #22c55e;">$479.05 (Oct 27)</div>
                        </div>
                        <div style="background: rgba(239,68,68,0.1); border-radius: 8px; padding: 10px;">
                            <div style="font-size: 10px; color: var(--muted);">Last Significant High</div>
                            <div id="gannPivotHigh" style="font-size: 14px; font-weight: 600; color: #ef4444;">$609.07 (Dec 6)</div>
                        </div>
                    </div>

                    <!-- Angles from Low -->
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-size: 11px; color: #22c55e; margin-bottom: 8px;"> Angles from Low (Bullish)</h4>
                        <div id="anglesFromLow" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; font-size: 10px;">
                            <div style="background: rgba(34,197,94,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">1x1</div><div style="color: #22c55e; font-weight: 600;">$523.05</div></div>
                            <div style="background: rgba(34,197,94,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">2x1</div><div style="color: #22c55e; font-weight: 600;">$567.05</div></div>
                            <div style="background: rgba(34,197,94,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">4x1</div><div style="color: #22c55e; font-weight: 600;">$655.05</div></div>
                            <div style="background: rgba(34,197,94,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">1x2</div><div style="color: #22c55e; font-weight: 600;">$501.05</div></div>
                            <div style="background: rgba(34,197,94,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">1x4</div><div style="color: #22c55e; font-weight: 600;">$490.05</div></div>
                            <div style="background: rgba(34,197,94,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">8x1</div><div style="color: #22c55e; font-weight: 600;">$831.05</div></div>
                        </div>
                    </div>

                    <!-- Angles from High -->
                    <div>
                        <h4 style="font-size: 11px; color: #ef4444; margin-bottom: 8px;"> Angles from High (Bearish)</h4>
                        <div id="anglesFromHigh" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; font-size: 10px;">
                            <div style="background: rgba(239,68,68,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">1x1</div><div style="color: #ef4444; font-weight: 600;">$605.07</div></div>
                            <div style="background: rgba(239,68,68,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">2x1</div><div style="color: #ef4444; font-weight: 600;">$601.07</div></div>
                            <div style="background: rgba(239,68,68,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">4x1</div><div style="color: #ef4444; font-weight: 600;">$593.07</div></div>
                            <div style="background: rgba(239,68,68,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">1x2</div><div style="color: #ef4444; font-weight: 600;">$607.07</div></div>
                            <div style="background: rgba(239,68,68,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">1x4</div><div style="color: #ef4444; font-weight: 600;">$608.07</div></div>
                            <div style="background: rgba(239,68,68,0.15); padding: 6px; border-radius: 4px; text-align: center;"><div style="color: var(--muted);">8x1</div><div style="color: #ef4444; font-weight: 600;">$577.07</div></div>
                        </div>
                    </div>

                    <!-- Current Position -->
                    <div id="gannAnglePosition" style="background: rgba(212,160,23,0.15); border-radius: 8px; padding: 12px; margin-top: 15px; text-align: center;">
                        <span style="font-size: 12px; color: var(--muted);">Current Position: </span>
                        <span id="anglePositionText" style="font-size: 12px; font-weight: 600; color: #d4a017;">Above 2x1 from Low - Strong Bullish</span>
                    </div>
                </div>

                <!-- SECTION 4: Sacred Numbers -->
                <div class="card gann-card" style="background: linear-gradient(135deg, rgba(212,160,23,0.08), rgba(0,0,0,0)); border: 1px solid rgba(212,160,23,0.2);">
                    <div class="card-title" style="color: #d4a017; border-bottom: 1px solid rgba(212,160,23,0.2); padding-bottom: 10px; margin-bottom: 15px;">
                         Sacred Numbers & Proportions
                    </div>

                    <!-- Cardinal Numbers -->
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-size: 11px; color: #8b5cf6; margin-bottom: 8px;">Cardinal Numbers (Degrees)</h4>
                        <div id="cardinalNumbers" class="grid grid-4" style="gap: 6px;">
                            <div style="background: rgba(139,92,246,0.15); padding: 8px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">90</div><div style="color: #8b5cf6; font-weight: 600; font-size: 12px;">$597.28</div></div>
                            <div style="background: rgba(139,92,246,0.15); padding: 8px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">180</div><div style="color: #8b5cf6; font-weight: 600; font-size: 12px;">$587.54</div></div>
                            <div style="background: rgba(139,92,246,0.15); padding: 8px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">270</div><div style="color: #8b5cf6; font-weight: 600; font-size: 12px;">$577.80</div></div>
                            <div style="background: rgba(139,92,246,0.15); padding: 8px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">360</div><div style="color: #8b5cf6; font-weight: 600; font-size: 12px;">$568.06</div></div>
                        </div>
                    </div>

                    <!-- Sacred Numbers -->
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-size: 11px; color: #f59e0b; margin-bottom: 8px;">Sacred Numbers</h4>
                        <div id="sacredNumbers" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px;">
                            <div style="background: rgba(245,158,11,0.15); padding: 6px 4px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">7</div><div style="color: #f59e0b; font-weight: 600; font-size: 11px;">$614.09</div></div>
                            <div style="background: rgba(245,158,11,0.15); padding: 6px 4px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">9</div><div style="color: #f59e0b; font-weight: 600; font-size: 11px;">$616.09</div></div>
                            <div style="background: rgba(245,158,11,0.15); padding: 6px 4px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">12</div><div style="color: #f59e0b; font-weight: 600; font-size: 11px;">$619.09</div></div>
                            <div style="background: rgba(245,158,11,0.15); padding: 6px 4px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">52</div><div style="color: #f59e0b; font-weight: 600; font-size: 11px;">$659.09</div></div>
                            <div style="background: rgba(245,158,11,0.15); padding: 6px 4px; border-radius: 4px; text-align: center;"><div style="color: var(--muted); font-size: 9px;">144</div><div style="color: #f59e0b; font-weight: 600; font-size: 11px;">$751.09</div></div>
                        </div>
                    </div>

                    <!-- Price Relationships -->
                    <div style="background: rgba(59,130,246,0.1); border-radius: 8px; padding: 12px;">
                        <h4 style="font-size: 11px; color: #3b82f6; margin-bottom: 10px;">Price Mathematical Relationships</h4>
                        <div id="priceRelationships" class="grid grid-2" style="gap: 8px; font-size: 11px;">
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--muted);">Price:</span><span style="color: #3b82f6; font-weight: 600;">24.68</span></div>
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--muted);">Price:</span><span style="color: #3b82f6; font-weight: 600;">371,121</span></div>
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--muted);">Price  9:</span><span style="color: #3b82f6; font-weight: 600;">$67.68</span></div>
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--muted);">Price  9:</span><span style="color: #3b82f6; font-weight: 600;">$5,481.63</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 5 & 6: Confluence & Forecast (Full Width) -->
            <div class="grid grid-2" style="gap: 15px; margin-top: 15px;">
                <!-- SECTION 5: Master Confluence -->
                <div class="card gann-card gann-confluence-card" style="background: linear-gradient(135deg, rgba(212,160,23,0.12), rgba(139,92,246,0.08)); border: 1px solid rgba(212,160,23,0.3);">
                    <div class="card-title" style="color: #d4a017; border-bottom: 1px solid rgba(212,160,23,0.2); padding-bottom: 10px; margin-bottom: 15px;">
                         Master Time & Price Confluence
                    </div>

                    <!-- Confluence Score Display -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="position: relative; width: 120px; height: 120px; margin: 0 auto;">
                            <svg viewBox="0 0 120 120" style="transform: rotate(-90deg);">
                                <circle cx="60" cy="60" r="50" fill="none" stroke="var(--border)" stroke-width="10"/>
                                <circle id="confluenceRing" cx="60" cy="60" r="50" fill="none" stroke="#22c55e" stroke-width="10" stroke-dasharray="314" stroke-dashoffset="79" style="transition: stroke-dashoffset 1s ease;"/>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div id="confluenceScore" style="font-size: 28px; font-weight: 700; color: #22c55e;">75</div>
                                <div style="font-size: 10px; color: var(--muted);">/ 100</div>
                            </div>
                        </div>
                        <div id="confluenceLabel" style="font-size: 14px; font-weight: 600; color: #22c55e; margin-top: 10px;">Strong Bullish Confluence</div>
                    </div>

                    <!-- Confluence Factors -->
                    <div id="confluenceFactors" style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(34,197,94,0.1); padding: 8px 10px; border-radius: 6px; font-size: 11px;">
                            <span style="color: var(--text);">Price above 2x1 Gann Angle</span>
                            <span style="color: #22c55e; font-weight: 600;">+20 pts</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(34,197,94,0.1); padding: 8px 10px; border-radius: 6px; font-size: 11px;">
                            <span style="color: var(--text);">Near Sq9 +90 Resistance</span>
                            <span style="color: #22c55e; font-weight: 600;">+15 pts</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(34,197,94,0.1); padding: 8px 10px; border-radius: 6px; font-size: 11px;">
                            <span style="color: var(--text);">30-Day Cycle Maturing</span>
                            <span style="color: #22c55e; font-weight: 600;">+15 pts</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(34,197,94,0.1); padding: 8px 10px; border-radius: 6px; font-size: 11px;">
                            <span style="color: var(--text);">Winter Solstice Approaching</span>
                            <span style="color: #22c55e; font-weight: 600;">+15 pts</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(139,92,246,0.1); padding: 8px 10px; border-radius: 6px; font-size: 11px;">
                            <span style="color: var(--text);">Annual Cycle Near Completion</span>
                            <span style="color: #8b5cf6; font-weight: 600;">+10 pts</span>
                        </div>
                    </div>
                </div>

                <!-- SECTION 6: Gann Forecast -->
                <div class="card gann-card gann-forecast-card" style="background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(212,160,23,0.08)); border: 1px solid rgba(212,160,23,0.3);">
                    <div class="card-title" style="color: #d4a017; border-bottom: 1px solid rgba(212,160,23,0.2); padding-bottom: 10px; margin-bottom: 15px;">
                         Gann Forecast
                    </div>

                    <!-- Direction Bias -->
                    <div id="gannBias" style="text-align: center; padding: 15px; background: rgba(34,197,94,0.15); border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;">GANN DIRECTIONAL BIAS</div>
                        <div id="gannBiasText" style="font-size: 20px; font-weight: 700; color: #22c55e;">BULLISH</div>
                    </div>

                    <!-- Key Levels -->
                    <div class="grid grid-2" style="gap: 10px; margin-bottom: 15px;">
                        <div style="background: rgba(34,197,94,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 10px; color: var(--muted);">Next Support (Sq9)</div>
                            <div id="forecastSupport" style="font-size: 16px; font-weight: 600; color: #22c55e;">$602.15</div>
                        </div>
                        <div style="background: rgba(239,68,68,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 10px; color: var(--muted);">Next Resistance (Sq9)</div>
                            <div id="forecastResistance" style="font-size: 16px; font-weight: 600; color: #ef4444;">$616.90</div>
                        </div>
                    </div>

                    <!-- Cycle Turn -->
                    <div style="background: rgba(139,92,246,0.1); border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                        <div class="grid grid-2" style="gap: 10px;">
                            <div>
                                <div style="font-size: 10px; color: var(--muted);">Next Cycle Turn</div>
                                <div id="forecastCycleDate" style="font-size: 14px; font-weight: 600; color: #8b5cf6;">Dec 21, 2024</div>
                            </div>
                            <div>
                                <div style="font-size: 10px; color: var(--muted);">Days Until</div>
                                <div id="forecastDaysUntil" style="font-size: 14px; font-weight: 600; color: #8b5cf6;">11 days</div>
                            </div>
                        </div>
                    </div>

                    <!-- Projected Move -->
                    <div id="projectedMove" style="background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05)); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; padding: 15px; text-align: center;">
                        <div style="font-size: 10px; color: var(--muted); margin-bottom: 5px;">PROJECTED MOVE</div>
                        <div id="projectedMoveText" style="font-size: 14px; font-weight: 600; color: #22c55e;">Expect +$9.81 move within 7 days to $616.90</div>
                    </div>
                </div>
            </div>

            <!-- Gann Wisdom Quote -->
            <div class="card" style="background: linear-gradient(135deg, rgba(212,160,23,0.05), transparent); border: 1px solid rgba(212,160,23,0.15); margin-top: 15px; text-align: center; padding: 15px;">
                <div id="gannQuote" style="font-style: italic; color: var(--muted); font-size: 12px;">
                    "The future is but a repetition of the past." - W.D. Gann
                </div>
            </div>
        </div>

        <!-- MULTI-CHARTS TAB -->
                <div id="multi-charts" class="tab-content">
            <div class="card" style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div class="card-title" style="margin: 0;"> Multi-Timeframe Chart Analysis <span id="multiChartsLastUpdated" class="section-timestamp" style="font-size: 10px; color: var(--muted); font-weight: normal; margin-left: 10px;" title="Last updated"> --</span></div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <label style="font-size: 11px; color: var(--muted);">Symbol:</label>
                        <select id="multiChartSymbol" onchange="syncSymbolFromMultiCharts()" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; font-weight: 600;">
                            <option value="SPY">SPY</option>
                            <option value="QQQ">QQQ</option>
                            <option value="IWM">IWM</option>
                            <option value="DIA">DIA</option>
                            <option value="XLF">XLF</option>
                            <option value="XLE">XLE</option>
                            <option value="XLK">XLK</option>
                            <option value="XLV">XLV</option>
                            <option value="XLI">XLI</option>
                            <option value="XLB">XLB</option>
                            <option value="XLU">XLU</option>
                            <option value="XLP">XLP</option>
                            <option value="XLY">XLY</option>
                            <option value="XLRE">XLRE</option>
                            <option value="XLC">XLC</option>
                        </select>
                        <button onclick="refreshAllCharts()" style="padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;"> Refresh All</button>
                    </div>
                </div>
            </div>

            <!-- MTF Bias Summary -->
            <div class="mtf-summary">
                <div class="mtf-summary-title"> Multi-Timeframe Bias Summary</div>
                <div class="mtf-summary-grid">
                    <div class="mtf-summary-item">
                        <div class="title"> Intraday</div>
                        <div class="value bullish" id="intradayBias">BULLISH</div>
                    </div>
                    <div class="mtf-summary-item">
                        <div class="title"> Swing</div>
                        <div class="value bullish" id="swingBias">BULLISH</div>
                    </div>
                    <div class="mtf-summary-item">
                        <div class="title"> Position</div>
                        <div class="value bearish" id="positionBias">BEARISH</div>
                    </div>
                    <div class="mtf-summary-item">
                        <div class="title"> Confluence</div>
                        <div class="value bullish" id="overallBias">2/3 BULLISH</div>
                    </div>
                </div>
            </div>

            <div class="multi-charts-container">
                <!-- INTRADAY PANEL -->
                <div class="chart-panel">
                    <div class="chart-panel-header">
                        <div class="chart-panel-title">
                            <span class="icon intraday"></span>
                            <span>Intraday</span>
                            <span class="signal-badge-mtf call" id="intradaySignal">CALL</span>
                        </div>
                        <div class="chart-controls">
                            <select id="intradayTimeframe" class="chart-select" onchange="updateChart('intraday')">
                                <option value="5">5 Min</option>
                                <option value="10">10 Min</option>
                                <option value="15" selected>15 Min</option>
                            </select>
                            <select id="intradayChartType" class="chart-select" onchange="updateChart('intraday')">
                                <option value="candlestick">Candlestick</option>
                                <option value="heikinashi">Heikin Ashi</option>
                                <option value="line">Line</option>
                                <option value="pf">Point & Figure</option>
                            </select>
                            <button class="settings-btn-mtf" onclick="toggleMTFSettings('intraday')"></button>
                        </div>
                    </div>
                    <div class="settings-panel-mtf" id="intradaySettings">
                        <div class="settings-row-mtf">
                            <label><input type="checkbox" id="intradayShowEMA" checked onchange="updateChart('intraday')"> EMAs</label>
                            <label><input type="checkbox" id="intradayShowFib" checked onchange="updateChart('intraday')"> Fib Levels</label>
                            <label><input type="checkbox" id="intradayShowPatterns" checked onchange="updateChart('intraday')"> Patterns</label>
                            <label><input type="checkbox" id="intradayShowVolume" checked onchange="updateChart('intraday')"> Volume</label>
                        </div>
                    </div>
                    <div id="intradayPattern" class="pattern-alert-mtf" style="display:none;"></div>
                    <div class="chart-body" id="intradayChartBody">
                        <div class="chart-legend">
                            <span class="symbol" id="intradaySymbol">SPY</span>
                            <span class="price" id="intradayPrice">--</span>
                        </div>
                        <div class="chart-canvas-container" id="intradayChartContainer"></div>
                        <div class="chart-loading" id="intradayLoading">Loading chart...</div>
                    </div>
                    <div class="mtf-legend" id="intradayLegend">
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#f59e0b;"></div> EMA 9</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#3b82f6;"></div> EMA 21</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#8b5cf6;"></div> EMA 50</div>
                    </div>
                    <div class="fib-levels-mtf" id="intradayFib"></div>
                </div>

                <!-- SWING PANEL -->
                <div class="chart-panel">
                    <div class="chart-panel-header">
                        <div class="chart-panel-title">
                            <span class="icon swing"></span>
                            <span>Swing</span>
                            <span class="signal-badge-mtf call" id="swingSignal">CALL</span>
                        </div>
                        <div class="chart-controls">
                            <select id="swingTimeframe" class="chart-select" onchange="updateChart('swing')">
                                <option value="D" selected>Daily</option>
                                <option value="W">Weekly</option>
                            </select>
                            <select id="swingChartType" class="chart-select" onchange="updateChart('swing')">
                                <option value="candlestick">Candlestick</option>
                                <option value="heikinashi">Heikin Ashi</option>
                                <option value="line">Line</option>
                                <option value="pf">Point & Figure</option>
                            </select>
                            <button class="settings-btn-mtf" onclick="toggleMTFSettings('swing')"></button>
                        </div>
                    </div>
                    <div class="settings-panel-mtf" id="swingSettings">
                        <div class="settings-row-mtf">
                            <label><input type="checkbox" id="swingShowEMA" checked onchange="updateChart('swing')"> EMAs</label>
                            <label><input type="checkbox" id="swingShowFib" checked onchange="updateChart('swing')"> Fib Levels</label>
                            <label><input type="checkbox" id="swingShowPatterns" checked onchange="updateChart('swing')"> Patterns</label>
                            <label><input type="checkbox" id="swingShowVolume" checked onchange="updateChart('swing')"> Volume</label>
                        </div>
                    </div>
                    <div id="swingPattern" class="pattern-alert-mtf" style="display:none;"></div>
                    <div class="chart-body" id="swingChartBody">
                        <div class="chart-legend">
                            <span class="symbol" id="swingSymbol">SPY</span>
                            <span class="price" id="swingPrice">--</span>
                        </div>
                        <div class="chart-canvas-container" id="swingChartContainer"></div>
                        <div class="chart-loading" id="swingLoading">Loading chart...</div>
                    </div>
                    <div class="mtf-legend" id="swingLegend">
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#f59e0b;"></div> EMA 9</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#3b82f6;"></div> EMA 21</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#8b5cf6;"></div> EMA 50</div>
                    </div>
                    <div class="fib-levels-mtf" id="swingFib"></div>
                </div>

                <!-- POSITION PANEL -->
                <div class="chart-panel">
                    <div class="chart-panel-header">
                        <div class="chart-panel-title">
                            <span class="icon position"></span>
                            <span>Position</span>
                            <span class="signal-badge-mtf put" id="positionSignal">PUT</span>
                        </div>
                        <div class="chart-controls">
                            <select id="positionTimeframe" class="chart-select" onchange="updateChart('position')">
                                <option value="M" selected>Monthly</option>
                                <option value="Q">Quarterly</option>
                            </select>
                            <select id="positionChartType" class="chart-select" onchange="updateChart('position')">
                                <option value="candlestick">Candlestick</option>
                                <option value="heikinashi">Heikin Ashi</option>
                                <option value="line">Line</option>
                                <option value="pf">Point & Figure</option>
                            </select>
                            <button class="settings-btn-mtf" onclick="toggleMTFSettings('position')"></button>
                        </div>
                    </div>
                    <div class="settings-panel-mtf" id="positionSettings">
                        <div class="settings-row-mtf">
                            <label><input type="checkbox" id="positionShowEMA" checked onchange="updateChart('position')"> EMAs</label>
                            <label><input type="checkbox" id="positionShowFib" checked onchange="updateChart('position')"> Fib Levels</label>
                            <label><input type="checkbox" id="positionShowPatterns" checked onchange="updateChart('position')"> Patterns</label>
                            <label><input type="checkbox" id="positionShowVolume" checked onchange="updateChart('position')"> Volume</label>
                        </div>
                    </div>
                    <div id="positionPattern" class="pattern-alert-mtf" style="display:none;"></div>
                    <div class="chart-body" id="positionChartBody">
                        <div class="chart-legend">
                            <span class="symbol" id="positionSymbol">SPY</span>
                            <span class="price" id="positionPrice">--</span>
                        </div>
                        <div class="chart-canvas-container" id="positionChartContainer"></div>
                        <div class="chart-loading" id="positionLoading">Loading chart...</div>
                    </div>
                    <div class="mtf-legend" id="positionLegend">
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#f59e0b;"></div> EMA 9</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#3b82f6;"></div> EMA 21</div>
                        <div class="legend-item-mtf"><div class="legend-color-mtf" style="background:#8b5cf6;"></div> EMA 50</div>
                    </div>
                    <div class="fib-levels-mtf" id="positionFib"></div>
                </div>
            </div>

            <!-- Chart Info Card -->
            <div class="card">
                <div class="card-title"> Chart Type Guide</div>
                <div class="grid grid-3" style="gap: 15px;">
                    <div style="background: rgba(245,158,11,0.1); padding: 12px; border-radius: 8px;">
                        <h4 style="font-size: 12px; color: var(--intraday); margin-bottom: 6px;"> Intraday (5-15 min)</h4>
                        <p style="font-size: 11px; color: var(--muted);">Short-term scalping & day trading. Best for 0-1 DTE options.</p>
                    </div>
                    <div style="background: rgba(139,92,246,0.1); padding: 12px; border-radius: 8px;">
                        <h4 style="font-size: 12px; color: var(--swing); margin-bottom: 6px;"> Swing (Daily/Weekly)</h4>
                        <p style="font-size: 11px; color: var(--muted);">Medium-term swing trades. Best for 3-14 DTE options.</p>
                    </div>
                    <div style="background: rgba(16,185,129,0.1); padding: 12px; border-radius: 8px;">
                        <h4 style="font-size: 12px; color: var(--success); margin-bottom: 6px;"> Position (Monthly)</h4>
                        <p style="font-size: 11px; color: var(--muted);">Long-term position trades. Best for 30+ DTE options.</p>
                    </div>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                    <div class="grid grid-4" style="gap: 15px;">
                        <div>
                            <h4 style="font-size: 11px; color: var(--text); margin-bottom: 4px;"> Candlestick</h4>
                            <p style="font-size: 10px; color: var(--muted);">Traditional OHLC candles showing price action.</p>
                        </div>
                        <div>
                            <h4 style="font-size: 11px; color: var(--text); margin-bottom: 4px;"> Heikin Ashi</h4>
                            <p style="font-size: 10px; color: var(--muted);">Smoothed candles that filter noise.</p>
                        </div>
                        <div>
                            <h4 style="font-size: 11px; color: var(--text); margin-bottom: 4px;"> Line</h4>
                            <p style="font-size: 10px; color: var(--muted);">Simple line chart for trend clarity.</p>
                        </div>
                        <div>
                            <h4 style="font-size: 11px; color: var(--text); margin-bottom: 4px;"> Point & Figure</h4>
                            <p style="font-size: 10px; color: var(--muted);">X's and O's with pattern detection.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>




        <!-- OPTIONS CALCULATOR TAB -->
        <div id="options-calc" class="tab-content">
            <div class="options-calc-container">
                <div class="calc-inputs">
                    <h3> Options Profit Calculator</h3>
                    <button class="use-current-btn" onclick="useCurrentSymbolPrice()">
                         Use Current Symbol Price
                    </button>

                    <div class="calc-form-group">
                        <label>Selected Symbol</label>
                        <input type="text" id="calcSymbol" value="SPY" readonly style="background: var(--bg); font-weight: 700;">
                    </div>

                    <div class="calc-row">
                        <div class="calc-form-group">
                            <label>Stock Price ($)</label>
                            <input type="number" id="calcStockPrice" value="500" step="0.01" onchange="calculateOptions()">
                        </div>
                        <div class="calc-form-group">
                            <label>Strike Price ($)</label>
                            <input type="number" id="calcStrikePrice" value="500" step="1" onchange="calculateOptions()">
                        </div>
                    </div>

                    <div class="calc-row">
                        <div class="calc-form-group">
                            <label>Days to Expiration</label>
                            <input type="number" id="calcDTE" value="7" min="1" max="365" onchange="calculateOptions()">
                        </div>
                        <div class="calc-form-group">
                            <label>Contracts</label>
                            <input type="number" id="calcContracts" value="1" min="1" max="1000" onchange="calculateOptions()">
                        </div>
                    </div>

                    <div class="calc-row">
                        <div class="calc-form-group">
                            <label>Implied Volatility (%)</label>
                            <input type="number" id="calcIV" value="20" step="0.1" min="1" max="200" onchange="calculateOptions()">
                        </div>
                        <div class="calc-form-group">
                            <label>Risk-Free Rate (%)</label>
                            <input type="number" id="calcRiskFree" value="5.0" step="0.1" min="0" max="20" onchange="calculateOptions()">
                        </div>
                    </div>

                    <div class="calc-form-group">
                        <label>Option Type</label>
                        <div class="option-type-toggle">
                            <button class="option-type-btn call active" onclick="setOptionType('call')"> CALL</button>
                            <button class="option-type-btn put" onclick="setOptionType('put')"> PUT</button>
                        </div>
                    </div>
                </div>

                <div class="calc-results">
                    <div class="calc-result-card">
                        <h4> Option Valuation</h4>
                        <div class="result-grid">
                            <div class="result-item">
                                <div class="label">Option Price</div>
                                <div class="value" id="calcOptionPrice">$0.00</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Total Cost</div>
                                <div class="value" id="calcTotalCost">$0.00</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Intrinsic Value</div>
                                <div class="value" id="calcIntrinsic">$0.00</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Extrinsic Value</div>
                                <div class="value" id="calcExtrinsic">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="calc-result-card">
                        <h4> Profit and Loss</h4>
                        <div class="result-grid">
                            <div class="result-item">
                                <div class="label">Breakeven</div>
                                <div class="value" id="calcBreakeven">$0.00</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Max Loss</div>
                                <div class="value negative" id="calcMaxLoss">$0.00</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Max Profit</div>
                                <div class="value positive" id="calcMaxProfit">Unlimited</div>
                            </div>
                            <div class="result-item">
                                <div class="label">Risk/Reward</div>
                                <div class="value" id="calcRiskReward">--</div>
                            </div>
                        </div>
                    </div>

                    <div class="calc-result-card">
                        <h4> The Greeks</h4>
                        <div class="greeks-grid">
                            <div class="greek-item">
                                <div class="greek-name">Delta</div>
                                <div class="greek-value" id="calcDelta">0.00</div>
                            </div>
                            <div class="greek-item">
                                <div class="greek-name">Gamma</div>
                                <div class="greek-value" id="calcGamma">0.00</div>
                            </div>
                            <div class="greek-item">
                                <div class="greek-name">Theta</div>
                                <div class="greek-value" id="calcTheta">0.00</div>
                            </div>
                            <div class="greek-item">
                                <div class="greek-name">Vega</div>
                                <div class="greek-value" id="calcVega">0.00</div>
                            </div>
                        </div>

                        <div class="greeks-reference">
                            <h5> Greeks Quick Reference</h5>
                            <table>
                                <tr><td><strong>Delta</strong></td><td>Price change per $1 move in stock</td></tr>
                                <tr><td><strong>Gamma</strong></td><td>Rate of change in Delta per $1 move</td></tr>
                                <tr><td><strong>Theta</strong></td><td>Daily time decay (premium lost per day)</td></tr>
                                <tr><td><strong>Vega</strong></td><td>Price change per 1% change in IV</td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- END CONTAINER -->
    </div>
    <!-- END MAIN APP -->

<script>
// ============================================
// AUTHENTICATION SYSTEM
// ============================================

// CREDENTIALS - Authorized Users
const VALID_CREDENTIALS = {
    // Admin account
    'DrTee': 'Gann2025!',
    // Backup admin
    'admin': 'Q5D@dmin2025'
};

// Session duration in milliseconds
const SESSION_DURATION_DEFAULT = 24 * 60 * 60 * 1000; // 24 hours if not remembered
const SESSION_DURATION_FOREVER = 100 * 365 * 24 * 60 * 60 * 1000; // 100 years (essentially forever)

// Check if user is already logged in
function checkAuth() {
    const session = localStorage.getItem('sa4_session');
    if (session) {
        try {
            const sessionData = JSON.parse(session);
            const now = new Date().getTime();
            
            // Check if session is still valid
            if (sessionData.expiry > now) {
                // Session valid - show main app
                showMainApp(sessionData.username);
                return true;
            } else {
                // Session expired - clear and show login
                localStorage.removeItem('sa4_session');
            }
        } catch (e) {
            localStorage.removeItem('sa4_session');
        }
    }
    
    // No valid session - show login
    showLoginScreen();
    return false;
}

// Handle login form submission
function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const rememberMe = document.getElementById('rememberMe').checked;
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    
    // Disable button during validation
    loginBtn.disabled = true;
    loginBtn.textContent = 'Signing in...';
    
    // Simulate slight delay for security feel
    setTimeout(() => {
        // Validate credentials
        if (VALID_CREDENTIALS[username] && VALID_CREDENTIALS[username] === password) {
            // Success - create session
            const expiry = new Date().getTime() + (rememberMe ? SESSION_DURATION_FOREVER : SESSION_DURATION_DEFAULT);
            const sessionData = {
                username: username,
                expiry: expiry,
                rememberMe: rememberMe,
                loginTime: new Date().toISOString()
            };
            
            localStorage.setItem('sa4_session', JSON.stringify(sessionData));
            
            // Hide error if shown
            loginError.classList.remove('show');
            
            // Show main app
            showMainApp(username);
        } else {
            // Failed - show error
            loginError.classList.add('show');
            document.getElementById('password').value = '';
            document.getElementById('password').classList.add('error');
            
            setTimeout(() => {
                document.getElementById('password').classList.remove('error');
            }, 2000);
        }
        
        // Re-enable button
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
    }, 500);
}

// Handle logout
function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('sa4_session');
        showLoginScreen();
    }
}

// Show login screen
function showLoginScreen() {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.remove('visible');
    document.getElementById('username').focus();
}

// Show main application
function showMainApp(username) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.add('visible');
    document.getElementById('loggedInUser').textContent = username;
    
    // Initialize the app
    initializeApp();
}

// Run auth check on page load
document.addEventListener('DOMContentLoaded', () => {
    showMainApp("admin");
});

// ============================================
// MAIN APPLICATION CODE
// ============================================

// Global State
let currentSymbol = 'SPY';
let tradingMode = 'intraday';
let currentData = [];
let allSymbolsData = {};
let priceChart;
let conversationHistory = [];

const SYMBOLS = ['SPY', 'QQQ', 'IWM', 'DIA', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY', 'XLRE', 'XLC'];
const SYMBOL_NAMES = {
    'SPY': 'S&P 500 ETF', 'QQQ': 'Nasdaq 100 ETF', 'IWM': 'Russell 2000 ETF', 'DIA': 'Dow Jones ETF',
    'XLF': 'Financials', 'XLE': 'Energy', 'XLK': 'Technology', 'XLV': 'Healthcare',
    'XLI': 'Industrials', 'XLB': 'Materials', 'XLU': 'Utilities', 'XLP': 'Consumer Staples',
    'XLY': 'Consumer Discretionary', 'XLRE': 'Real Estate', 'XLC': 'Communication Services'
};

const TRADING_PARAMS = {
    intraday: { fastSMA: 5, slowSMA: 20, atrPeriod: 10, stopATR: 0.75, target1ATR: 1.0, target2ATR: 1.5 },
    swing: { fastSMA: 10, slowSMA: 30, atrPeriod: 14, stopATR: 1.5, target1ATR: 2.0, target2ATR: 3.0 }
};

// ============================================
// GANN KNOWLEDGE BASE - EXPANDED
// ============================================

const GANN_KNOWLEDGE = {
    tunnelThroughAir: ` "THE TUNNEL THROUGH THE AIR" (1927) by W.D. Gann

This novel encodes Gann's most powerful trading secrets through allegory and hidden meanings.

CORE PRINCIPLES:
1. TIME IS MORE IMPORTANT THAN PRICE
   - Time cycles predict WHEN markets will turn
   - Price analysis alone is incomplete
   
2. NATURAL LAW GOVERNS MARKETS
   - Markets follow geometric and astronomical cycles
   - Nothing is random - patterns repeat
   
3. THE WHEEL OF TIME
   - 360 degrees = 1 year cycle
   - Each degree = 1 day
   - Major turns at 90, 180, 270, 360

KEY CYCLES:
 7-year cycle (Biblical/Saturn)
 10-year cycle (Decade)
 20-year cycle (Jupiter-Saturn)
 30-year cycle (Saturn return)
 60-year cycle (Major)
 90-year cycle (Master)

TRADING APPLICATION:
- Count days from major highs/lows
- Watch for turns at 30, 45, 60, 90, 120, 144, 180, 270, 360 days
- Anniversary dates of major moves often repeat`,

    mystifyingSquare: ` THE MYSTIFYING SQUARE (SQUARE OF 9)

The Square of 9 is Gann's most powerful tool - a spiral of numbers revealing price/time relationships.

STRUCTURE:
- Center starts at 1
- Numbers spiral outward counter-clockwise
- Cardinal cross (N,S,E,W) = strongest levels
- 45 angles mark important support/resistance

HOW TO CALCULATE:
1. Take square root of current price: Price
2. Add/subtract for target:
   - 0.125 = 45 move (1/8 turn)
   - 0.25 = 90 move (1/4 turn)
   - 0.5 = 180 move (1/2 turn)
   - 1.0 = 360 move (full turn)
   - 2.0 = 720 move (2 full turns)
3. Square the result: Result

EXAMPLE FOR SPY @ $675:
675 = 25.98
 +0.25 (90) = 26.23 = $688.01 (resistance)
 +0.5 (180) = 26.48 = $701.19 (major resistance)
 -0.25 (90) = 25.73 = $662.03 (support)
 -0.5 (180) = 25.48 = $649.23 (major support)

CARDINAL CROSS LEVELS:
Numbers on same angle have harmonic relationship
- 1, 2, 4, 7, 13, 22, 34, 49... (East)
- 1, 3, 6, 11, 19, 30, 44... (West)

TIME APPLICATION:
Same math applies to time (trading days from pivot)`,

    divineProportions: ` DIVINE PROPORTIONS (PHI & FIBONACCI)

The Golden Ratio (Phi = 1.618) is nature's blueprint that markets follow.

THE GOLDEN RATIO:
 Phi () = 1.618033988...
 Inverse = 0.618033988...
 Square = 2.618
 Phi = 1.272

FIBONACCI SEQUENCE:
1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377...

Each number  previous  1.618 (approaches Phi)

KEY RETRACEMENT LEVELS:
 23.6% - Minor pullback
 38.2% - First major support (Phi inverse)
 50.0% - Halfway (Gann's favorite)
 61.8% - Golden ratio (strongest)
 78.6% - Deep retracement (0.618)

EXTENSION LEVELS:
 100% - Equal move
 127.2% - Phi extension
 161.8% - Phi extension (primary target)
 200% - Double move
 261.8% - Phi squared

GANN'S USE OF PHI:
- Combined with Square of 9
- Price targets at Phi extensions
- Time cycles in Fibonacci days
- 144 days (Fibonacci) = sacred number

DIVINE PROPORTION IN OPTIONS:
 Entry at 61.8% retracement
 Target at 161.8% extension
 Stop below 78.6% retracement`,

    timeCycles: ` GANN TIME CYCLES

"When time is up, the trend changes."

NATURAL TIME DIVISIONS:
 7 days (week)
 30 days (month)
 90 days (quarter)
 365 days (year)

GANN'S KEY NUMBERS:
 30 - Minor cycle
 45 - Important (1/8 year)
 60 - Significant (2 months)
 90 - Major (quarter)
 120 - Important (1/3 year)
 144 - Fibonacci/sacred
 180 - Half year
 270 - 3/4 year
 360 - Full year/circle

ANNIVERSARY DATES:
Major tops/bottoms repeat on:
 Same calendar date
 30, 60, 90... days later
 1, 2, 3... years later

SEASONAL DATES:
 March 21 - Spring equinox
 June 21 - Summer solstice
 September 21 - Fall equinox
 December 21 - Winter solstice

TRADING APPLICATION:
1. Mark major high/low date
2. Add Gann numbers (30, 45, 60, 90...)
3. Watch for reversals on those dates
4. Combine with price levels`,

    platformPrinciples: ` Q5D PLATFORM CORE PRINCIPLES

MULTI-AGENT CONSENSUS SYSTEM:
4 independent agents must agree before trading:

1.  BASE CONFLUENCE - SMA crossover with ATR stops
2.  GANN-ELLIOTT - Gann geometry + Elliott waves
3.  DQN/RL - Reinforcement learning AI
4.  3-WAVE - Simplified impulse detection

SIGNAL CLASSIFICATION:
 1/4 agree = NO TRADE 
 2/4 agree = SINGLE (weak) 
 3/4 agree = SUPER (tradeable) 
 4/4 agree = ULTRA (highest) 

DUAL TIMEFRAME:
 INTRADAY: 0-1 DTE, 5-15 min, tight stops
 SWING: 3-5 DTE, daily, wider stops

WHY MULTI-AGENT WORKS:
- Reduces false signals
- Multiple confirmations
- Different methodologies
- Higher win rate (65-89%)`
};

// Gann Knowledge and other constants are initialized above
// App initialization is now handled by checkAuth() -> showMainApp()

function initTabs() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(btn.dataset.tab).classList.add('active');
            btn.classList.add('active');

            // Trigger Gann Analysis update when tab is clicked
            if (btn.dataset.tab === 'gann-analysis') {
                updateGannAnalysis();
            }
        };
    });
}

// Open TradingView chart for symbol
function viewChart(symbol) {
    const url = 'https://www.tradingview.com/chart/?symbol=' + symbol;
    window.open(url, '_blank');
}

// Opportunities Tab Filter Function
function filterOppTable(filter) {
    const tbody = document.getElementById('oppTableBody');
    if (!tbody) return;

    const rows = tbody.querySelectorAll('tr');

    rows.forEach(row => {
        const status = row.cells[0]?.textContent?.trim().toUpperCase() || '';
        const trade = row.cells[10]?.textContent?.trim().toUpperCase() || '';

        let show = true;

        if (filter === 'calls') {
            show = trade.includes('CALL');
        } else if (filter === 'puts') {
            show = trade.includes('PUT');
        } else if (filter === 'ready') {
            show = status.includes('READY');
        }

        row.style.display = show ? '' : 'none';
    });

    // Update button styles
    const filterDiv = document.querySelector('#opportunities .card');
    if (filterDiv) {
        const buttons = filterDiv.querySelectorAll('button');
        buttons.forEach(btn => {
            const btnText = btn.textContent.toLowerCase();
            if (btnText.includes('view')) return;

            if ((filter === 'all' && btnText === 'all') ||
                (filter === 'calls' && btnText.includes('calls')) ||
                (filter === 'puts' && btnText.includes('puts')) ||
                (filter === 'ready' && btnText.includes('ready'))) {
                btn.style.background = '#3b82f6';
                btn.style.color = 'white';
            } else {
                btn.style.background = '#e5e7eb';
                btn.style.color = '#333';
            }
        });
    }

    // Update summary counts based on visible rows
    let total = 0, ready = 0, lowRisk = 0, calls = 0, puts = 0;
    rows.forEach(row => {
        if (row.style.display !== 'none') {
            total++;
            const st = row.cells[0]?.textContent?.trim().toUpperCase() || '';
            const risk = row.cells[8]?.textContent?.trim().toUpperCase() || '';
            const tr = row.cells[10]?.textContent?.trim().toUpperCase() || '';
            if (st.includes('READY')) ready++;
            if (risk.includes('LOW')) lowRisk++;
            if (tr.includes('CALL')) calls++;
            if (tr.includes('PUT')) puts++;
        }
    });

    if (document.getElementById('opp-total')) document.getElementById('opp-total').textContent = total;
    if (document.getElementById('opp-ready')) document.getElementById('opp-ready').textContent = ready;
    if (document.getElementById('opp-soon')) document.getElementById('opp-soon').textContent = lowRisk;
    if (document.getElementById('opp-ratio')) document.getElementById('opp-ratio').textContent = calls + ' / ' + puts;
}

// Load live prices from CSV data files
async function loadOpportunitiesPrices() {
    const symbols = ['SPY', 'QQQ', 'IWM', 'XLF', 'XLE', 'XLK', 'XLV', 'XLI', 'XLB', 'XLU', 'XLP', 'XLY'];

    for (const symbol of symbols) {
        try {
            const response = await fetch('data/' + symbol + '.csv');
            if (!response.ok) continue;

            const text = await response.text();
            const lines = text.trim().split('\n');

            if (lines.length < 2) continue;

            // Get the last row (most recent data)
            const lastLine = lines[lines.length - 1];
            const columns = lastLine.split(',');

            // CSV format: Date,Open,High,Low,Close,Volume,...
            const closePrice = parseFloat(columns[4]);

            if (isNaN(closePrice)) continue;

            // Find the row in the table and update the price
            const tbody = document.getElementById('oppTableBody');
            if (!tbody) continue;

            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const symbolCell = row.cells[1]?.textContent?.trim();
                if (symbolCell === symbol) {
                    row.cells[3].textContent = '$' + closePrice.toFixed(2);
                }
            });

        } catch (error) {
            console.log('Error loading ' + symbol + ':', error);
        }
    }
}

// Call on page load
document.addEventListener('DOMContentLoaded', function() {
    loadOpportunitiesPrices();
    loadOverviewData();
    // Sort all tables to show newest first after data loads
    setTimeout(sortAllTablesNewestFirst, 1000);
});

// Also call when Opportunities tab is clicked
const oppTab = document.querySelector('[data-tab="opportunities"]');
if (oppTab) {
    oppTab.addEventListener('click', function() {
        setTimeout(loadOpportunitiesPrices, 100);
    });
}

// Call loadOverviewData when Overview tab is clicked
const overviewTab = document.querySelector('[data-tab="overview"]');
if (overviewTab) {
    overviewTab.addEventListener('click', function() {
        setTimeout(loadOverviewData, 100);
    });
}

// Call updateHistoricalAverages when Bar Count tab is clicked
const barcountTab = document.querySelector('[data-tab="barcount"]');
if (barcountTab) {
    barcountTab.addEventListener('click', function() {
        setTimeout(updateHistoricalAverages, 100);
    });
}

// ============================================
// TABLE SORTING UTILITIES - NEWEST FIRST
// ============================================

// Auto-sort all date-based tables to show most recent first
function sortAllTablesNewestFirst() {
    const dateTables = [
        { id: 'barCountTable', dateCol: 1, isDate: true },
        { id: 'historicalDataTable', dateCol: 0, isDate: true },
        { id: 'tradeTableBody', dateCol: 1, isDate: true },
        { id: 'reversalStatsTable', dateCol: 0, isDate: false, sortByRisk: true }
    ];

    dateTables.forEach(config => {
        const tbody = document.getElementById(config.id);
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll('tr'));
        if (rows.length === 0) return;

        rows.sort((a, b) => {
            if (config.sortByRisk) {
                // Sort by risk level (HIGH > MEDIUM > LOW)
                const riskOrder = { 'HIGH': 1, 'MEDIUM': 2, 'MED': 2, 'LOW': 3 };
                const aRisk = a.querySelector('.badge')?.textContent.trim() || 'LOW';
                const bRisk = b.querySelector('.badge')?.textContent.trim() || 'LOW';
                return (riskOrder[aRisk] || 3) - (riskOrder[bRisk] || 3);
            }

            let aVal = a.cells[config.dateCol]?.textContent.trim() || '';
            let bVal = b.cells[config.dateCol]?.textContent.trim() || '';

            if (config.isDate) {
                // Parse dates and sort descending (newest first)
                const aDate = new Date(aVal);
                const bDate = new Date(bVal);
                return bDate - aDate;
            } else {
                // For non-date columns, reverse alphabetically
                return bVal.localeCompare(aVal);
            }
        });

        rows.forEach(row => tbody.appendChild(row));

        // Update row numbers after sorting
        updateRowNumbers(config.id);
    });
}

// Update row numbers dynamically after sorting
function updateRowNumbers(tableId) {
    const tbody = document.getElementById(tableId);
    if (!tbody) return;

    const rows = tbody.querySelectorAll('tr');
    rows.forEach((row, index) => {
        const firstCell = row.cells[0];
        if (firstCell && !isNaN(parseInt(firstCell.textContent))) {
            firstCell.textContent = index + 1;
        }
    });
}

// Load market stats (Today range, 52W range, Volume vs Avg)
async function loadMarketStats(symbol) {
    if (!symbol) symbol = currentSymbol || 'SPY';

    try {
        const response = await fetch('data/' + symbol + '.csv');
        if (!response.ok) {
            console.log('Market stats: No data for ' + symbol);
            return;
        }

        const text = await response.text();
        const lines = text.trim().split('\n');

        if (lines.length < 2) return;

        // Parse all rows to calculate 52W high/low and volume average
        let high52W = -Infinity;
        let low52W = Infinity;
        let volumeSum = 0;
        let volumeCount = 0;

        // Get last 252 trading days (approximately 1 year) for 52W calculations
        const startIdx = Math.max(1, lines.length - 252);

        for (let i = startIdx; i < lines.length; i++) {
            const cols = lines[i].split(',');
            const high = parseFloat(cols[2]);
            const low = parseFloat(cols[3]);
            const volume = parseFloat(cols[5]);

            if (!isNaN(high) && high > high52W) high52W = high;
            if (!isNaN(low) && low < low52W) low52W = low;

            // Calculate 20-day volume average
            if (i >= lines.length - 20 && !isNaN(volume)) {
                volumeSum += volume;
                volumeCount++;
            }
        }

        const avgVolume = volumeCount > 0 ? volumeSum / volumeCount : 0;

        // Get today's data (last row)
        const lastLine = lines[lines.length - 1];
        const cols = lastLine.split(',');

        const todayHigh = parseFloat(cols[2]);
        const todayLow = parseFloat(cols[3]);
        const todayClose = parseFloat(cols[4]);
        const todayVolume = parseFloat(cols[5]);

        // Update Today Low/High
        if (!isNaN(todayLow)) {
            document.getElementById('statTodayLow').textContent = 'L: $' + todayLow.toFixed(2);
        }
        if (!isNaN(todayHigh)) {
            document.getElementById('statTodayHigh').textContent = 'H: $' + todayHigh.toFixed(2);
        }

        // Update 52W Range with color coding
        const stat52W = document.getElementById('stat52WRange');
        if (stat52W && !isNaN(high52W) && !isNaN(low52W)) {
            stat52W.textContent = '$' + low52W.toFixed(2) + ' - $' + high52W.toFixed(2);

            // Color based on where current price is in 52W range
            const range = high52W - low52W;
            const position = (todayClose - low52W) / range;

            if (position > 0.8) {
                stat52W.style.color = '#22c55e'; // Near 52W high - green
            } else if (position < 0.2) {
                stat52W.style.color = '#ef4444'; // Near 52W low - red
            } else {
                stat52W.style.color = 'var(--text)'; // Neutral
            }
        }

        // Update Volume vs Avg
        const statVolume = document.getElementById('statVolumeVsAvg');
        if (statVolume && avgVolume > 0 && !isNaN(todayVolume)) {
            const volPct = ((todayVolume - avgVolume) / avgVolume) * 100;
            const volSign = volPct >= 0 ? '+' : '';
            statVolume.textContent = volSign + volPct.toFixed(0) + '% vs Avg';

            // Color based on volume
            if (volPct > 20) {
                statVolume.style.color = '#22c55e'; // High volume - green
            } else if (volPct < -30) {
                statVolume.style.color = '#ef4444'; // Low volume - red
            } else {
                statVolume.style.color = 'var(--text)'; // Normal
            }
        }

    } catch (error) {
        console.log('Error loading market stats:', error);
    }
}

// Call market stats on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMarketStats();
});

// ==================== TIMESTAMP FUNCTIONS ====================

// Format timestamp as "Dec 2, 2025 2:45 PM ET" or short "2:45 PM"
function formatLastUpdated(date, short = false) {
    if (!date) return '--';
    const d = new Date(date);
    if (isNaN(d.getTime())) return '--';

    const options = short ?
        { hour: 'numeric', minute: '2-digit', hour12: true } :
        { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true };

    let formatted = d.toLocaleString('en-US', options);
    if (!short) formatted += ' ET';
    return formatted;
}

// Get color based on staleness
function getTimestampColor(lastUpdateTime) {
    if (!lastUpdateTime) return 'var(--muted)';

    const now = new Date();
    const updated = new Date(lastUpdateTime);
    const diffMinutes = (now - updated) / (1000 * 60);

    // Check if data is from previous day
    if (updated.toDateString() !== now.toDateString()) {
        return '#ef4444'; // Red - previous day
    }

    if (diffMinutes <= 30) return '#22c55e';      // Green - within 30 min
    if (diffMinutes <= 60) return '#eab308';      // Yellow - 30-60 min
    if (diffMinutes <= 240) return '#f97316';     // Orange - 1-4 hours
    return '#ef4444';                              // Red - more than 4 hours
}

// Update all timestamp displays
function updateAllTimestamps() {
    const now = new Date();
    const timestamps = {
        global: now,
        analysis: now,
        health: now,
        multiCharts: now,
        trades: now
    };

    // Save to localStorage
    localStorage.setItem('stockAgentTimestamps', JSON.stringify(timestamps));

    // Update displays
    updateTimestampDisplays(timestamps);
}

// Update specific section timestamp
function updateSectionTimestamp(section) {
    const timestamps = JSON.parse(localStorage.getItem('stockAgentTimestamps') || '{}');
    timestamps[section] = new Date().toISOString();
    localStorage.setItem('stockAgentTimestamps', JSON.stringify(timestamps));
    updateTimestampDisplays(timestamps);
}

// Update timestamp display elements
function updateTimestampDisplays(timestamps) {
    // Global timestamp
    const globalEl = document.getElementById('globalLastUpdated');
    if (globalEl && timestamps.global) {
        globalEl.textContent = formatLastUpdated(timestamps.global, true);
        globalEl.style.color = getTimestampColor(timestamps.global);
        globalEl.title = 'Last updated: ' + formatLastUpdated(timestamps.global);
    }

    // Analysis timestamp
    const analysisEl = document.getElementById('analysisLastUpdated');
    if (analysisEl && timestamps.analysis) {
        analysisEl.textContent = ' ' + formatLastUpdated(timestamps.analysis, true);
        analysisEl.style.color = getTimestampColor(timestamps.analysis);
        analysisEl.title = 'Last updated: ' + formatLastUpdated(timestamps.analysis);
    }

    // Health timestamp
    const healthEl = document.getElementById('healthLastUpdated');
    if (healthEl && timestamps.health) {
        healthEl.textContent = ' ' + formatLastUpdated(timestamps.health, true);
        healthEl.style.color = getTimestampColor(timestamps.health);
        healthEl.title = 'Last health check: ' + formatLastUpdated(timestamps.health);
    }

    // Multi-Charts timestamp
    const multiChartsEl = document.getElementById('multiChartsLastUpdated');
    if (multiChartsEl && timestamps.multiCharts) {
        multiChartsEl.textContent = ' ' + formatLastUpdated(timestamps.multiCharts, true);
        multiChartsEl.style.color = getTimestampColor(timestamps.multiCharts);
        multiChartsEl.title = 'Last updated: ' + formatLastUpdated(timestamps.multiCharts);
    }

    // Trades timestamp
    const tradesEl = document.getElementById('tradesLastUpdated');
    if (tradesEl && timestamps.trades) {
        tradesEl.textContent = ' ' + formatLastUpdated(timestamps.trades, true);
        tradesEl.style.color = getTimestampColor(timestamps.trades);
        tradesEl.title = 'Last updated: ' + formatLastUpdated(timestamps.trades);
    }
}

// Load saved timestamps from localStorage on page load
function loadSavedTimestamps() {
    const saved = localStorage.getItem('stockAgentTimestamps');
    if (saved) {
        try {
            const timestamps = JSON.parse(saved);
            updateTimestampDisplays(timestamps);
        } catch (e) {
            console.log('Error loading timestamps:', e);
        }
    }
}

// Check staleness and update colors every minute
setInterval(function() {
    const saved = localStorage.getItem('stockAgentTimestamps');
    if (saved) {
        try {
            updateTimestampDisplays(JSON.parse(saved));
        } catch (e) {}
    }
}, 60000); // Check every minute

// Load timestamps on page load
document.addEventListener('DOMContentLoaded', loadSavedTimestamps);

// ==================== END TIMESTAMP FUNCTIONS ====================

function setTradingMode(mode) {
    tradingMode = mode;
    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.mode-btn.${mode}`).classList.add('active');
    document.getElementById('symbolBanner').className = `symbol-banner ${mode}-mode`;
    document.getElementById('currentModeDisplay').textContent = mode.toUpperCase();
    document.getElementById('aiContextMode').textContent = mode.toUpperCase();
}

async function changeSymbol() {
    const newSymbol = document.getElementById('symbolSelect').value;
    console.log(` Changing symbol from ${currentSymbol} to ${newSymbol}`);
    currentSymbol = newSymbol;
    
    // Update ALL symbol displays immediately
    document.getElementById('currentSymbolDisplay').textContent = currentSymbol;
    document.getElementById('currentSymbolName').textContent = SYMBOL_NAMES[currentSymbol] || currentSymbol;
    document.getElementById('tickerSymbol').textContent = currentSymbol;
    document.getElementById('tickerName').textContent = SYMBOL_NAMES[currentSymbol] || currentSymbol;
    document.getElementById('aiContextSymbol').textContent = currentSymbol;
    
    // Update Bar Count tab symbol display
    const barCountSymbol = document.getElementById('barCountCurrentSymbol');
    if (barCountSymbol) barCountSymbol.textContent = currentSymbol;
    
    // Update Multi-Charts symbol selector to match
    const multiChartSymbol = document.getElementById('multiChartSymbol');
    if (multiChartSymbol) multiChartSymbol.value = currentSymbol;
    
    // Update Daily Analysis symbol display
    const confluenceSymbol = document.getElementById('confluenceSymbol');
    if (confluenceSymbol) confluenceSymbol.textContent = currentSymbol + ' Analysis';
    
    // Load the new symbol's data and update everything
    await loadAllData();

    // Update Overview tab with CSV data
    loadOverviewData();

    // Update market stats for new symbol
    loadMarketStats(currentSymbol);

    // Update Options Calculator with new symbol
    updateOptionsCalcForSymbol();

    // Update Gann Analysis if that tab is active
    const gannTab = document.getElementById('gann-analysis');
    if (gannTab && gannTab.classList.contains('active')) {
        updateGannAnalysis();
    }
}

function parseCSV(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return [];
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
        const values = line.split(',');
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i]?.trim() || '');
        return obj;
    });
}

async function loadAllData() {
    document.getElementById('loadingOverlay').classList.add('active');
    try {
        // Try multiple paths for the CSV file
        let r = null;
        let loadedSymbol = currentSymbol;

        // Try data/ folder first, then root
        const paths = [
            `data/${currentSymbol}.csv?t=${Date.now()}`,
            `${currentSymbol}.csv?t=${Date.now()}`
        ];

        for (const path of paths) {
            r = await fetch(path).catch(() => null);
            if (r?.ok) {
                console.log(` Found data at: ${path}`);
                break;
            }
        }
        
        // If the selected symbol's CSV doesn't exist, fall back to SPY
        if (!r?.ok) {
            console.warn(`${currentSymbol}.csv not found, falling back to SPY`);
            // Try SPY in both locations
            r = await fetch('data/SPY.csv?t=' + Date.now()).catch(() => null);
            if (!r?.ok) {
                r = await fetch('SPY.csv?t=' + Date.now()).catch(() => null);
            }
            loadedSymbol = 'SPY';

            // Update the symbol selector back to SPY if data not available
            const select = document.getElementById('symbolSelect');
            if (select) select.value = 'SPY';
            currentSymbol = 'SPY';

            // Show notification
            showDataNotification(`Data loaded for SPY`);
        }
        
        if (r?.ok) {
            currentData = parseCSV(await r.text());
            if (currentData.length) {
                console.log(` Loaded ${currentData.length} bars for ${currentSymbol}`);
                
                // Update ALL dashboard components
                updateDashboard();
                updateBarCountAnalysis();
                updateReversalStats();
                updatePriceChart();
                updateOverviewAiAnalysis();
                updateDataPatternDetection();
                updateOverviewTab();

                // Update Daily Analysis if that tab is active
                const analysisTab = document.getElementById('daily-analysis');
                if (analysisTab && analysisTab.classList.contains('active')) {
                    await loadRealAgentSignals();
                    generateDailyReport();
                }
                
                // Update Multi-Charts if that tab is active
                const multiChartsTab = document.getElementById('multi-charts');
                if (multiChartsTab && multiChartsTab.classList.contains('active')) {
                    updateAllMultiCharts();
                }
                
                // Update symbol displays
                document.getElementById('currentSymbolDisplay').textContent = currentSymbol;
                document.getElementById('currentSymbolName').textContent = SYMBOL_NAMES[currentSymbol] || currentSymbol;
                document.getElementById('tickerSymbol').textContent = currentSymbol;
                document.getElementById('tickerName').textContent = SYMBOL_NAMES[currentSymbol] || currentSymbol;
                document.getElementById('confluenceSymbol').textContent = currentSymbol + ' Analysis';

                // Update market stats in header
                loadMarketStats(currentSymbol);

                // Update timestamps
                updateAllTimestamps();

// Load all symbols data for AI and cross-symbol analysis                await loadAllSymbolsData();
            }
        }
    } catch (e) { console.error('Error:', e); }
    document.getElementById('loadingOverlay').classList.remove('active');
}

function showDataNotification(message) {
    // Create a temporary notification
    const notif = document.createElement('div');
    notif.style.cssText = 'position:fixed;top:80px;right:20px;background:var(--warning);color:white;padding:12px 20px;border-radius:8px;font-size:12px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.2);';
    notif.textContent = ' ' + message;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 3000);
}

async function loadAllSymbolsData() {
    for (const symbol of SYMBOLS) {
        try {
            const r = await fetch(`${symbol}.csv?t=${Date.now()}`).catch(() => null);
            if (r?.ok) {
                allSymbolsData[symbol] = parseCSV(await r.text());
            }
        } catch (e) { console.error(`Error loading ${symbol}:`, e); }
    }
}

function updateDashboard() {
    const lat = currentData[currentData.length - 1];
    const prev = currentData[currentData.length - 2] || lat;
    const price = parseFloat(lat.Close) || 0;
    const prevPrice = parseFloat(prev.Close) || price;
    const chg = price - prevPrice;
    const pct = prevPrice ? (chg / prevPrice * 100) : 0;
    const atr = parseFloat(lat.ATR) || 5;
    const bias = (lat.Bias || '').toUpperCase();

    // Header ticker
    document.getElementById('tickerPrice').textContent = '$' + price.toFixed(2);
    document.getElementById('tickerChange').textContent = (chg >= 0 ? '+' : '') + '$' + Math.abs(chg).toFixed(2);
    document.getElementById('tickerChange').className = 'ticker-change ' + (chg >= 0 ? 'positive' : 'negative');
    document.getElementById('tickerPct').textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';

    // Metrics
    document.getElementById('currentPrice').textContent = '$' + price.toFixed(2);
    document.getElementById('priceSource').textContent = `${currentData.length} bars`;
    document.getElementById('dailyChange').textContent = (chg >= 0 ? '+' : '') + '$' + Math.abs(chg).toFixed(2);
    document.getElementById('dailyChange').className = 'metric-value ' + (chg >= 0 ? 'positive' : 'negative');
    document.getElementById('changePct').textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
    document.getElementById('volumeDisplay').textContent = ((parseFloat(lat.Volume) || 0) / 1e6).toFixed(1) + 'M';
    document.getElementById('signalStatus').textContent = bias || 'HOLD';
    document.getElementById('signalConf').textContent = `${lat.PriceConfluence || 0}/4`;
    document.getElementById('atrDisplay').textContent = '$' + atr.toFixed(2);

    // Date/Time
    const dateStr = lat.Date || '';
    const [datePart, timePart] = dateStr.includes('T') ? dateStr.split('T') : [dateStr, 'EOD'];
    document.getElementById('dataDate').textContent = datePart;
    document.getElementById('dataTime').textContent = timePart.replace('Z', '');

    // AI Context
    document.getElementById('aiContextPrice').textContent = '$' + price.toFixed(2);
    document.getElementById('aiContextSignal').textContent = bias || 'HOLD';
    document.getElementById('aiContextConsensus').textContent = `${lat.PriceConfluence || 0}/4`;

    // Signals
    const ip = TRADING_PARAMS.intraday;
    const sp = TRADING_PARAMS.swing;
    
    document.getElementById('intradaySignal').textContent = bias || 'HOLD';
    document.getElementById('intradaySignal').className = `badge badge-${bias === 'CALL' ? 'success' : (bias === 'PUT' ? 'danger' : 'warning')}`;
    document.getElementById('intradayEntry').textContent = '$' + price.toFixed(2);
    document.getElementById('intradayStop').textContent = '$' + (bias === 'PUT' ? (price + atr * ip.stopATR) : (price - atr * ip.stopATR)).toFixed(2);
    document.getElementById('intradayT1').textContent = '$' + (bias === 'PUT' ? (price - atr * ip.target1ATR) : (price + atr * ip.target1ATR)).toFixed(2);
    document.getElementById('intradayT2').textContent = '$' + (bias === 'PUT' ? (price - atr * ip.target2ATR) : (price + atr * ip.target2ATR)).toFixed(2);
    document.getElementById('intradayStrike').textContent = '$' + Math.round(price) + ' ' + (bias || 'CALL');
    
    document.getElementById('swingSignal').textContent = bias || 'HOLD';
    document.getElementById('swingSignal').className = `badge badge-${bias === 'CALL' ? 'success' : (bias === 'PUT' ? 'danger' : 'warning')}`;
    document.getElementById('swingEntry').textContent = '$' + (price - 2).toFixed(0) + '-' + (price + 2).toFixed(0);
    document.getElementById('swingStop').textContent = '$' + (bias === 'PUT' ? (price + atr * sp.stopATR) : (price - atr * sp.stopATR)).toFixed(2);
    document.getElementById('swingT1').textContent = '$' + (bias === 'PUT' ? (price - atr * sp.target1ATR) : (price + atr * sp.target1ATR)).toFixed(2);
    document.getElementById('swingT2').textContent = '$' + (bias === 'PUT' ? (price - atr * sp.target2ATR) : (price + atr * sp.target2ATR)).toFixed(2);
    document.getElementById('swingStrike').textContent = '$' + (Math.round(price/5)*5) + ' ' + (bias || 'CALL');

    updateReferenceData();
    updateFibonacci();
    updateSignalsFibonacci();
}

function updateReferenceData() {
    const lat = currentData[currentData.length - 1];
    const yearData = currentData.slice(-252);
    
    const highs = yearData.map(d => parseFloat(d.High) || 0);
    const lows = yearData.map(d => parseFloat(d.Low) || 0);
    
    document.getElementById('week52High').textContent = '$' + Math.max(...highs).toFixed(2);
    document.getElementById('week52Low').textContent = '$' + Math.min(...lows).toFixed(2);
    document.getElementById('todayHigh').textContent = '$' + (parseFloat(lat.High) || 0).toFixed(2);
    document.getElementById('todayLow').textContent = '$' + (parseFloat(lat.Low) || 0).toFixed(2);
    
    const todayVol = parseFloat(lat.Volume) || 0;
    const volumes20 = currentData.slice(-20).map(d => parseFloat(d.Volume) || 0);
    const avgVol = volumes20.reduce((a, b) => a + b, 0) / 20;
    
    document.getElementById('avgVolume20').textContent = (avgVol / 1e6).toFixed(1) + 'M';
    document.getElementById('volumeVsAvg').textContent = ((todayVol/avgVol - 1) * 100).toFixed(0) + '%';
    document.getElementById('volumeVsAvgSmall').textContent = ((todayVol/avgVol - 1) * 100).toFixed(0) + '% vs avg';
}

function updateFibonacci() {
    const recent = currentData.slice(-60);
    const highs = recent.map(d => parseFloat(d.High) || 0);
    const lows = recent.map(d => parseFloat(d.Low) || 0);
    const swingHigh = Math.max(...highs);
    const swingLow = Math.min(...lows);
    const price = parseFloat(currentData[currentData.length - 1].Close) || 0;
    const range = swingHigh - swingLow;
    
    const fib382 = swingHigh - (range * 0.382);
    const fib500 = swingHigh - (range * 0.500);
    const fib618 = swingHigh - (range * 0.618);
    const fib100 = swingHigh;
    const fib1272 = swingLow + (range * 1.272);
    const fib1618 = swingLow + (range * 1.618);
    
    document.getElementById('fibR1').textContent = '$' + fib100.toFixed(2);
    document.getElementById('fibR2').textContent = '$' + fib1272.toFixed(2);
    document.getElementById('fibR3').textContent = '$' + fib1618.toFixed(2);
    document.getElementById('fibS1').textContent = '$' + fib382.toFixed(2);
    document.getElementById('fibS2').textContent = '$' + fib500.toFixed(2);
    document.getElementById('fibS3').textContent = '$' + fib618.toFixed(2);
    
    document.getElementById('chartR1').textContent = '$' + fib100.toFixed(2);
    document.getElementById('chartR2').textContent = '$' + fib1272.toFixed(2);
    document.getElementById('chartR3').textContent = '$' + fib1618.toFixed(2);
    document.getElementById('chartS1').textContent = '$' + fib382.toFixed(2);
    document.getElementById('chartS2').textContent = '$' + fib500.toFixed(2);
    document.getElementById('chartS3').textContent = '$' + fib618.toFixed(2);
    
    let zone = 'NEUTRAL';
    if (price > fib100) zone = 'BREAKOUT';
    else if (price > fib382) zone = 'STRONG';
    else if (price > fib500) zone = 'PULLBACK';
    else zone = 'DEEP';
    document.getElementById('fibZone').textContent = zone;
    
    const fastSMA = parseFloat(currentData[currentData.length-1].FastSMA) || price;
    const slowSMA = parseFloat(currentData[currentData.length-1].SlowSMA) || price;
    const trend = fastSMA > slowSMA ? 'BULLISH' : 'BEARISH';
    document.getElementById('trendBadge').textContent = trend;
    document.getElementById('trendBadge').className = `badge badge-${trend === 'BULLISH' ? 'success' : 'danger'}`;
    
    window.fibLevels = { fib100, fib1272, fib1618, fib382, fib500, fib618, swingHigh, swingLow };
}

// FIXED: Bar Count now uses currentSymbol - NEWEST FIRST
function updateBarCountAnalysis() {
    const barCount = parseInt(document.getElementById('barCountSelect')?.value || 20);

    // Use current symbol's data
    const symbolData = currentData;
    if (!symbolData || symbolData.length < 1) return;
    const actualBars = Math.min(barCount, symbolData.length);

    const data = symbolData.slice(-actualBars);
    const table = document.getElementById('barCountTable');
    if (!table) return;

    // Update the symbol display
    document.getElementById('barCountCurrentSymbol').textContent = currentSymbol;

    // Build rows array (oldest to newest for correct bar count calculation)
    let rows = [];
    let baseCount = 0, gannCount = 0, dqnCount = 0, waveCount = 0;

    data.forEach((d, i) => {
        const o = parseFloat(d.Open) || 0;
        const c = parseFloat(d.Close) || 0;
        const isBullish = c >= o;

        if (isBullish) {
            baseCount = baseCount >= 0 ? baseCount + 1 : 1;
            gannCount = gannCount >= 0 ? gannCount + 1 : 1;
            dqnCount = dqnCount >= 0 ? dqnCount + 1 : 1;
            waveCount = waveCount >= 0 ? waveCount + 1 : 1;
        } else {
            baseCount = baseCount <= 0 ? baseCount - 1 : -1;
            gannCount = gannCount <= 0 ? gannCount - 1 : -1;
            dqnCount = dqnCount <= 0 ? dqnCount - 1 : -1;
            waveCount = waveCount <= 0 ? waveCount - 1 : -1;
        }

        const avg = (baseCount + gannCount + dqnCount + waveCount) / 4;
        const date = (d.Date || '').split('T')[0].slice(5);

        rows.push({
            date, o, high: parseFloat(d.High)||0, low: parseFloat(d.Low)||0, c,
            isBullish, baseCount, gannCount, dqnCount, waveCount, avg
        });
    });

    // Reverse to show newest first, then build HTML with correct row numbers
    rows.reverse();
    let html = '';
    rows.forEach((r, i) => {
        html += `<tr>
            <td>${i + 1}</td>
            <td>${r.date}</td>
            <td style="font-size:10px;">${r.o.toFixed(0)}/${r.high.toFixed(0)}/${r.low.toFixed(0)}/${r.c.toFixed(0)}</td>
            <td>${r.isBullish ? '' : ''}</td>
            <td class="${r.baseCount > 0 ? 'positive' : 'negative'}">${r.baseCount > 0 ? '+' : ''}${r.baseCount}</td>
            <td class="${r.gannCount > 0 ? 'positive' : 'negative'}">${r.gannCount > 0 ? '+' : ''}${r.gannCount}</td>
            <td class="${r.dqnCount > 0 ? 'positive' : 'negative'}">${r.dqnCount > 0 ? '+' : ''}${r.dqnCount}</td>
            <td class="${r.waveCount > 0 ? 'positive' : 'negative'}">${r.waveCount > 0 ? '+' : ''}${r.waveCount}</td>
            <td><span class="badge badge-${r.avg > 2 ? 'success' : (r.avg < -2 ? 'danger' : 'warning')}">${r.avg.toFixed(1)}</span></td>
        </tr>`;
    });

    table.innerHTML = html;
    
    document.getElementById('baseBarCount').textContent = (baseCount > 0 ? '+' : '') + baseCount;
    document.getElementById('baseBarCount').style.color = baseCount > 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('gannBarCount').textContent = (gannCount > 0 ? '+' : '') + gannCount;
    document.getElementById('gannBarCount').style.color = gannCount > 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('dqnBarCount').textContent = (dqnCount > 0 ? '+' : '') + dqnCount;
    document.getElementById('dqnBarCount').style.color = dqnCount > 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('waveBarCount').textContent = (waveCount > 0 ? '+' : '') + waveCount;
    document.getElementById('waveBarCount').style.color = waveCount > 0 ? 'var(--success)' : 'var(--danger)';

    // Also update historical averages when bar count analysis updates
    updateHistoricalAverages();
}

// Calculate and update Historical Averages for all symbols
async function updateHistoricalAverages() {
    const symbols = ['SPY', 'QQQ', 'IWM', 'XLF', 'XLE', 'XLK'];

    for (const symbol of symbols) {
        try {
            // Try to get data from allSymbolsData or fetch it
            let data = allSymbolsData[symbol];

            if (!data || data.length < 20) {
                // Try to fetch the CSV
                let response = await fetch('data/' + symbol + '.csv').catch(() => null);
                if (!response?.ok) {
                    response = await fetch(symbol + '.csv').catch(() => null);
                }
                if (response?.ok) {
                    const text = await response.text();
                    data = parseCSV(text);
                }
            }

            if (!data || data.length < 20) continue;

            // Get last 20 bars
            const last20 = data.slice(-20);

            // Calculate OH, OL, OC, Range for each bar
            let sumOH = 0, sumOL = 0, sumOC = 0, sumRange = 0;
            let maxOH = 0, maxOL = 0;

            last20.forEach(bar => {
                const open = parseFloat(bar.Open) || 0;
                const high = parseFloat(bar.High) || 0;
                const low = parseFloat(bar.Low) || 0;
                const close = parseFloat(bar.Close) || 0;

                const oh = high - open;  // Open to High (always positive)
                const ol = open - low;   // Open to Low (always positive)
                const oc = close - open; // Open to Close (can be negative)
                const range = high - low;

                sumOH += oh;
                sumOL += ol;
                sumOC += oc;
                sumRange += range;

                if (oh > maxOH) maxOH = oh;
                if (ol > maxOL) maxOL = ol;
            });

            const avgOH = sumOH / 20;
            const avgOL = sumOL / 20;
            const avgOC = sumOC / 20;
            const avgRange = sumRange / 20;
            const callTarget = avgOH * 0.85;
            const putTarget = avgOL * 0.85;

            // Update table cells
            const symLower = symbol.toLowerCase();
            const updateEl = (id, value, prefix = '') => {
                const el = document.getElementById(id);
                if (el) el.textContent = prefix + '$' + value.toFixed(2);
            };

            updateEl(symLower + 'AvgOH', avgOH, '+');
            updateEl(symLower + 'MaxOH', maxOH, '+');
            updateEl(symLower + 'AvgOL', avgOL, '-');
            updateEl(symLower + 'MaxOL', maxOL, '-');
            updateEl(symLower + 'AvgOC', Math.abs(avgOC), avgOC >= 0 ? '+' : '-');
            updateEl(symLower + 'AvgRange', avgRange);
            updateEl(symLower + 'CallTarget', callTarget, '+');
            updateEl(symLower + 'PutTarget', putTarget, '-');

        } catch (e) {
            console.log('Error calculating averages for ' + symbol + ':', e);
        }
    }

    // Update Today vs Average section for current symbol
    updateTodayVsAverage();
}

// Update Today vs Average comparison for current symbol
function updateTodayVsAverage() {
    if (!currentData || currentData.length < 21) return;

    const last20 = currentData.slice(-21, -1); // Previous 20 bars (not including today)
    const today = currentData[currentData.length - 1];

    // Calculate averages from previous 20 bars
    let sumOH = 0, sumOL = 0, sumRange = 0;

    last20.forEach(bar => {
        const open = parseFloat(bar.Open) || 0;
        const high = parseFloat(bar.High) || 0;
        const low = parseFloat(bar.Low) || 0;

        sumOH += (high - open);
        sumOL += (open - low);
        sumRange += (high - low);
    });

    const avgOH = sumOH / 20;
    const avgOL = sumOL / 20;
    const avgRange = sumRange / 20;

    // Today's values
    const todayOpen = parseFloat(today.Open) || 0;
    const todayHigh = parseFloat(today.High) || 0;
    const todayLow = parseFloat(today.Low) || 0;

    const todayOH = todayHigh - todayOpen;
    const todayOL = todayOpen - todayLow;
    const todayRange = todayHigh - todayLow;

    // Calculate percentages
    const ohPct = avgOH > 0 ? (todayOH / avgOH) * 100 : 0;
    const olPct = avgOL > 0 ? (todayOL / avgOL) * 100 : 0;
    const rangePct = avgRange > 0 ? (todayRange / avgRange) * 100 : 0;

    // Update OH box
    const ohPctEl = document.getElementById('todayOHpct');
    const ohDetailEl = document.getElementById('todayOHdetail');
    const ohStatusEl = document.getElementById('todayOHstatus');
    const ohBoxEl = document.getElementById('todayOHvsAvgBox');

    if (ohPctEl) ohPctEl.textContent = ohPct.toFixed(0) + '%';
    if (ohDetailEl) ohDetailEl.textContent = '$' + todayOH.toFixed(2) + ' of $' + avgOH.toFixed(2) + ' avg';

    if (ohStatusEl && ohBoxEl) {
        if (ohPct < 50) {
            ohBoxEl.style.background = 'rgba(34,197,94,0.1)';
            ohStatusEl.style.color = '#22c55e';
            ohStatusEl.textContent = 'Room to run - upside potential';
        } else if (ohPct < 85) {
            ohBoxEl.style.background = 'rgba(234,179,8,0.1)';
            ohStatusEl.style.color = '#eab308';
            ohStatusEl.textContent = 'Approaching avg - watch closely';
        } else if (ohPct < 100) {
            ohBoxEl.style.background = 'rgba(249,115,22,0.1)';
            ohStatusEl.style.color = '#f97316';
            ohStatusEl.textContent = 'Nearing avg - consider taking profits';
        } else {
            ohBoxEl.style.background = 'rgba(239,68,68,0.1)';
            ohStatusEl.style.color = '#ef4444';
            ohStatusEl.textContent = 'Exceeded avg - extended move';
        }
    }

    // Update OL box
    const olPctEl = document.getElementById('todayOLpct');
    const olDetailEl = document.getElementById('todayOLdetail');
    const olStatusEl = document.getElementById('todayOLstatus');
    const olBoxEl = document.getElementById('todayOLvsAvgBox');

    if (olPctEl) olPctEl.textContent = olPct.toFixed(0) + '%';
    if (olDetailEl) olDetailEl.textContent = '$' + todayOL.toFixed(2) + ' of $' + avgOL.toFixed(2) + ' avg';

    if (olStatusEl && olBoxEl) {
        if (olPct < 50) {
            olBoxEl.style.background = 'rgba(34,197,94,0.1)';
            olStatusEl.style.color = '#22c55e';
            olStatusEl.textContent = 'Room to fall - downside potential';
        } else if (olPct < 85) {
            olBoxEl.style.background = 'rgba(234,179,8,0.1)';
            olStatusEl.style.color = '#eab308';
            olStatusEl.textContent = 'Approaching avg - watch closely';
        } else if (olPct < 100) {
            olBoxEl.style.background = 'rgba(249,115,22,0.1)';
            olStatusEl.style.color = '#f97316';
            olStatusEl.textContent = 'Nearing avg - consider covering puts';
        } else {
            olBoxEl.style.background = 'rgba(239,68,68,0.1)';
            olStatusEl.style.color = '#ef4444';
            olStatusEl.textContent = 'Exceeded avg - strong selling pressure';
        }
    }

    // Update Range box
    const rangePctEl = document.getElementById('todayRangePct');
    const rangeDetailEl = document.getElementById('todayRangeDetail');
    const rangeStatusEl = document.getElementById('todayRangeStatus');
    const rangeBoxEl = document.getElementById('todayRangevsAvgBox');

    if (rangePctEl) rangePctEl.textContent = rangePct.toFixed(0) + '%';
    if (rangeDetailEl) rangeDetailEl.textContent = '$' + todayRange.toFixed(2) + ' of $' + avgRange.toFixed(2) + ' avg';

    if (rangeStatusEl && rangeBoxEl) {
        if (rangePct < 50) {
            rangeBoxEl.style.background = 'rgba(59,130,246,0.1)';
            rangeStatusEl.style.color = '#3b82f6';
            rangeStatusEl.textContent = 'Low volatility - quiet day';
        } else if (rangePct < 85) {
            rangeBoxEl.style.background = 'rgba(34,197,94,0.1)';
            rangeStatusEl.style.color = '#22c55e';
            rangeStatusEl.textContent = 'Normal volatility day';
        } else if (rangePct < 120) {
            rangeBoxEl.style.background = 'rgba(234,179,8,0.1)';
            rangeStatusEl.style.color = '#eab308';
            rangeStatusEl.textContent = 'Above average volatility';
        } else {
            rangeBoxEl.style.background = 'rgba(239,68,68,0.1)';
            rangeStatusEl.style.color = '#ef4444';
            rangeStatusEl.textContent = 'High volatility - be cautious';
        }
    }
}

// Update Signals Tab Fibonacci Table with dynamic data
function updateSignalsFibonacci() {
    if (!currentData || currentData.length < 60) return;

    const tbody = document.getElementById('sigFibTable');
    const proximityEl = document.getElementById('sigFibProximity');
    const symbolEl = document.getElementById('sigFibSymbol');
    if (!tbody) return;

    // Update symbol display
    if (symbolEl) symbolEl.textContent = currentSymbol;

    // Calculate Fibonacci levels from recent data
    const recent = currentData.slice(-60);
    const highs = recent.map(d => parseFloat(d.High) || 0);
    const lows = recent.map(d => parseFloat(d.Low) || 0);
    const swingHigh = Math.max(...highs);
    const swingLow = Math.min(...lows);
    const currentPrice = parseFloat(currentData[currentData.length - 1].Close) || 0;
    const range = swingHigh - swingLow;

    // Find swing high/low dates
    const swingHighIdx = highs.indexOf(swingHigh);
    const swingLowIdx = lows.indexOf(swingLow);
    const swingHighDate = recent[swingHighIdx]?.Date ? new Date(recent[swingHighIdx].Date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '--';
    const swingLowDate = recent[swingLowIdx]?.Date ? new Date(recent[swingLowIdx].Date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '--';

    // Fibonacci levels with implications
    const levels = [
        { name: 'R3 (161.8%)', price: swingLow + (range * 1.618), type: 'resistance', tf: 'Weekly', implication: 'Extended - Take Profits' },
        { name: 'R2 (127.2%)', price: swingLow + (range * 1.272), type: 'resistance', tf: 'Daily', implication: 'Strong Resistance' },
        { name: 'R1 (100%)', price: swingHigh, type: 'resistance', tf: 'Daily', implication: 'First Target', dateSet: swingHighDate },
        { name: 'PIVOT', price: (swingHigh + swingLow) / 2, type: 'pivot', tf: 'Daily', implication: 'Key Decision Level' },
        { name: 'S1 (38.2%)', price: swingHigh - (range * 0.382), type: 'support', tf: 'Daily', implication: 'First Support' },
        { name: 'S2 (50.0%)', price: swingHigh - (range * 0.500), type: 'support', tf: 'Daily', implication: 'Key Support - Add Zone' },
        { name: 'S3 (61.8%)', price: swingHigh - (range * 0.618), type: 'support', tf: 'Weekly', implication: 'Deep Support - Reversal', dateSet: swingLowDate }
    ];

    // Find closest level
    let closestLevel = null;
    let closestDistance = Infinity;
    levels.forEach(level => {
        const dist = Math.abs(currentPrice - level.price);
        if (dist < closestDistance) {
            closestDistance = dist;
            closestLevel = level;
        }
    });

    const closestPct = closestLevel ? ((closestLevel.price - currentPrice) / currentPrice * 100).toFixed(1) : 0;

    // Update proximity alert
    if (proximityEl && closestLevel) {
        const direction = closestLevel.price > currentPrice ? 'below' : 'above';
        const levelType = closestLevel.type === 'resistance' ? '' : closestLevel.type === 'support' ? '' : '';
        proximityEl.innerHTML = `${levelType} <strong>${currentSymbol}</strong> is <strong>${Math.abs(closestPct)}%</strong> away from <strong>${closestLevel.name}</strong> ($${closestLevel.price.toFixed(2)})`;
        proximityEl.style.color = Math.abs(parseFloat(closestPct)) < 1 ? '#ef4444' : 'inherit';
    }

    // Generate table rows
    let html = '';
    levels.forEach(level => {
        const distance = ((level.price - currentPrice) / currentPrice * 100);
        const distanceStr = distance > 0 ? `+${distance.toFixed(1)}%` : `${distance.toFixed(1)}%`;
        const isClosest = level === closestLevel;
        const isApproaching = isClosest && Math.abs(distance) < 2;

        let rowStyle = '';
        let rowColor = '';
        if (level.type === 'resistance') {
            rowColor = '#22c55e';
            if (isApproaching) rowStyle = 'background: rgba(34,197,94,0.15);';
        } else if (level.type === 'support') {
            rowColor = '#ef4444';
            if (isApproaching) rowStyle = 'background: rgba(239,68,68,0.15);';
        } else {
            rowStyle = 'background: rgba(59,130,246,0.1);';
            rowColor = '#3b82f6';
        }

        const approaching = isApproaching ? '<span class="badge badge-success">YES</span>' : 'NO';
        const dateSet = level.dateSet || '--';

        html += `
            <tr style="${rowStyle} color: ${rowColor};">
                <td><strong>${isClosest ? ' ' : ''}${level.name}</strong></td>
                <td style="font-weight: 600;">$${level.price.toFixed(2)}</td>
                <td>${level.type === 'pivot' ? 'Current' : distanceStr}</td>
                <td>${approaching}</td>
                <td>${dateSet}</td>
                <td>${level.tf}</td>
                <td style="font-size: 10px;">${level.implication}</td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function updateReversalStats() {
    const table = document.getElementById('reversalStatsTable');
    if (!table) return;

    let rows = [];

    // First, always show current symbol
    const symbolsToShow = [currentSymbol];
    // Add other symbols if data is available
    for (const symbol of SYMBOLS) {
        if (symbol !== currentSymbol && allSymbolsData[symbol] && allSymbolsData[symbol].length >= 10) {
            symbolsToShow.push(symbol);
        }
    }

    for (const symbol of symbolsToShow) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 10) continue;

        let bullishRuns = [], bearishRuns = [], currentRun = 0, lastDir = null;

        for (const d of data) {
            const isBullish = parseFloat(d.Close) >= parseFloat(d.Open);

            if (lastDir === null) {
                lastDir = isBullish;
                currentRun = 1;
            } else if (isBullish === lastDir) {
                currentRun++;
            } else {
                if (lastDir) bullishRuns.push(currentRun);
                else bearishRuns.push(currentRun);
                lastDir = isBullish;
                currentRun = 1;
            }
        }

        const avgBullish = bullishRuns.length ? (bullishRuns.reduce((a,b) => a+b, 0) / bullishRuns.length).toFixed(1) : 'N/A';
        const avgBearish = bearishRuns.length ? (bearishRuns.reduce((a,b) => a+b, 0) / bearishRuns.length).toFixed(1) : 'N/A';
        const currentDir = lastDir ? 'Bullish' : 'Bearish';
        const avgForDir = lastDir ? parseFloat(avgBullish) : parseFloat(avgBearish);
        const pctOfAvg = avgForDir ? ((currentRun / avgForDir) * 100).toFixed(0) : 'N/A';

        let risk = 'LOW', riskClass = 'success', riskOrder = 3;
        if (pctOfAvg !== 'N/A') {
            const pct = parseInt(pctOfAvg);
            if (pct > 150) { risk = 'HIGH'; riskClass = 'danger'; riskOrder = 1; }
            else if (pct > 100) { risk = 'MEDIUM'; riskClass = 'warning'; riskOrder = 2; }
        }

        rows.push({
            symbol, avgBullish, avgBearish, currentRun, currentDir, pctOfAvg,
            risk, riskClass, riskOrder, isCurrentSymbol: symbol === currentSymbol
        });
    }

    // Sort by risk (HIGH first, then MEDIUM, then LOW)
    rows.sort((a, b) => a.riskOrder - b.riskOrder);

    let html = '';
    if (rows.length === 0) {
        html = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:20px;">Loading data... Select a symbol and wait for data to load.</td></tr>';
    } else {
        rows.forEach(r => {
            html += `<tr ${r.isCurrentSymbol ? 'style="background:rgba(59,130,246,0.1);font-weight:600;"' : ''}>
                <td>${r.isCurrentSymbol ? ' ' : ''}${r.symbol}</td>
                <td>${r.avgBullish} bars</td>
                <td>${r.avgBearish} bars</td>
                <td>${r.currentRun} (${r.currentDir})</td>
                <td>${r.pctOfAvg}%</td>
                <td><span class="badge badge-${r.riskClass}">${r.risk}</span></td>
            </tr>`;
        });
    }

    table.innerHTML = html;
}

function updatePriceChart() {
    const data = currentData.slice(-60);
    const ctx = document.getElementById('priceChart');
    if (!ctx) return;
    
    if (priceChart) priceChart.destroy();
    
    const fib = window.fibLevels || {};
    const colors = data.map(d => parseFloat(d.Close) >= parseFloat(d.Open) ? '#10b981' : '#ef4444');
    
    priceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => (d.Date || '').split('T')[0].slice(5)),
            datasets: [{ label: 'Price', data: data.map(d => parseFloat(d.Close) || 0), backgroundColor: colors, borderColor: colors }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false },
                annotation: { annotations: {
                    r1: { type: 'line', yMin: fib.fib100, yMax: fib.fib100, borderColor: '#ef4444', borderWidth: 1, borderDash: [5,5] },
                    s1: { type: 'line', yMin: fib.fib382, yMax: fib.fib382, borderColor: '#10b981', borderWidth: 1, borderDash: [5,5] },
                    s2: { type: 'line', yMin: fib.fib500, yMax: fib.fib500, borderColor: '#14b8a6', borderWidth: 1, borderDash: [5,5] }
                }}
            },
            scales: { y: { ticks: { callback: v => '$' + v } } }
        }
    });
}

// ============================================
// AI ASSISTANT - IMPROVED
// ============================================

function askAi(question) {
    document.getElementById('aiInput').value = question;
    sendAiMessage();
}

async function sendAiMessage() {
    const input = document.getElementById('aiInput');
    const message = input.value.trim();
    if (!message) return;
    
    const messagesDiv = document.getElementById('aiChatMessages');
    
    messagesDiv.innerHTML += `<div class="ai-message user">${escapeHtml(message)}</div>`;
    input.value = '';
    
    messagesDiv.innerHTML += `<div class="ai-message assistant" id="typingIndicator"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    document.getElementById('aiSendBtn').disabled = true;
    
    // Add to conversation history
    conversationHistory.push({ role: 'user', content: message });
    
    try {
        const response = await generateAiResponse(message);
        document.getElementById('typingIndicator')?.remove();
        messagesDiv.innerHTML += `<div class="ai-message assistant"><div class="message-content">${response}</div></div>`;
        conversationHistory.push({ role: 'assistant', content: response });
    } catch (e) {
        document.getElementById('typingIndicator')?.remove();
        messagesDiv.innerHTML += `<div class="ai-message assistant"><div class="message-content">Sorry, I encountered an error. Please try again.</div></div>`;
    }
    
    document.getElementById('aiSendBtn').disabled = false;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function generateAiResponse(userMessage) {
    const lowerMsg = userMessage.toLowerCase();
    
    // Build context from dashboard data
    const dashboardContext = buildDashboardContext();
    
    // Use local AI responses (API not available in browser due to CORS)
    try {
        console.log("AI Query:", userMessage);
        const response = generateLocalResponse(userMessage, dashboardContext);
        console.log("AI Response generated successfully");
        return response;
    } catch (e) {
        console.error("AI Response error:", e);
        return "I encountered an error processing your request. Please try again or check the console for details.";
    }
}

function buildSystemPrompt(context) {
    return `You are the Gann Trading Assistant for Q5D Options Platform.

KNOWLEDGE BASE:
${GANN_KNOWLEDGE.tunnelThroughAir}
${GANN_KNOWLEDGE.mystifyingSquare}
${GANN_KNOWLEDGE.divineProportions}
${GANN_KNOWLEDGE.timeCycles}
${GANN_KNOWLEDGE.platformPrinciples}

CURRENT DATA:
${context}

RULES:
1. Give specific, actionable trading guidance
2. Use actual dashboard data - never hallucinate
3. Reference Gann principles when relevant
4. Format responses clearly with tables when helpful
5. Be concise but thorough`;
}

function buildDashboardContext() {
    let context = `CURRENT: ${currentSymbol} | Mode: ${tradingMode.toUpperCase()}\n\n`;
    
    if (currentData.length) {
        const lat = currentData[currentData.length - 1];
        const price = parseFloat(lat.Close);
        const atr = parseFloat(lat.ATR) || 5;
        context += `${currentSymbol}: $${price.toFixed(2)} | Signal: ${lat.Bias || 'HOLD'} | Consensus: ${lat.PriceConfluence || 0}/4 | ATR: $${atr.toFixed(2)}\n\n`;
        
        // Square of 9 levels
        const sqrtPrice = Math.sqrt(price);
        context += `Square of 9 for ${currentSymbol}:\n`;
        context += ` +90 (${(sqrtPrice + 0.25)}) = $${Math.pow(sqrtPrice + 0.25, 2).toFixed(2)}\n`;
        context += ` +180 = $${Math.pow(sqrtPrice + 0.5, 2).toFixed(2)}\n`;
        context += ` -90 = $${Math.pow(sqrtPrice - 0.25, 2).toFixed(2)}\n`;
        context += ` -180 = $${Math.pow(sqrtPrice - 0.5, 2).toFixed(2)}\n\n`;
    }
    
    context += `ALL SYMBOLS:\n`;
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            context += `${symbol}: $${parseFloat(lat.Close).toFixed(2)} | ${lat.Bias || 'HOLD'} | ${lat.PriceConfluence || 0}/4\n`;
        }
    }
    
    return context;
}

function generateLocalResponse(message, context) {
    const lowerMsg = message.toLowerCase();
    
    // MORNING BREAKOUT PATTERN
    if (lowerMsg.includes('breakout') || lowerMsg.includes('breaking out') || lowerMsg.includes('breaking above')) {
        return generateBreakoutResponse();
    }
    
    // PATTERN SCAN - General
    if (lowerMsg.includes('pattern') || lowerMsg.includes('setup') || lowerMsg.includes('forming')) {
        return generatePatternScanResponse();
    }
    
    // MOMENTUM / TRENDING
    if (lowerMsg.includes('momentum') || lowerMsg.includes('trending') || lowerMsg.includes('strongest') || lowerMsg.includes('weakest')) {
        return generateMomentumResponse();
    }
    
    // REVERSAL PATTERNS
    if (lowerMsg.includes('reversal') || lowerMsg.includes('turning') || lowerMsg.includes('bottom') || lowerMsg.includes('top')) {
        return generateReversalResponse();
    }
    
    // BAR COUNT / CONSECUTIVE BARS
    if (lowerMsg.includes('bar') && (lowerMsg.includes('count') || lowerMsg.includes('consecutive') || lowerMsg.includes('yesterday') || lowerMsg.includes('closing'))) {
        return generateBarCountResponse();
    }
    
    // OPTIMAL TIME TO TRADE
    if ((lowerMsg.includes('optimal') || lowerMsg.includes('best')) && (lowerMsg.includes('time') || lowerMsg.includes('when'))) {
        return generateOptimalTimeResponse();
    }
    
    // WHEN TO TRADE / TRADING HOURS
    if (lowerMsg.includes('when') && (lowerMsg.includes('trade') || lowerMsg.includes('buy') || lowerMsg.includes('sell'))) {
        return generateOptimalTimeResponse();
    }
    
    // HIGH CONSENSUS TRADES
    if (lowerMsg.includes('consensus') || lowerMsg.includes('3/4') || lowerMsg.includes('4/4') || lowerMsg.includes('high consensus')) {
        let trades = [];
        for (const symbol of SYMBOLS) {
            const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
            if (data && data.length) {
                const lat = data[data.length - 1];
                const consensus = parseInt(lat.PriceConfluence) || 0;
                if (consensus >= 3) {
                    const price = parseFloat(lat.Close);
                    const atr = parseFloat(lat.ATR) || 5;
                    trades.push({ symbol, signal: lat.Bias || 'HOLD', consensus, price: price.toFixed(2), strike: Math.round(price), target: (price + atr * 2).toFixed(2) });
                }
            }
        }
        
        if (trades.length === 0) {
            return ` No ETFs currently have 3/4 or 4/4 consensus.

This could mean:
 Markets are consolidating
 Agents are conflicting
 Wait for clearer signals

 TIP: Check individual symbols for developing setups, or review the Bar Count tab for trend direction.`;
        }
        
        let response = ` **HIGH CONSENSUS TRADES TODAY:**\n\n`;
        trades.sort((a, b) => b.consensus - a.consensus);
        trades.forEach(t => {
            const emoji = t.consensus === 4 ? '' : '';
            response += `${emoji} **${t.symbol}** - ${t.signal} (${t.consensus}/4)\n`;
            response += `   Price: $${t.price} | Strike: $${t.strike} | Target: $${t.target}\n\n`;
        });
        
        const ultra = trades.filter(t => t.consensus === 4);
        if (ultra.length) {
            response += ` **TOP PICK:** ${ultra[0].symbol} has ULTRA signal (4/4 consensus)`;
        }
        
        return response;
    }
    
    // BEST CALLS
    if (lowerMsg.includes('call') && (lowerMsg.includes('best') || lowerMsg.includes('2 day'))) {
        return generateOptionRecommendations('CALL');
    }
    
    // BEST PUTS
    if (lowerMsg.includes('put') && (lowerMsg.includes('best') || lowerMsg.includes('2 day'))) {
        return generateOptionRecommendations('PUT');
    }
    
    // SQUARE OF 9 / MYSTIFYING SQUARE
    if (lowerMsg.includes('square of 9') || lowerMsg.includes('mystifying')) {
        const price = currentData.length ? parseFloat(currentData[currentData.length - 1].Close) : 675;
        const sqrtPrice = Math.sqrt(price);
        
        return ` **MYSTIFYING SQUARE (SQUARE OF 9) FOR ${currentSymbol}**

Current Price: $${price.toFixed(2)}
Square Root: ${sqrtPrice.toFixed(4)}

**RESISTANCE LEVELS (Price Targets):**
 +45 = $${Math.pow(sqrtPrice + 0.125, 2).toFixed(2)} (minor)
 +90 = $${Math.pow(sqrtPrice + 0.25, 2).toFixed(2)} (important)
 +180 = $${Math.pow(sqrtPrice + 0.5, 2).toFixed(2)} (major)
 +360 = $${Math.pow(sqrtPrice + 1.0, 2).toFixed(2)} (full cycle)

**SUPPORT LEVELS (Stop Areas):**
 -45 = $${Math.pow(sqrtPrice - 0.125, 2).toFixed(2)} (minor)
 -90 = $${Math.pow(sqrtPrice - 0.25, 2).toFixed(2)} (important)
 -180 = $${Math.pow(sqrtPrice - 0.5, 2).toFixed(2)} (major)

 **HOW TO USE:**
- Buy at support levels
- Take profits at resistance
- 90 moves are most common
- 180 = major reversal zones`;
    }
    
    // DIVINE PROPORTIONS / FIBONACCI
    if (lowerMsg.includes('divine') || lowerMsg.includes('proportion') || lowerMsg.includes('phi') || lowerMsg.includes('golden')) {
        const fib = window.fibLevels || {};
        return ` **DIVINE PROPORTIONS (PHI/FIBONACCI)**

The Golden Ratio ( = 1.618) governs natural growth patterns and markets follow these proportions.

**${currentSymbol} FIBONACCI LEVELS:**

 Resistance (Targets):
 R1 (100%) = $${fib.fib100?.toFixed(2) || '--'} (Swing High)
 R2 (127.2%) = $${fib.fib1272?.toFixed(2) || '--'} ( extension)
 R3 (161.8%) = $${fib.fib1618?.toFixed(2) || '--'} ( extension)

 Support (Stops):
 S1 (38.2%) = $${fib.fib382?.toFixed(2) || '--'} (First support)
 S2 (50.0%) = $${fib.fib500?.toFixed(2) || '--'} (Key level)
 S3 (61.8%) = $${fib.fib618?.toFixed(2) || '--'} (Golden ratio)

**TRADING RULES:**
 Enter CALL at 61.8% retracement
 Target 161.8% extension
 Stop below 78.6% level

**PHI RELATIONSHIPS:**
 1.618  1.618 = 2.618
 1/1.618 = 0.618
 1.618 = 1.272`;
    }
    
    // TIME CYCLES
    if (lowerMsg.includes('time cycle') || lowerMsg.includes('gann cycle') || lowerMsg.includes('when')) {
        return ` **GANN TIME CYCLES**

"When time is up, the trend changes" - W.D. Gann

**KEY CYCLE LENGTHS:**
 30 days - Minor cycle
 45 days - Important (1/8 year)
 60 days - Significant
 90 days - Major (quarter)
 120 days - 1/3 year
 144 days - Fibonacci/sacred
 180 days - Half year
 360 days - Full annual cycle

**SEASONAL TURN DATES:**
 Mar 21 - Spring Equinox
 Jun 21 - Summer Solstice
 Sep 21 - Fall Equinox
 Dec 21 - Winter Solstice

**HOW TO APPLY:**
1. Mark the last major high or low date
2. Add Gann numbers (30, 45, 60, 90...)
3. Watch for reversals on those dates
4. Combine with price levels for confirmation`;
    }
    
    // OPTIMAL STRIKE
    if (lowerMsg.includes('strike') || lowerMsg.includes('optimal')) {
        if (currentData.length) {
            const lat = currentData[currentData.length - 1];
            const price = parseFloat(lat.Close);
            const atr = parseFloat(lat.ATR) || 5;
            const signal = lat.Bias || 'CALL';
            const sqrtPrice = Math.sqrt(price);
            
            return ` **OPTIMAL STRIKE FOR ${currentSymbol}**

Current Price: $${price.toFixed(2)}
Signal: ${signal}
ATR: $${atr.toFixed(2)}

**INTRADAY (0DTE):**
 ATM Strike: $${Math.round(price)} (Delta ~0.50)
 Target: $${(signal === 'PUT' ? price - atr : price + atr).toFixed(2)}
 Stop: $${(signal === 'PUT' ? price + atr * 0.5 : price - atr * 0.5).toFixed(2)}

**SWING (3-5 DTE):**
 Strike: $${Math.round(price/5)*5} (slightly OTM)
 Target: $${(signal === 'PUT' ? price - atr * 2.5 : price + atr * 2.5).toFixed(2)}
 Stop: $${(signal === 'PUT' ? price + atr * 1.5 : price - atr * 1.5).toFixed(2)}

**SQUARE OF 9 TARGETS:**
 90 target: $${Math.pow(sqrtPrice + (signal === 'PUT' ? -0.25 : 0.25), 2).toFixed(2)}
 180 target: $${Math.pow(sqrtPrice + (signal === 'PUT' ? -0.5 : 0.5), 2).toFixed(2)}`;
        }
        return "Please select a symbol to calculate optimal strike.";
    }
    
    // SECTOR COMPARISON
    if (lowerMsg.includes('sector') || lowerMsg.includes('compare') || lowerMsg.includes('strongest')) {
        let sectors = [];
        for (const symbol of ['XLK', 'XLF', 'XLV', 'XLE']) {
            const data = allSymbolsData[symbol];
            if (data && data.length > 20) {
                const lat = data[data.length - 1];
                const prev20 = data[data.length - 21];
                const perf = ((parseFloat(lat.Close) - parseFloat(prev20.Close)) / parseFloat(prev20.Close) * 100);
                sectors.push({ symbol, name: SYMBOL_NAMES[symbol], perf: perf.toFixed(2), signal: lat.Bias || 'HOLD', consensus: lat.PriceConfluence || 0 });
            }
        }
        
        sectors.sort((a, b) => parseFloat(b.perf) - parseFloat(a.perf));
        
        let response = ` **SECTOR COMPARISON (20-Day Performance)**\n\n`;
        sectors.forEach((s, i) => {
            const emoji = i === 0 ? '' : (i === 1 ? '' : (i === 2 ? '' : ''));
            const perfColor = parseFloat(s.perf) >= 0 ? '+' : '';
            response += `${emoji} **${s.name}** (${s.symbol})\n`;
            response += `   ${perfColor}${s.perf}% | ${s.signal} | ${s.consensus}/4 consensus\n\n`;
        });
        
        response += `\n **RECOMMENDATION:**\n`;
        response += ` Strongest: ${sectors[0].symbol} - consider for CALL trades\n`;
        response += ` Weakest: ${sectors[sectors.length-1].symbol} - consider for PUT trades`;
        
        return response;
    }
    
    // TUNNEL THROUGH THE AIR
    if (lowerMsg.includes('tunnel') || lowerMsg.includes('through the air')) {
        return GANN_KNOWLEDGE.tunnelThroughAir;
    }
    
    // PLATFORM / PRINCIPLES
    if (lowerMsg.includes('platform') || lowerMsg.includes('principle') || lowerMsg.includes('how does') || lowerMsg.includes('q5d')) {
        return GANN_KNOWLEDGE.platformPrinciples;
    }
    
    // CURRENT PRICE / STATUS
    if ((lowerMsg.includes('price') || lowerMsg.includes('status') || lowerMsg.includes('current')) && !lowerMsg.includes('strike')) {
        return generateCurrentStatusResponse();
    }
    
    // WHAT SHOULD I TRADE / RECOMMENDATION
    if (lowerMsg.includes('should i') || lowerMsg.includes('recommend') || lowerMsg.includes('what to trade') || lowerMsg.includes('trade today')) {
        return generateTradeRecommendation();
    }
    
    // RISK / STOP LOSS
    if (lowerMsg.includes('risk') || lowerMsg.includes('stop loss') || lowerMsg.includes('position size')) {
        return generateRiskManagementResponse();
    }
    
    // NEWS / MARKET UPDATE
    if (lowerMsg.includes('news') || lowerMsg.includes('market') || lowerMsg.includes('update')) {
        return generateMarketUpdateResponse();
    }
    
    // HELP / WHAT CAN YOU DO
    if (lowerMsg.includes('help') || lowerMsg.includes('what can you') || lowerMsg.includes('how to use')) {
        return generateHelpResponse();
    }
    
    // DEFAULT RESPONSE - More intelligent
    return generateSmartDefaultResponse(message, context);
}

function generateOptionRecommendations(direction) {
    let recommendations = [];
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            const signal = (lat.Bias || '').toUpperCase();
            if (signal === direction) {
                const price = parseFloat(lat.Close);
                const atr = parseFloat(lat.ATR) || 5;
                recommendations.push({
                    symbol,
                    price: price.toFixed(2),
                    strike: Math.round(price),
                    target: (direction === 'CALL' ? price + atr * 2 : price - atr * 2).toFixed(2),
                    stop: (direction === 'CALL' ? price - atr : price + atr).toFixed(2),
                    consensus: parseInt(lat.PriceConfluence) || 0,
                    rr: ((atr * 2) / atr).toFixed(1)
                });
            }
        }
    }
    
    recommendations.sort((a, b) => b.consensus - a.consensus);
    
    if (recommendations.length === 0) {
        return ` No strong ${direction} signals found across ETFs.

The agents are not aligned for ${direction} trades currently. Consider:
 Waiting for better setups
 Checking individual symbols
 Looking at the opposite direction`;
    }
    
    let response = ` **BEST ${direction} OPTIONS (Next 2 Days)**\n\n`;
    
    recommendations.slice(0, 5).forEach((r, i) => {
        const emoji = r.consensus >= 3 ? '' : '';
        response += `${emoji} **#${i+1} ${r.symbol}** (${r.consensus}/4 consensus)\n`;
        response += `   Strike: $${r.strike} ${direction}\n`;
        response += `   Entry: $${r.price} | Target: $${r.target} | Stop: $${r.stop}\n`;
        response += `   Risk/Reward: 1:${r.rr}\n\n`;
    });
    
    if (recommendations.length > 0) {
        const best = recommendations[0];
        response += `\n **TOP PICK:** ${best.symbol} $${best.strike} ${direction}\n`;
        response += ` ${best.consensus}/4 agent consensus\n`;
        response += ` Target: $${best.target} (${best.rr}:1 R/R)`;
    }
    
    return response;
}

// NEW: Generate Bar Count Response with actual data
function generateBarCountResponse() {
    let response = ` **BAR COUNT ANALYSIS (as of last close)**\n\n`;
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 20) continue;
        
        // Calculate consecutive bars
        let bullCount = 0, bearCount = 0, currentStreak = 0, lastDir = null;
        
        for (let i = Math.max(0, data.length - 50); i < data.length; i++) {
            const d = data[i];
            const isBullish = parseFloat(d.Close) >= parseFloat(d.Open);
            
            if (lastDir === null) {
                lastDir = isBullish;
                currentStreak = 1;
            } else if (isBullish === lastDir) {
                currentStreak++;
            } else {
                lastDir = isBullish;
                currentStreak = 1;
            }
            
            if (isBullish) bullCount++;
            else bearCount++;
        }
        
        const lat = data[data.length - 1];
        const price = parseFloat(lat.Close).toFixed(2);
        const signal = lat.Bias || 'HOLD';
        const streakDir = lastDir ? ' Bullish' : ' Bearish';
        const streakEmoji = currentStreak >= 5 ? '' : (currentStreak >= 3 ? '' : '');
        
        response += `**${symbol}** - $${price} | ${signal}\n`;
        response += `   Current Streak: ${currentStreak} bars ${streakDir} ${streakEmoji}\n`;
        response += `   Last 50 bars: ${bullCount} bullish / ${bearCount} bearish\n\n`;
    }
    
    // Add interpretation
    response += `\n **INTERPRETATION:**\n`;
    response += ` 5+ consecutive bars = Strong trend, consider continuation\n`;
    response += ` 7+ consecutive bars = Possible exhaustion, watch for reversal\n`;
    response += ` Mixed (1-2 bars) = Choppy market, wait for direction`;
    
    return response;
}

// NEW: Morning Breakout Pattern Detection
function generateBreakoutResponse() {
    let breakouts = [];
    let potentialBreakouts = [];
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 20) continue;
        
        const lat = data[data.length - 1];
        const prev = data[data.length - 2];
        const prev5 = data.slice(-6, -1);
        
        const price = parseFloat(lat.Close);
        const open = parseFloat(lat.Open);
        const high = parseFloat(lat.High);
        const low = parseFloat(lat.Low);
        const prevHigh = parseFloat(prev.High);
        const prevClose = parseFloat(prev.Close);
        const atr = parseFloat(lat.ATR) || 5;
        const volume = parseFloat(lat.Volume) || 0;
        
        // Calculate average volume
        const avgVol = data.slice(-20).reduce((sum, d) => sum + (parseFloat(d.Volume) || 0), 0) / 20;
        const volRatio = volume / avgVol;
        
        // Calculate 5-day high
        const fiveDayHigh = Math.max(...prev5.map(d => parseFloat(d.High) || 0));
        
        // Breakout criteria
        const aboveOpen = price > open;
        const nearHigh = (high - price) < (atr * 0.25); // Within 25% of ATR from high
        const abovePrevHigh = price > prevHigh;
        const above5DayHigh = price > fiveDayHigh;
        const highVolume = volRatio > 1.2;
        const strongMove = ((price - open) / open) * 100 > 0.5; // >0.5% move
        
        const breakoutScore = (aboveOpen ? 1 : 0) + (nearHigh ? 1 : 0) + (abovePrevHigh ? 1 : 0) + 
                             (above5DayHigh ? 2 : 0) + (highVolume ? 1 : 0) + (strongMove ? 1 : 0);
        
        const breakoutData = {
            symbol,
            price: price.toFixed(2),
            change: ((price - prevClose) / prevClose * 100).toFixed(2),
            volRatio: (volRatio * 100).toFixed(0),
            score: breakoutScore,
            above5Day: above5DayHigh,
            signal: lat.Bias || 'HOLD',
            consensus: lat.PriceConfluence || 0,
            target: (price + atr * 1.5).toFixed(2),
            stop: (price - atr * 0.75).toFixed(2)
        };
        
        if (breakoutScore >= 5 && above5DayHigh) {
            breakouts.push(breakoutData);
        } else if (breakoutScore >= 3) {
            potentialBreakouts.push(breakoutData);
        }
    }
    
    let response = ` **MORNING BREAKOUT SCAN**\n\n`;
    
    if (breakouts.length > 0) {
        response += `** CONFIRMED BREAKOUTS:**\n`;
        breakouts.sort((a, b) => b.score - a.score);
        breakouts.forEach(b => {
            response += `\n**${b.symbol}** - BREAKOUT! \n`;
            response += `   Price: $${b.price} (+${b.change}%)\n`;
            response += `   Volume: ${b.volRatio}% of avg ${parseFloat(b.volRatio) > 150 ? '' : ''}\n`;
            response += `   Breaking 5-day high: ${b.above5Day ? ' YES' : ' No'}\n`;
            response += `   Agent Signal: ${b.signal} (${b.consensus}/4)\n`;
            response += `   Target: $${b.target} | Stop: $${b.stop}\n`;
        });
    } else {
        response += `**No confirmed breakouts at this time.**\n`;
    }
    
    if (potentialBreakouts.length > 0) {
        response += `\n** POTENTIAL BREAKOUTS (Watch List):**\n`;
        potentialBreakouts.sort((a, b) => b.score - a.score).slice(0, 4).forEach(b => {
            response += ` ${b.symbol}: $${b.price} (+${b.change}%) - ${b.signal}\n`;
        });
    }
    
    response += `\n** BREAKOUT CRITERIA:**\n`;
    response += ` Price above open \n`;
    response += ` Near session high \n`;
    response += ` Above 5-day high \n`;
    response += ` Volume > 120% avg \n`;
    response += ` Move > 0.5% \n`;
    
    response += `\n** BEST TIME:** Trade breakouts 9:45-10:30 AM ET`;
    
    return response;
}

// NEW: Pattern Scan Response
function generatePatternScanResponse() {
    let patterns = {
        breakout: [],
        pullback: [],
        reversal: [],
        consolidation: []
    };
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 20) continue;
        
        const lat = data[data.length - 1];
        const recent = data.slice(-10);
        
        const price = parseFloat(lat.Close);
        const open = parseFloat(lat.Open);
        const high = parseFloat(lat.High);
        const low = parseFloat(lat.Low);
        const atr = parseFloat(lat.ATR) || 5;
        const signal = lat.Bias || 'HOLD';
        
        // Get recent highs/lows
        const recentHighs = recent.map(d => parseFloat(d.High) || 0);
        const recentLows = recent.map(d => parseFloat(d.Low) || 0);
        const highestHigh = Math.max(...recentHighs);
        const lowestLow = Math.min(...recentLows);
        const range = highestHigh - lowestLow;
        
        // Pattern detection
        const nearHigh = price > highestHigh - (range * 0.1);
        const nearLow = price < lowestLow + (range * 0.1);
        const inMiddle = !nearHigh && !nearLow;
        const tightRange = range < atr * 2;
        const bullishCandle = price > open;
        
        const symbolData = { symbol, price: price.toFixed(2), signal, consensus: lat.PriceConfluence || 0 };
        
        if (nearHigh && bullishCandle && signal === 'CALL') {
            patterns.breakout.push({...symbolData, type: 'Bullish Breakout'});
        } else if (nearLow && !bullishCandle && signal === 'PUT') {
            patterns.breakout.push({...symbolData, type: 'Bearish Breakdown'});
        } else if (inMiddle && signal === 'CALL') {
            patterns.pullback.push({...symbolData, type: 'Bullish Pullback'});
        } else if (inMiddle && signal === 'PUT') {
            patterns.pullback.push({...symbolData, type: 'Bearish Rally'});
        } else if (tightRange) {
            patterns.consolidation.push({...symbolData, type: 'Tight Range'});
        }
    }
    
    let response = ` **PATTERN SCAN RESULTS**\n\n`;
    
    if (patterns.breakout.length) {
        response += `** BREAKOUT PATTERNS:**\n`;
        patterns.breakout.forEach(p => {
            response += ` ${p.symbol}: ${p.type} @ $${p.price} (${p.consensus}/4)\n`;
        });
        response += `\n`;
    }
    
    if (patterns.pullback.length) {
        response += `** PULLBACK/RETRACEMENT:**\n`;
        patterns.pullback.forEach(p => {
            response += ` ${p.symbol}: ${p.type} @ $${p.price} (${p.consensus}/4)\n`;
        });
        response += `\n`;
    }
    
    if (patterns.consolidation.length) {
        response += `** CONSOLIDATION (Watch for breakout):**\n`;
        patterns.consolidation.forEach(p => {
            response += ` ${p.symbol}: ${p.type} @ $${p.price}\n`;
        });
        response += `\n`;
    }
    
    if (patterns.breakout.length === 0 && patterns.pullback.length === 0) {
        response += `No clear patterns detected. Market may be choppy.\n\n`;
    }
    
    response += ` **TIP:** Breakouts need volume confirmation. Pullbacks offer better risk/reward.`;
    
    return response;
}

// NEW: Momentum Response
function generateMomentumResponse() {
    let momentum = [];
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 20) continue;
        
        const lat = data[data.length - 1];
        const prev5 = data[data.length - 6];
        const prev20 = data[data.length - 21];
        
        const price = parseFloat(lat.Close);
        const price5 = parseFloat(prev5?.Close) || price;
        const price20 = parseFloat(prev20?.Close) || price;
        
        const chg5 = ((price - price5) / price5 * 100);
        const chg20 = ((price - price20) / price20 * 100);
        
        // Count consecutive bars
        let streak = 0;
        for (let i = data.length - 1; i >= Math.max(0, data.length - 10); i--) {
            const d = data[i];
            const bullish = parseFloat(d.Close) >= parseFloat(d.Open);
            if (i === data.length - 1) {
                streak = bullish ? 1 : -1;
            } else if ((bullish && streak > 0) || (!bullish && streak < 0)) {
                streak += bullish ? 1 : -1;
            } else {
                break;
            }
        }
        
        momentum.push({
            symbol,
            price: price.toFixed(2),
            chg5: chg5.toFixed(2),
            chg20: chg20.toFixed(2),
            streak,
            signal: lat.Bias || 'HOLD',
            consensus: lat.PriceConfluence || 0,
            score: chg5 + (streak * 0.5)
        });
    }
    
    // Sort by momentum score
    momentum.sort((a, b) => b.score - a.score);
    
    let response = ` **MOMENTUM RANKINGS**\n\n`;
    
    response += `** STRONGEST (Bullish Momentum):**\n`;
    momentum.slice(0, 3).forEach((m, i) => {
        const emoji = i === 0 ? '' : (i === 1 ? '' : '');
        response += `${emoji} **${m.symbol}** - $${m.price}\n`;
        response += `   5-Day: ${parseFloat(m.chg5) >= 0 ? '+' : ''}${m.chg5}% | 20-Day: ${parseFloat(m.chg20) >= 0 ? '+' : ''}${m.chg20}%\n`;
        response += `   Streak: ${m.streak > 0 ? '+' : ''}${m.streak} bars | Signal: ${m.signal} (${m.consensus}/4)\n\n`;
    });
    
    response += `** WEAKEST (Bearish Momentum):**\n`;
    momentum.slice(-3).reverse().forEach((m, i) => {
        response += `${i + 1}. **${m.symbol}** - $${m.price}\n`;
        response += `   5-Day: ${parseFloat(m.chg5) >= 0 ? '+' : ''}${m.chg5}% | Streak: ${m.streak > 0 ? '+' : ''}${m.streak} bars\n\n`;
    });
    
    response += ` **TRADING TIP:**\n`;
    response += ` Strong momentum + 3/4 consensus = High probability CALL\n`;
    response += ` Weak momentum + PUT signal = Consider PUT trades`;
    
    return response;
}

// NEW: Reversal Pattern Response
function generateReversalResponse() {
    let reversals = [];
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (!data || data.length < 20) continue;
        
        const lat = data[data.length - 1];
        const prev = data[data.length - 2];
        const prev2 = data[data.length - 3];
        
        const price = parseFloat(lat.Close);
        const open = parseFloat(lat.Open);
        const high = parseFloat(lat.High);
        const low = parseFloat(lat.Low);
        const prevClose = parseFloat(prev.Close);
        const prevOpen = parseFloat(prev.Open);
        const atr = parseFloat(lat.ATR) || 5;
        
        // Calculate bar counts
        let bearStreak = 0, bullStreak = 0;
        for (let i = data.length - 2; i >= Math.max(0, data.length - 10); i--) {
            const d = data[i];
            if (parseFloat(d.Close) < parseFloat(d.Open)) bearStreak++;
            else break;
        }
        for (let i = data.length - 2; i >= Math.max(0, data.length - 10); i--) {
            const d = data[i];
            if (parseFloat(d.Close) >= parseFloat(d.Open)) bullStreak++;
            else break;
        }
        
        // Reversal patterns
        const bullishEngulfing = prevClose < prevOpen && price > open && price > prevOpen && open < prevClose;
        const bearishEngulfing = prevClose > prevOpen && price < open && price < prevOpen && open > prevClose;
        const hammer = (open - low) > (high - open) * 2 && price > open && bearStreak >= 3;
        const shootingStar = (high - open) > (open - low) * 2 && price < open && bullStreak >= 3;
        
        let pattern = null;
        let direction = null;
        
        if (bullishEngulfing || hammer) {
            pattern = bullishEngulfing ? 'Bullish Engulfing' : 'Hammer';
            direction = 'BULLISH';
        } else if (bearishEngulfing || shootingStar) {
            pattern = bearishEngulfing ? 'Bearish Engulfing' : 'Shooting Star';
            direction = 'BEARISH';
        } else if (bearStreak >= 5 && price > open) {
            pattern = 'Potential Bullish Reversal';
            direction = 'BULLISH';
        } else if (bullStreak >= 5 && price < open) {
            pattern = 'Potential Bearish Reversal';
            direction = 'BEARISH';
        }
        
        if (pattern) {
            reversals.push({
                symbol,
                pattern,
                direction,
                price: price.toFixed(2),
                priorStreak: direction === 'BULLISH' ? bearStreak : bullStreak,
                signal: lat.Bias || 'HOLD',
                consensus: lat.PriceConfluence || 0
            });
        }
    }
    
    let response = ` **REVERSAL PATTERN SCAN**\n\n`;
    
    if (reversals.length === 0) {
        response += `No clear reversal patterns detected.\n\n`;
        response += `**What to look for:**\n`;
        response += ` 5+ bar downtrend + bullish candle = Potential bottom\n`;
        response += ` 5+ bar uptrend + bearish candle = Potential top\n`;
        response += ` Engulfing patterns at key Fibonacci levels\n`;
    } else {
        const bullish = reversals.filter(r => r.direction === 'BULLISH');
        const bearish = reversals.filter(r => r.direction === 'BEARISH');
        
        if (bullish.length) {
            response += `** BULLISH REVERSALS (Potential Bottoms):**\n`;
            bullish.forEach(r => {
                response += ` **${r.symbol}**: ${r.pattern} @ $${r.price}\n`;
                response += `  Prior downtrend: ${r.priorStreak} bars | Signal: ${r.signal}\n\n`;
            });
        }
        
        if (bearish.length) {
            response += `** BEARISH REVERSALS (Potential Tops):**\n`;
            bearish.forEach(r => {
                response += ` **${r.symbol}**: ${r.pattern} @ $${r.price}\n`;
                response += `  Prior uptrend: ${r.priorStreak} bars | Signal: ${r.signal}\n\n`;
            });
        }
    }
    
    response += ` **CAUTION:** Reversals need confirmation. Wait for follow-through!`;
    
    return response;
}

// NEW: Generate Optimal Trading Time Response
function generateOptimalTimeResponse() {
    const lat = currentData.length ? currentData[currentData.length - 1] : null;
    const price = lat ? parseFloat(lat.Close).toFixed(2) : '--';
    const signal = lat ? (lat.Bias || 'HOLD') : '--';
    
    return ` **OPTIMAL TIMES TO TRADE ${currentSymbol} OPTIONS**

**INTRADAY (0DTE) BEST WINDOWS:**

 **9:30-10:00 AM ET - Opening Range**
 Highest volatility & liquidity
 Wait for first 5-15 min to establish range
 Best for momentum plays
  Avoid trading first 5 minutes (too erratic)

 **10:00-11:30 AM ET - Morning Trend**
 Trend typically established
 Best time for directional trades
 Options premiums still reasonable
  RECOMMENDED for 0DTE entries

 **11:30 AM-2:00 PM ET - Midday Lull**
 Lower volatility, choppy action
  Avoid new positions
 Good for managing existing trades

 **2:00-3:00 PM ET - Power Hour Setup**
 Institutional positioning begins
 Good for swing entries (1-5 DTE)
 Watch for trend continuation/reversal

 **3:00-4:00 PM ET - Power Hour**
 High volume, strong moves
 Last chance for 0DTE
  Wide spreads near close
 Best for experienced traders

**SWING TRADES (3-5 DTE) BEST TIMES:**
 Enter: 10:00-11:00 AM (after opening noise)
 Avoid: Fridays (weekend theta decay)
 Best days: Tuesday-Thursday

**CURRENT ${currentSymbol} STATUS:**
 Price: $${price}
 Signal: ${signal}
 Mode: ${tradingMode.toUpperCase()}

**GANN TIME FACTORS:**
 Strongest moves: First hour, last hour
 Weakest: 12:00-1:00 PM (lunch hour)
 Watch 90-minute cycles intraday (Gann)

** MY RECOMMENDATION:**
For ${currentSymbol} ${signal} signal:
${signal === 'CALL' ? ' Enter on pullback to support 10:00-11:00 AM' : ' Enter on rally to resistance 10:00-11:00 AM'}
 Set stop based on ATR ($${lat ? parseFloat(lat.ATR).toFixed(2) : '--'})
 Take profits before 3:30 PM for 0DTE`;
}

// Current Status Response
function generateCurrentStatusResponse() {
    let response = ` **CURRENT MARKET STATUS**\n\n`;
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            const prev = data[data.length - 2] || lat;
            const price = parseFloat(lat.Close);
            const prevPrice = parseFloat(prev.Close);
            const chg = price - prevPrice;
            const pct = ((chg / prevPrice) * 100).toFixed(2);
            const signal = lat.Bias || 'HOLD';
            const consensus = lat.PriceConfluence || 0;
            const isCurrentSym = symbol === currentSymbol;
            
            response += `${isCurrentSym ? ' ' : ''}**${symbol}**: $${price.toFixed(2)} (${chg >= 0 ? '+' : ''}${pct}%)\n`;
            response += `   Signal: ${signal} | Consensus: ${consensus}/4\n\n`;
        }
    }
    
    return response;
}

// Trade Recommendation
function generateTradeRecommendation() {
    let bestTrade = null;
    let bestScore = 0;
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            const consensus = parseInt(lat.PriceConfluence) || 0;
            const signal = lat.Bias || 'HOLD';
            
            if (consensus > bestScore && signal !== 'HOLD') {
                bestScore = consensus;
                bestTrade = {
                    symbol,
                    signal,
                    consensus,
                    price: parseFloat(lat.Close),
                    atr: parseFloat(lat.ATR) || 5
                };
            }
        }
    }
    
    if (!bestTrade || bestScore < 2) {
        return ` **NO STRONG TRADE RECOMMENDATIONS RIGHT NOW**

Current market conditions don't show clear setups:
 No symbols have 3/4 or 4/4 consensus
 Agents are conflicting
 Consider staying flat or reducing size

**WHAT TO DO:**
 Wait for clearer signals
 Review the Bar Count tab for trend direction
 Check back after market open for fresh data`;
    }
    
    const strike = Math.round(bestTrade.price);
    const target = bestTrade.signal === 'CALL' 
        ? bestTrade.price + bestTrade.atr * 2 
        : bestTrade.price - bestTrade.atr * 2;
    const stop = bestTrade.signal === 'CALL'
        ? bestTrade.price - bestTrade.atr
        : bestTrade.price + bestTrade.atr;
    
    return ` **TODAY'S TOP TRADE RECOMMENDATION**

**${bestTrade.symbol} ${bestTrade.signal}**
Agent Consensus: ${bestTrade.consensus}/4 ${bestTrade.consensus >= 3 ? '' : ''}

 **ENTRY:**
 Price: $${bestTrade.price.toFixed(2)}
 Strike: $${strike} ${bestTrade.signal}
 Mode: ${tradingMode === 'intraday' ? '0DTE' : '3-5 DTE'}

 **TARGETS:**
 Target 1: $${(bestTrade.signal === 'CALL' ? bestTrade.price + bestTrade.atr : bestTrade.price - bestTrade.atr).toFixed(2)}
 Target 2: $${target.toFixed(2)}

 **RISK:**
 Stop Loss: $${stop.toFixed(2)}
 Risk/Reward: 1:2

 **TIMING:**
 Best entry: 10:00-11:00 AM ET
 Avoid: First 15 min, last 30 min (0DTE)`;
}

// Risk Management Response
function generateRiskManagementResponse() {
    const lat = currentData.length ? currentData[currentData.length - 1] : null;
    const price = lat ? parseFloat(lat.Close) : 675;
    const atr = lat ? parseFloat(lat.ATR) || 5 : 5;
    
    return ` **RISK MANAGEMENT GUIDELINES**

**POSITION SIZING (Kelly Criterion):**
 Risk 0.5-1% per trade (intraday)
 Risk 1-2% per trade (swing)
 Never risk more than 5% daily

**EXAMPLE for $10,000 Account:**
 1% risk = $100 max loss per trade
 If stop is $${atr.toFixed(2)} away (1 ATR)
 Max position = $100  $${atr.toFixed(2)} = ${(100/atr).toFixed(0)} contracts

**STOP LOSS PLACEMENT:**
 Intraday: 0.5-1.0 ATR = $${(atr * 0.75).toFixed(2)}
 Swing: 1.5-2.0 ATR = $${(atr * 1.5).toFixed(2)}

**${currentSymbol} CURRENT LEVELS:**
 Price: $${price.toFixed(2)}
 ATR: $${atr.toFixed(2)}
 Intraday Stop: $${(price - atr * 0.75).toFixed(2)} (CALL) / $${(price + atr * 0.75).toFixed(2)} (PUT)
 Swing Stop: $${(price - atr * 1.5).toFixed(2)} (CALL) / $${(price + atr * 1.5).toFixed(2)} (PUT)

**GANN'S RISK RULES:**
 Never let a profit turn into a loss
 Move stop to breakeven after 1 ATR profit
 Scale out: 50% at T1, 50% at T2
 Max 3 losses in a row = stop trading for day`;
}

// Market Update Response
function generateMarketUpdateResponse() {
    let bullish = 0, bearish = 0, neutral = 0;
    
    for (const symbol of SYMBOLS) {
        const data = symbol === currentSymbol ? currentData : allSymbolsData[symbol];
        if (data && data.length) {
            const signal = data[data.length - 1].Bias || 'HOLD';
            if (signal === 'CALL') bullish++;
            else if (signal === 'PUT') bearish++;
            else neutral++;
        }
    }
    
    const marketBias = bullish > bearish ? 'BULLISH' : (bearish > bullish ? 'BEARISH' : 'MIXED');
    const biasEmoji = marketBias === 'BULLISH' ? '' : (marketBias === 'BEARISH' ? '' : '');
    
    return ` **MARKET UPDATE**

${biasEmoji} **OVERALL BIAS: ${marketBias}**
 Bullish signals: ${bullish}/${SYMBOLS.length} ETFs
 Bearish signals: ${bearish}/${SYMBOLS.length} ETFs
 Neutral: ${neutral}/${SYMBOLS.length} ETFs

**SECTOR BREAKDOWN:**
${generateQuickSectorSummary()}

**TRADING IMPLICATION:**
${marketBias === 'BULLISH' ? ' Favor CALL trades\n Look for pullbacks to support\n Sector leaders: Check XLK, XLF' : 
  marketBias === 'BEARISH' ? ' Favor PUT trades\n Look for rallies to resistance\n Defensive sectors may outperform' :
  ' Mixed signals - reduce position size\n Wait for clearer direction\n Focus on highest consensus trades'}

 Use "high consensus trades" to find specific setups.`;
}

function generateQuickSectorSummary() {
    let summary = '';
    for (const symbol of ['XLK', 'XLF', 'XLV', 'XLE']) {
        const data = allSymbolsData[symbol];
        if (data && data.length) {
            const lat = data[data.length - 1];
            const signal = lat.Bias || 'HOLD';
            const emoji = signal === 'CALL' ? '' : (signal === 'PUT' ? '' : '');
            summary += `${emoji} ${SYMBOL_NAMES[symbol]}: ${signal}\n`;
        }
    }
    return summary;
}

// Help Response
function generateHelpResponse() {
    return ` **HOW TO USE THE AI ASSISTANT**

**QUICK ACTIONS (Click the buttons!):**
  High Consensus - Find best trades
  Best CALLs - Top bullish plays
  Best PUTs - Top bearish plays
  Optimal Strike - Get strike recommendations

**EXAMPLE QUESTIONS:**

 **Data & Analysis:**
 "Show me bar count for all ETFs"
 "What's the current status?"
 "Compare all sectors"

 **Trade Ideas:**
 "What should I trade today?"
 "Best CALL options for 2 days"
 "Optimal strike for SPY"
 "Show high consensus trades"

 **Timing:**
 "When is the best time to trade?"
 "What are Gann time cycles?"

 **Education:**
 "Explain Square of 9"
 "What is Divine Proportions?"
 "Tunnel Through the Air principles"

 **Risk:**
 "How should I size my position?"
 "Where to place stop loss?"

Just type naturally - I understand most trading questions!`;
}

// Smart Default Response
function generateSmartDefaultResponse(message, context) {
    // Try to extract intent
    const lowerMsg = message.toLowerCase();
    
    // Check for symbol mentions
    const mentionedSymbol = SYMBOLS.find(s => lowerMsg.includes(s.toLowerCase()));
    
    let response = ` I want to help! Let me clarify...\n\n`;
    response += `You asked: "${message}"\n\n`;
    
    if (mentionedSymbol) {
        const data = allSymbolsData[mentionedSymbol] || currentData;
        if (data && data.length) {
            const lat = data[data.length - 1];
            response += `**${mentionedSymbol} Quick Info:**\n`;
            response += ` Price: $${parseFloat(lat.Close).toFixed(2)}\n`;
            response += ` Signal: ${lat.Bias || 'HOLD'}\n`;
            response += ` Consensus: ${lat.PriceConfluence || 0}/4\n\n`;
        }
    }
    
    response += `**Try asking:**\n`;
    response += ` "What should I trade today?"\n`;
    response += ` "Show me ${currentSymbol} bar count"\n`;
    response += ` "Best time to trade options"\n`;
    response += ` "Calculate Square of 9 for ${currentSymbol}"\n`;
    response += ` "High consensus trades"\n\n`;
    response += `Or click a Quick Action button on the right `;
    
    return response;
}

// ============================================
// TRADE LOG SYSTEM
// ============================================

// Initialize trades from localStorage
let trades = [];

function loadTrades() {
    const stored = localStorage.getItem('sa4_trades');
    if (stored) {
        try {
            trades = JSON.parse(stored);
        } catch (e) {
            trades = [];
        }
    }
    renderTrades();
    updateTradeStats();
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('tradeDate');
    if (dateInput) dateInput.value = today;
}

function saveTrades() {
    localStorage.setItem('sa4_trades', JSON.stringify(trades));
}

function logTrade(event) {
    event.preventDefault();
    
    const trade = {
        id: Date.now(),
        date: document.getElementById('tradeDate').value,
        symbol: document.getElementById('tradeSymbol').value,
        direction: document.getElementById('tradeDirection').value,
        type: document.getElementById('tradeType').value,
        strike: parseFloat(document.getElementById('tradeStrike').value),
        contracts: parseInt(document.getElementById('tradeContracts').value),
        entry: parseFloat(document.getElementById('tradeEntry').value),
        exit: parseFloat(document.getElementById('tradeExit').value) || null,
        consensus: document.getElementById('tradeConsensus').value,
        status: document.getElementById('tradeStatus').value,
        notes: document.getElementById('tradeNotes').value,
        createdAt: new Date().toISOString()
    };
    
    // Calculate P&L if closed
    if (trade.exit && trade.status !== 'OPEN') {
        trade.pnl = (trade.exit - trade.entry) * trade.contracts * 100;
    } else {
        trade.pnl = null;
    }
    
    trades.unshift(trade); // Add to beginning
    saveTrades();
    renderTrades();
    updateTradeStats();
    clearTradeForm();
    
    // Show success message
    alert(' Trade logged successfully!');
}

function clearTradeForm() {
    document.getElementById('tradeForm').reset();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('tradeDate').value = today;
    document.getElementById('tradeSymbol').value = currentSymbol;
}

function toggleExitField() {
    const status = document.getElementById('tradeStatus').value;
    const exitField = document.getElementById('tradeExit');
    if (status === 'OPEN') {
        exitField.value = '';
        exitField.disabled = true;
    } else {
        exitField.disabled = false;
    }
}

function renderTrades() {
    const tbody = document.getElementById('tradeTableBody');
    if (!tbody) return;

    const filterSymbol = document.getElementById('filterSymbol')?.value || 'ALL';
    const filterDirection = document.getElementById('filterDirection')?.value || 'ALL';
    const filterStatus = document.getElementById('filterStatus')?.value || 'ALL';

    let filteredTrades = trades.filter(t => {
        if (filterSymbol !== 'ALL' && t.symbol !== filterSymbol) return false;
        if (filterDirection !== 'ALL' && t.direction !== filterDirection) return false;
        if (filterStatus !== 'ALL' && t.status !== filterStatus) return false;
        return true;
    });

    // Sort by date descending (newest first)
    filteredTrades.sort((a, b) => new Date(b.date) - new Date(a.date));

    document.getElementById('tradeCount').textContent = `(${filteredTrades.length} trades)`;

    if (filteredTrades.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" style="text-align:center;color:var(--muted);padding:30px;">No trades match your filters.</td></tr>';
        return;
    }

    let html = '';
    filteredTrades.forEach((trade, index) => {
        const pnlClass = trade.pnl > 0 ? 'pnl-positive' : (trade.pnl < 0 ? 'pnl-negative' : '');
        const pnlDisplay = trade.pnl !== null ? `${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(2)}` : '--';
        const statusClass = trade.status.toLowerCase();
        const directionEmoji = trade.direction === 'CALL' ? '' : '';
        const typeEmoji = trade.type === 'INTRADAY' ? '' : '';

        html += `<tr>
            <td>${index + 1}</td>
            <td>${trade.date}</td>
            <td><strong>${trade.symbol}</strong></td>
            <td>${directionEmoji} ${trade.direction} ${typeEmoji}</td>
            <td>$${trade.strike}</td>
            <td>${trade.contracts}</td>
            <td>$${trade.entry.toFixed(2)}</td>
            <td>${trade.exit ? '$' + trade.exit.toFixed(2) : '--'}</td>
            <td class="${pnlClass}">${pnlDisplay}</td>
            <td><span class="badge badge-${trade.consensus === '4/4' ? 'ultra' : (trade.consensus === '3/4' ? 'success' : 'warning')}">${trade.consensus}</span></td>
            <td><span class="status-badge-trade ${statusClass}">${trade.status}</span></td>
            <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${trade.notes || ''}">${trade.notes || '--'}</td>
            <td>
                <button class="trade-action-btn edit" onclick="editTrade(${trade.id})"></button>
                <button class="trade-action-btn delete" onclick="deleteTrade(${trade.id})"></button>
            </td>
        </tr>`;
    });

    tbody.innerHTML = html;
}

function filterTrades() {
    renderTrades();
}

function editTrade(id) {
    const trade = trades.find(t => t.id === id);
    if (!trade) return;
    
    document.getElementById('tradeDate').value = trade.date;
    document.getElementById('tradeSymbol').value = trade.symbol;
    document.getElementById('tradeDirection').value = trade.direction;
    document.getElementById('tradeType').value = trade.type;
    document.getElementById('tradeStrike').value = trade.strike;
    document.getElementById('tradeContracts').value = trade.contracts;
    document.getElementById('tradeEntry').value = trade.entry;
    document.getElementById('tradeExit').value = trade.exit || '';
    document.getElementById('tradeConsensus').value = trade.consensus;
    document.getElementById('tradeStatus').value = trade.status;
    document.getElementById('tradeNotes').value = trade.notes || '';
    
    // Remove the old trade
    trades = trades.filter(t => t.id !== id);
    saveTrades();
    
    // Scroll to form
    document.getElementById('tradeForm').scrollIntoView({ behavior: 'smooth' });
}

function deleteTrade(id) {
    if (!confirm('Are you sure you want to delete this trade?')) return;
    
    trades = trades.filter(t => t.id !== id);
    saveTrades();
    renderTrades();
    updateTradeStats();
}

function clearAllTrades() {
    if (!confirm(' Are you sure you want to delete ALL trades? This cannot be undone!')) return;
    if (!confirm('This will permanently delete your entire trade history. Continue?')) return;
    
    trades = [];
    saveTrades();
    renderTrades();
    updateTradeStats();
}

function updateTradeStats() {
    const closedTrades = trades.filter(t => t.status !== 'OPEN' && t.pnl !== null);
    const wins = closedTrades.filter(t => t.pnl > 0);
    const losses = closedTrades.filter(t => t.pnl <= 0);
    
    // Basic stats
    document.getElementById('statTotalTrades').textContent = trades.length;
    
    // Win rate
    const winRate = closedTrades.length > 0 ? (wins.length / closedTrades.length * 100).toFixed(1) : 0;
    document.getElementById('statWinRate').textContent = winRate + '%';
    document.getElementById('statWinRate').className = `metric-value ${parseFloat(winRate) >= 50 ? 'positive' : 'negative'}`;
    document.getElementById('statWinLoss').textContent = `${wins.length}W / ${losses.length}L`;
    
    // Total P&L
    const totalPnL = closedTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
    document.getElementById('statTotalPnL').textContent = `${totalPnL >= 0 ? '+' : ''}$${totalPnL.toFixed(2)}`;
    document.getElementById('statTotalPnL').className = `metric-value ${totalPnL >= 0 ? 'positive' : 'negative'}`;
    
    // Average trade
    const avgTrade = closedTrades.length > 0 ? totalPnL / closedTrades.length : 0;
    document.getElementById('statAvgTrade').textContent = `Avg: ${avgTrade >= 0 ? '+' : ''}$${avgTrade.toFixed(2)}`;
    
    // Best/Worst trade
    if (closedTrades.length > 0) {
        const best = closedTrades.reduce((max, t) => t.pnl > max.pnl ? t : max);
        const worst = closedTrades.reduce((min, t) => t.pnl < min.pnl ? t : min);
        
        document.getElementById('statBestTrade').textContent = `+$${best.pnl.toFixed(2)}`;
        document.getElementById('statBestSymbol').textContent = `${best.symbol} ${best.direction}`;
        document.getElementById('statWorstTrade').textContent = `$${worst.pnl.toFixed(2)}`;
        document.getElementById('statWorstSymbol').textContent = `${worst.symbol} ${worst.direction}`;
    }
    
    // Trades this week
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    const weekTrades = trades.filter(t => new Date(t.date) >= oneWeekAgo);
    document.getElementById('statTradesThisWeek').textContent = `${weekTrades.length} this week`;
    
    // Update analytics
    updateSymbolPerformance();
    updateDirectionPerformance();
    updateConsensusAnalysis();
}

function updateSymbolPerformance() {
    const container = document.getElementById('symbolPerformance');
    if (!container) return;
    
    const closedTrades = trades.filter(t => t.status !== 'OPEN' && t.pnl !== null);
    if (closedTrades.length === 0) {
        container.innerHTML = '<p style="color:var(--muted);font-size:12px;">Log closed trades to see performance breakdown</p>';
        return;
    }
    
    const bySymbol = {};
    closedTrades.forEach(t => {
        if (!bySymbol[t.symbol]) {
            bySymbol[t.symbol] = { wins: 0, losses: 0, pnl: 0 };
        }
        bySymbol[t.symbol].pnl += t.pnl;
        if (t.pnl > 0) bySymbol[t.symbol].wins++;
        else bySymbol[t.symbol].losses++;
    });
    
    let html = '<div style="display:flex;flex-direction:column;gap:8px;">';
    Object.entries(bySymbol).sort((a, b) => b[1].pnl - a[1].pnl).forEach(([symbol, data]) => {
        const winRate = ((data.wins / (data.wins + data.losses)) * 100).toFixed(0);
        const pnlClass = data.pnl >= 0 ? 'positive' : 'negative';
        html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px;background:var(--bg);border-radius:4px;">
            <span style="font-weight:600;">${symbol}</span>
            <span>${data.wins}W/${data.losses}L (${winRate}%)</span>
            <span class="${pnlClass}" style="font-weight:600;">${data.pnl >= 0 ? '+' : ''}$${data.pnl.toFixed(2)}</span>
        </div>`;
    });
    html += '</div>';
    container.innerHTML = html;
}

function updateDirectionPerformance() {
    const container = document.getElementById('directionPerformance');
    if (!container) return;
    
    const closedTrades = trades.filter(t => t.status !== 'OPEN' && t.pnl !== null);
    if (closedTrades.length === 0) {
        container.innerHTML = '<p style="color:var(--muted);font-size:12px;">Log closed trades to see CALL vs PUT performance</p>';
        return;
    }
    
    const calls = closedTrades.filter(t => t.direction === 'CALL');
    const puts = closedTrades.filter(t => t.direction === 'PUT');
    
    const callWins = calls.filter(t => t.pnl > 0).length;
    const callPnL = calls.reduce((sum, t) => sum + t.pnl, 0);
    const putWins = puts.filter(t => t.pnl > 0).length;
    const putPnL = puts.reduce((sum, t) => sum + t.pnl, 0);
    
    const callWinRate = calls.length > 0 ? ((callWins / calls.length) * 100).toFixed(0) : 0;
    const putWinRate = puts.length > 0 ? ((putWins / puts.length) * 100).toFixed(0) : 0;
    
    container.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:10px;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(16,185,129,0.1);border-radius:6px;border-left:4px solid var(--success);">
                <div>
                    <div style="font-weight:700;font-size:14px;"> CALLS</div>
                    <div style="font-size:11px;color:var(--muted);">${calls.length} trades | ${callWinRate}% win rate</div>
                </div>
                <div style="font-size:18px;font-weight:700;" class="${callPnL >= 0 ? 'positive' : 'negative'}">${callPnL >= 0 ? '+' : ''}$${callPnL.toFixed(2)}</div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(239,68,68,0.1);border-radius:6px;border-left:4px solid var(--danger);">
                <div>
                    <div style="font-weight:700;font-size:14px;"> PUTS</div>
                    <div style="font-size:11px;color:var(--muted);">${puts.length} trades | ${putWinRate}% win rate</div>
                </div>
                <div style="font-size:18px;font-weight:700;" class="${putPnL >= 0 ? 'positive' : 'negative'}">${putPnL >= 0 ? '+' : ''}$${putPnL.toFixed(2)}</div>
            </div>
        </div>
    `;
}

function updateConsensusAnalysis() {
    const consensusLevels = ['4/4', '3/4', '2/4', '1/4'];
    const ids = ['ultra44', 'super34', 'single24', 'weak14'];
    
    consensusLevels.forEach((level, i) => {
        const levelTrades = trades.filter(t => t.consensus === level && t.status !== 'OPEN' && t.pnl !== null);
        const wins = levelTrades.filter(t => t.pnl > 0).length;
        const winRate = levelTrades.length > 0 ? ((wins / levelTrades.length) * 100).toFixed(0) : '--';
        
        document.getElementById(`${ids[i]}WinRate`).textContent = winRate + '%';
        document.getElementById(`${ids[i]}WinRate`).style.color = winRate !== '--' && parseFloat(winRate) >= 50 ? 'var(--success)' : 'var(--danger)';
        document.getElementById(`${ids[i]}Count`).textContent = `${levelTrades.length} trades`;
    });
}

// Export Functions
function printTrades() {
    window.print();
}

function exportCSV() {
    if (trades.length === 0) {
        alert('No trades to export!');
        return;
    }
    
    const headers = ['Date', 'Symbol', 'Direction', 'Type', 'Strike', 'Contracts', 'Entry', 'Exit', 'P&L', 'Consensus', 'Status', 'Notes'];
    const rows = trades.map(t => [
        t.date,
        t.symbol,
        t.direction,
        t.type,
        t.strike,
        t.contracts,
        t.entry,
        t.exit || '',
        t.pnl || '',
        t.consensus,
        t.status,
        `"${(t.notes || '').replace(/"/g, '""')}"`
    ]);
    
    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `trade_log_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    
    URL.revokeObjectURL(url);
}

function shareTrades() {
    const closedTrades = trades.filter(t => t.status !== 'OPEN' && t.pnl !== null);
    const wins = closedTrades.filter(t => t.pnl > 0).length;
    const winRate = closedTrades.length > 0 ? ((wins / closedTrades.length) * 100).toFixed(1) : 0;
    const totalPnL = closedTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
    
    const text = ` Stock Agent 4 - Trade Summary

 Total Trades: ${trades.length}
 Win Rate: ${winRate}%
 Total P&L: ${totalPnL >= 0 ? '+' : ''}$${totalPnL.toFixed(2)}
 Period: ${trades.length > 0 ? trades[trades.length-1].date : 'N/A'} to ${trades.length > 0 ? trades[0].date : 'N/A'}

Powered by Q5D Options Platform & Gann Principles `;

    if (navigator.share) {
        navigator.share({
            title: 'Stock Agent 4 Trade Summary',
            text: text
        }).catch(console.log);
    } else {
        // Fallback - copy to clipboard
        navigator.clipboard.writeText(text).then(() => {
            alert(' Trade summary copied to clipboard!');
        }).catch(() => {
            prompt('Copy this trade summary:', text);
        });
    }
}

function emailTrades() {
    const closedTrades = trades.filter(t => t.status !== 'OPEN' && t.pnl !== null);
    const wins = closedTrades.filter(t => t.pnl > 0).length;
    const winRate = closedTrades.length > 0 ? ((wins / closedTrades.length) * 100).toFixed(1) : 0;
    const totalPnL = closedTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
    
    const subject = encodeURIComponent('Stock Agent 4 - Trade Summary');
    const body = encodeURIComponent(`Stock Agent 4 - Trade Summary

Total Trades: ${trades.length}
Win Rate: ${winRate}%
Total P&L: ${totalPnL >= 0 ? '+' : ''}$${totalPnL.toFixed(2)}

Recent Trades:
${trades.slice(0, 10).map(t => `- ${t.date}: ${t.symbol} ${t.direction} ${t.contracts}x $${t.strike} | P&L: ${t.pnl !== null ? '$' + t.pnl.toFixed(2) : 'Open'}`).join('\n')}

---
Powered by Q5D Options Platform`);
    
    window.open(`mailto:?subject=${subject}&body=${body}`);
}

// Initialize trade log when app loads
async function initializeApp() {
    initTabs();
    await loadAllData();  // Wait for data to load
    
    // Update Options Calculator with new symbol
    updateOptionsCalcForSymbol();
    await loadAllSymbolsData();
    loadTrades(); // Load trade history
    runHealthCheck(); // Now run health check AFTER data is loaded
    renderSystemLog(); // Render existing log entries
    addSystemLogEntry('Data Updated (' + currentSymbol + ')', 'Success'); // Log data load
    setInterval(loadAllData, 60000);
    setInterval(runHealthCheck, 300000); // Health check every 5 minutes
}

// ============================================
// HEALTH MONITORING SYSTEM
// ============================================

let healthStatus = {
    dataFreshness: 'unknown',
    marketStatus: 'unknown',
    workflowStatus: 'unknown',
    dataQuality: 'unknown',
    alerts: []
};

function runHealthCheck() {
    console.log('Running health check...');
    healthStatus.alerts = [];
    
    // Check data freshness
    checkDataFreshness();
    
    // Check market status
    checkMarketStatus();
    
    // Check data quality
    checkDataQuality();
    
    // Check connections
    checkConnections();
    
    // Update overall status
    updateOverallHealth();

    // Update last check time
    document.getElementById('lastHealthCheck').textContent = new Date().toLocaleString();

    // Update health timestamp
    updateSectionTimestamp('health');
}

function checkDataFreshness() {
    console.log(' checkDataFreshness running...');
    
    // Get elements directly
    const lastDateEl = document.getElementById('lastDataDate');
    const daysSinceEl = document.getElementById('daysSinceUpdate');
    const expectedEl = document.getElementById('expectedUpdate');
    const totalBarsEl = document.getElementById('totalBarsLoaded');
    const dateRangeEl = document.getElementById('dataDateRange');
    const valueEl = document.getElementById('dataFreshnessValue');
    const statusEl = document.getElementById('dataFreshnessStatus');
    const freshEl = document.getElementById('healthDataFresh');
    
    // Check if we have data
    if (!currentData || currentData.length === 0) {
        console.log(' No data available');
        if (valueEl) valueEl.textContent = 'No Data';
        if (statusEl) statusEl.textContent = 'CRITICAL';
        healthStatus.dataFreshness = 'critical';
        healthStatus.alerts.push({ type: 'critical', message: 'No data loaded' });
        return;
    }
    
    console.log(' Data length:', currentData.length);
    
    // Get last bar directly
    const lastBar = currentData[currentData.length - 1];
    console.log(' Last bar:', lastBar);
    console.log(' Last bar Date:', lastBar.Date);
    
    // Parse the date - handle ISO format WITHOUT timezone conversion
    let lastDate;
    if (lastBar.Date) {
        // Extract just the date part (YYYY-MM-DD) to avoid timezone issues
        const dateStr = lastBar.Date.split('T')[0];
        const [year, month, day] = dateStr.split('-').map(Number);
        lastDate = new Date(year, month - 1, day); // month is 0-indexed
        console.log(' Parsed lastDate (no TZ):', lastDate);
    }
    
    if (!lastDate || isNaN(lastDate.getTime())) {
        console.log(' Invalid date');
        if (valueEl) valueEl.textContent = 'Invalid Date';
        healthStatus.dataFreshness = 'critical';
        return;
    }
    
    // Calculate days difference
    const now = new Date();
    const diffMs = now - lastDate;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    console.log(' Now:', now);
    console.log(' Diff days:', diffDays);
    
    // Format the date string
    const dateStr = lastDate.toLocaleDateString('en-US', { 
        weekday: 'short', 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
    });
    console.log(' Formatted date:', dateStr);
    
    // UPDATE THE ELEMENTS DIRECTLY
    if (lastDateEl) {
        lastDateEl.textContent = dateStr;
        lastDateEl.innerHTML = dateStr;
        console.log(' Updated lastDataDate to:', dateStr);
    } else {
        console.log(' lastDataDate element not found!');
    }
    
    if (daysSinceEl) {
        const daysText = diffDays === 0 ? 'Today' : (diffDays === 1 ? '1 day ago' : diffDays + ' days ago');
        daysSinceEl.textContent = daysText;
        console.log(' Updated daysSinceUpdate to:', daysText);
    }
    
    if (totalBarsEl) {
        totalBarsEl.textContent = currentData.length + ' bars';
    }
    
    // First date for range
    const firstBar = currentData[0];
    if (firstBar && firstBar.Date && dateRangeEl) {
        const firstDateStr = firstBar.Date.split('T')[0];
        const [fy, fm, fd] = firstDateStr.split('-').map(Number);
        const firstDate = new Date(fy, fm - 1, fd);
        dateRangeEl.textContent = firstDate.toLocaleDateString() + ' - ' + lastDate.toLocaleDateString();
    }
    
    // Expected update
    if (expectedEl) {
        const nextUpdate = getNextMarketDay(lastDate);
        expectedEl.textContent = nextUpdate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }
    
    // Status based on days
    if (diffDays === 0) {
        if (valueEl) valueEl.textContent = 'Up to Date';
        if (statusEl) { statusEl.textContent = 'FRESH'; statusEl.className = 'health-metric-status ok'; }
        if (freshEl) freshEl.className = 'health-metric healthy';
        healthStatus.dataFreshness = 'healthy';
        healthStatus.alerts.push({ type: 'success', message: 'Data is current' });
    } else if (diffDays === 1) {
        if (valueEl) valueEl.textContent = '1 Day Old';
        if (statusEl) { statusEl.textContent = 'OK'; statusEl.className = 'health-metric-status ok'; }
        if (freshEl) freshEl.className = 'health-metric healthy';
        healthStatus.dataFreshness = 'healthy';
    } else if (diffDays <= 3) {
        const isWeekend = isWeekendGap(lastDate, now);
        if (isWeekend) {
            if (valueEl) valueEl.textContent = diffDays + ' Days (Weekend)';
            if (statusEl) { statusEl.textContent = 'OK'; statusEl.className = 'health-metric-status ok'; }
            if (freshEl) freshEl.className = 'health-metric healthy';
            healthStatus.dataFreshness = 'healthy';
        } else {
            if (valueEl) valueEl.textContent = diffDays + ' Days Old';
            if (statusEl) { statusEl.textContent = 'STALE'; statusEl.className = 'health-metric-status warn'; }
            if (freshEl) freshEl.className = 'health-metric warning';
            healthStatus.dataFreshness = 'warning';
            healthStatus.alerts.push({ type: 'warning', message: 'Data is ' + diffDays + ' days old' });
        }
    } else {
        if (valueEl) valueEl.textContent = diffDays + ' Days Old';
        if (statusEl) { statusEl.textContent = 'OUTDATED'; statusEl.className = 'health-metric-status error'; }
        if (freshEl) freshEl.className = 'health-metric critical';
        healthStatus.dataFreshness = 'critical';
        healthStatus.alerts.push({ type: 'critical', message: 'Data is ' + diffDays + ' days old!' });
    }
    
    console.log(' checkDataFreshness complete');
}

function checkMarketStatus() {
    const marketEl = document.getElementById('healthMarket');
    const valueEl = document.getElementById('marketStatusValue');
    const statusEl = document.getElementById('marketStatusStatus');
    
    const now = new Date();
    const etOffset = getETOffset();
    const etNow = new Date(now.getTime() + etOffset);
    
    const day = etNow.getDay();
    const hours = etNow.getHours();
    const minutes = etNow.getMinutes();
    const timeNum = hours * 100 + minutes;
    
    // Weekend check
    if (day === 0 || day === 6) {
        valueEl.textContent = 'Weekend';
        statusEl.textContent = 'CLOSED';
        statusEl.className = 'health-metric-status warn';
        marketEl.className = 'health-metric warning';
        healthStatus.marketStatus = 'closed';
        return;
    }
    
    // Market hours: 9:30 AM - 4:00 PM ET
    if (timeNum >= 930 && timeNum < 1600) {
        valueEl.textContent = 'Market Open';
        statusEl.textContent = 'TRADING';
        statusEl.className = 'health-metric-status ok';
        marketEl.className = 'health-metric healthy';
        healthStatus.marketStatus = 'open';
    } else if (timeNum >= 400 && timeNum < 930) {
        valueEl.textContent = 'Pre-Market';
        statusEl.textContent = 'WAITING';
        statusEl.className = 'health-metric-status warn';
        marketEl.className = 'health-metric warning';
        healthStatus.marketStatus = 'premarket';
    } else {
        valueEl.textContent = 'After Hours';
        statusEl.textContent = 'CLOSED';
        statusEl.className = 'health-metric-status warn';
        marketEl.className = 'health-metric warning';
        healthStatus.marketStatus = 'closed';
    }
}

function checkDataQuality() {
    const qualityEl = document.getElementById('healthDataQuality');
    const valueEl = document.getElementById('dataQualityValue');
    const statusEl = document.getElementById('dataQualityStatus');
    
    if (!currentData || currentData.length === 0) {
        valueEl.textContent = 'No Data';
        statusEl.textContent = 'N/A';
        statusEl.className = 'health-metric-status error';
        qualityEl.className = 'health-metric critical';
        healthStatus.dataQuality = 'critical';
        return;
    }
    
    let issues = 0;
    let checks = 0;
    
    // Check for required fields
    const lastBar = currentData[currentData.length - 1];
    const requiredFields = ['Date', 'Open', 'High', 'Low', 'Close', 'Volume'];
    
    requiredFields.forEach(field => {
        checks++;
        if (!lastBar[field] && lastBar[field] !== 0) {
            issues++;
        }
    });
    
    // Check for valid price data
    checks++;
    if (lastBar.Close && (lastBar.Close < 0 || lastBar.Close > 10000)) {
        issues++;
        healthStatus.alerts.push({ type: 'warning', message: 'Unusual price detected - verify data integrity' });
    }
    
    // Check for signal data
    checks++;
    if (!lastBar.Bias) {
        issues++;
    }
    
    // Calculate quality score
    const score = Math.round(((checks - issues) / checks) * 100);
    
    if (score >= 90) {
        valueEl.textContent = score + '%';
        statusEl.textContent = 'EXCELLENT';
        statusEl.className = 'health-metric-status ok';
        qualityEl.className = 'health-metric healthy';
        healthStatus.dataQuality = 'healthy';
    } else if (score >= 70) {
        valueEl.textContent = score + '%';
        statusEl.textContent = 'GOOD';
        statusEl.className = 'health-metric-status ok';
        qualityEl.className = 'health-metric healthy';
        healthStatus.dataQuality = 'healthy';
    } else if (score >= 50) {
        valueEl.textContent = score + '%';
        statusEl.textContent = 'FAIR';
        statusEl.className = 'health-metric-status warn';
        qualityEl.className = 'health-metric warning';
        healthStatus.dataQuality = 'warning';
    } else {
        valueEl.textContent = score + '%';
        statusEl.textContent = 'POOR';
        statusEl.className = 'health-metric-status error';
        qualityEl.className = 'health-metric critical';
        healthStatus.dataQuality = 'critical';
        healthStatus.alerts.push({ type: 'critical', message: 'Data quality issues detected - check CSV files' });
    }
}

function checkConnections() {
    // Update symbol display
    const symbolEl = document.getElementById('connDataSymbol');
    if (symbolEl) symbolEl.textContent = currentSymbol;

    // GitHub Pages - if page loaded, it's working
    document.getElementById('connGitHubStatus').textContent = 'Connected';
    document.getElementById('connGitHubLight').textContent = '';

    // Data feed - based on whether data loaded
    if (currentData && currentData.length > 0) {
        document.getElementById('connDataStatus').textContent = 'Loaded (' + currentData.length + ' bars)';
        document.getElementById('connDataLight').textContent = '';
    } else {
        document.getElementById('connDataStatus').textContent = 'Failed';
        document.getElementById('connDataLight').textContent = '';
    }

    // Portfolio feed
    document.getElementById('connPortfolioStatus').textContent = 'Active';
    document.getElementById('connPortfolioLight').textContent = '';

    // Local Storage
    try {
        localStorage.setItem('health_test', 'test');
        localStorage.removeItem('health_test');
        document.getElementById('connLocalStorageStatus').textContent = 'Available';
        document.getElementById('connLocalStorageLight').textContent = '';
    } catch (e) {
        document.getElementById('connLocalStorageStatus').textContent = 'Blocked';
        document.getElementById('connLocalStorageLight').textContent = '';
        healthStatus.alerts.push({ type: 'warning', message: 'Local storage unavailable - trade log may not persist' });
    }
}

function updateOverallHealth() {
    const banner = document.getElementById('healthBanner');
    const icon = document.getElementById('healthBannerIcon');
    const title = document.getElementById('healthBannerTitle');
    const subtitle = document.getElementById('healthBannerSubtitle');
    const workflowEl = document.getElementById('healthWorkflow');
    const workflowValue = document.getElementById('workflowStatusValue');
    const workflowStatus = document.getElementById('workflowStatusStatus');

    // Determine workflow status based on data freshness
    if (healthStatus.dataFreshness === 'healthy') {
        workflowValue.textContent = 'Running';
        workflowStatus.textContent = 'ACTIVE';
        workflowStatus.className = 'health-metric-status ok';
        workflowEl.className = 'health-metric healthy';
        healthStatus.workflowStatus = 'healthy';
        document.getElementById('workflowStatusLight').textContent = '';
    } else if (healthStatus.dataFreshness === 'warning') {
        workflowValue.textContent = 'Delayed';
        workflowStatus.textContent = 'CHECK';
        workflowStatus.className = 'health-metric-status warn';
        workflowEl.className = 'health-metric warning';
        healthStatus.workflowStatus = 'warning';
        document.getElementById('workflowStatusLight').textContent = '';
    } else {
        workflowValue.textContent = 'Stopped?';
        workflowStatus.textContent = 'ERROR';
        workflowStatus.className = 'health-metric-status error';
        workflowEl.className = 'health-metric critical';
        healthStatus.workflowStatus = 'critical';
        document.getElementById('workflowStatusLight').textContent = '';
    }

    // Update traffic lights for data freshness
    const dataFreshLight = document.getElementById('dataFreshnessLight');
    if (dataFreshLight) {
        if (healthStatus.dataFreshness === 'healthy') dataFreshLight.textContent = '';
        else if (healthStatus.dataFreshness === 'warning') dataFreshLight.textContent = '';
        else dataFreshLight.textContent = '';
    }

    // Update traffic lights for data quality
    const dataQualityLight = document.getElementById('dataQualityLight');
    if (dataQualityLight) {
        if (healthStatus.dataQuality === 'healthy') dataQualityLight.textContent = '';
        else if (healthStatus.dataQuality === 'warning') dataQualityLight.textContent = '';
        else dataQualityLight.textContent = '';
    }

    // Update market status light
    const marketLight = document.getElementById('marketStatusLight');
    if (marketLight) {
        const marketVal = document.getElementById('marketStatusValue')?.textContent || '';
        if (marketVal.includes('Open') || marketVal.includes('Pre') || marketVal.includes('After')) {
            marketLight.textContent = '';
        } else {
            marketLight.textContent = '';
        }
    }

    // Count traffic lights for summary
    const statuses = [healthStatus.dataFreshness, healthStatus.dataQuality, healthStatus.workflowStatus];
    // Add market status (yellow if closed, green otherwise)
    const marketVal = document.getElementById('marketStatusValue')?.textContent || '';
    const marketStatus = (marketVal.includes('Open') || marketVal.includes('Pre') || marketVal.includes('After')) ? 'healthy' : 'warning';
    statuses.push(marketStatus);

    const greenCount = statuses.filter(s => s === 'healthy').length;
    const yellowCount = statuses.filter(s => s === 'warning').length;
    const redCount = statuses.filter(s => s === 'critical').length;

    document.getElementById('trafficGreenCount').textContent = ' ' + greenCount;
    document.getElementById('trafficYellowCount').textContent = ' ' + yellowCount;
    document.getElementById('trafficRedCount').textContent = ' ' + redCount;

    // Overall status
    if (redCount > 0) {
        banner.className = 'health-banner critical';
        icon.textContent = '';
        title.textContent = 'ATTENTION NEEDED';
        subtitle.textContent = `${greenCount}/4 Green, ${yellowCount} Yellow, ${redCount} Red`;
    } else if (yellowCount > 0) {
        banner.className = 'health-banner warning';
        icon.textContent = '';
        title.textContent = 'MINOR ISSUES';
        subtitle.textContent = `${greenCount}/4 Green, ${yellowCount} Yellow`;
    } else {
        banner.className = 'health-banner';
        icon.textContent = '';
        title.textContent = 'ALL SYSTEMS OPERATIONAL';
        subtitle.textContent = `${greenCount}/4 Green`;
    }

    // Update component status table
    updateComponentStatus();

    // Render alerts
    renderHealthAlerts();

    // Update header badge
    updateHeaderHealthBadge();

    // Log the health check event
    addSystemLogEntry('Health Check Run', 'Success');
}

function renderHealthAlerts() {
    const container = document.getElementById('healthAlerts');
    
    if (healthStatus.alerts.length === 0) {
        container.innerHTML = `
            <div class="health-alert success">
                <span class="alert-icon"></span>
                <span>No issues detected - system running normally</span>
            </div>
        `;
        return;
    }
    
    let html = '';
    healthStatus.alerts.forEach(alert => {
        const iconMap = { critical: '', warning: '', info: '', success: '' };
        html += `
            <div class="health-alert ${alert.type}">
                <span class="alert-icon">${iconMap[alert.type] || ''}</span>
                <span>${alert.message}</span>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// System Log Functions
function getSystemLog() {
    try {
        const log = localStorage.getItem('stockAgentSystemLog');
        return log ? JSON.parse(log) : [];
    } catch (e) {
        return [];
    }
}

function saveSystemLog(log) {
    try {
        // Keep only last 20 entries
        const trimmed = log.slice(-20);
        localStorage.setItem('stockAgentSystemLog', JSON.stringify(trimmed));
    } catch (e) {
        console.warn('Could not save system log:', e);
    }
}

function addSystemLogEntry(event, status) {
    const log = getSystemLog();
    const now = new Date();
    log.push({
        timestamp: now.toISOString(),
        dateTime: now.toLocaleString(),
        event: event,
        status: status
    });
    saveSystemLog(log);
    renderSystemLog();
}

function clearSystemLog() {
    try {
        localStorage.removeItem('stockAgentSystemLog');
        renderSystemLog();
    } catch (e) {
        console.warn('Could not clear system log:', e);
    }
}

function renderSystemLog() {
    const tbody = document.getElementById('systemLogTable');
    if (!tbody) return;

    const log = getSystemLog();
    if (log.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--muted);">No events logged yet</td></tr>';
        return;
    }

    // Show most recent first
    const recentLog = log.slice(-10).reverse();
    tbody.innerHTML = recentLog.map(entry => {
        const statusIcon = entry.status === 'Success' ? '' : entry.status === 'Warning' ? '' : '';
        return `
            <tr>
                <td>${entry.dateTime}</td>
                <td>${entry.event}</td>
                <td>${statusIcon} ${entry.status}</td>
            </tr>
        `;
    }).join('');
}

// Update Component Status Table
function updateComponentStatus() {
    const now = new Date();
    const nowStr = now.toLocaleString();

    // Health Check time
    const healthCheckTimeEl = document.getElementById('compHealthCheckTime');
    const healthCheckLightEl = document.getElementById('compHealthCheckLight');
    if (healthCheckTimeEl) healthCheckTimeEl.textContent = nowStr;
    if (healthCheckLightEl) healthCheckLightEl.textContent = '';

    // Data Fetch time (based on last data date)
    const dataFetchTimeEl = document.getElementById('compDataFetchTime');
    const dataFetchLightEl = document.getElementById('compDataFetchLight');
    if (currentData && currentData.length > 0) {
        const lastBar = currentData[currentData.length - 1];
        if (lastBar.Date) {
            const lastDate = new Date(lastBar.Date);
            // Assume data was fetched at 4:05 PM on that date
            lastDate.setHours(16, 5, 0);
            if (dataFetchTimeEl) dataFetchTimeEl.textContent = lastDate.toLocaleString();
            if (dataFetchLightEl) dataFetchLightEl.textContent = healthStatus.dataFreshness === 'healthy' ? '' : healthStatus.dataFreshness === 'warning' ? '' : '';
        }
    }

    // Workflow time (same as data fetch)
    const workflowTimeEl = document.getElementById('compWorkflowTime');
    const workflowLightEl = document.getElementById('compWorkflowLight');
    if (currentData && currentData.length > 0) {
        const lastBar = currentData[currentData.length - 1];
        if (lastBar.Date) {
            const lastDate = new Date(lastBar.Date);
            lastDate.setHours(16, 5, 0);
            if (workflowTimeEl) workflowTimeEl.textContent = lastDate.toLocaleString();
            if (workflowLightEl) workflowLightEl.textContent = healthStatus.workflowStatus === 'healthy' ? '' : healthStatus.workflowStatus === 'warning' ? '' : '';
        }
    }

    // Deploy time (estimate based on health check + 2 min)
    const deployTimeEl = document.getElementById('compDeployTime');
    const deployLightEl = document.getElementById('compDeployLight');
    if (deployTimeEl) {
        const deployTime = new Date(now.getTime() + 2 * 60 * 1000);
        deployTimeEl.textContent = '~' + deployTime.toLocaleString();
    }
    if (deployLightEl) deployLightEl.textContent = '';
}

// Helper functions
function getETOffset() {
    // Rough ET offset (doesn't account for DST perfectly)
    const now = new Date();
    const jan = new Date(now.getFullYear(), 0, 1);
    const jul = new Date(now.getFullYear(), 6, 1);
    const stdOffset = Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
    const isDST = now.getTimezoneOffset() < stdOffset;
    return isDST ? -4 * 60 * 60 * 1000 : -5 * 60 * 60 * 1000;
}

function getNextMarketDay(fromDate) {
    const next = new Date(fromDate);
    next.setDate(next.getDate() + 1);
    
    // Skip weekends
    while (next.getDay() === 0 || next.getDay() === 6) {
        next.setDate(next.getDate() + 1);
    }
    
    return next;
}

function isWeekendGap(lastDate, currentDate) {
    const lastDay = lastDate.getDay();
    const diff = Math.floor((currentDate - lastDate) / (1000 * 60 * 60 * 24));
    
    // If last data was Friday and it's been 2-3 days, it's a weekend gap
    if (lastDay === 5 && diff <= 3) return true;
    
    return false;
}

function toggleTroubleshoot(header) {
    const content = header.nextElementSibling;
    const toggle = header.querySelector('.troubleshoot-toggle');
    
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        toggle.textContent = '+';
    } else {
        content.classList.add('show');
        toggle.textContent = '';
    }
}

function updateHeaderHealthBadge() {
    const badge = document.getElementById('headerHealthBadge');
    const dot = document.getElementById('headerHealthDot');
    const text = document.getElementById('headerHealthText');
    
    if (!badge) return;
    
    const statuses = [healthStatus.dataFreshness, healthStatus.dataQuality, healthStatus.workflowStatus];
    
    if (statuses.includes('critical')) {
        badge.className = 'status-badge critical';
        badge.style.background = 'rgba(239,68,68,0.3)';
        text.textContent = 'ISSUES';
    } else if (statuses.includes('warning')) {
        badge.className = 'status-badge warning';
        badge.style.background = 'rgba(245,158,11,0.3)';
        text.textContent = 'WARNING';
    } else if (statuses.includes('unknown')) {
        badge.className = 'status-badge';
        badge.style.background = 'rgba(255,255,255,0.2)';
        text.textContent = 'CHECKING';
    } else {
        badge.className = 'status-badge online';
        badge.style.background = 'rgba(16,185,129,0.3)';
        text.textContent = 'HEALTHY';
    }
}

function switchToHealthTab() {
    // Activate health tab
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    const healthTab = document.querySelector('[data-tab="health"]');
    const healthContent = document.getElementById('health');
    
    if (healthTab) healthTab.classList.add('active');
    if (healthContent) healthContent.classList.add('active');
    
    // Run health check when switching
    runHealthCheck();
}

// ============================================
// ENHANCED MULTI-CHARTS SYSTEM
// ============================================

let lwChartInstances = { intraday: null, swing: null, position: null };
let mtfChartData = { intraday: [], swing: [], position: [] };

function toggleMTFSettings(panel) {
    const el = document.getElementById(`${panel}Settings`);
    if (el) el.classList.toggle('show');
}

function getMTFSettings(panel) {
    return {
        showEMA: document.getElementById(`${panel}ShowEMA`)?.checked ?? true,
        showFib: document.getElementById(`${panel}ShowFib`)?.checked ?? true,
        showPatterns: document.getElementById(`${panel}ShowPatterns`)?.checked ?? true,
        showVolume: document.getElementById(`${panel}ShowVolume`)?.checked ?? true
    };
}

function initMultiCharts() {
    console.log('Initializing enhanced multi-charts...');
    updateAllMultiCharts();
}

async function syncSymbolFromMultiCharts() {
    const newSymbol = document.getElementById('multiChartSymbol')?.value || 'SPY';
    const mainSelect = document.getElementById('symbolSelect');
    if (mainSelect && mainSelect.value !== newSymbol) {
        mainSelect.value = newSymbol;
    }
    await changeSymbol();
}

async function updateAllMultiCharts() {
    const symbol = document.getElementById('multiChartSymbol')?.value || 'SPY';
    ['intraday', 'swing', 'position'].forEach(panel => {
        const symbolEl = document.getElementById(`${panel}Symbol`);
        if (symbolEl) symbolEl.textContent = symbol;
    });
    await updateChart('intraday');
    await updateChart('swing');
    await updateChart('position');

    // Update multi-charts timestamp
    updateSectionTimestamp('multiCharts');
}

function refreshAllCharts() {
    updateAllMultiCharts();
}

async function updateChart(panelType) {
    const symbol = document.getElementById('multiChartSymbol')?.value || 'SPY';
    const timeframe = document.getElementById(`${panelType}Timeframe`)?.value;
    const chartType = document.getElementById(`${panelType}ChartType`)?.value;
    const container = document.getElementById(`${panelType}ChartContainer`);
    const loading = document.getElementById(`${panelType}Loading`);
    const settings = getMTFSettings(panelType);
    
    if (loading) loading.style.display = 'block';
    
    try {
        let data = getMultiChartData(panelType, timeframe);
        mtfChartData[panelType] = data;
        
        if (!data || data.length === 0) {
            if (loading) loading.textContent = 'No data available';
            return;
        }
        
        if (chartType === 'heikinashi') {
            data = convertToHeikinAshi(data);
        }
        
        if (chartType === 'pf') {
            renderEnhancedPF(panelType, mtfChartData[panelType], container, settings);
            document.getElementById(`${panelType}Legend`).style.display = 'none';
        } else {
            renderLWChart(panelType, data, chartType, container, settings);
            document.getElementById(`${panelType}Legend`).style.display = 'flex';
        }
        
        // Update price display
        const lastBar = data[data.length - 1];
        const priceEl = document.getElementById(`${panelType}Price`);
        if (priceEl && lastBar) {
            priceEl.textContent = `$${lastBar.close.toFixed(2)}`;
            priceEl.className = lastBar.close >= lastBar.open ? 'price' : 'price down';
        }
        
        // Update signal and bias
        const signal = lastBar.close > (data[data.length - 2]?.close || lastBar.close) ? 'CALL' : 'PUT';
        updateMTFSignal(panelType, signal);
        
        // Calculate and display Fibonacci levels
        if (settings.showFib && chartType !== 'pf') {
            displayMTFFib(panelType, data);
        } else {
            document.getElementById(`${panelType}Fib`).innerHTML = '';
        }
        
        if (loading) loading.style.display = 'none';
        
    } catch (error) {
        console.error(`Error updating ${panelType} chart:`, error);
        if (loading) loading.textContent = 'Error loading chart';
    }
}

function updateMTFSignal(panel, signal) {
    const signalEl = document.getElementById(`${panel}Signal`);
    const biasEl = document.getElementById(`${panel}Bias`);
    
    if (signalEl) {
        signalEl.textContent = signal;
        signalEl.className = `signal-badge-mtf ${signal.toLowerCase()}`;
    }
    
    if (biasEl) {
        const bias = signal === 'CALL' ? 'BULLISH' : 'BEARISH';
        biasEl.textContent = bias;
        biasEl.className = `value ${bias.toLowerCase()}`;
    }
    
    // Update overall confluence
    const intraday = document.getElementById('intradaySignal')?.textContent || 'HOLD';
    const swing = document.getElementById('swingSignal')?.textContent || 'HOLD';
    const position = document.getElementById('positionSignal')?.textContent || 'HOLD';
    
    let bullish = 0;
    [intraday, swing, position].forEach(s => { if (s === 'CALL') bullish++; });
    
    const overallEl = document.getElementById('overallBias');
    if (overallEl) {
        overallEl.textContent = `${bullish}/3 ${bullish >= 2 ? 'BULLISH' : 'BEARISH'}`;
        overallEl.className = `value ${bullish >= 2 ? 'bullish' : 'bearish'}`;
    }
}

function displayMTFFib(panelType, data) {
    const high = Math.max(...data.map(d => d.high));
    const low = Math.min(...data.map(d => d.low));
    const range = high - low;
    
    const fib = {
        high: high,
        low: low,
        level382: high - range * 0.382,
        level618: high - range * 0.618
    };
    
    const fibEl = document.getElementById(`${panelType}Fib`);
    if (fibEl) {
        fibEl.innerHTML = `
            <div class="fib-level-mtf resistance">R: $${fib.high.toFixed(2)}</div>
            <div class="fib-level-mtf resistance">38.2%: $${fib.level382.toFixed(2)}</div>
            <div class="fib-level-mtf support">61.8%: $${fib.level618.toFixed(2)}</div>
            <div class="fib-level-mtf support">S: $${fib.low.toFixed(2)}</div>
        `;
    }
}

function renderLWChart(panelType, data, chartType, container, settings) {
    // Clear existing chart
    if (lwChartInstances[panelType]) {
        lwChartInstances[panelType].remove();
        lwChartInstances[panelType] = null;
    }
    container.innerHTML = '';
    
    // Check if LightweightCharts is available
    if (typeof LightweightCharts === 'undefined') {
        console.warn('LightweightCharts not loaded, falling back to basic chart');
        renderFallbackChart(panelType, data, chartType, container);
        return;
    }
    
    const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: container.clientHeight || 350,
        layout: { background: { color: '#ffffff' }, textColor: '#333' },
        grid: { vertLines: { color: '#f0f0f0' }, horzLines: { color: '#f0f0f0' } },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
        rightPriceScale: { borderColor: '#e0e0e0' },
        timeScale: { borderColor: '#e0e0e0', timeVisible: true }
    });
    
    lwChartInstances[panelType] = chart;
    
    // Convert data to LightweightCharts format
    const lwData = data.map((bar, i) => ({
        time: Math.floor(Date.now() / 1000) - (data.length - i) * 86400,
        open: bar.open,
        high: bar.high,
        low: bar.low,
        close: bar.close
    }));
    
    let mainSeries;
    if (chartType === 'line') {
        mainSeries = chart.addLineSeries({ color: '#2962FF', lineWidth: 2 });
        mainSeries.setData(lwData.map(d => ({ time: d.time, value: d.close })));
    } else {
        mainSeries = chart.addCandlestickSeries({
            upColor: chartType === 'heikinashi' ? '#4caf50' : '#26a69a',
            downColor: chartType === 'heikinashi' ? '#f44336' : '#ef5350',
            borderVisible: false,
            wickUpColor: chartType === 'heikinashi' ? '#4caf50' : '#26a69a',
            wickDownColor: chartType === 'heikinashi' ? '#f44336' : '#ef5350'
        });
        mainSeries.setData(lwData);
    }
    
    // Add EMAs if enabled
    if (settings.showEMA) {
        const ema9 = calculateEMAForLW(data, 9);
        const ema21 = calculateEMAForLW(data, 21);
        const ema50 = calculateEMAForLW(data, 50);
        
        const ema9Data = ema9.map((val, i) => ({ time: lwData[i].time, value: val }));
        const ema21Data = ema21.map((val, i) => ({ time: lwData[i].time, value: val }));
        const ema50Data = ema50.map((val, i) => ({ time: lwData[i].time, value: val }));
        
        chart.addLineSeries({ color: '#f59e0b', lineWidth: 1, crosshairMarkerVisible: false, priceLineVisible: false, lastValueVisible: false }).setData(ema9Data);
        chart.addLineSeries({ color: '#3b82f6', lineWidth: 1, crosshairMarkerVisible: false, priceLineVisible: false, lastValueVisible: false }).setData(ema21Data);
        chart.addLineSeries({ color: '#8b5cf6', lineWidth: 1, crosshairMarkerVisible: false, priceLineVisible: false, lastValueVisible: false }).setData(ema50Data);
    }
    
    // Add volume if enabled
    if (settings.showVolume) {
        const volSeries = chart.addHistogramSeries({
            priceFormat: { type: 'volume' },
            priceScaleId: '',
            scaleMargins: { top: 0.85, bottom: 0 }
        });
        volSeries.setData(lwData.map((d, i) => ({
            time: d.time,
            value: data[i].volume || 1000000,
            color: d.close >= d.open ? 'rgba(38,166,154,0.5)' : 'rgba(239,83,80,0.5)'
        })));
    }
    
    chart.timeScale().fitContent();
}

function calculateEMAForLW(data, period) {
    const k = 2 / (period + 1);
    const result = [];
    let ema = data[0]?.close || 0;
    
    for (let i = 0; i < data.length; i++) {
        ema = i === 0 ? data[i].close : data[i].close * k + ema * (1 - k);
        result.push(ema);
    }
    return result;
}

function renderFallbackChart(panelType, data, chartType, container) {
    // Create canvas for fallback
    container.innerHTML = '<canvas style="width:100%;height:100%"></canvas>';
    const canvas = container.querySelector('canvas');
    renderMultiCandlestickChart(panelType, data, chartType, canvas);
}

// P&F Pattern Detection
function detectPFPatterns(columns) {
    if (columns.length < 3) return { pattern: null, signal: 'HOLD' };
    
    const patterns = [];
    const len = columns.length;
    const c1 = columns[len - 1];
    const c3 = len >= 3 ? columns[len - 3] : null;
    const c5 = len >= 5 ? columns[len - 5] : null;
    
    if (c3 && c1.type === 'X' && c3.type === 'X') {
        const c1High = Math.max(...c1.boxes);
        const c3High = Math.max(...c3.boxes);
        if (c1High > c3High) {
            patterns.push({ name: 'Double Top Breakout', type: 'bullish', strength: 85 });
        }
    }
    
    if (c3 && c1.type === 'O' && c3.type === 'O') {
        const c1Low = Math.min(...c1.boxes);
        const c3Low = Math.min(...c3.boxes);
        if (c1Low < c3Low) {
            patterns.push({ name: 'Double Bottom Breakdown', type: 'bearish', strength: 85 });
        }
    }
    
    if (c5 && c1.type === 'X' && c3.type === 'X' && c5.type === 'X') {
        const c1High = Math.max(...c1.boxes);
        const c3High = Math.max(...c3.boxes);
        const c5High = Math.max(...c5.boxes);
        if (c1High > c3High && c1High > c5High) {
            patterns.push({ name: 'Triple Top Breakout', type: 'bullish', strength: 95 });
        }
    }
    
    if (c5 && c1.type === 'O' && c3.type === 'O' && c5.type === 'O') {
        const c1Low = Math.min(...c1.boxes);
        const c3Low = Math.min(...c3.boxes);
        const c5Low = Math.min(...c5.boxes);
        if (c1Low < c3Low && c1Low < c5Low) {
            patterns.push({ name: 'Triple Bottom Breakdown', type: 'bearish', strength: 95 });
        }
    }
    
    if (patterns.length === 0) {
        patterns.push(c1.type === 'X' 
            ? { name: 'Uptrend in Progress', type: 'bullish', strength: 60 }
            : { name: 'Downtrend in Progress', type: 'bearish', strength: 60 });
    }
    
    const strongest = patterns.sort((a, b) => b.strength - a.strength)[0];
    return { pattern: strongest, signal: strongest.type === 'bullish' ? 'CALL' : 'PUT' };
}

function renderEnhancedPF(panelType, data, container, settings) {
    if (lwChartInstances[panelType]) {
        lwChartInstances[panelType].remove();
        lwChartInstances[panelType] = null;
    }
    
    container.innerHTML = '';
    const canvas = document.createElement('canvas');
    canvas.width = container.clientWidth || 400;
    canvas.height = container.clientHeight || 350;
    container.appendChild(canvas);
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width, height = canvas.height;
    
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, width, height);
    
    if (!data || data.length < 10) {
        ctx.fillStyle = '#666';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Not enough data for P&F', width/2, height/2);
        return;
    }
    
    // Calculate box size
    const avgPrice = data.reduce((s, b) => s + b.close, 0) / data.length;
    let boxSize = avgPrice < 5 ? 0.25 : avgPrice < 20 ? 0.5 : avgPrice < 100 ? 1 : avgPrice < 200 ? 2 : avgPrice < 500 ? 4 : 8;
    if (panelType === 'intraday') boxSize *= 0.5;
    if (panelType === 'position') boxSize *= 1.5;
    
    const columns = generatePFCols(data, boxSize, 3);
    const patternResult = detectPFPatterns(columns);
    
    // Display pattern alert
    const patternEl = document.getElementById(`${panelType}Pattern`);
    if (settings.showPatterns && patternResult.pattern) {
        patternEl.style.display = 'block';
        patternEl.className = `pattern-alert-mtf ${patternResult.pattern.type}`;
        patternEl.innerHTML = `${patternResult.pattern.type === 'bullish' ? '' : ''} <strong>${patternResult.pattern.name}</strong> <span style="float:right;">Strength: ${patternResult.pattern.strength}%</span>`;
        updateMTFSignal(panelType, patternResult.signal);
    } else {
        patternEl.style.display = 'none';
    }
    
    if (columns.length === 0) {
        ctx.fillStyle = '#666';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No P&F reversals', width/2, height/2);
        return;
    }
    
    // Find price range
    let minP = Infinity, maxP = -Infinity;
    columns.forEach(c => c.boxes.forEach(p => { minP = Math.min(minP, p); maxP = Math.max(maxP, p); }));
    minP -= boxSize * 2;
    maxP += boxSize * 2;
    
    const pad = { top: 40, right: 50, bottom: 20, left: 50 };
    const cw = width - pad.left - pad.right;
    const ch = height - pad.top - pad.bottom;
    const maxCols = Math.min(columns.length, 35);
    const dispCols = columns.slice(-maxCols);
    const colW = Math.min(14, cw / dispCols.length);
    
    // Draw grid
    ctx.strokeStyle = '#f0f0f0';
    ctx.lineWidth = 0.5;
    for (let p = minP; p <= maxP; p += boxSize) {
        const y = pad.top + ch - ((p - minP) / (maxP - minP)) * ch;
        ctx.beginPath();
        ctx.moveTo(pad.left, y);
        ctx.lineTo(width - pad.right, y);
        ctx.stroke();
    }
    
    // Draw price labels
    ctx.fillStyle = '#666';
    ctx.font = '9px Arial';
    ctx.textAlign = 'right';
    const step = Math.max(1, Math.floor((maxP - minP) / boxSize / 10)) * boxSize;
    for (let p = Math.ceil(minP / step) * step; p <= maxP; p += step) {
        const y = pad.top + ch - ((p - minP) / (maxP - minP)) * ch;
        ctx.fillText(p.toFixed(0), pad.left - 5, y + 3);
    }
    
    // Draw X's and O's
    const fs = Math.max(8, Math.min(12, colW - 1));
    ctx.font = `bold ${fs}px Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    dispCols.forEach((col, i) => {
        const x = pad.left + (i + 0.5) * colW;
        col.boxes.forEach(price => {
            const y = pad.top + ch - ((price - minP) / (maxP - minP)) * ch;
            ctx.fillStyle = col.type === 'X' ? '#26a69a' : '#ef5350';
            ctx.fillText(col.type, x, y);
        });
    });
    
    // Title
    ctx.fillStyle = '#333';
    ctx.font = 'bold 11px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('Point & Figure Chart', pad.left, 15);
    ctx.font = '10px Arial';
    ctx.fillStyle = '#666';
    ctx.fillText(`Box: $${boxSize.toFixed(2)} | Rev: 3`, pad.left + 110, 15);
    
    // Pattern name
    if (settings.showPatterns && patternResult.pattern) {
        ctx.font = 'bold 10px Arial';
        ctx.fillStyle = patternResult.pattern.type === 'bullish' ? '#059669' : '#dc2626';
        ctx.textAlign = 'center';
        ctx.fillText(patternResult.pattern.name, width / 2, 30);
    }
}

function getMultiChartData(panelType, timeframe) {
    if (!currentData || currentData.length === 0) return [];
    
    let data = currentData.map(bar => ({
        date: bar.Date,
        open: parseFloat(bar.Open) || 0,
        high: parseFloat(bar.High) || 0,
        low: parseFloat(bar.Low) || 0,
        close: parseFloat(bar.Close) || 0,
        volume: parseFloat(bar.Volume) || 0
    })).filter(bar => bar.close > 0);
    
    if (panelType === 'intraday') {
        return simulateIntradayBars(data.slice(-5), parseInt(timeframe) || 15);
    }
    
    if (panelType === 'swing') {
        if (timeframe === 'W') return aggregateWeekly(data);
        return data.slice(-60);
    }
    
    if (panelType === 'position') {
        if (timeframe === 'Q') return aggregateQuarterly(data);
        return aggregateMonthly(data);
    }
    
    return data;
}

function simulateIntradayBars(dailyData, minutes) {
    const intradayBars = [];
    const barsPerDay = Math.floor(390 / minutes);
    
    dailyData.forEach(day => {
        const range = day.high - day.low;
        for (let i = 0; i < barsPerDay; i++) {
            const progress = i / barsPerDay;
            const basePrice = day.open + (day.close - day.open) * progress;
            const noise = (Math.random() - 0.5) * range * 0.3;
            
            const open = i === 0 ? day.open : intradayBars[intradayBars.length - 1]?.close || basePrice;
            const close = basePrice + noise;
            
            intradayBars.push({
                date: day.date,
                time: `${Math.floor(9.5 + (i * minutes) / 60)}:${String((30 + i * minutes) % 60).padStart(2, '0')}`,
                open: open,
                high: Math.max(open, close) + Math.random() * range * 0.1,
                low: Math.min(open, close) - Math.random() * range * 0.1,
                close: close,
                volume: day.volume / barsPerDay
            });
        }
    });
    return intradayBars.slice(-50);
}

function aggregateWeekly(dailyData) {
    const weeks = {};
    dailyData.forEach(bar => {
        const date = new Date(bar.date);
        const weekStart = new Date(date);
        weekStart.setDate(date.getDate() - date.getDay());
        const weekKey = weekStart.toISOString().split('T')[0];
        
        if (!weeks[weekKey]) {
            weeks[weekKey] = { date: weekKey, open: bar.open, high: bar.high, low: bar.low, close: bar.close, volume: bar.volume };
        } else {
            weeks[weekKey].high = Math.max(weeks[weekKey].high, bar.high);
            weeks[weekKey].low = Math.min(weeks[weekKey].low, bar.low);
            weeks[weekKey].close = bar.close;
            weeks[weekKey].volume += bar.volume;
        }
    });
    return Object.values(weeks).slice(-30);
}

function aggregateMonthly(dailyData) {
    const months = {};
    dailyData.forEach(bar => {
        const date = new Date(bar.date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        
        if (!months[monthKey]) {
            months[monthKey] = { date: monthKey + '-01', open: bar.open, high: bar.high, low: bar.low, close: bar.close, volume: bar.volume };
        } else {
            months[monthKey].high = Math.max(months[monthKey].high, bar.high);
            months[monthKey].low = Math.min(months[monthKey].low, bar.low);
            months[monthKey].close = bar.close;
            months[monthKey].volume += bar.volume;
        }
    });
    return Object.values(months).slice(-24);
}

function aggregateQuarterly(dailyData) {
    const quarters = {};
    dailyData.forEach(bar => {
        const date = new Date(bar.date);
        const quarter = Math.floor(date.getMonth() / 3) + 1;
        const quarterKey = `${date.getFullYear()}-Q${quarter}`;
        
        if (!quarters[quarterKey]) {
            quarters[quarterKey] = { date: `${date.getFullYear()}-${String((quarter - 1) * 3 + 1).padStart(2, '0')}-01`, open: bar.open, high: bar.high, low: bar.low, close: bar.close, volume: bar.volume };
        } else {
            quarters[quarterKey].high = Math.max(quarters[quarterKey].high, bar.high);
            quarters[quarterKey].low = Math.min(quarters[quarterKey].low, bar.low);
            quarters[quarterKey].close = bar.close;
            quarters[quarterKey].volume += bar.volume;
        }
    });
    return Object.values(quarters).slice(-12);
}

function convertToHeikinAshi(data) {
    if (!data || data.length === 0) return [];
    const haData = [];
    
    data.forEach((bar, i) => {
        const haBar = { ...bar };
        if (i === 0) {
            haBar.open = (bar.open + bar.close) / 2;
            haBar.close = (bar.open + bar.high + bar.low + bar.close) / 4;
        } else {
            const prevHA = haData[i - 1];
            haBar.open = (prevHA.open + prevHA.close) / 2;
            haBar.close = (bar.open + bar.high + bar.low + bar.close) / 4;
        }
        haBar.high = Math.max(bar.high, haBar.open, haBar.close);
        haBar.low = Math.min(bar.low, haBar.open, haBar.close);
        haData.push(haBar);
    });
    return haData;
}

function generatePFCols(data, boxSize, reversal) {
    if (!data || data.length === 0) return [];
    
    const columns = [];
    let currentCol = { type: 'X', boxes: [Math.floor(data[0].close / boxSize) * boxSize] };
    
    data.forEach(bar => {
        const high = Math.floor(bar.high / boxSize) * boxSize;
        const low = Math.floor(bar.low / boxSize) * boxSize;
        const lastBox = currentCol.boxes[currentCol.boxes.length - 1];
        
        if (currentCol.type === 'X') {
            if (high > lastBox) {
                for (let p = lastBox + boxSize; p <= high; p += boxSize) currentCol.boxes.push(p);
            } else if (lastBox - low >= reversal * boxSize) {
                columns.push(currentCol);
                currentCol = { type: 'O', boxes: [] };
                for (let p = lastBox - boxSize; p >= low; p -= boxSize) currentCol.boxes.push(p);
            }
        } else {
            if (low < lastBox) {
                for (let p = lastBox - boxSize; p >= low; p -= boxSize) currentCol.boxes.push(p);
            } else if (high - lastBox >= reversal * boxSize) {
                columns.push(currentCol);
                currentCol = { type: 'X', boxes: [] };
                for (let p = lastBox + boxSize; p <= high; p += boxSize) currentCol.boxes.push(p);
            }
        }
    });
    
    if (currentCol.boxes.length > 0) columns.push(currentCol);
    return columns.slice(-30);
}

// Keep old function for fallback
function renderMultiCandlestickChart(panelType, data, chartType, canvas) {
    const ctx = canvas.getContext('2d');
    
    if (multiChartInstances && multiChartInstances[panelType]) {
        multiChartInstances[panelType].destroy();
    }
    
    const labels = data.map((bar, i) => {
        if (bar.time) return bar.time;
        const dateStr = bar.date?.split('T')[0] || '';
        return dateStr.slice(5);
    });
    
    const upColor = chartType === 'heikinashi' ? '#4caf50' : '#26a69a';
    const downColor = chartType === 'heikinashi' ? '#f44336' : '#ef5350';
    
    if (typeof Chart !== 'undefined') {
        multiChartInstances[panelType] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Price',
                    data: data.map(bar => bar.close),
                    backgroundColor: data.map(bar => bar.close >= bar.open ? upColor : downColor),
                    borderColor: data.map(bar => bar.close >= bar.open ? upColor : downColor),
                    borderWidth: 1,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: '#787b86', maxTicksLimit: 8, font: { size: 9 } } },
                    y: { display: true, position: 'right', grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: '#787b86', font: { size: 9 } } }
                }
            }
        });
    }
}

// Initialize multi-charts when tab is clicked
document.addEventListener('DOMContentLoaded', function() {
    const multiChartsTab = document.querySelector('[data-tab="multi-charts"]');
    if (multiChartsTab) {
        multiChartsTab.addEventListener('click', function() {
            setTimeout(initMultiCharts, 100);
        });
    }
});


// ============================================
// DAILY ANALYSIS SYSTEM
// ============================================

let currentAnalysisMode = 'morning';
let dailyAnalysisData = null;

// Initialize Daily Analysis when tab is clicked
document.addEventListener('DOMContentLoaded', function() {
    const analysisTab = document.querySelector('[data-tab="daily-analysis"]');
    if (analysisTab) {
        analysisTab.addEventListener('click', async function() {
            await loadRealAgentSignals();
            setTimeout(generateDailyReport, 100);
        });
    }
    
    // Pre-load agent signals on page load
    loadRealAgentSignals();
    
    // Auto-generate reports at scheduled times
    checkScheduledAnalysis();
    setInterval(checkScheduledAnalysis, 60000); // Check every minute
});

function checkScheduledAnalysis() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    
    // Morning analysis at 9:35 AM
    if (hours === 9 && minutes === 35) {
        currentAnalysisMode = 'morning';
        generateDailyReport();
    }
    
    // Evening analysis at 6:00 PM
    if (hours === 18 && minutes === 0) {
        currentAnalysisMode = 'evening';
        generateDailyReport();
    }
}

function switchAnalysisMode(mode) {
    currentAnalysisMode = mode;
    
    // Update button states
    document.getElementById('morningBtn')?.classList.toggle('active', mode === 'morning');
    document.getElementById('eveningBtn')?.classList.toggle('active', mode === 'evening');
    
    // Update title
    const planTitle = document.getElementById('planTitle');
    if (planTitle) {
        planTitle.textContent = mode === 'morning' ? ' Morning Trading Plan' : ' Evening Review & Next Day Plan';
    }
    
    generateDailyReport();
}

function refreshAnalysis() {
    generateDailyReport();
}

// AI Quick Analysis for Overview Tab
function refreshOverviewAI() {
    updateOverviewAiAnalysis();
}

function updateOverviewAiAnalysis() {
    const analysisEl = document.getElementById('overviewAiAnalysis');
    if (!analysisEl) return;

    if (!currentData || currentData.length < 2) {
        analysisEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);"><div style="font-size:24px;margin-bottom:8px;">&#9888;</div>Loading data...</div>';
        return;
    }

    const lastBar = currentData[currentData.length - 1];
    const prevBar = currentData[currentData.length - 2];
    const price = parseFloat(lastBar.Close) || 0;
    const prevClose = parseFloat(prevBar.Close) || price;
    const change = price - prevClose;
    const changePct = ((change / prevClose) * 100).toFixed(2);
    const atr = parseFloat(lastBar.ATR) || price * 0.015;
    const bias = lastBar.Bias || 'NEUTRAL';
    const volume = parseInt(lastBar.Volume) || 0;

    // Calculate 20-day average volume
    const recentData = currentData.slice(-20);
    const avgVol = recentData.reduce((sum, d) => sum + (parseInt(d.Volume) || 0), 0) / recentData.length;
    const volRatio = avgVol > 0 ? (volume / avgVol * 100).toFixed(0) : 100;

    // Determine signal strength
    const fastSMA = parseFloat(lastBar.FastSMA) || price;
    const slowSMA = parseFloat(lastBar.SlowSMA) || price;
    const priceVsFast = price > fastSMA ? 'above' : 'below';
    const fastVsSlow = fastSMA > slowSMA ? 'bullish' : 'bearish';

    // Build AI analysis
    const direction = bias === 'BULLISH' ? 'bullish' : bias === 'BEARISH' ? 'bearish' : 'neutral';
    const optionType = bias === 'BULLISH' ? 'CALL' : bias === 'BEARISH' ? 'PUT' : 'neutral';
    const momentum = change > 0 ? 'positive' : 'negative';

    // Calculate key levels
    const entryZoneLow = (price - atr * 0.3).toFixed(2);
    const entryZoneHigh = bias === 'BULLISH' ? price.toFixed(2) : (price + atr * 0.3).toFixed(2);
    const entryZone = bias === 'BULLISH' ?
        '$' + entryZoneLow + ' - $' + price.toFixed(2) :
        '$' + price.toFixed(2) + ' - $' + (price + atr * 0.3).toFixed(2);
    const stopLoss = bias === 'BULLISH' ? (price - atr * 0.75).toFixed(2) : (price + atr * 0.75).toFixed(2);
    const target1 = bias === 'BULLISH' ? (price + atr * 1.5).toFixed(2) : (price - atr * 1.5).toFixed(2);
    const target2 = bias === 'BULLISH' ? (price + atr * 2.5).toFixed(2) : (price - atr * 2.5).toFixed(2);

    // Confidence score
    let confidence = 50;
    if (bias === 'BULLISH' && price > fastSMA) confidence += 15;
    if (bias === 'BEARISH' && price < fastSMA) confidence += 15;
    if (parseInt(volRatio) > 100) confidence += 10;
    if (Math.abs(parseFloat(changePct)) > 0.5) confidence += 5;
    confidence = Math.min(95, confidence);

    const confColor = confidence >= 75 ? 'var(--success)' : confidence >= 60 ? 'var(--warning)' : 'var(--danger)';
    const signalColor = bias === 'BULLISH' ? 'var(--success)' : bias === 'BEARISH' ? 'var(--danger)' : 'var(--muted)';
    const volMsg = parseInt(volRatio) > 120 ? 'High volume confirms the move.' :
                   parseInt(volRatio) < 80 ? 'Low volume - move may lack conviction.' :
                   'Normal volume activity.';
    const confMsg = confidence >= 75 ? 'High confidence - favorable setup' :
                    confidence >= 60 ? 'Moderate confidence - smaller size' :
                    'Low confidence - consider waiting';
    const dteText = tradingMode === 'INTRADAY' ? '0-1 days' : '3-7 days';

    analysisEl.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
            <div>
                <div style="background:rgba(59,130,246,0.1);padding:12px;border-radius:8px;margin-bottom:10px;">
                    <strong style="color:var(--primary);">Market Snapshot</strong><br>
                    <span style="font-size:11px;">
                        ${currentSymbol} is showing <strong style="color:${signalColor};">${direction}</strong> bias with
                        <strong style="color:${momentum === 'positive' ? 'var(--success)' : 'var(--danger)'};">
                            ${parseFloat(changePct) > 0 ? '+' : ''}${changePct}%
                        </strong> move today.<br>
                        Price is ${priceVsFast} the 9-SMA with ${fastVsSlow} SMA crossover.
                    </span>
                </div>

                <div style="background:rgba(16,185,129,0.1);padding:12px;border-radius:8px;">
                    <strong style="color:var(--success);">Trade Setup</strong><br>
                    <span style="font-size:11px;">
                        <strong>Signal:</strong> <span style="color:${signalColor};font-weight:700;">${optionType}</span><br>
                        <strong>Entry Zone:</strong> ${entryZone}<br>
                        <strong>Stop Loss:</strong> <span style="color:var(--danger);">$${stopLoss}</span><br>
                        <strong>Target 1:</strong> <span style="color:var(--success);">$${target1}</span><br>
                        <strong>Target 2:</strong> <span style="color:var(--success);">$${target2}</span>
                    </span>
                </div>
            </div>

            <div>
                <div style="background:rgba(139,92,246,0.1);padding:12px;border-radius:8px;margin-bottom:10px;">
                    <strong style="color:#8b5cf6;">Volume Analysis</strong><br>
                    <span style="font-size:11px;">
                        Today's volume is at <strong>${volRatio}%</strong> of 20-day average.<br>
                        ${volMsg}
                    </span>
                </div>

                <div style="background:rgba(245,158,11,0.1);padding:12px;border-radius:8px;">
                    <strong style="color:var(--warning);">Confidence</strong><br>
                    <span style="font-size:11px;">
                        <div style="display:flex;align-items:center;gap:10px;margin-top:5px;">
                            <div style="flex:1;background:var(--border);border-radius:4px;height:8px;">
                                <div style="width:${confidence}%;background:${confColor};height:100%;border-radius:4px;"></div>
                            </div>
                            <strong style="color:${confColor};">${confidence}%</strong>
                        </div>
                        <div style="margin-top:5px;">
                            ${confMsg}
                        </div>
                    </span>
                </div>
            </div>
        </div>

        <div style="margin-top:12px;padding:10px;background:var(--bg);border-radius:6px;font-size:11px;color:var(--muted);">
            ATR: $${atr.toFixed(2)} | Risk/Reward: 1:2 minimum | DTE: ${dteText}
        </div>
    `;
}

// Data Pattern Detection with Dates
function updateDataPatternDetection() {
    const detectionEl = document.getElementById('dataPatternDetection');
    if (!detectionEl) return;

    if (!currentData || currentData.length < 10) {
        detectionEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);"><div style="font-size:24px;margin-bottom:8px;">&#9888;</div>Insufficient data for pattern detection</div>';
        return;
    }

    // Format date as "Mon DD" (e.g., "Dec 2", "Nov 27")
    function formatDateShort(dateStr) {
        const date = new Date(dateStr);
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return months[date.getMonth()] + ' ' + date.getDate();
    }

    // Get last 30 days of data for analysis
    const recentData = currentData.slice(-30);
    const analysisResults = [];

    // 1. UPTREND DETECTION - Check last 5 days for consecutive higher closes
    const last5Days = recentData.slice(-5);
    let uptrendDays = 0;
    for (let i = 1; i < last5Days.length; i++) {
        if (parseFloat(last5Days[i].Close) > parseFloat(last5Days[i-1].Close)) {
            uptrendDays++;
        }
    }

    let downtrendDays = 0;
    for (let i = 1; i < last5Days.length; i++) {
        if (parseFloat(last5Days[i].Close) < parseFloat(last5Days[i-1].Close)) {
            downtrendDays++;
        }
    }

    if (uptrendDays >= 3) {
        const startDate = formatDateShort(last5Days[0].Date || last5Days[0].date);
        const endDate = formatDateShort(last5Days[last5Days.length - 1].Date || last5Days[last5Days.length - 1].date);
        analysisResults.push({
            type: 'uptrend',
            icon: '',
            text: `<strong style="color:#22c55e;">UPTREND</strong> detected in last 5 days (${startDate} - ${endDate})`,
            detail: `${uptrendDays} of 4 days with higher closes`
        });
    } else if (downtrendDays >= 3) {
        const startDate = formatDateShort(last5Days[0].Date || last5Days[0].date);
        const endDate = formatDateShort(last5Days[last5Days.length - 1].Date || last5Days[last5Days.length - 1].date);
        analysisResults.push({
            type: 'downtrend',
            icon: '',
            text: `<strong style="color:#ef4444;">DOWNTREND</strong> detected in last 5 days (${startDate} - ${endDate})`,
            detail: `${downtrendDays} of 4 days with lower closes`
        });
    }

    // 2. HIGH VOLUME DAYS - Find days with >150% of 20-day average volume
    const avgVolume = recentData.slice(-20).reduce((sum, d) => sum + (parseInt(d.Volume) || 0), 0) / 20;
    const highVolumeDays = [];

    recentData.forEach(bar => {
        const vol = parseInt(bar.Volume) || 0;
        if (vol > avgVolume * 1.5) {
            highVolumeDays.push({
                date: formatDateShort(bar.Date || bar.date),
                volume: vol,
                ratio: ((vol / avgVolume) * 100).toFixed(0)
            });
        }
    });

    if (highVolumeDays.length > 0) {
        // Sort by most recent (reverse chronological)
        highVolumeDays.reverse();
        const displayDates = highVolumeDays.slice(0, 5).map(d => d.date);
        const moreCount = highVolumeDays.length > 5 ? ` (+${highVolumeDays.length - 5} more)` : '';
        analysisResults.push({
            type: 'highVolume',
            icon: '',
            text: `<strong style="color:#8b5cf6;">${highVolumeDays.length} HIGH VOLUME</strong> days (&gt;150% of average)`,
            detail: displayDates.join(', ') + moreCount
        });
    }

    // 3. GAP UPs - Find days where Open > Previous Close
    const gapUps = [];
    for (let i = 1; i < recentData.length; i++) {
        const prevClose = parseFloat(recentData[i-1].Close) || 0;
        const currOpen = parseFloat(recentData[i].Open) || 0;
        const gapSize = currOpen - prevClose;

        if (gapSize > 0 && gapSize >= prevClose * 0.002) { // At least 0.2% gap
            gapUps.push({
                date: formatDateShort(recentData[i].Date || recentData[i].date),
                gap: gapSize,
                pct: ((gapSize / prevClose) * 100).toFixed(2)
            });
        }
    }

    if (gapUps.length > 0) {
        // Sort by gap size (largest first)
        gapUps.sort((a, b) => b.gap - a.gap);
        const top3 = gapUps.slice(0, 3);
        const detailLines = top3.map(g => `${g.date}: +$${g.gap.toFixed(2)} gap`);
        const moreCount = gapUps.length > 3 ? `<br><span style="color:var(--muted);font-size:10px;">(showing top 3 by size, +${gapUps.length - 3} more)</span>` : '';
        analysisResults.push({
            type: 'gapUp',
            icon: '',
            text: `<strong style="color:#22c55e;">${gapUps.length} GAP UP(s)</strong> detected`,
            detail: detailLines.join('<br>') + moreCount
        });
    }

    // 4. GAP DOWNs - Find days where Open < Previous Close
    const gapDowns = [];
    for (let i = 1; i < recentData.length; i++) {
        const prevClose = parseFloat(recentData[i-1].Close) || 0;
        const currOpen = parseFloat(recentData[i].Open) || 0;
        const gapSize = prevClose - currOpen;

        if (gapSize > 0 && gapSize >= prevClose * 0.002) { // At least 0.2% gap
            gapDowns.push({
                date: formatDateShort(recentData[i].Date || recentData[i].date),
                gap: gapSize,
                pct: ((gapSize / prevClose) * 100).toFixed(2)
            });
        }
    }

    if (gapDowns.length > 0) {
        // Sort by gap size (largest first)
        gapDowns.sort((a, b) => b.gap - a.gap);
        const top3 = gapDowns.slice(0, 3);
        const detailLines = top3.map(g => `${g.date}: -$${g.gap.toFixed(2)} gap`);
        const moreCount = gapDowns.length > 3 ? `<br><span style="color:var(--muted);font-size:10px;">(showing top 3 by size, +${gapDowns.length - 3} more)</span>` : '';
        analysisResults.push({
            type: 'gapDown',
            icon: '',
            text: `<strong style="color:#ef4444;">${gapDowns.length} GAP DOWN(s)</strong> detected`,
            detail: detailLines.join('<br>') + moreCount
        });
    }

    // Build HTML output
    if (analysisResults.length === 0) {
        detectionEl.innerHTML = `
            <div style="text-align:center;padding:15px;color:var(--muted);">
                <div style="font-size:20px;margin-bottom:8px;"></div>
                No significant patterns detected in last 30 days
            </div>
        `;
        return;
    }

    let html = '<div style="display:flex;flex-direction:column;gap:10px;">';
    analysisResults.forEach(result => {
        const bgColor = result.type === 'uptrend' ? 'rgba(34,197,94,0.1)' :
                        result.type === 'downtrend' ? 'rgba(239,68,68,0.1)' :
                        result.type === 'highVolume' ? 'rgba(139,92,246,0.1)' :
                        result.type === 'gapUp' ? 'rgba(34,197,94,0.08)' :
                        'rgba(239,68,68,0.08)';
        html += `
            <div style="background:${bgColor};padding:10px 12px;border-radius:8px;">
                <div style="font-size:12px;margin-bottom:4px;">
                    ${result.icon} ${result.text}
                </div>
                <div style="font-size:11px;color:var(--muted);padding-left:20px;">
                    ${result.detail}
                </div>
            </div>
        `;
    });
    html += '</div>';

    detectionEl.innerHTML = html;
}

// ============================================
// GANN ANALYSIS FUNCTIONS
// ============================================

// Gann Quotes for rotation
const gannQuotes = [
    '"Time is more important than price." - W.D. Gann',
    '"The future is but a repetition of the past." - W.D. Gann',
    '"When time and price balance, change is imminent." - W.D. Gann',
    '"Every movement in the market is a result of natural law." - W.D. Gann',
    '"The market is never wrong, opinions often are." - W.D. Gann',
    '"Knowledge is the key to success in speculation." - W.D. Gann',
    '"Never trade without stop losses." - W.D. Gann',
    '"Buy and sell on definite rules, not on hope or fear." - W.D. Gann'
];

// Calculate Square of 9 levels
function calculateSquareOf9(price) {
    if (!price || price <= 0) return null;

    const sqrt = Math.sqrt(price);
    const angles = [45, 90, 135, 180, 225, 270, 315, 360];
    const support = [];
    const resistance = [];

    angles.forEach(angle => {
        // Resistance levels (adding to sqrt)
        const resistSqrt = sqrt + (angle / 180);
        const resistPrice = resistSqrt * resistSqrt;
        resistance.push({
            angle: angle,
            price: resistPrice,
            diff: resistPrice - price,
            diffPct: ((resistPrice - price) / price * 100).toFixed(2)
        });

        // Support levels (subtracting from sqrt)
        const supportSqrt = sqrt - (angle / 180);
        if (supportSqrt > 0) {
            const supportPrice = supportSqrt * supportSqrt;
            support.push({
                angle: angle,
                price: supportPrice,
                diff: price - supportPrice,
                diffPct: ((price - supportPrice) / price * 100).toFixed(2)
            });
        }
    });

    return { support, resistance, sqrt, price };
}

// Calculate Gann Time Cycles
function calculateGannCycles(referenceDate) {
    const today = new Date();
    const ref = referenceDate ? new Date(referenceDate) : new Date(today.getFullYear(), 0, 1); // Start of year
    const daysSinceRef = Math.floor((today - ref) / (1000 * 60 * 60 * 24));

    const cycles = [
        { name: '30-Day Minor', days: 30, color: '#3b82f6' },
        { name: '45-Day (1/8 yr)', days: 45, color: '#8b5cf6' },
        { name: '60-Day', days: 60, color: '#06b6d4' },
        { name: '90-Day (Qtr)', days: 90, color: '#10b981' },
        { name: '120-Day (1/3 yr)', days: 120, color: '#f59e0b' },
        { name: '144-Day Sacred', days: 144, color: '#d4a017' },
        { name: '180-Day (Semi)', days: 180, color: '#ef4444' },
        { name: '360-Day (Annual)', days: 360, color: '#ec4899' }
    ];

    return cycles.map(cycle => {
        const position = daysSinceRef % cycle.days;
        const progress = (position / cycle.days) * 100;
        const daysUntilTurn = cycle.days - position;
        const nextTurnDate = new Date(today.getTime() + daysUntilTurn * 24 * 60 * 60 * 1000);
        const isNearTurn = daysUntilTurn <= 2 || position <= 2;

        return {
            ...cycle,
            position,
            progress,
            daysUntilTurn,
            nextTurnDate,
            isNearTurn
        };
    });
}

// Detect significant pivots from price data
function detectGannPivots(data) {
    if (!data || data.length < 20) return { high: null, low: null };

    const lookback = Math.min(60, data.length);
    const recentData = data.slice(-lookback);

    let highestHigh = { price: 0, date: null, index: 0 };
    let lowestLow = { price: Infinity, date: null, index: 0 };

    recentData.forEach((bar, i) => {
        const high = parseFloat(bar.High) || 0;
        const low = parseFloat(bar.Low) || Infinity;
        const date = bar.Date || bar.date;

        if (high > highestHigh.price) {
            highestHigh = { price: high, date, index: i };
        }
        if (low < lowestLow.price) {
            lowestLow = { price: low, date, index: i };
        }
    });

    return {
        high: highestHigh.price > 0 ? highestHigh : null,
        low: lowestLow.price < Infinity ? lowestLow : null,
        dataLength: lookback
    };
}

// Calculate Gann Angles from pivot
function calculateGannAngles(pivotPrice, daysSincePivot, currentPrice) {
    if (!pivotPrice || daysSincePivot < 1) return [];

    // Gann angle ratios: price units per time unit
    const angleRatios = [
        { name: '1x8', ratio: 0.125, degrees: 7.5 },
        { name: '1x4', ratio: 0.25, degrees: 15 },
        { name: '1x3', ratio: 0.333, degrees: 18.75 },
        { name: '1x2', ratio: 0.5, degrees: 26.25 },
        { name: '1x1', ratio: 1, degrees: 45 },
        { name: '2x1', ratio: 2, degrees: 63.75 },
        { name: '3x1', ratio: 3, degrees: 71.25 },
        { name: '4x1', ratio: 4, degrees: 75 },
        { name: '8x1', ratio: 8, degrees: 82.5 }
    ];

    // Scale factor for price movement (ATR-based or percentage)
    const scaleFactor = pivotPrice * 0.001; // 0.1% per day as base unit

    return angleRatios.map(angle => {
        const priceAtAngle = pivotPrice + (angle.ratio * scaleFactor * daysSincePivot);
        const diffFromCurrent = currentPrice - priceAtAngle;
        const isAbove = currentPrice > priceAtAngle;

        return {
            ...angle,
            price: priceAtAngle,
            diff: diffFromCurrent,
            isAbove,
            isNear: Math.abs(diffFromCurrent / currentPrice) < 0.005 // Within 0.5%
        };
    });
}

// Calculate Gann Confluence Score
function calculateGannConfluence(sq9Levels, cycles, angles, price) {
    let score = 0;
    const factors = [];

    // Factor 1: Price near Square of 9 level (+25)
    let nearSq9 = false;
    if (sq9Levels) {
        const allLevels = [...sq9Levels.support, ...sq9Levels.resistance];
        nearSq9 = allLevels.some(level => Math.abs(level.diffPct) < 1.5);
    }
    if (nearSq9) {
        score += 25;
        factors.push({ text: 'Price near Square of 9 level', points: 25, active: true });
    } else {
        factors.push({ text: 'Price near Square of 9 level', points: 0, active: false });
    }

    // Factor 2: Time near cycle turn (+25)
    const nearCycleTurn = cycles && cycles.some(c => c.isNearTurn);
    if (nearCycleTurn) {
        score += 25;
        factors.push({ text: 'Time near cycle turn date', points: 25, active: true });
    } else {
        factors.push({ text: 'Time near cycle turn date', points: 0, active: false });
    }

    // Factor 3: Price on Gann angle (+25)
    const onAngle = angles && angles.some(a => a.isNear);
    if (onAngle) {
        score += 25;
        factors.push({ text: 'Price on Gann angle', points: 25, active: true });
    } else {
        factors.push({ text: 'Price on Gann angle', points: 0, active: false });
    }

    // Factor 4: Multiple cycles converging (+25)
    const convergingCycles = cycles ? cycles.filter(c => c.daysUntilTurn <= 5).length : 0;
    if (convergingCycles >= 2) {
        score += 25;
        factors.push({ text: `${convergingCycles} cycles converging`, points: 25, active: true });
    } else {
        factors.push({ text: 'Multiple cycles converging', points: 0, active: false });
    }

    return { score, factors };
}

// Get important Gann dates for current year
function getGannDates() {
    const year = new Date().getFullYear();
    const today = new Date();

    const dates = [
        { name: 'Spring Equinox', date: new Date(year, 2, 20), icon: '' },
        { name: 'Summer Solstice', date: new Date(year, 5, 21), icon: '' },
        { name: 'Fall Equinox', date: new Date(year, 8, 22), icon: '' },
        { name: 'Winter Solstice', date: new Date(year, 11, 21), icon: '' },
        { name: 'Year Start', date: new Date(year, 0, 1), icon: '' },
        { name: 'Mid-Year', date: new Date(year, 6, 1), icon: '' }
    ];

    return dates.map(d => {
        const daysDiff = Math.floor((d.date - today) / (1000 * 60 * 60 * 24));
        const isNear = Math.abs(daysDiff) <= 5;
        const isPast = daysDiff < 0;

        return {
            ...d,
            daysDiff,
            isNear,
            isPast,
            dateStr: d.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
        };
    }).sort((a, b) => a.date - b.date);
}

// Auto-fill Square of 9 with current price
function autoFillSq9Price() {
    const input = document.getElementById('sq9Input');
    if (input && currentData && currentData.length > 0) {
        const lastBar = currentData[currentData.length - 1];
        const price = parseFloat(lastBar.Close) || 0;
        input.value = price.toFixed(2);
        updateSquareOf9();
    }
}

// Update Square of 9 display
function updateSquareOf9() {
    const input = document.getElementById('sq9Input');
    const price = parseFloat(input?.value) || 0;

    if (price <= 0) return;

    const levels = calculateSquareOf9(price);
    if (!levels) return;

    // Update visual spiral
    const spiralEl = document.getElementById('sq9Spiral');
    if (spiralEl) {
        spiralEl.innerHTML = `
            <div style="position: relative; width: 180px; height: 180px;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div style="font-size: 8px; color: var(--muted);">CENTER</div>
                    <div style="font-size: 16px; font-weight: 700; color: #d4a017;">$${price.toFixed(2)}</div>
                    <div style="font-size: 9px; color: var(--muted);">${levels.sqrt.toFixed(4)}</div>
                </div>
                ${[45, 90, 135, 180, 225, 270, 315, 360].map((angle, i) => {
                    const rad = (angle - 90) * Math.PI / 180;
                    const r = 60 + (i * 5);
                    const x = 90 + Math.cos(rad) * r;
                    const y = 90 + Math.sin(rad) * r;
                    return `<div style="position: absolute; left: ${x}px; top: ${y}px; transform: translate(-50%, -50%); font-size: 8px; color: var(--muted);">${angle}</div>`;
                }).join('')}
                <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" viewBox="0 0 180 180">
                    <circle cx="90" cy="90" r="30" fill="none" stroke="rgba(212,160,23,0.2)" stroke-width="1"/>
                    <circle cx="90" cy="90" r="50" fill="none" stroke="rgba(212,160,23,0.15)" stroke-width="1"/>
                    <circle cx="90" cy="90" r="70" fill="none" stroke="rgba(212,160,23,0.1)" stroke-width="1"/>
                    <line x1="90" y1="20" x2="90" y2="160" stroke="rgba(212,160,23,0.1)" stroke-width="1"/>
                    <line x1="20" y1="90" x2="160" y2="90" stroke="rgba(212,160,23,0.1)" stroke-width="1"/>
                </svg>
            </div>
        `;
    }

    // Update support levels
    const supportEl = document.getElementById('sq9Support');
    if (supportEl) {
        supportEl.innerHTML = levels.support.map(l => `
            <div class="sq9-level">
                <span class="sq9-angle">${l.angle}</span>
                <span class="sq9-price" style="color: #22c55e;">$${l.price.toFixed(2)}</span>
                <span class="sq9-diff">-${l.diffPct}%</span>
            </div>
        `).join('');
    }

    // Update resistance levels
    const resistEl = document.getElementById('sq9Resistance');
    if (resistEl) {
        resistEl.innerHTML = levels.resistance.map(l => `
            <div class="sq9-level">
                <span class="sq9-angle">${l.angle}</span>
                <span class="sq9-price" style="color: #ef4444;">$${l.price.toFixed(2)}</span>
                <span class="sq9-diff">+${l.diffPct}%</span>
            </div>
        `).join('');
    }

    return levels;
}

// Main Gann Analysis Update Function
function updateGannAnalysis() {
    if (!currentData || currentData.length < 10) {
        console.warn('Insufficient data for Gann analysis');
        return;
    }

    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close) || 0;

    // Update header
    document.getElementById('gannCurrentSymbol').textContent = currentSymbol;
    document.getElementById('gannCurrentPrice').textContent = '$' + price.toFixed(2);

    // Auto-fill and calculate Square of 9
    const sq9Input = document.getElementById('sq9Input');
    if (sq9Input && !sq9Input.value) {
        sq9Input.value = price.toFixed(2);
    }
    const sq9Levels = updateSquareOf9();

    // Calculate Time Cycles
    const cycles = calculateGannCycles();
    updateCycleDisplay(cycles);

    // Detect Pivots and Calculate Angles
    const pivots = detectGannPivots(currentData);
    updatePivotDisplay(pivots, price);

    // Calculate angles from pivots
    let anglesFromLow = [];
    let anglesFromHigh = [];
    if (pivots.low) {
        const daysSinceLow = pivots.dataLength - pivots.low.index;
        anglesFromLow = calculateGannAngles(pivots.low.price, daysSinceLow, price);
    }
    if (pivots.high) {
        const daysSinceHigh = pivots.dataLength - pivots.high.index;
        anglesFromHigh = calculateGannAngles(pivots.high.price, daysSinceHigh, price);
    }
    updateAnglesDisplay(anglesFromLow, anglesFromHigh, price);

    // Update Sacred Numbers
    updateSacredNumbers(price);

    // Calculate Confluence Score
    const confluence = calculateGannConfluence(sq9Levels, cycles, [...anglesFromLow, ...anglesFromHigh], price);
    updateConfluenceDisplay(confluence);

    // Generate Forecast
    generateGannForecast(sq9Levels, cycles, pivots, confluence, price);

    // Update Gann Dates
    updateGannDates();

    // Rotate quote
    const quoteEl = document.getElementById('gannQuote');
    if (quoteEl) {
        quoteEl.textContent = gannQuotes[Math.floor(Math.random() * gannQuotes.length)];
    }

    console.log('Gann Analysis updated for', currentSymbol);
}

// Update Cycle Display
function updateCycleDisplay(cycles) {
    const progressEl = document.getElementById('cycleProgress');
    const alertEl = document.getElementById('cycleAlert');

    if (!progressEl) return;

    // Check for cycle turn zone
    const anyNearTurn = cycles.some(c => c.isNearTurn);
    if (alertEl) {
        alertEl.style.display = anyNearTurn ? 'block' : 'none';
    }

    progressEl.innerHTML = cycles.map(cycle => {
        const fillColor = cycle.isNearTurn ? '#f59e0b' : cycle.color;
        return `
            <div class="cycle-bar ${cycle.isNearTurn ? 'gann-glow' : ''}">
                <span class="cycle-bar-label">${cycle.name}</span>
                <div class="cycle-bar-track">
                    <div class="cycle-bar-fill" style="width: ${cycle.progress.toFixed(1)}%; background: ${fillColor};"></div>
                </div>
                <span class="cycle-bar-value" style="color: ${fillColor};">${cycle.daysUntilTurn}d</span>
            </div>
        `;
    }).join('');
}

// Update Pivot Display
function updatePivotDisplay(pivots, currentPrice) {
    const lowEl = document.getElementById('gannPivotLow');
    const highEl = document.getElementById('gannPivotHigh');

    if (lowEl && pivots.low) {
        const dateStr = new Date(pivots.low.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        lowEl.innerHTML = `$${pivots.low.price.toFixed(2)} <span style="font-size:10px;color:var(--muted);">(${dateStr})</span>`;
    }

    if (highEl && pivots.high) {
        const dateStr = new Date(pivots.high.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        highEl.innerHTML = `$${pivots.high.price.toFixed(2)} <span style="font-size:10px;color:var(--muted);">(${dateStr})</span>`;
    }
}

// Update Angles Display
function updateAnglesDisplay(fromLow, fromHigh, currentPrice) {
    const lowEl = document.getElementById('anglesFromLow');
    const highEl = document.getElementById('anglesFromHigh');
    const positionEl = document.getElementById('anglePositionText');

    if (lowEl) {
        lowEl.innerHTML = fromLow.map(angle => `
            <div class="angle-badge ${angle.isNear ? 'active' : ''}">
                <div class="angle-badge-name">${angle.name} (${angle.degrees})</div>
                <div class="angle-badge-value">$${angle.price.toFixed(2)}</div>
            </div>
        `).join('');
    }

    if (highEl) {
        highEl.innerHTML = fromHigh.map(angle => `
            <div class="angle-badge ${angle.isNear ? 'active' : ''}">
                <div class="angle-badge-name">${angle.name} (${angle.degrees})</div>
                <div class="angle-badge-value">$${angle.price.toFixed(2)}</div>
            </div>
        `).join('');
    }

    // Determine position
    if (positionEl) {
        const above1x1Low = fromLow.find(a => a.name === '1x1')?.isAbove;
        const below1x1High = fromHigh.find(a => a.name === '1x1')?.isAbove === false;

        let posText = '';
        if (above1x1Low && below1x1High) {
            posText = 'Price BETWEEN 1x1 angles - Balanced zone';
        } else if (above1x1Low) {
            posText = 'Price ABOVE 1x1 from low - Bullish momentum';
        } else {
            posText = 'Price BELOW 1x1 from low - Bearish pressure';
        }
        positionEl.textContent = posText;
    }
}

// Update Sacred Numbers Display
function updateSacredNumbers(price) {
    const cardinalEl = document.getElementById('cardinalNumbers');
    const sacredEl = document.getElementById('sacredNumbers');
    const relEl = document.getElementById('priceRelationships');

    if (cardinalEl) {
        const cardinals = [90, 180, 270, 360];
        cardinalEl.innerHTML = cardinals.map(n => `
            <div class="sacred-number">
                <div class="sacred-number-value">${n}</div>
                <div class="sacred-number-label">Cardinal</div>
            </div>
        `).join('');
    }

    if (sacredEl) {
        const sacred = [
            { val: 7, label: 'Days/Week' },
            { val: 9, label: 'Square of 9' },
            { val: 12, label: 'Months' },
            { val: 52, label: 'Weeks/Yr' },
            { val: 144, label: 'Fibonacci' }
        ];
        sacredEl.innerHTML = sacred.map(s => `
            <div class="sacred-number">
                <div class="sacred-number-value">${s.val}</div>
                <div class="sacred-number-label">${s.label}</div>
            </div>
        `).join('');
    }

    if (relEl) {
        const sqrt = Math.sqrt(price);
        const squared = price * price;
        const div9 = price / 9;
        const times9 = price * 9;

        relEl.innerHTML = `
            <div style="background:rgba(255,255,255,0.5);padding:8px;border-radius:4px;">
                <div style="color:var(--muted);font-size:10px;">Price</div>
                <div style="font-weight:600;color:#d4a017;">${sqrt.toFixed(4)}</div>
            </div>
            <div style="background:rgba(255,255,255,0.5);padding:8px;border-radius:4px;">
                <div style="color:var(--muted);font-size:10px;">Price</div>
                <div style="font-weight:600;color:#d4a017;">${squared.toFixed(2)}</div>
            </div>
            <div style="background:rgba(255,255,255,0.5);padding:8px;border-radius:4px;">
                <div style="color:var(--muted);font-size:10px;">Price  9</div>
                <div style="font-weight:600;color:#d4a017;">${div9.toFixed(4)}</div>
            </div>
            <div style="background:rgba(255,255,255,0.5);padding:8px;border-radius:4px;">
                <div style="color:var(--muted);font-size:10px;">Price  9</div>
                <div style="font-weight:600;color:#d4a017;">${times9.toFixed(2)}</div>
            </div>
        `;
    }
}

// Update Confluence Display
function updateConfluenceDisplay(confluence) {
    const scoreEl = document.getElementById('confluenceScore');
    const labelEl = document.getElementById('confluenceLabel');
    const ringEl = document.getElementById('confluenceRing');
    const factorsEl = document.getElementById('confluenceFactors');

    if (scoreEl) {
        scoreEl.textContent = confluence.score;

        // Color based on score
        const color = confluence.score >= 75 ? '#22c55e' :
                      confluence.score >= 50 ? '#d4a017' :
                      confluence.score >= 25 ? '#f59e0b' : '#6b7280';
        scoreEl.style.color = color;
    }

    if (labelEl) {
        const label = confluence.score >= 75 ? 'HIGH PROBABILITY ZONE' :
                      confluence.score >= 50 ? 'MODERATE CONFLUENCE' :
                      confluence.score >= 25 ? 'WEAK CONFLUENCE' : 'LOW PROBABILITY';
        labelEl.textContent = label;
        labelEl.style.color = confluence.score >= 50 ? '#d4a017' : 'var(--muted)';
    }

    if (ringEl) {
        const circumference = 314; // 2 * PI * 50
        const offset = circumference - (confluence.score / 100 * circumference);
        ringEl.style.strokeDashoffset = offset;
        ringEl.style.stroke = confluence.score >= 75 ? '#22c55e' :
                              confluence.score >= 50 ? '#d4a017' : '#6b7280';
    }

    if (factorsEl) {
        factorsEl.innerHTML = confluence.factors.map(f => `
            <div class="confluence-factor">
                <span class="confluence-factor-icon">${f.active ? '' : ''}</span>
                <span class="confluence-factor-text">${f.text}</span>
                <span class="confluence-factor-score ${f.active ? 'active' : 'inactive'}">
                    ${f.active ? '+' + f.points : '0'}
                </span>
            </div>
        `).join('');
    }
}

// Generate Gann Forecast
function generateGannForecast(sq9Levels, cycles, pivots, confluence, price) {
    // Direction bias
    const biasEl = document.getElementById('gannBiasText');
    const biasContainerEl = document.getElementById('gannBias');

    let bias = 'NEUTRAL';
    let biasColor = '#d4a017';

    if (pivots.high && pivots.low) {
        const midPoint = (pivots.high.price + pivots.low.price) / 2;
        if (price > midPoint * 1.02) {
            bias = 'BULLISH';
            biasColor = '#22c55e';
        } else if (price < midPoint * 0.98) {
            bias = 'BEARISH';
            biasColor = '#ef4444';
        }
    }

    if (biasEl) {
        biasEl.textContent = bias;
        biasEl.style.color = biasColor;
    }

    // Support & Resistance from Square of 9
    const supportEl = document.getElementById('forecastSupport');
    const resistEl = document.getElementById('forecastResistance');

    if (sq9Levels && supportEl && resistEl) {
        const nextSupport = sq9Levels.support[0]; // 45 down
        const nextResist = sq9Levels.resistance[0]; // 45 up

        supportEl.textContent = nextSupport ? '$' + nextSupport.price.toFixed(2) : '--';
        resistEl.textContent = nextResist ? '$' + nextResist.price.toFixed(2) : '--';
    }

    // Next cycle turn
    const cycleDateEl = document.getElementById('forecastCycleDate');
    const daysUntilEl = document.getElementById('forecastDaysUntil');

    if (cycles && cycles.length > 0) {
        // Find nearest cycle turn
        const sorted = [...cycles].sort((a, b) => a.daysUntilTurn - b.daysUntilTurn);
        const nearest = sorted[0];

        if (cycleDateEl) {
            cycleDateEl.textContent = nearest.nextTurnDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        if (daysUntilEl) {
            daysUntilEl.textContent = nearest.daysUntilTurn + ' days';
            daysUntilEl.style.color = nearest.daysUntilTurn <= 3 ? '#f59e0b' : '#8b5cf6';
        }
    }

    // Projected move
    const projectedEl = document.getElementById('projectedMoveText');
    if (projectedEl && sq9Levels) {
        const atr = parseFloat(currentData[currentData.length - 1]?.ATR) || price * 0.015;
        const projectedMove = atr * 2;
        const nearestCycleDays = cycles ? Math.min(...cycles.map(c => c.daysUntilTurn)) : 30;

        const direction = bias === 'BULLISH' ? '' : bias === 'BEARISH' ? '' : '';
        projectedEl.textContent = `Expect ${direction} $${projectedMove.toFixed(2)} move within ${nearestCycleDays} days`;
    }
}

// Update Gann Dates
function updateGannDates() {
    const datesEl = document.getElementById('gannDates');
    if (!datesEl) return;

    const dates = getGannDates();
    datesEl.innerHTML = dates.map(d => `
        <div class="gann-date-item ${d.isNear ? 'near' : ''}">
            <span>${d.icon} ${d.name}</span>
            <span style="font-weight:600;${d.isNear ? 'color:#f59e0b;' : ''}">${d.dateStr}</span>
        </div>
    `).join('');
}

// ============================================
// OVERVIEW TAB UPDATE FUNCTIONS
// ============================================

// Update Fibonacci Zone Display
function updateFibonacciZoneDisplay() {
    if (!currentData || currentData.length < 20) return;

    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close) || 0;

    // Calculate 52-week high/low for Fibonacci levels
    const lookback = Math.min(252, currentData.length);
    const yearData = currentData.slice(-lookback);
    let high52 = 0, low52 = Infinity;
    yearData.forEach(bar => {
        const h = parseFloat(bar.High) || 0;
        const l = parseFloat(bar.Low) || Infinity;
        if (h > high52) high52 = h;
        if (l < low52) low52 = l;
    });

    const range = high52 - low52;
    const s1 = low52 + range * 0.382;
    const s2 = low52 + range * 0.5;
    const s3 = low52 + range * 0.618;
    const r1 = high52; // 100%
    const r2 = high52 + range * 0.272;
    const r3 = high52 + range * 0.618;

    // Update prices
    document.getElementById('fibS3').textContent = '$' + s3.toFixed(2);
    document.getElementById('fibS2').textContent = '$' + s2.toFixed(2);
    document.getElementById('fibS1').textContent = '$' + s1.toFixed(2);
    document.getElementById('fibCurrentPrice').textContent = '$' + price.toFixed(2);
    document.getElementById('fibR1').textContent = '$' + r1.toFixed(2);
    document.getElementById('fibR2').textContent = '$' + r2.toFixed(2);
    document.getElementById('fibR3').textContent = '$' + r3.toFixed(2);

    // Determine zone
    let zoneLabel = '';
    let zoneColor = '#22c55e';
    if (price < s3) {
        zoneLabel = ' Below S3 - Oversold Zone';
        zoneColor = '#ef4444';
    } else if (price < s2) {
        zoneLabel = ' Between S3 and S2 - Support Zone';
        zoneColor = '#eab308';
    } else if (price < s1) {
        zoneLabel = ' Between S2 and S1 - Recovery Zone';
        zoneColor = '#22c55e';
    } else if (price < r1) {
        zoneLabel = ' Between S1 and R1 - Neutral Zone';
        zoneColor = '#22c55e';
    } else if (price < r2) {
        zoneLabel = ' Between R1 and R2 - Resistance Zone';
        zoneColor = '#eab308';
    } else if (price < r3) {
        zoneLabel = ' Between R2 and R3 - Extended Zone';
        zoneColor = '#f97316';
    } else {
        zoneLabel = ' Above R3 - Overbought Zone';
        zoneColor = '#ef4444';
    }

    const zoneLabelEl = document.getElementById('fibZoneLabel');
    if (zoneLabelEl) {
        zoneLabelEl.textContent = zoneLabel;
        zoneLabelEl.style.color = zoneColor;
    }
}

// Update Multi-Timeframe Trends
function updateMultiTimeframeTrends() {
    if (!currentData || currentData.length < 20) return;

    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close) || 0;

    // Calculate SMAs for different timeframes
    const sma5 = currentData.slice(-5).reduce((sum, d) => sum + parseFloat(d.Close || 0), 0) / 5;
    const sma10 = currentData.slice(-10).reduce((sum, d) => sum + parseFloat(d.Close || 0), 0) / 10;
    const sma20 = currentData.slice(-20).reduce((sum, d) => sum + parseFloat(d.Close || 0), 0) / 20;

    // Intraday trend (price vs 5 SMA)
    const intradayTrend = price > sma5 ? 'BULLISH' : 'BEARISH';
    const intradayColor = price > sma5 ? '#22c55e' : '#ef4444';

    // Swing trend (price vs 10 SMA and 5 vs 10)
    const swingBullish = price > sma10 && sma5 > sma10;
    const swingTrend = swingBullish ? 'BULLISH' : 'BEARISH';
    const swingColor = swingBullish ? '#22c55e' : '#ef4444';

    // Position trend (price vs 20 SMA)
    const positionTrend = price > sma20 ? 'BULLISH' : 'BEARISH';
    const positionColor = price > sma20 ? '#22c55e' : '#ef4444';

    document.getElementById('trendIntraday').textContent = intradayTrend;
    document.getElementById('trendIntraday').style.color = intradayColor;
    document.getElementById('trendSwing').textContent = swingTrend;
    document.getElementById('trendSwing').style.color = swingColor;
    document.getElementById('trendPosition').textContent = positionTrend;
    document.getElementById('trendPosition').style.color = positionColor;
}

// Update Gann Quick View
function updateGannQuickView() {
    if (!currentData || currentData.length < 10) return;

    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close) || 0;
    const bias = lastBar.Bias || 'NEUTRAL';

    // Trend
    const trendEl = document.getElementById('gannQvTrend');
    if (trendEl) {
        trendEl.textContent = bias;
        trendEl.style.color = bias === 'BULLISH' ? '#22c55e' : bias === 'BEARISH' ? '#ef4444' : '#d4a017';
    }

    // Volume vs Average
    const avgVol = currentData.slice(-20).reduce((sum, d) => sum + (parseInt(d.Volume) || 0), 0) / 20;
    const todayVol = parseInt(lastBar.Volume) || 0;
    const volRatio = avgVol > 0 ? ((todayVol / avgVol) * 100).toFixed(0) : 100;
    const volEl = document.getElementById('gannQvVolume');
    if (volEl) {
        volEl.textContent = volRatio + '%';
        volEl.style.color = parseInt(volRatio) > 120 ? '#22c55e' : parseInt(volRatio) < 80 ? '#ef4444' : 'var(--text)';
    }

    // Bars in current trend
    let barsInTrend = 0;
    const currentDirection = parseFloat(currentData[currentData.length - 1].Close) > parseFloat(currentData[currentData.length - 2].Close) ? 'up' : 'down';
    for (let i = currentData.length - 1; i > 0; i--) {
        const prevDir = parseFloat(currentData[i].Close) > parseFloat(currentData[i - 1].Close) ? 'up' : 'down';
        if (prevDir === currentDirection) {
            barsInTrend++;
        } else {
            break;
        }
    }
    const barsEl = document.getElementById('gannQvBars');
    if (barsEl) {
        barsEl.textContent = barsInTrend + ' bars';
        barsEl.style.color = barsInTrend > 5 ? '#f59e0b' : 'var(--text)';
    }

    // Cycle Phase
    const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    const cycleDay = dayOfYear % 30;
    const cyclePhaseEl = document.getElementById('gannQvCyclePhase');
    if (cyclePhaseEl) {
        cyclePhaseEl.textContent = 'Day ' + cycleDay + ' of 30';
    }

    // Next Cycle Turn
    const daysToTurn = 30 - cycleDay;
    const nextTurnEl = document.getElementById('gannQvNextTurn');
    if (nextTurnEl) {
        const nextDate = new Date();
        nextDate.setDate(nextDate.getDate() + daysToTurn);
        nextTurnEl.textContent = nextDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        nextTurnEl.style.color = daysToTurn <= 3 ? '#f59e0b' : 'var(--text)';
    }

    // Gann Score
    const scoreEl = document.getElementById('gannQvScore');
    if (scoreEl) {
        let score = 50;
        if (bias === 'BULLISH') score += 15;
        if (parseInt(volRatio) > 100) score += 10;
        if (barsInTrend >= 3) score += 10;
        score = Math.min(100, score);
        scoreEl.textContent = score + '/100';
        scoreEl.style.color = score >= 75 ? '#22c55e' : score >= 50 ? '#d4a017' : '#ef4444';
    }

    // Agent Consensus
    const consensusEl = document.getElementById('gannQvConsensus');
    if (consensusEl) {
        consensusEl.textContent = bias === 'BULLISH' ? 'BUY' : bias === 'BEARISH' ? 'SELL' : 'HOLD';
        consensusEl.style.color = bias === 'BULLISH' ? '#22c55e' : bias === 'BEARISH' ? '#ef4444' : '#d4a017';
    }

    // Reversal Risk
    const reversalEl = document.getElementById('gannQvReversal');
    if (reversalEl) {
        const risk = barsInTrend > 7 ? 'HIGH' : barsInTrend > 4 ? 'MEDIUM' : 'LOW';
        reversalEl.textContent = risk;
        reversalEl.style.color = risk === 'HIGH' ? '#ef4444' : risk === 'MEDIUM' ? '#f59e0b' : '#22c55e';
    }

    // MTF Alignment
    const mtfEl = document.getElementById('gannQvMtf');
    if (mtfEl) {
        const sma5 = currentData.slice(-5).reduce((sum, d) => sum + parseFloat(d.Close || 0), 0) / 5;
        const sma20 = currentData.slice(-20).reduce((sum, d) => sum + parseFloat(d.Close || 0), 0) / 20;
        const aligned = (price > sma5 && sma5 > sma20) || (price < sma5 && sma5 < sma20);
        mtfEl.textContent = aligned ? 'ALIGNED' : 'MIXED';
        mtfEl.style.color = aligned ? '#22c55e' : '#f59e0b';
    }

    // Entry Window
    const entryEl = document.getElementById('gannQvEntry');
    if (entryEl) {
        const entryScore = (barsInTrend < 5 && parseInt(volRatio) > 90) ? 'OPEN' : 'WAIT';
        entryEl.textContent = entryScore;
        entryEl.style.color = entryScore === 'OPEN' ? '#22c55e' : '#f59e0b';
    }
}

// Symbol to full name mapping
const symbolNames = {
    'SPY': 'S&P 500',
    'QQQ': 'Nasdaq 100',
    'IWM': 'Russell 2000',
    'DIA': 'Dow Jones',
    'XLK': 'Technology',
    'XLF': 'Financials',
    'XLE': 'Energy',
    'XLV': 'Healthcare',
    'XLI': 'Industrials',
    'XLP': 'Consumer Staples',
    'XLU': 'Utilities',
    'XLB': 'Materials',
    'XLC': 'Communications',
    'XLRE': 'Real Estate',
    'XLY': 'Consumer Disc',
    'VXX': 'Volatility',
    'TLT': 'Treasury Bonds',
    'GLD': 'Gold',
    'SLV': 'Silver',
    'USO': 'Oil',
    'UNG': 'Natural Gas',
    'EEM': 'Emerging Mkts',
    'EFA': 'Intl Developed',
    'HYG': 'High Yield',
    'LQD': 'Investment Grade',
    'ARKK': 'Innovation',
    'SMH': 'Semiconductors',
    'XBI': 'Biotech',
    'KRE': 'Regional Banks',
    'XHB': 'Homebuilders'
};

// Update Trade Statistics
function updateTradeStatistics() {
    if (!currentData || currentData.length < 30) return;

    const last30 = currentData.slice(-30);
    let wins = 0, losses = 0;
    let totalWin = 0, totalLoss = 0;
    let bestDay = 0, worstDay = 0;
    let streak = 0, currentStreakDir = null;

    for (let i = 1; i < last30.length; i++) {
        const change = parseFloat(last30[i].Close) - parseFloat(last30[i - 1].Close);
        const changeDollar = change;

        if (change > 0) {
            wins++;
            totalWin += changeDollar;
            if (changeDollar > bestDay) bestDay = changeDollar;
            if (currentStreakDir === 'win') streak++;
            else { streak = 1; currentStreakDir = 'win'; }
        } else if (change < 0) {
            losses++;
            totalLoss += Math.abs(changeDollar);
            if (changeDollar < worstDay) worstDay = changeDollar;
            if (currentStreakDir === 'loss') streak++;
            else { streak = 1; currentStreakDir = 'loss'; }
        }
    }

    const totalTrades = wins + losses;
    const winRate = totalTrades > 0 ? ((wins / totalTrades) * 100).toFixed(0) : 0;
    const avgWin = wins > 0 ? (totalWin / wins).toFixed(2) : 0;
    const avgLoss = losses > 0 ? (totalLoss / losses).toFixed(2) : 0;

    // Update dynamic title with symbol name
    const symbolName = symbolNames[currentSymbol] || currentSymbol;
    const titleEl = document.getElementById('statsTitle');
    if (titleEl) {
        titleEl.textContent = `${currentSymbol} - ${symbolName}  Trade Statistics (Last 30 Days)`;
    }

    document.getElementById('statsWinRate').textContent = winRate + '%';
    document.getElementById('statsAvgWin').textContent = '$' + avgWin;
    document.getElementById('statsAvgLoss').textContent = '$' + avgLoss;
    document.getElementById('statsTotalTrades').textContent = totalTrades;
    document.getElementById('statsBestDay').textContent = '+$' + bestDay.toFixed(2);
    document.getElementById('statsWorstDay').textContent = '$' + worstDay.toFixed(2);
    document.getElementById('statsStreak').textContent = streak + ' ' + (currentStreakDir === 'win' ? '' : '');
}

// Market Events Calendar Data
const marketEvents = {
    '2025-12-06': ' Jobs Report',
    '2025-12-11': ' CPI',
    '2025-12-17': ' FOMC Decision',
    '2025-12-18': ' FOMC',
    '2025-12-20': ' OpEx (Monthly)',
    '2025-12-24': ' Early Close',
    '2025-12-25': ' Market Closed',
    '2025-12-31': ' NYE Early Close',
    '2026-01-01': ' Market Closed',
    '2026-01-03': ' Jobs Report',
    '2026-01-10': ' CPI',
    '2026-01-15': ' OpEx (Monthly)',
    '2026-01-20': ' MLK Day Closed',
    '2026-01-29': ' FOMC',
    '2026-02-07': ' Jobs Report',
    '2026-02-12': ' CPI',
    '2026-02-21': ' OpEx (Monthly)',
    '2026-03-07': ' Jobs Report',
    '2026-03-12': ' CPI',
    '2026-03-18': ' FOMC',
    '2026-03-21': ' OpEx (Monthly)'
};

// Detect candle type
function detectCandleType(open, high, low, close) {
    const body = Math.abs(close - open);
    const range = high - low;
    const upperWick = high - Math.max(open, close);
    const lowerWick = Math.min(open, close) - low;

    if (range === 0) return { type: 'Doji', icon: '', color: '#f59e0b' };

    const bodyRatio = body / range;
    const upperWickRatio = upperWick / range;
    const lowerWickRatio = lowerWick / range;

    // Doji - small body, long wicks
    if (bodyRatio < 0.1) {
        return { type: 'Doji', icon: '', color: '#f59e0b' };
    }

    // Hammer - small body at top, long lower wick (bullish reversal)
    if (lowerWickRatio > 0.6 && upperWickRatio < 0.1 && bodyRatio < 0.3) {
        return { type: 'Hammer', icon: '', color: '#22c55e' };
    }

    // Shooting Star - small body at bottom, long upper wick (bearish reversal)
    if (upperWickRatio > 0.6 && lowerWickRatio < 0.1 && bodyRatio < 0.3) {
        return { type: 'Star', icon: '', color: '#ef4444' };
    }

    // Strong candles - big body, small wicks
    if (bodyRatio > 0.7) {
        if (close > open) {
            return { type: 'Strong Bull', icon: '', color: '#22c55e' };
        } else {
            return { type: 'Strong Bear', icon: '', color: '#ef4444' };
        }
    }

    // Regular candles
    if (close > open) {
        return { type: 'Bullish', icon: '', color: '#22c55e' };
    } else {
        return { type: 'Bearish', icon: '', color: '#ef4444' };
    }
}

// Update Upcoming Events Widget
function updateUpcomingEventsWidget() {
    const widget = document.getElementById('upcomingEventsWidget');
    if (!widget) return;

    const today = new Date();
    const next7Days = [];

    for (let i = 0; i < 7; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(today.getDate() + i);
        const dateStr = checkDate.toISOString().split('T')[0];
        const dayName = checkDate.toLocaleDateString('en-US', { weekday: 'short' });
        const dateDisplay = checkDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        if (marketEvents[dateStr]) {
            next7Days.push({
                date: dateDisplay,
                day: dayName,
                event: marketEvents[dateStr],
                daysAway: i
            });
        }
    }

    if (next7Days.length === 0) {
        widget.innerHTML = '<div style="color: var(--muted); font-size: 11px;">No major events in next 7 days</div>';
        return;
    }

    widget.innerHTML = next7Days.map(e => `
        <div style="background: ${e.daysAway === 0 ? 'rgba(239,68,68,0.2)' : 'rgba(255,255,255,0.5)'};
                    border: 1px solid ${e.daysAway === 0 ? '#ef4444' : 'rgba(245,158,11,0.3)'};
                    border-radius: 6px; padding: 8px 12px; text-align: center;">
            <div style="font-size: 9px; color: var(--muted);">${e.day} ${e.date}</div>
            <div style="font-size: 11px; font-weight: 600; ${e.daysAway === 0 ? 'color: #ef4444;' : ''}">${e.event}</div>
            <div style="font-size: 9px; color: ${e.daysAway <= 1 ? '#f59e0b' : 'var(--muted)'};">
                ${e.daysAway === 0 ? ' TODAY' : e.daysAway === 1 ? 'Tomorrow' : `In ${e.daysAway} days`}
            </div>
        </div>
    `).join('');
}

// Update Pattern Detection Summary
function updatePatternDetectionSummary() {
    if (!currentData || currentData.length < 14) return;

    const summary = document.getElementById('patternDetectionSummary');
    if (!summary) return;

    const last14 = currentData.slice(-14);
    let hammers = 0, shootingStars = 0, dojis = 0, strongBull = 0, strongBear = 0;
    let hhhl = 0, lhll = 0;

    // Count patterns and trends
    for (let i = 1; i < last14.length; i++) {
        const bar = last14[i];
        const prevBar = last14[i - 1];
        const open = parseFloat(bar.Open) || 0;
        const high = parseFloat(bar.High) || 0;
        const low = parseFloat(bar.Low) || 0;
        const close = parseFloat(bar.Close) || 0;

        const candle = detectCandleType(open, high, low, close);
        if (candle.type === 'Hammer') hammers++;
        if (candle.type === 'Star') shootingStars++;
        if (candle.type === 'Doji') dojis++;
        if (candle.type === 'Strong Bull') strongBull++;
        if (candle.type === 'Strong Bear') strongBear++;

        // Trend analysis
        const prevHigh = parseFloat(prevBar.High) || 0;
        const prevLow = parseFloat(prevBar.Low) || 0;
        if (high > prevHigh && low > prevLow) hhhl++;
        if (high < prevHigh && low < prevLow) lhll++;
    }

    // Volume trend analysis
    const vol5 = last14.slice(-5).reduce((s, d) => s + (parseInt(d.Volume) || 0), 0) / 5;
    const vol14 = last14.reduce((s, d) => s + (parseInt(d.Volume) || 0), 0) / 14;
    const volTrend = vol5 > vol14 * 1.1 ? 'Increasing ' : vol5 < vol14 * 0.9 ? 'Declining ' : 'Stable ';

    // Determine overall trend
    let trendStatus = ' Consolidation';
    let trendColor = '#f59e0b';
    if (hhhl >= 5) { trendStatus = ' Uptrend (HH/HL)'; trendColor = '#22c55e'; }
    else if (lhll >= 5) { trendStatus = ' Downtrend (LH/LL)'; trendColor = '#ef4444'; }

    // Conclusion
    let conclusion = '';
    if (hhhl >= 5 && vol5 < vol14 * 0.9) {
        conclusion = ' Uptrend intact but momentum weakening';
    } else if (hhhl >= 5 && vol5 > vol14) {
        conclusion = ' Strong uptrend with volume confirmation';
    } else if (lhll >= 5 && vol5 < vol14 * 0.9) {
        conclusion = ' Downtrend but selling pressure decreasing';
    } else if (lhll >= 5) {
        conclusion = ' Downtrend with selling pressure';
    } else {
        conclusion = ' No clear trend - wait for breakout';
    }

    summary.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
            <div>
                <div style="color: #22c55e; font-weight: 600; margin-bottom: 4px;">Bullish Patterns:</div>
                <div style="color: var(--muted);"> ${hammers} Hammers,  ${strongBull} Strong Bull</div>
            </div>
            <div>
                <div style="color: #ef4444; font-weight: 600; margin-bottom: 4px;">Bearish Patterns:</div>
                <div style="color: var(--muted);"> ${shootingStars} Shooting Stars,  ${strongBear} Strong Bear</div>
            </div>
            <div>
                <div style="color: #f59e0b; font-weight: 600; margin-bottom: 4px;">Neutral Patterns:</div>
                <div style="color: var(--muted);"> ${dojis} Dojis (Indecision)</div>
            </div>
            <div>
                <div style="font-weight: 600; margin-bottom: 4px;">Volume Trend:</div>
                <div style="color: var(--muted);">${volTrend}</div>
            </div>
        </div>
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                <div><strong>Current Trend:</strong> <span style="color: ${trendColor}; font-weight: 600;">${trendStatus}</span></div>
                <div><strong>HH/HL Days:</strong> ${hhhl} | <strong>LH/LL Days:</strong> ${lhll}</div>
            </div>
            <div style="margin-top: 8px; padding: 8px; background: rgba(139,92,246,0.1); border-radius: 6px;">
                <strong> Conclusion:</strong> ${conclusion}
            </div>
        </div>
    `;
}

// Update Historical Data Table with all new columns
function updateHistoricalDataTable() {
    if (!currentData || currentData.length < 10) return;

    const tbody = document.getElementById('historicalDataTable');
    const summaryEl = document.getElementById('historicalSummary');
    if (!tbody) return;

    // Calculate 20-day average volume
    const avgVol20 = currentData.slice(-20).reduce((s, d) => s + (parseInt(d.Volume) || 0), 0) / 20;

    const last10 = currentData.slice(-10).reverse();
    let html = '';

    // Summary counters
    let gapUps = 0, gapDowns = 0, hhhlCount = 0, lhllCount = 0, highVolDays = 0, lowVolDays = 0;
    let nextEventDays = null, nextEventName = '';

    // Find next event
    const today = new Date();
    for (let i = 0; i < 14; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(today.getDate() + i);
        const dateStr = checkDate.toISOString().split('T')[0];
        if (marketEvents[dateStr]) {
            nextEventDays = i;
            nextEventName = marketEvents[dateStr];
            break;
        }
    }

    last10.forEach((bar, index) => {
        const date = bar.Date || bar.date || '--';
        const dateKey = new Date(date).toISOString().split('T')[0];
        const open = parseFloat(bar.Open) || 0;
        const high = parseFloat(bar.High) || 0;
        const low = parseFloat(bar.Low) || 0;
        const close = parseFloat(bar.Close) || 0;
        const volume = parseInt(bar.Volume) || 0;

        // Get previous bar data (remember: array is reversed)
        const prevBar = last10[index + 1];
        const prevClose = prevBar ? parseFloat(prevBar.Close) || close : close;
        const prevHigh = prevBar ? parseFloat(prevBar.High) || high : high;
        const prevLow = prevBar ? parseFloat(prevBar.Low) || low : low;

        // Change calculation
        const change = close - prevClose;
        const changePct = prevClose > 0 ? ((change / prevClose) * 100).toFixed(2) : 0;

        // GAP calculation
        const gap = open - prevClose;
        const gapPct = prevClose > 0 ? ((gap / prevClose) * 100).toFixed(2) : 0;
        let gapDisplay = '', gapColor = '';
        if (Math.abs(parseFloat(gapPct)) >= 0.5) {
            if (gap > 0) { gapDisplay = ` +$${gap.toFixed(2)}`; gapColor = '#22c55e'; gapUps++; }
            else { gapDisplay = ` $${gap.toFixed(2)}`; gapColor = '#ef4444'; gapDowns++; }
        } else {
            gapDisplay = ` $${gap.toFixed(2)}`; gapColor = 'var(--muted)';
        }

        // Candle Type
        const candle = detectCandleType(open, high, low, close);

        // Trend Signal (HH/HL or LH/LL)
        let trendSignal = '', trendColor = '';
        if (prevBar) {
            const higherHigh = high > prevHigh;
            const higherLow = low > prevLow;
            const lowerHigh = high < prevHigh;
            const lowerLow = low < prevLow;

            if (higherHigh && higherLow) {
                trendSignal = ' HH/HL'; trendColor = '#22c55e'; hhhlCount++;
            } else if (lowerHigh && lowerLow) {
                trendSignal = ' LH/LL'; trendColor = '#ef4444'; lhllCount++;
            } else {
                trendSignal = ' Mixed'; trendColor = '#f59e0b';
            }
        } else {
            trendSignal = '--'; trendColor = 'var(--muted)';
        }

        // Close Position (where did price close in day's range)
        const range = high - low;
        const closePos = range > 0 ? ((close - low) / range * 100).toFixed(0) : 50;
        let closePosDisplay = '', closePosColor = '';
        if (parseInt(closePos) >= 75) {
            closePosDisplay = ' Upper'; closePosColor = '#22c55e';
        } else if (parseInt(closePos) <= 25) {
            closePosDisplay = ' Lower'; closePosColor = '#ef4444';
        } else {
            closePosDisplay = ' Mid'; closePosColor = 'var(--muted)';
        }

        // Volume Signal
        const volRatio = avgVol20 > 0 ? ((volume / avgVol20) * 100).toFixed(0) : 100;
        let volDisplay = '', volColor = '';
        if (parseInt(volRatio) >= 150) {
            volDisplay = ` +${volRatio - 100}%`; volColor = '#22c55e'; highVolDays++;
        } else if (parseInt(volRatio) <= 70) {
            volDisplay = ` ${volRatio - 100}%`; volColor = '#ef4444'; lowVolDays++;
        } else {
            volDisplay = ' Norm'; volColor = 'var(--muted)';
        }

        // OH Signal
        const openToLow = open - low;
        const openToHigh = high - open;
        const ohSignal = openToLow < openToHigh ? '' : '';
        const ohColor = openToLow < openToHigh ? '#22c55e' : '#ef4444';

        // Events
        const event = marketEvents[dateKey] || '-';

        // Row background color
        let rowBg = '';
        if (event !== '-') rowBg = 'background: rgba(245,158,11,0.1);';
        else if (parseInt(volRatio) >= 150) rowBg = 'background: rgba(59,130,246,0.1);';
        else if (candle.type === 'Hammer' || candle.type === 'Star') rowBg = 'background: rgba(249,115,22,0.1);';

        const dateFormatted = new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const changeColor = change >= 0 ? '#22c55e' : '#ef4444';
        const changeSign = change >= 0 ? '+' : '';

        html += `
            <tr style="${rowBg}">
                <td style="font-weight: 600;">${dateFormatted}</td>
                <td style="font-size: 9px;">$${open.toFixed(0)}/${high.toFixed(0)}/${low.toFixed(0)}/<span style="font-weight:600;">$${close.toFixed(2)}</span></td>
                <td style="color: ${changeColor}; font-weight: 600;">${changeSign}${changePct}%</td>
                <td style="color: ${gapColor};">${gapDisplay}</td>
                <td style="color: ${candle.color};">${candle.icon} ${candle.type}</td>
                <td style="color: ${trendColor};">${trendSignal}</td>
                <td style="color: ${closePosColor};">${closePosDisplay}</td>
                <td style="color: ${volColor};">${volDisplay}</td>
                <td style="color: ${ohColor};">${ohSignal}</td>
                <td style="font-size: 9px;">${event}</td>
            </tr>
        `;
    });

    tbody.innerHTML = html;

    // Update summary row
    if (summaryEl) {
        const trendDesc = hhhlCount > lhllCount + 2 ? ' Uptrend Confirmed' :
                          lhllCount > hhhlCount + 2 ? ' Downtrend Confirmed' : ' Consolidation';
        const volDesc = highVolDays > 3 ? ' High Volume' :
                        lowVolDays > 5 ? ' Low Volume ( Weak)' : ' Normal Volume';

        let nextEventHtml = '';
        if (nextEventDays !== null) {
            nextEventHtml = `<div><strong>Next Event:</strong> ${nextEventName} in ${nextEventDays} day${nextEventDays !== 1 ? 's' : ''}</div>`;
        }

        summaryEl.innerHTML = `
            <div><strong>Gaps:</strong> ${gapUps} Up, ${gapDowns} Down</div>
            <div><strong>Trend:</strong> ${hhhlCount} HH/HL, ${lhllCount} LH/LL  ${trendDesc}</div>
            <div><strong>Volume:</strong> ${volDesc}</div>
            ${nextEventHtml}
        `;
    }

    // Also update related widgets
    updateUpcomingEventsWidget();
    updatePatternDetectionSummary();
}

// Update Overview Reference Data
function updateOverviewReferenceData() {
    if (!currentData || currentData.length < 2) return;

    const lastBar = currentData[currentData.length - 1];
    const prevBar = currentData[currentData.length - 2];

    // Today Open
    const openEl = document.getElementById('todayOpen');
    if (openEl) openEl.textContent = '$' + (parseFloat(lastBar.Open) || 0).toFixed(2);

    // Prev Close
    const prevCloseEl = document.getElementById('prevClose');
    if (prevCloseEl) prevCloseEl.textContent = '$' + (parseFloat(prevBar.Close) || 0).toFixed(2);
}

// Master Overview Update Function
function updateOverviewTab() {
    updateFibonacciZoneDisplay();
    updateMultiTimeframeTrends();
    updateGannQuickView();
    updateTradeStatistics();
    updateHistoricalDataTable();
    updateOverviewReferenceData();
}

// Load Overview data directly from CSV
async function loadOverviewData() {
    const symbol = document.querySelector('#symbolSelect')?.value || 'SPY';

    try {
        // Try data folder first, then root
        let response = await fetch('data/' + symbol + '.csv').catch(() => null);
        if (!response?.ok) {
            response = await fetch(symbol + '.csv').catch(() => null);
        }

        if (!response?.ok) {
            console.log('Could not load ' + symbol + '.csv');
            return;
        }

        const text = await response.text();
        const lines = text.trim().split('\n');

        if (lines.length < 2) return;

        // Parse header to get column indices
        const header = lines[0].split(',');
        const getIndex = (name) => header.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));

        // Get last row (most recent data)
        const lastLine = lines[lines.length - 1];
        const cols = lastLine.split(',');

        // Get previous row for change calculation
        const prevLine = lines.length > 2 ? lines[lines.length - 2] : lastLine;
        const prevCols = prevLine.split(',');

        // Extract values using header or fallback positions
        const close = parseFloat(cols[getIndex('close')] || cols[4]) || 0;
        const open = parseFloat(cols[getIndex('open')] || cols[1]) || 0;
        const high = parseFloat(cols[getIndex('high')] || cols[2]) || 0;
        const low = parseFloat(cols[getIndex('low')] || cols[3]) || 0;
        const volume = parseFloat(cols[getIndex('volume')] || cols[5]) || 0;
        const atr = parseFloat(cols[getIndex('atr')] || cols[6]) || 0;
        const prevClose = parseFloat(prevCols[getIndex('close')] || prevCols[4]) || close;

        // Calculate change
        const change = close - prevClose;
        const changePct = prevClose ? ((change / prevClose) * 100) : 0;

        // Update Price metric
        const priceEl = document.getElementById('currentPrice');
        if (priceEl) priceEl.textContent = '$' + close.toFixed(2);

        // Update Change
        const changeEl = document.getElementById('dailyChange');
        if (changeEl) {
            changeEl.textContent = (change >= 0 ? '+' : '') + '$' + Math.abs(change).toFixed(2);
            changeEl.className = 'metric-value ' + (change >= 0 ? 'positive' : 'negative');
        }

        const changePctEl = document.getElementById('changePct');
        if (changePctEl) changePctEl.textContent = (changePct >= 0 ? '+' : '') + changePct.toFixed(2) + '%';

        // Update Volume
        const volEl = document.getElementById('volumeDisplay');
        if (volEl) volEl.textContent = (volume / 1000000).toFixed(1) + 'M';

        // Update ATR
        const atrEl = document.getElementById('atrDisplay');
        if (atrEl) atrEl.textContent = '$' + atr.toFixed(2);

        // Calculate Fibonacci levels based on recent high/low
        let recentHigh = high;
        let recentLow = low;

        // Get high/low from last 20 bars
        for (let i = Math.max(1, lines.length - 20); i < lines.length; i++) {
            const rowCols = lines[i].split(',');
            const h = parseFloat(rowCols[getIndex('high')] || rowCols[2]) || 0;
            const l = parseFloat(rowCols[getIndex('low')] || rowCols[3]) || 0;
            if (h > recentHigh) recentHigh = h;
            if (l < recentLow || recentLow === 0) recentLow = l;
        }

        const range = recentHigh - recentLow;

        // Fibonacci levels
        const fib382 = recentHigh - (range * 0.382);
        const fib500 = recentHigh - (range * 0.500);
        const fib618 = recentHigh - (range * 0.618);
        const fib100 = recentHigh;
        const fib1272 = recentLow + (range * 1.272);
        const fib1618 = recentLow + (range * 1.618);

        // Update Fibonacci Price Zones
        const fibS1 = document.getElementById('fibS1');
        const fibS2 = document.getElementById('fibS2');
        const fibS3 = document.getElementById('fibS3');
        const fibR1 = document.getElementById('fibR1');
        const fibR2 = document.getElementById('fibR2');
        const fibR3 = document.getElementById('fibR3');
        const fibCurrentPrice = document.getElementById('fibCurrentPrice');

        if (fibS1) fibS1.textContent = '$' + fib382.toFixed(2);
        if (fibS2) fibS2.textContent = '$' + fib500.toFixed(2);
        if (fibS3) fibS3.textContent = '$' + fib618.toFixed(2);
        if (fibR1) fibR1.textContent = '$' + fib100.toFixed(2);
        if (fibR2) fibR2.textContent = '$' + fib1272.toFixed(2);
        if (fibR3) fibR3.textContent = '$' + fib1618.toFixed(2);
        if (fibCurrentPrice) fibCurrentPrice.textContent = '$' + close.toFixed(2);

        // Calculate 52-week high/low from all data (up to 252 bars)
        let high52w = 0;
        let low52w = Infinity;
        const barsFor52w = Math.min(lines.length - 1, 252);

        for (let i = lines.length - barsFor52w; i < lines.length; i++) {
            if (i < 1) continue;
            const rowCols = lines[i].split(',');
            const h = parseFloat(rowCols[getIndex('high')] || rowCols[2]) || 0;
            const l = parseFloat(rowCols[getIndex('low')] || rowCols[3]) || 0;
            if (h > high52w) high52w = h;
            if (l < low52w && l > 0) low52w = l;
        }

        if (low52w === Infinity) low52w = low;

        // Update Reference Data
        const week52HighEl = document.getElementById('week52High');
        const week52LowEl = document.getElementById('week52Low');
        const todayHighEl = document.getElementById('todayHigh');
        const todayLowEl = document.getElementById('todayLow');
        const todayOpenEl = document.getElementById('todayOpen');
        const prevCloseEl = document.getElementById('prevClose');

        if (week52HighEl) week52HighEl.textContent = '$' + high52w.toFixed(2);
        if (week52LowEl) week52LowEl.textContent = '$' + low52w.toFixed(2);
        if (todayHighEl) todayHighEl.textContent = '$' + high.toFixed(2);
        if (todayLowEl) todayLowEl.textContent = '$' + low.toFixed(2);
        if (todayOpenEl) todayOpenEl.textContent = '$' + open.toFixed(2);
        if (prevCloseEl) prevCloseEl.textContent = '$' + prevClose.toFixed(2);

        // Calculate average volume (last 20 bars)
        let totalVolume = 0;
        const volBars = Math.min(lines.length - 1, 20);
        for (let i = lines.length - volBars; i < lines.length; i++) {
            if (i < 1) continue;
            const rowCols = lines[i].split(',');
            totalVolume += parseFloat(rowCols[getIndex('volume')] || rowCols[5]) || 0;
        }
        const avgVol = totalVolume / volBars;

        const avgVolEl = document.getElementById('avgVolume20');
        const volVsAvgEl = document.getElementById('volumeVsAvg');
        const volVsAvgSmallEl = document.getElementById('volumeVsAvgSmall');

        if (avgVolEl) avgVolEl.textContent = (avgVol / 1e6).toFixed(1) + 'M';
        if (volVsAvgEl) volVsAvgEl.textContent = ((volume / avgVol - 1) * 100).toFixed(0) + '%';
        if (volVsAvgSmallEl) volVsAvgSmallEl.textContent = ((volume / avgVol - 1) * 100).toFixed(0) + '% vs avg';

        console.log('Overview data loaded for ' + symbol);

    } catch (error) {
        console.log('Error loading overview data:', error);
    }
}

function generateDailyReport() {
    console.log('Generating daily report...', currentAnalysisMode);
    
    if (!currentData || currentData.length === 0) {
        console.warn('No data available for analysis');
        return;
    }
    
    // Get current symbol data
    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close) || 0;
    const prevClose = parseFloat(currentData[currentData.length - 2]?.Close) || price;
    
    // Calculate all signal components
    const signals = calculateAllSignals(currentData, price, prevClose);
    
    // Update the UI
    updateConfluenceScore(signals);
    updateTradeRecommendations(signals);
    updateGannAnalysis(price);
    updateFibonacciLevels(currentData);
    updateHighConsensusTrades(signals);
    updateMarketContext(signals);
    updateAISummary(signals, price);
    updatePlanDateTime();
    
    // Store for download
    dailyAnalysisData = {
        mode: currentAnalysisMode,
        timestamp: new Date().toISOString(),
        symbol: currentSymbol,
        price: price,
        signals: signals
    };

    // Update analysis timestamp
    updateSectionTimestamp('analysis');
}

function calculateAllSignals(data, price, prevClose) {
    const signals = {
        agentConsensus: { score: 0, detail: '', count: 0, agentDetails: null, isReal: false },
        barCount: { score: 0, detail: '', count: 0 },
        patterns: { score: 0, detail: '', found: [] },
        gann: { score: 0, detail: '' },
        fibonacci: { score: 0, detail: '', level: '' },
        volume: { score: 0, detail: '' },
        masterScore: 0,
        direction: 'NEUTRAL',
        confidence: 50
    };
    
    // 1. Agent Consensus Score (with individual agent breakdown)
    const agentSignals = getAgentSignals();
    signals.agentConsensus.count = agentSignals.agreeing;
    signals.agentConsensus.score = (agentSignals.agreeing / 4) * 4; // Max 4 points
    signals.agentConsensus.signal = agentSignals.signal;
    signals.agentConsensus.isReal = agentSignals.isReal;
    signals.agentConsensus.agentDetails = agentSignals.agentDetails;
    signals.agentConsensus.timestamp = agentSignals.timestamp;
    signals.agentConsensus.detail = `${agentSignals.agreeing}/4 agents: ${agentSignals.signal}${agentSignals.isReal ? ' (LIVE)' : ' (calc)'}`;
    
    // 2. Bar Count Score
    const barCount = calculateBarCountSignal(data);
    signals.barCount.count = barCount.count;
    signals.barCount.score = Math.min(Math.abs(barCount.count) / 5, 2) * (barCount.count > 0 ? 1 : -1); // Max 2
    signals.barCount.detail = `${barCount.count > 0 ? '+' : ''}${barCount.count} consecutive ${barCount.direction} bars`;
    
    // 3. Pattern Score
    const patterns = detectAllPatterns(data);
    signals.patterns.found = patterns.found;
    signals.patterns.score = patterns.score; // Max 3
    signals.patterns.detail = patterns.found.length > 0 ? patterns.found.join(', ') : 'No patterns detected';
    
    // 4. Gann Cycle Score
    const gann = calculateGannCycleScore(data, price);
    signals.gann.score = gann.score; // Max 2
    signals.gann.detail = gann.detail;
    
    // 5. Fibonacci Score
    const fib = calculateFibonacciScore(data, price);
    signals.fibonacci.score = fib.score; // Max 2
    signals.fibonacci.detail = fib.detail;
    signals.fibonacci.level = fib.level;
    
    // 6. Volume Score
    const volume = calculateVolumeScore(data);
    signals.volume.score = volume.score; // Max 1.5
    signals.volume.detail = volume.detail;
    
    // Calculate Master Score
    signals.masterScore = (
        signals.agentConsensus.score +
        signals.barCount.score +
        signals.patterns.score +
        signals.gann.score +
        signals.fibonacci.score +
        signals.volume.score
    );
    
    // Determine direction and confidence
    if (signals.masterScore >= 3) {
        signals.direction = 'BULLISH';
        signals.confidence = Math.min(50 + signals.masterScore * 5, 95);
    } else if (signals.masterScore <= -3) {
        signals.direction = 'BEARISH';
        signals.confidence = Math.min(50 + Math.abs(signals.masterScore) * 5, 95);
    } else {
        signals.direction = 'NEUTRAL';
        signals.confidence = 50 + Math.abs(signals.masterScore) * 3;
    }
    
    return signals;
}

// Real agent voting data (loaded from voting_log.json)
let realAgentVotes = null;

async function loadRealAgentSignals() {
    try {
        const response = await fetch('voting_log.json');
        if (response.ok) {
            const data = await response.json();
            realAgentVotes = data;
            console.log(' Loaded real agent signals from voting_log.json');
            return true;
        }
    } catch (e) {
        console.log(' voting_log.json not available, using calculated signals');
    }
    return false;
}

function getAgentSignals() {
    // Try to get REAL signals from voting_log.json first
    if (realAgentVotes && realAgentVotes.votes && realAgentVotes.votes.length > 0) {
        const latestVote = realAgentVotes.votes[realAgentVotes.votes.length - 1];
        
        // Parse individual agent signals
        const agentDetails = {
            base: { signal: 'HOLD', confidence: 0 },
            gann: { signal: 'HOLD', confidence: 0 },
            dqn: { signal: 'HOLD', confidence: 0 },
            wave: { signal: 'HOLD', confidence: 0 }
        };
        
        let callCount = 0, putCount = 0, holdCount = 0;
        
        if (latestVote.component_signals) {
            latestVote.component_signals.forEach(sig => {
                const agentName = sig.agent?.toLowerCase() || '';
                const signal = sig.signal?.toUpperCase() || 'HOLD';
                const confidence = sig.confidence || 0;
                
                if (agentName.includes('base') || agentName.includes('confluence')) {
                    agentDetails.base = { signal, confidence };
                } else if (agentName.includes('gann') || agentName.includes('elliott')) {
                    agentDetails.gann = { signal, confidence };
                } else if (agentName.includes('dqn') || agentName.includes('ml')) {
                    agentDetails.dqn = { signal, confidence };
                } else if (agentName.includes('wave') || agentName.includes('3')) {
                    agentDetails.wave = { signal, confidence };
                }
                
                if (signal === 'CALL') callCount++;
                else if (signal === 'PUT') putCount++;
                else holdCount++;
            });
        }
        
        const finalSignal = latestVote.final_signal?.toUpperCase() || 'HOLD';
        const agreementLevel = latestVote.agreement_level || Math.max(callCount, putCount, holdCount);
        
        return { 
            signal: finalSignal, 
            agreeing: agreementLevel, 
            callCount, 
            putCount, 
            holdCount,
            isReal: true,
            agentDetails,
            timestamp: latestVote.timestamp
        };
    }
    
    // FALLBACK: Calculate signals from price data if voting_log.json not available
    let callCount = 0, putCount = 0, holdCount = 0;
    const agentDetails = {
        base: { signal: 'HOLD', confidence: 50 },
        gann: { signal: 'HOLD', confidence: 50 },
        dqn: { signal: 'HOLD', confidence: 50 },
        wave: { signal: 'HOLD', confidence: 50 }
    };
    
    const lastBars = currentData.slice(-5);
    const trend = lastBars[lastBars.length - 1]?.Close > lastBars[0]?.Close;
    const momentum = calculateMomentum(currentData);
    
    // Base Confluence Agent
    if (trend && momentum > 0) {
        callCount++;
        agentDetails.base = { signal: 'CALL', confidence: 60 + momentum * 20 };
    } else if (!trend && momentum < 0) {
        putCount++;
        agentDetails.base = { signal: 'PUT', confidence: 60 + Math.abs(momentum) * 20 };
    } else {
        holdCount++;
        agentDetails.base = { signal: 'HOLD', confidence: 50 };
    }
    
    // Gann-Elliott Agent
    if (trend) {
        callCount++;
        agentDetails.gann = { signal: 'CALL', confidence: 65 };
    } else {
        putCount++;
        agentDetails.gann = { signal: 'PUT', confidence: 65 };
    }
    
    // DQN Agent
    if (momentum > 0.5) {
        callCount++;
        agentDetails.dqn = { signal: 'CALL', confidence: 70 + momentum * 15 };
    } else if (momentum < -0.5) {
        putCount++;
        agentDetails.dqn = { signal: 'PUT', confidence: 70 + Math.abs(momentum) * 15 };
    } else {
        holdCount++;
        agentDetails.dqn = { signal: 'HOLD', confidence: 50 };
    }
    
    // 3-Wave Agent
    if (trend) {
        callCount++;
        agentDetails.wave = { signal: 'CALL', confidence: 60 };
    } else {
        putCount++;
        agentDetails.wave = { signal: 'PUT', confidence: 60 };
    }
    
    const maxCount = Math.max(callCount, putCount, holdCount);
    let signal = 'HOLD';
    let agreeing = holdCount;
    
    if (callCount === maxCount && callCount > putCount) {
        signal = 'CALL';
        agreeing = callCount;
    } else if (putCount === maxCount) {
        signal = 'PUT';
        agreeing = putCount;
    }
    
    return { 
        signal, 
        agreeing, 
        callCount, 
        putCount, 
        holdCount,
        isReal: false,
        agentDetails,
        timestamp: null
    };
}

function calculateMomentum(data) {
    if (data.length < 14) return 0;
    const recent = data.slice(-14);
    const gains = [], losses = [];
    
    for (let i = 1; i < recent.length; i++) {
        const change = parseFloat(recent[i].Close) - parseFloat(recent[i-1].Close);
        if (change > 0) gains.push(change);
        else losses.push(Math.abs(change));
    }
    
    const avgGain = gains.length > 0 ? gains.reduce((a,b) => a+b, 0) / 14 : 0;
    const avgLoss = losses.length > 0 ? losses.reduce((a,b) => a+b, 0) / 14 : 0;
    
    if (avgLoss === 0) return 1;
    const rs = avgGain / avgLoss;
    const rsi = 100 - (100 / (1 + rs));
    
    return (rsi - 50) / 50; // Normalize to -1 to 1
}

function calculateBarCountSignal(data) {
    if (data.length < 2) return { count: 0, direction: 'neutral' };
    
    let count = 0;
    let direction = 'neutral';
    
    // Count consecutive bars in same direction
    for (let i = data.length - 1; i > 0; i--) {
        const curr = parseFloat(data[i].Close);
        const prev = parseFloat(data[i-1].Close);
        
        if (curr > prev) {
            if (direction === 'neutral' || direction === 'bullish') {
                direction = 'bullish';
                count++;
            } else break;
        } else if (curr < prev) {
            if (direction === 'neutral' || direction === 'bearish') {
                direction = 'bearish';
                count--;
            } else break;
        } else break;
    }
    
    return { count, direction };
}

function detectAllPatterns(data) {
    const found = [];
    let score = 0;
    
    if (data.length < 20) return { found, score };
    
    const recent = data.slice(-20);
    const closes = recent.map(d => parseFloat(d.Close));
    const highs = recent.map(d => parseFloat(d.High));
    const lows = recent.map(d => parseFloat(d.Low));
    
    // Bull Flag
    const highestHigh = Math.max(...highs.slice(0, 10));
    const recentHigh = Math.max(...highs.slice(-5));
    const recentLow = Math.min(...lows.slice(-5));
    
    if (recentHigh < highestHigh * 0.98 && recentLow > highestHigh * 0.95) {
        found.push('Bull Flag');
        score += 1.5;
    }
    
    // Bear Flag
    const lowestLow = Math.min(...lows.slice(0, 10));
    if (recentLow > lowestLow * 1.02 && recentHigh < lowestLow * 1.05) {
        found.push('Bear Flag');
        score -= 1.5;
    }
    
    // Golden Cross (9 SMA > 21 SMA)
    const sma9 = closes.slice(-9).reduce((a,b) => a+b, 0) / 9;
    const sma21 = closes.slice(-21).reduce((a,b) => a+b, 0) / 21;
    
    if (sma9 > sma21) {
        found.push('Golden Cross');
        score += 1;
    } else {
        found.push('Death Cross');
        score -= 1;
    }
    
    // Higher Highs / Lower Lows
    const recentHighs = highs.slice(-5);
    const recentLows = lows.slice(-5);
    
    let higherHighs = 0, lowerLows = 0;
    for (let i = 1; i < recentHighs.length; i++) {
        if (recentHighs[i] > recentHighs[i-1]) higherHighs++;
        if (recentLows[i] < recentLows[i-1]) lowerLows++;
    }
    
    if (higherHighs >= 3) {
        found.push('Higher Highs');
        score += 0.5;
    }
    if (lowerLows >= 3) {
        found.push('Lower Lows');
        score -= 0.5;
    }
    
    return { found, score: Math.max(-3, Math.min(3, score)) };
}

function calculateGannCycleScore(data, price) {
    const today = new Date();
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    
    // Gann believed in natural cycles
    const cycle30 = dayOfYear % 30;
    const cycle90 = dayOfYear % 90;
    const cycle180 = dayOfYear % 180;
    
    let score = 0;
    let details = [];
    
    // 30-day cycle
    if (cycle30 < 7) {
        details.push('30-day: Bottoming');
        score += 0.5;
    } else if (cycle30 > 23) {
        details.push('30-day: Topping');
        score -= 0.5;
    } else {
        details.push('30-day: Mid-cycle');
    }
    
    // 90-day cycle
    if (cycle90 < 20) {
        details.push('90-day: Accumulation');
        score += 0.5;
    } else if (cycle90 > 70) {
        details.push('90-day: Distribution');
        score -= 0.5;
    } else {
        details.push('90-day: Trend phase');
        score += 0.25;
    }
    
    // Seasonal (Q4 typically bullish)
    const month = today.getMonth();
    if (month >= 9) { // Oct-Dec
        details.push('Seasonal: Q4 bullish');
        score += 0.5;
    } else if (month >= 4 && month <= 6) { // May-Jul
        details.push('Seasonal: Summer lull');
        score -= 0.25;
    }
    
    return { score: Math.max(-2, Math.min(2, score)), detail: details.join('; ') };
}

function calculateFibonacciScore(data, price) {
    if (data.length < 50) return { score: 0, detail: 'Insufficient data', level: '' };
    
    const recent = data.slice(-50);
    const high = Math.max(...recent.map(d => parseFloat(d.High)));
    const low = Math.min(...recent.map(d => parseFloat(d.Low)));
    const range = high - low;
    
    // Calculate Fibonacci levels
    const levels = {
        '23.6%': high - range * 0.236,
        '38.2%': high - range * 0.382,
        '50%': high - range * 0.5,
        '61.8%': high - range * 0.618,
        '78.6%': high - range * 0.786
    };
    
    // Find nearest level
    let nearestLevel = '';
    let nearestDist = Infinity;
    
    for (const [name, levelPrice] of Object.entries(levels)) {
        const dist = Math.abs(price - levelPrice);
        if (dist < nearestDist) {
            nearestDist = dist;
            nearestLevel = name;
        }
    }
    
    let score = 0;
    let detail = '';
    
    // Score based on position relative to Fibonacci levels
    const pricePosition = (high - price) / range;
    
    if (pricePosition < 0.236) {
        score = 1.5; // Near highs - bullish continuation
        detail = 'Above 23.6% - Strong bullish';
    } else if (pricePosition < 0.382) {
        score = 1; // Shallow pullback
        detail = 'At 23.6-38.2% - Bullish pullback';
    } else if (pricePosition < 0.5) {
        score = 0.5; // Normal retracement
        detail = 'At 38.2-50% - Moderate support';
    } else if (pricePosition < 0.618) {
        score = 0; // Neutral
        detail = 'At 50-61.8% - Critical zone';
    } else if (pricePosition < 0.786) {
        score = -0.5; // Deep retracement
        detail = 'At 61.8-78.6% - Deep pullback';
    } else {
        score = -1.5; // Near lows - bearish
        detail = 'Below 78.6% - Bearish';
    }
    
    return { score, detail, level: nearestLevel };
}

function calculateVolumeScore(data) {
    if (data.length < 20) return { score: 0, detail: 'Insufficient data' };
    
    const volumes = data.slice(-20).map(d => parseFloat(d.Volume) || 0);
    const avgVolume = volumes.slice(0, -1).reduce((a,b) => a+b, 0) / 19;
    const todayVolume = volumes[volumes.length - 1];
    
    const volumeRatio = todayVolume / avgVolume;
    
    let score = 0;
    let detail = '';
    
    if (volumeRatio > 1.5) {
        score = 1.5;
        detail = `Volume ${(volumeRatio * 100).toFixed(0)}% of avg - High conviction`;
    } else if (volumeRatio > 1.2) {
        score = 1;
        detail = `Volume ${(volumeRatio * 100).toFixed(0)}% of avg - Above average`;
    } else if (volumeRatio > 0.8) {
        score = 0;
        detail = `Volume ${(volumeRatio * 100).toFixed(0)}% of avg - Normal`;
    } else {
        score = -0.5;
        detail = `Volume ${(volumeRatio * 100).toFixed(0)}% of avg - Low interest`;
    }
    
    return { score, detail };
}

function updateConfluenceScore(signals) {
    const scoreEl = document.getElementById('masterConfluenceScore');
    const directionEl = document.getElementById('confluenceDirection');
    const confidenceEl = document.getElementById('confluenceConfidence');
    const symbolEl = document.getElementById('confluenceSymbol');
    
    if (scoreEl) {
        scoreEl.textContent = (signals.masterScore > 0 ? '+' : '') + signals.masterScore.toFixed(1);
        scoreEl.className = 'confluence-score ' + (signals.masterScore > 0 ? 'bullish' : signals.masterScore < 0 ? 'bearish' : 'neutral');
    }
    
    if (directionEl) {
        directionEl.textContent = signals.direction + ' BIAS';
        directionEl.style.color = signals.direction === 'BULLISH' ? 'var(--success)' : 
                                  signals.direction === 'BEARISH' ? 'var(--danger)' : 'var(--muted)';
    }
    
    if (confidenceEl) confidenceEl.textContent = signals.confidence.toFixed(0) + '%';
    if (symbolEl) symbolEl.textContent = currentSymbol + ' Analysis';
    
    // Update individual signal scores
    updateSignalItem('agentScore', signals.agentConsensus.count + '/4', signals.agentConsensus.score > 0);
    updateSignalItem('agentDetail', signals.agentConsensus.detail);
    
    updateSignalItem('barCountScore', (signals.barCount.count > 0 ? '+' : '') + signals.barCount.count, signals.barCount.score > 0);
    updateSignalItem('barCountDetail', signals.barCount.detail);
    
    updateSignalItem('patternScore', (signals.patterns.score > 0 ? '+' : '') + signals.patterns.score.toFixed(1), signals.patterns.score > 0);
    updateSignalItem('patternDetail', signals.patterns.detail);
    
    updateSignalItem('gannScore', (signals.gann.score > 0 ? '+' : '') + signals.gann.score.toFixed(1), signals.gann.score > 0);
    updateSignalItem('gannDetail', signals.gann.detail);
    
    updateSignalItem('fibScore', (signals.fibonacci.score > 0 ? '+' : '') + signals.fibonacci.score.toFixed(1), signals.fibonacci.score > 0);
    updateSignalItem('fibDetail', signals.fibonacci.detail);
    
    updateSignalItem('volumeScore', (signals.volume.score > 0 ? '+' : '') + signals.volume.score.toFixed(1), signals.volume.score > 0);
    updateSignalItem('volumeDetail', signals.volume.detail);
}

function updateSignalItem(id, value, isBullish) {
    const el = document.getElementById(id);
    if (!el) return;
    
    if (id.includes('Score')) {
        el.textContent = value;
        el.className = 'signal-item-score ' + (isBullish ? 'bullish' : isBullish === false ? 'bearish' : 'neutral');
    } else {
        el.textContent = value;
    }
}

function updateTradeRecommendations(signals) {
    const container = document.getElementById('tradeRecommendations');
    if (!container) return;
    
    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close);
    const atr = parseFloat(lastBar.ATR) || price * 0.015;
    
    const signal = signals.direction === 'BULLISH' ? 'CALL' : signals.direction === 'BEARISH' ? 'PUT' : 'HOLD';
    
    // Calculate all price levels
    const entryLow = price - atr * 0.3;
    const entryHigh = price + atr * 0.1;
    const bestEntry = signal === 'CALL' ? entryLow : entryHigh;
    const stop05 = signal === 'CALL' ? price - atr * 0.5 : price + atr * 0.5;
    const stop10 = signal === 'CALL' ? price - atr * 1.0 : price + atr * 1.0;
    const target1 = signal === 'CALL' ? price + atr * 1.5 : price - atr * 1.5;
    const target2 = signal === 'CALL' ? price + atr * 2.5 : price - atr * 2.5;
    
    // Calculate optimal strike
    const strike = Math.round(price / 5) * 5; // Round to nearest $5
    
    // DTE explanation based on mode
    const dteValue = tradingMode === 'INTRADAY' ? '0-1' : '3-7';
    const dteExplain = tradingMode === 'INTRADAY' ? 
        'Expires today/tomorrow. High risk, high reward. Quick profits but rapid time decay.' : 
        'Expires in 3-7 days. Gives trade time to develop. Less time decay pressure.';
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            <!-- Main Trade Card -->
            <div style="background: ${signal === 'CALL' ? 'rgba(16,185,129,0.1)' : signal === 'PUT' ? 'rgba(239,68,68,0.1)' : 'rgba(100,116,139,0.1)'}; padding: 15px; border-radius: 8px; border-left: 4px solid ${signal === 'CALL' ? 'var(--success)' : signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="font-weight: 700; font-size: 18px;">${currentSymbol}</span>
                    <span style="background: ${signal === 'CALL' ? 'var(--success)' : signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'}; color: white; padding: 6px 14px; border-radius: 4px; font-size: 14px; font-weight: 700;">${signal}</span>
                </div>
                
                <div style="font-size: 12px; line-height: 2;">
                    <div style="background: rgba(255,255,255,0.5); padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                        <strong> Best Entry Price:</strong> <span style="color:var(--primary);font-weight:700;font-size:14px;">$${bestEntry.toFixed(2)}</span><br>
                        <span style="font-size:10px;color:var(--muted);">Wait for pullback to this level for optimal risk/reward</span>
                    </div>
                    
                    <div><strong>Entry Range:</strong> $${entryLow.toFixed(2)} - $${entryHigh.toFixed(2)}</div>
                    
                    <div style="margin-top: 6px;">
                        <strong> Stop Loss Options:</strong><br>
                        <div style="padding-left: 10px; font-size: 11px;">
                             Tight (0.5 ATR): <span style="color: var(--danger);font-weight:600;">$${stop05.toFixed(2)}</span> 
                            <span style="color:var(--muted);">(=$${(atr * 0.5).toFixed(2)} risk)</span><br>
                             Standard (1.0 ATR): <span style="color: var(--danger);font-weight:600;">$${stop10.toFixed(2)}</span>
                            <span style="color:var(--muted);">(=$${atr.toFixed(2)} risk)</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 6px;">
                        <strong> Profit Targets:</strong><br>
                        <div style="padding-left: 10px; font-size: 11px;">
                             Target 1: <span style="color: var(--success);font-weight:600;">$${target1.toFixed(2)}</span> (take 50%)<br>
                             Target 2: <span style="color: var(--success);font-weight:600;">$${target2.toFixed(2)}</span> (close position)
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border);">
                        <strong> Options Setup:</strong><br>
                        <div style="padding-left: 10px; font-size: 11px;">
                             Strike: <strong>$${strike} ${signal}</strong><br>
                             DTE: <strong>${dteValue} DTE</strong> (Days To Expiration)<br>
                            <span style="color:var(--muted);font-size:10px;"> ${dteExplain}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Signal Breakdown Card -->
            <div style="background: var(--bg); padding: 15px; border-radius: 8px;">
                <h4 style="font-size: 13px; margin-bottom: 12px;">
                     Why This Signal? 
                    ${signals.agentConsensus.isReal ? '<span style="background: var(--success); color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px;">LIVE DATA</span>' : '<span style="background: var(--muted); color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px;">CALCULATED</span>'}
                </h4>
                
                <!-- Individual Agent Breakdown -->
                <div style="background: white; border-radius: 6px; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border);">
                    <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px; color: var(--text);"> Individual Agent Votes:</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 10px;">
                        ${signals.agentConsensus.agentDetails ? `
                        <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: ${signals.agentConsensus.agentDetails.base.signal === 'CALL' ? 'rgba(16,185,129,0.1)' : signals.agentConsensus.agentDetails.base.signal === 'PUT' ? 'rgba(239,68,68,0.1)' : 'rgba(100,116,139,0.1)'}; border-radius: 4px;">
                            <span> Base Confluence:</span>
                            <strong style="color: ${signals.agentConsensus.agentDetails.base.signal === 'CALL' ? 'var(--success)' : signals.agentConsensus.agentDetails.base.signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'};">${signals.agentConsensus.agentDetails.base.signal} (${signals.agentConsensus.agentDetails.base.confidence.toFixed(0)}%)</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: ${signals.agentConsensus.agentDetails.gann.signal === 'CALL' ? 'rgba(16,185,129,0.1)' : signals.agentConsensus.agentDetails.gann.signal === 'PUT' ? 'rgba(239,68,68,0.1)' : 'rgba(100,116,139,0.1)'}; border-radius: 4px;">
                            <span> Gann-Elliott:</span>
                            <strong style="color: ${signals.agentConsensus.agentDetails.gann.signal === 'CALL' ? 'var(--success)' : signals.agentConsensus.agentDetails.gann.signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'};">${signals.agentConsensus.agentDetails.gann.signal} (${signals.agentConsensus.agentDetails.gann.confidence.toFixed(0)}%)</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: ${signals.agentConsensus.agentDetails.dqn.signal === 'CALL' ? 'rgba(16,185,129,0.1)' : signals.agentConsensus.agentDetails.dqn.signal === 'PUT' ? 'rgba(239,68,68,0.1)' : 'rgba(100,116,139,0.1)'}; border-radius: 4px;">
                            <span> DQN (ML):</span>
                            <strong style="color: ${signals.agentConsensus.agentDetails.dqn.signal === 'CALL' ? 'var(--success)' : signals.agentConsensus.agentDetails.dqn.signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'};">${signals.agentConsensus.agentDetails.dqn.signal} (${signals.agentConsensus.agentDetails.dqn.confidence.toFixed(0)}%)</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: ${signals.agentConsensus.agentDetails.wave.signal === 'CALL' ? 'rgba(16,185,129,0.1)' : signals.agentConsensus.agentDetails.wave.signal === 'PUT' ? 'rgba(239,68,68,0.1)' : 'rgba(100,116,139,0.1)'}; border-radius: 4px;">
                            <span> 3-Wave:</span>
                            <strong style="color: ${signals.agentConsensus.agentDetails.wave.signal === 'CALL' ? 'var(--success)' : signals.agentConsensus.agentDetails.wave.signal === 'PUT' ? 'var(--danger)' : 'var(--muted)'};">${signals.agentConsensus.agentDetails.wave.signal} (${signals.agentConsensus.agentDetails.wave.confidence.toFixed(0)}%)</strong>
                        </div>
                        ` : '<div style="grid-column: span 2; text-align: center; color: var(--muted);">Agent data not available</div>'}
                    </div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border); text-align: center;">
                        <strong style="color: ${signals.agentConsensus.count >= 3 ? 'var(--success)' : 'var(--warning)'};">
                            Consensus: ${signals.agentConsensus.count}/4 agents  ${signals.agentConsensus.signal}
                        </strong>
                    </div>
                </div>
                
                <!-- Other Signals -->
                <div style="font-size: 11px; line-height: 1.9;">
                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border);">
                        <span> Bar Count:</span>
                        <strong style="color: ${signals.barCount.count > 0 ? 'var(--success)' : signals.barCount.count < 0 ? 'var(--danger)' : 'var(--muted)'};">${signals.barCount.count > 0 ? '+' : ''}${signals.barCount.count} bars</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border);">
                        <span> Patterns:</span>
                        <strong>${signals.patterns.found.length > 0 ? signals.patterns.found.slice(0,2).join(', ') : 'None'}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border);">
                        <span> Gann Cycle:</span>
                        <strong>${signals.gann.score > 0 ? ' Bullish' : signals.gann.score < 0 ? ' Bearish' : ' Neutral'}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border);">
                        <span> Fibonacci:</span>
                        <strong>${signals.fibonacci.level}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                        <span> Volume:</span>
                        <strong>${signals.volume.score > 0 ? ' Above Avg' : ' Below Avg'}</strong>
                    </div>
                </div>
                
                <div style="margin-top: 12px; padding: 10px; background: ${signals.confidence >= 70 ? 'rgba(16,185,129,0.15)' : signals.confidence >= 50 ? 'rgba(245,158,11,0.15)' : 'rgba(239,68,68,0.15)'}; border-radius: 6px; text-align: center;">
                    <div style="font-size: 10px; color: var(--muted);">Overall Confidence</div>
                    <div style="font-size: 24px; font-weight: 700; color: ${signals.confidence >= 70 ? 'var(--success)' : signals.confidence >= 50 ? 'var(--warning)' : 'var(--danger)'};">${signals.confidence.toFixed(0)}%</div>
                </div>
            </div>
        </div>
        
        <!-- ATR Explanation -->
        <div style="background: rgba(59,130,246,0.05); padding: 12px; border-radius: 6px; margin-top: 15px; font-size: 11px; color: var(--muted);">
            <strong> Understanding ATR (Average True Range):</strong><br>
            Current ATR = <strong>$${atr.toFixed(2)}</strong>  This means ${currentSymbol} typically moves $${atr.toFixed(2)} per day.<br>
             <strong>0.5 ATR stop</strong> = $${(atr * 0.5).toFixed(2)} risk  Tighter stop, less room for normal fluctuation<br>
             <strong>1.0 ATR stop</strong> = $${atr.toFixed(2)} risk  Standard stop, accounts for normal daily volatility<br>
             Use tighter stops for day trades, wider stops for swing trades
        </div>
    `;
}

function updateGannAnalysis(price) {
    const timeCyclesEl = document.getElementById('gannTimeCycles');
    const sq9El = document.getElementById('squareOf9');
    
    const today = new Date();
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    
    // Time cycles
    const cycle30 = dayOfYear % 30;
    const cycle90 = dayOfYear % 90;
    const cycle180 = dayOfYear % 180;
    
    // Get cycle phases with explanations
    let cycle30Phase, cycle30Action;
    if (cycle30 < 7) {
        cycle30Phase = 'Bottoming';
        cycle30Action = ' Look for reversal longs';
    } else if (cycle30 > 23) {
        cycle30Phase = 'Topping';
        cycle30Action = ' Caution, take profits';
    } else if (cycle30 < 15) {
        cycle30Phase = 'Rising';
        cycle30Action = ' Favor bullish plays';
    } else {
        cycle30Phase = 'Declining';
        cycle30Action = ' Patience, wait for bottom';
    }
    
    let cycle90Phase, cycle90Action;
    if (cycle90 < 20) {
        cycle90Phase = 'Accumulation';
        cycle90Action = ' Smart money buying';
    } else if (cycle90 > 70) {
        cycle90Phase = 'Distribution';
        cycle90Action = ' Smart money selling';
    } else {
        cycle90Phase = 'Trend Phase';
        cycle90Action = ' Ride the momentum';
    }
    
    if (timeCyclesEl) {
        timeCyclesEl.innerHTML = `
            <div style="margin-bottom: 8px;">
                <strong>30-day cycle:</strong> Day ${cycle30}/30 - <span style="color:var(--primary);font-weight:600;">${cycle30Phase}</span><br>
                <span style="font-size:10px;color:var(--muted);">${cycle30Action} | ${cycle30Phase === 'Bottoming' ? 'Market finding floor, reversal expected' : cycle30Phase === 'Topping' ? 'Market at peak, reversal risk high' : cycle30Phase === 'Rising' ? 'Upward momentum active' : 'Downward pressure, wait for cycle bottom'}</span>
            </div>
            <div style="margin-bottom: 8px;">
                <strong>90-day cycle:</strong> Day ${cycle90}/90 - <span style="color:var(--primary);font-weight:600;">${cycle90Phase}</span><br>
                <span style="font-size:10px;color:var(--muted);">${cycle90Action} | ${cycle90Phase === 'Accumulation' ? 'Institutional buying phase' : cycle90Phase === 'Distribution' ? 'Institutional selling phase' : 'Strong trending, follow direction'}</span>
            </div>
            <div>
                <strong>Next Gann Date:</strong> ${getNextGannDate()}<br>
                <span style="font-size:10px;color:var(--muted);"> Gann dates (equinoxes/solstices) often mark trend reversals</span>
            </div>
        `;
    }
    
    // Square of 9 calculations with explanations
    if (sq9El) {
        const sq9Levels = calculateSquareOf9(price);
        sq9El.innerHTML = `
            <div style="margin-bottom: 8px;">
                <strong>Resistance Levels:</strong><br>
                 R1: <span style="color:var(--danger);font-weight:600;">$${sq9Levels.r1.toFixed(2)}</span> (45 up)<br>
                 R2: <span style="color:var(--danger);font-weight:600;">$${sq9Levels.r2.toFixed(2)}</span> (90 up)
            </div>
            <div style="margin-bottom: 8px;">
                <strong>Support Levels:</strong><br>
                 S1: <span style="color:var(--success);font-weight:600;">$${sq9Levels.s1.toFixed(2)}</span> (45 down)<br>
                 S2: <span style="color:var(--success);font-weight:600;">$${sq9Levels.s2.toFixed(2)}</span> (90 down)
            </div>
            <div style="font-size:10px;color:var(--muted);margin-top:8px;">
                 <strong>What is Square of 9?</strong><br>
                Gann's geometric calculator that finds natural price levels. Each 45 rotation = 1 step. Prices tend to find support/resistance at these harmonic levels.
            </div>
        `;
    }
}

function getNextGannDate() {
    const today = new Date();
    const gannDates = [
        { month: 0, day: 21 },  // Jan 21
        { month: 2, day: 21 },  // Mar 21 (Equinox)
        { month: 5, day: 21 },  // Jun 21 (Solstice)
        { month: 8, day: 21 },  // Sep 21 (Equinox)
        { month: 11, day: 21 }, // Dec 21 (Solstice)
    ];
    
    for (const gd of gannDates) {
        const date = new Date(today.getFullYear(), gd.month, gd.day);
        if (date > today) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
    }
    
    return new Date(today.getFullYear() + 1, 0, 21).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function calculateSquareOf9(price) {
    // Gann Square of 9 calculations
    const sqrt = Math.sqrt(price);
    const increment = 0.125; // 45 degrees = 0.125
    
    return {
        r1: Math.pow(sqrt + increment, 2),
        r2: Math.pow(sqrt + increment * 2, 2),
        s1: Math.pow(sqrt - increment, 2),
        s2: Math.pow(sqrt - increment * 2, 2)
    };
}

function updateFibonacciLevels(data) {
    if (data.length < 50) return;
    
    const recent = data.slice(-50);
    const high = Math.max(...recent.map(d => parseFloat(d.High)));
    const low = Math.min(...recent.map(d => parseFloat(d.Low)));
    const range = high - low;
    
    const levels = {
        'phi236': high - range * 0.236,
        'phi382': high - range * 0.382,
        'phi50': high - range * 0.5,
        'phi618': high - range * 0.618,
        'phi786': high - range * 0.786,
        'phi1618': high + range * 0.618
    };
    
    for (const [id, value] of Object.entries(levels)) {
        const el = document.getElementById(id);
        if (el) el.textContent = '$' + value.toFixed(2);
    }
}

function updateHighConsensusTrades(signals) {
    const tableBody = document.getElementById('highConsensusTable');
    if (!tableBody) return;
    
    const lastBar = currentData[currentData.length - 1];
    const price = parseFloat(lastBar.Close);
    const atr = parseFloat(lastBar.ATR) || price * 0.015;
    
    const signal = signals.direction === 'BULLISH' ? 'CALL' : signals.direction === 'BEARISH' ? 'PUT' : 'HOLD';
    const consensus = signals.agentConsensus.count;
    
    if (consensus >= 3) {
        const stop = signal === 'CALL' ? price - atr * 1.5 : price + atr * 1.5;
        const target = signal === 'CALL' ? price + atr * 2 : price - atr * 2;
        const strike = Math.round(price / 5) * 5;
        
        tableBody.innerHTML = `
            <tr>
                <td><strong>${currentSymbol}</strong></td>
                <td><span class="badge ${signal === 'CALL' ? 'call' : 'put'}">${signal}</span></td>
                <td><strong>${consensus}/4</strong></td>
                <td>${signals.masterScore > 0 ? '+' : ''}${signals.masterScore.toFixed(1)}</td>
                <td>$${(price - atr * 0.3).toFixed(2)} - $${(price + atr * 0.3).toFixed(2)}</td>
                <td style="color: var(--danger);">$${stop.toFixed(2)}</td>
                <td style="color: var(--success);">$${target.toFixed(2)}</td>
                <td>$${strike} ${signal}</td>
            </tr>
        `;
    } else {
        tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);">No high-consensus trades at this time</td></tr>';
    }
}

function updateMarketContext(signals) {
    const biasEl = document.getElementById('overallBias');
    const leadersEl = document.getElementById('sectorLeaders');
    const riskEl = document.getElementById('riskLevel');
    
    if (biasEl) {
        biasEl.textContent = signals.direction;
        biasEl.style.color = signals.direction === 'BULLISH' ? 'var(--success)' : 
                            signals.direction === 'BEARISH' ? 'var(--danger)' : 'var(--muted)';
    }
    
    if (leadersEl) {
        leadersEl.textContent = signals.direction === 'BULLISH' ? 'XLK, QQQ' : 
                                signals.direction === 'BEARISH' ? 'XLU, XLP' : 'Mixed';
    }
    
    if (riskEl) {
        const risk = signals.confidence > 75 ? 'LOW' : signals.confidence > 60 ? 'MODERATE' : 'HIGH';
        riskEl.textContent = risk;
        riskEl.style.color = risk === 'LOW' ? 'var(--success)' : risk === 'MODERATE' ? 'var(--warning)' : 'var(--danger)';
    }
}

function updateAISummary(signals, price) {
    const summaryEl = document.getElementById('aiSummary');
    if (!summaryEl) return;
    
    const lastBar = currentData[currentData.length - 1];
    const atr = parseFloat(lastBar.ATR) || price * 0.015;
    const sq9 = calculateSquareOf9(price);
    
    const signalWord = signals.direction === 'BULLISH' ? 'bullish' : signals.direction === 'BEARISH' ? 'bearish' : 'neutral';
    const optionType = signals.direction === 'BULLISH' ? 'CALL' : signals.direction === 'BEARISH' ? 'PUT' : 'neutral';
    
    // Calculate actual price levels
    const entryLow = (price - atr * 0.3).toFixed(2);
    const entryHigh = (price + atr * 0.1).toFixed(2);
    const bestEntry = signals.direction === 'BULLISH' ? entryLow : entryHigh;
    const stopLoss05ATR = signals.direction === 'BULLISH' ? (price - atr * 0.5).toFixed(2) : (price + atr * 0.5).toFixed(2);
    const stopLoss10ATR = signals.direction === 'BULLISH' ? (price - atr * 1.0).toFixed(2) : (price + atr * 1.0).toFixed(2);
    const target1 = signals.direction === 'BULLISH' ? (price + atr * 1.5).toFixed(2) : (price - atr * 1.5).toFixed(2);
    const target2 = signals.direction === 'BULLISH' ? (price + atr * 2.5).toFixed(2) : (price - atr * 2.5).toFixed(2);
    
    // Get Gann cycle explanations
    const gannExplanations = getGannCycleExplanations();
    
    // Calculate optimal strike
    const optimalStrike = Math.round(price / 5) * 5;
    
    if (currentAnalysisMode === 'morning') {
        summaryEl.innerHTML = `
            <strong> Morning Analysis (${new Date().toLocaleDateString()}):</strong> 
            Market conditions favor ${signalWord} positions today. ${currentSymbol} showing ${signals.agentConsensus.count}/4 agent consensus for ${signals.agentConsensus.signal}. 
            Master confluence score: ${signals.masterScore > 0 ? '+' : ''}${signals.masterScore.toFixed(1)} with ${signals.confidence.toFixed(0)}% confidence.
            <br><br>
            
            <strong> Recommended Entry Zone:</strong><br>
            <div style="background: rgba(16,185,129,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Best Entry Price:</strong> <span style="color:var(--primary);font-weight:700;">$${bestEntry}</span><br>
                 <strong>Entry Range:</strong> $${entryLow} - $${entryHigh}<br>
                 <strong>Why this range?</strong> Based on ATR (Average True Range = $${atr.toFixed(2)}), this zone offers optimal risk/reward
            </div>
            
            <strong> Recommended Strategy:</strong><br>
            ${signals.confidence >= 70 ? `
            <div style="background: rgba(59,130,246,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Trade:</strong> ${optionType} spreads on ${currentSymbol}<br>
                 <strong>Strike:</strong> $${optimalStrike} ${optionType}<br>
                 <strong>DTE:</strong> ${tradingMode === 'INTRADAY' ? '0-1 DTE' : '3-7 DTE'}<br>
                <div style="font-size:10px;color:var(--muted);margin-top:5px;">
                     <em>DTE = Days To Expiration. ${tradingMode === 'INTRADAY' ? 
                        '0-1 DTE means options expiring today or tomorrow - high risk/reward for quick moves.' : 
                        '3-7 DTE means 3-7 days until expiration - gives time for the move to develop with less theta decay.'}</em>
                </div>
            </div>` : `
            <div style="background: rgba(245,158,11,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Wait for higher confidence setup.</strong> Current confluence is weak.<br>
                Consider smaller position sizes or sitting out until signals align better.
            </div>`}
            
            <strong> Gann Cycle Analysis:</strong><br>
            <div style="background: rgba(139,92,246,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                ${gannExplanations}
            </div>
            
            <strong> Stop Loss Levels (with explanations):</strong><br>
            <div style="background: rgba(239,68,68,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Tight Stop (0.5 ATR):</strong> <span style="color:var(--danger);font-weight:600;">$${stopLoss05ATR}</span><br>
                  <span style="font-size:10px;color:var(--muted);"> 0.5  $${atr.toFixed(2)} ATR = $${(atr * 0.5).toFixed(2)} from entry  Stop at $${stopLoss05ATR}</span><br>
                  <span style="font-size:10px;color:var(--muted);">Use for: Day trades, high confidence setups, smaller position sizes</span><br><br>
                 <strong>Standard Stop (1.0 ATR):</strong> <span style="color:var(--danger);font-weight:600;">$${stopLoss10ATR}</span><br>
                  <span style="font-size:10px;color:var(--muted);"> 1.0  $${atr.toFixed(2)} ATR = $${atr.toFixed(2)} from entry  Stop at $${stopLoss10ATR}</span><br>
                  <span style="font-size:10px;color:var(--muted);">Use for: Swing trades, giving room for normal volatility</span>
            </div>
            
            <strong> Profit Targets:</strong><br>
            <div style="background: rgba(16,185,129,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 <strong>Target 1 (1.5 ATR):</strong> <span style="color:var(--success);font-weight:600;">$${target1}</span> - Take 50% profits<br>
                 <strong>Target 2 (2.5 ATR):</strong> <span style="color:var(--success);font-weight:600;">$${target2}</span> - Take remaining position<br>
                 <strong>Resistance (Sq9):</strong> $${sq9.r1.toFixed(2)} - Major resistance from Square of 9
            </div>
            
            <strong> Key Terms Explained:</strong><br>
            <div style="font-size:10px;color:var(--muted);line-height:1.6;margin-top:5px;">
                 <strong>ATR (Average True Range):</strong> Measures volatility. Current ATR = $${atr.toFixed(2)} means ${currentSymbol} typically moves $${atr.toFixed(2)} per day.<br>
                 <strong>DTE (Days To Expiration):</strong> How many days until your option expires. Lower DTE = higher risk but bigger potential gains.<br>
                 <strong>Sq9 (Square of 9):</strong> Gann's calculator for finding natural support/resistance levels based on price geometry.<br>
                 <strong>Confluence:</strong> Multiple signals agreeing on the same direction = higher probability trade.
            </div>
        `;
    } else {
        summaryEl.innerHTML = `
            <strong> Evening Review (${new Date().toLocaleDateString()}):</strong> 
            Today's session ended with ${currentSymbol} at $${price.toFixed(2)}. 
            ${signals.direction === 'BULLISH' ? 'Bulls maintained control' : signals.direction === 'BEARISH' ? 'Bears dominated' : 'Mixed price action'} with ${signals.agentConsensus.count}/4 agent agreement.
            <br><br>
            
            <strong> Day Summary:</strong><br>
            <div style="background: var(--bg); padding: 10px; border-radius: 6px; margin: 8px 0;">
                 Master Score: ${signals.masterScore > 0 ? '+' : ''}${signals.masterScore.toFixed(1)} (${signals.direction})<br>
                 Patterns: ${signals.patterns.found.length > 0 ? signals.patterns.found.join(', ') : 'None detected'}<br>
                 Bar Count: ${signals.barCount.count > 0 ? '+' : ''}${signals.barCount.count} consecutive ${signals.barCount.count > 0 ? 'bullish' : 'bearish'} bars<br>
                 Volume: ${signals.volume.detail}
            </div>
            
            <strong> Tomorrow's Trading Plan:</strong><br>
            <div style="background: rgba(59,130,246,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                ${signals.confidence >= 65 ? `
                <strong>Bias:</strong> Continue ${signalWord} outlook<br>
                <strong>Watch for:</strong> Gap ${signals.direction === 'BULLISH' ? 'up' : 'down'} at open<br>
                <strong>Entry Zone:</strong> $${entryLow} - $${entryHigh}<br>
                <strong>Best Entry:</strong> $${bestEntry} (wait for pullback to this level)<br>
                <strong>Stop Loss:</strong> $${stopLoss10ATR} (1 ATR = $${atr.toFixed(2)} below entry)<br>
                <strong>Target:</strong> $${target1} (first target), $${sq9.r1.toFixed(2)} (Sq9 resistance)
                ` : `
                 <strong>Low confidence setup for tomorrow.</strong><br>
                Wait for clearer signals before committing capital.<br>
                Key levels to watch: Support $${sq9.s1.toFixed(2)} / Resistance $${sq9.r1.toFixed(2)}
                `}
            </div>
            
            <strong> Gann Cycle Outlook:</strong><br>
            <div style="background: rgba(139,92,246,0.1); padding: 10px; border-radius: 6px; margin: 8px 0;">
                ${gannExplanations}
            </div>
            
            <strong> Pre-Market Checklist for Tomorrow:</strong><br>
            <div style="background: var(--bg); padding: 10px; border-radius: 6px; margin: 8px 0; font-size: 11px;">
                 Check overnight futures direction (ES, NQ)<br>
                 Review any earnings/economic news<br>
                 Confirm agent consensus at 9:35 AM<br>
                 Size positions based on confidence (${signals.confidence.toFixed(0)}%)<br>
                 Set alerts at $${sq9.s1.toFixed(2)} (support) and $${sq9.r1.toFixed(2)} (resistance)
            </div>
        `;
    }
}

function getGannCycleExplanations() {
    const today = new Date();
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    
    const cycle30 = dayOfYear % 30;
    const cycle90 = dayOfYear % 90;
    const month = today.getMonth();
    
    let explanations = '';
    
    // 30-day cycle explanation
    let cycle30Phase, cycle30Explain;
    if (cycle30 < 7) {
        cycle30Phase = 'Bottoming';
        cycle30Explain = 'Market finding a floor - look for reversal signals to go long';
    } else if (cycle30 > 23) {
        cycle30Phase = 'Topping';
        cycle30Explain = 'Market reaching peak - be cautious of reversals, consider taking profits';
    } else if (cycle30 < 15) {
        cycle30Phase = 'Rising';
        cycle30Explain = 'Upward momentum phase - favor bullish positions';
    } else {
        cycle30Phase = 'Declining';
        cycle30Explain = 'Downward momentum phase - favor bearish positions or wait';
    }
    
    // 90-day cycle explanation
    let cycle90Phase, cycle90Explain;
    if (cycle90 < 20) {
        cycle90Phase = 'Accumulation';
        cycle90Explain = 'Smart money buying - early bullish opportunity';
    } else if (cycle90 > 70) {
        cycle90Phase = 'Distribution';
        cycle90Explain = 'Smart money selling - late in cycle, increased risk';
    } else {
        cycle90Phase = 'Trend Phase';
        cycle90Explain = 'Strong trending period - follow the momentum';
    }
    
    // Seasonal explanation
    let seasonal, seasonalExplain;
    if (month >= 9) { // Oct-Dec
        seasonal = 'Q4 Bullish';
        seasonalExplain = 'Historically strongest quarter - Santa Rally, year-end positioning';
    } else if (month >= 4 && month <= 6) {
        seasonal = 'Summer Lull';
        seasonalExplain = '"Sell in May" period - typically lower volatility and returns';
    } else if (month >= 0 && month <= 2) {
        seasonal = 'January Effect';
        seasonalExplain = 'New year inflows, tax-loss harvesting reversals';
    } else {
        seasonal = 'Transitional';
        seasonalExplain = 'Between major seasonal patterns';
    }
    
    explanations = `
         <strong>30-Day Cycle:</strong> ${cycle30Phase} (Day ${cycle30}/30)<br>
          <span style="font-size:10px;color:var(--muted);"> ${cycle30Explain}</span><br><br>
         <strong>90-Day Cycle:</strong> ${cycle90Phase} (Day ${cycle90}/90)<br>
          <span style="font-size:10px;color:var(--muted);"> ${cycle90Explain}</span><br><br>
         <strong>Seasonal:</strong> ${seasonal}<br>
          <span style="font-size:10px;color:var(--muted);"> ${seasonalExplain}</span>
    `;
    
    return explanations;
}

function updatePlanDateTime() {
    const now = new Date();
    
    const dateEl = document.getElementById('planDate');
    const timeEl = document.getElementById('planTime');
    
    if (dateEl) {
        dateEl.textContent = now.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    }
    
    if (timeEl) {
        timeEl.textContent = now.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true
        }) + ' ET';
    }
}

function downloadReport() {
    if (!dailyAnalysisData) {
        alert('Please generate a report first');
        return;
    }
    
    const content = generateReportHTML();
    const blob = new Blob([content], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `Q5D_${currentSymbol}_${currentAnalysisMode}_${new Date().toISOString().split('T')[0]}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function generateReportHTML() {
    const signals = dailyAnalysisData.signals;
    const price = dailyAnalysisData.price;
    const sq9 = calculateSquareOf9(price);
    
    return `
<!DOCTYPE html>
<html>
<head>
    <title>Q5D Trading Report - ${currentSymbol} - ${new Date().toLocaleDateString()}</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
        h1 { color: #1e40af; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; }
        h2 { color: #374151; margin-top: 30px; }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .score { font-size: 48px; font-weight: bold; text-align: center; padding: 20px; border-radius: 10px; }
        .bullish { background: #dcfce7; color: #16a34a; }
        .bearish { background: #fee2e2; color: #dc2626; }
        .neutral { background: #f3f4f6; color: #6b7280; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f3f4f6; }
        .signal-call { color: #16a34a; font-weight: bold; }
        .signal-put { color: #dc2626; font-weight: bold; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280; }
        @media print { body { margin: 0; } }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1> Q5D Trading Report</h1>
            <p><strong>${currentAnalysisMode === 'morning' ? ' Morning Plan' : ' Evening Review'}</strong></p>
        </div>
        <div style="text-align: right;">
            <p><strong>${currentSymbol}</strong></p>
            <p>${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
            <p>${new Date().toLocaleTimeString()}</p>
        </div>
    </div>
    
    <div class="score ${signals.direction.toLowerCase()}">${signals.masterScore > 0 ? '+' : ''}${signals.masterScore.toFixed(1)}</div>
    <p style="text-align: center; font-size: 18px;"><strong>${signals.direction} BIAS</strong> | Confidence: ${signals.confidence.toFixed(0)}%</p>
    
    <h2> Signal Breakdown</h2>
    <table>
        <tr><th>Signal Component</th><th>Score</th><th>Details</th></tr>
        <tr><td> Agent Consensus</td><td>${signals.agentConsensus.count}/4</td><td>${signals.agentConsensus.detail}</td></tr>
        <tr><td> Bar Count</td><td>${signals.barCount.score > 0 ? '+' : ''}${signals.barCount.score.toFixed(1)}</td><td>${signals.barCount.detail}</td></tr>
        <tr><td> Patterns</td><td>${signals.patterns.score > 0 ? '+' : ''}${signals.patterns.score.toFixed(1)}</td><td>${signals.patterns.detail}</td></tr>
        <tr><td> Gann Cycles</td><td>${signals.gann.score > 0 ? '+' : ''}${signals.gann.score.toFixed(1)}</td><td>${signals.gann.detail}</td></tr>
        <tr><td> Fibonacci</td><td>${signals.fibonacci.score > 0 ? '+' : ''}${signals.fibonacci.score.toFixed(1)}</td><td>${signals.fibonacci.detail}</td></tr>
        <tr><td> Volume</td><td>${signals.volume.score > 0 ? '+' : ''}${signals.volume.score.toFixed(1)}</td><td>${signals.volume.detail}</td></tr>
    </table>
    
    <h2> Trade Recommendation</h2>
    <div class="card">
        <p><strong>Symbol:</strong> ${currentSymbol} | <strong>Current Price:</strong> $${price.toFixed(2)}</p>
        <p><strong>Signal:</strong> <span class="signal-${signals.direction === 'BULLISH' ? 'call' : 'put'}">${signals.direction === 'BULLISH' ? 'CALL' : signals.direction === 'BEARISH' ? 'PUT' : 'HOLD'}</span></p>
        <p><strong>Optimal Strike:</strong> $${Math.round(price / 5) * 5}</p>
        <p><strong>Stop Loss:</strong> $${sq9.s1.toFixed(2)}</p>
        <p><strong>Target:</strong> $${sq9.r1.toFixed(2)}</p>
    </div>
    
    <h2> Gann Square of 9 Levels</h2>
    <div class="grid">
        <div class="card">
            <h3>Resistance</h3>
            <p>R1: $${sq9.r1.toFixed(2)}</p>
            <p>R2: $${sq9.r2.toFixed(2)}</p>
        </div>
        <div class="card">
            <h3>Support</h3>
            <p>S1: $${sq9.s1.toFixed(2)}</p>
            <p>S2: $${sq9.s2.toFixed(2)}</p>
        </div>
    </div>
    
    <div class="footer">
        <p>Generated by Q5D Options Trading Platform | ${new Date().toISOString()}</p>
        <p> This report is for educational purposes only. Always do your own research before trading.</p>
    </div>
</body>
</html>
    `;
}

// ========== OPTIONS CALCULATOR ==========

// Default IV values for each ETF
const ETF_DEFAULT_IV = {
    SPY: 18, QQQ: 22, IWM: 25, DIA: 16,
    XLK: 24, XLF: 20, XLV: 18, XLE: 30, XLI: 19
};

let currentOptionType = 'call';

function setOptionType(type) {
    currentOptionType = type;
    document.querySelectorAll('.option-type-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.option-type-btn.' + type).classList.add('active');
    calculateOptions();
}

function useCurrentSymbolPrice() {
    const priceEl = document.getElementById('currentPrice');
    const priceText = priceEl ? priceEl.textContent : '';
    const price = parseFloat(priceText.replace(/[$,]/g, ''));
    
    if (price && price > 0) {
        document.getElementById('calcStockPrice').value = price.toFixed(2);
        document.getElementById('calcSymbol').value = currentSymbol;
        
        const strikeRound = price > 100 ? 5 : 1;
        document.getElementById('calcStrikePrice').value = Math.round(price / strikeRound) * strikeRound;
        
        const iv = ETF_DEFAULT_IV[currentSymbol] || 20;
        document.getElementById('calcIV').value = iv;
        
        calculateOptions();
    } else {
        alert('Price data not available yet. Please wait for data to load.');
    }
}

function updateOptionsCalcForSymbol() {
    document.getElementById('calcSymbol').value = currentSymbol;
    
    const priceEl = document.getElementById('currentPrice');
    const priceText = priceEl ? priceEl.textContent : '';
    const price = parseFloat(priceText.replace(/[$,]/g, ''));
    
    if (price && price > 0) {
        document.getElementById('calcStockPrice').value = price.toFixed(2);
        const strikeRound = price > 100 ? 5 : 1;
        document.getElementById('calcStrikePrice').value = Math.round(price / strikeRound) * strikeRound;
    }
    
    const iv = ETF_DEFAULT_IV[currentSymbol] || 20;
    document.getElementById('calcIV').value = iv;
    
    calculateOptions();
}

function normalCDF(x) {
    const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
    const a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
    const sign = x < 0 ? -1 : 1;
    x = Math.abs(x) / Math.sqrt(2);
    const t = 1.0 / (1.0 + p * x);
    const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
    return 0.5 * (1.0 + sign * y);
}

function normalPDF(x) {
    return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
}

function calculateOptions() {
    const S = parseFloat(document.getElementById('calcStockPrice').value) || 0;
    const K = parseFloat(document.getElementById('calcStrikePrice').value) || 0;
    const T = (parseFloat(document.getElementById('calcDTE').value) || 1) / 365;
    const r = (parseFloat(document.getElementById('calcRiskFree').value) || 5) / 100;
    const sigma = (parseFloat(document.getElementById('calcIV').value) || 20) / 100;
    const contracts = parseInt(document.getElementById('calcContracts').value) || 1;
    const isCall = currentOptionType === 'call';
    
    if (S <= 0 || K <= 0 || T <= 0 || sigma <= 0) {
        return;
    }
    
    const sqrtT = Math.sqrt(T);
    const d1 = (Math.log(S / K) + (r + sigma * sigma / 2) * T) / (sigma * sqrtT);
    const d2 = d1 - sigma * sqrtT;
    
    let price, delta;
    if (isCall) {
        price = S * normalCDF(d1) - K * Math.exp(-r * T) * normalCDF(d2);
        delta = normalCDF(d1);
    } else {
        price = K * Math.exp(-r * T) * normalCDF(-d2) - S * normalCDF(-d1);
        delta = normalCDF(d1) - 1;
    }
    
    const gamma = normalPDF(d1) / (S * sigma * sqrtT);
    const vega = S * sqrtT * normalPDF(d1) / 100;
    
    let theta;
    if (isCall) {
        theta = (-S * normalPDF(d1) * sigma / (2 * sqrtT) - r * K * Math.exp(-r * T) * normalCDF(d2)) / 365;
    } else {
        theta = (-S * normalPDF(d1) * sigma / (2 * sqrtT) + r * K * Math.exp(-r * T) * normalCDF(-d2)) / 365;
    }
    
    const intrinsic = isCall ? Math.max(0, S - K) : Math.max(0, K - S);
    const extrinsic = Math.max(0, price - intrinsic);
    
    const totalCost = price * contracts * 100;
    const breakeven = isCall ? K + price : K - price;
    const maxLoss = totalCost;
    const maxProfit = isCall ? 'Unlimited' : ((K - price) * contracts * 100);
    
    document.getElementById('calcOptionPrice').textContent = '$' + price.toFixed(2);
    document.getElementById('calcTotalCost').textContent = '$' + totalCost.toFixed(2);
    document.getElementById('calcIntrinsic').textContent = '$' + intrinsic.toFixed(2);
    document.getElementById('calcExtrinsic').textContent = '$' + extrinsic.toFixed(2);
    
    document.getElementById('calcBreakeven').textContent = '$' + breakeven.toFixed(2);
    document.getElementById('calcMaxLoss').textContent = '-$' + maxLoss.toFixed(2);
    document.getElementById('calcMaxProfit').textContent = typeof maxProfit === 'string' ? maxProfit : '$' + maxProfit.toFixed(2);
    
    if (!isCall && maxProfit > 0) {
        const rr = (maxProfit / maxLoss).toFixed(2);
        document.getElementById('calcRiskReward').textContent = '1:' + rr;
    } else {
        document.getElementById('calcRiskReward').textContent = isCall ? 'Unlimited' : '--';
    }
    
    document.getElementById('calcDelta').textContent = delta.toFixed(4);
    document.getElementById('calcGamma').textContent = gamma.toFixed(4);
    document.getElementById('calcTheta').textContent = theta.toFixed(4);
    document.getElementById('calcVega').textContent = vega.toFixed(4);
    
    document.getElementById('calcDelta').style.color = delta > 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('calcTheta').style.color = 'var(--danger)';
}

// Initialize calculator on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(calculateOptions, 1000);
});
</script>
</body>
</html>
