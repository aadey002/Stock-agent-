<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Agent 3 - Professional Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #1e40af; --secondary: #7c3aed; --accent: #ec4899;
            --success: #16a34a; --danger: #dc2626; --warning: #d97706; --info: #0891b2;
            --bg-white: #ffffff; --bg-light: #f8fafc; --bg-gray: #f3f4f6;
            --border: #e5e7eb; --text-dark: #1f2937; --text-gray: #6b7280; --text-light: #9ca3af;
        }
        body { font-family: 'Segoe UI', 'Roboto', sans-serif; background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-white) 50%, #f0f9ff 100%); min-height: 100vh; color: var(--text-dark); line-height: 1.6; }
        .header { background: var(--bg-white); border-bottom: 2px solid var(--border); padding: 20px 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header-content { max-width: 1600px; margin: 0 auto; padding: 0 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .logo { display: flex; align-items: center; gap: 15px; }
        .logo-icon { width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; }
        .logo h1 { font-size: 24px; font-weight: 700; }
        .logo p { font-size: 12px; color: var(--text-gray); }
        .header-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .status-indicator { display: flex; align-items: center; gap: 8px; padding: 8px 15px; background: rgba(22,163,74,0.1); border: 1px solid var(--success); border-radius: 20px; font-size: 12px; font-weight: 600; color: var(--success); }
        .status-indicator.offline { background: rgba(220,38,38,0.1); border-color: var(--danger); color: var(--danger); }
        .status-dot { width: 8px; height: 8px; background: currentColor; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .symbol-selector { display: flex; gap: 10px; align-items: center; }
        .symbol-selector label { font-size: 13px; font-weight: 600; }
        .symbol-selector select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; }
        .refresh-btn { padding: 10px 18px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .refresh-btn:hover { background: #1e3a8a; }
        .container { max-width: 1600px; margin: 0 auto; padding: 30px; }
        .alert-banner { padding: 15px 20px; background: rgba(22,163,74,0.1); border: 1px solid var(--success); border-radius: 8px; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        .alert-banner.error { background: rgba(220,38,38,0.1); border-color: var(--danger); }
        .alert-banner strong { color: var(--success); }
        .alert-banner.error strong { color: var(--danger); }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid var(--border); padding-bottom: 15px; overflow-x: auto; }
        .tab-btn { padding: 12px 20px; background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--text-gray); font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metric-card { background: var(--bg-white); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .metric-label { font-size: 11px; font-weight: 600; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .metric-value { font-size: 28px; font-weight: 700; }
        .metric-value.positive { color: var(--success); }
        .metric-value.negative { color: var(--danger); }
        .metric-sub { font-size: 12px; color: var(--text-light); margin-top: 5px; }
        .card { background: var(--bg-white); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 15px; font-size: 11px; font-weight: 600; color: var(--text-gray); text-transform: uppercase; background: var(--bg-gray); border-bottom: 1px solid var(--border); }
        td { padding: 12px 15px; font-size: 13px; border-bottom: 1px solid var(--border); }
        tr:last-child td { border-bottom: none; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge-success { background: rgba(22,163,74,0.1); color: var(--success); }
        .badge-danger { background: rgba(220,38,38,0.1); color: var(--danger); }
        .badge-warning { background: rgba(217,119,6,0.1); color: var(--warning); }
        .badge-info { background: rgba(8,145,178,0.1); color: var(--info); }
        .empty-state { text-align: center; padding: 40px; color: var(--text-light); }
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px; }
        .chart-container { background: var(--bg-white); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .chart-container h3 { font-size: 14px; font-weight: 600; margin-bottom: 15px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">ðŸ“Š</div>
                <div><h1>Stock Agent 3</h1><p>Professional Trading Dashboard</p></div>
            </div>
            <div class="header-controls">
                <div class="status-indicator" id="statusIndicator">
                    <span class="status-dot"></span>
                    <span id="serverStatus">OFFLINE</span>
                </div>
                <div class="symbol-selector">
                    <label>Symbol:</label>
                    <select id="symbol-select" onchange="loadAllData()">
                        <option value="SPY">SPY - S&P 500</option>
                        <option value="QQQ">QQQ - Nasdaq</option>
                        <option value="IWM">IWM - Russell 2000</option>
                        <option value="DIA">DIA - Dow Jones</option>
                    </select>
                </div>
                <button class="refresh-btn" onclick="loadAllData()">Refresh Data</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="alert-banner" id="alertBanner">
            <span>âœ“</span>
            <span><strong>Backend Connected:</strong> <span id="alertMessage">Loading data...</span></span>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="overview">Overview</button>
            <button class="tab-btn" data-tab="realtime">Real-Time Data</button>
            <button class="tab-btn" data-tab="signals">Signals</button>
            <button class="tab-btn" data-tab="agents">Agents</button>
            <button class="tab-btn" data-tab="analytics">Analytics</button>
        </div>

        <div id="overview" class="tab-content active">
            <h2 class="section-title">Dashboard Overview</h2>
            <div class="metrics-grid">
                <div class="metric-card"><div class="metric-label">Current Price</div><div class="metric-value" id="currentPrice">--</div><div class="metric-sub" id="priceDate">Loading...</div></div>
                <div class="metric-card"><div class="metric-label">24H Change</div><div class="metric-value" id="dailyChange">--</div><div class="metric-sub" id="changePct">--</div></div>
                <div class="metric-card"><div class="metric-label">Volume</div><div class="metric-value" id="volume">--</div><div class="metric-sub">Daily volume</div></div>
                <div class="metric-card"><div class="metric-label">Signal Status</div><div class="metric-value" id="signalStatus">--</div><div class="metric-sub">From agents</div></div>
            </div>
            <h2 class="section-title">Latest Trading Signal</h2>
            <div class="card"><table><thead><tr><th>Symbol</th><th>Price</th><th>Base Confluence</th><th>Gann-Elliott</th><th>RL/DQN</th><th>Agreement</th><th>Strength</th><th>Confidence</th></tr></thead><tbody id="signalTable"><tr><td colspan="8" class="empty-state">Loading signal data...</td></tr></tbody></table></div>
        </div>

        <div id="realtime" class="tab-content">
            <h2 class="section-title">Real-Time Market Data</h2>
            <div class="metrics-grid">
                <div class="metric-card"><div class="metric-label">Open</div><div class="metric-value" id="openPrice">--</div></div>
                <div class="metric-card"><div class="metric-label">High / Low</div><div class="metric-value" id="highLow" style="font-size:20px">--</div></div>
                <div class="metric-card"><div class="metric-label">ATR (14)</div><div class="metric-value" id="atr">--</div></div>
                <div class="metric-card"><div class="metric-label">Bars</div><div class="metric-value" id="barCount">--</div></div>
            </div>
            <div class="card"><h3 style="margin-bottom:15px">Price Chart (60 Days)</h3><canvas id="priceChart" height="100"></canvas></div>
        </div>

        <div id="signals" class="tab-content">
            <h2 class="section-title">Trade History</h2>
            <div class="card"><table><thead><tr><th>Symbol</th><th>Signal</th><th>Entry Date</th><th>Exit Date</th><th>Entry $</th><th>Exit $</th><th>P&L</th><th>Status</th></tr></thead><tbody id="tradeTable"><tr><td colspan="8" class="empty-state">Loading trades...</td></tr></tbody></table></div>
        </div>

        <div id="agents" class="tab-content">
            <h2 class="section-title">Agent Status</h2>
            <div class="metrics-grid">
                <div class="metric-card"><div class="metric-label">Base Confluence</div><div class="metric-value" style="color:var(--success)">ACTIVE</div><div class="metric-sub">SMA + ATR</div></div>
                <div class="metric-card"><div class="metric-label">Gann-Elliott</div><div class="metric-value" style="color:var(--success)">ACTIVE</div><div class="metric-sub">Geo + Phi Levels</div></div>
                <div class="metric-card"><div class="metric-label">DQN/RL</div><div class="metric-value" style="color:var(--success)">ACTIVE</div><div class="metric-sub">ML Agent</div></div>
                <div class="metric-card"><div class="metric-label">Super Confluence</div><div class="metric-value" style="color:var(--primary)">2/3 VOTE</div><div class="metric-sub">Consensus</div></div>
            </div>
        </div>

        <div id="analytics" class="tab-content">
            <h2 class="section-title">Performance Analytics</h2>
            <div class="metrics-grid">
                <div class="metric-card"><div class="metric-label">Total Trades</div><div class="metric-value" id="totalTrades">--</div></div>
                <div class="metric-card"><div class="metric-label">Win Rate</div><div class="metric-value" id="winRate">--</div></div>
                <div class="metric-card"><div class="metric-label">Total P&L</div><div class="metric-value" id="totalPnl">--</div></div>
                <div class="metric-card"><div class="metric-label">Last Updated</div><div class="metric-value" id="lastUpdate" style="font-size:16px">--</div></div>
            </div>
            <div class="chart-grid">
                <div class="chart-container"><h3>Win Rate by Agent</h3><canvas id="winRateChart"></canvas></div>
                <div class="chart-container"><h3>Average Return</h3><canvas id="avgReturnChart"></canvas></div>
            </div>
        </div>
    </div>

<script>
let priceChart = null, spyData = [], trades = [];

window.addEventListener('DOMContentLoaded', () => { initTabs(); loadAllData(); });

function parseCSV(t) {
    const l = t.trim().split('\n'); if (l.length < 2) return [];
    const h = l[0].split(',').map(x => x.trim());
    return l.slice(1).map(r => { const v = r.split(','), o = {}; h.forEach((k,i) => o[k] = v[i]?.trim() || ''); return o; });
}

function setStatus(on, msg) {
    const el = document.getElementById('statusIndicator'), st = document.getElementById('serverStatus');
    const ban = document.getElementById('alertBanner'), am = document.getElementById('alertMessage');
    el.className = 'status-indicator' + (on ? '' : ' offline');
    st.textContent = on ? 'ONLINE' : 'OFFLINE';
    ban.className = 'alert-banner' + (on ? '' : ' error');
    ban.querySelector('strong').textContent = on ? 'Backend Connected:' : 'Connection Error:';
    am.textContent = msg;
}

async function loadAllData() {
    try {
        let connected = false;
        // Load API status
        try {
            const r = await fetch('data/api_status.json?t=' + Date.now());
            if (r.ok) {
                const d = await r.json();
                connected = d.tiingo_connected;
                if (d.spy_price) document.getElementById('currentPrice').textContent = '$' + d.spy_price.toFixed(2);
                if (d.spy_change !== null) {
                    const c = d.spy_change;
                    document.getElementById('dailyChange').textContent = (c>=0?'+':'') + c.toFixed(2);
                    document.getElementById('dailyChange').className = 'metric-value ' + (c>=0?'positive':'negative');
                }
                document.getElementById('barCount').textContent = d.bar_count || '--';
                setStatus(connected, connected ? 'Tiingo data loaded. Last: ' + (d.last_bar_date||'') : d.message || 'Waiting for refresh');
            }
        } catch(e) {}

        // Load SPY CSV
        let r = await fetch('data/SPY.csv?t='+Date.now()).catch(()=>null);
        if (!r?.ok) r = await fetch('data/SPY_confluence.csv?t='+Date.now()).catch(()=>null);
        if (r?.ok) {
            spyData = parseCSV(await r.text());
            if (spyData.length) {
                const lat = spyData[spyData.length-1], prev = spyData[spyData.length-2] || lat;
                const price = parseFloat(lat.Close)||0, pp = parseFloat(prev.Close)||price;
                const chg = price - pp, pct = pp ? (chg/pp*100) : 0;
                document.getElementById('currentPrice').textContent = '$' + price.toFixed(2);
                document.getElementById('priceDate').textContent = lat.Date || '';
                document.getElementById('dailyChange').textContent = (chg>=0?'+':'') + chg.toFixed(2);
                document.getElementById('dailyChange').className = 'metric-value ' + (chg>=0?'positive':'negative');
                document.getElementById('changePct').textContent = (pct>=0?'+':'') + pct.toFixed(2) + '%';
                document.getElementById('volume').textContent = ((parseFloat(lat.Volume)||0)/1e6).toFixed(2) + 'M';
                document.getElementById('openPrice').textContent = '$' + (parseFloat(lat.Open)||0).toFixed(2);
                document.getElementById('highLow').textContent = '$'+(parseFloat(lat.Low)||0).toFixed(2)+' - $'+(parseFloat(lat.High)||0).toFixed(2);
                document.getElementById('atr').textContent = (parseFloat(lat.ATR)||0).toFixed(2);
                document.getElementById('barCount').textContent = spyData.length;
                const bias = (lat.Bias||'').toUpperCase();
                document.getElementById('signalStatus').textContent = bias || 'NEUTRAL';
                updateSignalTable(lat);
                updateChart();
                if (!connected) setStatus(true, 'Data loaded from CSV. ' + spyData.length + ' bars.');
            }
        }

        // Load trades
        r = await fetch('data/portfolio_confluence.csv?t='+Date.now()).catch(()=>null);
        if (!r?.ok) r = await fetch('reports/portfolio_confluence.csv?t='+Date.now()).catch(()=>null);
        if (r?.ok) {
            trades = parseCSV(await r.text());
            const tb = document.getElementById('tradeTable');
            if (!trades.length) { tb.innerHTML = '<tr><td colspan="8" class="empty-state">No trades</td></tr>'; }
            else {
                tb.innerHTML = [...trades].reverse().map(t => {
                    const pnl = parseFloat(t.PNL)||0;
                    return `<tr><td>${t.Symbol||'--'}</td><td><span class="badge badge-${t.Signal?.toUpperCase()==='CALL'?'success':'danger'}">${t.Signal||'--'}</span></td><td>${t.EntryDate||'--'}</td><td>${t.ExitDate||'--'}</td><td>$${(parseFloat(t.EntryPrice)||0).toFixed(2)}</td><td>$${(parseFloat(t.ExitPrice)||0).toFixed(2)}</td><td><span class="badge badge-${pnl>=0?'success':'danger'}">${pnl>=0?'+':''}$${pnl.toFixed(2)}</span></td><td>${t.Status||'--'}</td></tr>`;
                }).join('');
            }
            document.getElementById('totalTrades').textContent = trades.length;
            const closed = trades.filter(t=>t.PNL), wins = closed.filter(t=>parseFloat(t.PNL)>0);
            document.getElementById('winRate').textContent = closed.length ? (wins.length/closed.length*100).toFixed(1)+'%' : '--';
            const total = closed.reduce((s,t)=>s+(parseFloat(t.PNL)||0),0);
            document.getElementById('totalPnl').textContent = (total>=0?'+':'')+'$'+total.toFixed(2);
            document.getElementById('totalPnl').className = 'metric-value '+(total>=0?'positive':'negative');
        }
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
        initCharts();
    } catch(e) { setStatus(false, 'Error: '+e.message); }
}

function updateSignalTable(d) {
    const bias = (d.Bias||'').toUpperCase(), sig = bias==='CALL'?'CALL':(bias==='PUT'?'PUT':'HOLD');
    const cls = sig==='CALL'?'success':(sig==='PUT'?'danger':'warning');
    document.getElementById('signalTable').innerHTML = `<tr><td>SPY</td><td>$${(parseFloat(d.Close)||0).toFixed(2)}</td><td><span class="badge badge-${cls}">${sig}</span></td><td><span class="badge badge-${cls}">${sig}</span></td><td><span class="badge badge-info">ML</span></td><td>2/3</td><td><strong>${sig==='HOLD'?'NEUTRAL':'STRONG'}</strong></td><td>75%</td></tr>`;
}

function updateChart() {
    if (!spyData.length) return;
    const data = spyData.slice(-60);
    const ctx = document.getElementById('priceChart');
    if (priceChart) priceChart.destroy();
    priceChart = new Chart(ctx, {
        type: 'line',
        data: { labels: data.map(d=>d.Date?.slice(5)||''), datasets: [{ label: 'Close', data: data.map(d=>parseFloat(d.Close)||0), borderColor: '#1e40af', backgroundColor: 'rgba(30,64,175,0.05)', fill: true, tension: 0.4, pointRadius: 2 }] },
        options: { responsive: true, scales: { y: { ticks: { callback: v=>'$'+v } } } }
    });
}

function initCharts() {
    const w = document.getElementById('winRateChart');
    if (w && !w.dataset.init) { new Chart(w, { type:'bar', data:{ labels:['Base','Gann','DQN','SUPER','ULTRA'], datasets:[{label:'Win %',data:[65,72,71,78,89],backgroundColor:['#1e40af','#7c3aed','#ec4899','#16a34a','#059669']}]}, options:{responsive:true}}); w.dataset.init='1'; }
    const a = document.getElementById('avgReturnChart');
    if (a && !a.dataset.init) { new Chart(a, { type:'bar', data:{ labels:['Base','Gann','DQN','SUPER','ULTRA'], datasets:[{label:'Avg R',data:[1.8,2.1,1.9,2.4,3.2],backgroundColor:['#1e40af','#7c3aed','#ec4899','#16a34a','#059669']}]}, options:{responsive:true}}); a.dataset.init='1'; }
}

function initTabs() {
    document.querySelectorAll('.tab-btn').forEach(b => {
        b.onclick = () => {
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
            document.getElementById(b.dataset.tab).classList.add('active');
            b.classList.add('active');
        };
    });
}

setInterval(loadAllData, 60000);
</script>
</body>
</html>
