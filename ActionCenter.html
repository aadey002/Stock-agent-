<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Action Center - Stock Agent 4</title>
    <style>
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-dim: #64748b;
            --accent: #2563eb;
            --green: #22c55e;
            --red: #ef4444;
            --yellow: #f59e0b;
            --purple: #8b5cf6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 12px;
            color: var(--text-dim);
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .status-card {
            background: var(--card);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid var(--accent);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .status-card .label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .status-card .value {
            font-size: 20px;
            font-weight: 700;
        }

        .status-card .detail {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-header h2 {
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header .subtitle {
            font-size: 11px;
            color: var(--text-dim);
            font-weight: normal;
            margin-left: 8px;
        }

        .filter-btns {
            display: flex;
            gap: 6px;
        }

        .filter-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .filter-btn:hover { background: var(--border); }
        .filter-btn.active { background: var(--accent); border-color: var(--accent); }

        .trades-container {
            background: var(--card);
            border-radius: 12px;
            border: 2px solid var(--green);
            overflow: hidden;
            min-height: 300px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .trade-card {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        .trade-card:hover { background: rgba(37,99,235,0.05); }
        .trade-card.selected { border-left-color: var(--green); background: rgba(34,197,94,0.05); }

        .trade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .trade-symbol {
            font-size: 20px;
            font-weight: 700;
        }

        .trade-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-etf { background: var(--accent); color: white; }
        .badge-stock { background: var(--purple); color: white; }

        .trade-direction {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .direction-call { background: rgba(34,197,94,0.15); color: var(--green); }
        .direction-put { background: rgba(239,68,68,0.15); color: var(--red); }

        .trade-score {
            text-align: right;
        }

        .trade-score .number {
            font-size: 18px;
            font-weight: 700;
            color: var(--green);
        }

        .trade-score .label {
            font-size: 10px;
            color: var(--green);
        }

        .trade-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .metric {
            background: var(--bg);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .metric .label {
            font-size: 9px;
            color: var(--text-dim);
            margin-bottom: 2px;
        }

        .metric .value {
            font-size: 13px;
            font-weight: 600;
        }

        .trade-targets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .target-box {
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .target-box.entry { background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); }
        .target-box.stop { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); }
        .target-box.target { background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3); }

        .target-box .label {
            font-size: 9px;
            margin-bottom: 2px;
        }

        .target-box.entry .label { color: var(--green); }
        .target-box.stop .label { color: var(--red); }
        .target-box.target .label { color: var(--purple); }

        .target-box .value {
            font-size: 13px;
            font-weight: 600;
        }

        .target-box.entry .value { color: var(--green); }
        .target-box.stop .value { color: var(--red); }
        .target-box.target .value { color: var(--purple); }

        .watching-section {
            margin-top: 20px;
        }

        .watching-container {
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--yellow);
            overflow: hidden;
        }

        .watching-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .watching-table th {
            padding: 10px;
            text-align: left;
            background: rgba(245,158,11,0.15);
            font-weight: 600;
        }

        .watching-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .watching-table tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        .watching-table tr:hover { background: rgba(245,158,11,0.05); }

        /* Right Sidebar */
        .sidebar { display: flex; flex-direction: column; gap: 16px; }

        .checklist-card {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .checklist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .checklist-header h3 {
            font-size: 14px;
        }

        .checklist-symbol {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
        }

        .check-row {
            padding: 10px;
            margin-bottom: 6px;
            border-radius: 8px;
            background: var(--bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid transparent;
            transition: all 0.2s;
        }

        .check-row .check-label {
            font-size: 12px;
            font-weight: 500;
        }

        .check-row .check-value {
            font-size: 11px;
            text-align: right;
        }

        .check-row.pass {
            background: rgba(34,197,94,0.1);
            border-left-color: var(--green);
        }

        .check-row.warn {
            background: rgba(245,158,11,0.1);
            border-left-color: var(--yellow);
        }

        .check-row.fail {
            background: rgba(239,68,68,0.1);
            border-left-color: var(--red);
        }

        .check-row.info {
            background: rgba(59,130,246,0.1);
            border-left-color: #3b82f6;
        }

        .checklist-result {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            background: var(--bg);
        }

        .checklist-result.ready {
            background: rgba(34,197,94,0.15);
            border: 2px solid rgba(34,197,94,0.4);
        }

        .checklist-result.watching {
            background: rgba(245,158,11,0.15);
            border: 2px solid rgba(245,158,11,0.4);
        }

        .checklist-result.notready {
            background: rgba(239,68,68,0.15);
            border: 2px solid rgba(239,68,68,0.4);
        }

        .research-links {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .research-btn {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .research-btn:hover { background: var(--border); }

        .research-btn strong {
            display: block;
            font-size: 12px;
            margin-bottom: 2px;
        }

        .research-btn span {
            font-size: 10px;
            color: var(--text-dim);
        }

        .time-windows {
            font-size: 12px;
        }

        .time-window {
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .time-window.am { background: rgba(34,197,94,0.1); }
        .time-window.pm { background: rgba(59,130,246,0.1); }

        .time-window strong {
            color: var(--green);
        }

        .time-window.pm strong {
            color: #3b82f6;
        }

        .current-time-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            background: var(--bg);
            text-align: center;
            font-weight: 600;
        }

        .rules-card {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 12px;
            padding: 16px;
        }

        .rules-card h3 {
            font-size: 14px;
            color: #92400e;
            margin-bottom: 8px;
        }

        .rules-card ul {
            margin: 0;
            padding-left: 16px;
            font-size: 11px;
            color: #78350f;
            line-height: 1.8;
        }

        .rules-card li strong {
            color: #92400e;
        }

        .empty-state {
            padding: 40px;
            text-align: center;
            color: var(--text-dim);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: var(--text);
        }

        @media (max-width: 1024px) {
            .main-grid { grid-template-columns: 1fr; }
            .status-bar { grid-template-columns: repeat(3, 1fr); }
        }

        @media (max-width: 600px) {
            .status-bar { grid-template-columns: repeat(2, 1fr); }
            .trade-metrics { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üéØ Trade Action Center</h1>
        <div class="header-right">
            <span id="lastUpdate">Loading...</span>
            <a href="index.html" style="color: var(--accent); text-decoration: none;">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-card" id="trendCard" style="border-left-color: var(--green);">
            <div class="label">Market Trend</div>
            <div class="value" id="trendValue" style="color: var(--green);">BULLISH</div>
            <div class="detail" id="trendDetail">CALLS ONLY today</div>
        </div>

        <div class="status-card" style="border-left-color: var(--accent);">
            <div class="label">Qualified Setups</div>
            <div class="value" id="qualifiedCount" style="color: var(--accent);">0</div>
            <div class="detail">From 50 symbols</div>
        </div>

        <div class="status-card" style="border-left-color: var(--purple);">
            <div class="label">Account</div>
            <div class="value" style="color: var(--purple);">$700</div>
            <div class="detail">Available</div>
        </div>

        <div class="status-card" style="border-left-color: var(--yellow);">
            <div class="label">Max Position</div>
            <div class="value" style="color: var(--yellow);">$50-75</div>
            <div class="detail">1 contract</div>
        </div>

        <div class="status-card" style="border-left-color: var(--red);">
            <div class="label">Daily Risk</div>
            <div class="value" id="dailyRisk" style="color: var(--green);">$0 / $14</div>
            <div class="detail">2% max</div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">
        <!-- Left: Trade Lists -->
        <div>
            <!-- Qualified Trades -->
            <div class="section-header">
                <h2>üéØ QUALIFIED TRADES <span class="subtitle">All 5 criteria met</span></h2>
                <div class="filter-btns">
                    <button class="filter-btn active" onclick="filterTrades('all')" id="btnAll">ALL</button>
                    <button class="filter-btn" onclick="filterTrades('CALL')" id="btnCall">üìà CALLS</button>
                    <button class="filter-btn" onclick="filterTrades('PUT')" id="btnPut">üìâ PUTS</button>
                    <button class="filter-btn" onclick="refreshData()">üîÑ</button>
                </div>
            </div>

            <div class="trades-container" id="qualifiedTrades">
                <div class="empty-state">
                    <div class="icon">‚è≥</div>
                    <h3>Loading...</h3>
                    <p>Fetching qualified setups from 50 symbols</p>
                </div>
            </div>

            <!-- Watching Section -->
            <div class="watching-section">
                <div class="section-header">
                    <h2 style="color: var(--yellow);">‚è≥ WATCHING <span class="subtitle">2-4 criteria met</span></h2>
                </div>

                <div class="watching-container" id="watchingTrades">
                    <div class="empty-state" style="padding: 20px;">
                        <p>Loading watching setups...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Sidebar -->
        <div class="sidebar">
            <!-- Checklist -->
            <div class="checklist-card">
                <div class="checklist-header">
                    <h3>‚úÖ TRADE CHECKLIST</h3>
                    <span class="checklist-symbol" id="checklistSymbol">Click a trade</span>
                </div>

                <div id="checklistRows">
                    <div class="check-row" id="checkRow1">
                        <span class="check-label">1. Trend (Multi-Agent)</span>
                        <span class="check-value" id="checkTrend">‚Äî</span>
                    </div>
                    <div class="check-row" id="checkRow2">
                        <span class="check-label">2. SQ9 Level</span>
                        <span class="check-value" id="checkSQ9">‚Äî</span>
                    </div>
                    <div class="check-row" id="checkRow3">
                        <span class="check-label">3. Candle Pattern</span>
                        <span class="check-value" id="checkCandle">‚Äî</span>
                    </div>
                    <div class="check-row" id="checkRow4">
                        <span class="check-label">4. Time Window</span>
                        <span class="check-value" id="checkTime">‚Äî</span>
                    </div>
                    <div class="check-row" id="checkRow5">
                        <span class="check-label">5. Fib R:R</span>
                        <span class="check-value" id="checkRR">‚Äî</span>
                    </div>
                </div>

                <div class="checklist-result" id="checklistResult">
                    <span style="color: var(--text-dim); font-size: 12px;">Click a trade to see checklist</span>
                </div>
            </div>

            <!-- Research Links -->
            <div class="checklist-card">
                <h3 style="font-size: 14px; margin-bottom: 12px;">üîç RESEARCH</h3>
                <div class="research-links">
                    <a href="index.html#sq9-scanner" class="research-btn">
                        <strong>SQ9 Scanner</strong>
                        <span>All 50 symbols - price levels</span>
                    </a>
                    <a href="index.html#patterns" class="research-btn">
                        <strong>Pattern Scanner</strong>
                        <span>Candle patterns + 3 bar</span>
                    </a>
                    <a href="index.html#signals" class="research-btn">
                        <strong>Multi-TF Signals</strong>
                        <span>Timeframe alignment</span>
                    </a>
                </div>
            </div>

            <!-- Time Windows -->
            <div class="checklist-card">
                <h3 style="font-size: 14px; margin-bottom: 12px;">‚è∞ ENTRY WINDOWS</h3>
                <div class="time-windows">
                    <div class="time-window am">
                        <strong>AM:</strong> 10:00 - 11:30 ET
                    </div>
                    <div class="time-window pm">
                        <strong>PM:</strong> 1:00 - 3:00 ET
                    </div>
                    <div class="current-time-status" id="timeStatus">
                        Checking...
                    </div>
                </div>
            </div>

            <!-- Rules -->
            <div class="rules-card">
                <h3>‚ö†Ô∏è DR. TEE'S RULES</h3>
                <ul>
                    <li><strong>UPTREND = CALLS ONLY</strong></li>
                    <li><strong>DOWNTREND = PUTS ONLY</strong></li>
                    <li>Multi-Agent trend (Mkt 50%)</li>
                    <li>3 bar confirm required</li>
                    <li>Fib entry/stop/target</li>
                    <li>Max $50-75 per trade</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
    // =========================================================================
    // TRADE ACTION CENTER - DR. TEE'S RULES
    // =========================================================================

    let tradeData = {
        qualified: [],
        watching: [],
        marketTrend: 'NEUTRAL',
        lastUpdate: null
    };

    // Load data from SQ9 scanner JSON
    async function loadData() {
        try {
            const response = await fetch('data/sq9_scanner.json?' + Date.now());
            if (!response.ok) throw new Error('Data not found');

            const data = await response.json();

            // Determine market trend from SPY or majority
            const spySetup = data.results.find(r => r.symbol === 'SPY');
            if (spySetup) {
                tradeData.marketTrend = spySetup.direction === 'CALL' ? 'BULLISH' : 'BEARISH';
            } else {
                // Use majority direction
                const calls = data.results.filter(r => r.direction === 'CALL').length;
                const puts = data.results.filter(r => r.direction === 'PUT').length;
                tradeData.marketTrend = calls > puts ? 'BULLISH' : 'BEARISH';
            }

            // Filter qualified (READY + matches trend)
            tradeData.qualified = data.results.filter(r => {
                if (r.status !== 'READY') return false;
                if (tradeData.marketTrend === 'BULLISH' && r.direction !== 'CALL') return false;
                if (tradeData.marketTrend === 'BEARISH' && r.direction !== 'PUT') return false;
                return true;
            });

            // Filter watching
            tradeData.watching = data.results.filter(r => {
                return r.status === 'WATCHING' ||
                       (r.status === 'READY' &&
                        ((tradeData.marketTrend === 'BULLISH' && r.direction === 'PUT') ||
                         (tradeData.marketTrend === 'BEARISH' && r.direction === 'CALL')));
            });

            tradeData.lastUpdate = new Date();

            updateUI();
            console.log('Loaded:', tradeData.qualified.length, 'qualified,', tradeData.watching.length, 'watching');

        } catch (error) {
            console.error('Error loading data:', error);
            document.getElementById('qualifiedTrades').innerHTML =
                '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><h3>Data Not Available</h3><p>Run sq9_scanner.py first</p></div>';
        }
    }

    function updateUI() {
        // Update trend card
        const trendCard = document.getElementById('trendCard');
        const trendValue = document.getElementById('trendValue');
        const trendDetail = document.getElementById('trendDetail');

        if (tradeData.marketTrend === 'BULLISH') {
            trendCard.style.borderLeftColor = 'var(--green)';
            trendValue.style.color = 'var(--green)';
            trendValue.textContent = 'BULLISH';
            trendDetail.textContent = 'CALLS ONLY today';
        } else {
            trendCard.style.borderLeftColor = 'var(--red)';
            trendValue.style.color = 'var(--red)';
            trendValue.textContent = 'BEARISH';
            trendDetail.textContent = 'PUTS ONLY today';
        }

        // Update count
        document.getElementById('qualifiedCount').textContent = tradeData.qualified.length;

        // Update timestamp
        document.getElementById('lastUpdate').textContent = 'Updated: ' + tradeData.lastUpdate.toLocaleTimeString();

        // Render trades
        renderQualifiedTrades(tradeData.qualified);
        renderWatchingTrades(tradeData.watching);

        // Update time status
        updateTimeStatus();
    }

    function renderQualifiedTrades(trades) {
        const container = document.getElementById('qualifiedTrades');

        if (trades.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="icon">üîç</div>
                    <h3>No Qualified Setups</h3>
                    <p>No trades meet all 5 criteria right now.<br>Check WATCHING section below.</p>
                </div>`;
            return;
        }

        container.innerHTML = trades.map((t, idx) => `
            <div class="trade-card" data-idx="${idx}" data-dir="${t.direction}" onclick="selectTrade('qualified', ${idx})">
                <div class="trade-header">
                    <div>
                        <span class="trade-symbol">${t.symbol}</span>
                        <span class="trade-badge ${t.is_etf ? 'badge-etf' : 'badge-stock'}">${t.is_etf ? 'ETF' : 'STOCK'}</span>
                        <span class="trade-direction ${t.direction === 'CALL' ? 'direction-call' : 'direction-put'}">
                            ${t.direction === 'CALL' ? 'üìà' : 'üìâ'} ${t.direction}
                        </span>
                    </div>
                    <div class="trade-score">
                        <div class="number">${t.check_count}/5</div>
                        <div class="label">READY</div>
                    </div>
                </div>

                <div class="trade-metrics">
                    <div class="metric">
                        <div class="label">PRICE</div>
                        <div class="value">${t.price.toFixed(2)}</div>
                    </div>
                    <div class="metric">
                        <div class="label">SQ9</div>
                        <div class="value">${t.sq9_level.toFixed(2)}</div>
                    </div>
                    <div class="metric">
                        <div class="label">DIST</div>
                        <div class="value" style="color: ${Math.abs(t.distance_pct) <= 1.5 ? 'var(--green)' : 'var(--yellow)'}">
                            ${t.distance_pct >= 0 ? '+' : ''}${t.distance_pct.toFixed(1)}%
                        </div>
                    </div>
                    <div class="metric">
                        <div class="label">R:R</div>
                        <div class="value">1:${t.rr_ratio.toFixed(1)}</div>
                    </div>
                </div>

                <div class="trade-targets">
                    <div class="target-box entry">
                        <div class="label">FIB ENTRY</div>
                        <div class="value">${(t.fib_entry || t.price).toFixed(2)}</div>
                    </div>
                    <div class="target-box stop">
                        <div class="label">FIB STOP</div>
                        <div class="value">${(t.fib_stop || t.stop).toFixed(2)}</div>
                    </div>
                    <div class="target-box target">
                        <div class="label">FIB TARGET</div>
                        <div class="value">${(t.fib_target || t.target).toFixed(2)}</div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderWatchingTrades(trades) {
        const container = document.getElementById('watchingTrades');

        if (trades.length === 0) {
            container.innerHTML = '<div class="empty-state" style="padding:20px;"><p>No watching setups</p></div>';
            return;
        }

        let html = '<table class="watching-table"><thead><tr>';
        html += '<th>Symbol</th><th>Dir</th><th>Score</th><th style="color:var(--green)">‚úì Available</th><th style="color:var(--red)">‚úó Missing</th>';
        html += '</tr></thead><tbody>';

        trades.slice(0, 10).forEach((t, idx) => {
            const available = [];
            const missing = [];

            // Check each criterion
            const agreeCount = t.agent_agreement || 1;
            if (agreeCount >= 2) available.push('Trend(' + agreeCount + '/3)');
            else missing.push('Trend');

            if (Math.abs(t.distance_pct) <= 1.5) available.push('SQ9');
            else if (Math.abs(t.distance_pct) <= 3) available.push('SQ9~');
            else missing.push('SQ9');

            if (t.candle_pattern || t.three_bar_valid) available.push('Candle');
            else missing.push('Candle');

            if (isInTradingWindow()) available.push('Time');
            else missing.push('Time');

            if (t.rr_ratio >= 1.5) available.push('R:R');
            else if (t.rr_ratio >= 1.2) available.push('R:R~');
            else missing.push('R:R');

            html += `<tr onclick="selectTrade('watching', ${idx})">
                <td style="font-weight:600;">${t.symbol}</td>
                <td style="color:${t.direction === 'CALL' ? 'var(--green)' : 'var(--red)'}; font-weight:600;">${t.direction}</td>
                <td style="font-weight:600;">${t.check_count}/5</td>
                <td style="font-size:10px;color:var(--green);">${available.join(', ') || '‚Äî'}</td>
                <td style="font-size:10px;color:var(--red);">${missing.join(', ') || '‚Äî'}</td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function selectTrade(type, idx) {
        const trade = type === 'qualified' ? tradeData.qualified[idx] : tradeData.watching[idx];
        if (!trade) return;

        // Update symbol
        const symbolEl = document.getElementById('checklistSymbol');
        symbolEl.textContent = trade.symbol + ' ' + trade.direction;
        symbolEl.style.color = trade.direction === 'CALL' ? 'var(--green)' : 'var(--red)';

        // === CHECK 1: MULTI-AGENT TREND ===
        const row1 = document.getElementById('checkRow1');
        const check1 = document.getElementById('checkTrend');
        const agentCount = trade.agent_agreement || 1;
        const confidence = trade.trend_confidence || 50;
        const mktSignal = trade.market_signal || trade.direction;

        row1.className = 'check-row';
        if (agentCount >= 3) {
            check1.innerHTML = '‚úÖ ULTRA (' + agentCount + '/3)';
            row1.classList.add('pass');
        } else if (agentCount >= 2) {
            check1.innerHTML = '‚úÖ SUPER (' + agentCount + '/3)';
            row1.classList.add('pass');
        } else {
            check1.innerHTML = '‚ö†Ô∏è ' + mktSignal + ' (1/3)';
            row1.classList.add('warn');
        }

        // === CHECK 2: SQ9 LEVEL ===
        const row2 = document.getElementById('checkRow2');
        const check2 = document.getElementById('checkSQ9');
        const dist = Math.abs(trade.distance_pct);

        row2.className = 'check-row';
        if (dist <= 1.5) {
            check2.innerHTML = '‚úÖ AT LEVEL (' + trade.distance_pct.toFixed(1) + '%)';
            row2.classList.add('pass');
        } else if (dist <= 3.0) {
            check2.innerHTML = '‚ö†Ô∏è ' + trade.distance_pct.toFixed(1) + '% (approaching)';
            row2.classList.add('warn');
        } else {
            check2.innerHTML = '‚ùå ' + trade.distance_pct.toFixed(1) + '% (far)';
            row2.classList.add('fail');
        }

        // === CHECK 3: CANDLE PATTERN ===
        const row3 = document.getElementById('checkRow3');
        const check3 = document.getElementById('checkCandle');
        const hasPattern = trade.candle_pattern;
        const has3Bar = trade.three_bar_valid;

        row3.className = 'check-row';
        if (hasPattern && has3Bar) {
            check3.innerHTML = '‚úÖ ' + trade.candle_pattern + ' + 3bar';
            row3.classList.add('pass');
        } else if (hasPattern) {
            check3.innerHTML = '‚úÖ ' + trade.candle_pattern;
            row3.classList.add('pass');
        } else if (has3Bar) {
            const barDesc = trade.direction === 'CALL' ? '3 green‚Üë' : '3 red‚Üì';
            check3.innerHTML = '‚úÖ ' + barDesc;
            row3.classList.add('pass');
        } else {
            check3.innerHTML = '‚ùå No pattern';
            row3.classList.add('fail');
        }

        // === CHECK 4: TIME WINDOW ===
        const row4 = document.getElementById('checkRow4');
        const check4 = document.getElementById('checkTime');
        const timeOK = isInTradingWindow();
        const timeStr = getTimeStatus();

        row4.className = 'check-row';
        if (timeOK) {
            check4.innerHTML = '‚úÖ ' + timeStr;
            row4.classList.add('pass');
        } else {
            check4.innerHTML = '‚è≥ ' + timeStr;
            row4.classList.add('warn');
        }

        // === CHECK 5: FIBONACCI R:R ===
        const row5 = document.getElementById('checkRow5');
        const check5 = document.getElementById('checkRR');
        const rr = trade.rr_ratio;

        row5.className = 'check-row';
        if (rr >= 2.0) {
            check5.innerHTML = '‚úÖ 1:' + rr.toFixed(1) + ' (Excellent)';
            row5.classList.add('pass');
        } else if (rr >= 1.5) {
            check5.innerHTML = '‚úÖ 1:' + rr.toFixed(1) + ' (Good)';
            row5.classList.add('pass');
        } else if (rr >= 1.2) {
            check5.innerHTML = '‚ö†Ô∏è 1:' + rr.toFixed(1) + ' (OK)';
            row5.classList.add('warn');
        } else {
            check5.innerHTML = '‚ùå 1:' + rr.toFixed(1) + ' (Low)';
            row5.classList.add('fail');
        }

        // === RESULT ===
        const result = document.getElementById('checklistResult');
        const checks = [agentCount >= 2, dist <= 1.5, hasPattern || has3Bar, timeOK, rr >= 1.2];
        const passCount = checks.filter(Boolean).length;

        result.className = 'checklist-result';
        if (passCount >= 4 && type === 'qualified') {
            result.classList.add('ready');
            result.innerHTML = `<div style="font-size:15px;font-weight:700;color:var(--green);">‚úÖ ${passCount}/5 READY</div>
                <div style="font-size:11px;color:var(--text-dim);margin-top:6px;">
                    Entry: ${(trade.fib_entry || trade.price).toFixed(2)} |
                    Stop: ${(trade.fib_stop || trade.stop).toFixed(2)} |
                    Target: ${(trade.fib_target || trade.target).toFixed(2)}
                </div>`;
        } else if (passCount >= 3) {
            result.classList.add('watching');
            result.innerHTML = `<div style="font-size:15px;font-weight:700;color:var(--yellow);">‚è≥ ${passCount}/5 ALMOST</div>
                <div style="font-size:11px;color:var(--text-dim);margin-top:6px;">Needs ${5-passCount} more</div>`;
        } else {
            result.classList.add('notready');
            result.innerHTML = `<div style="font-size:15px;font-weight:700;color:var(--red);">‚ùå ${passCount}/5 NOT READY</div>`;
        }

        // Highlight selected
        document.querySelectorAll('.trade-card').forEach(c => c.classList.remove('selected'));
        if (type === 'qualified') {
            document.querySelectorAll('.trade-card')[idx]?.classList.add('selected');
        }
    }

    function isInTradingWindow() {
        const h = new Date().getHours();
        const m = new Date().getMinutes();
        const t = h + m/60;
        return (t >= 10 && t <= 11.5) || (t >= 13 && t <= 15);
    }

    function getTimeStatus() {
        const h = new Date().getHours();
        const m = new Date().getMinutes();
        const t = h + m/60;
        if (t >= 10 && t <= 11.5) return 'AM Window';
        if (t >= 13 && t <= 15) return 'PM Window';
        if (t < 10) return 'Wait 10AM';
        if (t > 11.5 && t < 13) return 'Wait 1PM';
        return 'After hours';
    }

    function updateTimeStatus() {
        const el = document.getElementById('timeStatus');
        const inWindow = isInTradingWindow();
        const status = getTimeStatus();

        if (inWindow) {
            el.textContent = 'üü¢ ' + status + ' - OPEN';
            el.style.background = 'rgba(34,197,94,0.2)';
            el.style.color = 'var(--green)';
        } else {
            el.textContent = '‚è≥ ' + status;
            el.style.background = 'rgba(245,158,11,0.2)';
            el.style.color = 'var(--yellow)';
        }
    }

    function filterTrades(dir) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        // Map dir to button ID: 'all' -> 'btnAll', 'CALL' -> 'btnCall', 'PUT' -> 'btnPut'
        let btnId = 'btnAll';
        if (dir === 'CALL') btnId = 'btnCall';
        else if (dir === 'PUT') btnId = 'btnPut';
        const btn = document.getElementById(btnId);
        if (btn) btn.classList.add('active');

        document.querySelectorAll('.trade-card').forEach(card => {
            if (dir === 'all') {
                card.style.display = 'block';
            } else {
                card.style.display = card.dataset.dir === dir ? 'block' : 'none';
            }
        });
    }

    function refreshData() {
        loadData();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadData();
        updateTimeStatus();

        // Auto-refresh every 60 seconds during market hours
        setInterval(function() {
            const h = new Date().getHours();
            const d = new Date().getDay();
            if (d >= 1 && d <= 5 && h >= 9 && h < 16) {
                loadData();
            }
            updateTimeStatus();
        }, 60000);
    });
    </script>
</body>
</html>
