# Stock Agent 4 - Q5D Daily Analysis
# Fixed version - uses correct agent paths in agents/ folder

name: Q5D Daily Analysis

on:
  schedule:
    # 9:35 AM ET (14:35 UTC during EST, 13:35 UTC during EDT)
    - cron: '35 14 * * 1-5'
    # 4:05 PM ET (21:05 UTC during EST, 20:05 UTC during EDT)  
    - cron: '05 21 * * 1-5'
  
  workflow_dispatch:

# IMPORTANT: Give workflow write permissions
permissions:
  contents: write
  pages: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    env:
      TZ: America/New_York
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests
          pip install tensorflow || echo "TensorFlow optional, continuing..."
          echo "âœ… Dependencies installed"

      - name: ðŸ“‚ Create directories
        run: |
          mkdir -p data
          mkdir -p reports
          mkdir -p logs

      - name: ðŸ” Check available agents
        run: |
          echo "ðŸ“ Available agent files:"
          ls -la agents/

      - name: ðŸ¤– Run Base Agent
        env:
          TIINGO_TOKEN: ${{ secrets.TIINGO_TOKEN }}
        run: |
          echo "ðŸš€ Running Base Agent..."
          echo "Token length: ${#TIINGO_TOKEN}"
          python agents/base_agent.py
          echo "âœ… Base Agent completed"

      - name: ðŸ§  Run DQN Agent
        env:
          TIINGO_TOKEN: ${{ secrets.TIINGO_TOKEN }}
        continue-on-error: true
        run: |
          echo "ðŸ§  Running DQN Agent..."
          python agents/dqn_agent.py || echo "âš ï¸ DQN Agent skipped"

      - name: ðŸ”„ Run Hybrid Engine
        env:
          TIINGO_TOKEN: ${{ secrets.TIINGO_TOKEN }}
        run: |
          echo "ðŸ”„ Running Hybrid Engine..."
          python agents/hybrid_engine.py
          echo "âœ… Hybrid Engine completed"

      - name: ðŸ“Š Show results
        run: |
          echo "ðŸ“ Data folder:"
          ls -la data/ 2>/dev/null || echo "No data folder"
          echo ""
          echo "ðŸ“ Reports folder:"
          ls -la reports/ 2>/dev/null || echo "No reports folder"
          echo ""
          echo "ðŸ“‹ Last 3 lines of SPY.csv:"
          tail -3 data/SPY.csv 2>/dev/null || tail -3 SPY.csv 2>/dev/null || echo "SPY.csv not found"

      - name: ðŸ“¤ Commit and push to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Pull latest changes first
          git pull origin main --rebase || git pull origin main || true
          
          # Add all data files
          git add data/ reports/ logs/ *.csv *.json 2>/dev/null || true
          git add -A || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "ðŸ¤– Agent update: $(date '+%Y-%m-%d %H:%M ET')"
            git push origin main || {
              git pull origin main --rebase
              git push origin main
            }
            echo "âœ… Pushed to main"
          fi

      - name: ðŸŒ Update gh-pages branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Save data files
          mkdir -p /tmp/data-backup
          cp data/*.csv /tmp/data-backup/ 2>/dev/null || true
          cp reports/*.csv /tmp/data-backup/ 2>/dev/null || true
          cp *.csv /tmp/data-backup/ 2>/dev/null || true
          
          # Fetch and checkout gh-pages
          git fetch origin gh-pages:gh-pages || true
          git checkout gh-pages || git checkout -b gh-pages
          git pull origin gh-pages || true
          
          # Copy CSV files
          cp /tmp/data-backup/*.csv . 2>/dev/null || true
          
          git add *.csv 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No CSV changes"
          else
            git commit -m "ðŸ“Š Data: $(date '+%Y-%m-%d %H:%M ET')"
            git push origin gh-pages || git push origin gh-pages --force
            echo "âœ… Pushed to gh-pages"
          fi
          
          git checkout main

      - name: ðŸ“ Summary
        run: |
          echo "## ðŸ¤– Stock Agent Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date '+%Y-%m-%d %H:%M:%S ET')" >> $GITHUB_STEP_SUMMARY
          echo "### Agents Run:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Base Agent (agents/base_agent.py)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§  DQN Agent (agents/dqn_agent.py)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Hybrid Engine (agents/hybrid_engine.py)" >> $GITHUB_STEP_SUMMARY
