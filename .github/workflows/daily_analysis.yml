# Stock Agent 4 - Q5D Daily Analysis
# Fixed version - handles git push conflicts properly

name: Q5D Daily Analysis

on:
  schedule:
    # 9:35 AM ET (14:35 UTC during EST, 13:35 UTC during EDT)
    - cron: '35 14 * * 1-5'
    # 4:05 PM ET (21:05 UTC during EST, 20:05 UTC during EDT)  
    - cron: '05 21 * * 1-5'
  
  workflow_dispatch:

# IMPORTANT: Give workflow write permissions
permissions:
  contents: write
  pages: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    env:
      TZ: America/New_York
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests

      - name: ðŸ“‚ Create directories
        run: |
          mkdir -p data
          mkdir -p reports
          mkdir -p logs

      - name: ðŸ¤– Run Stock Agent
        env:
          TIINGO_TOKEN: ${{ secrets.TIINGO_TOKEN }}
        run: |
          echo "ðŸš€ Starting Stock Agent..."
          echo "Token length: ${#TIINGO_TOKEN}"
          python agent_FIXED.py
          echo "âœ… Agent completed"

      - name: ðŸ“Š Show results
        run: |
          echo "ðŸ“ Output files:"
          ls -la data/ || echo "No data folder"
          ls -la reports/ || echo "No reports folder"
          
          echo ""
          echo "ðŸ“‹ Last 3 lines of SPY.csv:"
          tail -3 data/SPY.csv || echo "File not found"

      - name: ðŸ“¤ Commit and push to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Pull latest changes first to avoid conflicts
          git pull origin main --rebase || git pull origin main --no-rebase || true
          
          # Add files
          git add data/ reports/ logs/ || true
          git add -A || true
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "ðŸ¤– Agent update: $(date '+%Y-%m-%d %H:%M ET')"
            
            # Push with retry
            git push origin main || {
              echo "âš ï¸ Push failed, trying with pull..."
              git pull origin main --rebase
              git push origin main
            }
            echo "âœ… Pushed to main"
          fi

      - name: ðŸŒ Update gh-pages branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Save data files
          mkdir -p /tmp/data-backup
          cp data/*.csv /tmp/data-backup/ 2>/dev/null || true
          cp reports/*.csv /tmp/data-backup/ 2>/dev/null || true
          
          # Fetch and checkout gh-pages
          git fetch origin gh-pages:gh-pages || true
          git checkout gh-pages || git checkout -b gh-pages
          
          # Pull latest gh-pages
          git pull origin gh-pages --rebase || git pull origin gh-pages || true
          
          # Copy CSV files (keep index.html intact)
          cp /tmp/data-backup/*.csv . 2>/dev/null || true
          
          # Commit and push
          git add *.csv || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No CSV changes for gh-pages"
          else
            git commit -m "ðŸ“Š Data: $(date '+%Y-%m-%d %H:%M ET')"
            git push origin gh-pages || {
              echo "âš ï¸ Push failed, force pushing..."
              git push origin gh-pages --force
            }
            echo "âœ… Data pushed to gh-pages"
          fi
          
          # Return to main
          git checkout main

      - name: ðŸ“ Summary
        run: |
          echo "## ðŸ¤– Stock Agent Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date '+%Y-%m-%d %H:%M:%S ET')" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/SPY.csv" ]; then
            LAST_LINE=$(tail -1 data/SPY.csv)
            LAST_DATE=$(echo "$LAST_LINE" | cut -d',' -f1)
            LAST_CLOSE=$(echo "$LAST_LINE" | cut -d',' -f5)
            LAST_BIAS=$(echo "$LAST_LINE" | cut -d',' -f10)
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Latest Data" >> $GITHUB_STEP_SUMMARY
            echo "- **Date:** $LAST_DATE" >> $GITHUB_STEP_SUMMARY
            echo "- **Close:** \$${LAST_CLOSE}" >> $GITHUB_STEP_SUMMARY
            echo "- **Signal:** $LAST_BIAS" >> $GITHUB_STEP_SUMMARY
          fi
