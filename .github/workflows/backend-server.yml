name: Fetch Tiingo Data & Deploy Dashboard

on:
  schedule:
    - cron: '30 14 * * 1-5'  # 9:30 AM ET weekdays
    - cron: '30 21 * * 1-5'  # 4:30 PM ET weekdays
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  fetch-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install pandas requests
      
      - name: Fetch Tiingo Data
        env:
          TIINGO_TOKEN: ${{ secrets.TIINGO_TOKEN }}
        run: |
          python << 'EOF'
          import os, json, requests
          from datetime import datetime, timedelta
          
          token = os.environ.get('TIINGO_TOKEN', '')
          os.makedirs('data', exist_ok=True)
          
          status = {
              "timestamp": datetime.now().isoformat(),
              "tiingo_connected": False,
              "message": "",
              "spy_price": None,
              "spy_change": None,
              "last_bar_date": None,
              "bar_count": 0
          }
          
          try:
              # Test connection
              r = requests.get(f"https://api.tiingo.com/api/test?token={token}", timeout=30)
              if r.status_code == 200:
                  status["tiingo_connected"] = True
                  status["message"] = "Connected"
                  print("✓ Tiingo API connected")
                  
                  # Fetch SPY daily data
                  start = (datetime.now() - timedelta(days=800)).strftime("%Y-%m-%d")
                  r2 = requests.get(f"https://api.tiingo.com/tiingo/daily/SPY/prices?startDate={start}&token={token}", timeout=60)
                  if r2.status_code == 200:
                      bars = r2.json()
                      status["bar_count"] = len(bars)
                      if bars:
                          latest = bars[-1]
                          prev = bars[-2] if len(bars) > 1 else latest
                          status["spy_price"] = latest.get("close")
                          status["spy_change"] = round(latest.get("close", 0) - prev.get("close", 0), 2)
                          status["last_bar_date"] = latest.get("date", "")[:10]
                          print(f"✓ Fetched {len(bars)} bars, latest: {status['last_bar_date']}")
              else:
                  status["message"] = f"HTTP {r.status_code}"
          except Exception as e:
              status["message"] = str(e)
              print(f"✗ Error: {e}")
          
          with open('data/api_status.json', 'w') as f:
              json.dump(status, f, indent=2)
          print("✓ Saved data/api_status.json")
          EOF
      
      - name: Run Confluence Agent
        env:
          TIINGO_TOKEN: ${{ secrets.TIINGO_TOKEN }}
        run: python agent_FIXED.py || echo "Agent completed with warnings"
      
      - name: Prepare Deploy
        run: |
          mkdir -p deploy/data deploy/reports
          cp index.html deploy/
          cp -r data/* deploy/data/ 2>/dev/null || true
          cp -r reports/* deploy/reports/ 2>/dev/null || true
          echo "Deploy contents:"
          find deploy -type f
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          publish_branch: gh-pages
          force_orphan: true
