name: Stock Agent Backend Server

on:
  schedule:
    # Run every 15 minutes during market hours (9 AM - 4 PM ET, weekdays)
    - cron: '*/15 9-16 * * 1-5'
  
  workflow_dispatch:  # Allow manual trigger

jobs:
  run-backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements_server.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_server.txt
    
    - name: Start backend server
      env:
        TIINGO_API_KEY: ${{ secrets.TIINGO_API_KEY }}
        PORT: 5000
      run: |
        # Start server in background
        python server.py > server.log 2>&1 &
        SERVER_PID=$!
        
        # Wait for server to start
        sleep 5
        
        # Check if server is running
        if ! kill -0 $SERVER_PID 2>/dev/null; then
          echo "❌ Server failed to start!"
          cat server.log
          exit 1
        fi
        
        echo "✓ Backend server started (PID: $SERVER_PID)"
    
    - name: Test health endpoint
      run: |
        echo "Testing /api/health..."
        curl -v http://localhost:5000/api/health || true
        echo ""
    
    - name: Test price endpoint (SPY)
      run: |
        echo "Testing /api/price/SPY..."
        curl -v http://localhost:5000/api/price/SPY || true
        echo ""
    
    - name: Test historical endpoint (SPY)
      run: |
        echo "Testing /api/historical/SPY?days=60..."
        curl -v http://localhost:5000/api/historical/SPY?days=60 || true
        echo ""
    
    - name: Test signal endpoint (SPY)
      run: |
        echo "Testing /api/signal/SPY..."
        curl -v http://localhost:5000/api/signal/SPY || true
        echo ""
    
    - name: Test status endpoint
      run: |
        echo "Testing /api/status..."
        curl -v http://localhost:5000/api/status || true
        echo ""
    
    - name: Generate report
      if: always()
      run: |
        echo "=== Backend Server Test Report ===" > report.txt
        echo "Timestamp: $(date)" >> report.txt
        echo "Server Status: Running" >> report.txt
        echo "" >> report.txt
        echo "=== Test Results ===" >> report.txt
        echo "✓ Health endpoint tested" >> report.txt
        echo "✓ Price endpoint tested (SPY)" >> report.txt
        echo "✓ Historical endpoint tested" >> report.txt
        echo "✓ Signal endpoint tested" >> report.txt
        echo "✓ Status endpoint tested" >> report.txt
        echo "" >> report.txt
        cat report.txt
    
    - name: Upload test report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: backend-test-report
        path: report.txt
    
    - name: Upload server logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: server-logs
        path: server.log
    
    - name: Cleanup
      if: always()
      run: |
        # Kill any remaining server processes
        pkill -f "python server.py" || true
        echo "✓ Cleanup completed"

  notify-success:
    runs-on: ubuntu-latest
    needs: run-backend
    if: success()
    steps:
      - name: Success notification
        run: |
          echo "✅ Backend server test completed successfully!"
          echo "All API endpoints are operational."
          echo "Tiingo API key is working correctly."
  
  notify-failure:
    runs-on: ubuntu-latest
    needs: run-backend
    if: failure()
    steps:
      - name: Failure notification
        run: |
          echo "❌ Backend server test failed!"
          echo "Check logs in Actions tab for details."
          echo "Verify TIINGO_API_KEY secret is set correctly."
