<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SPY Trading Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050814;
      --card: #111827;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.1);
      --danger: #f97373;
      --success: #4ade80;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Arial, sans-serif;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px;
      font-family: var(--font-sans);
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text);
    }

    h1,
    h2,
    h3 {
      margin: 0 0 8px;
      font-weight: 600;
    }

    a {
      color: var(--accent);
    }

    .container {
      max-width: 1120px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 12px;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-bottom: 24px;
    }

    .card {
      background: radial-gradient(circle at top left, #1f2937 0, #020617 70%);
      border-radius: 16px;
      padding: 14px 16px;
      border: 1px solid var(--border);
      box-shadow: 0 16px 30px rgba(0, 0, 0, 0.4);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }

    .card-label {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .card-value {
      font-size: 22px;
      font-weight: 600;
    }

    .card-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid var(--border);
      background: #030712;
    }

    .pill-success {
      border-color: var(--success);
      color: var(--success);
    }

    .pill-danger {
      border-color: var(--danger);
      color: var(--danger);
    }

    .pill-neutral {
      border-color: var(--muted);
      color: var(--muted);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 18px;
      margin-bottom: 24px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: #020617;
      border-radius: 16px;
      padding: 16px;
      border: 1px solid var(--border);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
    }

    canvas {
      width: 100%;
      height: 260px;
      display: block;
      border-radius: 10px;
      background: radial-gradient(circle at top, #020617 0, #030712 70%);
    }

    .table-wrapper {
      max-height: 330px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #020617;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th,
    td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid #111827;
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      color: var(--muted);
      position: sticky;
      top: 0;
    }

    tbody tr:nth-child(even) {
      background: #020617;
    }

    tbody tr:nth-child(odd) {
      background: #030712;
    }

    .mono {
      font-family: var(--font-mono);
    }

    .right {
      text-align: right;
    }

    .pnl-pos {
      color: var(--success);
    }

    .pnl-neg {
      color: var(--danger);
    }

    .section {
      margin-top: 8px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      font-size: 12px;
    }

    .controls label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--muted);
    }

    .controls input {
      width: 64px;
      padding: 3px 5px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      font-size: 12px;
      font-family: var(--font-mono);
    }

    .button {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 12px;
      cursor: pointer;
    }

    .button:hover {
      background: rgba(56, 189, 248, 0.18);
    }

    .footer {
      margin-top: 12px;
      font-size: 11px;
      color: var(--muted);
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="badge">
          <span class="badge-dot"></span>
          SPY Puts & Calls Agent
        </div>
        <h1>SPY Trading Dashboard</h1>
        <div class="muted">
          Powered by Tiingo data · Signals generated locally from
          <strong>SPY.csv</strong>
        </div>
      </div>
      <div style="text-align:right">
        <div class="card-label">Data File</div>
        <div class="muted mono">web/data/SPY.csv</div>
        <div id="dataStatus" class="card-sub"></div>
      </div>
    </div>

    <div class="cards">
      <div class="card">
        <div class="card-header">
          <div class="card-label">Latest Close</div>
          <div id="lastDate" class="muted mono"></div>
        </div>
        <div id="lastPrice" class="card-value mono">–</div>
        <div id="lastChange" class="card-sub"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-label">Last Signal</div>
          <span id="lastSignalPill" class="pill pill-neutral">Waiting…</span>
        </div>
        <div id="lastSignal" class="card-value">–</div>
        <div id="lastSignalDetail" class="card-sub"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-label">Win / Loss</div>
          <span class="pill" id="tradeCountLabel">0 trades</span>
        </div>
        <div id="winLoss" class="card-value mono">0 / 0</div>
        <div id="winRate" class="card-sub">Win rate –</div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-label">Total P&amp;L (Index Points)</div>
          <span class="pill" id="holdingLabel">Hold 5 days</span>
        </div>
        <div id="totalPnl" class="card-value mono">0.00</div>
        <div id="avgPnl" class="card-sub">Avg P&amp;L per trade –</div>
      </div>
    </div>

    <div class="layout">
      <div class="panel">
        <div class="panel-header">
          <div>
            <h2>Price Chart</h2>
            <div class="muted">Last 60 trading days · SPY close</div>
          </div>
          <div class="controls">
            <label>
              Fast SMA
              <input type="number" id="fastLen" value="5" min="2" max="50" />
            </label>
            <label>
              Slow SMA
              <input type="number" id="slowLen" value="20" min="5" max="100" />
            </label>
            <label>
              Hold (days)
              <input type="number" id="holdDays" value="5" min="1" max="20" />
            </label>
            <button class="button" id="recalcBtn">Recalculate</button>
          </div>
        </div>
        <canvas id="priceChart"></canvas>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div>
            <h2>Backtest Summary</h2>
            <div class="muted">
              Simple rule: Fast SMA crossing Slow SMA generates CALL / PUT,
              held for N days.
            </div>
          </div>
        </div>

        <div class="section">
          <div class="muted" style="margin-bottom:4px">Key metrics</div>
          <table>
            <tbody>
              <tr>
                <td>Trades</td>
                <td class="right mono" id="metricTrades">0</td>
              </tr>
              <tr>
                <td>Calls</td>
                <td class="right mono" id="metricCalls">0</td>
              </tr>
              <tr>
                <td>Puts</td>
                <td class="right mono" id="metricPuts">0</td>
              </tr>
              <tr>
                <td>Median P&amp;L</td>
                <td class="right mono" id="metricMedian">–</td>
              </tr>
              <tr>
                <td>Max Drawdown (per trade)</td>
                <td class="right mono" id="metricMaxDD">–</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div>
          <h2>Trade Log</h2>
          <div class="muted">Generated locally from SMA rule on SPY closes</div>
        </div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Signal</th>
              <th>Entry</th>
              <th>Exit</th>
              <th>Exit Date</th>
              <th>P&amp;L</th>
            </tr>
          </thead>
          <tbody id="tradeBody"></tbody>
        </table>
      </div>
      <div class="footer">
        For testing only. Not investment advice. Compare signals with your own
        thesis before trading.
      </div>
    </div>
  </div>

  <script>
    async function loadCSV(url) {
      const resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) throw new Error("Failed to load CSV: " + resp.status);
      const text = await resp.text();
      return parseCSV(text);
    }

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      const header = lines[0].split(",");
      const idx = (name) => header.indexOf(name);
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(",");
        if (cols.length < 5) continue;
        rows.push({
          date: cols[idx("Date")],
          open: +cols[idx("Open")],
          high: +cols[idx("High")],
          low: +cols[idx("Low")],
          close: +cols[idx("Close")],
          volume: idx("Volume") >= 0 ? +cols[idx("Volume")] : 0,
        });
      }
      return rows.sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    function computeSMA(values, length) {
      const out = new Array(values.length).fill(null);
      let sum = 0;
      for (let i = 0; i < values.length; i++) {
        sum += values[i];
        if (i >= length) sum -= values[i - length];
        if (i >= length - 1) out[i] = sum / length;
      }
      return out;
    }

    function generateTrades(data, fastLen, slowLen, holdDays) {
      const closes = data.map((d) => d.close);
      const fast = computeSMA(closes, fastLen);
      const slow = computeSMA(closes, slowLen);
      const trades = [];

      let lastSignal = null;

      for (let i = 1; i < data.length; i++) {
        if (!fast[i] || !slow[i] || !fast[i - 1] || !slow[i - 1]) continue;

        const prevDiff = fast[i - 1] - slow[i - 1];
        const diff = fast[i] - slow[i];

        let signal = null;
        if (prevDiff <= 0 && diff > 0) {
          signal = "CALL";
        } else if (prevDiff >= 0 && diff < 0) {
          signal = "PUT";
        }

        if (!signal || signal === lastSignal) continue;
        lastSignal = signal;

        const entryIdx = i;
        const entryBar = data[entryIdx];
        const entryPrice = entryBar.close;

        const exitIdx = Math.min(data.length - 1, entryIdx + holdDays);
        const exitBar = data[exitIdx];
        const exitPrice = exitBar.close;

        const pnl =
          signal === "CALL" ? exitPrice - entryPrice : entryPrice - exitPrice;

        trades.push({
          date: entryBar.date,
          direction: signal,
          entry: entryPrice,
          exit: exitPrice,
          exitDate: exitBar.date,
          pnl,
        });
      }
      return trades;
    }

    function summaryStats(trades) {
      const wins = trades.filter((t) => t.pnl > 0);
      const losses = trades.filter((t) => t.pnl < 0);
      const totalPnl = trades.reduce((a, t) => a + t.pnl, 0);
      const winRate = trades.length
        ? (wins.length / trades.length) * 100
        : 0.0;
      const sortedPnL = trades
        .map((t) => t.pnl)
        .slice()
        .sort((a, b) => a - b);
      let median = null;
      if (sortedPnL.length) {
        const mid = Math.floor(sortedPnL.length / 2);
        median =
          sortedPnL.length % 2
            ? sortedPnL[mid]
            : (sortedPnL[mid - 1] + sortedPnL[mid]) / 2;
      }
      const maxDD = trades.length
        ? Math.min(...trades.map((t) => t.pnl))
        : null;

      return {
        wins: wins.length,
        losses: losses.length,
        trades: trades.length,
        totalPnl,
        winRate,
        median,
        maxDD,
      };
    }

    function drawChart(canvas, data) {
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (!data.length) return;

      const subset = data.slice(-60);
      const prices = subset.map((d) => d.close);
      const minP = Math.min(...prices);
      const maxP = Math.max(...prices);
      const pad = (maxP - minP || 1) * 0.1;

      const left = 40;
      const right = canvas.width - 10;
      const top = 10;
      const bottom = canvas.height - 20;

      ctx.strokeStyle = "#1f2937";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(left, top);
      ctx.lineTo(left, bottom);
      ctx.lineTo(right, bottom);
      ctx.stroke();

      ctx.strokeStyle = "#38bdf8";
      ctx.lineWidth = 1.6;
      ctx.beginPath();
      subset.forEach((d, idx) => {
        const x =
          left +
          (idx / Math.max(1, subset.length - 1)) * (right - left - 5);
        const v = d.close;
        const y =
          bottom -
          ((v - (minP - pad)) / (maxP - minP + 2 * pad)) * (bottom - top);
        if (idx === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    async function main() {
      const statusEl = document.getElementById("dataStatus");
      const lastDateEl = document.getElementById("lastDate");
      const lastPriceEl = document.getElementById("lastPrice");
      const lastChangeEl = document.getElementById("lastChange");
      const lastSignalEl = document.getElementById("lastSignal");
      const lastSignalDetailEl = document.getElementById("lastSignalDetail");
      const lastSignalPill = document.getElementById("lastSignalPill");
      const winLossEl = document.getElementById("winLoss");
      const winRateEl = document.getElementById("winRate");
      const totalPnlEl = document.getElementById("totalPnl");
      const avgPnlEl = document.getElementById("avgPnl");
      const tradeCountLabel = document.getElementById("tradeCountLabel");
      const holdingLabel = document.getElementById("holdingLabel");
      const tradeBody = document.getElementById("tradeBody");
      const metricTrades = document.getElementById("metricTrades");
      const metricCalls = document.getElementById("metricCalls");
      const metricPuts = document.getElementById("metricPuts");
      const metricMedian = document.getElementById("metricMedian");
      const metricMaxDD = document.getElementById("metricMaxDD");

      let data;
      try {
        data = await loadCSV("./data/SPY.csv");
      } catch (e) {
        statusEl.textContent = "Could not load SPY.csv – check workflow run.";
        console.error(e);
        return;
      }

      if (!data.length) {
        statusEl.textContent = "SPY.csv is empty.";
        return;
      }

      statusEl.textContent =
        data.length +
        " rows · from " +
        data[0].date +
        " to " +
        data[data.length - 1].date;

      const last = data[data.length - 1];
      lastDateEl.textContent = last.date;
      lastPriceEl.textContent = last.close.toFixed(2);

      const prev = data[data.length - 2] || last;
      const diff = last.close - prev.close;
      const pct = (diff / prev.close) * 100;
      const sign = diff > 0 ? "+" : diff < 0 ? "−" : "";
      lastChangeEl.textContent =
        (sign || "") +
        Math.abs(diff).toFixed(2) +
        " (" +
        (sign || "") +
        Math.abs(pct).toFixed(2) +
        "% vs prev close)";

      const canvas = document.getElementById("priceChart");
      const resizeCanvas = () => {
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * window.devicePixelRatio;
        canvas.height = rect.height * window.devicePixelRatio;
        drawChart(canvas, data);
      };
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      function recompute() {
        const fastLen = parseInt(
          document.getElementById("fastLen").value,
          10
        );
        const slowLen = parseInt(
          document.getElementById("slowLen").value,
          10
        );
        const holdDays = parseInt(
          document.getElementById("holdDays").value,
          10
        );

        holdingLabel.textContent = "Hold " + holdDays + " days";

        const trades = generateTrades(data, fastLen, slowLen, holdDays);
        const stats = summaryStats(trades);

        tradeBody.innerHTML = "";
        trades.forEach((t) => {
          const tr = document.createElement("tr");
          const pnlClass = t.pnl >= 0 ? "pnl-pos" : "pnl-neg";
          tr.innerHTML = `
            <td class="mono">${t.date}</td>
            <td>${t.direction}</td>
            <td class="mono right">${t.entry.toFixed(2)}</td>
            <td class="mono right">${t.exit.toFixed(2)}</td>
            <td class="mono">${t.exitDate}</td>
            <td class="mono right ${pnlClass}">${t.pnl.toFixed(2)}</td>
          `;
          tradeBody.appendChild(tr);
        });

        const lastTrade = trades[trades.length - 1] || null;
        if (lastTrade) {
          lastSignalEl.textContent = lastTrade.direction;
          lastSignalDetailEl.textContent =
            "Entry " +
            lastTrade.entry.toFixed(2) +
            " on " +
            lastTrade.date +
            ", exit " +
            lastTrade.exit.toFixed(2) +
            " on " +
            lastTrade.exitDate +
            ".";
          lastSignalPill.textContent =
            lastTrade.direction === "CALL" ? "Bias: CALL" : "Bias: PUT";
          lastSignalPill.className =
            "pill " +
            (lastTrade.direction === "CALL"
              ? "pill-success"
              : "pill-danger");
        } else {
          lastSignalEl.textContent = "No signals";
          lastSignalDetailEl.textContent =
            "Insufficient crossovers for chosen parameters.";
          lastSignalPill.textContent = "Neutral";
          lastSignalPill.className = "pill pill-neutral";
        }

        winLossEl.textContent =
          stats.wins.toString() + " / " + stats.losses.toString();
        winRateEl.textContent =
          "Win rate " + stats.winRate.toFixed(1) + "%";

        totalPnlEl.textContent = stats.totalPnl.toFixed(2);
        avgPnlEl.textContent =
          stats.trades > 0
            ? "Avg " + (stats.totalPnl / stats.trades).toFixed(2) + " per trade"
            : "Avg P&L per trade –";

        tradeCountLabel.textContent =
          stats.trades.toString() + " trades tested";

        metricTrades.textContent = stats.trades.toString();
        metricCalls.textContent = trades
          .filter((t) => t.direction === "CALL")
          .length.toString();
        metricPuts.textContent = trades
          .filter((t) => t.direction === "PUT")
          .length.toString();
        metricMedian.textContent =
          stats.median === null ? "–" : stats.median.toFixed(2);
        metricMaxDD.textContent =
          stats.maxDD === null ? "–" : stats.maxDD.toFixed(2);
      }

      document
        .getElementById("recalcBtn")
        .addEventListener("click", recompute);

      recompute();
    }

    main().catch((e) => {
      console.error(e);
    });
  </script>
</body>
</html>

