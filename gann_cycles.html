<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gann Cycle Trading Dashboard</title>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .header h1 {
            font-size: 28px;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #888;
            font-size: 14px;
        }

        .header .last-update {
            color: #666;
            font-size: 12px;
            margin-top: 10px;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: rgba(34,197,94,0.2);
            border: 1px solid rgba(34,197,94,0.5);
            border-radius: 20px;
            font-size: 11px;
            color: #22c55e;
            margin-left: 10px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: #888;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title .icon {
            font-size: 18px;
        }

        /* Alert Cards */
        .alert-card {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .alert-card:hover {
            transform: scale(1.02);
        }

        .alert-critical {
            background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(239,68,68,0.1));
            border: 1px solid rgba(239,68,68,0.5);
            animation: alertPulse 2s infinite;
        }

        @keyframes alertPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
            50% { box-shadow: 0 0 20px 5px rgba(239,68,68,0.2); }
        }

        .alert-warning {
            background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(245,158,11,0.1));
            border: 1px solid rgba(245,158,11,0.5);
        }

        .alert-info {
            background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(59,130,246,0.1));
            border: 1px solid rgba(59,130,246,0.5);
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.1));
            border: 1px solid rgba(34,197,94,0.5);
        }

        .alert-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-subtitle {
            font-size: 12px;
            color: #999;
        }

        .alert-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .badge-critical { background: #ef4444; color: white; }
        .badge-warning { background: #f59e0b; color: white; }
        .badge-info { background: #3b82f6; color: white; }
        .badge-success { background: #22c55e; color: white; }

        /* Cycle Progress */
        .cycle-progress {
            margin-bottom: 15px;
        }

        .cycle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .cycle-name {
            font-size: 13px;
            font-weight: 500;
        }

        .cycle-days {
            font-size: 12px;
            color: #888;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .progress-normal { background: linear-gradient(90deg, #3b82f6, #8b5cf6); }
        .progress-warning { background: linear-gradient(90deg, #f59e0b, #ef4444); }
        .progress-critical { background: linear-gradient(90deg, #ef4444, #dc2626); }

        /* Price Cards */
        .price-card {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            transition: all 0.3s;
        }

        .price-card.price-up {
            background: rgba(34,197,94,0.1);
            border: 1px solid rgba(34,197,94,0.3);
        }

        .price-card.price-down {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
        }

        .price-symbol {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .price-value {
            font-size: 22px;
            font-weight: 700;
        }

        .price-change {
            font-size: 12px;
            margin-top: 5px;
        }

        .price-change.up { color: #22c55e; }
        .price-change.down { color: #ef4444; }

        /* Pivot Cards */
        .pivot-card {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .pivot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .pivot-type {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .pivot-high { background: rgba(239,68,68,0.2); color: #f87171; }
        .pivot-low { background: rgba(34,197,94,0.2); color: #4ade80; }

        .pivot-info {
            text-align: right;
        }

        .pivot-date {
            font-size: 14px;
            font-weight: 600;
        }

        .pivot-price {
            font-size: 12px;
            color: #888;
        }

        .cycle-timeline {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .cycle-dot {
            text-align: center;
            flex: 1;
            min-width: 50px;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .cycle-dot:hover {
            background: rgba(255,255,255,0.1);
        }

        .cycle-dot .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin: 0 auto 4px;
        }

        .dot-done { background: #22c55e; }
        .dot-active { background: #ef4444; animation: pulse 1s infinite; }
        .dot-future { background: #4b5563; }

        .cycle-dot .label {
            font-size: 10px;
            color: #888;
        }

        .cycle-dot .date {
            font-size: 9px;
            color: #666;
        }

        .cycle-dot .result {
            font-size: 8px;
            margin-top: 2px;
        }

        /* Trade Recommendation */
        .trade-rec {
            background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(59,130,246,0.1));
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(124,58,237,0.3);
        }

        .trade-signal {
            text-align: center;
            margin-bottom: 15px;
        }

        .signal-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .signal-value {
            font-size: 32px;
            font-weight: 700;
        }

        .signal-buy { color: #22c55e; }
        .signal-sell { color: #ef4444; }
        .signal-wait { color: #f59e0b; }
        .signal-caution { color: #f97316; }

        .signal-reason {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .trade-details {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
        }

        .trade-section-title {
            font-size: 11px;
            font-weight: 600;
            color: #888;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .trade-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 13px;
        }

        .trade-row:last-child {
            border-bottom: none;
        }

        .trade-row .label {
            color: #888;
        }

        .trade-row .value {
            font-weight: 500;
        }

        /* Sq9 Levels */
        .sq9-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .sq9-section {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 12px;
        }

        .sq9-title {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sq9-support .sq9-title { color: #4ade80; }
        .sq9-resist .sq9-title { color: #f87171; }

        .sq9-level {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .sq9-level:last-child {
            border-bottom: none;
        }

        .sq9-level.near-level {
            background: rgba(34,197,94,0.1);
            margin: 0 -8px;
            padding: 8px;
            border-radius: 6px;
        }

        .sq9-level .angle {
            color: #888;
        }

        .sq9-level .price {
            font-weight: 500;
        }

        .sq9-level .distance {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
        }

        .sq9-level .distance.close {
            background: rgba(34,197,94,0.2);
            color: #4ade80;
        }

        .sq9-alert {
            margin-top: 12px;
            padding: 12px;
            background: rgba(34,197,94,0.1);
            border-radius: 8px;
            border: 1px solid rgba(34,197,94,0.3);
            font-size: 12px;
            color: #4ade80;
        }

        /* Multi-ETF Table */
        .etf-table {
            width: 100%;
            border-collapse: collapse;
        }

        .etf-table th {
            text-align: left;
            padding: 12px 10px;
            font-size: 11px;
            color: #888;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-transform: uppercase;
        }

        .etf-table td {
            padding: 15px 10px;
            font-size: 13px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .etf-table tr:hover {
            background: rgba(255,255,255,0.03);
        }

        .etf-symbol {
            font-weight: 600;
            color: #fff;
            font-size: 15px;
        }

        .etf-price {
            font-weight: 500;
        }

        .cycle-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .signal-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .signal-badge.buy { background: rgba(34,197,94,0.2); color: #22c55e; }
        .signal-badge.sell { background: rgba(239,68,68,0.2); color: #ef4444; }
        .signal-badge.wait { background: rgba(245,158,11,0.2); color: #f59e0b; }
        .signal-badge.caution { background: rgba(249,115,22,0.2); color: #f97316; }

        /* Trade Journal */
        .journal-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s;
        }

        .journal-entry:hover {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.1);
        }

        .journal-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .journal-result {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .result-win { background: rgba(34,197,94,0.2); }
        .result-loss { background: rgba(239,68,68,0.2); }
        .result-open { background: rgba(59,130,246,0.2); }

        .journal-info .symbol {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 3px;
        }

        .journal-info .details {
            font-size: 12px;
            color: #888;
        }

        .journal-info .signal-type {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }

        .journal-pnl {
            text-align: right;
        }

        .pnl-amount {
            font-weight: 600;
            font-size: 16px;
        }

        .pnl-positive { color: #22c55e; }
        .pnl-negative { color: #ef4444; }
        .pnl-open { color: #3b82f6; }

        .pnl-percent {
            font-size: 12px;
            color: #888;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-box {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 11px;
            color: #888;
        }

        /* Full Width Sections */
        .full-width {
            grid-column: 1 / -1;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(255,255,255,0.1);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 6px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 14px;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102,126,234,0.4);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        /* Alert Settings */
        .alert-settings {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 15px;
        }

        .alert-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .alert-option {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            padding: 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
        }

        .alert-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Calendar */
        .calendar-container {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
        }

        .calendar-header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-month {
            font-size: 16px;
            font-weight: 600;
        }

        .calendar-nav-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-header {
            text-align: center;
            font-size: 11px;
            color: #666;
            padding: 8px 0;
        }

        .calendar-day {
            text-align: center;
            padding: 10px 5px;
            font-size: 12px;
            border-radius: 6px;
            background: rgba(255,255,255,0.03);
            cursor: pointer;
            position: relative;
        }

        .calendar-day:hover {
            background: rgba(255,255,255,0.1);
        }

        .calendar-day.today {
            background: rgba(59,130,246,0.2);
            border: 1px solid rgba(59,130,246,0.5);
        }

        .calendar-day.cycle-day {
            background: rgba(239,68,68,0.2);
            border: 1px solid rgba(239,68,68,0.5);
            color: #f87171;
            font-weight: 600;
        }

        .calendar-day.entry-zone {
            background: rgba(34,197,94,0.2);
            border: 1px solid rgba(34,197,94,0.5);
            color: #4ade80;
        }

        .calendar-day .cycle-indicator {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
        }

        /* Navigation */
        .nav-link {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            color: #888;
            text-decoration: none;
            font-size: 12px;
            margin-right: 10px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }

        .toast {
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-success { border-left: 4px solid #22c55e; }
        .toast-error { border-left: 4px solid #ef4444; }
        .toast-warning { border-left: 4px solid #f59e0b; }
        .toast-info { border-left: 4px solid #3b82f6; }

        .toast-message {
            font-size: 13px;
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.03);
            padding: 5px;
            border-radius: 10px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: transparent;
            border: none;
            color: #888;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #fff;
            background: rgba(255,255,255,0.05);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Header -->
    <div class="header">
        <h1>Gann Cycle Trading Dashboard</h1>
        <div class="subtitle">
            Biblical Cycles - Sq9 Levels - Options Recommendations
            <span class="live-indicator" id="liveIndicator">
                <span class="live-dot"></span>
                <span id="liveStatus">Connecting...</span>
            </span>
        </div>
        <div class="last-update">Last Updated: <span id="lastUpdate">Loading...</span></div>
        <div style="margin-top: 15px;">
            <a href="index.html" class="nav-link">&#8592; Main Dashboard</a>
            <button class="btn btn-primary btn-sm" onclick="refreshData()">Refresh</button>
            <button class="btn btn-secondary btn-sm" onclick="openAddTradeModal()">Add Trade</button>
            <button class="btn btn-secondary btn-sm" onclick="openSettingsModal()">Settings</button>
        </div>
    </div>

    <!-- Alert Banner -->
    <div id="alertBanner" style="display: none; margin-bottom: 20px;"></div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('overview')">Overview</button>
        <button class="tab" onclick="switchTab('cycles')">Cycles</button>
        <button class="tab" onclick="switchTab('journal')">Journal</button>
        <button class="tab" onclick="switchTab('alerts')">Alerts</button>
    </div>

    <!-- Overview Tab -->
    <div class="tab-content active" id="tab-overview">
        <!-- Top Row: Alerts, Countdown, Quick Stats -->
        <div class="dashboard-grid">

            <!-- Active Alerts -->
            <div class="card">
                <div class="card-title"><span class="icon">&#128680;</span> Active Alerts</div>
                <div id="activeAlerts">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div class="spinner" style="margin: 0 auto 10px;"></div>
                        Loading alerts...
                    </div>
                </div>
            </div>

            <!-- Cycle Countdown -->
            <div class="card">
                <div class="card-title"><span class="icon">&#128197;</span> Cycle Countdown</div>
                <div id="cycleCountdowns">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div class="spinner" style="margin: 0 auto 10px;"></div>
                        Loading cycles...
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card">
                <div class="card-title"><span class="icon">&#128200;</span> Market Status</div>
                <div id="quickStats">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                        <div class="price-card" id="spyCard">
                            <div class="price-symbol">SPY</div>
                            <div class="price-value" id="spyPrice">--</div>
                            <div class="price-change" id="spyChange">--</div>
                        </div>
                        <div class="price-card" id="qqqCard">
                            <div class="price-symbol">QQQ</div>
                            <div class="price-value" id="qqqPrice">--</div>
                            <div class="price-change" id="qqqChange">--</div>
                        </div>
                        <div class="price-card" id="iwmCard">
                            <div class="price-symbol">IWM</div>
                            <div class="price-value" id="iwmPrice">--</div>
                            <div class="price-change" id="iwmChange">--</div>
                        </div>
                    </div>
                    <div id="signalBox" style="text-align: center; padding: 15px; background: rgba(245,158,11,0.1); border-radius: 10px; border: 1px solid rgba(245,158,11,0.3);">
                        <div style="font-size: 11px; color: #f59e0b;">CURRENT SIGNAL</div>
                        <div id="currentSignal" style="font-size: 24px; font-weight: 700; color: #f59e0b;">Loading...</div>
                        <div id="signalReason" style="font-size: 11px; color: #888;">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trade Recommendation & Sq9 Levels -->
        <div class="dashboard-grid">

            <!-- Trade Recommendation -->
            <div class="card">
                <div class="card-title"><span class="icon">&#127919;</span> Trade Recommendation</div>
                <div class="trade-rec" id="tradeRecContainer">
                    <div class="trade-signal">
                        <div class="signal-label">CURRENT SIGNAL</div>
                        <div id="tradeSignal" class="signal-value signal-wait">&#9203;</div>
                    </div>
                    <div class="signal-reason" id="tradeSignalReason">
                        Loading recommendation...
                    </div>
                    <div class="trade-details" id="tradeDetails">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Sq9 Levels -->
            <div class="card">
                <div class="card-title">
                    <span class="icon">&#128208;</span> Sq9 Levels
                    <select id="sq9Symbol" style="margin-left: auto; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 12px;" onchange="updateSq9Display()">
                        <option value="SPY">SPY</option>
                        <option value="QQQ">QQQ</option>
                        <option value="IWM">IWM</option>
                    </select>
                </div>
                <div id="sq9Levels">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div class="spinner" style="margin: 0 auto 10px;"></div>
                        Loading Sq9 levels...
                    </div>
                </div>
            </div>

            <!-- Options Calculator -->
            <div class="card">
                <div class="card-title"><span class="icon">&#129518;</span> Options Calculator</div>
                <div class="options-calc" id="optionsCalc">
                    <div class="form-group">
                        <label class="form-label">Underlying</label>
                        <select id="calcSymbol" class="form-select" onchange="updateOptionsCalc()">
                            <option value="SPY">SPY</option>
                            <option value="QQQ">QQQ</option>
                            <option value="IWM">IWM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Account Size ($)</label>
                        <input type="number" id="accountSize" class="form-input" placeholder="10000" onchange="updateOptionsCalc()">
                    </div>
                    <div id="optionsRecOutput" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; margin-top: 15px;">
                        <div style="text-align: center; color: #666; font-size: 12px;">
                            Enter account size to see recommendations
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Multi-ETF Status -->
        <div class="dashboard-grid">
            <div class="card full-width">
                <div class="card-title"><span class="icon">&#128200;</span> Multi-ETF Cycle Status</div>
                <table class="etf-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Price</th>
                            <th>Change</th>
                            <th>From Last HIGH</th>
                            <th>From Last LOW</th>
                            <th>Nearest Cycle</th>
                            <th>Signal</th>
                        </tr>
                    </thead>
                    <tbody id="etfTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 30px; color: #666;">
                                <div class="spinner" style="margin: 0 auto 10px;"></div>
                                Loading ETF data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Cycles Tab -->
    <div class="tab-content" id="tab-cycles">
        <div class="dashboard-grid">
            <!-- Pivot Timeline -->
            <div class="card full-width">
                <div class="card-title"><span class="icon">&#128205;</span> Major Pivots & Cycle Timeline</div>
                <div id="pivotTimelines">
                    <div style="text-align: center; padding: 30px; color: #666;">
                        <div class="spinner" style="margin: 0 auto 10px;"></div>
                        Loading pivot data...
                    </div>
                </div>
            </div>

            <!-- Calendar -->
            <div class="card">
                <div class="card-title"><span class="icon">&#128197;</span> Cycle Calendar</div>
                <div class="calendar-container" id="calendarContainer">
                    <!-- Calendar populated by JS -->
                </div>
                <div style="margin-top: 15px; font-size: 11px; color: #888; display: flex; gap: 15px; flex-wrap: wrap;">
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: rgba(59,130,246,0.5); border-radius: 3px; margin-right: 5px;"></span> Today</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: rgba(239,68,68,0.5); border-radius: 3px; margin-right: 5px;"></span> Cycle Date</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: rgba(34,197,94,0.5); border-radius: 3px; margin-right: 5px;"></span> Entry Zone</span>
                </div>
            </div>

            <!-- Upcoming Dates -->
            <div class="card" style="grid-column: span 2;">
                <div class="card-title"><span class="icon">&#128197;</span> Upcoming Cycle Dates</div>
                <div id="upcomingDates">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        Loading upcoming dates...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Journal Tab -->
    <div class="tab-content" id="tab-journal">
        <div class="dashboard-grid">
            <!-- Performance Stats -->
            <div class="card full-width">
                <div class="card-title"><span class="icon">&#128200;</span> Performance Statistics</div>
                <div class="stats-grid" id="perfStats">
                    <div class="stat-box">
                        <div class="stat-value" id="statTotalTrades">0</div>
                        <div class="stat-label">Total Trades</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="statWinRate" style="color: #22c55e;">0%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="statTotalPnL">$0</div>
                        <div class="stat-label">Total P/L</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="statAvgWin" style="color: #22c55e;">$0</div>
                        <div class="stat-label">Avg Win</div>
                    </div>
                </div>
            </div>

            <!-- Trade Journal -->
            <div class="card full-width">
                <div class="card-title">
                    <span class="icon">&#128221;</span> Trade Journal
                    <button class="btn btn-success btn-sm" style="margin-left: auto;" onclick="openAddTradeModal()">+ Add Trade</button>
                </div>
                <div id="tradeJournal">
                    <div style="text-align: center; padding: 30px; color: #666;">
                        No trades recorded yet. Click "Add Trade" to start tracking.
                    </div>
                </div>
            </div>

            <!-- Backtested Performance -->
            <div class="card full-width">
                <div class="card-title"><span class="icon">&#128200;</span> Backtested Signal Performance</div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" style="color: #22c55e;">62%</div>
                        <div class="stat-label">Sq9 Support Bounce</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" style="color: #22c55e;">80%</div>
                        <div class="stat-label">49-Day Jubilee</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" style="color: #f59e0b;">67%</div>
                        <div class="stat-label">90-Day Quarter</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" style="color: #f59e0b;">60%</div>
                        <div class="stat-label">Continuation</div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; font-size: 12px; color: #888;">
                    Confirmed across: SPY (32 years) - QQQ (40 years) - IWM (20 years)
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Tab -->
    <div class="tab-content" id="tab-alerts">
        <div class="dashboard-grid">
            <!-- Email/SMS Settings -->
            <div class="card">
                <div class="card-title"><span class="icon">&#128231;</span> Email Alerts</div>
                <div class="alert-settings">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" id="alertEmail" class="form-input" placeholder="your@email.com">
                    </div>
                    <div class="alert-options">
                        <label class="alert-option">
                            <input type="checkbox" id="alert49Day" checked>
                            <span>49-Day Jubilee (3 days before)</span>
                        </label>
                        <label class="alert-option">
                            <input type="checkbox" id="alert90Day" checked>
                            <span>90-Day Quarter (5 days before)</span>
                        </label>
                        <label class="alert-option">
                            <input type="checkbox" id="alertSq9">
                            <span>Sq9 Support touched (1% threshold)</span>
                        </label>
                        <label class="alert-option">
                            <input type="checkbox" id="alert360Day" checked>
                            <span>360-Day Anniversary (7 days before)</span>
                        </label>
                    </div>
                    <button class="btn btn-primary btn-block" style="margin-top: 15px;" onclick="saveAlertSettings()">Save Settings</button>
                    <button class="btn btn-secondary btn-block" style="margin-top: 10px;" onclick="testEmailAlert()">Send Test Email</button>
                </div>
            </div>

            <!-- Alert History -->
            <div class="card" style="grid-column: span 2;">
                <div class="card-title"><span class="icon">&#128203;</span> Alert History</div>
                <div id="alertHistory">
                    <div style="text-align: center; padding: 30px; color: #666;">
                        No alerts sent yet. Configure your email above to receive alerts.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Trade Modal -->
    <div class="modal-overlay" id="addTradeModal">
        <div class="modal">
            <div class="modal-title">Add Trade</div>
            <form id="addTradeForm" onsubmit="saveTrade(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Symbol</label>
                        <select id="tradeSymbol" class="form-select" required>
                            <option value="SPY">SPY</option>
                            <option value="QQQ">QQQ</option>
                            <option value="IWM">IWM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Direction</label>
                        <select id="tradeDirection" class="form-select" required>
                            <option value="CALL">CALL (Bullish)</option>
                            <option value="PUT">PUT (Bearish)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Strike Price</label>
                        <input type="number" id="tradeStrike" class="form-input" placeholder="600" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Expiration</label>
                        <input type="date" id="tradeExpiry" class="form-input" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Entry Date</label>
                        <input type="date" id="tradeEntryDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Entry Price ($)</label>
                        <input type="number" step="0.01" id="tradeEntryPrice" class="form-input" placeholder="4.50" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Signal Type</label>
                    <select id="tradeSignalType" class="form-select">
                        <option value="49-Day Jubilee">49-Day Jubilee</option>
                        <option value="90-Day Quarter">90-Day Quarter</option>
                        <option value="Sq9 Support">Sq9 Support</option>
                        <option value="120-Day">120-Day (1/3 Year)</option>
                        <option value="180-Day">180-Day (Half Year)</option>
                        <option value="360-Day">360-Day Anniversary</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <input type="text" id="tradeNotes" class="form-input" placeholder="Optional notes...">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal('addTradeModal')">Cancel</button>
                    <button type="submit" class="btn btn-success" style="flex: 1;">Save Trade</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Close Trade Modal -->
    <div class="modal-overlay" id="closeTradeModal">
        <div class="modal">
            <div class="modal-title">Close Trade</div>
            <form id="closeTradeForm" onsubmit="closeTradeSubmit(event)">
                <input type="hidden" id="closeTradeId">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Exit Date</label>
                        <input type="date" id="tradeExitDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Exit Price ($)</label>
                        <input type="number" step="0.01" id="tradeExitPrice" class="form-input" placeholder="6.50" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Result</label>
                    <select id="tradeResult" class="form-select" required>
                        <option value="WIN">WIN</option>
                        <option value="LOSS">LOSS</option>
                        <option value="BREAKEVEN">BREAKEVEN</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal('closeTradeModal')">Cancel</button>
                    <button type="submit" class="btn btn-success" style="flex: 1;">Close Trade</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-title">Settings</div>
            <div class="form-group">
                <label class="form-label">Default Account Size ($)</label>
                <input type="number" id="settingsAccountSize" class="form-input" placeholder="10000">
            </div>
            <div class="form-group">
                <label class="form-label">Position Size (%)</label>
                <select id="settingsPositionSize" class="form-select">
                    <option value="3">3% (Conservative)</option>
                    <option value="5">5% (Moderate)</option>
                    <option value="10">10% (Aggressive)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Auto-refresh Interval</label>
                <select id="settingsRefreshInterval" class="form-select">
                    <option value="60">1 minute</option>
                    <option value="300" selected>5 minutes</option>
                    <option value="900">15 minutes</option>
                    <option value="0">Manual only</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal('settingsModal')">Cancel</button>
                <button type="button" class="btn btn-primary" style="flex: 1;" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div style="text-align: center; padding: 20px; color: #666; font-size: 12px;">
        Gann Cycle Trading Dashboard v2.0 | Based on W.D. Gann's Biblical Cycles<br>
        Backtested on SPY - QQQ - IWM | <a href="index.html" style="color: #888;">Main Dashboard</a>
    </div>

<script>
// ==========================================
// GANN CYCLE TRADING DASHBOARD - PHASE 2
// Live Data, Email Alerts, Trade Journal
// ==========================================

// ==========================================
// DATA STRUCTURES
// ==========================================

const majorPivots = {
    SPY: [
        { date: '2025-02-19', price: 614.42, type: 'HIGH', name: '2025 ATH', confirmed: ['49d LOW', '90d HIGH'] },
        { date: '2025-04-07', price: 506.22, type: 'LOW', name: 'Apr 2025 Bottom', confirmed: [] },
        { date: '2022-01-04', price: 479.35, type: 'HIGH', name: '2022 Peak', confirmed: ['180d LOW'] },
        { date: '2022-10-13', price: 366.99, type: 'LOW', name: '2022 Bottom', confirmed: [] }
    ],
    QQQ: [
        { date: '2025-02-19', price: 554.39, type: 'HIGH', name: '2025 ATH', confirmed: ['49d LOW', '216d HIGH'] },
        { date: '2025-04-07', price: 435.77, type: 'LOW', name: 'Apr 2025 Bottom', confirmed: ['49d LOW'] },
        { date: '2021-11-22', price: 409.52, type: 'HIGH', name: '2021 ATH', confirmed: ['270d HIGH'] }
    ],
    IWM: [
        { date: '2024-11-25', price: 242.40, type: 'HIGH', name: '2024 ATH', confirmed: [] },
        { date: '2025-04-07', price: 179.55, type: 'LOW', name: 'Apr 2025 Bottom', confirmed: ['49d', '90d'] },
        { date: '2022-06-16', price: 163.06, type: 'LOW', name: '2022 Bottom', confirmed: [] }
    ]
};

const biblicalCycles = [
    { days: 49, name: 'Jubilee (7x7)', priority: 1, color: '#ef4444', winRate: 80 },
    { days: 90, name: 'Quarter', priority: 2, color: '#f59e0b', winRate: 67 },
    { days: 120, name: '1/3 Year', priority: 2, color: '#f59e0b', winRate: 60 },
    { days: 144, name: 'Sacred (12x12)', priority: 3, color: '#8b5cf6', winRate: 55 },
    { days: 180, name: 'Half Year', priority: 2, color: '#f59e0b', winRate: 60 },
    { days: 270, name: '3/4 Year', priority: 2, color: '#f59e0b', winRate: 55 },
    { days: 360, name: 'Prophetic Year', priority: 1, color: '#ef4444', winRate: 65 },
    { days: 720, name: '2 Years', priority: 3, color: '#8b5cf6', winRate: 55 }
];

let currentPrices = { SPY: null, QQQ: null, IWM: null };
let previousPrices = { SPY: null, QQQ: null, IWM: null };
let trades = [];
let alertHistory = [];
let settings = {
    accountSize: 10000,
    positionSize: 3,
    refreshInterval: 300,
    email: '',
    alerts: { day49: true, day90: true, sq9: false, day360: true }
};

// ==========================================
// INITIALIZATION
// ==========================================

document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    loadTrades();
    loadAlertHistory();
    fetchLivePrices();
    updateDashboard();

    // Set default dates
    document.getElementById('tradeEntryDate').valueAsDate = new Date();
    document.getElementById('tradeExitDate').valueAsDate = new Date();

    // Auto-refresh
    if (settings.refreshInterval > 0) {
        setInterval(fetchLivePrices, settings.refreshInterval * 1000);
    }
});

// ==========================================
// LIVE PRICE FETCHING
// ==========================================

async function fetchLivePrices() {
    const symbols = ['SPY', 'QQQ', 'IWM'];
    const liveIndicator = document.getElementById('liveIndicator');
    const liveStatus = document.getElementById('liveStatus');

    try {
        // Try fetching from your CSV data files first
        for (const symbol of symbols) {
            try {
                const response = await fetch('data/' + symbol + '.csv?t=' + Date.now());
                if (response.ok) {
                    const text = await response.text();
                    const lines = text.trim().split('\n');
                    const lastLine = lines[lines.length - 1];
                    const values = lastLine.split(',');

                    // Assuming CSV format: Date,Open,High,Low,Close,...
                    previousPrices[symbol] = currentPrices[symbol];
                    currentPrices[symbol] = {
                        price: parseFloat(values[4]), // Close price
                        open: parseFloat(values[1]),
                        high: parseFloat(values[2]),
                        low: parseFloat(values[3]),
                        date: values[0]
                    };
                }
            } catch (e) {
                console.log('Could not fetch ' + symbol + ' from CSV:', e);
            }
        }

        // If CSV fetch failed, use fallback prices
        if (!currentPrices.SPY || !currentPrices.SPY.price) {
            // Fallback to last known prices
            currentPrices = {
                SPY: { price: 598.27, open: 596.50, high: 600.00, low: 595.00, change: 0.29 },
                QQQ: { price: 524.18, open: 522.00, high: 526.00, low: 521.00, change: 0.42 },
                IWM: { price: 248.20, open: 247.00, high: 249.00, low: 246.50, change: 0.49 }
            };
        }

        liveIndicator.style.borderColor = 'rgba(34,197,94,0.5)';
        liveStatus.textContent = 'Live';

        updatePriceDisplay();
        updateSq9Display();
        checkPriceAlerts();

    } catch (error) {
        console.error('Error fetching prices:', error);
        liveIndicator.style.borderColor = 'rgba(239,68,68,0.5)';
        liveStatus.textContent = 'Offline';
    }

    document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
}

function updatePriceDisplay() {
    ['SPY', 'QQQ', 'IWM'].forEach(function(symbol) {
        const data = currentPrices[symbol];
        if (!data) return;

        const priceEl = document.getElementById(symbol.toLowerCase() + 'Price');
        const changeEl = document.getElementById(symbol.toLowerCase() + 'Change');
        const cardEl = document.getElementById(symbol.toLowerCase() + 'Card');

        if (priceEl) priceEl.textContent = '$' + data.price.toFixed(2);

        if (changeEl && data.open) {
            const change = ((data.price - data.open) / data.open * 100);
            changeEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
            changeEl.className = 'price-change ' + (change >= 0 ? 'up' : 'down');

            if (cardEl) {
                cardEl.classList.remove('price-up', 'price-down');
                cardEl.classList.add(change >= 0 ? 'price-up' : 'price-down');
            }
        }
    });
}

// ==========================================
// CYCLE CALCULATIONS
// ==========================================

function daysBetween(date1, date2) {
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    return Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));
}

function getUpcomingCycles(symbol) {
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    const upcoming = [];

    if (!majorPivots[symbol]) return upcoming;

    majorPivots[symbol].forEach(function(pivot) {
        biblicalCycles.forEach(function(cycle) {
            const pivotDate = new Date(pivot.date);
            const targetDate = new Date(pivotDate);
            targetDate.setDate(targetDate.getDate() + cycle.days);

            const daysUntil = daysBetween(todayStr, targetDate.toISOString().split('T')[0]);

            if (daysUntil >= -7 && daysUntil <= 120) {
                upcoming.push({
                    symbol: symbol,
                    pivot: pivot,
                    cycle: cycle,
                    targetDate: targetDate,
                    daysUntil: daysUntil,
                    expectation: pivot.type === 'HIGH' ? 'Potential LOW' : 'Potential HIGH'
                });
            }
        });
    });

    return upcoming.sort(function(a, b) { return a.daysUntil - b.daysUntil; });
}

function getCurrentSignal() {
    const allUpcoming = [];
    ['SPY', 'QQQ', 'IWM'].forEach(function(symbol) {
        allUpcoming.push.apply(allUpcoming, getUpcomingCycles(symbol));
    });

    // Find most imminent cycle
    const imminent = allUpcoming.filter(function(a) { return a.daysUntil >= -3 && a.daysUntil <= 5 && a.cycle.priority <= 2; });

    if (imminent.length > 0) {
        const nearest = imminent[0];
        if (nearest.daysUntil <= 0) {
            // At or past the cycle date
            return {
                signal: nearest.expectation.includes('LOW') ? 'BUY' : 'SELL',
                class: nearest.expectation.includes('LOW') ? 'signal-buy' : 'signal-sell',
                reason: nearest.cycle.name + ' cycle from ' + nearest.pivot.name,
                emoji: nearest.expectation.includes('LOW') ? 'BUY' : 'SELL'
            };
        } else {
            return {
                signal: 'CAUTION',
                class: 'signal-caution',
                reason: nearest.cycle.name + ' in ' + nearest.daysUntil + ' days',
                emoji: 'CAUTION'
            };
        }
    }

    // Check for Sq9 support proximity
    const sq9Signal = checkSq9Proximity('SPY');
    if (sq9Signal) {
        return {
            signal: 'BUY',
            class: 'signal-buy',
            reason: 'Sq9 Support at ' + sq9Signal.level.toFixed(2),
            emoji: 'BUY'
        };
    }

    return {
        signal: 'WAIT',
        class: 'signal-wait',
        reason: 'No active signals',
        emoji: 'WAIT'
    };
}

// ==========================================
// SQ9 CALCULATIONS
// ==========================================

function calculateSq9Levels(price) {
    const sqrt = Math.sqrt(price);
    return {
        support: [
            { angle: '-45', price: Math.pow(sqrt - 0.25, 2) },
            { angle: '-90', price: Math.pow(sqrt - 0.5, 2) },
            { angle: '-180', price: Math.pow(sqrt - 1.0, 2) },
            { angle: '-270', price: Math.pow(sqrt - 1.5, 2) }
        ],
        resistance: [
            { angle: '+45', price: Math.pow(sqrt + 0.25, 2) },
            { angle: '+90', price: Math.pow(sqrt + 0.5, 2) },
            { angle: '+180', price: Math.pow(sqrt + 1.0, 2) },
            { angle: '+270', price: Math.pow(sqrt + 1.5, 2) }
        ]
    };
}

function checkSq9Proximity(symbol) {
    const data = currentPrices[symbol];
    if (!data) return null;

    const levels = calculateSq9Levels(data.price);

    for (let i = 0; i < levels.support.length; i++) {
        const level = levels.support[i];
        const distance = Math.abs(data.price - level.price) / data.price * 100;
        if (distance < 1.5) {
            return { level: level.price, distance: distance, angle: level.angle };
        }
    }
    return null;
}

function updateSq9Display() {
    const symbol = document.getElementById('sq9Symbol').value;
    const data = currentPrices[symbol];
    const container = document.getElementById('sq9Levels');

    if (!data || !data.price) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Price data not available</div>';
        return;
    }

    const levels = calculateSq9Levels(data.price);
    const proximity = checkSq9Proximity(symbol);

    let html = '<div style="text-align: center; margin-bottom: 15px;">' +
        '<div style="font-size: 12px; color: #888;">Current ' + symbol + ' Price</div>' +
        '<div style="font-size: 28px; font-weight: 700;">$' + data.price.toFixed(2) + '</div>' +
        '</div>' +
        '<div class="sq9-container">' +
        '<div class="sq9-section sq9-support">' +
        '<div class="sq9-title">SUPPORT (62% bounce)</div>';

    levels.support.forEach(function(level) {
        const distance = ((data.price - level.price) / data.price * 100).toFixed(1);
        const isClose = parseFloat(distance) < 1.5;
        html += '<div class="sq9-level ' + (isClose ? 'near-level' : '') + '">' +
            '<span class="angle">' + level.angle + '</span>' +
            '<span class="price">$' + level.price.toFixed(2) + '</span>' +
            '<span class="distance ' + (isClose ? 'close' : '') + '">' + distance + '%</span>' +
            '</div>';
    });

    html += '</div><div class="sq9-section sq9-resist">' +
        '<div class="sq9-title">RESIST (41% - avoid)</div>';

    levels.resistance.forEach(function(level) {
        const distance = ((level.price - data.price) / data.price * 100).toFixed(1);
        html += '<div class="sq9-level">' +
            '<span class="angle">' + level.angle + '</span>' +
            '<span class="price">$' + level.price.toFixed(2) + '</span>' +
            '<span class="distance">' + distance + '%</span>' +
            '</div>';
    });

    html += '</div></div>';

    if (proximity) {
        html += '<div class="sq9-alert">' +
            'Price near ' + proximity.angle + ' support ($' + proximity.level.toFixed(2) + ') - BUY CALL signal! (62% bounce rate)' +
            '</div>';
    }

    container.innerHTML = html;
}

// ==========================================
// DASHBOARD UPDATES
// ==========================================

function updateDashboard() {
    updateActiveAlerts();
    updateCycleCountdowns();
    updateSignalDisplay();
    updateTradeRecommendation();
    updateETFTable();
    updatePivotTimelines();
    updateCalendar();
    updateUpcomingDates();
    updateTradeJournal();
    updatePerformanceStats();
}

function updateActiveAlerts() {
    const container = document.getElementById('activeAlerts');
    const allUpcoming = [];

    ['SPY', 'QQQ', 'IWM'].forEach(function(symbol) {
        allUpcoming.push.apply(allUpcoming, getUpcomingCycles(symbol));
    });

    // Filter to significant alerts
    const alerts = allUpcoming.filter(function(a) { return a.daysUntil >= -3 && a.daysUntil <= 14 && a.cycle.priority <= 2; });

    // Remove duplicates
    const uniqueAlerts = [];
    const seen = {};
    alerts.forEach(function(a) {
        const key = a.targetDate.toISOString().split('T')[0] + a.cycle.days;
        if (!seen[key]) {
            seen[key] = true;
            uniqueAlerts.push(a);
        }
    });

    if (uniqueAlerts.length === 0) {
        container.innerHTML = '<div class="alert-card alert-success">' +
            '<div class="alert-title">All Clear</div>' +
            '<div class="alert-subtitle">No imminent cycle dates. Next major cycle in 15+ days.</div>' +
            '</div>';
        return;
    }

    let html = '';
    uniqueAlerts.slice(0, 4).forEach(function(alert) {
        let alertClass = 'alert-info';
        let badgeClass = 'badge-info';

        if (alert.daysUntil <= 3) {
            alertClass = 'alert-critical';
            badgeClass = 'badge-critical';
        } else if (alert.daysUntil <= 7) {
            alertClass = 'alert-warning';
            badgeClass = 'badge-warning';
        }

        const dateStr = alert.targetDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        html += '<div class="alert-card ' + alertClass + '">' +
            '<div class="alert-title">' + alert.cycle.name +
            '<span class="alert-badge ' + badgeClass + '">' + (alert.daysUntil <= 0 ? 'NOW' : alert.daysUntil + ' DAYS') + '</span></div>' +
            '<div class="alert-subtitle">' + alert.symbol + ' from ' + alert.pivot.name + ' - ' + dateStr + ' - ' + alert.expectation + '</div>' +
            '</div>';
    });

    container.innerHTML = html;
}

function updateCycleCountdowns() {
    const container = document.getElementById('cycleCountdowns');
    const today = new Date();

    // Key cycles to track
    const keyCycles = [
        { pivot: majorPivots.SPY[0], cycleDays: 360, name: 'SPY: Feb 19 ATH - 360d' },
        { pivot: majorPivots.SPY[1], cycleDays: 270, name: 'SPY: Apr 7 Low - 270d' },
        { pivot: majorPivots.SPY[1], cycleDays: 360, name: 'SPY: Apr 7 Low - 360d' }
    ];

    let html = '';
    keyCycles.forEach(function(item) {
        const pivotDate = new Date(item.pivot.date);
        const targetDate = new Date(pivotDate);
        targetDate.setDate(targetDate.getDate() + item.cycleDays);

        const daysSince = daysBetween(item.pivot.date, today.toISOString().split('T')[0]);
        const progress = Math.min(100, (daysSince / item.cycleDays) * 100);

        let progressClass = 'progress-normal';
        if (progress > 90) progressClass = 'progress-critical';
        else if (progress > 75) progressClass = 'progress-warning';

        html += '<div class="cycle-progress">' +
            '<div class="cycle-header">' +
            '<span class="cycle-name">' + item.name + '</span>' +
            '<span class="cycle-days">Day ' + daysSince + ' / ' + item.cycleDays + '</span>' +
            '</div>' +
            '<div class="progress-bar">' +
            '<div class="progress-fill ' + progressClass + '" style="width: ' + progress + '%;"></div>' +
            '</div></div>';
    });

    container.innerHTML = html;
}

function updateSignalDisplay() {
    const signal = getCurrentSignal();

    document.getElementById('currentSignal').textContent = signal.emoji;
    document.getElementById('currentSignal').className = signal.class;
    document.getElementById('signalReason').textContent = signal.reason;

    // Update signal box color
    const signalBox = document.getElementById('signalBox');
    if (signal.signal === 'BUY') {
        signalBox.style.background = 'rgba(34,197,94,0.1)';
        signalBox.style.borderColor = 'rgba(34,197,94,0.3)';
    } else if (signal.signal === 'SELL') {
        signalBox.style.background = 'rgba(239,68,68,0.1)';
        signalBox.style.borderColor = 'rgba(239,68,68,0.3)';
    } else if (signal.signal === 'CAUTION') {
        signalBox.style.background = 'rgba(249,115,22,0.1)';
        signalBox.style.borderColor = 'rgba(249,115,22,0.3)';
    } else {
        signalBox.style.background = 'rgba(245,158,11,0.1)';
        signalBox.style.borderColor = 'rgba(245,158,11,0.3)';
    }
}

function updateTradeRecommendation() {
    const signal = getCurrentSignal();
    const container = document.getElementById('tradeDetails');

    document.getElementById('tradeSignal').textContent = signal.emoji;
    document.getElementById('tradeSignal').className = 'signal-value ' + signal.class;
    document.getElementById('tradeSignalReason').textContent = signal.reason;

    if (signal.signal === 'BUY' || signal.signal === 'CAUTION') {
        const price = currentPrices.SPY ? currentPrices.SPY.price : 600;
        const strike = Math.round(price / 5) * 5;
        const today = new Date();
        const expDate = new Date(today);
        expDate.setDate(expDate.getDate() + 45);

        container.innerHTML = '<div class="trade-section-title">' + (signal.signal === 'BUY' ? 'RECOMMENDED TRADE:' : 'IF PULLBACK OCCURS:') + '</div>' +
            '<div class="trade-row"><span class="label">Action</span><span class="value" style="color: #22c55e;">BUY CALL</span></div>' +
            '<div class="trade-row"><span class="label">Symbol</span><span class="value">SPY / QQQ / IWM</span></div>' +
            '<div class="trade-row"><span class="label">Strike</span><span class="value">' + strike + ' (ATM)</span></div>' +
            '<div class="trade-row"><span class="label">Expiration</span><span class="value">' + expDate.toLocaleDateString() + ' (45 DTE)</span></div>' +
            '<div class="trade-row"><span class="label">Est. Premium</span><span class="value">~$' + (price * 0.02).toFixed(2) + '</span></div>' +
            '<div class="trade-row"><span class="label">Position Size</span><span class="value">3-5% of account</span></div>' +
            '<div class="trade-row"><span class="label">Target</span><span class="value" style="color: #22c55e;">+100%</span></div>' +
            '<div class="trade-row"><span class="label">Stop</span><span class="value" style="color: #ef4444;">-50%</span></div>';
    } else {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">' +
            'No active trade recommendation.<br>Wait for cycle signal or Sq9 support.</div>';
    }
}

function updateETFTable() {
    const tbody = document.getElementById('etfTableBody');
    const today = new Date();

    let html = '';
    ['SPY', 'QQQ', 'IWM'].forEach(function(symbol) {
        const data = currentPrices[symbol];
        const pivots = majorPivots[symbol];

        const price = data ? data.price : '--';
        const change = (data && data.open) ? ((data.price - data.open) / data.open * 100) : 0;

        // Find nearest HIGH and LOW pivots
        const highPivot = pivots.find(function(p) { return p.type === 'HIGH'; });
        const lowPivot = pivots.find(function(p) { return p.type === 'LOW'; });

        const daysFromHigh = highPivot ? daysBetween(highPivot.date, today.toISOString().split('T')[0]) : '--';
        const daysFromLow = lowPivot ? daysBetween(lowPivot.date, today.toISOString().split('T')[0]) : '--';

        // Find nearest cycle
        const upcoming = getUpcomingCycles(symbol).filter(function(u) { return u.daysUntil > 0; });
        const nearest = upcoming[0];

        // Determine signal
        const signal = getCurrentSignal();
        let signalClass = 'wait';
        if (signal.signal === 'BUY') signalClass = 'buy';
        else if (signal.signal === 'SELL') signalClass = 'sell';
        else if (signal.signal === 'CAUTION') signalClass = 'caution';

        html += '<tr>' +
            '<td class="etf-symbol">' + symbol + '</td>' +
            '<td class="etf-price">$' + (typeof price === 'number' ? price.toFixed(2) : price) + '</td>' +
            '<td class="price-change ' + (change >= 0 ? 'up' : 'down') + '">' + (change >= 0 ? '+' : '') + change.toFixed(2) + '%</td>' +
            '<td><div class="cycle-status"><span class="status-dot" style="background: ' + (daysFromHigh > 300 ? '#f59e0b' : '#3b82f6') + ';"></span>Day ' + daysFromHigh + '/360</div></td>' +
            '<td><div class="cycle-status"><span class="status-dot" style="background: ' + (daysFromLow > 250 ? '#ef4444' : '#3b82f6') + ';"></span>Day ' + daysFromLow + '/270</div></td>' +
            '<td>' + (nearest ? nearest.cycle.days + 'd - ' + nearest.targetDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '--') + '</td>' +
            '<td><span class="signal-badge ' + signalClass + '">' + signal.signal + '</span></td>' +
            '</tr>';
    });

    tbody.innerHTML = html;
}

function updatePivotTimelines() {
    const container = document.getElementById('pivotTimelines');
    const today = new Date();

    let html = '';
    ['SPY', 'QQQ', 'IWM'].forEach(function(symbol) {
        const pivots = majorPivots[symbol];

        pivots.slice(0, 2).forEach(function(pivot) {
            const pivotDate = new Date(pivot.date);

            html += '<div class="pivot-card">' +
                '<div class="pivot-header">' +
                '<div><span style="font-weight: 600; font-size: 16px;">' + symbol + '</span>' +
                '<span class="pivot-type pivot-' + pivot.type.toLowerCase() + '">' + pivot.type + '</span></div>' +
                '<div class="pivot-info">' +
                '<div class="pivot-date">' + pivot.name + '</div>' +
                '<div class="pivot-price">' + pivot.date + ' @ $' + pivot.price.toFixed(2) + '</div>' +
                '</div></div>' +
                '<div class="cycle-timeline">';

            biblicalCycles.slice(0, 7).forEach(function(cycle) {
                const targetDate = new Date(pivotDate);
                targetDate.setDate(targetDate.getDate() + cycle.days);
                const daysUntil = daysBetween(today.toISOString().split('T')[0], targetDate.toISOString().split('T')[0]);

                let dotClass = 'dot-future';
                let dateLabel = targetDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                let result = '';

                if (daysUntil < -3) {
                    dotClass = 'dot-done';
                    const confirmed = pivot.confirmed ? pivot.confirmed.find(function(c) { return c.startsWith(cycle.days + 'd'); }) : null;
                    if (confirmed) {
                        result = '<div class="result" style="color: #22c55e;">OK</div>';
                    }
                } else if (daysUntil >= -3 && daysUntil <= 3) {
                    dotClass = 'dot-active';
                }

                html += '<div class="cycle-dot" title="' + cycle.name + ': ' + targetDate.toLocaleDateString() + '">' +
                    '<div class="dot ' + dotClass + '"></div>' +
                    '<div class="label">' + cycle.days + 'd</div>' +
                    '<div class="date">' + dateLabel + '</div>' +
                    result + '</div>';
            });

            html += '</div></div>';
        });
    });

    container.innerHTML = html;
}

function updateCalendar() {
    const container = document.getElementById('calendarContainer');
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();

    // Get cycle dates for the month
    const cycleDates = {};
    const entryDates = {};

    ['SPY', 'QQQ', 'IWM'].forEach(function(symbol) {
        getUpcomingCycles(symbol).forEach(function(u) {
            const dateStr = u.targetDate.toISOString().split('T')[0];
            cycleDates[dateStr] = true;

            // Entry zone is 1-4 days after cycle date
            for (let i = 1; i <= 4; i++) {
                const entryDate = new Date(u.targetDate);
                entryDate.setDate(entryDate.getDate() + i);
                entryDates[entryDate.toISOString().split('T')[0]] = true;
            }
        });
    });

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];

    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

    let html = '<div class="calendar-header-nav">' +
        '<button class="calendar-nav-btn" onclick="changeMonth(-1)">&#8592;</button>' +
        '<div class="calendar-month">' + monthNames[currentMonth] + ' ' + currentYear + '</div>' +
        '<button class="calendar-nav-btn" onclick="changeMonth(1)">&#8594;</button>' +
        '</div>' +
        '<div class="calendar-grid">' +
        '<div class="calendar-header">Sun</div>' +
        '<div class="calendar-header">Mon</div>' +
        '<div class="calendar-header">Tue</div>' +
        '<div class="calendar-header">Wed</div>' +
        '<div class="calendar-header">Thu</div>' +
        '<div class="calendar-header">Fri</div>' +
        '<div class="calendar-header">Sat</div>';

    // Empty cells before first day
    for (let i = 0; i < firstDay; i++) {
        html += '<div class="calendar-day" style="opacity: 0.3;"></div>';
    }

    // Days of month
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = currentYear + '-' + String(currentMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        const isToday = dateStr === today.toISOString().split('T')[0];
        const isCycleDay = cycleDates[dateStr];
        const isEntryZone = entryDates[dateStr];

        let dayClass = 'calendar-day';
        if (isToday) dayClass += ' today';
        if (isCycleDay) dayClass += ' cycle-day';
        else if (isEntryZone) dayClass += ' entry-zone';

        html += '<div class="' + dayClass + '">' + day + '</div>';
    }

    html += '</div>';
    container.innerHTML = html;
}

function updateUpcomingDates() {
    const container = document.getElementById('upcomingDates');
    const allUpcoming = [];

    ['SPY', 'QQQ', 'IWM'].forEach(function(symbol) {
        allUpcoming.push.apply(allUpcoming, getUpcomingCycles(symbol));
    });

    const upcoming = allUpcoming.filter(function(u) { return u.daysUntil > 0; }).slice(0, 10);

    if (upcoming.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No upcoming cycles in the next 120 days.</div>';
        return;
    }

    let html = '<div style="display: grid; gap: 10px;">';
    upcoming.forEach(function(u) {
        const dateStr = u.targetDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">' +
            '<div><div style="font-weight: 600;">' + u.symbol + ' - ' + u.cycle.name + '</div>' +
            '<div style="font-size: 12px; color: #888;">' + dateStr + '</div></div>' +
            '<div style="text-align: right;">' +
            '<div style="font-size: 14px; font-weight: 600; color: ' + (u.daysUntil <= 7 ? '#ef4444' : '#888') + ';">' + u.daysUntil + ' days</div>' +
            '<div style="font-size: 11px; color: ' + (u.expectation.includes('LOW') ? '#22c55e' : '#ef4444') + ';">' + u.expectation + '</div>' +
            '</div></div>';
    });
    html += '</div>';

    container.innerHTML = html;
}

// ==========================================
// TRADE JOURNAL
// ==========================================

function loadTrades() {
    const saved = localStorage.getItem('gannTrades');
    if (saved) {
        trades = JSON.parse(saved);
    }
}

function saveTrades() {
    localStorage.setItem('gannTrades', JSON.stringify(trades));
}

function saveTrade(event) {
    event.preventDefault();

    const trade = {
        id: Date.now(),
        symbol: document.getElementById('tradeSymbol').value,
        direction: document.getElementById('tradeDirection').value,
        strike: parseFloat(document.getElementById('tradeStrike').value),
        expiry: document.getElementById('tradeExpiry').value,
        entryDate: document.getElementById('tradeEntryDate').value,
        entryPrice: parseFloat(document.getElementById('tradeEntryPrice').value),
        signalType: document.getElementById('tradeSignalType').value,
        notes: document.getElementById('tradeNotes').value,
        status: 'OPEN',
        exitDate: null,
        exitPrice: null,
        result: null,
        pnl: null
    };

    trades.unshift(trade);
    saveTrades();
    updateTradeJournal();
    updatePerformanceStats();
    closeModal('addTradeModal');
    showToast('Trade added successfully!', 'success');

    // Reset form
    document.getElementById('addTradeForm').reset();
    document.getElementById('tradeEntryDate').valueAsDate = new Date();
}

function openCloseTrade(tradeId) {
    document.getElementById('closeTradeId').value = tradeId;
    document.getElementById('tradeExitDate').valueAsDate = new Date();
    openModal('closeTradeModal');
}

function closeTradeSubmit(event) {
    event.preventDefault();

    const tradeId = parseInt(document.getElementById('closeTradeId').value);
    const trade = trades.find(function(t) { return t.id === tradeId; });

    if (trade) {
        trade.exitDate = document.getElementById('tradeExitDate').value;
        trade.exitPrice = parseFloat(document.getElementById('tradeExitPrice').value);
        trade.result = document.getElementById('tradeResult').value;
        trade.status = 'CLOSED';
        trade.pnl = (trade.exitPrice - trade.entryPrice) * 100; // Per contract
        trade.pnlPercent = ((trade.exitPrice - trade.entryPrice) / trade.entryPrice * 100).toFixed(1);

        saveTrades();
        updateTradeJournal();
        updatePerformanceStats();
        closeModal('closeTradeModal');
        showToast('Trade closed!', trade.result === 'WIN' ? 'success' : 'warning');
    }
}

function deleteTrade(tradeId) {
    if (confirm('Are you sure you want to delete this trade?')) {
        trades = trades.filter(function(t) { return t.id !== tradeId; });
        saveTrades();
        updateTradeJournal();
        updatePerformanceStats();
        showToast('Trade deleted', 'info');
    }
}

function updateTradeJournal() {
    const container = document.getElementById('tradeJournal');

    if (trades.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 30px; color: #666;">No trades recorded yet. Click "Add Trade" to start tracking.</div>';
        return;
    }

    let html = '';
    trades.forEach(function(trade) {
        const isOpen = trade.status === 'OPEN';
        let resultClass = 'result-open';
        let resultIcon = 'OPEN';
        let pnlClass = 'pnl-open';

        if (!isOpen) {
            if (trade.result === 'WIN') {
                resultClass = 'result-win';
                resultIcon = 'WIN';
                pnlClass = 'pnl-positive';
            } else if (trade.result === 'LOSS') {
                resultClass = 'result-loss';
                resultIcon = 'LOSS';
                pnlClass = 'pnl-negative';
            } else {
                resultIcon = 'BE';
            }
        }

        const pnlDisplay = isOpen ? 'OPEN' : (trade.pnl >= 0 ? '+' : '') + '$' + trade.pnl.toFixed(0);
        const pctDisplay = isOpen ? '' : '(' + trade.pnlPercent + '%)';

        html += '<div class="journal-entry">' +
            '<div class="journal-left">' +
            '<div class="journal-result ' + resultClass + '">' + resultIcon + '</div>' +
            '<div class="journal-info">' +
            '<div class="symbol">' + trade.symbol + ' ' + trade.strike + ' ' + trade.direction + ' ' + trade.expiry + '</div>' +
            '<div class="details">' + trade.entryDate + ' @ $' + trade.entryPrice.toFixed(2) + (isOpen ? '' : ' - ' + trade.exitDate + ' @ $' + trade.exitPrice.toFixed(2)) + '</div>' +
            '<div class="signal-type">Signal: ' + trade.signalType + '</div>' +
            '</div></div>' +
            '<div class="journal-pnl">' +
            '<div class="pnl-amount ' + pnlClass + '">' + pnlDisplay + '</div>' +
            '<div class="pnl-percent">' + pctDisplay + '</div>' +
            (isOpen ? '<button class="btn btn-success btn-sm" style="margin-top: 8px;" onclick="openCloseTrade(' + trade.id + ')">Close</button>' : '') +
            '<button class="btn btn-secondary btn-sm" style="margin-top: 5px; padding: 4px 8px; font-size: 10px;" onclick="deleteTrade(' + trade.id + ')">Delete</button>' +
            '</div></div>';
    });

    container.innerHTML = html;
}

function updatePerformanceStats() {
    const closedTrades = trades.filter(function(t) { return t.status === 'CLOSED'; });
    const wins = closedTrades.filter(function(t) { return t.result === 'WIN'; });
    const losses = closedTrades.filter(function(t) { return t.result === 'LOSS'; });

    const totalTrades = closedTrades.length;
    const winRate = totalTrades > 0 ? (wins.length / totalTrades * 100).toFixed(0) : 0;
    const totalPnL = closedTrades.reduce(function(sum, t) { return sum + (t.pnl || 0); }, 0);
    const avgWin = wins.length > 0 ? wins.reduce(function(sum, t) { return sum + t.pnl; }, 0) / wins.length : 0;

    document.getElementById('statTotalTrades').textContent = totalTrades;
    document.getElementById('statWinRate').textContent = winRate + '%';
    document.getElementById('statWinRate').style.color = winRate >= 50 ? '#22c55e' : '#ef4444';
    document.getElementById('statTotalPnL').textContent = (totalPnL >= 0 ? '+' : '') + '$' + totalPnL.toFixed(0);
    document.getElementById('statTotalPnL').style.color = totalPnL >= 0 ? '#22c55e' : '#ef4444';
    document.getElementById('statAvgWin').textContent = '$' + avgWin.toFixed(0);
}

// ==========================================
// OPTIONS CALCULATOR
// ==========================================

function updateOptionsCalc() {
    const symbol = document.getElementById('calcSymbol').value;
    const accountSize = parseFloat(document.getElementById('accountSize').value) || 0;
    const container = document.getElementById('optionsRecOutput');

    const data = currentPrices[symbol];
    if (!data || !data.price) {
        container.innerHTML = '<div style="text-align: center; color: #666; font-size: 12px;">Price data not available</div>';
        return;
    }

    const price = data.price;
    const strike = Math.round(price / 5) * 5;
    const estPremium = price * 0.02;

    const today = new Date();
    const expDate = new Date(today);
    expDate.setDate(expDate.getDate() + 45);

    const position3pct = accountSize * 0.03;
    const position5pct = accountSize * 0.05;
    const contracts3pct = Math.floor(position3pct / (estPremium * 100));
    const contracts5pct = Math.floor(position5pct / (estPremium * 100));

    let html = '<div class="trade-row"><span class="label">Symbol</span><span class="value">' + symbol + '</span></div>' +
        '<div class="trade-row"><span class="label">Current Price</span><span class="value">$' + price.toFixed(2) + '</span></div>' +
        '<div class="trade-row"><span class="label">Rec. Strike (ATM)</span><span class="value" style="color: #22c55e;">$' + strike + '</span></div>' +
        '<div class="trade-row"><span class="label">Rec. Expiration</span><span class="value">' + expDate.toLocaleDateString() + ' (45 DTE)</span></div>' +
        '<div class="trade-row"><span class="label">Est. Premium</span><span class="value">~$' + estPremium.toFixed(2) + '</span></div>';

    if (accountSize > 0) {
        html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">' +
            '<div class="trade-row"><span class="label">3% Position ($' + position3pct.toFixed(0) + ')</span><span class="value">' + contracts3pct + ' contracts</span></div>' +
            '<div class="trade-row"><span class="label">5% Position ($' + position5pct.toFixed(0) + ')</span><span class="value">' + contracts5pct + ' contracts</span></div>' +
            '</div>';
    } else {
        html += '<div style="margin-top: 10px; font-size: 11px; color: #888; text-align: center;">Enter account size above</div>';
    }

    container.innerHTML = html;
}

// ==========================================
// ALERT SYSTEM
// ==========================================

function loadAlertHistory() {
    const saved = localStorage.getItem('gannAlertHistory');
    if (saved) {
        alertHistory = JSON.parse(saved);
    }
    updateAlertHistoryDisplay();
}

function saveAlertHistory() {
    localStorage.setItem('gannAlertHistory', JSON.stringify(alertHistory));
}

function checkPriceAlerts() {
    // Check Sq9 alerts
    if (settings.alerts && settings.alerts.sq9) {
        ['SPY', 'QQQ', 'IWM'].forEach(function(symbol) {
            const proximity = checkSq9Proximity(symbol);
            if (proximity && proximity.distance < 1.0) {
                triggerAlert({
                    type: 'sq9',
                    symbol: symbol,
                    message: symbol + ' near Sq9 support at $' + proximity.level.toFixed(2) + ' (' + proximity.distance.toFixed(2) + '% away)',
                    date: new Date().toISOString()
                });
            }
        });
    }
}

function triggerAlert(alert) {
    // Check if we've already sent this alert today
    const today = new Date().toISOString().split('T')[0];
    const existing = alertHistory.find(function(a) {
        return a.type === alert.type && a.symbol === alert.symbol && a.date.startsWith(today);
    });

    if (existing) return;

    // Add to history
    alertHistory.unshift(alert);
    if (alertHistory.length > 50) alertHistory = alertHistory.slice(0, 50);
    saveAlertHistory();
    updateAlertHistoryDisplay();

    // Show toast
    showToast(alert.message, 'warning');
}

function testEmailAlert() {
    const email = document.getElementById('alertEmail').value;
    if (!email) {
        showToast('Please enter an email address first', 'error');
        return;
    }

    showToast('Test email would be sent to: ' + email + ' (Configure EmailJS for real emails)', 'info');
}

function updateAlertHistoryDisplay() {
    const container = document.getElementById('alertHistory');

    if (alertHistory.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 30px; color: #666;">No alerts sent yet.</div>';
        return;
    }

    let html = '';
    alertHistory.slice(0, 10).forEach(function(alert) {
        const date = new Date(alert.date).toLocaleString();
        html += '<div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px;">' +
            '<div style="display: flex; justify-content: space-between; align-items: center;">' +
            '<div><div style="font-weight: 600; font-size: 13px;">' + alert.symbol + ' - ' + alert.type.toUpperCase() + '</div>' +
            '<div style="font-size: 12px; color: #888;">' + alert.message + '</div></div>' +
            '<div style="text-align: right; font-size: 11px; color: #666;">' + date + '</div>' +
            '</div></div>';
    });

    container.innerHTML = html;
}

// ==========================================
// SETTINGS
// ==========================================

function loadSettings() {
    const saved = localStorage.getItem('gannSettings');
    if (saved) {
        const parsed = JSON.parse(saved);
        settings = Object.assign({}, settings, parsed);
    }

    // Populate form fields
    if (document.getElementById('alertEmail')) {
        document.getElementById('alertEmail').value = settings.email || '';
    }
    if (document.getElementById('accountSize')) {
        document.getElementById('accountSize').value = settings.accountSize || '';
    }
    if (document.getElementById('alert49Day')) {
        document.getElementById('alert49Day').checked = settings.alerts ? settings.alerts.day49 : true;
        document.getElementById('alert90Day').checked = settings.alerts ? settings.alerts.day90 : true;
        document.getElementById('alertSq9').checked = settings.alerts ? settings.alerts.sq9 : false;
        document.getElementById('alert360Day').checked = settings.alerts ? settings.alerts.day360 : true;
    }
}

function saveSettings() {
    settings.accountSize = parseFloat(document.getElementById('settingsAccountSize').value) || 10000;
    settings.positionSize = parseInt(document.getElementById('settingsPositionSize').value) || 3;
    settings.refreshInterval = parseInt(document.getElementById('settingsRefreshInterval').value) || 300;

    localStorage.setItem('gannSettings', JSON.stringify(settings));
    closeModal('settingsModal');
    showToast('Settings saved!', 'success');
}

function saveAlertSettings() {
    settings.email = document.getElementById('alertEmail').value;
    settings.alerts = {
        day49: document.getElementById('alert49Day').checked,
        day90: document.getElementById('alert90Day').checked,
        sq9: document.getElementById('alertSq9').checked,
        day360: document.getElementById('alert360Day').checked
    };

    localStorage.setItem('gannSettings', JSON.stringify(settings));
    showToast('Alert settings saved!', 'success');
}

// ==========================================
// UI HELPERS
// ==========================================

function switchTab(tabId) {
    // Update tab buttons
    document.querySelectorAll('.tab').forEach(function(tab) { tab.classList.remove('active'); });
    event.target.classList.add('active');

    // Update tab content
    document.querySelectorAll('.tab-content').forEach(function(content) { content.classList.remove('active'); });
    document.getElementById('tab-' + tabId).classList.add('active');
}

function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function openAddTradeModal() {
    document.getElementById('tradeEntryDate').valueAsDate = new Date();
    openModal('addTradeModal');
}

function openSettingsModal() {
    document.getElementById('settingsAccountSize').value = settings.accountSize || '';
    document.getElementById('settingsPositionSize').value = settings.positionSize || 3;
    document.getElementById('settingsRefreshInterval').value = settings.refreshInterval || 300;
    openModal('settingsModal');
}

function showToast(message, type) {
    type = type || 'info';
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast toast-' + type;
    toast.innerHTML = '<div class="toast-message">' + message + '</div>';
    container.appendChild(toast);

    setTimeout(function() {
        toast.style.opacity = '0';
        setTimeout(function() { toast.remove(); }, 300);
    }, 4000);
}

function refreshData() {
    showToast('Refreshing data...', 'info');
    fetchLivePrices().then(function() {
        updateDashboard();
        showToast('Data refreshed!', 'success');
    });
}

// Close modals when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-overlay')) {
        e.target.classList.remove('active');
    }
});
</script>
</body>
</html>
